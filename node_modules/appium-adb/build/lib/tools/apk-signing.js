"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _teen_process = require("teen_process");

var _path = _interopRequireDefault(require("path"));

var _logger = _interopRequireDefault(require("../logger.js"));

var _appiumSupport = require("appium-support");

var _helpers = require("../helpers.js");

const DEFAULT_PRIVATE_KEY = _path.default.resolve(_helpers.rootDir, 'keys', 'testkey.pk8');

const DEFAULT_CERTIFICATE = _path.default.resolve(_helpers.rootDir, 'keys', 'testkey.x509.pem');

const DEFAULT_CERT_DIGEST = 'a40da80a59d170caa950cf15c18c454d47a39b26989d8b640ecd745ba71bf5dc';
const BUNDLETOOL_TUTORIAL = 'https://developer.android.com/studio/command-line/bundletool';
const APKSIGNER_VERIFY_FAIL = 'DOES NOT VERIFY';
let apkSigningMethods = {};

async function patchApksigner(originalPath) {
  const originalContent = await _appiumSupport.fs.readFile(originalPath, 'ascii');
  const patchedContent = originalContent.replace('-Djava.ext.dirs="%frameworkdir%"', '-cp "%frameworkdir%\\*"');

  if (patchedContent === originalContent) {
    return originalPath;
  }

  _logger.default.debug(`Patching '${originalPath}...`);

  const patchedPath = await _appiumSupport.tempDir.path({
    prefix: 'apksigner',
    suffix: '.bat'
  });
  await (0, _appiumSupport.mkdirp)(_path.default.dirname(patchedPath));
  await _appiumSupport.fs.writeFile(patchedPath, patchedContent, 'ascii');
  return patchedPath;
}

apkSigningMethods.executeApksigner = async function (args = []) {
  const apkSigner = await (0, _helpers.getApksignerForOs)(this);

  const originalFolder = _path.default.dirname(apkSigner);

  const getApksignerOutput = async apksignerPath => {
    let binaryPath = apksignerPath;

    if (_appiumSupport.system.isWindows() && _appiumSupport.util.isSubPath(binaryPath, originalFolder)) {
      binaryPath = _path.default.basename(binaryPath);
    }

    const {
      stdout,
      stderr
    } = await (0, _teen_process.exec)(binaryPath, args, {
      cwd: originalFolder
    });

    for (let [name, stream] of [['stdout', stdout], ['stderr', stderr]]) {
      if (!stream) {
        continue;
      }

      if (name === 'stdout') {
        stream = stream.split('\n').filter(line => !line.includes('WARNING:')).join('\n');
      }

      _logger.default.debug(`apksigner ${name}: ${stream}`);
    }

    return stdout;
  };

  _logger.default.debug(`Starting '${apkSigner}' with args '${JSON.stringify(args)}'`);

  try {
    return await getApksignerOutput(apkSigner);
  } catch (err) {
    _logger.default.warn(`Got an error during apksigner execution: ${err.message}`);

    for (const [name, stream] of [['stdout', err.stdout], ['stderr', err.stderr]]) {
      if (stream) {
        _logger.default.warn(`apksigner ${name}: ${stream}`);
      }
    }

    if (_appiumSupport.system.isWindows()) {
      const patchedApksigner = await patchApksigner(apkSigner);

      if (patchedApksigner !== apkSigner) {
        try {
          return await getApksignerOutput(patchedApksigner);
        } finally {
          await _appiumSupport.fs.unlink(patchedApksigner);
        }
      }
    }

    throw err;
  }
};

apkSigningMethods.signWithDefaultCert = async function (apk) {
  _logger.default.debug(`Signing '${apk}' with default cert`);

  if (!(await _appiumSupport.fs.exists(apk))) {
    throw new Error(`${apk} file doesn't exist.`);
  }

  try {
    const args = ['sign', '--key', DEFAULT_PRIVATE_KEY, '--cert', DEFAULT_CERTIFICATE, apk];
    await this.executeApksigner(args);
  } catch (err) {
    _logger.default.warn(`Cannot use apksigner tool for signing. Defaulting to sign.jar. ` + `Original error: ${err.message}` + (err.stderr ? `; StdErr: ${err.stderr}` : ''));

    const java = (0, _helpers.getJavaForOs)();

    const signPath = _path.default.resolve(this.helperJarPath, 'sign.jar');

    _logger.default.debug("Resigning apk.");

    try {
      await (0, _teen_process.exec)(java, ['-jar', signPath, apk, '--override']);
    } catch (e) {
      throw new Error(`Could not sign with default certificate. Original error ${e.message}`);
    }
  }
};

apkSigningMethods.signWithCustomCert = async function (apk) {
  _logger.default.debug(`Signing '${apk}' with custom cert`);

  if (!(await _appiumSupport.fs.exists(this.keystorePath))) {
    throw new Error(`Keystore: ${this.keystorePath} doesn't exist.`);
  }

  if (!(await _appiumSupport.fs.exists(apk))) {
    throw new Error(`'${apk}' doesn't exist.`);
  }

  try {
    const args = ['sign', '--ks', this.keystorePath, '--ks-key-alias', this.keyAlias, '--ks-pass', `pass:${this.keystorePassword}`, '--key-pass', `pass:${this.keyPassword}`, apk];
    await this.executeApksigner(args);
  } catch (err) {
    _logger.default.warn(`Cannot use apksigner tool for signing. Defaulting to jarsigner. ` + `Original error: ${err.message}`);

    try {
      _logger.default.debug("Unsigning apk.");

      await (0, _teen_process.exec)((0, _helpers.getJavaForOs)(), ['-jar', _path.default.resolve(this.helperJarPath, 'unsign.jar'), apk]);

      _logger.default.debug("Signing apk.");

      const jarsigner = _path.default.resolve((0, _helpers.getJavaHome)(), 'bin', `jarsigner${_appiumSupport.system.isWindows() ? '.exe' : ''}`);

      await (0, _teen_process.exec)(jarsigner, ['-sigalg', 'MD5withRSA', '-digestalg', 'SHA1', '-keystore', this.keystorePath, '-storepass', this.keystorePassword, '-keypass', this.keyPassword, apk, this.keyAlias]);
    } catch (e) {
      throw new Error(`Could not sign with custom certificate. Original error ${e.message}`);
    }
  }
};

apkSigningMethods.sign = async function (appPath) {
  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    let message = 'Signing of .apks-files is not supported. ';

    if (this.useKeystore) {
      message += 'Consider manual application bundle signing with the custom keystore ' + `like it is described at ${BUNDLETOOL_TUTORIAL}`;
    } else {
      message += `Consider manual application bundle signing with the key at '${DEFAULT_PRIVATE_KEY}' ` + `and the certificate at '${DEFAULT_CERTIFICATE}'. Read ${BUNDLETOOL_TUTORIAL} for more details.`;
    }

    _logger.default.warn(message);

    return;
  }

  let apksignerFound = true;

  try {
    await (0, _helpers.getApksignerForOs)(this);
  } catch (err) {
    apksignerFound = false;
  }

  if (apksignerFound) {
    await this.zipAlignApk(appPath);
  }

  if (this.useKeystore) {
    await this.signWithCustomCert(appPath);
  } else {
    await this.signWithDefaultCert(appPath);
  }

  if (!apksignerFound) {
    await this.zipAlignApk(appPath);
  }
};

apkSigningMethods.zipAlignApk = async function (apk) {
  await this.initZipAlign();

  try {
    await (0, _teen_process.exec)(this.binaries.zipalign, ['-c', '4', apk]);

    _logger.default.debug(`${apk}' is already zip-aligned. Doing nothing`);

    return false;
  } catch (e) {
    _logger.default.debug(`'${apk}' is not zip-aligned. Aligning`);
  }

  const alignedApk = await _appiumSupport.tempDir.path({
    prefix: 'appium',
    suffix: '.tmp'
  });
  await (0, _appiumSupport.mkdirp)(_path.default.dirname(alignedApk));

  try {
    await (0, _teen_process.exec)(this.binaries.zipalign, ['-f', '4', apk, alignedApk]);
    await _appiumSupport.fs.mv(alignedApk, apk, {
      mkdirp: true
    });
    return true;
  } catch (e) {
    if (await _appiumSupport.fs.exists(alignedApk)) {
      await _appiumSupport.fs.unlink(alignedApk);
    }

    throw new Error(`zipAlignApk failed. Original error: ${e.message}. Stdout: '${e.stdout}'; Stderr: '${e.stderr}'`);
  }
};

apkSigningMethods.checkApkCert = async function (appPath, pkg) {
  _logger.default.debug(`Checking app cert for ${appPath}`);

  if (!(await _appiumSupport.fs.exists(appPath))) {
    _logger.default.debug(`'${appPath}' does not exist`);

    return false;
  }

  if (this.useKeystore) {
    return await this.checkCustomApkCert(appPath, pkg);
  }

  if (_path.default.extname(appPath) === _helpers.APKS_EXTENSION) {
    appPath = await this.extractBaseApk(appPath);
  }

  try {
    await (0, _helpers.getApksignerForOs)(this);
    const output = await this.executeApksigner(['verify', '--print-certs', appPath]);

    if (!_lodash.default.includes(output, DEFAULT_CERT_DIGEST)) {
      _logger.default.debug(`'${appPath}' is signed with non-default certificate`);

      return false;
    }

    _logger.default.debug(`'${appPath}' is already signed.`);

    return true;
  } catch (err) {
    if (err.stderr && err.stderr.includes(APKSIGNER_VERIFY_FAIL)) {
      _logger.default.debug(`'${appPath}' is not signed with debug cert`);

      return false;
    }

    _logger.default.warn(`Cannot use apksigner tool for signature verification. ` + `Original error: ${err.message}`);
  }

  try {
    _logger.default.debug(`Defaulting to verify.jar`);

    await (0, _teen_process.exec)((0, _helpers.getJavaForOs)(), ['-jar', _path.default.resolve(this.helperJarPath, 'verify.jar'), appPath]);

    _logger.default.debug(`'${appPath}' is already signed.`);

    return true;
  } catch (err) {
    _logger.default.debug(`'${appPath}' is not signed with debug cert${err.stderr ? `: ${err.stderr}` : ''}`);

    return false;
  }
};

apkSigningMethods.checkCustomApkCert = async function (appPath, pkg) {
  _logger.default.debug(`Checking custom app cert for ${appPath}`);

  if (_path.default.extname(appPath) === _helpers.APKS_EXTENSION) {
    appPath = await this.extractBaseApk(appPath);
  }

  let h = "a-fA-F0-9";
  let md5Str = [`.*MD5.*((?:[${h}]{2}:){15}[${h}]{2})`];
  let md5 = new RegExp(md5Str, 'mi');

  let keytool = _path.default.resolve((0, _helpers.getJavaHome)(), 'bin', `keytool${_appiumSupport.system.isWindows() ? '.exe' : ''}`);

  let keystoreHash = await this.getKeystoreMd5(keytool, md5);
  return await this.checkApkKeystoreMatch(keytool, md5, keystoreHash, pkg, appPath);
};

apkSigningMethods.getKeystoreMd5 = async function (keytool, md5re) {
  _logger.default.debug("Printing keystore md5.");

  try {
    let {
      stdout
    } = await (0, _teen_process.exec)(keytool, ['-v', '-list', '-alias', this.keyAlias, '-keystore', this.keystorePath, '-storepass', this.keystorePassword]);
    let keystoreHash = md5re.exec(stdout);
    keystoreHash = keystoreHash ? keystoreHash[1] : null;

    _logger.default.debug(`Keystore MD5: ${keystoreHash}`);

    return keystoreHash;
  } catch (e) {
    throw new Error(`getKeystoreMd5 failed. Original error: ${e.message}`);
  }
};

apkSigningMethods.checkApkKeystoreMatch = async function (keytool, md5re, keystoreHash, pkg, apk) {
  let entryHash = null;
  let rsa = /^META-INF\/.*\.[rR][sS][aA]$/;
  let foundKeystoreMatch = false;
  await _appiumSupport.zip.readEntries(apk, async ({
    entry,
    extractEntryTo
  }) => {
    entry = entry.fileName;

    if (!rsa.test(entry)) {
      return;
    }

    _logger.default.debug(`Entry: ${entry}`);

    let entryPath = _path.default.join(this.tmpDir, pkg, 'cert');

    _logger.default.debug(`entryPath: ${entryPath}`);

    let entryFile = _path.default.join(entryPath, entry);

    _logger.default.debug(`entryFile: ${entryFile}`);

    await _appiumSupport.fs.rimraf(entryPath);
    await extractEntryTo(entryPath);

    _logger.default.debug("extracted!");

    _logger.default.debug("Printing apk md5.");

    let {
      stdout
    } = await (0, _teen_process.exec)(keytool, ['-v', '-printcert', '-file', entryFile]);
    entryHash = md5re.exec(stdout);
    entryHash = entryHash ? entryHash[1] : null;

    _logger.default.debug(`entryHash MD5: ${entryHash}`);

    _logger.default.debug(`keystore MD5: ${keystoreHash}`);

    let matchesKeystore = entryHash && entryHash === keystoreHash;

    _logger.default.debug(`Matches keystore? ${matchesKeystore}`);

    if (matchesKeystore) {
      foundKeystoreMatch = true;
      return false;
    }
  });
  return foundKeystoreMatch;
};

var _default = apkSigningMethods;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90b29scy9hcGstc2lnbmluZy5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX1BSSVZBVEVfS0VZIiwicGF0aCIsInJlc29sdmUiLCJyb290RGlyIiwiREVGQVVMVF9DRVJUSUZJQ0FURSIsIkRFRkFVTFRfQ0VSVF9ESUdFU1QiLCJCVU5ETEVUT09MX1RVVE9SSUFMIiwiQVBLU0lHTkVSX1ZFUklGWV9GQUlMIiwiYXBrU2lnbmluZ01ldGhvZHMiLCJwYXRjaEFwa3NpZ25lciIsIm9yaWdpbmFsUGF0aCIsIm9yaWdpbmFsQ29udGVudCIsImZzIiwicmVhZEZpbGUiLCJwYXRjaGVkQ29udGVudCIsInJlcGxhY2UiLCJsb2ciLCJkZWJ1ZyIsInBhdGNoZWRQYXRoIiwidGVtcERpciIsInByZWZpeCIsInN1ZmZpeCIsImRpcm5hbWUiLCJ3cml0ZUZpbGUiLCJleGVjdXRlQXBrc2lnbmVyIiwiYXJncyIsImFwa1NpZ25lciIsIm9yaWdpbmFsRm9sZGVyIiwiZ2V0QXBrc2lnbmVyT3V0cHV0IiwiYXBrc2lnbmVyUGF0aCIsImJpbmFyeVBhdGgiLCJzeXN0ZW0iLCJpc1dpbmRvd3MiLCJ1dGlsIiwiaXNTdWJQYXRoIiwiYmFzZW5hbWUiLCJzdGRvdXQiLCJzdGRlcnIiLCJjd2QiLCJuYW1lIiwic3RyZWFtIiwic3BsaXQiLCJmaWx0ZXIiLCJsaW5lIiwiaW5jbHVkZXMiLCJqb2luIiwiSlNPTiIsInN0cmluZ2lmeSIsImVyciIsIndhcm4iLCJtZXNzYWdlIiwicGF0Y2hlZEFwa3NpZ25lciIsInVubGluayIsInNpZ25XaXRoRGVmYXVsdENlcnQiLCJhcGsiLCJleGlzdHMiLCJFcnJvciIsImphdmEiLCJzaWduUGF0aCIsImhlbHBlckphclBhdGgiLCJlIiwic2lnbldpdGhDdXN0b21DZXJ0Iiwia2V5c3RvcmVQYXRoIiwia2V5QWxpYXMiLCJrZXlzdG9yZVBhc3N3b3JkIiwia2V5UGFzc3dvcmQiLCJqYXJzaWduZXIiLCJzaWduIiwiYXBwUGF0aCIsImVuZHNXaXRoIiwiQVBLU19FWFRFTlNJT04iLCJ1c2VLZXlzdG9yZSIsImFwa3NpZ25lckZvdW5kIiwiemlwQWxpZ25BcGsiLCJpbml0WmlwQWxpZ24iLCJiaW5hcmllcyIsInppcGFsaWduIiwiYWxpZ25lZEFwayIsIm12IiwibWtkaXJwIiwiY2hlY2tBcGtDZXJ0IiwicGtnIiwiY2hlY2tDdXN0b21BcGtDZXJ0IiwiZXh0bmFtZSIsImV4dHJhY3RCYXNlQXBrIiwib3V0cHV0IiwiXyIsImgiLCJtZDVTdHIiLCJtZDUiLCJSZWdFeHAiLCJrZXl0b29sIiwia2V5c3RvcmVIYXNoIiwiZ2V0S2V5c3RvcmVNZDUiLCJjaGVja0Fwa0tleXN0b3JlTWF0Y2giLCJtZDVyZSIsImV4ZWMiLCJlbnRyeUhhc2giLCJyc2EiLCJmb3VuZEtleXN0b3JlTWF0Y2giLCJ6aXAiLCJyZWFkRW50cmllcyIsImVudHJ5IiwiZXh0cmFjdEVudHJ5VG8iLCJmaWxlTmFtZSIsInRlc3QiLCJlbnRyeVBhdGgiLCJ0bXBEaXIiLCJlbnRyeUZpbGUiLCJyaW1yYWYiLCJtYXRjaGVzS2V5c3RvcmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsbUJBQW1CLEdBQUdDLGNBQUtDLE9BQUwsQ0FBYUMsZ0JBQWIsRUFBc0IsTUFBdEIsRUFBOEIsYUFBOUIsQ0FBNUI7O0FBQ0EsTUFBTUMsbUJBQW1CLEdBQUdILGNBQUtDLE9BQUwsQ0FBYUMsZ0JBQWIsRUFBc0IsTUFBdEIsRUFBOEIsa0JBQTlCLENBQTVCOztBQUNBLE1BQU1FLG1CQUFtQixHQUFHLGtFQUE1QjtBQUNBLE1BQU1DLG1CQUFtQixHQUFHLDhEQUE1QjtBQUNBLE1BQU1DLHFCQUFxQixHQUFHLGlCQUE5QjtBQUVBLElBQUlDLGlCQUFpQixHQUFHLEVBQXhCOztBQVVBLGVBQWVDLGNBQWYsQ0FBK0JDLFlBQS9CLEVBQTZDO0FBQzNDLFFBQU1DLGVBQWUsR0FBRyxNQUFNQyxrQkFBR0MsUUFBSCxDQUFZSCxZ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O0FBQ0E1RSxvQkFBSUMsS0FBSixDQUFXLHFCQUFvQjZGLGVBQWdCLEVBQS9DOztBQUdBLFFBQUlBLGVBQUosRUFBcUI7QUFDbkJYLE1BQUFBLGtCQUFrQixHQUFHLElBQXJCO0FBQ0EsYUFBTyxLQUFQO0FBQ0Q7QUFDRixHQTlCSyxDQUFOO0FBK0JBLFNBQU9BLGtCQUFQO0FBQ0QsQ0F0Q0Q7O2VBd0NlM0YsaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyLmpzJztcbmltcG9ydCB7IHRlbXBEaXIsIHN5c3RlbSwgbWtkaXJwLCBmcywgemlwLCB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgZ2V0SmF2YUZvck9zLCBnZXRBcGtzaWduZXJGb3JPcywgZ2V0SmF2YUhvbWUsIHJvb3REaXIsIEFQS1NfRVhURU5TSU9OIH0gZnJvbSAnLi4vaGVscGVycy5qcyc7XG5cbmNvbnN0IERFRkFVTFRfUFJJVkFURV9LRVkgPSBwYXRoLnJlc29sdmUocm9vdERpciwgJ2tleXMnLCAndGVzdGtleS5wazgnKTtcbmNvbnN0IERFRkFVTFRfQ0VSVElGSUNBVEUgPSBwYXRoLnJlc29sdmUocm9vdERpciwgJ2tleXMnLCAndGVzdGtleS54NTA5LnBlbScpO1xuY29uc3QgREVGQVVMVF9DRVJUX0RJR0VTVCA9ICdhNDBkYTgwYTU5ZDE3MGNhYTk1MGNmMTVjMThjNDU0ZDQ3YTM5YjI2OTg5ZDhiNjQwZWNkNzQ1YmE3MWJmNWRjJztcbmNvbnN0IEJVTkRMRVRPT0xfVFVUT1JJQUwgPSAnaHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vc3R1ZGlvL2NvbW1hbmQtbGluZS9idW5kbGV0b29sJztcbmNvbnN0IEFQS1NJR05FUl9WRVJJRllfRkFJTCA9ICdET0VTIE5PVCBWRVJJRlknO1xuXG5sZXQgYXBrU2lnbmluZ01ldGhvZHMgPSB7fTtcblxuLyoqXG4gKiBBcHBsaWVzIHRoZSBwYXRjaCwgd2hpY2ggd29ya2Fyb3VuZHMnLURqYXZhLmV4dC5kaXJzIGlzIG5vdCBzdXBwb3J0ZWQuIFVzZSAtY2xhc3NwYXRoIGluc3RlYWQuJ1xuICogZXJyb3Igb24gV2luZG93cyBieSBjcmVhdGluZyBhIHRlbXBvcmFyeSBwYXRjaGVkIGNvcHkgb2YgdGhlIG9yaWdpbmFsIGFwa3NpZ25lciBzY3JpcHQuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IG9yaWdpbmFsUGF0aCAtIFRoZSBvcmlnaW5hbCBwYXRoIHRvIGFwa3NpZ25lciB0b29sXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBwYXRjaGVkIHNjcmlwdCBvciB0aGUgc2FtZSBwYXRoIGlmIHRoZXJlIGlzXG4gKiAgICAgICAgICAgICAgICAgICBubyBuZWVkIHRvIHBhdGNoIHRoZSBvcmlnaW5hbCBmaWxlLlxuICovXG5hc3luYyBmdW5jdGlvbiBwYXRjaEFwa3NpZ25lciAob3JpZ2luYWxQYXRoKSB7XG4gIGNvbnN0IG9yaWdpbmFsQ29udGVudCA9IGF3YWl0IGZzLnJlYWRGaWxlKG9yaWdpbmFsUGF0aCwgJ2FzY2lpJyk7XG4gIGNvbnN0IHBhdGNoZWRDb250ZW50ID0gb3JpZ2luYWxDb250ZW50LnJlcGxhY2UoJy1EamF2YS5leHQuZGlycz1cIiVmcmFtZXdvcmtkaXIlXCInLFxuICAgICctY3AgXCIlZnJhbWV3b3JrZGlyJVxcXFwqXCInKTtcbiAgaWYgKHBhdGNoZWRDb250ZW50ID09PSBvcmlnaW5hbENvbnRlbnQpIHtcbiAgICByZXR1cm4gb3JpZ2luYWxQYXRoO1xuICB9XG4gIGxvZy5kZWJ1ZyhgUGF0Y2hpbmcgJyR7b3JpZ2luYWxQYXRofS4uLmApO1xuICBjb25zdCBwYXRjaGVkUGF0aCA9IGF3YWl0IHRlbXBEaXIucGF0aCh7cHJlZml4OiAnYXBrc2lnbmVyJywgc3VmZml4OiAnLmJhdCd9KTtcbiAgYXdhaXQgbWtkaXJwKHBhdGguZGlybmFtZShwYXRjaGVkUGF0aCkpO1xuICBhd2FpdCBmcy53cml0ZUZpbGUocGF0Y2hlZFBhdGgsIHBhdGNoZWRDb250ZW50LCAnYXNjaWknKTtcbiAgcmV0dXJuIHBhdGNoZWRQYXRoO1xufVxuXG4vKipcbiAqIEV4ZWN1dGUgYXBrc2lnbmVyIHV0aWxpdHkgd2l0aCBnaXZlbiBhcmd1bWVudHMuXG4gKlxuICogQHBhcmFtIHs/QXJyYXk8U3RyaW5nPn0gYXJncyAtIFRoZSBsaXN0IG9mIHRvb2wgYXJndW1lbnRzLlxuICogQHJldHVybiB7c3RyaW5nfSAtIENvbW1hbmQgc3Rkb3V0XG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgYXBrc2lnbmVyIGJpbmFyeSBpcyBub3QgcHJlc2VudCBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW1cbiAqICAgICAgICAgICAgICAgICBvciB0aGUgcmV0dXJuIGNvZGUgaXMgbm90IGVxdWFsIHRvIHplcm8uXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLmV4ZWN1dGVBcGtzaWduZXIgPSBhc3luYyBmdW5jdGlvbiAoYXJncyA9IFtdKSB7XG4gIGNvbnN0IGFwa1NpZ25lciA9IGF3YWl0IGdldEFwa3NpZ25lckZvck9zKHRoaXMpO1xuICBjb25zdCBvcmlnaW5hbEZvbGRlciA9IHBhdGguZGlybmFtZShhcGtTaWduZXIpO1xuICBjb25zdCBnZXRBcGtzaWduZXJPdXRwdXQgPSBhc3luYyAoYXBrc2lnbmVyUGF0aCkgPT4ge1xuICAgIGxldCBiaW5hcnlQYXRoID0gYXBrc2lnbmVyUGF0aDtcbiAgICBpZiAoc3lzdGVtLmlzV2luZG93cygpICYmIHV0aWwuaXNTdWJQYXRoKGJpbmFyeVBhdGgsIG9yaWdpbmFsRm9sZGVyKSkge1xuICAgICAgLy8gV29ya2Fyb3VuZCBmb3IgaHR0cHM6Ly9naXRodWIuY29tL25vZGVqcy9ub2RlLXYwLngtYXJjaGl2ZS9pc3N1ZXMvMjU4OTVcbiAgICAgIGJpbmFyeVBhdGggPSBwYXRoLmJhc2VuYW1lKGJpbmFyeVBhdGgpO1xuICAgIH1cbiAgICBjb25zdCB7c3Rkb3V0LCBzdGRlcnJ9ID0gYXdhaXQgZXhlYyhiaW5hcnlQYXRoLCBhcmdzLCB7XG4gICAgICBjd2Q6IG9yaWdpbmFsRm9sZGVyXG4gICAgfSk7XG4gICAgZm9yIChsZXQgW25hbWUsIHN0cmVhbV0gb2YgW1snc3Rkb3V0Jywgc3Rkb3V0XSwgWydzdGRlcnInLCBzdGRlcnJdXSkge1xuICAgICAgaWYgKCFzdHJlYW0pIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGlmIChuYW1lID09PSAnc3Rkb3V0Jykge1xuICAgICAgICAvLyBNYWtlIHRoZSBvdXRwdXQgbGVzcyB0YWxrYXRpdmVcbiAgICAgICAgc3RyZWFtID0gc3RyZWFtLnNwbGl0KCdcXG4nKVxuICAgICAgICAgIC5maWx0ZXIoKGxpbmUpID0+ICFsaW5lLmluY2x1ZGVzKCdXQVJOSU5HOicpKVxuICAgICAgICAgIC5qb2luKCdcXG4nKTtcbiAgICAgIH1cbiAgICAgIGxvZy5kZWJ1ZyhgYXBrc2lnbmVyICR7bmFtZX06ICR7c3RyZWFtfWApO1xuICAgIH1cbiAgICByZXR1cm4gc3Rkb3V0O1xuICB9O1xuICBsb2cuZGVidWcoYFN0YXJ0aW5nICcke2Fwa1NpZ25lcn0nIHdpdGggYXJncyAnJHtKU09OLnN0cmluZ2lmeShhcmdzKX0nYCk7XG4gIHRyeSB7XG4gICAgcmV0dXJuIGF3YWl0IGdldEFwa3NpZ25lck91dHB1dChhcGtTaWduZXIpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgR290IGFuIGVycm9yIGR1cmluZyBhcGtzaWduZXIgZXhlY3V0aW9uOiAke2Vyci5tZXNzYWdlfWApO1xuICAgIGZvciAoY29uc3QgW25hbWUsIHN0cmVhbV0gb2YgW1snc3Rkb3V0JywgZXJyLnN0ZG91dF0sIFsnc3RkZXJyJywgZXJyLnN0ZGVycl1dKSB7XG4gICAgICBpZiAoc3RyZWFtKSB7XG4gICAgICAgIGxvZy53YXJuKGBhcGtzaWduZXIgJHtuYW1lfTogJHtzdHJlYW19YCk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChzeXN0ZW0uaXNXaW5kb3dzKCkpIHtcbiAgICAgIGNvbnN0IHBhdGNoZWRBcGtzaWduZXIgPSBhd2FpdCBwYXRjaEFwa3NpZ25lcihhcGtTaWduZXIpO1xuICAgICAgaWYgKHBhdGNoZWRBcGtzaWduZXIgIT09IGFwa1NpZ25lcikge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHJldHVybiBhd2FpdCBnZXRBcGtzaWduZXJPdXRwdXQocGF0Y2hlZEFwa3NpZ25lcik7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgYXdhaXQgZnMudW5saW5rKHBhdGNoZWRBcGtzaWduZXIpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHRocm93IGVycjtcbiAgfVxufTtcblxuLyoqXG4gKiAoUmUpc2lnbiB0aGUgZ2l2ZW4gYXBrIGZpbGUgb24gdGhlIGxvY2FsIGZpbGUgc3lzdGVtIHdpdGggdGhlIGRlZmF1bHQgY2VydGlmaWNhdGUuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwayAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIGxvY2FsIGFwayBmaWxlLlxuICogQHRocm93cyB7RXJyb3J9IElmIHNpZ25pbmcgZmFpbHMuXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLnNpZ25XaXRoRGVmYXVsdENlcnQgPSBhc3luYyBmdW5jdGlvbiAoYXBrKSB7XG4gIGxvZy5kZWJ1ZyhgU2lnbmluZyAnJHthcGt9JyB3aXRoIGRlZmF1bHQgY2VydGApO1xuICBpZiAoIShhd2FpdCBmcy5leGlzdHMoYXBrKSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYCR7YXBrfSBmaWxlIGRvZXNuJ3QgZXhpc3QuYCk7XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IGFyZ3MgPSBbJ3NpZ24nLFxuICAgICAgJy0ta2V5JywgREVGQVVMVF9QUklWQVRFX0tFWSxcbiAgICAgICctLWNlcnQnLCBERUZBVUxUX0NFUlRJRklDQVRFLFxuICAgICAgYXBrXTtcbiAgICBhd2FpdCB0aGlzLmV4ZWN1dGVBcGtzaWduZXIoYXJncyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBDYW5ub3QgdXNlIGFwa3NpZ25lciB0b29sIGZvciBzaWduaW5nLiBEZWZhdWx0aW5nIHRvIHNpZ24uamFyLiBgICtcbiAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlcnIubWVzc2FnZX1gICsgKGVyci5zdGRlcnIgPyBgOyBTdGRFcnI6ICR7ZXJyLnN0ZGVycn1gIDogJycpKTtcbiAgICBjb25zdCBqYXZhID0gZ2V0SmF2YUZvck9zKCk7XG4gICAgY29uc3Qgc2lnblBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5oZWxwZXJKYXJQYXRoLCAnc2lnbi5qYXInKTtcbiAgICBsb2cuZGVidWcoXCJSZXNpZ25pbmcgYXBrLlwiKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZXhlYyhqYXZhLCBbJy1qYXInLCBzaWduUGF0aCwgYXBrLCAnLS1vdmVycmlkZSddKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBzaWduIHdpdGggZGVmYXVsdCBjZXJ0aWZpY2F0ZS4gT3JpZ2luYWwgZXJyb3IgJHtlLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG59O1xuXG4vKipcbiAqIChSZSlzaWduIHRoZSBnaXZlbiBhcGsgZmlsZSBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW0gd2l0aCBhIGN1c3RvbSBjZXJ0aWZpY2F0ZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBrIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgbG9jYWwgYXBrIGZpbGUuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgc2lnbmluZyBmYWlscy5cbiAqL1xuYXBrU2lnbmluZ01ldGhvZHMuc2lnbldpdGhDdXN0b21DZXJ0ID0gYXN5bmMgZnVuY3Rpb24gKGFwaykge1xuICBsb2cuZGVidWcoYFNpZ25pbmcgJyR7YXBrfScgd2l0aCBjdXN0b20gY2VydGApO1xuICBpZiAoIShhd2FpdCBmcy5leGlzdHModGhpcy5rZXlzdG9yZVBhdGgpKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgS2V5c3RvcmU6ICR7dGhpcy5rZXlzdG9yZVBhdGh9IGRvZXNuJ3QgZXhpc3QuYCk7XG4gIH1cbiAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKGFwaykpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGAnJHthcGt9JyBkb2Vzbid0IGV4aXN0LmApO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBhcmdzID0gWydzaWduJyxcbiAgICAgICctLWtzJywgdGhpcy5rZXlzdG9yZVBhdGgsXG4gICAgICAnLS1rcy1rZXktYWxpYXMnLCB0aGlzLmtleUFsaWFzLFxuICAgICAgJy0ta3MtcGFzcycsIGBwYXNzOiR7dGhpcy5rZXlzdG9yZVBhc3N3b3JkfWAsXG4gICAgICAnLS1rZXktcGFzcycsIGBwYXNzOiR7dGhpcy5rZXlQYXNzd29yZH1gLFxuICAgICAgYXBrXTtcbiAgICBhd2FpdCB0aGlzLmV4ZWN1dGVBcGtzaWduZXIoYXJncyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBDYW5ub3QgdXNlIGFwa3NpZ25lciB0b29sIGZvciBzaWduaW5nLiBEZWZhdWx0aW5nIHRvIGphcnNpZ25lci4gYCArXG4gICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgdHJ5IHtcbiAgICAgIGxvZy5kZWJ1ZyhcIlVuc2lnbmluZyBhcGsuXCIpO1xuICAgICAgYXdhaXQgZXhlYyhnZXRKYXZhRm9yT3MoKSwgWyctamFyJywgcGF0aC5yZXNvbHZlKHRoaXMuaGVscGVySmFyUGF0aCwgJ3Vuc2lnbi5qYXInKSwgYXBrXSk7XG4gICAgICBsb2cuZGVidWcoXCJTaWduaW5nIGFway5cIik7XG4gICAgICBjb25zdCBqYXJzaWduZXIgPSBwYXRoLnJlc29sdmUoZ2V0SmF2YUhvbWUoKSwgJ2JpbicsIGBqYXJzaWduZXIke3N5c3RlbS5pc1dpbmRvd3MoKSA/ICcuZXhlJyA6ICcnfWApO1xuICAgICAgYXdhaXQgZXhlYyhqYXJzaWduZXIsIFsnLXNpZ2FsZycsICdNRDV3aXRoUlNBJywgJy1kaWdlc3RhbGcnLCAnU0hBMScsXG4gICAgICAgICcta2V5c3RvcmUnLCB0aGlzLmtleXN0b3JlUGF0aCwgJy1zdG9yZXBhc3MnLCB0aGlzLmtleXN0b3JlUGFzc3dvcmQsXG4gICAgICAgICcta2V5cGFzcycsIHRoaXMua2V5UGFzc3dvcmQsIGFwaywgdGhpcy5rZXlBbGlhc10pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IHNpZ24gd2l0aCBjdXN0b20gY2VydGlmaWNhdGUuIE9yaWdpbmFsIGVycm9yICR7ZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxufTtcblxuLyoqXG4gKiAoUmUpc2lnbiB0aGUgZ2l2ZW4gYXBrIGZpbGUgb24gdGhlIGxvY2FsIGZpbGUgc3lzdGVtIHdpdGggZWl0aGVyXG4gKiBjdXN0b20gb3IgZGVmYXVsdCBjZXJ0aWZpY2F0ZSBiYXNlZCBvbiBfdGhpcy51c2VLZXlzdG9yZV8gcHJvcGVydHkgdmFsdWVcbiAqIGFuZCBaaXAtYWxpZ25zIGl0IGFmdGVyIHNpZ25pbmcuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwcFBhdGggLSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBsb2NhbCAuYXBrKHMpIGZpbGUuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgc2lnbmluZyBmYWlscy5cbiAqL1xuYXBrU2lnbmluZ01ldGhvZHMuc2lnbiA9IGFzeW5jIGZ1bmN0aW9uIChhcHBQYXRoKSB7XG4gIGlmIChhcHBQYXRoLmVuZHNXaXRoKEFQS1NfRVhURU5TSU9OKSkge1xuICAgIGxldCBtZXNzYWdlID0gJ1NpZ25pbmcgb2YgLmFwa3MtZmlsZXMgaXMgbm90IHN1cHBvcnRlZC4gJztcbiAgICBpZiAodGhpcy51c2VLZXlzdG9yZSkge1xuICAgICAgbWVzc2FnZSArPSAnQ29uc2lkZXIgbWFudWFsIGFwcGxpY2F0aW9uIGJ1bmRsZSBzaWduaW5nIHdpdGggdGhlIGN1c3RvbSBrZXlzdG9yZSAnICtcbiAgICAgICAgYGxpa2UgaXQgaXMgZGVzY3JpYmVkIGF0ICR7QlVORExFVE9PTF9UVVRPUklBTH1gO1xuICAgIH0gZWxzZSB7XG4gICAgICBtZXNzYWdlICs9IGBDb25zaWRlciBtYW51YWwgYXBwbGljYXRpb24gYnVuZGxlIHNpZ25pbmcgd2l0aCB0aGUga2V5IGF0ICcke0RFRkFVTFRfUFJJVkFURV9LRVl9JyBgICtcbiAgICAgICAgYGFuZCB0aGUgY2VydGlmaWNhdGUgYXQgJyR7REVGQVVMVF9DRVJUSUZJQ0FURX0nLiBSZWFkICR7QlVORExFVE9PTF9UVVRPUklBTH0gZm9yIG1vcmUgZGV0YWlscy5gO1xuICAgIH1cbiAgICBsb2cud2FybihtZXNzYWdlKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBsZXQgYXBrc2lnbmVyRm91bmQgPSB0cnVlO1xuICB0cnkge1xuICAgIGF3YWl0IGdldEFwa3NpZ25lckZvck9zKHRoaXMpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBhcGtzaWduZXJGb3VuZCA9IGZhbHNlO1xuICB9XG5cbiAgaWYgKGFwa3NpZ25lckZvdW5kKSB7XG4gICAgLy8gaXQgaXMgbmVjZXNzYXJ5IHRvIGFwcGx5IHppcGFsaWduIG9ubHkgYmVmb3JlIHNpZ25pbmdcbiAgICAvLyBpZiBhcGtzaWduZXIgaXMgdXNlZCBvciBvbmx5IGFmdGVyIHNpZ25pbmcgaWYgd2Ugb25seSBoYXZlXG4gICAgLy8gc2lnbi5qYXIgdXRpbGl0eVxuICAgIGF3YWl0IHRoaXMuemlwQWxpZ25BcGsoYXBwUGF0aCk7XG4gIH1cblxuICBpZiAodGhpcy51c2VLZXlzdG9yZSkge1xuICAgIGF3YWl0IHRoaXMuc2lnbldpdGhDdXN0b21DZXJ0KGFwcFBhdGgpO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IHRoaXMuc2lnbldpdGhEZWZhdWx0Q2VydChhcHBQYXRoKTtcbiAgfVxuXG4gIGlmICghYXBrc2lnbmVyRm91bmQpIHtcbiAgICBhd2FpdCB0aGlzLnppcEFsaWduQXBrKGFwcFBhdGgpO1xuICB9XG59O1xuXG4vKipcbiAqIFBlcmZvcm0gemlwLWFsaWduaW5nIHRvIHRoZSBnaXZlbiBsb2NhbCBhcGsgZmlsZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBrIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgbG9jYWwgYXBrIGZpbGUuXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgYXBrIGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSBhbGlnbmVkXG4gKiBvciBmYWxzZSBpZiB0aGUgYXBrIGhhcyBiZWVuIGFscmVhZHkgYWxpZ25lZC5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB6aXAtYWxpZ24gZmFpbHMuXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLnppcEFsaWduQXBrID0gYXN5bmMgZnVuY3Rpb24gKGFwaykge1xuICBhd2FpdCB0aGlzLmluaXRaaXBBbGlnbigpO1xuICB0cnkge1xuICAgIGF3YWl0IGV4ZWModGhpcy5iaW5hcmllcy56aXBhbGlnbiwgWyctYycsICc0JywgYXBrXSk7XG4gICAgbG9nLmRlYnVnKGAke2Fwa30nIGlzIGFscmVhZHkgemlwLWFsaWduZWQuIERvaW5nIG5vdGhpbmdgKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2cuZGVidWcoYCcke2Fwa30nIGlzIG5vdCB6aXAtYWxpZ25lZC4gQWxpZ25pbmdgKTtcbiAgfVxuICBjb25zdCBhbGlnbmVkQXBrID0gYXdhaXQgdGVtcERpci5wYXRoKHtwcmVmaXg6ICdhcHBpdW0nLCBzdWZmaXg6ICcudG1wJ30pO1xuICBhd2FpdCBta2RpcnAocGF0aC5kaXJuYW1lKGFsaWduZWRBcGspKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBleGVjKHRoaXMuYmluYXJpZXMuemlwYWxpZ24sIFsnLWYnLCAnNCcsIGFwaywgYWxpZ25lZEFwa10pO1xuICAgIGF3YWl0IGZzLm12KGFsaWduZWRBcGssIGFwaywgeyBta2RpcnA6IHRydWUgfSk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoYXdhaXQgZnMuZXhpc3RzKGFsaWduZWRBcGspKSB7XG4gICAgICBhd2FpdCBmcy51bmxpbmsoYWxpZ25lZEFwayk7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcihgemlwQWxpZ25BcGsgZmFpbGVkLiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9LiBTdGRvdXQ6ICcke2Uuc3Rkb3V0fSc7IFN0ZGVycjogJyR7ZS5zdGRlcnJ9J2ApO1xuICB9XG59O1xuXG4vKipcbiAqIENoZWNrIGlmIHRoZSBhcHAgaXMgYWxyZWFkeSBzaWduZWQgd2l0aCB0aGUgZGVmYXVsdCBBcHBpdW0gY2VydGlmaWNhdGUuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwcFBhdGggLSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBsb2NhbCAuYXBrKHMpIGZpbGUuXG4gKiBAcGFyYW0ge3N0cmluZ30gcGdrIC0gVGhlIG5hbWUgb2YgYXBwbGljYXRpb24gcGFja2FnZS5cbiAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgZ2l2ZW4gYXBwbGljYXRpb24gaXMgYWxyZWFkeSBzaWduZWQuXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLmNoZWNrQXBrQ2VydCA9IGFzeW5jIGZ1bmN0aW9uIChhcHBQYXRoLCBwa2cpIHtcbiAgbG9nLmRlYnVnKGBDaGVja2luZyBhcHAgY2VydCBmb3IgJHthcHBQYXRofWApO1xuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhhcHBQYXRoKSkge1xuICAgIGxvZy5kZWJ1ZyhgJyR7YXBwUGF0aH0nIGRvZXMgbm90IGV4aXN0YCk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgaWYgKHRoaXMudXNlS2V5c3RvcmUpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5jaGVja0N1c3RvbUFwa0NlcnQoYXBwUGF0aCwgcGtnKTtcbiAgfVxuXG4gIGlmIChwYXRoLmV4dG5hbWUoYXBwUGF0aCkgPT09IEFQS1NfRVhURU5TSU9OKSB7XG4gICAgYXBwUGF0aCA9IGF3YWl0IHRoaXMuZXh0cmFjdEJhc2VBcGsoYXBwUGF0aCk7XG4gIH1cblxuICB0cnkge1xuICAgIGF3YWl0IGdldEFwa3NpZ25lckZvck9zKHRoaXMpO1xuICAgIGNvbnN0IG91dHB1dCA9IGF3YWl0IHRoaXMuZXhlY3V0ZUFwa3NpZ25lcihbJ3ZlcmlmeScsICctLXByaW50LWNlcnRzJywgYXBwUGF0aF0pO1xuICAgIGlmICghXy5pbmNsdWRlcyhvdXRwdXQsIERFRkFVTFRfQ0VSVF9ESUdFU1QpKSB7XG4gICAgICBsb2cuZGVidWcoYCcke2FwcFBhdGh9JyBpcyBzaWduZWQgd2l0aCBub24tZGVmYXVsdCBjZXJ0aWZpY2F0ZWApO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYCcke2FwcFBhdGh9JyBpcyBhbHJlYWR5IHNpZ25lZC5gKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gY2hlY2sgaWYgdGhlcmUgaXMgbm8gc2lnbmF0dXJlXG4gICAgaWYgKGVyci5zdGRlcnIgJiYgZXJyLnN0ZGVyci5pbmNsdWRlcyhBUEtTSUdORVJfVkVSSUZZX0ZBSUwpKSB7XG4gICAgICBsb2cuZGVidWcoYCcke2FwcFBhdGh9JyBpcyBub3Qgc2lnbmVkIHdpdGggZGVidWcgY2VydGApO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBsb2cud2FybihgQ2Fubm90IHVzZSBhcGtzaWduZXIgdG9vbCBmb3Igc2lnbmF0dXJlIHZlcmlmaWNhdGlvbi4gYCArXG4gICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cblxuICAvLyBkZWZhdWx0IHRvIHZlcmlmeS5qYXJcbiAgdHJ5IHtcbiAgICBsb2cuZGVidWcoYERlZmF1bHRpbmcgdG8gdmVyaWZ5LmphcmApO1xuICAgIGF3YWl0IGV4ZWMoZ2V0SmF2YUZvck9zKCksIFsnLWphcicsIHBhdGgucmVzb2x2ZSh0aGlzLmhlbHBlckphclBhdGgsICd2ZXJpZnkuamFyJyksIGFwcFBhdGhdKTtcbiAgICBsb2cuZGVidWcoYCcke2FwcFBhdGh9JyBpcyBhbHJlYWR5IHNpZ25lZC5gKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmRlYnVnKGAnJHthcHBQYXRofScgaXMgbm90IHNpZ25lZCB3aXRoIGRlYnVnIGNlcnQke2Vyci5zdGRlcnIgPyBgOiAke2Vyci5zdGRlcnJ9YCA6ICcnfWApO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufTtcblxuLyoqXG4gKiBDaGVjayBpZiB0aGUgYXBwIGlzIGFscmVhZHkgc2lnbmVkIHdpdGggYSBjdXN0b20gY2VydGlmaWNhdGUuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwcFBhdGggLSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBsb2NhbCBhcGsocykgZmlsZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBwZ2sgLSBUaGUgbmFtZSBvZiBhcHBsaWNhdGlvbiBwYWNrYWdlLlxuICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBnaXZlbiBhcHBsaWNhdGlvbiBpcyBhbHJlYWR5IHNpZ25lZCB3aXRoIGEgY3VzdG9tIGNlcnRpZmljYXRlLlxuICovXG5hcGtTaWduaW5nTWV0aG9kcy5jaGVja0N1c3RvbUFwa0NlcnQgPSBhc3luYyBmdW5jdGlvbiAoYXBwUGF0aCwgcGtnKSB7XG4gIGxvZy5kZWJ1ZyhgQ2hlY2tpbmcgY3VzdG9tIGFwcCBjZXJ0IGZvciAke2FwcFBhdGh9YCk7XG5cbiAgaWYgKHBhdGguZXh0bmFtZShhcHBQYXRoKSA9PT0gQVBLU19FWFRFTlNJT04pIHtcbiAgICBhcHBQYXRoID0gYXdhaXQgdGhpcy5leHRyYWN0QmFzZUFwayhhcHBQYXRoKTtcbiAgfVxuXG4gIGxldCBoID0gXCJhLWZBLUYwLTlcIjtcbiAgbGV0IG1kNVN0ciA9IFtgLipNRDUuKigoPzpbJHtofV17Mn06KXsxNX1bJHtofV17Mn0pYF07XG4gIGxldCBtZDUgPSBuZXcgUmVnRXhwKG1kNVN0ciwgJ21pJyk7XG4gIGxldCBrZXl0b29sID0gcGF0aC5yZXNvbHZlKGdldEphdmFIb21lKCksICdiaW4nLCBga2V5dG9vbCR7c3lzdGVtLmlzV2luZG93cygpID8gJy5leGUnIDogJyd9YCk7XG4gIGxldCBrZXlzdG9yZUhhc2ggPSBhd2FpdCB0aGlzLmdldEtleXN0b3JlTWQ1KGtleXRvb2wsIG1kNSk7XG4gIHJldHVybiBhd2FpdCB0aGlzLmNoZWNrQXBrS2V5c3RvcmVNYXRjaChrZXl0b29sLCBtZDUsIGtleXN0b3JlSGFzaCwgcGtnLCBhcHBQYXRoKTtcbn07XG5cbi8qKlxuICogR2V0IHRoZSBNRDUgaGFzaCBvZiB0aGUga2V5c3RvcmUuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGtleXRvb2wgLSBUaGUgbmFtZSBvZiB0aGUga2V5dG9vbCB1dGlsaXR5LlxuICogQHBhcmFtIHtSZWdFeHB9IG1kNXJlIC0gVGhlIHBhdHRlcm4gdXNlZCB0byBtYXRjaCB0aGUgcmVzdWx0IGluIF9rZXl0b29sXyBvdXRwdXQuXG4gKiBAcmV0dXJuIHs/c3RyaW5nfSBLZXlzdG9yZSBNRDUgaGFzaCBvciBfbnVsbF8gaWYgdGhlIGhhc2ggY2Fubm90IGJlIHBhcnNlZC5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBnZXR0aW5nIGtleXN0b3JlIE1ENSBoYXNoIGZhaWxzLlxuICovXG5hcGtTaWduaW5nTWV0aG9kcy5nZXRLZXlzdG9yZU1kNSA9IGFzeW5jIGZ1bmN0aW9uIChrZXl0b29sLCBtZDVyZSkge1xuICBsb2cuZGVidWcoXCJQcmludGluZyBrZXlzdG9yZSBtZDUuXCIpO1xuICB0cnkge1xuICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoa2V5dG9vbCwgWyctdicsICctbGlzdCcsXG4gICAgICAnLWFsaWFzJywgdGhpcy5rZXlBbGlhcyxcbiAgICAgICcta2V5c3RvcmUnLCB0aGlzLmtleXN0b3JlUGF0aCxcbiAgICAgICctc3RvcmVwYXNzJywgdGhpcy5rZXlzdG9yZVBhc3N3b3JkXSk7XG4gICAgbGV0IGtleXN0b3JlSGFzaCA9IG1kNXJlLmV4ZWMoc3Rkb3V0KTtcbiAgICBrZXlzdG9yZUhhc2ggPSBrZXlzdG9yZUhhc2ggPyBrZXlzdG9yZUhhc2hbMV0gOiBudWxsO1xuICAgIGxvZy5kZWJ1ZyhgS2V5c3RvcmUgTUQ1OiAke2tleXN0b3JlSGFzaH1gKTtcbiAgICByZXR1cm4ga2V5c3RvcmVIYXNoO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBnZXRLZXlzdG9yZU1kNSBmYWlsZWQuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgfVxufTtcblxuLyoqXG4gKiBDaGVjayBpZiB0aGUgTUQ1IGhhc2ggb2YgdGhlIHBhcnRpY3VsYXIgYXBwbGljYXRpb24gbWF0Y2hlcyB0byB0aGUgZ2l2ZW4gaGFzaC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30ga2V5dG9vbCAtIFRoZSBuYW1lIG9mIHRoZSBrZXl0b29sIHV0aWxpdHkuXG4gKiBAcGFyYW0ge1JlZ0V4cH0gbWQ1cmUgLSBUaGUgcGF0dGVybiB1c2VkIHRvIG1hdGNoIHRoZSByZXN1bHQgaW4gX2tleXRvb2xfIG91dHB1dC5cbiAqIEBwYXJhbSB7c3RyaW5nfSBrZXlzdG9yZUhhc2ggLSBUaGUgZXhwZWN0ZWQgaGFzaCB2YWx1ZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBwa2cgLSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFsbGVkIHBhY2thZ2UuXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBrIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgZXhpc3RpbmcgYXBrIGZpbGUuXG4gKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIGJvdGggaGFzaGVzIGFyZSBlcXVhbC5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBnZXR0aW5nIGtleXN0b3JlIE1ENSBoYXNoIGZhaWxzLlxuICovXG5hcGtTaWduaW5nTWV0aG9kcy5jaGVja0Fwa0tleXN0b3JlTWF0Y2ggPSBhc3luYyBmdW5jdGlvbiAoa2V5dG9vbCwgbWQ1cmUsIGtleXN0b3JlSGFzaCwgcGtnLCBhcGspIHtcbiAgbGV0IGVudHJ5SGFzaCA9IG51bGw7XG4gIGxldCByc2EgPSAvXk1FVEEtSU5GXFwvLipcXC5bclJdW3NTXVthQV0kLztcbiAgbGV0IGZvdW5kS2V5c3RvcmVNYXRjaCA9IGZhbHNlO1xuXG4gIC8vZm9yIChsZXQgZW50cnkgb2YgZW50cmllcykge1xuICBhd2FpdCB6aXAucmVhZEVudHJpZXMoYXBrLCBhc3luYyAoe2VudHJ5LCBleHRyYWN0RW50cnlUb30pID0+IHtcbiAgICBlbnRyeSA9IGVudHJ5LmZpbGVOYW1lO1xuICAgIGlmICghcnNhLnRlc3QoZW50cnkpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgRW50cnk6ICR7ZW50cnl9YCk7XG4gICAgbGV0IGVudHJ5UGF0aCA9IHBhdGguam9pbih0aGlzLnRtcERpciwgcGtnLCAnY2VydCcpO1xuICAgIGxvZy5kZWJ1ZyhgZW50cnlQYXRoOiAke2VudHJ5UGF0aH1gKTtcbiAgICBsZXQgZW50cnlGaWxlID0gcGF0aC5qb2luKGVudHJ5UGF0aCwgZW50cnkpO1xuICAgIGxvZy5kZWJ1ZyhgZW50cnlGaWxlOiAke2VudHJ5RmlsZX1gKTtcbiAgICAvLyBlbnN1cmUgL3RtcC9wa2cvY2VydC8gZG9lc24ndCBleGlzdCBvciBleHRyYWN0IHdpbGwgZmFpbC5cbiAgICBhd2FpdCBmcy5yaW1yYWYoZW50cnlQYXRoKTtcbiAgICAvLyBNRVRBLUlORi9DRVJULlJTQVxuICAgIGF3YWl0IGV4dHJhY3RFbnRyeVRvKGVudHJ5UGF0aCk7XG4gICAgbG9nLmRlYnVnKFwiZXh0cmFjdGVkIVwiKTtcbiAgICAvLyBjaGVjayBmb3IgbWF0Y2hcbiAgICBsb2cuZGVidWcoXCJQcmludGluZyBhcGsgbWQ1LlwiKTtcbiAgICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKGtleXRvb2wsIFsnLXYnLCAnLXByaW50Y2VydCcsICctZmlsZScsIGVudHJ5RmlsZV0pO1xuICAgIGVudHJ5SGFzaCA9IG1kNXJlLmV4ZWMoc3Rkb3V0KTtcbiAgICBlbnRyeUhhc2ggPSBlbnRyeUhhc2ggPyBlbnRyeUhhc2hbMV0gOiBudWxsO1xuICAgIGxvZy5kZWJ1ZyhgZW50cnlIYXNoIE1ENTogJHtlbnRyeUhhc2h9YCk7XG4gICAgbG9nLmRlYnVnKGBrZXlzdG9yZSBNRDU6ICR7a2V5c3RvcmVIYXNofWApO1xuICAgIGxldCBtYXRjaGVzS2V5c3RvcmUgPSBlbnRyeUhhc2ggJiYgZW50cnlIYXNoID09PSBrZXlzdG9yZUhhc2g7XG4gICAgbG9nLmRlYnVnKGBNYXRjaGVzIGtleXN0b3JlPyAke21hdGNoZXNLZXlzdG9yZX1gKTtcblxuICAgIC8vIElmIHdlIGhhdmUgYSBrZXlzdG9yZSBtYXRjaCwgc3RvcCBpdGVyYXRpbmdcbiAgICBpZiAobWF0Y2hlc0tleXN0b3JlKSB7XG4gICAgICBmb3VuZEtleXN0b3JlTWF0Y2ggPSB0cnVlO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfSk7XG4gIHJldHVybiBmb3VuZEtleXN0b3JlTWF0Y2g7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBhcGtTaWduaW5nTWV0aG9kcztcbiJdLCJmaWxlIjoibGliL3Rvb2xzL2Fway1zaWduaW5nLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
