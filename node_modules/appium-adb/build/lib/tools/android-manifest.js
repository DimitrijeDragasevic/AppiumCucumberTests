"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger.js"));

var _helpers = require("../helpers.js");

var _appiumSupport = require("appium-support");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _xmldom = _interopRequireDefault(require("xmldom"));

var _xpath = _interopRequireDefault(require("xpath"));

var _shellQuote = require("shell-quote");

let manifestMethods = {};

manifestMethods.processFromManifest = async function (localApk) {
  await this.initAapt();

  _logger.default.info("Retrieving process from manifest");

  let args = ['dump', 'xmltree', localApk, 'AndroidManifest.xml'];
  let {
    stdout
  } = await (0, _teen_process.exec)(this.binaries.aapt, args);
  let result = null;
  let lines = stdout.split("\n");
  let applicationRegex = new RegExp(/\s+E: application \(line=\d+\).*/);
  let applicationFound = false;
  let attributeRegex = new RegExp(/\s+A: .+/);
  let processRegex = new RegExp(/\s+A: android:process\(0x01010011\)="([^"]+).*"/);

  for (let line of lines) {
    if (!applicationFound) {
      if (applicationRegex.test(line)) {
        applicationFound = true;
      }
    } else {
      let notAttribute = !attributeRegex.test(line);

      if (notAttribute) {
        break;
      }

      let process = processRegex.exec(line);

      if (process && process.length > 1) {
        result = process[1];

        if (result.length > 15) {
          result = result.substr(result.length - 15);
        }

        break;
      }
    }
  }

  return result;
};

async function extractApkInfoWithApkTools(localApk, aaptPath, jarPath, tmpRoot) {
  _logger.default.info("Extracting package and launch activity from manifest");

  let args = ['dump', 'badging', localApk];
  let stdout = (await (0, _teen_process.exec)(aaptPath, args)).stdout;
  let apkPackage = new RegExp(/package: name='([^']+)'/g).exec(stdout);

  if (!apkPackage || apkPackage.length < 2) {
    throw new Error(`Cannot parse package name from ` + `'${_lodash.default.join([aaptPath, 'dump', 'badging', '"' + localApk + '"'], ' ')}' command  output`);
  }

  apkPackage = apkPackage[1];
  let apkActivity = new RegExp(/launchable-activity: name='([^']+)'/g).exec(stdout);

  if (apkActivity && apkActivity.length >= 2) {
    apkActivity = apkActivity[1];
    return {
      apkPackage,
      apkActivity
    };
  }

  let outputPath = _path.default.resolve(tmpRoot, apkPackage);

  let getLaunchActivity = ['-jar', jarPath, 'printLaunchActivity', localApk, outputPath];
  const output = await (0, _teen_process.exec)('java', getLaunchActivity);

  if (output.stderr) {
    throw new Error(`Cannot parse launchActivity from manifest: ${output.stderr}`);
  }

  stdout = output.stdout;
  let act = new RegExp(/Launch activity parsed:([^']+)/g).exec(stdout);

  if (act && act.length >= 2) {
    apkActivity = act[1];
    return {
      apkPackage,
      apkActivity
    };
  }

  throw new Error(`Cannot parse main activity name from '${stdout}' command  output`);
}

async function extractApkInfoWithApkanalyzer(localApk, apkanalyzerPath) {
  const args = ['-h', 'manifest', 'print', localApk];

  _logger.default.debug(`Starting '${apkanalyzerPath}' with args ${JSON.stringify(args)}`);

  const manifestXml = (await (0, _teen_process.exec)(apkanalyzerPath, args, {
    shell: true,
    cwd: _path.default.dirname(apkanalyzerPath)
  })).stdout;
  const doc = new _xmldom.default.DOMParser().parseFromString(manifestXml);

  const apkPackageAttribute = _xpath.default.select1('//manifest/@package', doc);

  if (!apkPackageAttribute) {
    throw new Error(`Cannot parse package name from ${manifestXml}`);
  }

  const apkPackage = apkPackageAttribute.value;

  const apkActivityAttribute = _xpath.default.select1("//application/*[starts-with(name(), 'activity') " + "and .//action[@*[local-name()='name' and .='android.intent.action.MAIN']] " + "and .//category[@*[local-name()='name' and .='android.intent.category.LAUNCHER']]]" + "/@*[local-name()='name']", doc);

  if (!apkActivityAttribute) {
    throw new Error(`Cannot parse main activity name from ${manifestXml}`);
  }

  const apkActivity = apkActivityAttribute.value;
  return {
    apkPackage,
    apkActivity
  };
}

manifestMethods.packageAndLaunchActivityFromManifest = async function (appPath) {
  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    appPath = await this.extractBaseApk(appPath);
  }

  const apkInfoGetters = [async () => {
    const apkanalyzerPath = await (0, _helpers.getApkanalyzerForOs)(this);
    return await extractApkInfoWithApkanalyzer(appPath, apkanalyzerPath);
  }, async () => {
    await this.initAapt();
    return await extractApkInfoWithApkTools(appPath, this.binaries.aapt, this.jars['appium_apk_tools.jar'], this.tmpDir);
  }];
  let savedError;

  for (const infoGetter of apkInfoGetters) {
    try {
      const {
        apkPackage,
        apkActivity
      } = await infoGetter();

      _logger.default.info(`Package name: '${apkPackage}'`);

      _logger.default.info(`Main activity name: '${apkActivity}'`);

      return {
        apkPackage,
        apkActivity
      };
    } catch (e) {
      if (infoGetter !== _lodash.default.last(apkInfoGetters)) {
        _logger.default.info(`Using the alternative activity name detection method because of: ${e.message}`);
      }

      savedError = e;
    }
  }

  throw new Error(`packageAndLaunchActivityFromManifest failed. Original error: ${savedError.message}` + (savedError.stderr ? `; StdErr: ${savedError.stderr}` : ''));
};

manifestMethods.targetSdkVersionFromManifest = async function (appPath) {
  await this.initAapt();

  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    appPath = await this.extractBaseApk(appPath);
  }

  _logger.default.info("Extracting package and launch activity from manifest");

  let args = ['dump', 'badging', appPath];
  let output;

  try {
    let {
      stdout
    } = await (0, _teen_process.exec)(this.binaries.aapt, args);
    output = stdout;
  } catch (e) {
    throw new Error(`fetching targetSdkVersion from local APK failed. Original error: ${e.message}`);
  }

  let targetSdkVersion = new RegExp(/targetSdkVersion:'([^']+)'/g).exec(output);

  if (!targetSdkVersion) {
    throw new Error(`targetSdkVersion is not specified in the application.`);
  }

  return parseInt(targetSdkVersion[1], 10);
};

manifestMethods.targetSdkVersionUsingPKG = async function (pkg, cmdOutput = null) {
  let stdout = cmdOutput || (await this.shell(['dumpsys', 'package', pkg]));
  let targetSdkVersion = new RegExp(/targetSdk=([^\s\s]+)/g).exec(stdout);

  if (targetSdkVersion && targetSdkVersion.length >= 2) {
    targetSdkVersion = targetSdkVersion[1];
  } else {
    targetSdkVersion = 0;
  }

  return parseInt(targetSdkVersion, 10);
};

manifestMethods.compileManifest = async function (manifest, manifestPackage, targetPackage) {
  const {
    platform,
    platformPath
  } = await (0, _helpers.getAndroidPlatformAndPath)();

  if (!platform) {
    throw new Error('Cannot compile the manifest. The required platform does not exist (API level >= 17)');
  }

  const resultPath = `${manifest}.apk`;
  const args = ['package', '-M', manifest, '--rename-manifest-package', manifestPackage, '--rename-instrumentation-target-package', targetPackage, '-I', _path.default.resolve(platformPath, 'android.jar'), '-F', resultPath, '-f'];

  try {
    await this.initAapt();

    _logger.default.debug(`Compiling the manifest: ${this.binaries.aapt} ${(0, _shellQuote.quote)(args)}`);

    await (0, _teen_process.exec)(this.binaries.aapt, args);

    _logger.default.debug(`Compiled the manifest at '${resultPath}'`);
  } catch (err) {
    throw new Error(`Cannot compile the manifest. Original error: ${err.message}`);
  }
};

manifestMethods.insertManifest = async function (manifest, srcApk, dstApk) {
  _logger.default.debug(`Inserting manifest, src: ${srcApk} dst: ${dstApk}`);

  await this.initAapt();
  await (0, _helpers.unzipFile)(`${manifest}.apk`);
  await _appiumSupport.fs.copyFile(srcApk, dstApk);

  _logger.default.debug("Testing new tmp apk");

  await _appiumSupport.zip.assertValidZip(dstApk);

  _logger.default.debug("Moving manifest");

  try {
    await (0, _teen_process.exec)(this.binaries.aapt, ['remove', dstApk, _path.default.basename(manifest)]);
  } catch (ign) {}

  await (0, _teen_process.exec)(this.binaries.aapt, ['add', dstApk, _path.default.basename(manifest)], {
    cwd: _path.default.dirname(manifest)
  });

  _logger.default.debug("Inserted manifest.");
};

manifestMethods.hasInternetPermissionFromManifest = async function (appPath) {
  await this.initAapt();

  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    appPath = await this.extractBaseApk(appPath);
  }

  _logger.default.debug(`Checking if '${appPath}' requires internet access permission in the manifest`);

  try {
    let {
      stdout
    } = await (0, _teen_process.exec)(this.binaries.aapt, ['dump', 'badging', appPath]);
    return new RegExp(/uses-permission:.*'android.permission.INTERNET'/).test(stdout);
  } catch (e) {
    throw new Error(`Cannot check if '${appPath}' requires internet access permission. ` + `Original error: ${e.message}`);
  }
};

manifestMethods.printManifestFromApk = async function printManifestFromApk(appPath, logLevel = 'debug') {
  await this.initAapt();

  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    appPath = await this.extractBaseApk(appPath);
  }

  _logger.default[logLevel](`Extracting the manifest from '${appPath}'`);

  let out = false;
  const {
    stdout
  } = await (0, _teen_process.exec)(this.binaries.aapt, ['l', '-a', appPath]);

  for (const line of stdout.split('\n')) {
    if (!out && line.includes('Android manifest:')) {
      out = true;
    }

    if (out) {
      _logger.default[logLevel](line);
    }
  }
};

var _default = manifestMethods;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90b29scy9hbmRyb2lkLW1hbmlmZXN0LmpzIl0sIm5hbWVzIjpbIm1hbmlmZXN0TWV0aG9kcyIsInByb2Nlc3NGcm9tTWFuaWZlc3QiLCJsb2NhbEFwayIsImluaXRBYXB0IiwibG9nIiwiaW5mbyIsImFyZ3MiLCJzdGRvdXQiLCJiaW5hcmllcyIsImFhcHQiLCJyZXN1bHQiLCJsaW5lcyIsInNwbGl0IiwiYXBwbGljYXRpb25SZWdleCIsIlJlZ0V4cCIsImFwcGxpY2F0aW9uRm91bmQiLCJhdHRyaWJ1dGVSZWdleCIsInByb2Nlc3NSZWdleCIsImxpbmUiLCJ0ZXN0Iiwibm90QXR0cmlidXRlIiwicHJvY2VzcyIsImV4ZWMiLCJsZW5ndGgiLCJzdWJzdHIiLCJleHRyYWN0QXBrSW5mb1dpdGhBcGtUb29scyIsImFhcHRQYXRoIiwiamFyUGF0aCIsInRtcFJvb3QiLCJhcGtQYWNrYWdlIiwiRXJyb3IiLCJfIiwiam9pbiIsImFwa0FjdGl2aXR5Iiwib3V0cHV0UGF0aCIsInBhdGgiLCJyZXNvbHZlIiwiZ2V0TGF1bmNoQWN0aXZpdHkiLCJvdXRwdXQiLCJzdGRlcnIiLCJhY3QiLCJleHRyYWN0QXBrSW5mb1dpdGhBcGthbmFseXplciIsImFwa2FuYWx5emVyUGF0aCIsImRlYnVnIiwiSlNPTiIsInN0cmluZ2lmeSIsIm1hbmlmZXN0WG1sIiwic2hlbGwiLCJjd2QiLCJkaXJuYW1lIiwiZG9jIiwieG1sZG9tIiwiRE9NUGFyc2VyIiwicGFyc2VGcm9tU3RyaW5nIiwiYXBrUGFja2FnZUF0dHJpYnV0ZSIsInhwYXRoIiwic2VsZWN0MSIsInZhbHVlIiwiYXBrQWN0aXZpdHlBdHRyaWJ1dGUiLCJwYWNrYWdlQW5kTGF1bmNoQWN0aXZpdHlGcm9tTWFuaWZlc3QiLCJhcHBQYXRoIiwiZW5kc1dpdGgiLCJBUEtTX0VYVEVOU0lPTiIsImV4dHJhY3RCYXNlQXBrIiwiYXBrSW5mb0dldHRlcnMiLCJqYXJzIiwidG1wRGlyIiwic2F2ZWRFcnJvciIsImluZm9HZXR0ZXIiLCJlIiwibGFzdCIsIm1lc3NhZ2UiLCJ0YXJnZXRTZGtWZXJzaW9uRnJvbU1hbmlmZXN0IiwidGFyZ2V0U2RrVmVyc2lvbiIsInBhcnNlSW50IiwidGFyZ2V0U2RrVmVyc2lvblVzaW5nUEtHIiwicGtnIiwiY21kT3V0cHV0IiwiY29tcGlsZU1hbmlmZXN0IiwibWFuaWZlc3QiLCJtYW5pZmVzdFBhY2thZ2UiLCJ0YXJnZXRQYWNrYWdlIiwicGxhdGZvcm0iLCJwbGF0Zm9ybVBhdGgiLCJyZXN1bHRQYXRoIiwiZXJyIiwiaW5zZXJ0TWFuaWZlc3QiLCJzcmNBcGsiLCJkc3RBcGsiLCJmcyIsImNvcHlGaWxlIiwiemlwIiwiYXNzZXJ0VmFsaWRaaXAiLCJiYXNlbmFtZSIsImlnbiIsImhhc0ludGVybmV0UGVybWlzc2lvbkZyb21NYW5pZmVzdCIsInByaW50TWFuaWZlc3RGcm9tQXBrIiwibG9nTGV2ZWwiLCJvdXQiLCJpbmNsdWRlcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxJQUFJQSxlQUFlLEdBQUcsRUFBdEI7O0FBTUFBLGVBQWUsQ0FBQ0MsbUJBQWhCLEdBQXNDLGdCQUFnQkMsUUFBaEIsRUFBMEI7QUFDOUQsUUFBTSxLQUFLQyxRQUFMLEVBQU47O0FBQ0FDLGtCQUFJQyxJQUFKLENBQVMsa0NBQVQ7O0FBQ0EsTUFBSUMsSUFBSSxHQUFHLENBQUMsTUFBRCxFQUFTLFNBQVQsRUFBb0JKLFFBQXBCLEVBQThCLHFCQUE5QixDQUFYO0FBQ0EsTUFBSTtBQUFDSyxJQUFBQTtBQUFELE1BQVcsTUFBTSx3QkFBSyxLQUFLQyxRQUFMLENBQWNDLElBQW5CLEVBQXlCSCxJQUF6QixDQUFyQjtBQUNBLE1BQUlJLE1BQU0sR0FBRyxJQUFiO0FBQ0EsTUFBSUMsS0FBSyxHQUFHSixNQUFNLENBQUNLLEtBQVAsQ0FBYSxJQUFiLENBQVo7QUFDQSxNQUFJQyxnQkFBZ0IsR0FBRyxJQUFJQyxN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QUFiLENBQW5CLEVBQXVDO0FBQ3JDLFFBQUksQ0FBQ3NGLEdBQUQsSUFBUWhGLElBQUksQ0FBQ2lGLFFBQUwsQ0FBYyxtQkFBZCxDQUFaLEVBQWdEO0FBQzlDRCxNQUFBQSxHQUFHLEdBQUcsSUFBTjtBQUNEOztBQUNELFFBQUlBLEdBQUosRUFBUztBQUNQOUYsc0JBQUk2RixRQUFKLEVBQWMvRSxJQUFkO0FBQ0Q7QUFDRjtBQUNGLENBbEJEOztlQXFCZWxCLGUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyLmpzJztcbmltcG9ydCB7XG4gIGdldEFuZHJvaWRQbGF0Zm9ybUFuZFBhdGgsIHVuemlwRmlsZSxcbiAgZ2V0QXBrYW5hbHl6ZXJGb3JPcywgQVBLU19FWFRFTlNJT04gfSBmcm9tICcuLi9oZWxwZXJzLmpzJztcbmltcG9ydCB7IGZzLCB6aXAgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeG1sZG9tIGZyb20gJ3htbGRvbSc7XG5pbXBvcnQgeHBhdGggZnJvbSAneHBhdGgnO1xuaW1wb3J0IHsgcXVvdGUgfSBmcm9tICdzaGVsbC1xdW90ZSc7XG5cbmxldCBtYW5pZmVzdE1ldGhvZHMgPSB7fTtcblxuLy8gYW5kcm9pZDpwcm9jZXNzPSBtYXkgYmUgZGVmaW5lZCBpbiBBbmRyb2lkTWFuaWZlc3QueG1sXG4vLyBodHRwOi8vZGV2ZWxvcGVyLmFuZHJvaWQuY29tL3JlZmVyZW5jZS9hbmRyb2lkL1IuYXR0ci5odG1sI3Byb2Nlc3Ncbi8vIG5vdGUgdGhhdCB0aGUgcHJvY2VzcyBuYW1lIHdoZW4gdXNlZCB3aXRoIHBzIG11c3QgYmUgdHJ1bmNhdGVkIHRvIHRoZSBsYXN0IDE1IGNoYXJzXG4vLyBwcyAtYyBjb20uZXhhbXBsZS5hbmRyb2lkLmFwaXMgYmVjb21lcyBwcyAtYyBsZS5hbmRyb2lkLmFwaXNcbm1hbmlmZXN0TWV0aG9kcy5wcm9jZXNzRnJvbU1hbmlmZXN0ID0gYXN5bmMgZnVuY3Rpb24gKGxvY2FsQXBrKSB7XG4gIGF3YWl0IHRoaXMuaW5pdEFhcHQoKTtcbiAgbG9nLmluZm8oXCJSZXRyaWV2aW5nIHByb2Nlc3MgZnJvbSBtYW5pZmVzdFwiKTtcbiAgbGV0IGFyZ3MgPSBbJ2R1bXAnLCAneG1sdHJlZScsIGxvY2FsQXBrLCAnQW5kcm9pZE1hbmlmZXN0LnhtbCddO1xuICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKHRoaXMuYmluYXJpZXMuYWFwdCwgYXJncyk7XG4gIGxldCByZXN1bHQgPSBudWxsO1xuICBsZXQgbGluZXMgPSBzdGRvdXQuc3BsaXQoXCJcXG5cIik7XG4gIGxldCBhcHBsaWNhdGlvblJlZ2V4ID0gbmV3IFJlZ0V4cCgvXFxzK0U6IGFwcGxpY2F0aW9uIFxcKGxpbmU9XFxkK1xcKS4qLyk7XG4gIGxldCBhcHBsaWNhdGlvbkZvdW5kID0gZmFsc2U7XG4gIGxldCBhdHRyaWJ1dGVSZWdleCA9IG5ldyBSZWdFeHAoL1xccytBOiAuKy8pO1xuICBsZXQgcHJvY2Vzc1JlZ2V4ID0gbmV3IFJlZ0V4cCgvXFxzK0E6IGFuZHJvaWQ6cHJvY2Vzc1xcKDB4MDEwMTAwMTFcXCk9XCIoW15cIl0rKS4qXCIvKTtcbiAgZm9yIChsZXQgbGluZSBvZiBsaW5lcykge1xuICAgIGlmICghYXBwbGljYXRpb25Gb3VuZCkge1xuICAgICAgaWYgKGFwcGxpY2F0aW9uUmVnZXgudGVzdChsaW5lKSkge1xuICAgICAgICBhcHBsaWNhdGlvbkZvdW5kID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IG5vdEF0dHJpYnV0ZSA9ICFhdHRyaWJ1dGVSZWdleC50ZXN0KGxpbmUpO1xuICAgICAgLy8gcHJvY2VzcyBtdXN0IGJlIGFuIGF0dHJpYnV0ZSBhZnRlciBhcHBsaWNhdGlvbi5cbiAgICAgIGlmIChub3RBdHRyaWJ1dGUpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBsZXQgcHJvY2VzcyA9IHByb2Nlc3NSZWdleC5leGVjKGxpbmUpO1xuICAgICAgLy8gdGhpcyBpcyBhbiBhcHBsaWNhdGlvbiBhdHRyaWJ1dGUgcHJvY2Vzcy5cbiAgICAgIGlmIChwcm9jZXNzICYmIHByb2Nlc3MubGVuZ3RoID4gMSkge1xuICAgICAgICByZXN1bHQgPSBwcm9jZXNzWzFdO1xuICAgICAgICAvLyBtdXN0IHRyaW0gdG8gbGFzdCAxNSBmb3IgYW5kcm9pZCdzIHBzIGJpbmFyeVxuICAgICAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDE1KSB7XG4gICAgICAgICAgcmVzdWx0ID0gcmVzdWx0LnN1YnN0cihyZXN1bHQubGVuZ3RoIC0gMTUpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gcmVzdWx0O1xufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBBUEtJbmZvXG4gKiBAcHJvcGVydHkge3N0cmluZ30gYXBrUGFja2FnZSAtIFRoZSBuYW1lIG9mIGFwcGxpY2F0aW9uIHBhY2thZ2UsIGZvciBleGFtcGxlICdjb20uYWNtZS5hcHAnLlxuICogQHByb3BlcnR5IHtzdHJpbmd9IGFwa0FjdGl2aXR5IC0gVGhlIG5hbWUgb2YgbWFpbiBhcHBsaWNhdGlvbiBhY3Rpdml0eS5cbiAqL1xuXG4vKipcbiAqIEV4dHJhY3QgcGFja2FnZSBhbmQgbWFpbiBhY3Rpdml0eSBuYW1lIGZyb20gYXBwbGljYXRpb24gbWFuaWZlc3QgdXNpbmdcbiAqIHRoZSBjdXN0b20gYXBrIHRvb2xzLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBsb2NhbEFwayAtIFRoZSBmdWxsIHBhdGggdG8gYXBwbGljYXRpb24gcGFja2FnZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBhYXB0UGF0aCAtIFRoZSBmdWxsIHBhdGggdG8gYXBwdCBiaW5hcnkuXG4gKiBAcGFyYW0ge3N0cmluZ30gamFyUGF0aCAtIFRoZSBmdWxsIHBhdGggdG8gYXBwaXVtX2Fwa190b29scy5qYXIgdXRpbGl0eVxuICogQHBhcmFtIHtzdHJpbmd9IHRtcFJvb3QgLSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBjbGFzcy13aWRlIHRlbXBvcmFyeSBmb2xkZXIuXG4gKiBAcmV0dXJuIHtBUEtJbmZvfSBUaGUgcGFyc2VkIGFwcGxpY2F0aW9uIGluZm8uXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGdldHRpbmcgdGhlIGRhdGEgZnJvbSB0aGUgZ2l2ZW5cbiAqICAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbiBwYWNrYWdlLlxuICovXG5hc3luYyBmdW5jdGlvbiBleHRyYWN0QXBrSW5mb1dpdGhBcGtUb29scyAobG9jYWxBcGssIGFhcHRQYXRoLCBqYXJQYXRoLCB0bXBSb290KSB7XG4gIGxvZy5pbmZvKFwiRXh0cmFjdGluZyBwYWNrYWdlIGFuZCBsYXVuY2ggYWN0aXZpdHkgZnJvbSBtYW5pZmVzdFwiKTtcbiAgbGV0IGFyZ3MgPSBbJ2R1bXAnLCAnYmFkZ2luZycsIGxvY2FsQXBrXTtcbiAgbGV0IHN0ZG91dCA9IChhd2FpdCBleGVjKGFhcHRQYXRoLCBhcmdzKSkuc3Rkb3V0O1xuICBsZXQgYXBrUGFja2FnZSA9IG5ldyBSZWdFeHAoL3BhY2thZ2U6IG5hbWU9JyhbXiddKyknL2cpLmV4ZWMoc3Rkb3V0KTtcbiAgaWYgKCFhcGtQYWNrYWdlIHx8IGFwa1BhY2thZ2UubGVuZ3RoIDwgMikge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHBhcnNlIHBhY2thZ2UgbmFtZSBmcm9tIGAgK1xuICAgICAgYCcke18uam9pbihbYWFwdFBhdGgsICdkdW1wJywgJ2JhZGdpbmcnLCAnXCInICsgbG9jYWxBcGsgKyAnXCInXSwgJyAnKX0nIGNvbW1hbmQgIG91dHB1dGApO1xuICB9XG4gIGFwa1BhY2thZ2UgPSBhcGtQYWNrYWdlWzFdO1xuICBsZXQgYXBrQWN0aXZpdHkgPSBuZXcgUmVnRXhwKC9sYXVuY2hhYmxlLWFjdGl2aXR5OiBuYW1lPScoW14nXSspJy9nKS5leGVjKHN0ZG91dCk7XG4gIGlmIChhcGtBY3Rpdml0eSAmJiBhcGtBY3Rpdml0eS5sZW5ndGggPj0gMikge1xuICAgIGFwa0FjdGl2aXR5ID0gYXBrQWN0aXZpdHlbMV07XG4gICAgcmV0dXJuIHthcGtQYWNrYWdlLCBhcGtBY3Rpdml0eX07XG4gIH1cblxuICBsZXQgb3V0cHV0UGF0aCA9IHBhdGgucmVzb2x2ZSh0bXBSb290LCBhcGtQYWNrYWdlKTtcbiAgbGV0IGdldExhdW5jaEFjdGl2aXR5ID0gW1xuICAgICctamFyJywgamFyUGF0aCxcbiAgICAncHJpbnRMYXVuY2hBY3Rpdml0eScsIGxvY2FsQXBrLFxuICAgIG91dHB1dFBhdGhcbiAgXTtcbiAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgZXhlYygnamF2YScsIGdldExhdW5jaEFjdGl2aXR5KTtcbiAgaWYgKG91dHB1dC5zdGRlcnIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBwYXJzZSBsYXVuY2hBY3Rpdml0eSBmcm9tIG1hbmlmZXN0OiAke291dHB1dC5zdGRlcnJ9YCk7XG4gIH1cbiAgc3Rkb3V0ID0gb3V0cHV0LnN0ZG91dDtcbiAgbGV0IGFjdCA9IG5ldyBSZWdFeHAoL0xhdW5jaCBhY3Rpdml0eSBwYXJzZWQ6KFteJ10rKS9nKS5leGVjKHN0ZG91dCk7XG4gIGlmIChhY3QgJiYgYWN0Lmxlbmd0aCA+PSAyKSB7XG4gICAgYXBrQWN0aXZpdHkgPSBhY3RbMV07XG4gICAgcmV0dXJuIHthcGtQYWNrYWdlLCBhcGtBY3Rpdml0eX07XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgcGFyc2UgbWFpbiBhY3Rpdml0eSBuYW1lIGZyb20gJyR7c3Rkb3V0fScgY29tbWFuZCAgb3V0cHV0YCk7XG59XG5cbi8qKlxuICogRXh0cmFjdCBwYWNrYWdlIGFuZCBtYWluIGFjdGl2aXR5IG5hbWUgZnJvbSBhcHBsaWNhdGlvbiBtYW5pZmVzdCB1c2luZ1xuICogYXBrYW5hbHl6ZXIgdG9vbC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gbG9jYWxBcGsgLSBUaGUgZnVsbCBwYXRoIHRvIGFwcGxpY2F0aW9uIHBhY2thZ2UuXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBrYW5hbHl6ZXJQYXRoIC0gVGhlIGZ1bGwgcGF0aCB0byBhcGthbmFseXplciB0b29sLlxuICogQHJldHVybiB7QVBLSW5mb30gVGhlIHBhcnNlZCBhcHBsaWNhdGlvbiBpbmZvLlxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBnZXR0aW5nIHRoZSBkYXRhIGZyb20gdGhlIGdpdmVuXG4gKiAgICAgICAgICAgICAgICAgYXBwbGljYXRpb24gcGFja2FnZSBvciBpZiB0aGUgdG9vbCBpdHNlbGZcbiAqICAgICAgICAgICAgICAgICBpcyBub3QgcHJlc2VudCBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW0uXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGV4dHJhY3RBcGtJbmZvV2l0aEFwa2FuYWx5emVyIChsb2NhbEFwaywgYXBrYW5hbHl6ZXJQYXRoKSB7XG4gIGNvbnN0IGFyZ3MgPSBbJy1oJywgJ21hbmlmZXN0JywgJ3ByaW50JywgbG9jYWxBcGtdO1xuICBsb2cuZGVidWcoYFN0YXJ0aW5nICcke2Fwa2FuYWx5emVyUGF0aH0nIHdpdGggYXJncyAke0pTT04uc3RyaW5naWZ5KGFyZ3MpfWApO1xuICBjb25zdCBtYW5pZmVzdFhtbCA9IChhd2FpdCBleGVjKGFwa2FuYWx5emVyUGF0aCwgYXJncywge1xuICAgIHNoZWxsOiB0cnVlLFxuICAgIGN3ZDogcGF0aC5kaXJuYW1lKGFwa2FuYWx5emVyUGF0aClcbiAgfSkpLnN0ZG91dDtcbiAgY29uc3QgZG9jID0gbmV3IHhtbGRvbS5ET01QYXJzZXIoKS5wYXJzZUZyb21TdHJpbmcobWFuaWZlc3RYbWwpO1xuICBjb25zdCBhcGtQYWNrYWdlQXR0cmlidXRlID0geHBhdGguc2VsZWN0MSgnLy9tYW5pZmVzdC9AcGFja2FnZScsIGRvYyk7XG4gIGlmICghYXBrUGFja2FnZUF0dHJpYnV0ZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHBhcnNlIHBhY2thZ2UgbmFtZSBmcm9tICR7bWFuaWZlc3RYbWx9YCk7XG4gIH1cbiAgY29uc3QgYXBrUGFja2FnZSA9IGFwa1BhY2thZ2VBdHRyaWJ1dGUudmFsdWU7XG4gIC8vIExvb2sgZm9yIGFjdGl2aXR5IG9yIGFjdGl2aXR5LWFsaWFzIHdpdGhcbiAgLy8gYWN0aW9uID09IGFuZHJvaWQuaW50ZW50LmFjdGlvbi5NQUlOIGFuZFxuICAvLyBjYXRlZ29yeSA9PSBhbmRyb2lkLmludGVudC5jYXRlZ29yeS5MQVVOQ0hFUlxuICAvLyBkZXNjZW5kYW50c1xuICBjb25zdCBhcGtBY3Rpdml0eUF0dHJpYnV0ZSA9IHhwYXRoLnNlbGVjdDEoXG4gICAgXCIvL2FwcGxpY2F0aW9uLypbc3RhcnRzLXdpdGgobmFtZSgpLCAnYWN0aXZpdHknKSBcIiArXG4gICAgXCJhbmQgLi8vYWN0aW9uW0AqW2xvY2FsLW5hbWUoKT0nbmFtZScgYW5kIC49J2FuZHJvaWQuaW50ZW50LmFjdGlvbi5NQUlOJ11dIFwiICtcbiAgICBcImFuZCAuLy9jYXRlZ29yeVtAKltsb2NhbC1uYW1lKCk9J25hbWUnIGFuZCAuPSdhbmRyb2lkLmludGVudC5jYXRlZ29yeS5MQVVOQ0hFUiddXV1cIiArXG4gICAgXCIvQCpbbG9jYWwtbmFtZSgpPSduYW1lJ11cIiwgZG9jKTtcbiAgaWYgKCFhcGtBY3Rpdml0eUF0dHJpYnV0ZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHBhcnNlIG1haW4gYWN0aXZpdHkgbmFtZSBmcm9tICR7bWFuaWZlc3RYbWx9YCk7XG4gIH1cbiAgY29uc3QgYXBrQWN0aXZpdHkgPSBhcGtBY3Rpdml0eUF0dHJpYnV0ZS52YWx1ZTtcbiAgcmV0dXJuIHthcGtQYWNrYWdlLCBhcGtBY3Rpdml0eX07XG59XG5cbi8qKlxuICogRXh0cmFjdCBwYWNrYWdlIGFuZCBtYWluIGFjdGl2aXR5IG5hbWUgZnJvbSBhcHBsaWNhdGlvbiBtYW5pZmVzdC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBwUGF0aCAtIFRoZSBmdWxsIHBhdGggdG8gYXBwbGljYXRpb24gLmFwayhzKSBwYWNrYWdlXG4gKiBAcmV0dXJuIHtBUEtJbmZvfSBUaGUgcGFyc2VkIGFwcGxpY2F0aW9uIGluZm8uXG4gKiBAdGhyb3dzIHtlcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGdldHRpbmcgdGhlIGRhdGEgZnJvbSB0aGUgZ2l2ZW5cbiAqICAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbiBwYWNrYWdlLlxuICovXG5tYW5pZmVzdE1ldGhvZHMucGFja2FnZUFuZExhdW5jaEFjdGl2aXR5RnJvbU1hbmlmZXN0ID0gYXN5bmMgZnVuY3Rpb24gKGFwcFBhdGgpIHtcbiAgaWYgKGFwcFBhdGguZW5kc1dpdGgoQVBLU19FWFRFTlNJT04pKSB7XG4gICAgYXBwUGF0aCA9IGF3YWl0IHRoaXMuZXh0cmFjdEJhc2VBcGsoYXBwUGF0aCk7XG4gIH1cblxuICBjb25zdCBhcGtJbmZvR2V0dGVycyA9IFtcbiAgICBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBhcGthbmFseXplclBhdGggPSBhd2FpdCBnZXRBcGthbmFseXplckZvck9zKHRoaXMpO1xuICAgICAgcmV0dXJuIGF3YWl0IGV4dHJhY3RBcGtJbmZvV2l0aEFwa2FuYWx5emVyKGFwcFBhdGgsIGFwa2FuYWx5emVyUGF0aCk7XG4gICAgfSxcbiAgICBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCB0aGlzLmluaXRBYXB0KCk7XG4gICAgICByZXR1cm4gYXdhaXQgZXh0cmFjdEFwa0luZm9XaXRoQXBrVG9vbHMoYXBwUGF0aCxcbiAgICAgICAgdGhpcy5iaW5hcmllcy5hYXB0LCB0aGlzLmphcnNbJ2FwcGl1bV9hcGtfdG9vbHMuamFyJ10sIHRoaXMudG1wRGlyKTtcbiAgICB9LFxuICBdO1xuXG4gIGxldCBzYXZlZEVycm9yO1xuICBmb3IgKGNvbnN0IGluZm9HZXR0ZXIgb2YgYXBrSW5mb0dldHRlcnMpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qge2Fwa1BhY2thZ2UsIGFwa0FjdGl2aXR5fSA9IGF3YWl0IGluZm9HZXR0ZXIoKTtcbiAgICAgIGxvZy5pbmZvKGBQYWNrYWdlIG5hbWU6ICcke2Fwa1BhY2thZ2V9J2ApO1xuICAgICAgbG9nLmluZm8oYE1haW4gYWN0aXZpdHkgbmFtZTogJyR7YXBrQWN0aXZpdHl9J2ApO1xuICAgICAgcmV0dXJuIHthcGtQYWNrYWdlLCBhcGtBY3Rpdml0eX07XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKGluZm9HZXR0ZXIgIT09IF8ubGFzdChhcGtJbmZvR2V0dGVycykpIHtcbiAgICAgICAgbG9nLmluZm8oYFVzaW5nIHRoZSBhbHRlcm5hdGl2ZSBhY3Rpdml0eSBuYW1lIGRldGVjdGlvbiBtZXRob2QgYmVjYXVzZSBvZjogJHtlLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgICBzYXZlZEVycm9yID0gZTtcbiAgICB9XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKGBwYWNrYWdlQW5kTGF1bmNoQWN0aXZpdHlGcm9tTWFuaWZlc3QgZmFpbGVkLiBPcmlnaW5hbCBlcnJvcjogJHtzYXZlZEVycm9yLm1lc3NhZ2V9YCArXG4gICAgICAgICAgICAgICAgICAoc2F2ZWRFcnJvci5zdGRlcnIgPyBgOyBTdGRFcnI6ICR7c2F2ZWRFcnJvci5zdGRlcnJ9YCA6ICcnKSk7XG59O1xuXG4vKipcbiAqIEV4dHJhY3QgdGFyZ2V0IFNESyB2ZXJzaW9uIGZyb20gYXBwbGljYXRpb24gbWFuaWZlc3QuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwcFBhdGggLSBUaGUgZnVsbCBwYXRoIHRvIC5hcGsocykgcGFja2FnZS5cbiAqIEByZXR1cm4ge251bWJlcn0gVGhlIHZlcnNpb24gb2YgdGhlIHRhcmdldCBTREsuXG4gKiBAdGhyb3dzIHtlcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGdldHRpbmcgdGhlIGRhdGEgZnJvbSB0aGUgZ2l2ZW5cbiAqICAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbiBwYWNrYWdlLlxuICovXG5tYW5pZmVzdE1ldGhvZHMudGFyZ2V0U2RrVmVyc2lvbkZyb21NYW5pZmVzdCA9IGFzeW5jIGZ1bmN0aW9uIChhcHBQYXRoKSB7XG4gIGF3YWl0IHRoaXMuaW5pdEFhcHQoKTtcblxuICBpZiAoYXBwUGF0aC5lbmRzV2l0aChBUEtTX0VYVEVOU0lPTikpIHtcbiAgICBhcHBQYXRoID0gYXdhaXQgdGhpcy5leHRyYWN0QmFzZUFwayhhcHBQYXRoKTtcbiAgfVxuXG4gIGxvZy5pbmZvKFwiRXh0cmFjdGluZyBwYWNrYWdlIGFuZCBsYXVuY2ggYWN0aXZpdHkgZnJvbSBtYW5pZmVzdFwiKTtcbiAgbGV0IGFyZ3MgPSBbJ2R1bXAnLCAnYmFkZ2luZycsIGFwcFBhdGhdO1xuICBsZXQgb3V0cHV0O1xuICB0cnkge1xuICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWModGhpcy5iaW5hcmllcy5hYXB0LCBhcmdzKTtcbiAgICBvdXRwdXQgPSBzdGRvdXQ7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYGZldGNoaW5nIHRhcmdldFNka1ZlcnNpb24gZnJvbSBsb2NhbCBBUEsgZmFpbGVkLiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gIH1cbiAgbGV0IHRhcmdldFNka1ZlcnNpb24gPSBuZXcgUmVnRXhwKC90YXJnZXRTZGtWZXJzaW9uOicoW14nXSspJy9nKS5leGVjKG91dHB1dCk7XG4gIGlmICghdGFyZ2V0U2RrVmVyc2lvbikge1xuICAgIHRocm93IG5ldyBFcnJvcihgdGFyZ2V0U2RrVmVyc2lvbiBpcyBub3Qgc3BlY2lmaWVkIGluIHRoZSBhcHBsaWNhdGlvbi5gKTtcbiAgfVxuICByZXR1cm4gcGFyc2VJbnQodGFyZ2V0U2RrVmVyc2lvblsxXSwgMTApO1xufTtcblxuLyoqXG4gKiBFeHRyYWN0IHRhcmdldCBTREsgdmVyc2lvbiBmcm9tIHBhY2thZ2UgaW5mb3JtYXRpb24uXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHBrZyAtIFRoZSBjbGFzcyBuYW1lIG9mIHRoZSBwYWNrYWdlIGluc3RhbGxlZCBvbiB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKiBAcGFyYW0gez9zdHJpbmd9IGNtZE91dHB1dCAtIE9wdGlvbmFsIHBhcmFtZXRlciBjb250YWluaW5nIHRoZSBvdXRwdXQgb2ZcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2R1bXBzeXMgcGFja2FnZV8gY29tbWFuZC4gSXQgbWF5IHNwZWVkIHVwIHRoZSBtZXRob2QgZXhlY3V0aW9uLlxuICogQHJldHVybiB7bnVtYmVyfSBUaGUgdmVyc2lvbiBvZiB0aGUgdGFyZ2V0IFNESy5cbiAqL1xubWFuaWZlc3RNZXRob2RzLnRhcmdldFNka1ZlcnNpb25Vc2luZ1BLRyA9IGFzeW5jIGZ1bmN0aW9uIChwa2csIGNtZE91dHB1dCA9IG51bGwpIHtcbiAgbGV0IHN0ZG91dCA9IGNtZE91dHB1dCB8fCBhd2FpdCB0aGlzLnNoZWxsKFsnZHVtcHN5cycsICdwYWNrYWdlJywgcGtnXSk7XG4gIGxldCB0YXJnZXRTZGtWZXJzaW9uID0gbmV3IFJlZ0V4cCgvdGFyZ2V0U2RrPShbXlxcc1xcc10rKS9nKS5leGVjKHN0ZG91dCk7XG4gIGlmICh0YXJnZXRTZGtWZXJzaW9uICYmIHRhcmdldFNka1ZlcnNpb24ubGVuZ3RoID49IDIpIHtcbiAgICB0YXJnZXRTZGtWZXJzaW9uID0gdGFyZ2V0U2RrVmVyc2lvblsxXTtcbiAgfSBlbHNlIHtcbiAgICAvLyB0YXJnZXRTZGsgbm90IGZvdW5kIGluIHRoZSBkdW1wLCBhc3NpZ25pbmcgMCB0byB0YXJnZXRTZGtWZXJzaW9uXG4gICAgdGFyZ2V0U2RrVmVyc2lvbiA9IDA7XG4gIH1cbiAgcmV0dXJuIHBhcnNlSW50KHRhcmdldFNka1ZlcnNpb24sIDEwKTtcbn07XG5cbi8qKlxuICogQ3JlYXRlIGJpbmFyeSByZXByZXNlbnRhdGlvbiBvZiBwYWNrYWdlIG1hbmlmZXN0ICh1c3VhbGx5IEFuZHJvaWRNYW5pZmVzdC54bWwpLlxuICogYCR7bWFuaWZlc3R9LmFwa2AgZmlsZSB3aWxsIGJlIGNyZWF0ZWQgYXMgdGhlIHJlc3VsdCBvZiB0aGlzIG1ldGhvZFxuICogY29udGFpbmluZyB0aGUgY29tcGlsZWQgbWFuaWZlc3QuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IG1hbmlmZXN0IC0gRnVsbCBwYXRoIHRvIHRoZSBpbml0aWFsIG1hbmlmZXN0IHRlbXBsYXRlXG4gKiBAcGFyYW0ge3N0cmluZ30gbWFuaWZlc3RQYWNrYWdlIC0gVGhlIG5hbWUgb2YgdGhlIG1hbmlmZXN0IHBhY2thZ2VcbiAqIEBwYXJhbSB7c3RyaW5nfSB0YXJnZXRQYWNrYWdlIC0gVGhlIG5hbWUgb2YgdGhlIGRlc3RpbmF0aW9uIHBhY2thZ2VcbiAqL1xubWFuaWZlc3RNZXRob2RzLmNvbXBpbGVNYW5pZmVzdCA9IGFzeW5jIGZ1bmN0aW9uIChtYW5pZmVzdCwgbWFuaWZlc3RQYWNrYWdlLCB0YXJnZXRQYWNrYWdlKSB7XG4gIGNvbnN0IHtwbGF0Zm9ybSwgcGxhdGZvcm1QYXRofSA9IGF3YWl0IGdldEFuZHJvaWRQbGF0Zm9ybUFuZFBhdGgoKTtcbiAgaWYgKCFwbGF0Zm9ybSkge1xuICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGNvbXBpbGUgdGhlIG1hbmlmZXN0LiBUaGUgcmVxdWlyZWQgcGxhdGZvcm0gZG9lcyBub3QgZXhpc3QgKEFQSSBsZXZlbCA+PSAxNyknKTtcbiAgfVxuICBjb25zdCByZXN1bHRQYXRoID0gYCR7bWFuaWZlc3R9LmFwa2A7XG4gIGNvbnN0IGFyZ3MgPSBbXG4gICAgJ3BhY2thZ2UnLFxuICAgICctTScsIG1hbmlmZXN0LFxuICAgICctLXJlbmFtZS1tYW5pZmVzdC1wYWNrYWdlJywgbWFuaWZlc3RQYWNrYWdlLFxuICAgICctLXJlbmFtZS1pbnN0cnVtZW50YXRpb24tdGFyZ2V0LXBhY2thZ2UnLCB0YXJnZXRQYWNrYWdlLFxuICAgICctSScsIHBhdGgucmVzb2x2ZShwbGF0Zm9ybVBhdGgsICdhbmRyb2lkLmphcicpLFxuICAgICctRicsIHJlc3VsdFBhdGgsXG4gICAgJy1mJyxcbiAgXTtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLmluaXRBYXB0KCk7XG4gICAgbG9nLmRlYnVnKGBDb21waWxpbmcgdGhlIG1hbmlmZXN0OiAke3RoaXMuYmluYXJpZXMuYWFwdH0gJHtxdW90ZShhcmdzKX1gKTtcbiAgICBhd2FpdCBleGVjKHRoaXMuYmluYXJpZXMuYWFwdCwgYXJncyk7XG4gICAgbG9nLmRlYnVnKGBDb21waWxlZCB0aGUgbWFuaWZlc3QgYXQgJyR7cmVzdWx0UGF0aH0nYCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGNvbXBpbGUgdGhlIG1hbmlmZXN0LiBPcmlnaW5hbCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxufTtcblxuLyoqXG4gKiBSZXBsYWNlL2luc2VydCB0aGUgc3BlY2lhbGx5IHByZWNvbXBpbGVkIG1hbmlmZXN0IGZpbGUgaW50byB0aGVcbiAqIHBhcnRpY3VsYXIgcGFja2FnZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gbWFuaWZlc3QgLSBGdWxsIHBhdGggdG8gdGhlIHByZWNvbXBpbGVkIG1hbmlmZXN0XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVkIGJ5IGBjb21waWxlTWFuaWZlc3RgIG1ldGhvZCBjYWxsXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRob3V0IC5hcGsgZXh0ZW5zaW9uXG4gKiBAcGFyYW0ge3N0cmluZ30gc3JjQXBrIC0gRnVsbCBwYXRoIHRvIHRoZSBleGlzdGluZyB2YWxpZCBhcHBsaWNhdGlvbiBwYWNrYWdlLCB3aGVyZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMgbWFuaWZlc3QgaGFzIHRvIGJlIGluc2V0cmVkIHRvLiBUaGlzIHBhY2thZ2VcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICB3aWxsIE5PVCBiZSBtb2RpZmllZC5cbiAqIEBwYXJhbSB7c3RyaW5nfSBkc3RBcGsgLSBGdWxsIHBhdGggdG8gdGhlIHJlc3VsdGluZyBwYWNrYWdlLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBmaWxlIHdpbGwgYmUgb3ZlcnJpZGVuIGlmIGl0IGFscmVhZHkgZXhpc3RzLlxuICovXG5tYW5pZmVzdE1ldGhvZHMuaW5zZXJ0TWFuaWZlc3QgPSBhc3luYyBmdW5jdGlvbiAobWFuaWZlc3QsIHNyY0FwaywgZHN0QXBrKSB7XG4gIGxvZy5kZWJ1ZyhgSW5zZXJ0aW5nIG1hbmlmZXN0LCBzcmM6ICR7c3JjQXBrfSBkc3Q6ICR7ZHN0QXBrfWApO1xuICBhd2FpdCB0aGlzLmluaXRBYXB0KCk7XG4gIGF3YWl0IHVuemlwRmlsZShgJHttYW5pZmVzdH0uYXBrYCk7XG4gIGF3YWl0IGZzLmNvcHlGaWxlKHNyY0FwaywgZHN0QXBrKTtcbiAgbG9nLmRlYnVnKFwiVGVzdGluZyBuZXcgdG1wIGFwa1wiKTtcbiAgYXdhaXQgemlwLmFzc2VydFZhbGlkWmlwKGRzdEFwayk7XG4gIGxvZy5kZWJ1ZyhcIk1vdmluZyBtYW5pZmVzdFwiKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBleGVjKHRoaXMuYmluYXJpZXMuYWFwdCwgW1xuICAgICAgJ3JlbW92ZScsIGRzdEFwaywgcGF0aC5iYXNlbmFtZShtYW5pZmVzdClcbiAgICBdKTtcbiAgfSBjYXRjaCAoaWduKSB7fVxuICBhd2FpdCBleGVjKHRoaXMuYmluYXJpZXMuYWFwdCwgW1xuICAgICdhZGQnLCBkc3RBcGssIHBhdGguYmFzZW5hbWUobWFuaWZlc3QpXG4gIF0sIHtjd2Q6IHBhdGguZGlybmFtZShtYW5pZmVzdCl9KTtcbiAgbG9nLmRlYnVnKFwiSW5zZXJ0ZWQgbWFuaWZlc3QuXCIpO1xufTtcblxuLyoqXG4gKiBDaGVjayB3aGV0aGVyIHBhY2thZ2UgbWFuaWZlc3QgY29udGFpbnMgSW50ZXJuZXQgcGVybWlzc2lvbnMuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwcFBhdGggLSBUaGUgZnVsbCBwYXRoIHRvIC5hcGsocykgcGFja2FnZS5cbiAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIG1hbmlmZXN0IHJlcXVpcmVzIEludGVybmV0IGFjY2VzcyBwZXJtaXNzaW9uLlxuICovXG5tYW5pZmVzdE1ldGhvZHMuaGFzSW50ZXJuZXRQZXJtaXNzaW9uRnJvbU1hbmlmZXN0ID0gYXN5bmMgZnVuY3Rpb24gKGFwcFBhdGgpIHtcbiAgYXdhaXQgdGhpcy5pbml0QWFwdCgpO1xuXG4gIGlmIChhcHBQYXRoLmVuZHNXaXRoKEFQS1NfRVhURU5TSU9OKSkge1xuICAgIGFwcFBhdGggPSBhd2FpdCB0aGlzLmV4dHJhY3RCYXNlQXBrKGFwcFBhdGgpO1xuICB9XG5cbiAgbG9nLmRlYnVnKGBDaGVja2luZyBpZiAnJHthcHBQYXRofScgcmVxdWlyZXMgaW50ZXJuZXQgYWNjZXNzIHBlcm1pc3Npb24gaW4gdGhlIG1hbmlmZXN0YCk7XG4gIHRyeSB7XG4gICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyh0aGlzLmJpbmFyaWVzLmFhcHQsIFsnZHVtcCcsICdiYWRnaW5nJywgYXBwUGF0aF0pO1xuICAgIHJldHVybiBuZXcgUmVnRXhwKC91c2VzLXBlcm1pc3Npb246LionYW5kcm9pZC5wZXJtaXNzaW9uLklOVEVSTkVUJy8pLnRlc3Qoc3Rkb3V0KTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGNoZWNrIGlmICcke2FwcFBhdGh9JyByZXF1aXJlcyBpbnRlcm5ldCBhY2Nlc3MgcGVybWlzc2lvbi4gYCArXG4gICAgICAgICAgICAgICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gIH1cbn07XG5cbi8qKlxuICogUHJpbnRzIG91dCB0aGUgbWFuaWZlc3QgZXh0cmFjdGVkIGZyb20gdGhlIGFwa1xuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBQYXRoIC0gVGhlIGZ1bGwgcGF0aCB0byBhcHBsaWNhdGlvbiBwYWNrYWdlLlxuICogQHBhcmFtIHs/c3RyaW5nfSBsb2dMZXZlbCAtIFRoZSBsZXZlbCBhdCB3aGljaCB0byBsb2cuIEUuZy4sICdkZWJ1ZydcbiAqL1xubWFuaWZlc3RNZXRob2RzLnByaW50TWFuaWZlc3RGcm9tQXBrID0gYXN5bmMgZnVuY3Rpb24gcHJpbnRNYW5pZmVzdEZyb21BcGsgKGFwcFBhdGgsIGxvZ0xldmVsID0gJ2RlYnVnJykge1xuICBhd2FpdCB0aGlzLmluaXRBYXB0KCk7XG5cbiAgaWYgKGFwcFBhdGguZW5kc1dpdGgoQVBLU19FWFRFTlNJT04pKSB7XG4gICAgYXBwUGF0aCA9IGF3YWl0IHRoaXMuZXh0cmFjdEJhc2VBcGsoYXBwUGF0aCk7XG4gIH1cblxuICBsb2dbbG9nTGV2ZWxdKGBFeHRyYWN0aW5nIHRoZSBtYW5pZmVzdCBmcm9tICcke2FwcFBhdGh9J2ApO1xuICBsZXQgb3V0ID0gZmFsc2U7XG4gIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyh0aGlzLmJpbmFyaWVzLmFhcHQsIFsnbCcsICctYScsIGFwcFBhdGhdKTtcbiAgZm9yIChjb25zdCBsaW5lIG9mIHN0ZG91dC5zcGxpdCgnXFxuJykpIHtcbiAgICBpZiAoIW91dCAmJiBsaW5lLmluY2x1ZGVzKCdBbmRyb2lkIG1hbmlmZXN0OicpKSB7XG4gICAgICBvdXQgPSB0cnVlO1xuICAgIH1cbiAgICBpZiAob3V0KSB7XG4gICAgICBsb2dbbG9nTGV2ZWxdKGxpbmUpO1xuICAgIH1cbiAgfVxufTtcblxuXG5leHBvcnQgZGVmYXVsdCBtYW5pZmVzdE1ldGhvZHM7XG4iXSwiZmlsZSI6ImxpYi90b29scy9hbmRyb2lkLW1hbmlmZXN0LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
