"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _teen_process = require("teen_process");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("./logger"));

var _asyncbox = require("asyncbox");

const IOSDEPLOY_PATH = `ios-deploy`;

class IOSDeploy {
  constructor(udid) {
    this.udid = udid;
    this.cmd = IOSDEPLOY_PATH;
  }

  async checkStatus() {
    await _appiumSupport.fs.which(this.cmd);
  }

  async launchApp(app) {
    let remove = [`--justlaunch`, `--noinstall`, this.udid, `--bundle`, app];

    try {
      await (0, _teen_process.exec)(this.cmd, remove);
    } catch (err) {
      _logger.default.debug(`Stdout: '${err.stdout}'. Stderr: '${err.stderr}'.`);

      throw new Error(`Could not remove app: '${err.message}'`);
    }
  }

  async remove(bundleid) {
    let remove = [`--uninstall_only`, `--id`, this.udid, `--bundle_id`, bundleid];

    try {
      await (0, _teen_process.exec)(this.cmd, remove);
    } catch (err) {
      _logger.default.debug(`Stdout: '${err.stdout}'. Stderr: '${err.stderr}'.`);

      throw new Error(`Could not remove app: '${err.message}'`);
    }
  }

  async removeApp(bundleId) {
    await this.remove(bundleId);
  }

  async install(app) {
    const args = [`--justlaunch`, `--uninstall`, `--id`, this.udid, `--bundle`, app];

    try {
      await (0, _asyncbox.retryInterval)(5, 500, _teen_process.exec, this.cmd, args);
    } catch (err) {
      _logger.default.debug(`Stdout: '${err.stdout}'. Stderr: '${err.stderr}'.`);

      throw new Error(`Could not install app: '${err.message}'`);
    }
  }

  async installApp(app) {
    await this.install(app);
  }

  async isAppInstalled(bundleid) {
    let isInstalled = [`--exists`, `--id`, this.udid, `--bundle_id`, bundleid];

    try {
      let {
        stdout
      } = await (0, _teen_process.exec)(this.cmd, isInstalled);
      return stdout && stdout.includes('true');
    } catch (err) {
      if (err.code !== 255) {
        _logger.default.debug(`Error checking install status: '${err.message}'`);
      }

      return false;
    }
  }

}

var _default = IOSDeploy;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pb3MtZGVwbG95LmpzIl0sIm5hbWVzIjpbIklPU0RFUExPWV9QQVRIIiwiSU9TRGVwbG95IiwiY29uc3RydWN0b3IiLCJ1ZGlkIiwiY21kIiwiY2hlY2tTdGF0dXMiLCJmcyIsIndoaWNoIiwibGF1bmNoQXBwIiwiYXBwIiwicmVtb3ZlIiwiZXJyIiwibG9nZ2VyIiwiZGVidWciLCJzdGRvdXQiLCJzdGRlcnIiLCJFcnJvciIsIm1lc3NhZ2UiLCJidW5kbGVpZCIsInJlbW92ZUFwcCIsImJ1bmRsZUlkIiwiaW5zdGFsbCIsImFyZ3MiLCJleGVjIiwiaW5zdGFsbEFwcCIsImlzQXBwSW5zdGFsbGVkIiwiaXNJbnN0YWxsZWQiLCJpbmNsdWRlcyIsImNvZGUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsY0FBYyxHQUFJLFlBQXhCOztBQUVBLE1BQU1DLFNBQU4sQ0FBZ0I7QUFFZEMsRUFBQUEsV0FBVyxDQUFFQyxJQUFGLEVBQVE7QUFDakIsU0FBS0EsSUFBTCxHQUFZQSxJQUFaO0FBQ0EsU0FBS0MsR0FBTCxHQUFXSixjQUFYO0FBQ0Q7O0FBRUQsUUFBTUssV0FBTixHQUFxQjtBQUVuQixVQUFNQyxrQkFBR0MsS0FBSCxDQUFTLEtBQUtILEdBQWQsQ0FBTjtBQUNEOztBQUVELFFBQU1JLFNBQU4sQ0FBaUJDLEdBQWpCLEVBQXNCO0FBQ3BCLFFBQUlDLE1BQU0sR0FBRyxDQUFFLGNBQUYsRUFBa0IsYUFBbEIsRUFBZ0MsS0FBS1AsSUFBckMsRUFBNEMsVUFBNUMsRUFBdURNLEdBQXZELENBQWI7O0FBQ0EsUUFBSTtBQUNGLFlBQU0sd0JBQUssS0FBS0wsR0FBVixFQUFlTSxNQUFmLENBQU47QUFDRCxLQUZELENBRUUsT0FBT0MsR0FBUCxFQUFZO0FBQ1pDLHNCQUFPQyxLQUFQLENBQWMsWUFBV0YsR0FBRyxDQUFDRyxNQUFPLGVBQWNILEdBQUcsQ0FBQ0ksTUFBTyxJQUE3RDs7QUFDQSxZQUFNLElBQUlDLEtBQUosQ0FBVywwQkFBeUJMLEdBQUcsQ0FBQ00sT0FBUSxHQUFoRCxDQUFOO0FBQ0Q7QUFDRjs7QUFFRCxRQUFNUCxNQUFOLENBQWNRLFFBQWQsRUFBd0I7QUFDdEIsUUFBSVIsTUFBTSxHQUFHLENBQUUsa0JBQUYsRUFBc0IsTUFBdEIsRUFBNkIsS0FBS1AsSUFBbEMsRUFBeUMsYUFBekMsRUFBdURlLFFBQXZELENBQWI7O0FBQ0EsUUFBSTtBQUNGLFlBQU0sd0JBQUssS0FBS2QsR0FBVixFQUFlTSxNQUFmLENBQU47QUFDRCxLQUZELENBRUUsT0FBT0MsR0FBUCxFQUFZO0FBQ1pDLHNCQUFPQyxLQUFQLENBQWMsWUFBV0YsR0FBRyxDQUFDRyxNQUFPLGVBQWNILEdBQUcsQ0FBQ0ksTUFBTyxJQUE3RDs7QUFDQSxZQUFNLElBQUlDLEtBQUosQ0FBVywwQkFBeUJMLEdBQUcsQ0FBQ00sT0FBUSxHQUFoRCxDQUFOO0FBQ0Q7QUFDRjs7QUFFRCxRQUFNRSxTQUFOLENBQWlCQyxRQUFqQixFQUEyQjtBQUN6QixVQUFNLEtBQUtWLE1BQUwsQ0FBWVUsUUFBWixDQUFOO0FBQ0Q7O0FBRUQsUUFBTUMsT0FBTixDQUFlWixHQUFmLEVBQW9CO0FBQ2xCLFVBQU1hLElBQUksR0FBRyxDQUFFLGNBQUYsRUFBa0IsYUFBbEIsRUFBaUMsTUFBakMsRUFBd0MsS0FBS25CLElBQTdDLEVBQW9ELFVBQXBELEVBQStETSxHQUEvRCxDQUFiOztBQUNBLFFBQUk7QUFDRixZQUFNLDZCQUFjLENBQWQsRUFBaUIsR0FBakIsRUFBc0JjLGtCQUF0QixFQUE0QixLQUFLbkIsR0FBakMsRUFBc0NrQixJQUF0QyxDQUFOO0FBQ0QsS0FGRCxDQUVFLE9BQU9YLEdBQVAsRUFBWTtBQUNaQyxzQkFBT0MsS0FBUCxDQUFjLFlBQVdGLEdBQUcsQ0FBQ0csTUFBTyxlQUFjSCxHQUFHLENBQUNJLE1BQU8sSUFBN0Q7O0FBQ0EsWUFBTSxJQUFJQyxLQUFKLENBQVcsMkJBQTBCTCxHQUFHLENBQUNNLE9BQVEsR0FBakQsQ0FBTjtBQUNEO0FBQ0Y7O0FBRUQsUUFBTU8sVUFBTixDQUFrQmYsR0FBbEIsRUFBdUI7QUFDckIsVUFBTSxLQUFLWSxPQUFMLENBQWFaLEdBQWIsQ0FBTjtBQUNEOztBQUVELFFBQU1nQixjQUFOLENBQXNCUCxRQUF0QixFQUFnQztBQUM5QixRQUFJUSxXQUFXLEdBQUcsQ0FBRSxVQUFGLEVBQWMsTUFBZCxFQUFxQixLQUFLdkIsSUFBMUIsRUFBaUMsYUFBakMsRUFBK0NlLFFBQS9DLENBQWxCOztBQUNBLFFBQUk7QUFDRixVQUFJO0FBQUNKLFFBQUFBO0FBQUQsVUFBVyxNQUFNLHdCQUFLLEtBQUtWLEdBQVYsRUFBZXNCLFdBQWYsQ0FBckI7QUFDQSxhQUFRWixNQUFNLElBQUtBLE1BQU0sQ0FBQ2EsUUFBUCxDQUFnQixNQUFoQixDQUFuQjtBQUNELEtBSEQsQ0FHRSxPQUFPaEIsR0FBUCxFQUFZO0FBRVosVUFBSUEsR0FBRyxDQUFDaUIsSUFBSixLQUFhLEdBQWpCLEVBQXNCO0FBQ3BCaEIsd0JBQU9DLEtBQVAsQ0FBYyxtQ0FBa0NGLEdBQUcsQ0FBQ00sT0FBUSxHQUE1RDtBQUNEOztBQUNELGFBQU8sS0FBUDtBQUNEO0FBQ0Y7O0FBOURhOztlQWlFRGhCLFMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuXG5jb25zdCBJT1NERVBMT1lfUEFUSCA9IGBpb3MtZGVwbG95YDtcblxuY2xhc3MgSU9TRGVwbG95IHtcblxuICBjb25zdHJ1Y3RvciAodWRpZCkge1xuICAgIHRoaXMudWRpZCA9IHVkaWQ7XG4gICAgdGhpcy5jbWQgPSBJT1NERVBMT1lfUEFUSDsgLy8gdGhpcy5jbWQgaXMgaW4gYWNjb3JkYW5jZSB3aXRoIGlEZXZpY2VcbiAgfVxuXG4gIGFzeW5jIGNoZWNrU3RhdHVzICgpIHtcbiAgICAvLyBtYWtlIHN1cmUgd2UgYWN0dWFsbHkgaGF2ZSB0aGUgcHJvZ3JhbVxuICAgIGF3YWl0IGZzLndoaWNoKHRoaXMuY21kKTtcbiAgfVxuXG4gIGFzeW5jIGxhdW5jaEFwcCAoYXBwKSB7XG4gICAgbGV0IHJlbW92ZSA9IFtgLS1qdXN0bGF1bmNoYCwgYC0tbm9pbnN0YWxsYCwgdGhpcy51ZGlkLCBgLS1idW5kbGVgLCBhcHBdO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBleGVjKHRoaXMuY21kLCByZW1vdmUpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBTdGRvdXQ6ICcke2Vyci5zdGRvdXR9Jy4gU3RkZXJyOiAnJHtlcnIuc3RkZXJyfScuYCk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCByZW1vdmUgYXBwOiAnJHtlcnIubWVzc2FnZX0nYCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmVtb3ZlIChidW5kbGVpZCkge1xuICAgIGxldCByZW1vdmUgPSBbYC0tdW5pbnN0YWxsX29ubHlgLCBgLS1pZGAsIHRoaXMudWRpZCwgYC0tYnVuZGxlX2lkYCwgYnVuZGxlaWRdO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBleGVjKHRoaXMuY21kLCByZW1vdmUpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBTdGRvdXQ6ICcke2Vyci5zdGRvdXR9Jy4gU3RkZXJyOiAnJHtlcnIuc3RkZXJyfScuYCk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCByZW1vdmUgYXBwOiAnJHtlcnIubWVzc2FnZX0nYCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmVtb3ZlQXBwIChidW5kbGVJZCkge1xuICAgIGF3YWl0IHRoaXMucmVtb3ZlKGJ1bmRsZUlkKTtcbiAgfVxuXG4gIGFzeW5jIGluc3RhbGwgKGFwcCkge1xuICAgIGNvbnN0IGFyZ3MgPSBbYC0tanVzdGxhdW5jaGAsIGAtLXVuaW5zdGFsbGAsIGAtLWlkYCwgdGhpcy51ZGlkLCBgLS1idW5kbGVgLCBhcHBdO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCByZXRyeUludGVydmFsKDUsIDUwMCwgZXhlYywgdGhpcy5jbWQsIGFyZ3MpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBTdGRvdXQ6ICcke2Vyci5zdGRvdXR9Jy4gU3RkZXJyOiAnJHtlcnIuc3RkZXJyfScuYCk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBpbnN0YWxsIGFwcDogJyR7ZXJyLm1lc3NhZ2V9J2ApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGluc3RhbGxBcHAgKGFwcCkge1xuICAgIGF3YWl0IHRoaXMuaW5zdGFsbChhcHApO1xuICB9XG5cbiAgYXN5bmMgaXNBcHBJbnN0YWxsZWQgKGJ1bmRsZWlkKSB7XG4gICAgbGV0IGlzSW5zdGFsbGVkID0gW2AtLWV4aXN0c2AsIGAtLWlkYCwgdGhpcy51ZGlkLCBgLS1idW5kbGVfaWRgLCBidW5kbGVpZF07XG4gICAgdHJ5IHtcbiAgICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWModGhpcy5jbWQsIGlzSW5zdGFsbGVkKTtcbiAgICAgIHJldHVybiAoc3Rkb3V0ICYmIChzdGRvdXQuaW5jbHVkZXMoJ3RydWUnKSkpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gZXJyb3IgMjU1IGlzIGp1c3QgaW9zLWRlcGxveSdzIHdheSBvZiBzYXlpbmcgaXQgaXMgbm90IGluc3RhbGxlZFxuICAgICAgaWYgKGVyci5jb2RlICE9PSAyNTUpIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKGBFcnJvciBjaGVja2luZyBpbnN0YWxsIHN0YXR1czogJyR7ZXJyLm1lc3NhZ2V9J2ApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBJT1NEZXBsb3k7XG4iXSwiZmlsZSI6ImxpYi9pb3MtZGVwbG95LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
