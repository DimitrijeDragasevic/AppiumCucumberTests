"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.YouiEngineDriver = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _desiredCaps = require("./desired-caps");

var _logger = _interopRequireDefault(require("./logger"));

var _index = _interopRequireDefault(require("./commands/index"));

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _asyncbox = require("asyncbox");

var _appiumAndroidDriver = _interopRequireDefault(require("appium-android-driver"));

var _appiumIosDriver = _interopRequireDefault(require("appium-ios-driver"));

var _appiumXcuitestDriver = _interopRequireDefault(require("appium-xcuitest-driver"));

var _appiumMacDriver = _interopRequireDefault(require("appium-mac-driver"));

var _bluesky = _interopRequireDefault(require("./bluesky"));

var _tvos = _interopRequireDefault(require("./tvos"));

var _tvossimulator = _interopRequireDefault(require("./tvossimulator"));

var _yimac = _interopRequireDefault(require("./yimac"));

const TO_PROXY_COMMON = ['background', 'closeApp', 'getLog', 'getLogTypes', 'getOrientation', 'getStrings', 'installApp', 'launchApp', 'lock', 'removeApp', 'setOrientation'];
const TO_PROXY_IOS_ONLY = ['mobileShake'];
const TO_PROXY_ANDROID_ONLY = ['getNetworkConnection', 'isAppInstalled', 'isLocked', 'longPressKeyCode', 'pressKeyCode', 'setNetworkConnection', 'toggleLocationServices', 'unlock'];
const TO_PROXY_IOS = TO_PROXY_IOS_ONLY.concat(TO_PROXY_COMMON);
const TO_PROXY_ANDROID = TO_PROXY_ANDROID_ONLY.concat(TO_PROXY_COMMON);
const TO_PROXY_MAC = TO_PROXY_COMMON;
const MAX_RETRY_COUNT = 10;
const RETRY_BACKOFF = 3000;

class YouiEngineDriver extends _appiumBaseDriver.BaseDriver {
  resetYouiEngine() {
    this.ready = false;
    this.socket = null;
    this.locatorStrategies = ['id', 'name', 'class name', 'accessibility id'];
    this.proxydriver = null;
    this.proxyAllowList = '';
    this.device = null;
  }

  constructor(opts, shouldValidateCaps) {
    super(opts, shouldValidateCaps);
    this.desiredCapConstraints = _desiredCaps.desiredCapConstraints;
    this.settings = new _appiumBaseDriver.DeviceSettings({
      'TimeDilation': 1,
      'SourceTreeFilter': ''
    }, this.onSettingsUpdate.bind(this));
    this.resetYouiEngine();
  }

  validateLocatorStrategy(strategy) {
    super.validateLocatorStrategy(strategy, false);
  }

  async createSession(caps) {
    try {
      let [sessionId] = await super.createSession(caps);

      if (caps.platformName !== null) {
        let appPlatform = caps.platformName.toLowerCase();
        this.validateAppLocation(caps.app);

        switch (appPlatform) {
          case "ios":
            await this.startIOSSession(caps);
            break;

          case "android":
            await this.startAndroidSession(caps);
            break;

          case "mac":
            await this.startMacSession(caps);
            break;

          case "yimac":
            this.device = new _yimac.default();
            this.device.startSession(caps);
            break;

          case "bluesky":
            this.device = new _bluesky.default();
            this.device.startSession(caps);
            break;

          case "yitvos":
            let shell = require('shelljs');

            if (shell.exec(`instruments -s devices | grep '${caps.udid}'`).includes('(Simulator)')) {
              this.device = new _tvossimulator.default();
            } else {
              this.device = new _tvos.default();
            }

            await this.device.startSession(caps, this);
            break;

          case "noproxy":
            break;

          default:
            let msg = `Unsupported platformName: ${caps.platformName}`;

            _logger.default.errorAndThrow(msg);

        }
      }

      await this.connectSocket();
      return [sessionId, this.opts];
    } catch (e) {
      await this.deleteSession();
      throw e;
    }
  }

  async onSettingsUpdate(key, value) {
    if (key === "TimeDilation") {
      await this.setTimeDilation(value);
    } else if (key === "SourceTreeFilter") {
      await this.setSourceTreeFilter(value);
    }
  }

  async stop() {
    this.ready = false;
  }

  async deleteSession() {
    _logger.default.debug("Deleting YouiEngine session");

    if (this.caps.platformName !== null) {
      let appPlatform = this.caps.platformName.toLowerCase();

      if (["yimac", "yitvos", "bluesky"].includes(appPlatform)) {
        if (this.device) {
          this.device.endSession();
        }
      }
    }

    if (this.proxydriver !== null) {
      await this.proxydriver.deleteSession();
    }

    await super.deleteSession();
    await this.stop();
  }

  driverShouldDoProxyCmd(command) {
    if (!this.proxydriver) {
      return false;
    }

    for (let allowedCommand of this.proxyAllowList) {
      if (allowedCommand === command) {
        return true;
      }
    }

    return false;
  }

  async executeCommand(cmd, ...args) {
    if (cmd === 'receiveAsyncResponse') {
      _logger.default.debug(`Executing YouiEngineDriver response '${cmd}'`);

      return await this.receiveAsyncResponse(...args);
    } else if (this.ready) {
      if (this.driverShouldDoProxyCmd(cmd)) {
        _logger.default.debug(`Executing proxied WebDriver command '${cmd}'`);

        this.clearNewCommandTimeout();
        let result = this.proxydriver.executeCommand(cmd, ...args);
        this.startNewCommandTimeout(cmd);
        return result;
      } else {
        _logger.default.debug(`Executing YouiEngine WebDriver command '${cmd}'`);

        return super.executeCommand(cmd, ...args);
      }
    } else {
      _logger.default.debug(`Command Error '${cmd}'`);

      throw new _appiumBaseDriver.errors.NoSuchDriverError(`Driver is not ready, cannot execute ${cmd}.`);
    }
  }

  validateDesiredCaps(caps) {
    let res = super.validateDesiredCaps(caps);

    if (!res) {
      return res;
    }

    if (caps.platformName.toLowerCase() !== 'noproxy') {
      if (!caps.youiEngineAppAddress) {
        let msg = 'The desired capabilities must include youiEngineAppAddress';

        _logger.default.errorAndThrow(msg);
      }

      if (!caps.app) {
        let msg = 'The desired capabilities must include app';

        _logger.default.errorAndThrow(msg);
      }

      if (caps.deviceName.toLowerCase() === 'android') {
        if (!caps.avd) {
          let msg = 'The desired capabilities must include avd';

          _logger.default.errorAndThrow(msg);
        }
      }
    }

    return true;
  }

  async setupNewIOSDriver(caps) {
    let iosArgs = {
      javascriptEnabled: true
    };
    let iosdriver = new _appiumXcuitestDriver.default(iosArgs);

    if (caps.platformVersion) {
      let majorVer = caps.platformVersion.toString().split(".")[0];

      if (parseInt(majorVer, 10) < 10) {
        iosdriver = new _appiumIosDriver.default(iosArgs);
      }
    }

    let capsCopy = _lodash.default.cloneDeep(caps);

    capsCopy.newCommandTimeout = 0;
    await iosdriver.createSession(capsCopy);
    return iosdriver;
  }

  async startIOSSession(caps) {
    _logger.default.info("Starting an IOS proxy session");

    this.proxyAllowList = TO_PROXY_IOS;
    this.proxydriver = await this.setupNewIOSDriver(caps);
  }

  async setupNewAndroidDriver(caps) {
    let androidArgs = {
      javascriptEnabled: true
    };
    let androiddriver = new _appiumAndroidDriver.default(androidArgs);

    let capsCopy = _lodash.default.cloneDeep(caps);

    capsCopy.newCommandTimeout = 0;
    await androiddriver.createSession(capsCopy);
    return androiddriver;
  }

  async startAndroidSession(caps) {
    _logger.default.info("Starting an Android proxy session");

    this.proxyAllowList = TO_PROXY_ANDROID;
    this.proxydriver = await this.setupNewAndroidDriver(caps);
  }

  async setupNewMacDriver(caps) {
    let macArgs = {
      javascriptEnabled: true
    };
    let macdriver = new _appiumMacDriver.default(macArgs);

    let capsCopy = _lodash.default.cloneDeep(caps);

    capsCopy.newCommandTimeout = 0;
    await macdriver.createSession(capsCopy);
    return macdriver;
  }

  async startMacSession(caps) {
    _logger.default.info("Starting a Mac proxy session");

    this.proxyAllowList = TO_PROXY_MAC;
    this.proxydriver = await this.setupNewMacDriver(caps);
  }

  validateAppLocation(app) {
    const fs = require('fs');

    const path = require('path');

    if (!fs.existsSync(app)) {
      let absolutepath = path.resolve(app);
      let msg = 'The app could not be found in following location: ' + absolutepath;

      _logger.default.errorAndThrow(msg);
    }
  }

  async connectSocket() {
    let retryCount = 0;
    let connected = false;

    while (retryCount < MAX_RETRY_COUNT && !connected) {
      if (retryCount > 0) {
        _logger.default.info("Waiting " + RETRY_BACKOFF / 1000 + " seconds before trying...");

        await (0, _asyncbox.sleep)(RETRY_BACKOFF);
      }

      _logger.default.info("Attempt #" + (retryCount + 1));

      let connectedPromise = new _bluebird.default(resolve => {
        let net = require('net');

        let HOST = this.opts.youiEngineAppAddress;
        let PORT = 12345;

        _logger.default.info('Connecting to WebDriver: ' + HOST + ':' + PORT);

        this.socket = new net.Socket();
        this.socket.on('error', function (ex) {
          _logger.default.error(ex);

          _logger.default.error('Check that WebDriver is enabled in application, if a device ensure the proper IP address is used.');

          resolve(false);
        });
        this.socket.on('close', function () {
          _logger.default.info('Connection closed');
        });
        this.socket.on('timeout', function () {
          _logger.default.error('Connection timed out');

          resolve(false);
        });
        this.socket.connect(PORT, HOST, function () {
          _logger.default.info('Connected');

          resolve(true);
        });
      });
      retryCount++;
      connected = await connectedPromise;

      if (!connected && retryCount === MAX_RETRY_COUNT - 1) {
        _logger.default.errorAndThrow("Failed to connect " + MAX_RETRY_COUNT + " times. Aborting.");
      }
    }

    retryCount = 0;
    this.ready = connected;
  }

  async executeSocketCommand(cmd) {
    if (!this.socket.writable) {
      _logger.default.info("Socket is not writable. Trying to reconnect.");

      await this.connectSocket();
    }

    let cmdPromise = new _bluebird.default(resolve => {
      _logger.default.debug('COMMAND: ' + cmd);

      let totaldata = [];
      let endMarker = new Buffer("youiend");
      let socketClient = this.socket;

      let dataHandler = function (data) {
        if (data.length >= endMarker.length) {
          let dataend = new Buffer(endMarker.length);
          let startIndex = data.length - endMarker.length;
          data.copy(dataend, 0, startIndex, startIndex + endMarker.length);

          if (dataend.equals(endMarker)) {
            let lastData = data.slice(0, startIndex);
            totaldata.push(lastData);
            socketClient.removeListener('data', dataHandler);
            resolve(Buffer.concat(totaldata));
          } else {
            totaldata.push(data);
          }
        }
      };

      socketClient.write(cmd + "\n", "UTF8", () => {
        socketClient.on('data', dataHandler);
      });
    });
    return await cmdPromise;
  }

}

exports.YouiEngineDriver = YouiEngineDriver;

for (let [cmd, fn] of _lodash.default.toPairs(_index.default)) {
  YouiEngineDriver.prototype[cmd] = fn;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kcml2ZXIuanMiXSwibmFtZXMiOlsiVE9fUFJPWFlfQ09NTU9OIiwiVE9fUFJPWFlfSU9TX09OTFkiLCJUT19QUk9YWV9BTkRST0lEX09OTFkiLCJUT19QUk9YWV9JT1MiLCJjb25jYXQiLCJUT19QUk9YWV9BTkRST0lEIiwiVE9fUFJPWFlfTUFDIiwiTUFYX1JFVFJZX0NPVU5UIiwiUkVUUllfQkFDS09GRiIsIllvdWlFbmdpbmVEcml2ZXIiLCJCYXNlRHJpdmVyIiwicmVzZXRZb3VpRW5naW5lIiwicmVhZHkiLCJzb2NrZXQiLCJsb2NhdG9yU3RyYXRlZ2llcyIsInByb3h5ZHJpdmVyIiwicHJveHlBbGxvd0xpc3QiLCJkZXZpY2UiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJzaG91bGRWYWxpZGF0ZUNhcHMiLCJkZXNpcmVkQ2FwQ29uc3RyYWludHMiLCJzZXR0aW5ncyIsIkRldmljZVNldHRpbmdzIiwib25TZXR0aW5nc1VwZGF0ZSIsImJpbmQiLCJ2YWxpZGF0ZUxvY2F0b3JTdHJhdGVneSIsInN0cmF0ZWd5IiwiY3JlYXRlU2Vzc2lvbiIsImNhcHMiLCJzZXNzaW9uSWQiLCJwbGF0Zm9ybU5hbWUiLCJhcHBQbGF0Zm9ybSIsInRvTG93ZXJDYXNlIiwidmFsaWRhdGVBcHBMb2NhdGlvbiIsImFwcCIsInN0YXJ0SU9TU2Vzc2lvbiIsInN0YXJ0QW5kcm9pZFNlc3Npb24iLCJzdGFydE1hY1Nlc3Npb24iLCJZaU1hYyIsInN0YXJ0U2Vzc2lvbiIsIkJsdWVTa3kiLCJzaGVsbCIsInJlcXVpcmUiLCJleGVjIiwidWRpZCIsImluY2x1ZGVzIiwiVHZPc1NpbXVsYXRvciIsIlR2T3MiLCJtc2ciLCJsb2dnZXIiLCJlcnJvckFuZFRocm93IiwiY29ubmVjdFNvY2tldCIsImUiLCJkZWxldGVTZXNzaW9uIiwia2V5IiwidmFsdWUiLCJzZXRUaW1lRGlsYXRpb24iLCJzZXRTb3VyY2VUcmVlRmlsdGVyIiwic3RvcCIsImRlYnVnIiwiZW5kU2Vzc2lvbiIsImRyaXZlclNob3VsZERvUHJveHlDbWQiLCJjb21tYW5kIiwiYWxsb3dlZENvbW1hbmQiLCJleGVjdXRlQ29tbWFuZCIsImNtZCIsImFyZ3MiLCJyZWNlaXZlQXN5bmNSZXNwb25zZSIsImNsZWFyTmV3Q29tbWFuZFRpbWVvdXQiLCJyZXN1bHQiLCJzdGFydE5ld0NvbW1hbmRUaW1lb3V0IiwiZXJyb3JzIiwiTm9TdWNoRHJpdmVyRXJyb3IiLCJ2YWxpZGF0ZURlc2lyZWRDYXBzIiwicmVzIiwieW91aUVuZ2luZUFwcEFkZHJlc3MiLCJkZXZpY2VOYW1lIiwiYXZkIiwic2V0dXBOZXdJT1NEcml2ZXIiLCJpb3NBcmdzIiwiamF2YXNjcmlwdEVuYWJsZWQiLCJpb3Nkcml2ZXIiLCJYQ1VJVGVzdERyaXZlciIsInBsYXRmb3JtVmVyc2lvbiIsIm1ham9yVmVyIiwidG9TdHJpbmciLCJzcGxpdCIsInBhcnNlSW50IiwiSU9TRHJpdmVyIiwiY2Fwc0NvcHkiLCJfIiwiY2xvbmVEZWVwIiwibmV3Q29tbWFuZFRpbWVvdXQiLCJpbmZvIiwic2V0dXBOZXdBbmRyb2lkRHJpdmVyIiwiYW5kcm9pZEFyZ3MiLCJhbmRyb2lkZHJpdmVyIiwiQW5kcm9pZERyaXZlciIsInNldHVwTmV3TWFjRHJpdmVyIiwibWFjQXJncyIsIm1hY2RyaXZlciIsIk1hY0RyaXZlciIsImZzIiwicGF0aCIsImV4aXN0c1N5bmMiLCJhYnNvbHV0ZXBhdGgiLCJyZXNvbHZlIiwicmV0cnlDb3VudCIsImNvbm5lY3RlZCIsImNvbm5lY3RlZFByb21pc2UiLCJCIiwibmV0IiwiSE9TVCIsIlBPUlQiLCJTb2NrZXQiLCJvbiIsImV4IiwiZXJyb3IiLCJjb25uZWN0IiwiZXhlY3V0ZVNvY2tldENvbW1hbmQiLCJ3cml0YWJsZSIsImNtZFByb21pc2UiLCJ0b3RhbGRhdGEiLCJlbmRNYXJrZXIiLCJCdWZmZXIiLCJzb2NrZXRDbGllbnQiLCJkYXRhSGFuZGxlciIsImRhdGEiLCJsZW5ndGgiLCJkYXRhZW5kIiwic3RhcnRJbmRleCIsImNvcHkiLCJlcXVhbHMiLCJsYXN0RGF0YSIsInNsaWNlIiwicHVzaCIsInJlbW92ZUxpc3RlbmVyIiwid3JpdGUiLCJmbiIsInRvUGFpcnMiLCJjb21tYW5kcyIsInByb3RvdHlwZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFNQSxNQUFNQSxlQUFlLEdBQUcsQ0FDdEIsWUFEc0IsRUFFdEIsVUFGc0IsRUFHdEIsUUFIc0IsRUFJdEIsYUFKc0IsRUFLdEIsZ0JBTHNCLEVBTXRCLFlBTnNCLEVBT3RCLFlBUHNCLEVBUXRCLFdBUnNCLEVBU3RCLE1BVHNCLEVBVXRCLFdBVnNCLEVBV3RCLGdCQVhzQixDQUF4QjtBQWNBLE1BQU1DLGlCQUFpQixHQUFHLENBQ3hCLGFBRHdCLENBQTFCO0FBSUEsTUFBTUMscUJBQXFCLEdBQUcsQ0FDNUIsc0JBRDRCLEVBRTVCLGdCQUY0QixFQUc1QixVQUg0QixFQUk1QixrQkFKNEIsRUFLNUIsY0FMNEIsRUFNNUIsc0JBTjRCLEVBTzVCLHdCQVA0QixFQVE1QixRQVI0QixDQUE5QjtBQVdBLE1BQU1DLFlBQVksR0FBR0YsaUJBQWlCLENBQUNHLE1BQWxCLENBQXlCSixlQUF6QixDQUFyQjtBQUNBLE1BQU1LLGdCQUFnQixHQUFHSCxxQkFBcUIsQ0FBQ0UsTUFBdEIsQ0FBNkJKLGVBQTdCLENBQXpCO0FBQ0EsTUFBTU0sWUFBWSxHQUFHTixlQUFyQjtBQUVBLE1BQU1PLGVBQWUsR0FBRyxFQUF4QjtBQUNBLE1BQU1DLGFBQWEsR0FBRyxJQUF0Qjs7QUFFQSxNQUFNQyxnQkFBTixTQUErQkMsNEJBQS9CLENBQTBDO0FBQ3hDQyxFQUFBQSxlQUFlLEdBQUk7QUFFakIsU0FBS0MsS0FBTCxHQUFhLEtBQWI7QUFDQSxTQUFLQyxNQUFMLEdBQWMsSUFBZDtBQUNBLFNBQUtDLGlCQUFMLEdBQXlCLENBQUMsSUFBRCxFQUFP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QUFFQSxjQUFJQyxPQUFPLENBQUNHLE1BQVIsQ0FBZVQsU0FBZixDQUFKLEVBQStCO0FBRTdCLGdCQUFJVSxRQUFRLEdBQUdOLElBQUksQ0FBQ08sS0FBTCxDQUFXLENBQVgsRUFBY0osVUFBZCxDQUFmO0FBRUFSLFlBQUFBLFNBQVMsQ0FBQ2EsSUFBVixDQUFlRixRQUFmO0FBR0FSLFlBQUFBLFlBQVksQ0FBQ1csY0FBYixDQUE0QixNQUE1QixFQUFvQ1YsV0FBcEM7QUFHQXBCLFlBQUFBLE9BQU8sQ0FBQ2tCLE1BQU0sQ0FBQ3pILE1BQVAsQ0FBY3VILFNBQWQsQ0FBRCxDQUFQO0FBQ0QsV0FYRCxNQVdPO0FBQ0xBLFlBQUFBLFNBQVMsQ0FBQ2EsSUFBVixDQUFlUixJQUFmO0FBQ0Q7QUFDRjtBQUNGLE9BeEJEOztBQTBCQUYsTUFBQUEsWUFBWSxDQUFDWSxLQUFiLENBQW1CeEUsR0FBRyxHQUFHLElBQXpCLEVBQStCLE1BQS9CLEVBQXVDLE1BQU07QUFDM0M0RCxRQUFBQSxZQUFZLENBQUNWLEVBQWIsQ0FBZ0IsTUFBaEIsRUFBd0JXLFdBQXhCO0FBQ0QsT0FGRDtBQUdELEtBckNnQixDQUFqQjtBQXNDQSxXQUFPLE1BQU1MLFVBQWI7QUFDRDs7QUExV3VDOzs7O0FBNlcxQyxLQUFLLElBQUksQ0FBQ3hELEdBQUQsRUFBTXlFLEVBQU4sQ0FBVCxJQUFzQmhELGdCQUFFaUQsT0FBRixDQUFVQyxjQUFWLENBQXRCLEVBQTJDO0FBQ3pDcEksRUFBQUEsZ0JBQWdCLENBQUNxSSxTQUFqQixDQUEyQjVFLEdBQTNCLElBQWtDeUUsRUFBbEM7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhc2VEcml2ZXIsIERldmljZVNldHRpbmdzLCBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgZGVzaXJlZENhcENvbnN0cmFpbnRzIH0gZnJvbSAnLi9kZXNpcmVkLWNhcHMnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgY29tbWFuZHMgZnJvbSAnLi9jb21tYW5kcy9pbmRleCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgc2xlZXAgfSBmcm9tICdhc3luY2JveCc7XG5cbi8vIGZvciBwcm94aWVzXG5pbXBvcnQgQW5kcm9pZERyaXZlciBmcm9tICdhcHBpdW0tYW5kcm9pZC1kcml2ZXInO1xuaW1wb3J0IElPU0RyaXZlciBmcm9tICdhcHBpdW0taW9zLWRyaXZlcic7XG5pbXBvcnQgWENVSVRlc3REcml2ZXIgZnJvbSAnYXBwaXVtLXhjdWl0ZXN0LWRyaXZlcic7XG5pbXBvcnQgTWFjRHJpdmVyIGZyb20gJ2FwcGl1bS1tYWMtZHJpdmVyJztcbmltcG9ydCBCbHVlU2t5IGZyb20gJy4vYmx1ZXNreSc7XG5pbXBvcnQgVHZPcyBmcm9tICcuL3R2b3MnO1xuaW1wb3J0IFR2T3NTaW11bGF0b3IgZnJvbSAnLi90dm9zc2ltdWxhdG9yJztcbmltcG9ydCBZaU1hYyBmcm9tICcuL3lpbWFjJztcblxuXG4vLyBBZGQgY29tbWFuZHMgZnJvbSB0aGUgZm9sbG93aW5nIGxvY2F0aW9uIHRoYXQgc2hvdWxkIGJlIG1hcHBlZCB0byBleGlzdGluZyBkcml2ZXJzOlxuLy8gaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0tYmFzZS1kcml2ZXIvYmxvYi9tYXN0ZXIvbGliL21qc29ud3Avcm91dGVzLmpzXG5cbmNvbnN0IFRPX1BST1hZX0NPTU1PTiA9IFtcbiAgJ2JhY2tncm91bmQnLFxuICAnY2xvc2VBcHAnLFxuICAnZ2V0TG9nJyxcbiAgJ2dldExvZ1R5cGVzJyxcbiAgJ2dldE9yaWVudGF0aW9uJyxcbiAgJ2dldFN0cmluZ3MnLFxuICAnaW5zdGFsbEFwcCcsXG4gICdsYXVuY2hBcHAnLFxuICAnbG9jaycsXG4gICdyZW1vdmVBcHAnLFxuICAnc2V0T3JpZW50YXRpb24nLFxuXTtcblxuY29uc3QgVE9fUFJPWFlfSU9TX09OTFkgPSBbXG4gICdtb2JpbGVTaGFrZScsXG5dO1xuXG5jb25zdCBUT19QUk9YWV9BTkRST0lEX09OTFkgPSBbXG4gICdnZXROZXR3b3JrQ29ubmVjdGlvbicsXG4gICdpc0FwcEluc3RhbGxlZCcsXG4gICdpc0xvY2tlZCcsXG4gICdsb25nUHJlc3NLZXlDb2RlJyxcbiAgJ3ByZXNzS2V5Q29kZScsXG4gICdzZXROZXR3b3JrQ29ubmVjdGlvbicsXG4gICd0b2dnbGVMb2NhdGlvblNlcnZpY2VzJyxcbiAgJ3VubG9jaycsXG5dO1xuXG5jb25zdCBUT19QUk9YWV9JT1MgPSBUT19QUk9YWV9JT1NfT05MWS5jb25jYXQoVE9fUFJPWFlfQ09NTU9OKTtcbmNvbnN0IFRPX1BST1hZX0FORFJPSUQgPSBUT19QUk9YWV9BTkRST0lEX09OTFkuY29uY2F0KFRPX1BST1hZX0NPTU1PTik7XG5jb25zdCBUT19QUk9YWV9NQUMgPSBUT19QUk9YWV9DT01NT047XG5cbmNvbnN0IE1BWF9SRVRSWV9DT1VOVCA9IDEwO1xuY29uc3QgUkVUUllfQkFDS09GRiA9IDMwMDA7XG5cbmNsYXNzIFlvdWlFbmdpbmVEcml2ZXIgZXh0ZW5kcyBCYXNlRHJpdmVyIHtcbiAgcmVzZXRZb3VpRW5naW5lICgpIHtcblxuICAgIHRoaXMucmVhZHkgPSBmYWxzZTtcbiAgICB0aGlzLnNvY2tldCA9IG51bGw7XG4gICAgdGhpcy5sb2NhdG9yU3RyYXRlZ2llcyA9IFsnaWQnLCAnbmFtZScsICdjbGFzcyBuYW1lJywgJ2FjY2Vzc2liaWxpdHkgaWQnXTtcbiAgICB0aGlzLnByb3h5ZHJpdmVyID0gbnVsbDtcbiAgICB0aGlzLnByb3h5QWxsb3dMaXN0ID0gJyc7XG4gICAgdGhpcy5kZXZpY2UgPSBudWxsO1xuICB9XG5cbiAgY29uc3RydWN0b3IgKG9wdHMsIHNob3VsZFZhbGlkYXRlQ2Fwcykge1xuICAgIHN1cGVyKG9wdHMsIHNob3VsZFZhbGlkYXRlQ2Fwcyk7XG5cbiAgICB0aGlzLmRlc2lyZWRDYXBDb25zdHJhaW50cyA9IGRlc2lyZWRDYXBDb25zdHJhaW50cztcbiAgICB0aGlzLnNldHRpbmdzID0gbmV3IERldmljZVNldHRpbmdzKHsnVGltZURpbGF0aW9uJzogMSwgJ1NvdXJjZVRyZWVGaWx0ZXInOiAnJ30sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25TZXR0aW5nc1VwZGF0ZS5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLnJlc2V0WW91aUVuZ2luZSgpO1xuXG4gIH1cblxuICB2YWxpZGF0ZUxvY2F0b3JTdHJhdGVneSAoc3RyYXRlZ3kpIHtcbiAgICBzdXBlci52YWxpZGF0ZUxvY2F0b3JTdHJhdGVneShzdHJhdGVneSwgZmFsc2UpO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlU2Vzc2lvbiAoY2Fwcykge1xuICAgIHRyeSB7XG4gICAgICBsZXQgW3Nlc3Npb25JZF0gPSBhd2FpdCBzdXBlci5jcmVhdGVTZXNzaW9uKGNhcHMpO1xuXG4gICAgICAvLyBzZXR1cCBwcm94aWVzIC0gaWYgcGxhdGZvcm1OYW1lIGlzIG5vdCBlbXB0eSwgbWFrZSBpdCBsZXNzIGNhc2Ugc2Vuc2l0aXZlXG4gICAgICBpZiAoY2Fwcy5wbGF0Zm9ybU5hbWUgIT09IG51bGwpIHtcbiAgICAgICAgbGV0IGFwcFBsYXRmb3JtID0gY2Fwcy5wbGF0Zm9ybU5hbWUudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgdGhpcy52YWxpZGF0ZUFwcExvY2F0aW9uKGNhcHMuYXBwKTtcbiAgICAgICAgc3dpdGNoKGFwcFBsYXRmb3JtKSB7XG4gICAgICAgICAgY2FzZSBcImlvc1wiOlxuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFydElPU1Nlc3Npb24oY2Fwcyk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlIFwiYW5kcm9pZFwiOlxuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFydEFuZHJvaWRTZXNzaW9uKGNhcHMpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSBcIm1hY1wiOlxuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFydE1hY1Nlc3Npb24oY2Fwcyk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlIFwieWltYWNcIjpcbiAgICAgICAgICAgIHRoaXMuZGV2aWNlID0gbmV3IFlpTWFjKCk7XG4gICAgICAgICAgICB0aGlzLmRldmljZS5zdGFydFNlc3Npb24oY2Fwcyk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlIFwiYmx1ZXNreVwiOlxuICAgICAgICAgICAgdGhpcy5kZXZpY2UgPSBuZXcgQmx1ZVNreSgpO1xuICAgICAgICAgICAgdGhpcy5kZXZpY2Uuc3RhcnRTZXNzaW9uKGNhcHMpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSBcInlpdHZvc1wiOlxuICAgICAgICAgICAgbGV0IHNoZWxsID0gcmVxdWlyZSgnc2hlbGxqcycpO1xuICAgICAgICAgICAgaWYgKHNoZWxsLmV4ZWMoYGluc3RydW1lbnRzIC1zIGRldmljZXMgfCBncmVwICcke2NhcHMudWRpZH0nYCkuaW5jbHVkZXMoJyhTaW11bGF0b3IpJykpIHtcbiAgICAgICAgICAgICAgdGhpcy5kZXZpY2UgPSBuZXcgVHZPc1NpbXVsYXRvcigpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgdGhpcy5kZXZpY2UgPSBuZXcgVHZPcygpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5kZXZpY2Uuc3RhcnRTZXNzaW9uKGNhcHMsIHRoaXMpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSBcIm5vcHJveHlcIjpcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICBsZXQgbXNnID0gYFVuc3VwcG9ydGVkIHBsYXRmb3JtTmFtZTogJHtjYXBzLnBsYXRmb3JtTmFtZX1gO1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3cobXNnKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBhd2FpdCB0aGlzLmNvbm5lY3RTb2NrZXQoKTtcbiAgICAgIHJldHVybiBbc2Vzc2lvbklkLCB0aGlzLm9wdHNdO1xuXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgYXdhaXQgdGhpcy5kZWxldGVTZXNzaW9uKCk7XG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIG9uU2V0dGluZ3NVcGRhdGUgKGtleSwgdmFsdWUpIHtcbiAgICBpZiAoa2V5ID09PSBcIlRpbWVEaWxhdGlvblwiKSB7XG4gICAgICBhd2FpdCB0aGlzLnNldFRpbWVEaWxhdGlvbih2YWx1ZSk7XG4gICAgfSBlbHNlIGlmIChrZXkgPT09IFwiU291cmNlVHJlZUZpbHRlclwiKSB7XG4gICAgICBhd2FpdCB0aGlzLnNldFNvdXJjZVRyZWVGaWx0ZXIodmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0b3AgKCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgICB0aGlzLnJlYWR5ID0gZmFsc2U7XG4gIH1cblxuICBhc3luYyBkZWxldGVTZXNzaW9uICgpIHtcbiAgICBsb2dnZXIuZGVidWcoXCJEZWxldGluZyBZb3VpRW5naW5lIHNlc3Npb25cIik7XG5cbiAgICBpZiAodGhpcy5jYXBzLnBsYXRmb3JtTmFtZSAhPT0gbnVsbCkge1xuICAgICAgbGV0IGFwcFBsYXRmb3JtID0gdGhpcy5jYXBzLnBsYXRmb3JtTmFtZS50b0xvd2VyQ2FzZSgpO1xuXG4gICAgICBpZihbXCJ5aW1hY1wiLCBcInlpdHZvc1wiLCBcImJsdWVza3lcIl0uaW5jbHVkZXMoYXBwUGxhdGZvcm0pKSB7XG4gICAgICAgIGlmICh0aGlzLmRldmljZSl7XG4gICAgICAgICAgdGhpcy5kZXZpY2UuZW5kU2Vzc2lvbigpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHRoaXMucHJveHlkcml2ZXIgIT09IG51bGwpIHtcbiAgICAgIGF3YWl0IHRoaXMucHJveHlkcml2ZXIuZGVsZXRlU2Vzc2lvbigpO1xuICAgIH1cbiAgICBhd2FpdCBzdXBlci5kZWxldGVTZXNzaW9uKCk7XG4gICAgYXdhaXQgdGhpcy5zdG9wKCk7XG4gIH1cblxuICBkcml2ZXJTaG91bGREb1Byb3h5Q21kIChjb21tYW5kKSB7XG4gICAgaWYgKCF0aGlzLnByb3h5ZHJpdmVyKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLy8gb25seSBhbGxvdyB3aGl0ZSBsaXN0ZWQgY29tbWFuZHNcbiAgICBmb3IgKGxldCBhbGxvd2VkQ29tbWFuZCBvZiB0aGlzLnByb3h5QWxsb3dMaXN0KSB7XG4gICAgICBpZiAoYWxsb3dlZENvbW1hbmQgPT09IGNvbW1hbmQpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGFzeW5jIGV4ZWN1dGVDb21tYW5kIChjbWQsIC4uLmFyZ3MpIHtcbiAgICBpZiAoY21kID09PSAncmVjZWl2ZUFzeW5jUmVzcG9uc2UnKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYEV4ZWN1dGluZyBZb3VpRW5naW5lRHJpdmVyIHJlc3BvbnNlICcke2NtZH0nYCk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5yZWNlaXZlQXN5bmNSZXNwb25zZSguLi5hcmdzKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMucmVhZHkpIHtcblxuICAgICAgaWYgKHRoaXMuZHJpdmVyU2hvdWxkRG9Qcm94eUNtZChjbWQpKSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgRXhlY3V0aW5nIHByb3hpZWQgV2ViRHJpdmVyIGNvbW1hbmQgJyR7Y21kfSdgKTtcblxuICAgICAgICAvLyBUaGVyZSBhcmUgMiBDb21tYW5kVGltZW91dCAoWW91aUVuZ2luZURyaXZlciBhbmQgcHJveHkpXG4gICAgICAgIC8vIE9ubHkgWW91aUVuZ2luZURyaXZlciBDb21tYW5kVGltZW91dCBpcyB1c2VkOyBQcm94eSBpcyBkaXNhYmxlZFxuICAgICAgICAvLyBBbGwgcHJveHkgY29tbWFuZHMgbmVlZHMgdG8gcmVzZXQgdGhlIFlvdWlFbmdpbmVEcml2ZXIgQ29tbWFuZFRpbWVvdXRcbiAgICAgICAgLy8gSGVyZSB3ZSBtYW51YWxseSByZXNldCB0aGUgWW91aUVuZ2luZURyaXZlciBDb21tYW5kVGltZW91dCBmb3IgY29tbWFuZHMgdGhhdCBnb2UgdG8gcHJveHkuXG4gICAgICAgIHRoaXMuY2xlYXJOZXdDb21tYW5kVGltZW91dCgpO1xuICAgICAgICBsZXQgcmVzdWx0ID0gdGhpcy5wcm94eWRyaXZlci5leGVjdXRlQ29tbWFuZChjbWQsIC4uLmFyZ3MpO1xuICAgICAgICB0aGlzLnN0YXJ0TmV3Q29tbWFuZFRpbWVvdXQoY21kKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgRXhlY3V0aW5nIFlvdWlFbmdpbmUgV2ViRHJpdmVyIGNvbW1hbmQgJyR7Y21kfSdgKTtcbiAgICAgICAgcmV0dXJuIHN1cGVyLmV4ZWN1dGVDb21tYW5kKGNtZCwgLi4uYXJncyk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgQ29tbWFuZCBFcnJvciAnJHtjbWR9J2ApO1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hEcml2ZXJFcnJvcihgRHJpdmVyIGlzIG5vdCByZWFkeSwgY2Fubm90IGV4ZWN1dGUgJHtjbWR9LmApO1xuICAgIH1cbiAgfVxuXG4gIHZhbGlkYXRlRGVzaXJlZENhcHMgKGNhcHMpIHtcbiAgICAvLyBjaGVjayB3aXRoIHRoZSBiYXNlIGNsYXNzLCBhbmQgcmV0dXJuIGlmIGl0IGZhaWxzXG4gICAgbGV0IHJlcyA9IHN1cGVyLnZhbGlkYXRlRGVzaXJlZENhcHMoY2Fwcyk7XG4gICAgaWYgKCFyZXMpIHtcbiAgICAgIHJldHVybiByZXM7XG4gICAgfVxuXG4gICAgLy8gdXNpbmcgYSBwcm94eVxuICAgIGlmIChjYXBzLnBsYXRmb3JtTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAnbm9wcm94eScpIHtcbiAgICAgIC8vIG1ha2Ugc3VyZSB0aGF0IHRoZSBjYXBhYmlsaXRpZXMgaGFzIHlvdWlFbmdpbmVBcHBBZGRyZXNzXG4gICAgICBpZiAoIWNhcHMueW91aUVuZ2luZUFwcEFkZHJlc3MpIHtcbiAgICAgICAgbGV0IG1zZyA9ICdUaGUgZGVzaXJlZCBjYXBhYmlsaXRpZXMgbXVzdCBpbmNsdWRlIHlvdWlFbmdpbmVBcHBBZGRyZXNzJztcbiAgICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3cobXNnKTtcbiAgICAgIH1cbiAgICAgIC8vIG1ha2Ugc3VyZSB0aGF0IHRoZSBjYXBhYmlsaXRpZXMgaGFzIGFwcFxuICAgICAgaWYgKCFjYXBzLmFwcCkge1xuICAgICAgICBsZXQgbXNnID0gJ1RoZSBkZXNpcmVkIGNhcGFiaWxpdGllcyBtdXN0IGluY2x1ZGUgYXBwJztcbiAgICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3cobXNnKTtcbiAgICAgIH1cblxuICAgICAgLy9BbmRyb2lkIGVtdWxhdG9yIHdpdGggcHJveHlcbiAgICAgIGlmIChjYXBzLmRldmljZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ2FuZHJvaWQnKSB7XG4gICAgICAgIGlmICghY2Fwcy5hdmQpIHtcbiAgICAgICAgICBsZXQgbXNnID0gJ1RoZSBkZXNpcmVkIGNhcGFiaWxpdGllcyBtdXN0IGluY2x1ZGUgYXZkJztcbiAgICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhtc2cpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gZmluYWxseSwgcmV0dXJuIHRydWUgc2luY2UgdGhlIHN1cGVyY2xhc3MgY2hlY2sgcGFzc2VkLCBhcyBkaWQgdGhpc1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgYXN5bmMgc2V0dXBOZXdJT1NEcml2ZXIgKGNhcHMpIHtcbiAgICBsZXQgaW9zQXJncyA9IHtcbiAgICAgIGphdmFzY3JpcHRFbmFibGVkOiB0cnVlLFxuICAgIH07XG5cbiAgICBsZXQgaW9zZHJpdmVyID0gbmV3IFhDVUlUZXN0RHJpdmVyKGlvc0FyZ3MpO1xuICAgIC8vIElmIGlPUyB2ZXJzaW9uIGlzIDEwIG9yIGFib3ZlIHdlIG5lZWQgdG8gdXNlIFhDVUlUZXN0RHJpdmVyIChhbmQgWGNvZGUgOCspXG4gICAgaWYgKGNhcHMucGxhdGZvcm1WZXJzaW9uKSB7XG4gICAgICBsZXQgbWFqb3JWZXIgPSBjYXBzLnBsYXRmb3JtVmVyc2lvbi50b1N0cmluZygpLnNwbGl0KFwiLlwiKVswXTtcbiAgICAgIGlmIChwYXJzZUludChtYWpvclZlciwgMTApIDwgMTApIHtcbiAgICAgICAgaW9zZHJpdmVyID0gbmV3IElPU0RyaXZlcihpb3NBcmdzKTtcbiAgICAgIH1cbiAgICB9XG4gICAgbGV0IGNhcHNDb3B5ID0gXy5jbG9uZURlZXAoY2Fwcyk7XG4gICAgLy8gRGlzYWJsaW5nIHRoZSBwcm94eSBDb21tYW5kVGltZW91dCBpbiB0aGUgaU9TIGRyaXZlciBzaW5jZSB3ZSBhcmUgbm93IGhhbmRsaW5nIGl0IGluIHRoZSBZb3VpRW5naW5lIERyaXZlclxuICAgIGNhcHNDb3B5Lm5ld0NvbW1hbmRUaW1lb3V0ID0gMDtcbiAgICBhd2FpdCBpb3Nkcml2ZXIuY3JlYXRlU2Vzc2lvbihjYXBzQ29weSk7XG5cbiAgICByZXR1cm4gaW9zZHJpdmVyO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRJT1NTZXNzaW9uIChjYXBzKSB7XG4gICAgbG9nZ2VyLmluZm8oXCJTdGFydGluZyBhbiBJT1MgcHJveHkgc2Vzc2lvblwiKTtcbiAgICB0aGlzLnByb3h5QWxsb3dMaXN0ID0gVE9fUFJPWFlfSU9TO1xuXG4gICAgdGhpcy5wcm94eWRyaXZlciA9IGF3YWl0IHRoaXMuc2V0dXBOZXdJT1NEcml2ZXIoY2Fwcyk7XG4gIH1cblxuICBhc3luYyBzZXR1cE5ld0FuZHJvaWREcml2ZXIgKGNhcHMpIHtcbiAgICBsZXQgYW5kcm9pZEFyZ3MgPSB7XG4gICAgICBqYXZhc2NyaXB0RW5hYmxlZDogdHJ1ZVxuICAgIH07XG4gICAgbGV0IGFuZHJvaWRkcml2ZXIgPSBuZXcgQW5kcm9pZERyaXZlcihhbmRyb2lkQXJncyk7XG4gICAgbGV0IGNhcHNDb3B5ID0gXy5jbG9uZURlZXAoY2Fwcyk7XG4gICAgLy8gRGlzYWJsaW5nIHRoZSBwcm94eSBDb21tYW5kVGltZW91dCBpbiB0aGUgQW5kcm9pZCBkcml2ZXIgc2luY2Ugd2UgYXJlIG5vdyBoYW5kbGluZyBpdCBpbiB0aGUgWW91aUVuZ2luZSBEcml2ZXJcbiAgICBjYXBzQ29weS5uZXdDb21tYW5kVGltZW91dCA9IDA7XG5cbiAgICBhd2FpdCBhbmRyb2lkZHJpdmVyLmNyZWF0ZVNlc3Npb24oY2Fwc0NvcHkpO1xuXG4gICAgcmV0dXJuIGFuZHJvaWRkcml2ZXI7XG4gIH1cblxuICBhc3luYyBzdGFydEFuZHJvaWRTZXNzaW9uIChjYXBzKSB7XG4gICAgbG9nZ2VyLmluZm8oXCJTdGFydGluZyBhbiBBbmRyb2lkIHByb3h5IHNlc3Npb25cIik7XG4gICAgdGhpcy5wcm94eUFsbG93TGlzdCA9IFRPX1BST1hZX0FORFJPSUQ7XG5cbiAgICB0aGlzLnByb3h5ZHJpdmVyID0gYXdhaXQgdGhpcy5zZXR1cE5ld0FuZHJvaWREcml2ZXIoY2Fwcyk7XG4gIH1cblxuICBhc3luYyBzZXR1cE5ld01hY0RyaXZlciAoY2Fwcykge1xuICAgIGxldCBtYWNBcmdzID0ge1xuICAgICAgamF2YXNjcmlwdEVuYWJsZWQ6IHRydWVcbiAgICB9O1xuICAgIGxldCBtYWNkcml2ZXIgPSBuZXcgTWFjRHJpdmVyKG1hY0FyZ3MpO1xuICAgIGxldCBjYXBzQ29weSA9IF8uY2xvbmVEZWVwKGNhcHMpO1xuICAgIC8vIERpc2FibGluZyB0aGUgcHJveHkgQ29tbWFuZFRpbWVvdXQgaW4gdGhlIHByb3hpZWQgZHJpdmVyIHNpbmNlIHdlIGFyZSBub3cgaGFuZGxpbmcgaXQgaW4gdGhlIFlvdWlFbmdpbmUgRHJpdmVyXG4gICAgY2Fwc0NvcHkubmV3Q29tbWFuZFRpbWVvdXQgPSAwO1xuXG4gICAgYXdhaXQgbWFjZHJpdmVyLmNyZWF0ZVNlc3Npb24oY2Fwc0NvcHkpO1xuXG4gICAgcmV0dXJuIG1hY2RyaXZlcjtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0TWFjU2Vzc2lvbiAoY2Fwcykge1xuICAgIGxvZ2dlci5pbmZvKFwiU3RhcnRpbmcgYSBNYWMgcHJveHkgc2Vzc2lvblwiKTtcbiAgICB0aGlzLnByb3h5QWxsb3dMaXN0ID0gVE9fUFJPWFlfTUFDO1xuXG4gICAgdGhpcy5wcm94eWRyaXZlciA9IGF3YWl0IHRoaXMuc2V0dXBOZXdNYWNEcml2ZXIoY2Fwcyk7XG4gIH1cblxuICB2YWxpZGF0ZUFwcExvY2F0aW9uIChhcHApIHtcbiAgICBjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG4gICAgY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoYXBwKSkge1xuICAgICAgbGV0IGFic29sdXRlcGF0aCA9IHBhdGgucmVzb2x2ZShhcHApO1xuICAgICAgbGV0IG1zZyA9ICdUaGUgYXBwIGNvdWxkIG5vdCBiZSBmb3VuZCBpbiBmb2xsb3dpbmcgbG9jYXRpb246ICcgKyBhYnNvbHV0ZXBhdGg7XG4gICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhtc2cpO1xuICAgIH1cbiAgfVxuXG4gIC8vIFNPQ0tFVFNcbiAgYXN5bmMgY29ubmVjdFNvY2tldCAoKSB7XG4gICAgbGV0IHJldHJ5Q291bnQgPSAwO1xuICAgIGxldCBjb25uZWN0ZWQgPSBmYWxzZTtcbiAgICB3aGlsZSAocmV0cnlDb3VudCA8IE1BWF9SRVRSWV9DT1VOVCAmJiAhY29ubmVjdGVkKSB7XG4gICAgICBpZiAocmV0cnlDb3VudCA+IDApIHtcbiAgICAgICAgbG9nZ2VyLmluZm8oXCJXYWl0aW5nIFwiICsgKFJFVFJZX0JBQ0tPRkYgLyAxMDAwKSArIFwiIHNlY29uZHMgYmVmb3JlIHRyeWluZy4uLlwiKTtcbiAgICAgICAgYXdhaXQgc2xlZXAoUkVUUllfQkFDS09GRik7XG4gICAgICB9XG4gICAgICBsb2dnZXIuaW5mbyhcIkF0dGVtcHQgI1wiICsgKHJldHJ5Q291bnQgKyAxKSk7XG5cbiAgICAgIGxldCBjb25uZWN0ZWRQcm9taXNlID0gbmV3IEIoKHJlc29sdmUpID0+IHtcbiAgICAgICAgbGV0IG5ldCA9IHJlcXVpcmUoJ25ldCcpO1xuXG4gICAgICAgIGxldCBIT1NUID0gdGhpcy5vcHRzLnlvdWlFbmdpbmVBcHBBZGRyZXNzO1xuICAgICAgICBsZXQgUE9SVCA9IDEyMzQ1O1xuXG4gICAgICAgIGxvZ2dlci5pbmZvKCdDb25uZWN0aW5nIHRvIFdlYkRyaXZlcjogJyArIEhPU1QgKyAnOicgKyBQT1JUKTtcblxuICAgICAgICB0aGlzLnNvY2tldCA9IG5ldyBuZXQuU29ja2V0KCk7XG5cbiAgICAgICAgLy8gQWRkIGFuICdlcnJvcicgZXZlbnQgaGFuZGxlciBmb3IgdGhlIGNsaWVudCBzb2NrZXRcbiAgICAgICAgdGhpcy5zb2NrZXQub24gKCdlcnJvcicsIGZ1bmN0aW9uIChleCkge1xuICAgICAgICAgIGxvZ2dlci5lcnJvcihleCk7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yKCdDaGVjayB0aGF0IFdlYkRyaXZlciBpcyBlbmFibGVkIGluIGFwcGxpY2F0aW9uLCBpZiBhIGRldmljZSBlbnN1cmUgdGhlIHByb3BlciBJUCBhZGRyZXNzIGlzIHVzZWQuJyk7XG4gICAgICAgICAgcmVzb2x2ZShmYWxzZSk7XG4gICAgICAgIH0pO1xuICAgICAgICAvLyBBZGQgYSAnY2xvc2UnIGV2ZW50IGhhbmRsZXIgZm9yIHRoZSBjbGllbnQgc29ja2V0XG4gICAgICAgIHRoaXMuc29ja2V0Lm9uICgnY2xvc2UnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgbG9nZ2VyLmluZm8oJ0Nvbm5lY3Rpb24gY2xvc2VkJyk7XG4gICAgICAgIH0pO1xuICAgICAgICAvLyBBZGQgYSAndGltZW91dCcgZXZlbnQgaGFuZGxlciBmb3IgdGhlIGNsaWVudCBzb2NrZXRcbiAgICAgICAgdGhpcy5zb2NrZXQub24gKCd0aW1lb3V0JywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGxvZ2dlci5lcnJvcignQ29ubmVjdGlvbiB0aW1lZCBvdXQnKTtcbiAgICAgICAgICByZXNvbHZlKGZhbHNlKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuc29ja2V0LmNvbm5lY3QgKFBPUlQsIEhPU1QsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBsb2dnZXIuaW5mbygnQ29ubmVjdGVkJyk7XG4gICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICAgIHJldHJ5Q291bnQrKztcbiAgICAgIGNvbm5lY3RlZCA9IGF3YWl0IGNvbm5lY3RlZFByb21pc2U7XG5cbiAgICAgIGlmICghY29ubmVjdGVkICYmIHJldHJ5Q291bnQgPT09IChNQVhfUkVUUllfQ09VTlQgLSAxKSkge1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhcIkZhaWxlZCB0byBjb25uZWN0IFwiICsgTUFYX1JFVFJZX0NPVU5UICsgXCIgdGltZXMuIEFib3J0aW5nLlwiKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0cnlDb3VudCA9IDA7XG4gICAgdGhpcy5yZWFkeSA9IGNvbm5lY3RlZDtcbiAgfVxuXG4gIC8vIHJlc3BvbnNlcyB0byB0aGUgY29tbWFuZHMgYXJlIEJJTkFSWVxuICBhc3luYyBleGVjdXRlU29ja2V0Q29tbWFuZCAoY21kKSB7XG5cbiAgICBpZiAoIXRoaXMuc29ja2V0LndyaXRhYmxlKSB7XG4gICAgICBsb2dnZXIuaW5mbyhcIlNvY2tldCBpcyBub3Qgd3JpdGFibGUuIFRyeWluZyB0byByZWNvbm5lY3QuXCIpO1xuICAgICAgYXdhaXQgdGhpcy5jb25uZWN0U29ja2V0KCk7XG4gICAgfVxuXG4gICAgbGV0IGNtZFByb21pc2UgPSBuZXcgQigocmVzb2x2ZSkgPT4ge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdDT01NQU5EOiAnICsgY21kKTtcblxuICAgICAgbGV0IHRvdGFsZGF0YSA9IFtdO1xuICAgICAgbGV0IGVuZE1hcmtlciA9IG5ldyBCdWZmZXIoXCJ5b3VpZW5kXCIpO1xuICAgICAgbGV0IHNvY2tldENsaWVudCA9IHRoaXMuc29ja2V0O1xuXG5cbiAgICAgIGxldCBkYXRhSGFuZGxlciA9IGZ1bmN0aW9uIChkYXRhKSB7XG5cbiAgICAgICAgLy8gZGV0ZXJtaW5lIGlmIHRoaXMgaW5jbHVkZXMgYW4gZW5kIHBhcmtlclxuICAgICAgICAvLyBnZXQgbGFzdCBmZXcgdmFsdWVzIG9mIGJ1ZmZlclxuICAgICAgICBpZiAoZGF0YS5sZW5ndGggPj0gZW5kTWFya2VyLmxlbmd0aCkge1xuICAgICAgICAgIGxldCBkYXRhZW5kID0gbmV3IEJ1ZmZlcihlbmRNYXJrZXIubGVuZ3RoKTtcbiAgICAgICAgICBsZXQgc3RhcnRJbmRleCA9IGRhdGEubGVuZ3RoIC0gZW5kTWFya2VyLmxlbmd0aDtcbiAgICAgICAgICBkYXRhLmNvcHkoZGF0YWVuZCwgMCwgc3RhcnRJbmRleCwgc3RhcnRJbmRleCArIGVuZE1hcmtlci5sZW5ndGgpO1xuICAgICAgICAgIC8vbG9nZ2VyLmRlYnVnKCdEQVRBRU5EJyArIGRhdGFlbmQudG9TdHJpbmcoKSk7XG4gICAgICAgICAgaWYgKGRhdGFlbmQuZXF1YWxzKGVuZE1hcmtlcikpIHtcbiAgICAgICAgICAgIC8vIHJlbW92ZSBkYXRhIGVuZFxuICAgICAgICAgICAgbGV0IGxhc3REYXRhID0gZGF0YS5zbGljZSgwLCBzdGFydEluZGV4KTtcbiAgICAgICAgICAgIC8vbG9nZ2VyLmRlYnVnKCdMQVNUIERBVEE6ICcgKyBsYXN0RGF0YS50b1N0cmluZygpKTtcbiAgICAgICAgICAgIHRvdGFsZGF0YS5wdXNoKGxhc3REYXRhKTtcblxuICAgICAgICAgICAgLy9yZW1vdmUgaGFuZGxlclxuICAgICAgICAgICAgc29ja2V0Q2xpZW50LnJlbW92ZUxpc3RlbmVyKCdkYXRhJywgZGF0YUhhbmRsZXIpO1xuXG4gICAgICAgICAgICAvLyByZXNvbHZlXG4gICAgICAgICAgICByZXNvbHZlKEJ1ZmZlci5jb25jYXQodG90YWxkYXRhKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRvdGFsZGF0YS5wdXNoKGRhdGEpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfTtcblxuICAgICAgc29ja2V0Q2xpZW50LndyaXRlKGNtZCArIFwiXFxuXCIsIFwiVVRGOFwiLCAoKSA9PiB7XG4gICAgICAgIHNvY2tldENsaWVudC5vbignZGF0YScsIGRhdGFIYW5kbGVyKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJldHVybiBhd2FpdCBjbWRQcm9taXNlO1xuICB9XG59XG5cbmZvciAobGV0IFtjbWQsIGZuXSBvZiBfLnRvUGFpcnMoY29tbWFuZHMpKSB7XG4gIFlvdWlFbmdpbmVEcml2ZXIucHJvdG90eXBlW2NtZF0gPSBmbjtcbn1cbmV4cG9ydCB7IFlvdWlFbmdpbmVEcml2ZXIgfTtcbiJdLCJmaWxlIjoibGliL2RyaXZlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
