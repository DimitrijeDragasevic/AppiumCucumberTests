"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _index = _interopRequireDefault(require("./commands/index"));

var _iosDeploy = _interopRequireDefault(require("./ios-deploy"));

var _asyncbox = require("asyncbox");

var _utils = require("./utils");

var _basedevice = _interopRequireDefault(require("./basedevice"));

class TvOs extends _basedevice.default {
  constructor() {
    super();
    let bundleId;
    let caps;
    let iosdeploy;
    let driver;
  }

  async execScript(script) {
    let shell = require('shelljs');

    script += ` --id ${this.caps.udid}`;

    _logger.default.info(`script: ${script}`);

    try {
      return await shell.exec(script);
    } catch (err) {
      _logger.default.debug(`Stdout: '${err.stdout}'. Stderr: '${err.stderr}'.`);

      throw new Error(`Could not run '${script}': '${err.message}'`);
      return false;
    }
  }

  async closeApp() {
    _logger.default.info(`tvOS: Close App`);

    let commandObject = {
      name: 'CloseApp'
    };
    let commandJSON = JSON.stringify(commandObject);
    let data = await this.driver.executeSocketCommand(commandJSON);
    let result;

    try {
      result = JSON.parse(data);
    } catch (e) {
      throw new Error("Bad response from CloseApp");
    }

    if (result.status === _utils.youiEngineDriverReturnValues.WEBDRIVER_UNKNOWN_COMMAND) {
      throw new Error("This command is only supported in You.i Engine v5.1.0+");
    }
  }

  async endSession() {
    _logger.default.info(`tvOS: End Session`);

    if (this.caps.fullReset) {
      await this.removeApp(this.bundleId);
    } else {
      await this.closeApp();
    }
  }

  async installApp(appPath) {
    _logger.default.info(`tvOS: Installing and launching app`);

    await this.iosdeploy.installApp(appPath);
  }

  async isAppInstalled(bundleId) {
    _logger.default.info(`tvOS: Check if App is installed`);

    return await this.iosdeploy.isAppInstalled(bundleId);
  }

  async launchApp() {
    _logger.default.info(`tvOS: Launching app`);

    await this.iosdeploy.launchApp(this.caps.app);
  }

  async removeApp(bundleId) {
    _logger.default.info(`Deleting app`);

    await this.iosdeploy.removeApp(bundleId);
  }

  async startSession(caps, driver) {
    _logger.default.info(`tvOS: Start Session`);

    this.caps = caps;
    this.driver = driver;
    this.iosdeploy = new _iosDeploy.default(caps.udid);
    await this.iosdeploy.checkStatus();

    let shell = require('shelljs');

    this.bundleId = await shell.exec(`osascript -e 'id of app "${caps.app}"'`).replace(/(\r\n|\n|\r)/gm, "");
    let devAppInstalled = await this.isAppInstalled(this.bundleId);

    if (caps.fullReset || !devAppInstalled) {
      await this.installApp(caps.app);
    } else {
      await this.launchApp();
    }
  }

}

var _default = TvOs;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90dm9zLmpzIl0sIm5hbWVzIjpbIlR2T3MiLCJCYXNlRGV2aWNlIiwiY29uc3RydWN0b3IiLCJidW5kbGVJZCIsImNhcHMiLCJpb3NkZXBsb3kiLCJkcml2ZXIiLCJleGVjU2NyaXB0Iiwic2NyaXB0Iiwic2hlbGwiLCJyZXF1aXJlIiwidWRpZCIsImxvZ2dlciIsImluZm8iLCJleGVjIiwiZXJyIiwiZGVidWciLCJzdGRvdXQiLCJzdGRlcnIiLCJFcnJvciIsIm1lc3NhZ2UiLCJjbG9zZUFwcCIsImNvbW1hbmRPYmplY3QiLCJuYW1lIiwiY29tbWFuZEpTT04iLCJKU09OIiwic3RyaW5naWZ5IiwiZGF0YSIsImV4ZWN1dGVTb2NrZXRDb21tYW5kIiwicmVzdWx0IiwicGFyc2UiLCJlIiwic3RhdHVzIiwieW91aUVuZ2luZURyaXZlclJldHVyblZhbHVlcyIsIldFQkRSSVZFUl9VTktOT1dOX0NPTU1BTkQiLCJlbmRTZXNzaW9uIiwiZnVsbFJlc2V0IiwicmVtb3ZlQXBwIiwiaW5zdGFsbEFwcCIsImFwcFBhdGgiLCJpc0FwcEluc3RhbGxlZCIsImxhdW5jaEFwcCIsImFwcCIsInN0YXJ0U2Vzc2lvbiIsIklPU0RlcGxveSIsImNoZWNrU3RhdHVzIiwicmVwbGFjZSIsImRldkFwcEluc3RhbGxlZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxJQUFOLFNBQW1CQyxtQkFBbkIsQ0FBOEI7QUFFNUJDLEVBQUFBLFdBQVcsR0FBSTtBQUNiO0FBQ0EsUUFBSUMsUUFBSjtBQUNBLFFBQUlDLElBQUo7QUFDQSxRQUFJQyxTQUFKO0FBQ0EsUUFBSUMsTUFBSjtBQUNEOztBQUVELFFBQU1DLFVBQU4sQ0FBa0JDLE1BQWxCLEVBQTBCO0FBQ3hCLFFBQUlDLEtBQUssR0FBR0MsT0FBTyxDQUFDLFNBQUQsQ0FBbkI7O0FBQ0FGLElBQUFBLE1BQU0sSUFBSyxTQUFRLEtBQUtKLElB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O0FBQ0EsU0FBS1AsUUFBTCxHQUFnQixNQUFNTSxLQUFLLENBQUNLLElBQU4sQ0FBWSw0QkFBMkJWLElBQUksQ0FBQ3NDLEdBQUksSUFBaEQsRUFBcURJLE9BQXJELENBQTZELGdCQUE3RCxFQUE4RSxFQUE5RSxDQUF0QjtBQUNBLFFBQUlDLGVBQWUsR0FBRyxNQUFNLEtBQUtQLGNBQUwsQ0FBb0IsS0FBS3JDLFFBQXpCLENBQTVCOztBQUNBLFFBQUlDLElBQUksQ0FBQ2dDLFNBQUwsSUFBa0IsQ0FBQ1csZUFBdkIsRUFBd0M7QUFDcEMsWUFBTSxLQUFLVCxVQUFMLENBQWdCbEMsSUFBSSxDQUFDc0MsR0FBckIsQ0FBTjtBQUVILEtBSEQsTUFHTztBQUNMLFlBQU0sS0FBS0QsU0FBTCxFQUFOO0FBQ0Q7QUFDRjs7QUEzRjJCOztlQThGZnpDLEkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBjb21tYW5kcyBmcm9tICcuL2NvbW1hbmRzL2luZGV4JztcbmltcG9ydCBJT1NEZXBsb3kgZnJvbSAnLi9pb3MtZGVwbG95JztcbmltcG9ydCB7IHNsZWVwIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgeW91aUVuZ2luZURyaXZlclJldHVyblZhbHVlcyB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IEJhc2VEZXZpY2UgZnJvbSAnLi9iYXNlZGV2aWNlJztcblxuY2xhc3MgVHZPcyBleHRlbmRzIEJhc2VEZXZpY2Uge1xuXG4gIGNvbnN0cnVjdG9yICgpIHtcbiAgICBzdXBlcigpO1xuICAgIGxldCBidW5kbGVJZDtcbiAgICBsZXQgY2FwcztcbiAgICBsZXQgaW9zZGVwbG95O1xuICAgIGxldCBkcml2ZXI7XG4gIH1cblxuICBhc3luYyBleGVjU2NyaXB0IChzY3JpcHQpIHtcbiAgICBsZXQgc2hlbGwgPSByZXF1aXJlKCdzaGVsbGpzJyk7XG4gICAgc2NyaXB0ICs9IGAgLS1pZCAke3RoaXMuY2Fwcy51ZGlkfWA7XG4gICAgbG9nZ2VyLmluZm8oYHNjcmlwdDogJHtzY3JpcHR9YCk7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCBzaGVsbC5leGVjKHNjcmlwdCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYFN0ZG91dDogJyR7ZXJyLnN0ZG91dH0nLiBTdGRlcnI6ICcke2Vyci5zdGRlcnJ9Jy5gKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IHJ1biAnJHtzY3JpcHR9JzogJyR7ZXJyLm1lc3NhZ2V9J2ApO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfTtcblxuICBhc3luYyBjbG9zZUFwcCAoKSB7XG4gICAgbG9nZ2VyLmluZm8oYHR2T1M6IENsb3NlIEFwcGApO1xuICAgIGxldCBjb21tYW5kT2JqZWN0ID0ge1xuICAgICAgbmFtZTogJ0Nsb3NlQXBwJ1xuICAgIH07XG4gICAgbGV0IGNvbW1hbmRKU09OID0gSlNPTi5zdHJpbmdpZnkoY29tbWFuZE9iamVjdCk7XG4gICAgbGV0IGRhdGEgPSBhd2FpdCB0aGlzLmRyaXZlci5leGVjdXRlU29ja2V0Q29tbWFuZChjb21tYW5kSlNPTik7XG4gICAgbGV0IHJlc3VsdDsgXG5cbiAgICB0cnkge1xuICAgICAgcmVzdWx0ID0gSlNPTi5wYXJzZShkYXRhKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJCYWQgcmVzcG9uc2UgZnJvbSBDbG9zZUFwcFwiKTtcbiAgICB9XG4gICAgLy8gZ2V0IHN0YXR1cyByZXR1cm5lZCBhbmQgaGFuZGxlIGVycm9ycyByZXR1cm5lZCBmcm9tIHNlcnZlclxuICAgIGlmIChyZXN1bHQuc3RhdHVzID09PSB5b3VpRW5naW5lRHJpdmVyUmV0dXJuVmFsdWVzLldFQkRSSVZFUl9VTktOT1dOX0NPTU1BTkQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlRoaXMgY29tbWFuZCBpcyBvbmx5IHN1cHBvcnRlZCBpbiBZb3UuaSBFbmdpbmUgdjUuMS4wK1wiKTtcbiAgICB9XG4gIH07XG5cbiAgYXN5bmMgZW5kU2Vzc2lvbiAoKSB7XG4gICAgbG9nZ2VyLmluZm8oYHR2T1M6IEVuZCBTZXNzaW9uYCk7XG4gICAgLy8gSWYgbXVsdGlwbGUgYXBwcyB3aXRoIG91ciBzb2NrZXQgYXJlIGluc3RhbGxlZCwgaXQgd2lsbCBjb25uZWN0IHRvIHRoZSBmaXJzdCBhcHAgaW5zdGFsbGVkLlxuICAgIC8vIEZvciB0aGlzIHJlYXNvbiwgZXZlcnkgYXBwIHNob3VsZCBiZSB1bmluc3RhbGxlZCBhZnRlciBydW5uaW5nLlxuICAgIGlmICh0aGlzLmNhcHMuZnVsbFJlc2V0KSB7XG4gICAgICBhd2FpdCB0aGlzLnJlbW92ZUFwcCh0aGlzLmJ1bmRsZUlkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgdGhpcy5jbG9zZUFwcCgpO1xuICAgIH1cbiAgfTtcblxuICBhc3luYyBpbnN0YWxsQXBwIChhcHBQYXRoKSB7XG4gICAgbG9nZ2VyLmluZm8oYHR2T1M6IEluc3RhbGxpbmcgYW5kIGxhdW5jaGluZyBhcHBgKTtcbiAgICBhd2FpdCB0aGlzLmlvc2RlcGxveS5pbnN0YWxsQXBwKGFwcFBhdGgpO1xuICB9O1xuXG4gIGFzeW5jIGlzQXBwSW5zdGFsbGVkIChidW5kbGVJZCkge1xuICAgIGxvZ2dlci5pbmZvKGB0dk9TOiBDaGVjayBpZiBBcHAgaXMgaW5zdGFsbGVkYCk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuaW9zZGVwbG95LmlzQXBwSW5zdGFsbGVkKGJ1bmRsZUlkKTtcbiAgfTtcblxuICBhc3luYyBsYXVuY2hBcHAgKCkge1xuICAgIGxvZ2dlci5pbmZvKGB0dk9TOiBMYXVuY2hpbmcgYXBwYCk7XG4gICAgYXdhaXQgdGhpcy5pb3NkZXBsb3kubGF1bmNoQXBwKHRoaXMuY2Fwcy5hcHApO1xuICB9O1xuXG4gIGFzeW5jIHJlbW92ZUFwcCAoYnVuZGxlSWQpIHtcbiAgICBsb2dnZXIuaW5mbyhgRGVsZXRpbmcgYXBwYCk7XG4gICAgYXdhaXQgdGhpcy5pb3NkZXBsb3kucmVtb3ZlQXBwKGJ1bmRsZUlkKVxuICB9O1xuXG4gIGFzeW5jIHN0YXJ0U2Vzc2lvbiAoY2FwcywgZHJpdmVyKSB7XG4gICAgbG9nZ2VyLmluZm8oYHR2T1M6IFN0YXJ0IFNlc3Npb25gKTtcbiAgICB0aGlzLmNhcHMgPSBjYXBzO1xuICAgIHRoaXMuZHJpdmVyID0gZHJpdmVyO1xuICAgIHRoaXMuaW9zZGVwbG95ID0gbmV3IElPU0RlcGxveShjYXBzLnVkaWQpO1xuICAgIGF3YWl0IHRoaXMuaW9zZGVwbG95LmNoZWNrU3RhdHVzKCk7XG5cbiAgICAvLyBDaGVjayBpZiBhcHAgaXMgaW5zdGFsbGVkXG4gICAgbGV0IHNoZWxsID0gcmVxdWlyZSgnc2hlbGxqcycpO1xuICAgIHRoaXMuYnVuZGxlSWQgPSBhd2FpdCBzaGVsbC5leGVjKGBvc2FzY3JpcHQgLWUgJ2lkIG9mIGFwcCBcIiR7Y2Fwcy5hcHB9XCInYCkucmVwbGFjZSgvKFxcclxcbnxcXG58XFxyKS9nbSxcIlwiKTtcbiAgICBsZXQgZGV2QXBwSW5zdGFsbGVkID0gYXdhaXQgdGhpcy5pc0FwcEluc3RhbGxlZCh0aGlzLmJ1bmRsZUlkKTtcbiAgICBpZiAoY2Fwcy5mdWxsUmVzZXQgfHwgIWRldkFwcEluc3RhbGxlZCkge1xuICAgICAgICBhd2FpdCB0aGlzLmluc3RhbGxBcHAoY2Fwcy5hcHApO1xuICAgICAgICAvL2F3YWl0IHRoaXMubGF1bmNoQXBwKGNhcHMuYXBwKTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgdGhpcy5sYXVuY2hBcHAoKTtcbiAgICB9XG4gIH07XG5cbn1cbmV4cG9ydCBkZWZhdWx0IFR2T3M7XG4iXSwiZmlsZSI6ImxpYi90dm9zLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
