"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _lodash = _interopRequireDefault(require("lodash"));

var _url = _interopRequireDefault(require("url"));

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _appiumIosSimulator = require("appium-ios-simulator");

var _server = require("../server");

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;

commands.execute = async function (script, args) {
  if (script.match(/^mobile:/)) {
    script = script.replace(/^mobile:/, '').trim();
    return await this.executeMobile(script, _lodash.default.isArray(args) ? args[0] : args);
  } else {
    if (this.isWebContext()) {
      args = this.convertElementsForAtoms(args);
      return await this.executeAtom('execute_script', [script, args]);
    } else {
      return await this.uiAutoClient.sendCommand(script);
    }
  }
};

commands.executeAsync = async function (script, args, sessionId) {
  if (!this.isWebContext()) {
    return await this.uiAutoClient.sendCommand(script);
  }

  let address = this.opts.callbackAddress || this.opts.address;
  let port = this.opts.callbackPort || this.opts.port;
  sessionId = sessionId || this.sessionId;
  let protocol = 'http:';

  try {
    let currentUrl = _url.default.parse((await this.getUrl()));

    if (currentUrl.protocol === 'https:' && this.opts.httpsCallbackPort && this.opts.httpsCallbackAddress) {
      protocol = currentUrl.protocol;
      port = this.opts.httpsCallbackPort;
      address = this.opts.httpsCallbackAddress;
    }
  } catch (ign) {}

  let responseUrl = `${protocol}//${address}:${port}/wd/hub/session/${sessionId}/receive_async_response`;

  if (this.isRealDevice()) {
    let defaultHost = this.opts.address;

    let urlObject = _url.default.parse(responseUrl);

    if (urlObject.hostname === defaultHost) {
      _logger.default.debug('Real device safari test and no custom callback address ' + 'set, changing callback address to local ip.');

      urlObject.hostname = _appiumSupport.util.localIp();
      urlObject.host = null;
      responseUrl = _url.default.format(urlObject);
    } else {
      _logger.default.debug('Custom callback address set, leaving as is.');
    }
  }

  _logger.default.debug(`Response url for executeAsync: ${responseUrl}`);

  args = this.convertElementsForAtoms(args);
  this.asyncWaitMs = this.asyncWaitMs || 0;
  return await this.executeAtomAsync('execute_async_script', [script, args, this.asyncWaitMs], responseUrl);
};

commands.receiveAsyncResponse = async function (status, value) {
  _logger.default.debug(`Received async response: ${JSON.stringify(value)}`);

  if (!_appiumSupport.util.hasValue(this.asyncPromise)) {
    _logger.default.warn(`Received async response when we were not expecting one! ` + `Response was: ${JSON.stringify(value)}`);

    return;
  }

  if (_appiumSupport.util.hasValue(status) && status !== 0) {
    return this.asyncPromise.reject((0, _appiumBaseDriver.errorFromCode)(status, value.message));
  }

  if (!_appiumSupport.util.hasValue(status) && value && _lodash.default.isString(value.error)) {
    return this.asyncPromise.reject((0, _appiumBaseDriver.errorFromW3CJsonCode)(value.error, value.message, value.stacktrace));
  }

  return this.asyncPromise.resolve(value);
};

helpers.startHttpsAsyncServer = async function () {
  _logger.default.debug('Starting https server for async responses');

  let address = this.opts.callbackAddress || this.opts.address;
  let port = this.opts.callbackPort || this.opts.port;
  let {
    sslServer,
    pemCertificate,
    httpsPort
  } = await (0, _server.startHttpsServer)(port, address);
  this.opts.sslServer = sslServer;
  this.opts.httpsServerCertificate = pemCertificate;
  this.opts.httpsCallbackPort = httpsPort;
  this.opts.httpsCallbackAddress = 'localhost';
  let udid;

  if (this.sim) {
    udid = this.sim.udid;
  } else {
    udid = this.opts.udid;
  }

  await (0, _appiumIosSimulator.installSSLCert)(this.opts.httpsServerCertificate, udid);
};

helpers.stopHttpsAsyncServer = async function () {
  _logger.default.debug('Stopping https server for async responses');

  if (this.opts.sslServer) {
    await this.opts.sslServer.close();
  }

  await (0, _appiumIosSimulator.uninstallSSLCert)(this.opts.httpsServerCertificate, this.opts.udid);
};

commands.executeMobile = async function (mobileCommand, opts = {}) {
  if (mobileCommand === 'scroll') {
    await this.mobileScroll(opts);
  } else if (mobileCommand === 'viewportScreenshot') {
    return await this.getViewportScreenshot();
  } else {
    throw new _appiumBaseDriver.errors.UnknownCommandError('Unknown command, all the mobile commands except scroll have been removed.');
  }
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9leGVjdXRlLmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJleGVjdXRlIiwic2NyaXB0IiwiYXJncyIsIm1hdGNoIiwicmVwbGFjZSIsInRyaW0iLCJleGVjdXRlTW9iaWxlIiwiXyIsImlzQXJyYXkiLCJpc1dlYkNvbnRleHQiLCJjb252ZXJ0RWxlbWVudHNGb3JBdG9tcyIsImV4ZWN1dGVBdG9tIiwidWlBdXRvQ2xpZW50Iiwic2VuZENvbW1hbmQiLCJleGVjdXRlQXN5bmMiLCJzZXNzaW9uSWQiLCJhZGRyZXNzIiwib3B0cyIsImNhbGxiYWNrQWRkcmVzcyIsInBvcnQiLCJjYWxsYmFja1BvcnQiLCJwcm90b2NvbCIsImN1cnJlbnRVcmwiLCJ1cmwiLCJwYXJzZSIsImdldFVybCIsImh0dHBzQ2FsbGJhY2tQb3J0IiwiaHR0cHNDYWxsYmFja0FkZHJlc3MiLCJpZ24iLCJyZXNwb25zZVVybCIsImlzUmVhbERldmljZSIsImRlZmF1bHRIb3N0IiwidXJsT2JqZWN0IiwiaG9zdG5hbWUiLCJsb2dnZXIiLCJkZWJ1ZyIsInV0aWwiLCJsb2NhbElwIiwiaG9zdCIsImZvcm1hdCIsImFzeW5jV2FpdE1zIiwiZXhlY3V0ZUF0b21Bc3luYyIsInJlY2VpdmVBc3luY1Jlc3BvbnNlIiwic3RhdHVzIiwidmFsdWUiLCJKU09OIiwic3RyaW5naWZ5IiwiaGFzVmFsdWUiLCJhc3luY1Byb21pc2UiLCJ3YXJuIiwicmVqZWN0IiwibWVzc2FnZSIsImlzU3RyaW5nIiwiZXJyb3IiLCJzdGFja3RyYWNlIiwicmVzb2x2ZSIsInN0YXJ0SHR0cHNBc3luY1NlcnZlciIsInNzbFNlcnZlciIsInBlbUNlcnRpZmljYXRlIiwiaHR0cHNQb3J0IiwiaHR0cHNTZXJ2ZXJDZXJ0aWZpY2F0ZSIsInVkaWQiLCJzaW0iLCJzdG9wSHR0cHNBc3luY1NlcnZlciIsImNsb3NlIiwibW9iaWxlQ29tbWFuZCIsIm1vYmlsZVNjcm9sbCIsImdldFZpZXdwb3J0U2NyZWVuc2hvdCIsImVycm9ycyIsIlVua25vd25Db21tYW5kRXJyb3IiLCJPYmplY3QiLCJhc3NpZ24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsSUFBSUEsUUFBUSxHQUFHLEVBQWY7QUFBQSxJQUFtQkMsT0FBTyxHQUFHLEVBQTdCO0FBQUEsSUFBaUNDLFVBQVUsR0FBRyxFQUE5Qzs7OztBQUVBRixRQUFRLENBQUNHLE9BQVQsR0FBbUIsZ0JBQWdCQyxNQUFoQixFQUF3QkMsSUFBeEIsRUFBOEI7QUFDL0MsTUFBSUQsTUFBTSxDQUFDRSxLQUFQLENBQWEsVUFBYixDQUFKLEVBQThCO0FBQzVCRixJQUFBQSxNQUFNLEdBQUdBLE1BQU0sQ0FBQ0csT0FBUCxDQUFlLFVBQWYsRUFBMkIsRUFBM0IsRUFBK0JDLElBQS9CLEVBQVQ7QUFDQSxXQUFPLE1BQU0sS0FBS0MsYUFBTCxDQUFtQkwsTUFBbkIsRUFBMkJNLGdCQUFFQyxPQUFGLENBQVVOLElBQVYsSUFBa0JBLElBQUksQ0FBQyxDQUFELENBQXRCLEdBQTRCQSxJQUF2RCxDQUFiO0FBQ0QsR0FIRCxNQUdPO0FBQ0wsUUFBSSxLQUFLTyxZQUFMLEVBQUosRUFBeUI7QUFDdkJQLE1BQUFBLElBQUksR0FBRyxLQUFLUSx1QkFBTCxDQUE2QlIsSUFBN0IsQ0FBUDtBQUNBLGFBQU8sTUFBTSxLQUFLUyxXQUFMLENBQWlCLGdCQUFqQixFQUFtQyxDQUFDVixNQUFELEVBQVNDLElBQVQsQ0FBbkMsQ0FBYjtBQUNELEtBSEQsTUFHTztBQUNMLGFBQU8sTUFBTSxLQUFLVSxZQUFMLENBQWtCQyxXQUFsQixDQUE4QlosTUFBOUIsQ0FBYjtBQUNEO0FBQ0Y7QUFDRixDQVpEOztBQWNBSixRQUFRLENBQUNpQixZQUFULEdBQXdCLGdCQUFnQmIsTUFBaEIsRUFBd0JDLElBQXhCLEVBQThCYSxTQUE5QixFQUF5QztBQUMvRCxNQUFJLENBQUMsS0FB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RVpELElBQUFBLElBQUksR0FBRyxLQUFLQyxHQUFMLENBQVNELElBQWhCO0FBQ0QsR0FIRCxNQUdPO0FBRUxBLElBQUFBLElBQUksR0FBRyxLQUFLNUMsSUFBTCxDQUFVNEMsSUFBakI7QUFDRDs7QUFDRCxRQUFNLHdDQUFlLEtBQUs1QyxJQUFMLENBQVUyQyxzQkFBekIsRUFBaURDLElBQWpELENBQU47QUFDRCxDQWxCRDs7QUFvQkEvRCxPQUFPLENBQUNpRSxvQkFBUixHQUErQixrQkFBa0I7QUFDL0M3QixrQkFBT0MsS0FBUCxDQUFhLDJDQUFiOztBQUNBLE1BQUksS0FBS2xCLElBQUwsQ0FBVXdDLFNBQWQsRUFBeUI7QUFDdkIsVUFBTSxLQUFLeEMsSUFBTCxDQUFVd0MsU0FBVixDQUFvQk8sS0FBcEIsRUFBTjtBQUNEOztBQUNELFFBQU0sMENBQWlCLEtBQUsvQyxJQUFMLENBQVUyQyxzQkFBM0IsRUFBbUQsS0FBSzNDLElBQUwsQ0FBVTRDLElBQTdELENBQU47QUFDRCxDQU5EOztBQVFBaEUsUUFBUSxDQUFDUyxhQUFULEdBQXlCLGdCQUFnQjJELGFBQWhCLEVBQStCaEQsSUFBSSxHQUFHLEVBQXRDLEVBQTBDO0FBRWpFLE1BQUlnRCxhQUFhLEtBQUssUUFBdEIsRUFBZ0M7QUFDOUIsVUFBTSxLQUFLQyxZQUFMLENBQWtCakQsSUFBbEIsQ0FBTjtBQUNELEdBRkQsTUFFTyxJQUFJZ0QsYUFBYSxLQUFLLG9CQUF0QixFQUE0QztBQUNqRCxXQUFPLE1BQU0sS0FBS0UscUJBQUwsRUFBYjtBQUNELEdBRk0sTUFFQTtBQUNMLFVBQU0sSUFBSUMseUJBQU9DLG1CQUFYLENBQStCLDJFQUEvQixDQUFOO0FBQ0Q7QUFDRixDQVREOztBQVdBQyxNQUFNLENBQUNDLE1BQVAsQ0FBY3hFLFVBQWQsRUFBMEJGLFFBQTFCLEVBQW9DQyxPQUFwQztlQUVlQyxVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXJyb3JzLCBlcnJvckZyb21Db2RlLCBlcnJvckZyb21XM0NKc29uQ29kZSB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHVybCBmcm9tICd1cmwnO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGluc3RhbGxTU0xDZXJ0LCB1bmluc3RhbGxTU0xDZXJ0IH0gZnJvbSAnYXBwaXVtLWlvcy1zaW11bGF0b3InO1xuaW1wb3J0IHsgc3RhcnRIdHRwc1NlcnZlciB9IGZyb20gJy4uL3NlcnZlcic7XG5cblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb21tYW5kcy5leGVjdXRlID0gYXN5bmMgZnVuY3Rpb24gKHNjcmlwdCwgYXJncykge1xuICBpZiAoc2NyaXB0Lm1hdGNoKC9ebW9iaWxlOi8pKSB7XG4gICAgc2NyaXB0ID0gc2NyaXB0LnJlcGxhY2UoL15tb2JpbGU6LywgJycpLnRyaW0oKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlTW9iaWxlKHNjcmlwdCwgXy5pc0FycmF5KGFyZ3MpID8gYXJnc1swXSA6IGFyZ3MpO1xuICB9IGVsc2Uge1xuICAgIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgICBhcmdzID0gdGhpcy5jb252ZXJ0RWxlbWVudHNGb3JBdG9tcyhhcmdzKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdleGVjdXRlX3NjcmlwdCcsIFtzY3JpcHQsIGFyZ3NdKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKHNjcmlwdCk7XG4gICAgfVxuICB9XG59O1xuXG5jb21tYW5kcy5leGVjdXRlQXN5bmMgPSBhc3luYyBmdW5jdGlvbiAoc2NyaXB0LCBhcmdzLCBzZXNzaW9uSWQpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKHNjcmlwdCk7XG4gIH1cblxuICBsZXQgYWRkcmVzcyA9IHRoaXMub3B0cy5jYWxsYmFja0FkZHJlc3MgfHwgdGhpcy5vcHRzLmFkZHJlc3M7XG4gIGxldCBwb3J0ID0gdGhpcy5vcHRzLmNhbGxiYWNrUG9ydCB8fCB0aGlzLm9wdHMucG9ydDtcbiAgc2Vzc2lvbklkID0gc2Vzc2lvbklkIHx8IHRoaXMuc2Vzc2lvbklkO1xuXG4gIC8vIGh0dHBzIHNpdGVzIG5lZWQgdG8gcmVwbHkgdG8gYW4gaHR0cHMgZW5kcG9pbnQsIGluIFNhZmFyaVxuICBsZXQgcHJvdG9jb2wgPSAnaHR0cDonO1xuICB0cnkge1xuICAgIGxldCBjdXJyZW50VXJsID0gdXJsLnBhcnNlKGF3YWl0IHRoaXMuZ2V0VXJsKCkpO1xuICAgIGlmIChjdXJyZW50VXJsLnByb3RvY29sID09PSAnaHR0cHM6JyAmJiB0aGlzLm9wdHMuaHR0cHNDYWxsYmFja1BvcnQgJiYgdGhpcy5vcHRzLmh0dHBzQ2FsbGJhY2tBZGRyZXNzKSB7XG4gICAgICBwcm90b2NvbCA9IGN1cnJlbnRVcmwucHJvdG9jb2w7XG4gICAgICBwb3J0ID0gdGhpcy5vcHRzLmh0dHBzQ2FsbGJhY2tQb3J0O1xuICAgICAgYWRkcmVzcyA9IHRoaXMub3B0cy5odHRwc0NhbGxiYWNrQWRkcmVzcztcbiAgICB9XG4gIH0gY2F0Y2ggKGlnbikge31cbiAgbGV0IHJlc3BvbnNlVXJsID0gYCR7cHJvdG9jb2x9Ly8ke2FkZHJlc3N9OiR7cG9ydH0vd2QvaHViL3Nlc3Npb24vJHtzZXNzaW9uSWR9L3JlY2VpdmVfYXN5bmNfcmVzcG9uc2VgO1xuXG4gIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgbGV0IGRlZmF1bHRIb3N0ID0gdGhpcy5vcHRzLmFkZHJlc3M7XG4gICAgbGV0IHVybE9iamVjdCA9IHVybC5wYXJzZShyZXNwb25zZVVybCk7XG4gICAgaWYgKHVybE9iamVjdC5ob3N0bmFtZSA9PT0gZGVmYXVsdEhvc3QpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZygnUmVhbCBkZXZpY2Ugc2FmYXJpIHRlc3QgYW5kIG5vIGN1c3RvbSBjYWxsYmFjayBhZGRyZXNzICcgK1xuICAgICAgICAgICAgICAgICAgICdzZXQsIGNoYW5naW5nIGNhbGxiYWNrIGFkZHJlc3MgdG8gbG9jYWwgaXAuJyk7XG4gICAgICB1cmxPYmplY3QuaG9zdG5hbWUgPSB1dGlsLmxvY2FsSXAoKTtcbiAgICAgIHVybE9iamVjdC5ob3N0ID0gbnVsbDsgLy8gc2V0IHRvIG51bGwsIG90aGVyd2lzZSBob3N0bmFtZSBpcyBpZ25vcmVkXG4gICAgICByZXNwb25zZVVybCA9IHVybC5mb3JtYXQodXJsT2JqZWN0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdDdXN0b20gY2FsbGJhY2sgYWRkcmVzcyBzZXQsIGxlYXZpbmcgYXMgaXMuJyk7XG4gICAgfVxuICB9XG5cbiAgbG9nZ2VyLmRlYnVnKGBSZXNwb25zZSB1cmwgZm9yIGV4ZWN1dGVBc3luYzogJHtyZXNwb25zZVVybH1gKTtcbiAgYXJncyA9IHRoaXMuY29udmVydEVsZW1lbnRzRm9yQXRvbXMoYXJncyk7XG4gIHRoaXMuYXN5bmNXYWl0TXMgPSB0aGlzLmFzeW5jV2FpdE1zIHx8IDA7XG4gIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tQXN5bmMoJ2V4ZWN1dGVfYXN5bmNfc2NyaXB0JywgW3NjcmlwdCwgYXJncywgdGhpcy5hc3luY1dhaXRNc10sIHJlc3BvbnNlVXJsKTtcbn07XG5cbmNvbW1hbmRzLnJlY2VpdmVBc3luY1Jlc3BvbnNlID0gYXN5bmMgZnVuY3Rpb24gKHN0YXR1cywgdmFsdWUpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gIGxvZ2dlci5kZWJ1ZyhgUmVjZWl2ZWQgYXN5bmMgcmVzcG9uc2U6ICR7SlNPTi5zdHJpbmdpZnkodmFsdWUpfWApO1xuICBpZiAoIXV0aWwuaGFzVmFsdWUodGhpcy5hc3luY1Byb21pc2UpKSB7XG4gICAgbG9nZ2VyLndhcm4oYFJlY2VpdmVkIGFzeW5jIHJlc3BvbnNlIHdoZW4gd2Ugd2VyZSBub3QgZXhwZWN0aW5nIG9uZSEgYCArXG4gICAgICBgUmVzcG9uc2Ugd2FzOiAke0pTT04uc3RyaW5naWZ5KHZhbHVlKX1gKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAodXRpbC5oYXNWYWx1ZShzdGF0dXMpICYmIHN0YXR1cyAhPT0gMCkge1xuICAgIC8vIE1KU09OV1BcbiAgICByZXR1cm4gdGhpcy5hc3luY1Byb21pc2UucmVqZWN0KGVycm9yRnJvbUNvZGUoc3RhdHVzLCB2YWx1ZS5tZXNzYWdlKSk7XG4gIH1cbiAgaWYgKCF1dGlsLmhhc1ZhbHVlKHN0YXR1cykgJiYgdmFsdWUgJiYgXy5pc1N0cmluZyh2YWx1ZS5lcnJvcikpIHtcbiAgICAvLyBXM0NcbiAgICByZXR1cm4gdGhpcy5hc3luY1Byb21pc2UucmVqZWN0KGVycm9yRnJvbVczQ0pzb25Db2RlKHZhbHVlLmVycm9yLCB2YWx1ZS5tZXNzYWdlLCB2YWx1ZS5zdGFja3RyYWNlKSk7XG4gIH1cbiAgcmV0dXJuIHRoaXMuYXN5bmNQcm9taXNlLnJlc29sdmUodmFsdWUpO1xufTtcblxuaGVscGVycy5zdGFydEh0dHBzQXN5bmNTZXJ2ZXIgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxvZ2dlci5kZWJ1ZygnU3RhcnRpbmcgaHR0cHMgc2VydmVyIGZvciBhc3luYyByZXNwb25zZXMnKTtcbiAgbGV0IGFkZHJlc3MgPSB0aGlzLm9wdHMuY2FsbGJhY2tBZGRyZXNzIHx8IHRoaXMub3B0cy5hZGRyZXNzO1xuICBsZXQgcG9ydCA9IHRoaXMub3B0cy5jYWxsYmFja1BvcnQgfHwgdGhpcy5vcHRzLnBvcnQ7XG4gIGxldCB7c3NsU2VydmVyLCBwZW1DZXJ0aWZpY2F0ZSwgaHR0cHNQb3J0fSA9IGF3YWl0IHN0YXJ0SHR0cHNTZXJ2ZXIocG9ydCwgYWRkcmVzcyk7XG4gIHRoaXMub3B0cy5zc2xTZXJ2ZXIgPSBzc2xTZXJ2ZXI7XG4gIHRoaXMub3B0cy5odHRwc1NlcnZlckNlcnRpZmljYXRlID0gcGVtQ2VydGlmaWNhdGU7XG4gIHRoaXMub3B0cy5odHRwc0NhbGxiYWNrUG9ydCA9IGh0dHBzUG9ydDtcbiAgdGhpcy5vcHRzLmh0dHBzQ2FsbGJhY2tBZGRyZXNzID0gJ2xvY2FsaG9zdCc7XG4gIGxldCB1ZGlkO1xuICBpZiAodGhpcy5zaW0pIHtcbiAgICAvLyBpb3MgZHJpdmVyXG4gICAgdWRpZCA9IHRoaXMuc2ltLnVkaWQ7XG4gIH0gZWxzZSB7XG4gICAgLy8geGN1aXRlc3QgZHJpdmVyXG4gICAgdWRpZCA9IHRoaXMub3B0cy51ZGlkO1xuICB9XG4gIGF3YWl0IGluc3RhbGxTU0xDZXJ0KHRoaXMub3B0cy5odHRwc1NlcnZlckNlcnRpZmljYXRlLCB1ZGlkKTtcbn07XG5cbmhlbHBlcnMuc3RvcEh0dHBzQXN5bmNTZXJ2ZXIgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxvZ2dlci5kZWJ1ZygnU3RvcHBpbmcgaHR0cHMgc2VydmVyIGZvciBhc3luYyByZXNwb25zZXMnKTtcbiAgaWYgKHRoaXMub3B0cy5zc2xTZXJ2ZXIpIHtcbiAgICBhd2FpdCB0aGlzLm9wdHMuc3NsU2VydmVyLmNsb3NlKCk7XG4gIH1cbiAgYXdhaXQgdW5pbnN0YWxsU1NMQ2VydCh0aGlzLm9wdHMuaHR0cHNTZXJ2ZXJDZXJ0aWZpY2F0ZSwgdGhpcy5vcHRzLnVkaWQpO1xufTtcblxuY29tbWFuZHMuZXhlY3V0ZU1vYmlsZSA9IGFzeW5jIGZ1bmN0aW9uIChtb2JpbGVDb21tYW5kLCBvcHRzID0ge30pIHtcbiAgLy8gd2Ugb25seSBzdXBwb3J0IG1vYmlsZTogc2Nyb2xsXG4gIGlmIChtb2JpbGVDb21tYW5kID09PSAnc2Nyb2xsJykge1xuICAgIGF3YWl0IHRoaXMubW9iaWxlU2Nyb2xsKG9wdHMpO1xuICB9IGVsc2UgaWYgKG1vYmlsZUNvbW1hbmQgPT09ICd2aWV3cG9ydFNjcmVlbnNob3QnKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0Vmlld3BvcnRTY3JlZW5zaG90KCk7XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duQ29tbWFuZEVycm9yKCdVbmtub3duIGNvbW1hbmQsIGFsbCB0aGUgbW9iaWxlIGNvbW1hbmRzIGV4Y2VwdCBzY3JvbGwgaGF2ZSBiZWVuIHJlbW92ZWQuJyk7XG4gIH1cbn07XG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMsIGhlbHBlcnMpO1xuZXhwb3J0IHsgY29tbWFuZHMsIGhlbHBlcnMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9leGVjdXRlLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
