"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _lodash = _interopRequireDefault(require("lodash"));

var _js2xmlparser = _interopRequireDefault(require("js2xmlparser2"));

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var utils = _interopRequireWildcard(require("../utils"));

var _nodeSimctl = require("node-simctl");

var _moment = _interopRequireDefault(require("moment"));

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;
const MOMENT_FORMAT_ISO8601 = 'YYYY-MM-DDTHH:mm:ssZ';

commands.active = async function () {
  if (this.isWebContext()) {
    return await this.executeAtom('active_element', []);
  } else {
    return await this.uiAutoClient.sendCommand("au.getActiveElement()");
  }
};

commands.getDeviceTime = async function (format = MOMENT_FORMAT_ISO8601) {
  _logger.default.info('Attempting to capture iOS device date and time');

  let cmd;
  let args;
  let inputFormat;

  if (this.isRealDevice()) {
    try {
      cmd = await _appiumSupport.fs.which('idevicedate');
    } catch (err) {
      _logger.default.errorAndThrow('Could not capture device date and time using libimobiledevice idevicedate. ' + 'Libimobiledevice is probably not installed');
    }

    _logger.default.info(`Found idevicedate: '${cmd}'`);

    args = ['-u', this.opts.udid];
    inputFormat = 'ddd MMM DD HH:mm:ss z YYYY';
  } else {
    _logger.default.warn('On simulator. Assuming device time is the same as host time');

    cmd = 'date';
    args = ['+%Y-%m-%dT%H:%M:%S%z'];
    inputFormat = MOMENT_FORMAT_ISO8601;
  }

  const stdout = (await (0, _teen_process.exec)(cmd, args)).stdout.trim();

  _logger.default.debug(`Got the following output out of '${cmd} ${args.join(' ')}': ${stdout}`);

  const parsedTimestamp = (0, _moment.default)(stdout, inputFormat);

  if (!parsedTimestamp.isValid()) {
    _logger.default.warn(`Cannot parse the timestamp '${stdout}' returned by '${cmd}' command. Returning it as is`);

    return stdout;
  }

  return parsedTimestamp.format(format);
};

commands.hideKeyboard = async function (strategy, ...possibleKeys) {
  possibleKeys.pop();
  let cmd;

  let key = _lodash.default.find(possibleKeys, k => {
    return k;
  });

  if (key) {
    strategy = strategy || 'pressKey';
    cmd = `au.hideKeyboard('${strategy}', '${key}')`;
  } else {
    strategy = strategy || 'default';
    cmd = `au.hideKeyboard('${strategy}')`;
  }

  await this.uiAutoClient.sendCommand(cmd);
};

commands.getPageSource = async function () {
  if (this.isWebContext()) {
    const script = 'return document.documentElement.outerHTML';
    return await this.executeAtom('execute_script', [script, []]);
  } else {
    return await this.getNativePageSource();
  }
};

helpers.getNativePageSource = async function () {
  let jsonSource = await this.getSourceForElementForXML();

  if (typeof jsonSource === "string") {
    jsonSource = JSON.parse(jsonSource);
  }

  let xmlSource = (0, _js2xmlparser.default)("AppiumAUT", jsonSource, {
    wrapArray: {
      enabled: false,
      elementName: "element"
    },
    declaration: {
      include: true
    },
    prettyPrinting: {
      indentString: "    "
    }
  });
  return xmlSource;
};

commands.background = async function (secs) {
  await this.uiAutoClient.sendCommand(`au.background(${secs})`);
};

commands.lock = async function (secs) {
  if (!secs) {
    _logger.default.debug('No seconds parameter. Using 0 seconds');

    secs = 0;
  }

  await this.uiAutoClient.sendCommand(`au.lock(${secs})`);
};

commands.closeApp = async function () {
  let appName = this.opts.app || this.opts.bundleId;

  try {
    await this.stop();

    _logger.default.info(`Successfully closed the '${appName}' app.`);
  } catch (err) {
    _logger.default.warn(`Something went wrong while closing the '${appName}' app.`);

    throw err;
  }
};

commands.launchApp = async function () {
  let appName = this.opts.app || this.opts.bundleId;

  try {
    await this.start();

    _logger.default.info(`Successfully launched the '${appName}' app.`);
  } catch (err) {
    _logger.default.warn(`Something went wrong while launching the '${appName}' app.`);

    throw err;
  }
};

commands.removeApp = async function (bundleId) {
  if (this.isRealDevice()) {
    await this.realDevice.remove(bundleId);
  } else {
    await this.sim.removeApp(bundleId);
  }
};

commands.keys = async function (keys) {
  if (this.isWebContext()) {
    let el = await this.active();

    if (_lodash.default.isUndefined(el.ELEMENT)) {
      throw new _appiumBaseDriver.errors.NoSuchElementError();
    }

    await this.setValue(keys, el.ELEMENT);
  } else {
    if (_lodash.default.isArray(keys)) {
      keys = keys.join('');
    }

    if (!_lodash.default.isString(keys)) {
      keys = keys.toString();
    }

    keys = _appiumSupport.util.escapeSpecialChars(keys, "'");
    let command = `au.sendKeysToActiveElement('${keys}')`;
    await this.uiAutoClient.sendCommand(command);
  }
};

commands.setGeoLocation = async function (location) {
  await this.uiAutoClient.sendCommand(`target.setLocation(${JSON.stringify(location)})`);
};

commands.getWindowSize = async function (windowHandle = "current") {
  if (windowHandle !== "current") {
    throw new _appiumBaseDriver.errors.NotYetImplementedError("Currently only getting current window size is supported.");
  }

  if (this.isWebContext()) {
    return await this.executeAtom('get_window_size', []);
  } else {
    return await this.uiAutoClient.sendCommand("au.getWindowSize()");
  }
};

commands.getWindowRect = async function () {
  const {
    width,
    height
  } = await this.getWindowSize();
  return {
    width,
    height,
    x: 0,
    y: 0
  };
};

commands.getStrings = async function (language, stringFile = null) {
  _logger.default.debug(`Gettings strings for language '${language}' and string file '${stringFile}'`);

  return await utils.parseLocalizableStrings(Object.assign({}, this.opts, {
    language,
    stringFile,
    strictMode: true
  }));
};

commands.setUrl = async function (url) {
  _logger.default.debug(`Attempting to set url '${url}'`);

  if (!this.isWebContext()) {
    await (0, _nodeSimctl.openUrl)(this.opts.udid || this.sim.udid, url);
    return;
  }

  this.setCurrentUrl(url);
  this.curWebFrames = [];
  await this.remote.navToUrl(url);
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJNT01FTlRfRk9STUFUX0lTTzg2MDEiLCJhY3RpdmUiLCJpc1dlYkNvbnRleHQiLCJleGVjdXRlQXRvbSIsInVpQXV0b0NsaWVudCIsInNlbmRDb21tYW5kIiwiZ2V0RGV2aWNlVGltZSIsImZvcm1hdCIsImxvZyIsImluZm8iLCJjbWQiLCJhcmdzIiwiaW5wdXRGb3JtYXQiLCJpc1JlYWxEZXZpY2UiLCJmcyIsIndoaWNoIiwiZXJyIiwiZXJyb3JBbmRUaHJvdyIsIm9wdHMiLCJ1ZGlkIiwid2FybiIsInN0ZG91dCIsInRyaW0iLCJkZWJ1ZyIsImpvaW4iLCJwYXJzZWRUaW1lc3RhbXAiLCJpc1ZhbGlkIiwiaGlkZUtleWJvYXJkIiwic3RyYXRlZ3kiLCJwb3NzaWJsZUtleXMiLCJwb3AiLCJrZXkiLCJfIiwiZmluZCIsImsiLCJnZXRQYWdlU291cmNlIiwic2NyaXB0IiwiZ2V0TmF0aXZlUGFnZVNvdXJjZSIsImpzb25Tb3VyY2UiLCJnZXRTb3VyY2VGb3JFbGVtZW50Rm9yWE1MIiwiSlNPTiIsInBhcnNlIiwieG1sU291cmNlIiwid3JhcEFycmF5IiwiZW5hYmxlZCIsImVsZW1lbnROYW1lIiwiZGVjbGFyYXRpb24iLCJpbmNsdWRlIiwicHJldHR5UHJpbnRpbmciLCJpbmRlbnRTdHJpbmciLCJiYWNrZ3JvdW5kIiwic2VjcyIsImxvY2siLCJjbG9zZUFwcCIsImFwcE5hbWUiLCJhcHAiLCJidW5kbGVJZCIsInN0b3AiLCJsYXVuY2hBcHAiLCJzdGFydCIsInJlbW92ZUFwcCIsInJlYWxEZXZpY2UiLCJyZW1vdmUiLCJzaW0iLCJrZXlzIiwiZWwiLCJpc1VuZGVmaW5lZCIsIkVMRU1FTlQiLCJlcnJvcnMiLCJOb1N1Y2hFbGVtZW50RXJyb3IiLCJzZXRWYWx1ZSIsImlzQXJyYXkiLCJpc1N0cmluZyIsInRvU3RyaW5nIiwidXRpbCIsImVzY2FwZVNwZWNpYWxDaGFycyIsImNvbW1hbmQiLCJzZXRHZW9Mb2NhdGlvbiIsImxvY2F0aW9uIiwic3RyaW5naWZ5IiwiZ2V0V2luZG93U2l6ZSIsIndpbmRvd0hhbmRsZSIsIk5vdFlldEltcGxlbWVudGVkRXJyb3IiLCJnZXRXaW5kb3dSZWN0Iiwid2lkdGgiLCJoZWlnaHQiLCJ4IiwieSIsImdldFN0cmluZ3MiLCJsYW5ndWFnZSIsInN0cmluZ0ZpbGUiLCJ1dGlscyIsInBhcnNlTG9jYWxpemFibGVTdHJpbmdzIiwiT2JqZWN0IiwiYXNzaWduIiwic3RyaWN0TW9kZSIsInNldFVybCIsInVybCIsInNldEN1cnJlbnRVcmwiLCJjdXJXZWJGcmFtZXMiLCJyZW1vdGUiLCJuYXZUb1VybCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLElBQUlBLFFBQVEsR0FBRyxFQUFmO0FBQUEsSUFBbUJDLE9BQU8sR0FBRyxFQUE3QjtBQUFBLElBQWlDQyxVQUFVLEdBQUcsRUFBOUM7OztBQUVBLE1BQU1DLHFCQUFxQixHQUFHLHNCQUE5Qjs7QUFFQUgsUUFBUSxDQUFDSSxNQUFULEdBQWtCLGtCQUFrQjtBQUNsQyxNQUFJLEtBQUtDLFlBQUwsRUFBSixFQUF5QjtBQUN2QixXQUFPLE1BQU0sS0FBS0MsV0FBTCxDQUFpQixnQkFBakIsRUFBbUMsRUFBbkMsQ0FBYjtBQUNELEdBRkQsTUFFTztBQUNMLFdBQU8sTUFBTSxLQUFLQyxZQUFMLENBQWtCQyxXQUFsQixDQUE4Qix1QkFBOUIsQ0FBYjtBQUNEO0FBQ0YsQ0FORDs7QUFpQkFSLFFBQVEsQ0FBQ1MsYUFBVCxHQUF5QixnQkFBZ0JDLE1BQU0sR0FBR1AscUJBQXpCLEVBQWdEO0FBQ3ZFUSxrQkFBSUMsSUFBSixDQUFTLGdEQUFUOztBQUNBLE1BQUlDLEdBQUo7QUFDQSxNQUFJQyxJQUFKO0FBQ0EsTUFBSUMsV0FBSjs7QUFDQSxNQUFJLEtB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WyJpbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBqczJ4bWwgZnJvbSBcImpzMnhtbHBhcnNlcjJcIjtcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGZzLCB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgKiBhcyB1dGlscyBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgeyBvcGVuVXJsIH0gZnJvbSAnbm9kZS1zaW1jdGwnO1xuaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQnO1xuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmNvbnN0IE1PTUVOVF9GT1JNQVRfSVNPODYwMSA9ICdZWVlZLU1NLUREVEhIOm1tOnNzWic7XG5cbmNvbW1hbmRzLmFjdGl2ZSA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnYWN0aXZlX2VsZW1lbnQnLCBbXSk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKFwiYXUuZ2V0QWN0aXZlRWxlbWVudCgpXCIpO1xuICB9XG59O1xuXG4vKipcbiAqIFJldHJpZXZlcyB0aGUgY3VycmVudCBkZXZpY2UncyB0aW1lc3RhbXAuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGZvcm1hdCAtIFRoZSBzZXQgb2YgZm9ybWF0IHNwZWNpZmllcnMuIFJlYWRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwczovL21vbWVudGpzLmNvbS9kb2NzLyB0byBnZXQgdGhlIGZ1bGwgbGlzdCBvZiBzdXBwb3J0ZWRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRldGltZSBmb3JtYXQgc3BlY2lmaWVycy4gVGhlIGRlZmF1bHQgZm9ybWF0IGlzXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgYFlZWVktTU0tRERUSEg6bW06c3NaYCwgd2hpY2ggY29tcGxpZXMgdG8gSVNPLTg2MDFcbiAqIEByZXR1cm5zIEZvcm1hdHRlZCBkYXRldGltZSBzdHJpbmcgb3IgdGhlIHJhdyBjb21tYW5kIG91dHB1dCBpZiBmb3JtYXR0aW5nIGZhaWxzXG4gKi9cbmNvbW1hbmRzLmdldERldmljZVRpbWUgPSBhc3luYyBmdW5jdGlvbiAoZm9ybWF0ID0gTU9NRU5UX0ZPUk1BVF9JU084NjAxKSB7XG4gIGxvZy5pbmZvKCdBdHRlbXB0aW5nIHRvIGNhcHR1cmUgaU9TIGRldmljZSBkYXRlIGFuZCB0aW1lJyk7XG4gIGxldCBjbWQ7XG4gIGxldCBhcmdzO1xuICBsZXQgaW5wdXRGb3JtYXQ7XG4gIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNtZCA9IGF3YWl0IGZzLndoaWNoKCdpZGV2aWNlZGF0ZScpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coJ0NvdWxkIG5vdCBjYXB0dXJlIGRldmljZSBkYXRlIGFuZCB0aW1lIHVzaW5nIGxpYmltb2JpbGVkZXZpY2UgaWRldmljZWRhdGUuICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJ0xpYmltb2JpbGVkZXZpY2UgaXMgcHJvYmFibHkgbm90IGluc3RhbGxlZCcpO1xuICAgIH1cbiAgICBsb2cuaW5mbyhgRm91bmQgaWRldmljZWRhdGU6ICcke2NtZH0nYCk7XG4gICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2xpYmltb2JpbGVkZXZpY2UvbGliaW1vYmlsZWRldmljZS9ibG9iLzI2MzczYjMzNDg4OWY1YWUyZTI3MzdmZjQ0N2ViMjViMTcwMGZhMmYvdG9vbHMvaWRldmljZWRhdGUuYyNMMTI5XG4gICAgYXJncyA9IFsnLXUnLCB0aGlzLm9wdHMudWRpZF07XG4gICAgaW5wdXRGb3JtYXQgPSAnZGRkIE1NTSBERCBISDptbTpzcyB6IFlZWVknO1xuICB9IGVsc2Uge1xuICAgIGxvZy53YXJuKCdPbiBzaW11bGF0b3IuIEFzc3VtaW5nIGRldmljZSB0aW1lIGlzIHRoZSBzYW1lIGFzIGhvc3QgdGltZScpO1xuICAgIGNtZCA9ICdkYXRlJztcbiAgICBhcmdzID0gWycrJVktJW0tJWRUJUg6JU06JVMleiddO1xuICAgIGlucHV0Rm9ybWF0ID0gTU9NRU5UX0ZPUk1BVF9JU084NjAxO1xuICB9XG4gIGNvbnN0IHN0ZG91dCA9IChhd2FpdCBleGVjKGNtZCwgYXJncykpLnN0ZG91dC50cmltKCk7XG4gIGxvZy5kZWJ1ZyhgR290IHRoZSBmb2xsb3dpbmcgb3V0cHV0IG91dCBvZiAnJHtjbWR9ICR7YXJncy5qb2luKCcgJyl9JzogJHtzdGRvdXR9YCk7XG4gIGNvbnN0IHBhcnNlZFRpbWVzdGFtcCA9IG1vbWVudChzdGRvdXQsIGlucHV0Rm9ybWF0KTtcbiAgaWYgKCFwYXJzZWRUaW1lc3RhbXAuaXNWYWxpZCgpKSB7XG4gICAgbG9nLndhcm4oYENhbm5vdCBwYXJzZSB0aGUgdGltZXN0YW1wICcke3N0ZG91dH0nIHJldHVybmVkIGJ5ICcke2NtZH0nIGNvbW1hbmQuIFJldHVybmluZyBpdCBhcyBpc2ApO1xuICAgIHJldHVybiBzdGRvdXQ7XG4gIH1cbiAgcmV0dXJuIHBhcnNlZFRpbWVzdGFtcC5mb3JtYXQoZm9ybWF0KTtcbn07XG5cbmNvbW1hbmRzLmhpZGVLZXlib2FyZCA9IGFzeW5jIGZ1bmN0aW9uIChzdHJhdGVneSwgLi4ucG9zc2libGVLZXlzKSB7XG4gIHBvc3NpYmxlS2V5cy5wb3AoKTsgLy8gbGFzdCBwYXJhbWV0ZXIgaXMgdGhlIHNlc3Npb24gaWRcbiAgbGV0IGNtZDtcbiAgbGV0IGtleSA9IF8uZmluZChwb3NzaWJsZUtleXMsIChrKSA9PiB7cmV0dXJuIGs7fSk7XG4gIGlmIChrZXkpIHtcbiAgICBzdHJhdGVneSA9IHN0cmF0ZWd5IHx8ICdwcmVzc0tleSc7XG4gICAgY21kID0gYGF1LmhpZGVLZXlib2FyZCgnJHtzdHJhdGVneX0nLCAnJHtrZXl9JylgO1xuICB9IGVsc2Uge1xuICAgIHN0cmF0ZWd5ID0gc3RyYXRlZ3kgfHwgJ2RlZmF1bHQnO1xuICAgIGNtZCA9IGBhdS5oaWRlS2V5Ym9hcmQoJyR7c3RyYXRlZ3l9JylgO1xuICB9XG4gIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGNtZCk7XG59O1xuXG5jb21tYW5kcy5nZXRQYWdlU291cmNlID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGNvbnN0IHNjcmlwdCA9ICdyZXR1cm4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lm91dGVySFRNTCc7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2V4ZWN1dGVfc2NyaXB0JywgW3NjcmlwdCwgW11dKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXROYXRpdmVQYWdlU291cmNlKCk7XG4gIH1cbn07XG5cbmhlbHBlcnMuZ2V0TmF0aXZlUGFnZVNvdXJjZSA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbGV0IGpzb25Tb3VyY2UgPSBhd2FpdCB0aGlzLmdldFNvdXJjZUZvckVsZW1lbnRGb3JYTUwoKTtcbiAgaWYgKHR5cGVvZiBqc29uU291cmNlID09PSBcInN0cmluZ1wiKSB7XG4gICAganNvblNvdXJjZSA9IEpTT04ucGFyc2UoanNvblNvdXJjZSk7XG4gIH1cbiAgbGV0IHhtbFNvdXJjZSA9IGpzMnhtbChcIkFwcGl1bUFVVFwiLCBqc29uU291cmNlLCB7XG4gICAgd3JhcEFycmF5OiB7ZW5hYmxlZDogZmFsc2UsIGVsZW1lbnROYW1lOiBcImVsZW1lbnRcIn0sXG4gICAgZGVjbGFyYXRpb246IHtpbmNsdWRlOiB0cnVlfSxcbiAgICBwcmV0dHlQcmludGluZzoge2luZGVudFN0cmluZzogXCIgICAgXCJ9XG4gIH0pO1xuICByZXR1cm4geG1sU291cmNlO1xufTtcblxuY29tbWFuZHMuYmFja2dyb3VuZCA9IGFzeW5jIGZ1bmN0aW9uIChzZWNzKSB7XG4gIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGBhdS5iYWNrZ3JvdW5kKCR7c2Vjc30pYCk7XG59O1xuXG5jb21tYW5kcy5sb2NrID0gYXN5bmMgZnVuY3Rpb24gKHNlY3MpIHtcbiAgaWYgKCFzZWNzKSB7XG4gICAgbG9nLmRlYnVnKCdObyBzZWNvbmRzIHBhcmFtZXRlci4gVXNpbmcgMCBzZWNvbmRzJyk7XG4gICAgc2VjcyA9IDA7XG4gIH1cbiAgYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoYGF1LmxvY2soJHtzZWNzfSlgKTtcbn07XG5cbmNvbW1hbmRzLmNsb3NlQXBwID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsZXQgYXBwTmFtZSA9IHRoaXMub3B0cy5hcHAgfHwgdGhpcy5vcHRzLmJ1bmRsZUlkO1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuc3RvcCgpO1xuICAgIGxvZy5pbmZvKGBTdWNjZXNzZnVsbHkgY2xvc2VkIHRoZSAnJHthcHBOYW1lfScgYXBwLmApO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgU29tZXRoaW5nIHdlbnQgd3Jvbmcgd2hpbGUgY2xvc2luZyB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmxhdW5jaEFwcCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbGV0IGFwcE5hbWUgPSB0aGlzLm9wdHMuYXBwIHx8IHRoaXMub3B0cy5idW5kbGVJZDtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLnN0YXJ0KCk7XG4gICAgbG9nLmluZm8oYFN1Y2Nlc3NmdWxseSBsYXVuY2hlZCB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYFNvbWV0aGluZyB3ZW50IHdyb25nIHdoaWxlIGxhdW5jaGluZyB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnJlbW92ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIChidW5kbGVJZCkge1xuICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIGF3YWl0IHRoaXMucmVhbERldmljZS5yZW1vdmUoYnVuZGxlSWQpO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IHRoaXMuc2ltLnJlbW92ZUFwcChidW5kbGVJZCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmtleXMgPSBhc3luYyBmdW5jdGlvbiAoa2V5cykge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGxldCBlbCA9IGF3YWl0IHRoaXMuYWN0aXZlKCk7XG4gICAgaWYgKF8uaXNVbmRlZmluZWQoZWwuRUxFTUVOVCkpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKCk7XG4gICAgfVxuICAgIGF3YWl0IHRoaXMuc2V0VmFsdWUoa2V5cywgZWwuRUxFTUVOVCk7XG4gIH0gZWxzZSB7XG4gICAgaWYgKF8uaXNBcnJheShrZXlzKSkge1xuICAgICAga2V5cyA9IGtleXMuam9pbignJyk7XG4gICAgfVxuICAgIGlmICghXy5pc1N0cmluZyhrZXlzKSkge1xuICAgICAga2V5cyA9IGtleXMudG9TdHJpbmcoKTtcbiAgICB9XG4gICAga2V5cyA9IHV0aWwuZXNjYXBlU3BlY2lhbENoYXJzKGtleXMsIFwiJ1wiKTtcbiAgICBsZXQgY29tbWFuZCA9IGBhdS5zZW5kS2V5c1RvQWN0aXZlRWxlbWVudCgnJHtrZXlzfScpYDtcbiAgICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChjb21tYW5kKTtcbiAgfVxufTtcblxuY29tbWFuZHMuc2V0R2VvTG9jYXRpb24gPSBhc3luYyBmdW5jdGlvbiAobG9jYXRpb24pIHtcbiAgLy8gVE9ETzogY2hlY2sgdGhlIGhhc09wdGlvbnMgYml0LCB0aGUgbWV0aG9kIHNpZ25hdHVyZSBzaG91bGQgYmUgbG9jYXRpb24sIG9wdGlvblxuXG4gIC8vIGxldCBoYXNPcHRpb25zID0gYWx0aXR1ZGUgIT09IG51bGwgfHwgaG9yaXpvbnRhbEFjY3VyYWN5ICE9PSBudWxsIHx8IHZlcnRpY2FsQWNjdXJhY3kgIT09IG51bGwgfHwgY291cnNlICE9PSBudWxsIHx8IHNwZWVkICE9PSBudWxsO1xuICAvLyBpZiAoaGFzT3B0aW9ucykge1xuICAvLyAgIGxldCBvcHRpb25zID0ge307XG4gIC8vICAgaWYgKGFsdGl0dWRlICE9PSBudWxsKSB7XG4gIC8vICAgICBvcHRpb25zLmFsdGl0dWRlID0gYWx0aXR1ZGU7XG4gIC8vICAgfVxuICAvLyAgIGlmIChob3Jpem9udGFsQWNjdXJhY3kgIT09IG51bGwpIHtcbiAgLy8gICAgIG9wdGlvbnMuaG9yaXpvbnRhbEFjY3VyYWN5ID0gaG9yaXpvbnRhbEFjY3VyYWN5O1xuICAvLyAgIH1cbiAgLy8gICBpZiAodmVydGljYWxBY2N1cmFjeSAhPT0gbnVsbCkge1xuICAvLyAgICAgb3B0aW9ucy52ZXJ0aWNhbEFjY3VyYWN5ID0gdmVydGljYWxBY2N1cmFjeTtcbiAgLy8gICB9XG4gIC8vICAgaWYgKGNvdXJzZSAhPT0gbnVsbCkge1xuICAvLyAgICAgb3B0aW9ucy5jb3Vyc2UgPSBjb3Vyc2U7XG4gIC8vICAgfVxuICAvLyAgIGlmIChzcGVlZCAhPT0gbnVsbCkge1xuICAvLyAgICAgb3B0aW9ucy5zcGVlZCA9IHNwZWVkO1xuICAvLyAgIH1cbiAgLy8gICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChcbiAgLy8gICAgIGB0YXJnZXQuc2V0TG9jYXRpb25XaXRoT3B0aW9ucygke0pTT04uc3RyaW5naWZ5KGNvb3JkaW5hdGVzKX0sICR7SlNPTi5zdHJpbmdpZnkob3B0aW9ucyl9KWApO1xuICAvLyB9IGVsc2Uge1xuICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChgdGFyZ2V0LnNldExvY2F0aW9uKCR7SlNPTi5zdHJpbmdpZnkobG9jYXRpb24pfSlgKTtcbiAgLy8gfVxufTtcblxuY29tbWFuZHMuZ2V0V2luZG93U2l6ZSA9IGFzeW5jIGZ1bmN0aW9uICh3aW5kb3dIYW5kbGUgPSBcImN1cnJlbnRcIikge1xuICBpZiAod2luZG93SGFuZGxlICE9PSBcImN1cnJlbnRcIikge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcihcIkN1cnJlbnRseSBvbmx5IGdldHRpbmcgY3VycmVudCB3aW5kb3cgc2l6ZSBpcyBzdXBwb3J0ZWQuXCIpO1xuICB9XG5cbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3dpbmRvd19zaXplJywgW10pO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChcImF1LmdldFdpbmRvd1NpemUoKVwiKTtcbiAgfVxufTtcblxuLy8gRm9yIFczQ1xuY29tbWFuZHMuZ2V0V2luZG93UmVjdCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgY29uc3Qge3dpZHRoLCBoZWlnaHR9ID0gYXdhaXQgdGhpcy5nZXRXaW5kb3dTaXplKCk7XG4gIHJldHVybiB7XG4gICAgd2lkdGgsXG4gICAgaGVpZ2h0LFxuICAgIHg6IDAsXG4gICAgeTogMFxuICB9O1xufTtcblxuY29tbWFuZHMuZ2V0U3RyaW5ncyA9IGFzeW5jIGZ1bmN0aW9uIChsYW5ndWFnZSwgc3RyaW5nRmlsZSA9IG51bGwpIHtcbiAgbG9nLmRlYnVnKGBHZXR0aW5ncyBzdHJpbmdzIGZvciBsYW5ndWFnZSAnJHtsYW5ndWFnZX0nIGFuZCBzdHJpbmcgZmlsZSAnJHtzdHJpbmdGaWxlfSdgKTtcbiAgcmV0dXJuIGF3YWl0IHV0aWxzLnBhcnNlTG9jYWxpemFibGVTdHJpbmdzKE9iamVjdC5hc3NpZ24oe30sIHRoaXMub3B0cywge1xuICAgIGxhbmd1YWdlLFxuICAgIHN0cmluZ0ZpbGUsXG4gICAgc3RyaWN0TW9kZTogdHJ1ZSxcbiAgfSkpO1xufTtcblxuY29tbWFuZHMuc2V0VXJsID0gYXN5bmMgZnVuY3Rpb24gKHVybCkge1xuICBsb2cuZGVidWcoYEF0dGVtcHRpbmcgdG8gc2V0IHVybCAnJHt1cmx9J2ApO1xuICBpZiAoIXRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICAvLyB1c2UgeGNydW4gdG8gb3BlbiBkZWVwbGlua1xuICAgIGF3YWl0IG9wZW5VcmwodGhpcy5vcHRzLnVkaWQgfHwgdGhpcy5zaW0udWRpZCwgdXJsKTtcbiAgICByZXR1cm47XG4gIH1cbiAgdGhpcy5zZXRDdXJyZW50VXJsKHVybCk7XG4gIC8vIG1ha2Ugc3VyZSB0byBjbGVhciBvdXQgYW55IGxlZnRvdmVyIHdlYiBmcmFtZXNcbiAgdGhpcy5jdXJXZWJGcmFtZXMgPSBbXTtcbiAgYXdhaXQgdGhpcy5yZW1vdGUubmF2VG9VcmwodXJsKTtcbn07XG5cblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL2dlbmVyYWwuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
