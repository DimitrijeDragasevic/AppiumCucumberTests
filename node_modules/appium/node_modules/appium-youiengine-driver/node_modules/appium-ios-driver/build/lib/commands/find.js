"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

var _appiumBaseDriver = require("appium-base-driver");

var _lodash = _interopRequireDefault(require("lodash"));

var _js2xmlparser = _interopRequireDefault(require("js2xmlparser2"));

var _xmldom = _interopRequireDefault(require("xmldom"));

var _xpath = _interopRequireDefault(require("xpath"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _utils = require("../utils");

const MAGIC_FIRST_VIS_CHILD_SEL = /\/\*\[@firstVisible ?= ?('|")true\1\]/;
const MAGIC_SCROLLABLE_SEL = /\/\/\*\[@scrollable ?= ?('|")true\1\]/;
let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;

helpers.findElOrEls = async function (strategy, selector, mult, context) {
  context = (0, _utils.unwrapEl)(context);

  if (this.isWebContext()) {
    return await this.findWebElementOrElements(strategy, selector, mult, context);
  } else {
    return await this.findUIElementOrElements(strategy, selector, mult, context);
  }
};

helpers.findUIElementOrElements = async function (strategy, selector, mult, context) {
  if (strategy !== "xpath") {
    selector = _appiumSupport.util.escapeSpecialChars(selector, "'");
  }

  if (typeof context === "undefined" || !context) {
    context = '';
  } else if (typeof context === "string") {
    context = _appiumSupport.util.escapeSpecialChars(context, "'");
  }

  if (strategy === 'xpath' && MAGIC_SCROLLABLE_SEL.test(selector)) {
    return await this.findScrollableElOrEls(mult, context);
  }

  if (strategy === 'xpath' && MAGIC_FIRST_VIS_CHILD_SEL.test(selector)) {
    if (mult) {
      throw new Error("Cannot get multiple first children");
    }

    return await this.getFirstVisibleChild(context);
  }

  if (strategy === 'class name' && selector.indexOf('UIA') !== 0) {
    throw new _appiumBaseDriver.errors.InvalidSelectorError(`The class name selector must use full UIA class names. Try 'UIA${selector}' instead.`);
  }

  if (!selector) new _appiumBaseDriver.errors.InvalidSelectorError('Missing selector');

  let createGetElementCommand = function (strategy, selector, mult, context) {
    let ext = mult ? 's' : '';
    let command = "";
    context = !context ? context : `, '${context}'`;

    switch (strategy) {
      case "name":
        command = `au.getElement${ext}ByName('${selector}'${context})`;
        break;

      case "accessibility id":
        command = `au.getElement${ext}ByAccessibilityId('${selector}'${context})`;
        break;

      case "id":
        command = `au.getElement${ext}ById('${selector}')`;
        break;

      case "-ios uiautomation":
        command = `au.getElement${ext}ByUIAutomation('${selector}'${context})`;
        break;

      default:
        command = `au.getElement${ext}ByType('${selector}'${context})`;
    }

    return command;
  };

  let getLocalizedStringForSelector = function (selector, strings) {
    let newSelector = selector;

    if (strings) {
      let localizedSelector = strings[selector];

      if (localizedSelector) {
        newSelector = localizedSelector;
      } else {
        _logger.default.debug(`Id selector, '${selector}', not found in Localizable.strings.`);
      }
    }

    return newSelector;
  };

  let res;

  let doFind = async () => {
    if (strategy === "xpath") {
      res = await this.findUIElementsByXpath(selector, mult, context);
    } else if (strategy === "id") {
      let findByAxIdCmd = createGetElementCommand("accessibility id", selector, mult, context);
      res = await this.uiAutoClient.sendCommand(findByAxIdCmd);

      if (!(res && _lodash.default.size(res) > 0)) {
        let findByIdCmd = createGetElementCommand("id", getLocalizedStringForSelector(selector, this.opts.localizableStrings), mult, context);
        res = await this.uiAutoClient.sendCommand(findByIdCmd);
      }
    } else {
      let command = createGetElementCommand(strategy, selector, mult, context);
      res = await this.uiAutoClient.sendCommand(command);
    }

    return _lodash.default.size(res) > 0;
  };

  try {
    await this.implicitWaitForCondition(doFind);
  } catch (err) {
    if (err.message && err.message.match(/Condition unmet/)) {
      res = [];
    } else {
      throw err;
    }
  }

  if (mult) {
    return res;
  } else {
    if (!res || _lodash.default.size(res) === 0) {
      throw new _appiumBaseDriver.errors.NoSuchElementError();
    }

    return res;
  }
};

let _pathFromDomNode = function (node) {
  let path = null;

  for (let attrObj of _lodash.default.values(node.attributes)) {
    if (attrObj.name === "path") {
      path = attrObj.value;
    }
  }

  return path;
};

let _xmlSourceFromJson = function (jsonSource) {
  if (typeof jsonSource === "string") {
    jsonSource = JSON.parse(jsonSource);
  }

  return (0, _js2xmlparser.default)("AppiumAUT", jsonSource, {
    wrapArray: {
      enabled: false,
      elementName: "element"
    },
    declaration: {
      include: true
    },
    prettyPrinting: {
      indentString: "    "
    }
  });
};

let _performXpathQueryOnJson = function (selector, jsonSource) {
  let xmlSource = _xmlSourceFromJson(jsonSource);

  let dom = new _xmldom.default.DOMParser().parseFromString(xmlSource);
  return _xpath.default.select(selector, dom);
};

commands.findUIElementsByXpath = async function (selector, mult, context = null, curRetry = 1) {
  let sourceXml;

  try {
    sourceXml = await this.getSourceForElementForXML(context);
  } catch (err) {
    _logger.default.warn("Error getting source, can't continue finding element by XPath");

    throw err;
  }

  let selectedNodes = _performXpathQueryOnJson(selector, sourceXml);

  if (!mult) {
    selectedNodes = selectedNodes.slice(0, 1);
  }

  let indexPaths = [];

  for (let node of selectedNodes) {
    let ip = _pathFromDomNode(node);

    if (ip !== null) {
      indexPaths.push(ip);
    }
  }

  if (indexPaths.length < 1) {
    return [];
  }

  let methodName;
  let methodArgs = [];

  if (!mult) {
    methodName = "getElementByIndexPath";
    methodArgs[0] = `'${indexPaths[0]}'`;
  } else {
    methodName = "getElementsByIndexPaths";
    methodArgs[0] = JSON.stringify(indexPaths);
  }

  if (context) {
    methodArgs[1] = `au.getElement('${context}')`;
  }

  let proxyCmd = `au.${methodName}(${methodArgs.join(", ")})`;
  let res;

  try {
    res = await this.uiAutoClient.sendCommand(proxyCmd);
  } catch (err) {
    if (curRetry < 3) {
      _logger.default.debug("Got a warning from uiauto that some index paths " + "could not be resolved, trying again");

      await _bluebird.default.delay(300);
      return await this.findUIElementsByXpath(selector, mult, context, curRetry + 1);
    }

    throw err;
  }

  return res;
};

helpers.findScrollableElOrEls = async function (mult, context) {
  const scrollTypes = ['UIAScrollView', 'UIATableView', 'UIACollectionView', 'UIAWebView'];
  let res = [];
  const ext = mult ? 's' : '';

  for (const scrollType of scrollTypes) {
    const command = `au.getElement${ext}ByType('${scrollType}'${context})`;

    if (mult) {
      let elements = await this.uiAutoClient.sendCommand(command);

      if (!_lodash.default.isEmpty(elements)) {
        res.push(...elements);
      }
    } else {
      let element = await this.uiAutoClient.sendCommand(command);

      if (element) {
        return element;
      }
    }
  }

  if (mult) {
    return res;
  }

  throw new _appiumBaseDriver.errors.NoSuchElementError();
};

helpers.getFirstVisibleChild = async function (elementId) {
  let visibleEls = await this.findElementsFromElement('-ios uiautomation', '.elements().withPredicate("isVisible == 1");', elementId);
  return _lodash.default.first(visibleEls);
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9maW5kLmpzIl0sIm5hbWVzIjpbIk1BR0lDX0ZJUlNUX1ZJU19DSElMRF9TRUwiLCJNQUdJQ19TQ1JPTExBQkxFX1NFTCIsImNvbW1hbmRzIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJmaW5kRWxPckVscyIsInN0cmF0ZWd5Iiwic2VsZWN0b3IiLCJtdWx0IiwiY29udGV4dCIsImlzV2ViQ29udGV4dCIsImZpbmRXZWJFbGVtZW50T3JFbGVtZW50cyIsImZpbmRVSUVsZW1lbnRPckVsZW1lbnRzIiwidXRpbCIsImVzY2FwZVNwZWNpYWxDaGFycyIsInRlc3QiLCJmaW5kU2Nyb2xsYWJsZUVsT3JFbHMiLCJFcnJvciIsImdldEZpcnN0VmlzaWJsZUNoaWxkIiwiaW5kZXhPZiIsImVycm9ycyIsIkludmFsaWRTZWxlY3RvckVycm9yIiwiY3JlYXRlR2V0RWxlbWVudENvbW1hbmQiLCJleHQiLCJjb21tYW5kIiwiZ2V0TG9jYWxpemVkU3RyaW5nRm9yU2VsZWN0b3IiLCJzdHJpbmdzIiwibmV3U2VsZWN0b3IiLCJsb2NhbGl6ZWRTZWxlY3RvciIsImxvZ2dlciIsImRlYnVnIiwicmVzIiwiZG9GaW5kIiwiZmluZFVJRWxlbWVudHNCeVhwYXRoIiwiZmluZEJ5QXhJZENtZCIsInVpQXV0b0NsaWVudCIsInNlbmRDb21tYW5kIiwiXyIsInNpemUiLCJmaW5kQnlJZENtZCIsIm9wdHMiLCJsb2NhbGl6YWJsZVN0cmluZ3MiLCJpbXBsaWNpdFdhaXRGb3JDb25kaXRpb24iLCJlcnIiLCJtZXNzYWdlIiwibWF0Y2giLCJOb1N1Y2hFbGVtZW50RXJyb3IiLCJfcGF0aEZyb21Eb21Ob2RlIiwibm9kZSIsInBhdGgiLCJhdHRyT2JqIiwidmFsdWVzIiwiYXR0cmlidXRlcyIsIm5hbWUiLCJ2YWx1ZSIsIl94bWxTb3VyY2VGcm9tSnNvbiIsImpzb25Tb3VyY2UiLCJKU09OIiwicGFyc2UiLCJ3cmFwQXJyYXkiLCJlbmFibGVkIiwiZWxlbWVudE5hbWUiLCJkZWNsYXJhdGlvbiIsImluY2x1ZGUiLCJwcmV0dHlQcmludGluZyIsImluZGVudFN0cmluZyIsIl9wZXJmb3JtWHBhdGhRdWVyeU9uSnNvbiIsInhtbFNvdXJjZSIsImRvbSIsIlhNTERvbSIsIkRPTVBhcnNlciIsInBhcnNlRnJvbVN0cmluZyIsInhwYXRoIiwic2VsZWN0IiwiY3VyUmV0cnkiLCJzb3VyY2VYbWwiLCJnZXRTb3VyY2VGb3JFbGVtZW50Rm9yWE1MIiwid2FybiIsInNlbGVjdGVkTm9kZXMiLCJzbGljZSIsImluZGV4UGF0aHMiLCJpcCIsInB1c2giLCJsZW5ndGgiLCJtZXRob2ROYW1lIiwibWV0aG9kQXJncyIsInN0cmluZ2lmeSIsInByb3h5Q21kIiwiam9pbiIsIkIiLCJkZWxheSIsInNjcm9sbFR5cGVzIiwic2Nyb2xsVHlwZSIsImVsZW1lbnRzIiwiaXNFbXB0eSIsImVsZW1lbnQiLCJlbGVtZW50SWQiLCJ2aXNpYmxlRWxzIiwiZmluZEVsZW1lbnRzRnJvbUVsZW1lbnQiLCJmaXJzdCIsIk9iamVjdCIsImFzc2lnbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFJQSxNQUFNQSx5QkFBeUIsR0FBRyx1Q0FBbEM7QUFJQSxNQUFNQyxvQkFBb0IsR0FBRyx1Q0FBN0I7QUFFQSxJQUFJQyxRQUFRLEdBQUcsRUFBZjtBQUFBLElBQW1CQyxPQUFPLEdBQUcsRUFBN0I7QUFBQSxJQUFpQ0MsVUFBVSxHQUFHLEVBQTlDOzs7O0FBRUFELE9BQU8sQ0FBQ0UsV0FBUixHQUFzQixnQkFBZ0JDLFFBQWhCLEVBQTBCQyxRQUExQixFQUFvQ0MsSUFBcEMsRUFBMENDLE9BQTFDLEVBQW1EO0FBQ3ZFQSxFQUFBQSxPQUFPLEdBQUcscUJBQVNBLE9BQVQsQ0FBVjs7QUFDQSxNQUFJLEtBQUtDLFlBQUwsRUFBSixFQUF5QjtBQUN2QixXQUFPLE1BQU0sS0FBS0Msd0JBQUwsQ0FBOEJMLFFB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QUksQ0FBQ2EsZ0JBQUV5RCxPQUFGLENBQVVELFFBQVYsQ0FBTCxFQUEwQjtBQUN4QjlELFFBQUFBLEdBQUcsQ0FBQ21ELElBQUosQ0FBUyxHQUFHVyxRQUFaO0FBQ0Q7QUFDRixLQUxELE1BS087QUFDTCxVQUFJRSxPQUFPLEdBQUcsTUFBTSxLQUFLNUQsWUFBTCxDQUFrQkMsV0FBbEIsQ0FBOEJaLE9BQTlCLENBQXBCOztBQUNBLFVBQUl1RSxPQUFKLEVBQWE7QUFDWCxlQUFPQSxPQUFQO0FBQ0Q7QUFDRjtBQUNGOztBQUVELE1BQUl2RixJQUFKLEVBQVU7QUFDUixXQUFPdUIsR0FBUDtBQUNEOztBQUVELFFBQU0sSUFBSVgseUJBQU8wQixrQkFBWCxFQUFOO0FBQ0QsQ0F6QkQ7O0FBMkJBM0MsT0FBTyxDQUFDZSxvQkFBUixHQUErQixnQkFBZ0I4RSxTQUFoQixFQUEyQjtBQUN4RCxNQUFJQyxVQUFVLEdBQUcsTUFBTSxLQUFLQyx1QkFBTCxDQUE2QixtQkFBN0IsRUFBa0QsOENBQWxELEVBQWtHRixTQUFsRyxDQUF2QjtBQUNBLFNBQU8zRCxnQkFBRThELEtBQUYsQ0FBUUYsVUFBUixDQUFQO0FBQ0QsQ0FIRDs7QUFLQUcsTUFBTSxDQUFDQyxNQUFQLENBQWNqRyxVQUFkLEVBQTBCRixRQUExQixFQUFvQ0MsT0FBcEM7ZUFFZUMsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2dnZXIgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBqczJ4bWwgZnJvbSAnanMyeG1scGFyc2VyMic7XG5pbXBvcnQgWE1MRG9tIGZyb20gJ3htbGRvbSc7XG5pbXBvcnQgeHBhdGggZnJvbSAneHBhdGgnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgdW53cmFwRWwgfSBmcm9tICcuLi91dGlscyc7XG5cbi8vIHdlIG92ZXJyaWRlIHRoZSB4cGF0aCBzZWFyY2ggZm9yIHRoaXMgZmlyc3QtdmlzaWJsZS1jaGlsZCBzZWxlY3Rvciwgd2hpY2hcbi8vIGxvb2tzIGxpa2UgLypbQGZpcnN0VmlzaWJsZT1cInRydWVcIl1cbmNvbnN0IE1BR0lDX0ZJUlNUX1ZJU19DSElMRF9TRUwgPSAvXFwvXFwqXFxbQGZpcnN0VmlzaWJsZSA/PSA/KCd8XCIpdHJ1ZVxcMVxcXS87XG5cbi8vIHdlIGxpa2V3aXNlIG92ZXJyaWRlIHhwYXRoIHNlYXJjaCB0byBwcm92aWRlIGEgc2hvcnRjdXQgZm9yIGZpbmRpbmcgYWxsXG4vLyBzY3JvbGxhYmxlIGVsZW1lbnRzXG5jb25zdCBNQUdJQ19TQ1JPTExBQkxFX1NFTCA9IC9cXC9cXC9cXCpcXFtAc2Nyb2xsYWJsZSA/PSA/KCd8XCIpdHJ1ZVxcMVxcXS87XG5cbmxldCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuaGVscGVycy5maW5kRWxPckVscyA9IGFzeW5jIGZ1bmN0aW9uIChzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpIHtcbiAgY29udGV4dCA9IHVud3JhcEVsKGNvbnRleHQpO1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRXZWJFbGVtZW50T3JFbGVtZW50cyhzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRVSUVsZW1lbnRPckVsZW1lbnRzKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCk7XG4gIH1cbn07XG5cbmhlbHBlcnMuZmluZFVJRWxlbWVudE9yRWxlbWVudHMgPSBhc3luYyBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KSB7XG4gIGlmIChzdHJhdGVneSAhPT0gXCJ4cGF0aFwiKSB7XG4gICAgc2VsZWN0b3IgPSB1dGlsLmVzY2FwZVNwZWNpYWxDaGFycyhzZWxlY3RvciwgXCInXCIpO1xuICB9XG5cbiAgaWYgKHR5cGVvZiBjb250ZXh0ID09PSBcInVuZGVmaW5lZFwiIHx8ICFjb250ZXh0KSB7XG4gICAgY29udGV4dCA9ICcnO1xuICB9IGVsc2UgaWYgKHR5cGVvZiBjb250ZXh0ID09PSBcInN0cmluZ1wiKSB7XG4gICAgY29udGV4dCA9IHV0aWwuZXNjYXBlU3BlY2lhbENoYXJzKGNvbnRleHQsIFwiJ1wiKTtcbiAgfVxuXG4gIGlmIChzdHJhdGVneSA9PT0gJ3hwYXRoJyAmJiBNQUdJQ19TQ1JPTExBQkxFX1NFTC50ZXN0KHNlbGVjdG9yKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRTY3JvbGxhYmxlRWxPckVscyhtdWx0LCBjb250ZXh0KTtcbiAgfVxuXG4gIGlmIChzdHJhdGVneSA9PT0gJ3hwYXRoJyAmJiBNQUdJQ19GSVJTVF9WSVNfQ0hJTERfU0VMLnRlc3Qoc2VsZWN0b3IpKSB7XG4gICAgaWYgKG11bHQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBnZXQgbXVsdGlwbGUgZmlyc3QgY2hpbGRyZW5cIik7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldEZpcnN0VmlzaWJsZUNoaWxkKGNvbnRleHQpO1xuICB9XG5cbiAgLy8gcHJldmlvdXNseSBnZXRTZWxlY3RvckZvclN0cmF0ZWd5XG4gIGlmIChzdHJhdGVneSA9PT0gJ2NsYXNzIG5hbWUnICYmIHNlbGVjdG9yLmluZGV4T2YoJ1VJQScpICE9PSAwKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkU2VsZWN0b3JFcnJvcihcbiAgICAgIGBUaGUgY2xhc3MgbmFtZSBzZWxlY3RvciBtdXN0IHVzZSBmdWxsIFVJQSBjbGFzcyBuYW1lcy4gVHJ5ICdVSUEke3NlbGVjdG9yfScgaW5zdGVhZC5gKTtcbiAgfVxuXG4gIGlmICghc2VsZWN0b3IpIG5ldyBlcnJvcnMuSW52YWxpZFNlbGVjdG9yRXJyb3IoJ01pc3Npbmcgc2VsZWN0b3InKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuXG4gIGxldCBjcmVhdGVHZXRFbGVtZW50Q29tbWFuZCA9IGZ1bmN0aW9uIChzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpIHtcbiAgICBsZXQgZXh0ID0gbXVsdCA/ICdzJyA6ICcnO1xuICAgIGxldCBjb21tYW5kID0gXCJcIjtcbiAgICBjb250ZXh0ID0gIWNvbnRleHQgPyBjb250ZXh0IDogYCwgJyR7Y29udGV4dH0nYCA7XG4gICAgc3dpdGNoIChzdHJhdGVneSkge1xuICAgICAgY2FzZSBcIm5hbWVcIjpcbiAgICAgICAgY29tbWFuZCA9IGBhdS5nZXRFbGVtZW50JHtleHR9QnlOYW1lKCcke3NlbGVjdG9yfScke2NvbnRleHR9KWA7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBcImFjY2Vzc2liaWxpdHkgaWRcIjpcbiAgICAgICAgY29tbWFuZCA9IGBhdS5nZXRFbGVtZW50JHtleHR9QnlBY2Nlc3NpYmlsaXR5SWQoJyR7c2VsZWN0b3J9JyR7Y29udGV4dH0pYDtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwiaWRcIjpcbiAgICAgICAgY29tbWFuZCA9IGBhdS5nZXRFbGVtZW50JHtleHR9QnlJZCgnJHtzZWxlY3Rvcn0nKWA7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBcIi1pb3MgdWlhdXRvbWF0aW9uXCI6XG4gICAgICAgIGNvbW1hbmQgPSBgYXUuZ2V0RWxlbWVudCR7ZXh0fUJ5VUlBdXRvbWF0aW9uKCcke3NlbGVjdG9yfScke2NvbnRleHR9KWA7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgY29tbWFuZCA9IGBhdS5nZXRFbGVtZW50JHtleHR9QnlUeXBlKCcke3NlbGVjdG9yfScke2NvbnRleHR9KWA7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbW1hbmQ7XG4gIH07XG5cbiAgbGV0IGdldExvY2FsaXplZFN0cmluZ0ZvclNlbGVjdG9yID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBzdHJpbmdzKSB7XG4gICAgbGV0IG5ld1NlbGVjdG9yID0gc2VsZWN0b3I7XG4gICAgaWYgKHN0cmluZ3MpIHtcbiAgICAgIGxldCBsb2NhbGl6ZWRTZWxlY3RvciA9IHN0cmluZ3Nbc2VsZWN0b3JdO1xuICAgICAgaWYgKGxvY2FsaXplZFNlbGVjdG9yKSB7XG4gICAgICAgIG5ld1NlbGVjdG9yID0gbG9jYWxpemVkU2VsZWN0b3I7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIuZGVidWcoXG4gICAgICAgICAgYElkIHNlbGVjdG9yLCAnJHtzZWxlY3Rvcn0nLCBub3QgZm91bmQgaW4gTG9jYWxpemFibGUuc3RyaW5ncy5gKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbmV3U2VsZWN0b3I7XG4gIH07XG5cbiAgbGV0IHJlcztcbiAgbGV0IGRvRmluZCA9IGFzeW5jICgpID0+IHtcbiAgICBpZiAoc3RyYXRlZ3kgPT09IFwieHBhdGhcIikge1xuICAgICAgcmVzID0gYXdhaXQgdGhpcy5maW5kVUlFbGVtZW50c0J5WHBhdGgoc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpO1xuICAgIH0gZWxzZSBpZiAoc3RyYXRlZ3kgPT09IFwiaWRcIikge1xuICAgICAgLy8gRm9yIHRoZSBJRCBzdHJhdGVneSwgd2UgZmlyc3Qgd2FudCB0byBoYW5kbGUgdGhlIHNlbGVjdG9yIGFzIGFuXG4gICAgICAvLyBhY2Nlc3NpYmlsaXR5IGlkLiBJZiBubyBlbGVtZW50IGlzIGZvdW5kIGJ5IHRoYXQgc3RyYXRlZ3ksIHdlIGZhbGxcbiAgICAgIC8vIGJhY2sgdG8gc2VhcmNoaW5nIGZvciB0aGUgc3RyaW5nLlxuICAgICAgbGV0IGZpbmRCeUF4SWRDbWQgPSBjcmVhdGVHZXRFbGVtZW50Q29tbWFuZChcImFjY2Vzc2liaWxpdHkgaWRcIiwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpO1xuICAgICAgcmVzID0gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoZmluZEJ5QXhJZENtZCk7XG4gICAgICBpZiAoIShyZXMgJiYgXy5zaXplKHJlcykgPiAwKSkge1xuICAgICAgICAvLyBTaW5jZSBubyBlbGVtZW50IHdhcyBmb3VuZCB1c2luZyB0aGUgYWNjZXNzaWJpbGl0eSBpZCwgd2UgZmFsbFxuICAgICAgICAvLyBiYWNrIHRvIHNlYXJjaCBieSBzdHJpbmcuXG4gICAgICAgIGxldCBmaW5kQnlJZENtZCA9IGNyZWF0ZUdldEVsZW1lbnRDb21tYW5kKFwiaWRcIiwgZ2V0TG9jYWxpemVkU3RyaW5nRm9yU2VsZWN0b3Ioc2VsZWN0b3IsXG4gICAgICAgICAgdGhpcy5vcHRzLmxvY2FsaXphYmxlU3RyaW5ncyksIG11bHQsIGNvbnRleHQpO1xuICAgICAgICByZXMgPSBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChmaW5kQnlJZENtZCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBjb21tYW5kID0gY3JlYXRlR2V0RWxlbWVudENvbW1hbmQoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KTtcbiAgICAgIHJlcyA9IGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGNvbW1hbmQpO1xuICAgIH1cbiAgICByZXR1cm4gXy5zaXplKHJlcykgPiAwO1xuICB9O1xuXG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5pbXBsaWNpdFdhaXRGb3JDb25kaXRpb24oZG9GaW5kKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKGVyci5tZXNzYWdlICYmIGVyci5tZXNzYWdlLm1hdGNoKC9Db25kaXRpb24gdW5tZXQvKSkge1xuICAgICAgLy8gY29uZGl0aW9uIHdhcyBub3QgbWV0IHNldHRpbmcgcmVzIHRvIGVtcHR5IGFycmF5XG4gICAgICByZXMgPSBbXTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfVxuICBpZiAobXVsdCkge1xuICAgIHJldHVybiByZXM7XG4gIH0gZWxzZSB7XG4gICAgaWYgKCFyZXMgfHwgXy5zaXplKHJlcykgPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKCk7XG4gICAgfVxuICAgIHJldHVybiByZXM7XG4gIH1cbn07XG5cbmxldCBfcGF0aEZyb21Eb21Ob2RlID0gZnVuY3Rpb24gKG5vZGUpIHtcbiAgbGV0IHBhdGggPSBudWxsO1xuICBmb3IgKGxldCBhdHRyT2JqIG9mIF8udmFsdWVzKG5vZGUuYXR0cmlidXRlcykpIHtcbiAgICBpZiAoYXR0ck9iai5uYW1lID09PSBcInBhdGhcIikge1xuICAgICAgcGF0aCA9IGF0dHJPYmoudmFsdWU7XG4gICAgfVxuICB9XG4gIHJldHVybiBwYXRoO1xufTtcblxubGV0IF94bWxTb3VyY2VGcm9tSnNvbiA9IGZ1bmN0aW9uIChqc29uU291cmNlKSB7XG4gIGlmICh0eXBlb2YganNvblNvdXJjZSA9PT0gXCJzdHJpbmdcIikge1xuICAgIGpzb25Tb3VyY2UgPSBKU09OLnBhcnNlKGpzb25Tb3VyY2UpO1xuICB9XG4gIHJldHVybiBqczJ4bWwoXCJBcHBpdW1BVVRcIiwganNvblNvdXJjZSwge1xuICAgIHdyYXBBcnJheToge2VuYWJsZWQ6IGZhbHNlLCBlbGVtZW50TmFtZTogXCJlbGVtZW50XCJ9LFxuICAgIGRlY2xhcmF0aW9uOiB7aW5jbHVkZTogdHJ1ZX0sXG4gICAgcHJldHR5UHJpbnRpbmc6IHtpbmRlbnRTdHJpbmc6IFwiICAgIFwifVxuICB9KTtcbn07XG5cbmxldCBfcGVyZm9ybVhwYXRoUXVlcnlPbkpzb24gPSBmdW5jdGlvbiAoc2VsZWN0b3IsIGpzb25Tb3VyY2UpIHtcbiAgbGV0IHhtbFNvdXJjZSA9IF94bWxTb3VyY2VGcm9tSnNvbihqc29uU291cmNlKTtcbiAgbGV0IGRvbSA9IG5ldyBYTUxEb20uRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKHhtbFNvdXJjZSk7XG4gIHJldHVybiB4cGF0aC5zZWxlY3Qoc2VsZWN0b3IsIGRvbSk7XG59O1xuXG5jb21tYW5kcy5maW5kVUlFbGVtZW50c0J5WHBhdGggPSBhc3luYyBmdW5jdGlvbiAoc2VsZWN0b3IsIG11bHQsIGNvbnRleHQgPSBudWxsLCBjdXJSZXRyeSA9IDEpIHtcbiAgbGV0IHNvdXJjZVhtbDtcbiAgdHJ5IHtcbiAgICBzb3VyY2VYbWwgPSBhd2FpdCB0aGlzLmdldFNvdXJjZUZvckVsZW1lbnRGb3JYTUwoY29udGV4dCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZ2dlci53YXJuKFwiRXJyb3IgZ2V0dGluZyBzb3VyY2UsIGNhbid0IGNvbnRpbnVlIGZpbmRpbmcgZWxlbWVudCBieSBYUGF0aFwiKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbiAgbGV0IHNlbGVjdGVkTm9kZXMgPSBfcGVyZm9ybVhwYXRoUXVlcnlPbkpzb24oc2VsZWN0b3IsIHNvdXJjZVhtbCk7XG5cbiAgaWYgKCFtdWx0KSB7XG4gICAgc2VsZWN0ZWROb2RlcyA9IHNlbGVjdGVkTm9kZXMuc2xpY2UoMCwgMSk7XG4gIH1cbiAgbGV0IGluZGV4UGF0aHMgPSBbXTtcbiAgLy8gZmlsdGVyIG91dCBlbGVtZW50cyB3aXRob3V0ICdwYXRoJyBhdHRyaWJ1dGVcbiAgZm9yIChsZXQgbm9kZSBvZiBzZWxlY3RlZE5vZGVzKSB7XG4gICAgbGV0IGlwID0gX3BhdGhGcm9tRG9tTm9kZShub2RlKTtcbiAgICBpZiAoaXAgIT09IG51bGwpIHtcbiAgICAgIGluZGV4UGF0aHMucHVzaChpcCk7XG4gICAgfVxuICB9XG5cbiAgaWYgKGluZGV4UGF0aHMubGVuZ3RoIDwgMSkge1xuICAgIC8vIGFuZCBpZiB3ZSBkb24ndCBoYXZlIGFueSBtYXRjaGluZyBub2RlcywgcmV0dXJuIHRoZSBlbXB0eSBhcnJheVxuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIC8vIG90aGVyd2lzZSBsb29rIHVwIHRoZSBhY3R1YWwgZWxlbWVudCBieSBpdHMgaW5kZXggcGF0aFxuICBsZXQgbWV0aG9kTmFtZTtcbiAgbGV0IG1ldGhvZEFyZ3MgPSBbXTtcblxuICBpZiAoIW11bHQpIHtcbiAgICBtZXRob2ROYW1lID0gXCJnZXRFbGVtZW50QnlJbmRleFBhdGhcIjtcbiAgICBtZXRob2RBcmdzWzBdID0gYCcke2luZGV4UGF0aHNbMF19J2A7XG4gIH0gZWxzZSB7XG4gICAgbWV0aG9kTmFtZSA9IFwiZ2V0RWxlbWVudHNCeUluZGV4UGF0aHNcIjtcbiAgICBtZXRob2RBcmdzWzBdID0gSlNPTi5zdHJpbmdpZnkoaW5kZXhQYXRocyk7XG4gIH1cblxuICBpZiAoY29udGV4dCkge1xuICAgIG1ldGhvZEFyZ3NbMV0gPSBgYXUuZ2V0RWxlbWVudCgnJHtjb250ZXh0fScpYDtcbiAgfVxuXG4gIGxldCBwcm94eUNtZCA9IGBhdS4ke21ldGhvZE5hbWV9KCR7bWV0aG9kQXJncy5qb2luKFwiLCBcIil9KWA7XG5cbiAgLy8gaGF2aW5nIGluZGV4IHBhdGhzIG1lYW5zIHdlIHRoaW5rIGVsZW1lbnRzIHNob3VsZCBiZSB0aGVyZS4gU29tZXRpbWVzXG4gIC8vIHVpYXV0byBsYWdzIGluIGVuYWJsaW5nIHVzIHRvIGdldCBlbGVtZW50cywgc28gd2UgcmV0cnkgYSBmZXcgdGltZXMgaWZcbiAgLy8gaXQgY2FuJ3QgZmluZCBlbGVtZW50cyB3ZSBrbm93IHNob3VsZCBiZSB0aGVyZS4gc2VlIHVpYXV0byBjb2RlXG4gIC8vIGZvciBtb3JlIGxvZ2ljXG4gIGxldCByZXM7XG4gIHRyeSB7XG4gICAgcmVzID0gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQocHJveHlDbWQpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICAvLyB3ZSBnZXQgYSBTdGFsZUVsZW1lbnRSZWZlcmVuY2UgaWYgdWlhdXRvIGNhbid0IGZpbmQgYW4gZWxlbWVudFxuICAgIC8vIGJ5IHRoZSBwYXRoIHdlIG1lbnRpb25lZFxuICAgIGlmIChjdXJSZXRyeSA8IDMpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhcIkdvdCBhIHdhcm5pbmcgZnJvbSB1aWF1dG8gdGhhdCBzb21lIGluZGV4IHBhdGhzIFwiICtcbiAgICAgICAgICAgICAgICAgICBcImNvdWxkIG5vdCBiZSByZXNvbHZlZCwgdHJ5aW5nIGFnYWluXCIpO1xuICAgICAgYXdhaXQgQi5kZWxheSgzMDApO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZFVJRWxlbWVudHNCeVhwYXRoKHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0LCBjdXJSZXRyeSArIDEpO1xuICAgIH1cbiAgICB0aHJvdyBlcnI7XG4gIH1cbiAgcmV0dXJuIHJlcztcbn07XG5cbmhlbHBlcnMuZmluZFNjcm9sbGFibGVFbE9yRWxzID0gYXN5bmMgZnVuY3Rpb24gKG11bHQsIGNvbnRleHQpIHtcbiAgY29uc3Qgc2Nyb2xsVHlwZXMgPSBbJ1VJQVNjcm9sbFZpZXcnLCAnVUlBVGFibGVWaWV3JywgJ1VJQUNvbGxlY3Rpb25WaWV3JywgJ1VJQVdlYlZpZXcnXTtcbiAgbGV0IHJlcyA9IFtdO1xuICBjb25zdCBleHQgPSBtdWx0ID8gJ3MnIDogJyc7XG4gIGZvciAoY29uc3Qgc2Nyb2xsVHlwZSBvZiBzY3JvbGxUeXBlcykge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBgYXUuZ2V0RWxlbWVudCR7ZXh0fUJ5VHlwZSgnJHtzY3JvbGxUeXBlfScke2NvbnRleHR9KWA7XG5cbiAgICBpZiAobXVsdCkge1xuICAgICAgbGV0IGVsZW1lbnRzID0gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoY29tbWFuZCk7XG4gICAgICBpZiAoIV8uaXNFbXB0eShlbGVtZW50cykpIHtcbiAgICAgICAgcmVzLnB1c2goLi4uZWxlbWVudHMpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgZWxlbWVudCA9IGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGNvbW1hbmQpO1xuICAgICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgICAgcmV0dXJuIGVsZW1lbnQ7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKG11bHQpIHtcbiAgICByZXR1cm4gcmVzO1xuICB9XG5cbiAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hFbGVtZW50RXJyb3IoKTtcbn07XG5cbmhlbHBlcnMuZ2V0Rmlyc3RWaXNpYmxlQ2hpbGQgPSBhc3luYyBmdW5jdGlvbiAoZWxlbWVudElkKSB7XG4gIGxldCB2aXNpYmxlRWxzID0gYXdhaXQgdGhpcy5maW5kRWxlbWVudHNGcm9tRWxlbWVudCgnLWlvcyB1aWF1dG9tYXRpb24nLCAnLmVsZW1lbnRzKCkud2l0aFByZWRpY2F0ZShcImlzVmlzaWJsZSA9PSAxXCIpOycsIGVsZW1lbnRJZCk7XG4gIHJldHVybiBfLmZpcnN0KHZpc2libGVFbHMpO1xufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL2ZpbmQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
