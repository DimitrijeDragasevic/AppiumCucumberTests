"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setLocale = setLocale;
exports.setPreferences = setPreferences;
exports.setLocaleAndPreferences = setLocaleAndPreferences;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

const SETTINGS_CAPS = ['locationServicesEnabled', 'locationServicesAuthorized'];
const SAFARI_SETTINGS_CAPS = ['safariAllowPopups', 'safariIgnoreFraudWarning', 'safariOpenLinksInBackground'];

async function launchAndQuitSimulator(sim, safari) {
  _logger.default.debug('No simulator directories found.');

  return await sim.launchAndQuit(safari);
}

function checkPreferences(settings, opts = {}) {
  for (let setting of settings) {
    if (_lodash.default.has(opts, setting)) {
      return true;
    }
  }

  return false;
}

async function setLocaleAndPreferences(sim, opts, safari = false, shutdownFn = _lodash.default.noop) {
  const localConfig = await setLocale(sim, opts, {}, safari);
  const prefsUpdated = await setPreferences(sim, opts, safari);

  if (localConfig._updated || prefsUpdated) {
    _logger.default.debug("Updated settings. Rebooting the simulator if it's already open");

    await shutdownFn(sim);
  }

  delete localConfig._updated;
  return localConfig;
}

async function setLocale(sim, opts, localeConfig = {}, safari = false) {
  if (!opts.language && !opts.locale && !opts.calendarFormat) {
    _logger.default.debug("No reason to set locale");

    return {
      _updated: false
    };
  }

  if (await sim.isFresh()) {
    await launchAndQuitSimulator(sim, safari);
  }

  _logger.default.debug('Setting locale information');

  localeConfig = {
    language: opts.language || localeConfig.language,
    locale: opts.locale || localeConfig.locale,
    calendarFormat: opts.calendarFormat || localeConfig.calendarFormat,
    _updated: false
  };

  try {
    let updated = await sim.updateLocale(opts.language, opts.locale, opts.calendarFormat);

    if (updated) {
      localeConfig._updated = true;
    }
  } catch (e) {
    _logger.default.errorAndThrow(`Appium was unable to set locale info: ${e}`);
  }

  return localeConfig;
}

async function setPreferences(sim, opts, safari = false) {
  let needToSetPrefs = checkPreferences(SETTINGS_CAPS, opts);
  let needToSetSafariPrefs = checkPreferences(SAFARI_SETTINGS_CAPS, opts);

  if (!needToSetPrefs && !needToSetSafariPrefs) {
    _logger.default.debug("No iOS / app preferences to set");

    return false;
  }

  _logger.default.debug("Setting iOS and app preferences");

  if (await sim.isFresh()) {
    await launchAndQuitSimulator(sim, safari);
  }

  try {
    if (needToSetPrefs) {
      await setLocServicesPrefs(sim, opts);
    }
  } catch (e) {
    _logger.default.error("Error setting location services preferences, prefs will not work");

    _logger.default.error(e);
  }

  try {
    if (needToSetSafariPrefs) {
      await setSafariPrefs(sim, opts);
    }
  } catch (e) {
    _logger.default.error("Error setting safari preferences, prefs will not work");

    _logger.default.error(e);
  }

  return true;
}

async function setLocServicesPrefs(sim, opts = {}) {
  let locServ = _lodash.default.find([opts.locationServicesEnabled, opts.locationServicesAuthorized], c => {
    return !_lodash.default.isUndefined(c);
  });

  if (!_lodash.default.isUndefined(locServ)) {
    locServ = locServ ? 1 : 0;

    _logger.default.debug(`Setting location services to ${locServ}`);

    await sim.updateSettings('locationServices', {
      LocationServicesEnabled: locServ,
      'LocationServicesEnabledIn7.0': locServ,
      'LocationServicesEnabledIn8.0': locServ
    });
  }

  if (!_lodash.default.isUndefined(opts.locationServicesAuthorized)) {
    if (!opts.bundleId) {
      let msg = "Can't set location services for app without bundle ID";

      _logger.default.errorAndThrow(msg);
    }

    let locAuth = !!opts.locationServicesAuthorized;

    if (locAuth) {
      _logger.default.debug("Authorizing location services for app");
    } else {
      _logger.default.debug("De-authorizing location services for app");
    }

    await sim.updateLocationSettings(opts.bundleId, locAuth);
  }
}

async function setSafariPrefs(sim, opts = {}) {
  let safariSettings = {};

  if (_lodash.default.has(opts, 'safariAllowPopups')) {
    let val = !!opts.safariAllowPopups;

    _logger.default.debug(`Setting javascript window opening to '${val}'`);

    safariSettings.WebKitJavaScriptCanOpenWindowsAutomatically = val;
    safariSettings.JavaScriptCanOpenWindowsAutomatically = val;
  }

  if (_lodash.default.has(opts, 'safariIgnoreFraudWarning')) {
    let val = !opts.safariIgnoreFraudWarning;

    _logger.default.debug(`Setting fraudulent website warning to '${val}'`);

    safariSettings.WarnAboutFraudulentWebsites = val;
  }

  if (_lodash.default.has(opts, 'safariOpenLinksInBackground')) {
    let val = opts.safariOpenLinksInBackground ? 1 : 0;

    _logger.default.debug(`Setting opening links in background to '${!!val}'`);

    safariSettings.OpenLinksInBackground = val;
  }

  if (_lodash.default.size(safariSettings) > 0) {
    await sim.updateSafariSettings(safariSettings);
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zZXR0aW5ncy5qcyJdLCJuYW1lcyI6WyJTRVRUSU5HU19DQVBTIiwiU0FGQVJJX1NFVFRJTkdTX0NBUFMiLCJsYXVuY2hBbmRRdWl0U2ltdWxhdG9yIiwic2ltIiwic2FmYXJpIiwibG9nZ2VyIiwiZGVidWciLCJsYXVuY2hBbmRRdWl0IiwiY2hlY2tQcmVmZXJlbmNlcyIsInNldHRpbmdzIiwib3B0cyIsInNldHRpbmciLCJfIiwiaGFzIiwic2V0TG9jYWxlQW5kUHJlZmVyZW5jZXMiLCJzaHV0ZG93bkZuIiwibm9vcCIsImxvY2FsQ29uZmlnIiwic2V0TG9jYWxlIiwicHJlZnNVcGRhdGVkIiwic2V0UHJlZmVyZW5jZXMiLCJfdXBkYXRlZCIsImxvY2FsZUNvbmZpZyIsImxhbmd1YWdlIiwibG9jYWxlIiwiY2FsZW5kYXJGb3JtYXQiLCJpc0ZyZXNoIiwidXBkYXRlZCIsInVwZGF0ZUxvY2FsZSIsImUiLCJlcnJvckFuZFRocm93IiwibmVlZFRvU2V0UHJlZnMiLCJuZWVkVG9TZXRTYWZhcmlQcmVmcyIsInNldExvY1NlcnZpY2VzUHJlZnMiLCJlcnJvciIsInNldFNhZmFyaVByZWZzIiwibG9jU2VydiIsImZpbmQiLCJsb2NhdGlvblNlcnZpY2VzRW5hYmxlZCIsImxvY2F0aW9uU2VydmljZXNBdXRob3JpemVkIiwiYyIsImlzVW5kZWZpbmVkIiwidXBkYXRlU2V0dGluZ3MiLCJMb2NhdGlvblNlcnZpY2VzRW5hYmxlZCIsImJ1bmRsZUlkIiwibXNnIiwibG9jQXV0aCIsInVwZGF0ZUxvY2F0aW9uU2V0dGluZ3MiLCJzYWZhcmlTZXR0aW5ncyIsInZhbCIsInNhZmFyaUFsbG93UG9wdXBzIiwiV2ViS2l0SmF2YVNjcmlwdENhbk9wZW5XaW5kb3dzQXV0b21hdGljYWxseSIsIkphdmFTY3JpcHRDYW5PcGVuV2luZG93c0F1dG9tYXRpY2FsbHkiLCJzYWZhcmlJZ25vcmVGcmF1ZFdhcm5pbmciLCJXYXJuQWJvdXRGcmF1ZHVsZW50V2Vic2l0ZXMiLCJzYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQiLCJPcGVuTGlua3NJbkJhY2tncm91bmQiLCJzaXplIiwidXBkYXRlU2FmYXJpU2V0dGluZ3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFHQSxNQUFNQSxhQUFhLEdBQUcsQ0FDcEIseUJBRG9CLEVBRXBCLDRCQUZvQixDQUF0QjtBQUlBLE1BQU1DLG9CQUFvQixHQUFHLENBQzNCLG1CQUQyQixFQUUzQiwwQkFGMkIsRUFHM0IsNkJBSDJCLENBQTdCOztBQU1BLGVBQWVDLHNCQUFmLENBQXVDQyxHQUF2QyxFQUE0Q0MsTUFBNUMsRUFBb0Q7QUFDbERDLGtCQUFPQyxLQUFQLENBQWEsaUNBQWI7O0FBQ0EsU0FBTyxNQUFNSCxHQUFHLENBQUNJLGFBQUosQ0FBa0JILE1BQWxCLENBQWI7QUFDRDs7QUFFRCxTQUFTSSxnQkFBVCxDQUEyQkMsUUFBM0IsRUFBcUNDLElBQUksR0FBRyxFQUE1QyxFQUFnRDtBQUM5QyxPQUFLLElBQUlDLE9BQVQsSUFBb0JGLFFBQXBCLEVBQThCO0FBQzVCLFFBQUlHLGdCQUFFQyxHQUFGLENBQU1ILElBQU4sRUFBWUMsT0FBWixDQUFKLEVBQTBCO0FBQ3hCLGFBQU8sSUFBUDtBQUNEO0FBQ0Y7O0FBQ0QsU0FBTyxLQUFQO0FBQ0Q7O0FBRUQsZUFBZUcsdUJBQWYsQ0FBd0NYLEdBQXhDLEVBQTZDTyxJQUE3QyxFQUFtRE4sTUFBTSxHQUFHLEtBQTVELEVBQW1FVyxVQUFVLEdBQUdILGdCQUFFSSxJQUFsRixFQUF3RjtBQUN0RixRQUFNQyxXQUFXLEdBQUcsTUFBTUMsU0FBUyxDQUFDZixHQUFELEVBQU1PLElBQU4sRUFBWSxFQUFaLEVBQWdCTixNQUFoQixDQUFuQztBQUNBLFFBQU1lLFlBQVksR0FBRyxNQUFNQyxjQUFjLENBQUNqQixHQUFELEVBQU1PLElBQU4sRUFBWU4sTUFBWixDQUF6Qzs7QUFDQSxNQUFJYSxXQUFXLENBQUNJLFFBQVosSUFBd0JGLFlBQTVCLEVBQTBDO0FBQ3hDZCxv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NkMsSUFBRixDQUFPVCxjQUFQLElBQXlCLENBQTdCLEVBQWdDO0FBQzlCLFVBQU03QyxHQUFHLENBQUN1RCxvQkFBSixDQUF5QlYsY0FBekIsQ0FBTjtBQUNEO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5cblxuY29uc3QgU0VUVElOR1NfQ0FQUyA9IFtcbiAgJ2xvY2F0aW9uU2VydmljZXNFbmFibGVkJyxcbiAgJ2xvY2F0aW9uU2VydmljZXNBdXRob3JpemVkJyxcbl07XG5jb25zdCBTQUZBUklfU0VUVElOR1NfQ0FQUyA9IFtcbiAgJ3NhZmFyaUFsbG93UG9wdXBzJyxcbiAgJ3NhZmFyaUlnbm9yZUZyYXVkV2FybmluZycsXG4gICdzYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQnLFxuXTtcblxuYXN5bmMgZnVuY3Rpb24gbGF1bmNoQW5kUXVpdFNpbXVsYXRvciAoc2ltLCBzYWZhcmkpIHtcbiAgbG9nZ2VyLmRlYnVnKCdObyBzaW11bGF0b3IgZGlyZWN0b3JpZXMgZm91bmQuJyk7XG4gIHJldHVybiBhd2FpdCBzaW0ubGF1bmNoQW5kUXVpdChzYWZhcmkpO1xufVxuXG5mdW5jdGlvbiBjaGVja1ByZWZlcmVuY2VzIChzZXR0aW5ncywgb3B0cyA9IHt9KSB7XG4gIGZvciAobGV0IHNldHRpbmcgb2Ygc2V0dGluZ3MpIHtcbiAgICBpZiAoXy5oYXMob3B0cywgc2V0dGluZykpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldExvY2FsZUFuZFByZWZlcmVuY2VzIChzaW0sIG9wdHMsIHNhZmFyaSA9IGZhbHNlLCBzaHV0ZG93bkZuID0gXy5ub29wKSB7XG4gIGNvbnN0IGxvY2FsQ29uZmlnID0gYXdhaXQgc2V0TG9jYWxlKHNpbSwgb3B0cywge30sIHNhZmFyaSk7XG4gIGNvbnN0IHByZWZzVXBkYXRlZCA9IGF3YWl0IHNldFByZWZlcmVuY2VzKHNpbSwgb3B0cywgc2FmYXJpKTtcbiAgaWYgKGxvY2FsQ29uZmlnLl91cGRhdGVkIHx8IHByZWZzVXBkYXRlZCkge1xuICAgIGxvZ2dlci5kZWJ1ZyhcIlVwZGF0ZWQgc2V0dGluZ3MuIFJlYm9vdGluZyB0aGUgc2ltdWxhdG9yIGlmIGl0J3MgYWxyZWFkeSBvcGVuXCIpO1xuICAgIGF3YWl0IHNodXRkb3duRm4oc2ltKTtcbiAgfVxuICBkZWxldGUgbG9jYWxDb25maWcuX3VwZGF0ZWQ7XG4gIHJldHVybiBsb2NhbENvbmZpZztcbn1cblxuLy8gcGFzcyBpbiB0aGUgc2ltdWxhdG9yIHNvIHRoYXQgb3RoZXIgc3lzdGVtcyB0aGF0IHVzZSB0aGUgZnVuY3Rpb24gY2FuIHN1cHBseVxuLy8gd2hhdGV2ZXIgdGhleSBoYXZlXG5hc3luYyBmdW5jdGlvbiBzZXRMb2NhbGUgKHNpbSwgb3B0cywgbG9jYWxlQ29uZmlnID0ge30sIHNhZmFyaSA9IGZhbHNlKSB7XG4gIGlmICghb3B0cy5sYW5ndWFnZSAmJiAhb3B0cy5sb2NhbGUgJiYgIW9wdHMuY2FsZW5kYXJGb3JtYXQpIHtcbiAgICBsb2dnZXIuZGVidWcoXCJObyByZWFzb24gdG8gc2V0IGxvY2FsZVwiKTtcbiAgICByZXR1cm4ge1xuICAgICAgX3VwZGF0ZWQ6IGZhbHNlLFxuICAgIH07XG4gIH1cblxuICAvLyB3ZSBuZWVkIHRoZSBzaW11bGF0b3IgdG8gaGF2ZSBpdHMgZGlyZWN0b3JpZXMgaW4gcGxhY2VcbiAgaWYgKGF3YWl0IHNpbS5pc0ZyZXNoKCkpIHtcbiAgICBhd2FpdCBsYXVuY2hBbmRRdWl0U2ltdWxhdG9yKHNpbSwgc2FmYXJpKTtcbiAgfVxuXG4gIGxvZ2dlci5kZWJ1ZygnU2V0dGluZyBsb2NhbGUgaW5mb3JtYXRpb24nKTtcbiAgbG9jYWxlQ29uZmlnID0ge1xuICAgIGxhbmd1YWdlOiBvcHRzLmxhbmd1YWdlIHx8IGxvY2FsZUNvbmZpZy5sYW5ndWFnZSxcbiAgICBsb2NhbGU6IG9wdHMubG9jYWxlIHx8IGxvY2FsZUNvbmZpZy5sb2NhbGUsXG4gICAgY2FsZW5kYXJGb3JtYXQ6IG9wdHMuY2FsZW5kYXJGb3JtYXQgfHwgbG9jYWxlQ29uZmlnLmNhbGVuZGFyRm9ybWF0LFxuICAgIF91cGRhdGVkOiBmYWxzZSxcbiAgfTtcblxuICB0cnkge1xuICAgIGxldCB1cGRhdGVkID0gYXdhaXQgc2ltLnVwZGF0ZUxvY2FsZShvcHRzLmxhbmd1YWdlLCBvcHRzLmxvY2FsZSwgb3B0cy5jYWxlbmRhckZvcm1hdCk7XG4gICAgaWYgKHVwZGF0ZWQpIHtcbiAgICAgIGxvY2FsZUNvbmZpZy5fdXBkYXRlZCA9IHRydWU7XG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nZ2VyLmVycm9yQW5kVGhyb3coYEFwcGl1bSB3YXMgdW5hYmxlIHRvIHNldCBsb2NhbGUgaW5mbzogJHtlfWApO1xuICB9XG5cbiAgcmV0dXJuIGxvY2FsZUNvbmZpZztcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0UHJlZmVyZW5jZXMgKHNpbSwgb3B0cywgc2FmYXJpID0gZmFsc2UpIHtcbiAgbGV0IG5lZWRUb1NldFByZWZzID0gY2hlY2tQcmVmZXJlbmNlcyhTRVRUSU5HU19DQVBTLCBvcHRzKTtcbiAgbGV0IG5lZWRUb1NldFNhZmFyaVByZWZzID0gY2hlY2tQcmVmZXJlbmNlcyhTQUZBUklfU0VUVElOR1NfQ0FQUywgb3B0cyk7XG4gIGlmICghbmVlZFRvU2V0UHJlZnMgJiYgIW5lZWRUb1NldFNhZmFyaVByZWZzKSB7XG4gICAgbG9nZ2VyLmRlYnVnKFwiTm8gaU9TIC8gYXBwIHByZWZlcmVuY2VzIHRvIHNldFwiKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBsb2dnZXIuZGVidWcoXCJTZXR0aW5nIGlPUyBhbmQgYXBwIHByZWZlcmVuY2VzXCIpO1xuXG4gIGlmIChhd2FpdCBzaW0uaXNGcmVzaCgpKSB7XG4gICAgYXdhaXQgbGF1bmNoQW5kUXVpdFNpbXVsYXRvcihzaW0sIHNhZmFyaSk7XG4gIH1cblxuICB0cnkge1xuICAgIGlmIChuZWVkVG9TZXRQcmVmcykge1xuICAgICAgYXdhaXQgc2V0TG9jU2VydmljZXNQcmVmcyhzaW0sIG9wdHMpO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZ2dlci5lcnJvcihcIkVycm9yIHNldHRpbmcgbG9jYXRpb24gc2VydmljZXMgcHJlZmVyZW5jZXMsIHByZWZzIHdpbGwgbm90IHdvcmtcIik7XG4gICAgbG9nZ2VyLmVycm9yKGUpO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBpZiAobmVlZFRvU2V0U2FmYXJpUHJlZnMpIHtcbiAgICAgIGF3YWl0IHNldFNhZmFyaVByZWZzKHNpbSwgb3B0cyk7XG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nZ2VyLmVycm9yKFwiRXJyb3Igc2V0dGluZyBzYWZhcmkgcHJlZmVyZW5jZXMsIHByZWZzIHdpbGwgbm90IHdvcmtcIik7XG4gICAgbG9nZ2VyLmVycm9yKGUpO1xuICB9XG5cbiAgcmV0dXJuIHRydWU7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldExvY1NlcnZpY2VzUHJlZnMgKHNpbSwgb3B0cyA9IHt9KSB7XG4gIGxldCBsb2NTZXJ2ID0gXy5maW5kKFtvcHRzLmxvY2F0aW9uU2VydmljZXNFbmFibGVkLCBvcHRzLmxvY2F0aW9uU2VydmljZXNBdXRob3JpemVkXSwgKGMpID0+IHtcbiAgICByZXR1cm4gIV8uaXNVbmRlZmluZWQoYyk7XG4gIH0pO1xuICBpZiAoIV8uaXNVbmRlZmluZWQobG9jU2VydikpIHtcbiAgICBsb2NTZXJ2ID0gbG9jU2VydiA/IDEgOiAwO1xuICAgIGxvZ2dlci5kZWJ1ZyhgU2V0dGluZyBsb2NhdGlvbiBzZXJ2aWNlcyB0byAke2xvY1NlcnZ9YCk7XG4gICAgYXdhaXQgc2ltLnVwZGF0ZVNldHRpbmdzKCdsb2NhdGlvblNlcnZpY2VzJywge1xuICAgICAgTG9jYXRpb25TZXJ2aWNlc0VuYWJsZWQ6IGxvY1NlcnYsXG4gICAgICAnTG9jYXRpb25TZXJ2aWNlc0VuYWJsZWRJbjcuMCc6IGxvY1NlcnYsXG4gICAgICAnTG9jYXRpb25TZXJ2aWNlc0VuYWJsZWRJbjguMCc6IGxvY1NlcnZcbiAgICB9KTtcbiAgfVxuICBpZiAoIV8uaXNVbmRlZmluZWQob3B0cy5sb2NhdGlvblNlcnZpY2VzQXV0aG9yaXplZCkpIHtcbiAgICBpZiAoIW9wdHMuYnVuZGxlSWQpIHtcbiAgICAgIGxldCBtc2cgPSBcIkNhbid0IHNldCBsb2NhdGlvbiBzZXJ2aWNlcyBmb3IgYXBwIHdpdGhvdXQgYnVuZGxlIElEXCI7XG4gICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhtc2cpO1xuICAgIH1cbiAgICBsZXQgbG9jQXV0aCA9ICEhb3B0cy5sb2NhdGlvblNlcnZpY2VzQXV0aG9yaXplZDtcbiAgICBpZiAobG9jQXV0aCkge1xuICAgICAgbG9nZ2VyLmRlYnVnKFwiQXV0aG9yaXppbmcgbG9jYXRpb24gc2VydmljZXMgZm9yIGFwcFwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nZ2VyLmRlYnVnKFwiRGUtYXV0aG9yaXppbmcgbG9jYXRpb24gc2VydmljZXMgZm9yIGFwcFwiKTtcbiAgICB9XG4gICAgYXdhaXQgc2ltLnVwZGF0ZUxvY2F0aW9uU2V0dGluZ3Mob3B0cy5idW5kbGVJZCwgbG9jQXV0aCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0U2FmYXJpUHJlZnMgKHNpbSwgb3B0cyA9IHt9KSB7XG4gIGxldCBzYWZhcmlTZXR0aW5ncyA9IHt9O1xuXG4gIGlmIChfLmhhcyhvcHRzLCAnc2FmYXJpQWxsb3dQb3B1cHMnKSkge1xuICAgIGxldCB2YWwgPSAhIW9wdHMuc2FmYXJpQWxsb3dQb3B1cHM7XG4gICAgbG9nZ2VyLmRlYnVnKGBTZXR0aW5nIGphdmFzY3JpcHQgd2luZG93IG9wZW5pbmcgdG8gJyR7dmFsfSdgKTtcbiAgICBzYWZhcmlTZXR0aW5ncy5XZWJLaXRKYXZhU2NyaXB0Q2FuT3BlbldpbmRvd3NBdXRvbWF0aWNhbGx5ID0gdmFsO1xuICAgIHNhZmFyaVNldHRpbmdzLkphdmFTY3JpcHRDYW5PcGVuV2luZG93c0F1dG9tYXRpY2FsbHkgPSB2YWw7XG4gIH1cbiAgaWYgKF8uaGFzKG9wdHMsICdzYWZhcmlJZ25vcmVGcmF1ZFdhcm5pbmcnKSkge1xuICAgIGxldCB2YWwgPSAhb3B0cy5zYWZhcmlJZ25vcmVGcmF1ZFdhcm5pbmc7XG4gICAgbG9nZ2VyLmRlYnVnKGBTZXR0aW5nIGZyYXVkdWxlbnQgd2Vic2l0ZSB3YXJuaW5nIHRvICcke3ZhbH0nYCk7XG4gICAgc2FmYXJpU2V0dGluZ3MuV2FybkFib3V0RnJhdWR1bGVudFdlYnNpdGVzID0gdmFsO1xuICB9XG4gIGlmIChfLmhhcyhvcHRzLCAnc2FmYXJpT3BlbkxpbmtzSW5CYWNrZ3JvdW5kJykpIHtcbiAgICBsZXQgdmFsID0gb3B0cy5zYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQgPyAxIDogMDtcbiAgICBsb2dnZXIuZGVidWcoYFNldHRpbmcgb3BlbmluZyBsaW5rcyBpbiBiYWNrZ3JvdW5kIHRvICckeyEhdmFsfSdgKTtcbiAgICBzYWZhcmlTZXR0aW5ncy5PcGVuTGlua3NJbkJhY2tncm91bmQgPSB2YWw7XG4gIH1cbiAgaWYgKF8uc2l6ZShzYWZhcmlTZXR0aW5ncykgPiAwKSB7XG4gICAgYXdhaXQgc2ltLnVwZGF0ZVNhZmFyaVNldHRpbmdzKHNhZmFyaVNldHRpbmdzKTtcbiAgfVxufVxuXG5leHBvcnQgeyBzZXRMb2NhbGUsIHNldFByZWZlcmVuY2VzLCBzZXRMb2NhbGVBbmRQcmVmZXJlbmNlcyB9O1xuIl0sImZpbGUiOiJsaWIvc2V0dGluZ3MuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
