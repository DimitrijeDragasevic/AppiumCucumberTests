"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _fs2 = _interopRequireDefault(require("fs"));

var _url = _interopRequireDefault(require("url"));

var _asyncbox = require("asyncbox");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _teen_process = require("teen_process");

var _path = _interopRequireDefault(require("path"));

var _v = _interopRequireDefault(require("v8"));

let commands = {},
    extensions = {};
exports.commands = commands;
const RETRY_PAUSE = 300;
const RETRY_TIMEOUT = 5000;
const MAX_RECORDING_TIME_SEC = 60 * 3;
const MAX_TIME_SEC = 60 * 30;
const DEFAULT_RECORDING_TIME_SEC = MAX_RECORDING_TIME_SEC;
const PROCESS_SHUTDOWN_TIMEOUT = 10 * 1000;
const SCREENRECORD_BINARY = 'screenrecord';
const DEFAULT_EXT = '.mp4';
const MIN_EMULATOR_API_LEVEL = 27;
const FFMPEG_BINARY = `ffmpeg${_appiumSupport.system.isWindows() ? '.exe' : ''}`;

async function uploadRecordedMedia(adb, localFile, remotePath = null, uploadOptions = {}) {
  const {
    size
  } = await _appiumSupport.fs.stat(localFile);

  _logger.default.debug(`The size of the resulting screen recording is ${_appiumSupport.util.toReadableSizeString(size)}`);

  if (_lodash.default.isEmpty(remotePath)) {
    const maxMemoryLimit = _v.default.getHeapStatistics().total_available_size / 2;

    if (size >= maxMemoryLimit) {
      _logger.default.info(`The file might be too large to fit into the process memory ` + `(${_appiumSupport.util.toReadableSizeString(size)} >= ${_appiumSupport.util.toReadableSizeString(maxMemoryLimit)}). ` + `Provide a link to a remote writable location for video upload ` + `(http(s) and ftp protocols are supported) if you experience Out Of Memory errors`);
    }

    return (await _appiumSupport.fs.readFile(localFile)).toString('base64');
  }

  const remoteUrl = _url.default.parse(remotePath);

  let options = {};
  const {
    user,
    pass,
    method
  } = uploadOptions;

  if (remoteUrl.protocol.startsWith('http')) {
    options = {
      url: remoteUrl.href,
      method: method || 'PUT',
      multipart: [{
        body: _fs2.default.createReadStream(localFile)
      }]
    };

    if (user && pass) {
      options.auth = {
        user,
        pass
      };
    }
  } else if (remoteUrl.protocol.startsWith('ftp')) {
    options = {
      host: remoteUrl.hostname,
      port: remoteUrl.port || 21
    };

    if (user && pass) {
      options.user = user;
      options.pass = pass;
    }
  }

  await _appiumSupport.net.uploadFile(localFile, remotePath, options);
  return '';
}

async function verifyScreenRecordIsSupported(adb, isEmulator) {
  const apiLevel = await adb.getApiLevel();

  if (isEmulator && apiLevel < MIN_EMULATOR_API_LEVEL) {
    throw new Error(`Screen recording does not work on emulators running Android API level less than ${MIN_EMULATOR_API_LEVEL}`);
  }

  if (apiLevel < 19) {
    throw new Error(`Screen recording not available on API Level ${apiLevel}. Minimum API Level is 19.`);
  }
}

async function scheduleScreenRecord(adb, recordingProperties) {
  if (recordingProperties.stopped) {
    return;
  }

  const {
    startTimestamp,
    videoSize,
    bitRate,
    timeLimit,
    bugReport
  } = recordingProperties;
  let currentTimeLimit = MAX_RECORDING_TIME_SEC;

  if (_appiumSupport.util.hasValue(recordingProperties.currentTimeLimit)) {
    const currentTimeLimitInt = parseInt(recordingProperties.currentTimeLimit, 10);

    if (!isNaN(currentTimeLimitInt) && currentTimeLimitInt < MAX_RECORDING_TIME_SEC) {
      currentTimeLimit = currentTimeLimitInt;
    }
  }

  const pathOnDevice = `/sdcard/${Math.floor(new Date())}${DEFAULT_EXT}`;
  const recordingProc = adb.screenrecord(pathOnDevice, {
    videoSize,
    bitRate,
    timeLimit: currentTimeLimit,
    bugReport
  });
  recordingProc.on('end', () => {
    if (recordingProperties.stopped || !_appiumSupport.util.hasValue(timeLimit)) {
      return;
    }

    const currentDuration = process.hrtime(startTimestamp)[0];

    _logger.default.debug(`The overall screen recording duration is ${currentDuration}s so far`);

    const timeLimitInt = parseInt(timeLimit, 10);

    if (isNaN(timeLimitInt) || currentDuration >= timeLimitInt) {
      _logger.default.debug('There is no need to start the next recording chunk');

      return;
    }

    recordingProperties.currentTimeLimit = timeLimitInt - currentDuration;
    const chunkDuration = recordingProperties.currentTimeLimit < MAX_RECORDING_TIME_SEC ? recordingProperties.currentTimeLimit : MAX_RECORDING_TIME_SEC;

    _logger.default.debug(`Starting the next ${chunkDuration}s-chunk ` + `of screen recording in order to achieve ${timeLimitInt}s total duration`);

    scheduleScreenRecord(adb, recordingProperties).catch(e => {
      _logger.default.error(e.stack);

      recordingProperties.stopped = true;
    });
  });
  await recordingProc.start(0);

  try {
    await (0, _asyncbox.waitForCondition)(async () => await adb.fileExists(pathOnDevice), {
      waitMs: RETRY_TIMEOUT,
      intervalMs: RETRY_PAUSE
    });
  } catch (e) {
    throw new Error(`The expected screen record file '${pathOnDevice}' does not exist after ${RETRY_TIMEOUT}ms`);
  }

  recordingProperties.records.push(pathOnDevice);
  recordingProperties.recordingProcess = recordingProc;
}

async function mergeScreenRecords(mediaFiles) {
  try {
    await _appiumSupport.fs.which(FFMPEG_BINARY);
  } catch (e) {
    throw new Error(`${FFMPEG_BINARY} utility is not available in PATH. Please install it from https://www.ffmpeg.org/`);
  }

  const configContent = mediaFiles.map(x => `file '${x}'`).join('\n');

  const configFile = _path.default.resolve(_path.default.dirname(mediaFiles[0]), 'config.txt');

  await _appiumSupport.fs.writeFile(configFile, configContent, 'utf8');

  _logger.default.debug(`Generated ffmpeg merging config '${configFile}' with items:\n${configContent}`);

  const result = _path.default.resolve(_path.default.dirname(mediaFiles[0]), `merge_${Math.floor(new Date())}${DEFAULT_EXT}`);

  const args = ['-safe', '0', '-f', 'concat', '-i', configFile, '-c', 'copy', result];

  _logger.default.info(`Initiating screen records merging using the command '${FFMPEG_BINARY} ${args.join(' ')}'`);

  await (0, _teen_process.exec)(FFMPEG_BINARY, args);
  return result;
}

async function terminateBackgroundScreenRecording(adb, force = true) {
  const pids = (await adb.getPIDsByName(SCREENRECORD_BINARY)).map(p => `${p}`);

  if (_lodash.default.isEmpty(pids)) {
    return false;
  }

  try {
    await adb.shell(['kill', force ? '-15' : '-2', ...pids]);
    await (0, _asyncbox.waitForCondition)(async () => _lodash.default.isEmpty((await adb.getPIDsByName(SCREENRECORD_BINARY))), {
      waitMs: PROCESS_SHUTDOWN_TIMEOUT,
      intervalMs: 500
    });
    return true;
  } catch (err) {
    throw new Error(`Unable to stop the background screen recording: ${err.message}`);
  }
}

commands.startRecordingScreen = async function startRecordingScreen(options = {}) {
  await verifyScreenRecordIsSupported(this.adb, this.isEmulator());
  let result = '';
  const {
    videoSize,
    timeLimit = DEFAULT_RECORDING_TIME_SEC,
    bugReport,
    bitRate,
    forceRestart
  } = options;

  if (!forceRestart) {
    result = await this.stopRecordingScreen(options);
  }

  if (await terminateBackgroundScreenRecording(this.adb, true)) {
    _logger.default.warn(`There were some ${SCREENRECORD_BINARY} process leftovers running ` + `in the background. Make sure you stop screen recording each time after it is started, ` + `otherwise the recorded media might quickly exceed all the free space on the device under test.`);
  }

  if (!_lodash.default.isEmpty(this._screenRecordingProperties)) {
    for (const record of this._screenRecordingProperties.records || []) {
      await this.adb.rimraf(record);
    }

    this._screenRecordingProperties = null;
  }

  const timeout = parseFloat(timeLimit);

  if (isNaN(timeout) || timeout > MAX_TIME_SEC || timeout <= 0) {
    throw new Error(`The timeLimit value must be in range [1, ${MAX_TIME_SEC}] seconds. ` + `The value of '${timeLimit}' has been passed instead.`);
  }

  this._screenRecordingProperties = {
    startTimestamp: process.hrtime(),
    videoSize,
    timeLimit,
    currentTimeLimit: timeLimit,
    bitRate,
    bugReport,
    records: [],
    recordingProcess: null,
    stopped: false
  };
  await scheduleScreenRecord(this.adb, this._screenRecordingProperties);
  return result;
};

commands.stopRecordingScreen = async function stopRecordingScreen(options = {}) {
  await verifyScreenRecordIsSupported(this.adb, this.isEmulator());

  if (!_lodash.default.isEmpty(this._screenRecordingProperties)) {
    this._screenRecordingProperties.stopped = true;
  }

  try {
    await terminateBackgroundScreenRecording(this.adb, false);
  } catch (err) {
    _logger.default.warn(err.message);

    if (!_lodash.default.isEmpty(this._screenRecordingProperties)) {
      _logger.default.warn('The resulting video might be corrupted');
    }
  }

  if (_lodash.default.isEmpty(this._screenRecordingProperties)) {
    _logger.default.info(`Screen recording has not been previously started by Appium. There is nothing to stop`);

    return '';
  }

  if (this._screenRecordingProperties.recordingProcess && this._screenRecordingProperties.recordingProcess.isRunning) {
    try {
      await this._screenRecordingProperties.recordingProcess.stop('SIGINT', PROCESS_SHUTDOWN_TIMEOUT);
    } catch (e) {
      _logger.default.errorAndThrow(`Unable to stop screen recording within ${PROCESS_SHUTDOWN_TIMEOUT}ms`);
    }

    this._screenRecordingProperties.recordingProcess = null;
  }

  if (_lodash.default.isEmpty(this._screenRecordingProperties.records)) {
    _logger.default.errorAndThrow(`No screen recordings have been stored on the device so far. ` + `Are you sure the ${SCREENRECORD_BINARY} utility works as expected?`);
  }

  const tmpRoot = await _appiumSupport.tempDir.openDir();

  try {
    const localRecords = [];

    for (const pathOnDevice of this._screenRecordingProperties.records) {
      localRecords.push(_path.default.resolve(tmpRoot, _path.default.posix.basename(pathOnDevice)));
      await this.adb.pull(pathOnDevice, _lodash.default.last(localRecords));
      await this.adb.rimraf(pathOnDevice);
    }

    let resultFilePath = _lodash.default.last(localRecords);

    if (localRecords.length > 1) {
      _logger.default.info(`Got ${localRecords.length} screen recordings. Trying to merge them`);

      try {
        resultFilePath = await mergeScreenRecords(localRecords);
      } catch (e) {
        _logger.default.warn(`Cannot merge the recorded files. The most recent screen recording is going to be returned as the result. ` + `Original error: ${e.message}`);
      }
    }

    const {
      remotePath,
      user,
      pass,
      method
    } = options;
    return await uploadRecordedMedia(this.adb, resultFilePath, remotePath, {
      user,
      pass,
      method
    });
  } finally {
    await _appiumSupport.fs.rimraf(tmpRoot);
    this._screenRecordingProperties = null;
  }
};

Object.assign(extensions, commands);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9yZWNvcmRzY3JlZW4uanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJleHRlbnNpb25zIiwiUkVUUllfUEFVU0UiLCJSRVRSWV9USU1FT1VUIiwiTUFYX1JFQ09SRElOR19USU1FX1NFQyIsIk1BWF9USU1FX1NFQyIsIkRFRkFVTFRfUkVDT1JESU5HX1RJTUVfU0VDIiwiUFJPQ0VTU19TSFVURE9XTl9USU1FT1VUIiwiU0NSRUVOUkVDT1JEX0JJTkFSWSIsIkRFRkFVTFRfRVhUIiwiTUlOX0VNVUxBVE9SX0FQSV9MRVZFTCIsIkZGTVBFR19CSU5BUlkiLCJzeXN0ZW0iLCJpc1dpbmRvd3MiLCJ1cGxvYWRSZWNvcmRlZE1lZGlhIiwiYWRiIiwibG9jYWxGaWxlIiwicmVtb3RlUGF0aCIsInVwbG9hZE9wdGlvbnMiLCJzaXplIiwiZnMiLCJzdGF0IiwibG9nIiwiZGVidWciLCJ1dGlsIiwidG9SZWFkYWJsZVNpemVTdHJpbmciLCJfIiwiaXNFbXB0eSIsIm1heE1lbW9yeUxpbWl0IiwidjgiLCJnZXRIZWFwU3RhdGlzdGljcyIsInRvdGFsX2F2YWlsYWJsZV9zaXplIiwiaW5mbyIsInJlYWRGaWxlIiwidG9TdHJpbmciLCJyZW1vdGVVcmwiLCJ1cmwiLCJwYXJzZSIsIm9wdGlvbnMiLCJ1c2VyIiwicGFzcyIsIm1ldGhvZCIsInByb3RvY29sIiwic3RhcnRzV2l0aCIsImhyZWYiLCJtdWx0aXBhcnQiLCJib2R5IiwiX2ZzIiwiY3JlYXRlUmVhZFN0cmVhbSIsImF1dGgiLCJob3N0IiwiaG9zdG5hbWUiLCJwb3J0IiwibmV0IiwidXBsb2FkRmlsZSIsInZlcmlmeVNjcmVlblJlY29yZElzU3VwcG9ydGVkIiwiaXNFbXVsYXRvciIsImFwaUxldmVsIiwiZ2V0QXBpTGV2ZWwiLCJFcnJvciIsInNjaGVkdWxlU2NyZWVuUmVjb3JkIiwicmVjb3JkaW5nUHJvcGVydGllcyIsInN0b3BwZWQiLCJzdGFydFRpbWVzdGFtcCIsInZpZGVvU2l6ZSIsImJpdFJhdGUiLCJ0aW1lTGltaXQiLCJidWdSZXBvcnQiLCJjdXJyZW50VGltZUxpbWl0IiwiaGFzVmFsdWUiLCJjdXJyZW50VGltZUxpbWl0SW50IiwicGFyc2VJbnQiLCJpc05hTiIsInBhdGhPbkRldmljZSIsIk1hdGgiLCJmbG9vciIsIkRhdGUiLCJyZWNvcmRpbmdQcm9jIiwic2NyZWVucmVjb3JkIiwib24iLCJjdXJyZW50RHVyYXRpb24iLCJwcm9jZXNzIiwiaHJ0aW1lIiwidGltZUxpbWl0SW50IiwiY2h1bmtEdXJhdGlvbiIsImNhdGNoIiwiZSIsImVycm9yIiwic3RhY2siLCJzdGFydCIsImZpbGVFeGlzdHMiLCJ3YWl0TXMiLCJpbnRlcnZhbE1zIiwicmVjb3JkcyIsInB1c2giLCJyZWNvcmRpbmdQcm9jZXNzIiwibWVyZ2VTY3JlZW5SZWNvcmRzIiwibWVkaWFGaWxlcyIsIndoaWNoIiwiY29uZmlnQ29udGVudCIsIm1hcCIsIngiLCJqb2luIiwiY29uZmlnRmlsZSIsInBhdGgiLCJyZXNvbHZlIiwiZGlybmFtZSIsIndyaXRlRmlsZSIsInJlc3VsdCIsImFyZ3MiLCJ0ZXJtaW5hdGVCYWNrZ3JvdW5kU2NyZWVuUmVjb3JkaW5nIiwiZm9yY2UiLCJwaWRzIiwiZ2V0UElEc0J5TmFtZSIsInAiLCJzaGVsbCIsImVyciIsIm1lc3NhZ2UiLCJzdGFydFJlY29yZGluZ1NjcmVlbiIsImZvcmNlUmVzdGFydCIsInN0b3BSZWNvcmRpbmdTY3JlZW4iLCJ3YXJuIiwiX3NjcmVlblJlY29yZGluZ1Byb3BlcnRpZXMiLCJyZWNvcmQiLCJyaW1yYWYiLCJ0aW1lb3V0IiwicGFyc2VGbG9hdCIsImlzUnVubmluZyIsInN0b3AiLCJlcnJvckFuZFRocm93IiwidG1wUm9vdCIsInRlbXBEaXIiLCJvcGVuRGlyIiwibG9jYWxSZWNvcmRzIiwicG9zaXgiLCJiYXNlbmFtZSIsInB1bGwiLCJsYXN0IiwicmVzdWx0RmlsZVBhdGgiLCJsZW5ndGgiLCJPYmplY3QiLCJhc3NpZ24iXSwibWFwcGluZ3MiOiI7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QUMsQ0FBQytCLE9BQVEsRUFEL0I7QUFFRDtBQUNGOztBQUNELFVBQU07QUFBQ3BHLE1BQUFBLFVBQUQ7QUFBYXNCLE1BQUFBLElBQWI7QUFBbUJDLE1BQUFBLElBQW5CO0FBQXlCQyxNQUFBQTtBQUF6QixRQUFtQ0gsT0FBekM7QUFDQSxXQUFPLE1BQU14QixtQkFBbUIsQ0FBQyxLQUFLQyxHQUFOLEVBQVcySCxjQUFYLEVBQTJCekgsVUFBM0IsRUFBdUM7QUFBQ3NCLE1BQUFBLElBQUQ7QUFBT0MsTUFBQUEsSUFBUDtBQUFhQyxNQUFBQTtBQUFiLEtBQXZDLENBQWhDO0FBQ0QsR0FuQkQsU0FtQlU7QUFDUixVQUFNckIsa0JBQUd3RyxNQUFILENBQVVNLE9BQVYsQ0FBTjtBQUNBLFNBQUtSLDBCQUFMLEdBQWtDLElBQWxDO0FBQ0Q7QUFDRixDQTNERDs7QUE4REFrQixNQUFNLENBQUNDLE1BQVAsQ0FBYzVJLFVBQWQsRUFBMEJELFFBQTFCO2VBRWVDLFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IF9mcyBmcm9tICdmcyc7XG5pbXBvcnQgdXJsIGZyb20gJ3VybCc7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgdXRpbCwgZnMsIG5ldCwgdGVtcERpciwgc3lzdGVtIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB2OCBmcm9tICd2OCc7XG5cblxubGV0IGNvbW1hbmRzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuY29uc3QgUkVUUllfUEFVU0UgPSAzMDA7XG5jb25zdCBSRVRSWV9USU1FT1VUID0gNTAwMDtcbmNvbnN0IE1BWF9SRUNPUkRJTkdfVElNRV9TRUMgPSA2MCAqIDM7XG5jb25zdCBNQVhfVElNRV9TRUMgPSA2MCAqIDMwO1xuY29uc3QgREVGQVVMVF9SRUNPUkRJTkdfVElNRV9TRUMgPSBNQVhfUkVDT1JESU5HX1RJTUVfU0VDO1xuY29uc3QgUFJPQ0VTU19TSFVURE9XTl9USU1FT1VUID0gMTAgKiAxMDAwO1xuY29uc3QgU0NSRUVOUkVDT1JEX0JJTkFSWSA9ICdzY3JlZW5yZWNvcmQnO1xuY29uc3QgREVGQVVMVF9FWFQgPSAnLm1wNCc7XG5jb25zdCBNSU5fRU1VTEFUT1JfQVBJX0xFVkVMID0gMjc7XG5jb25zdCBGRk1QRUdfQklOQVJZID0gYGZmbXBlZyR7c3lzdGVtLmlzV2luZG93cygpID8gJy5leGUnIDogJyd9YDtcblxuYXN5bmMgZnVuY3Rpb24gdXBsb2FkUmVjb3JkZWRNZWRpYSAoYWRiLCBsb2NhbEZpbGUsIHJlbW90ZVBhdGggPSBudWxsLCB1cGxvYWRPcHRpb25zID0ge30pIHtcbiAgY29uc3Qge3NpemV9ID0gYXdhaXQgZnMuc3RhdChsb2NhbEZpbGUpO1xuICBsb2cuZGVidWcoYFRoZSBzaXplIG9mIHRoZSByZXN1bHRpbmcgc2NyZWVuIHJlY29yZGluZyBpcyAke3V0aWwudG9SZWFkYWJsZVNpemVTdHJpbmcoc2l6ZSl9YCk7XG4gIGlmIChfLmlzRW1wdHkocmVtb3RlUGF0aCkpIHtcbiAgICBjb25zdCBtYXhNZW1vcnlMaW1pdCA9IHY4LmdldEhlYXBTdGF0aXN0aWNzKCkudG90YWxfYXZhaWxhYmxlX3NpemUgLyAyO1xuICAgIGlmIChzaXplID49IG1heE1lbW9yeUxpbWl0KSB7XG4gICAgICBsb2cuaW5mbyhgVGhlIGZpbGUgbWlnaHQgYmUgdG9vIGxhcmdlIHRvIGZpdCBpbnRvIHRoZSBwcm9jZXNzIG1lbW9yeSBgICtcbiAgICAgICAgYCgke3V0aWwudG9SZWFkYWJsZVNpemVTdHJpbmcoc2l6ZSl9ID49ICR7dXRpbC50b1JlYWRhYmxlU2l6ZVN0cmluZyhtYXhNZW1vcnlMaW1pdCl9KS4gYCArXG4gICAgICAgIGBQcm92aWRlIGEgbGluayB0byBhIHJlbW90ZSB3cml0YWJsZSBsb2NhdGlvbiBmb3IgdmlkZW8gdXBsb2FkIGAgK1xuICAgICAgICBgKGh0dHAocykgYW5kIGZ0cCBwcm90b2NvbHMgYXJlIHN1cHBvcnRlZCkgaWYgeW91IGV4cGVyaWVuY2UgT3V0IE9mIE1lbW9yeSBlcnJvcnNgKTtcbiAgICB9XG4gICAgcmV0dXJuIChhd2FpdCBmcy5yZWFkRmlsZShsb2NhbEZpbGUpKS50b1N0cmluZygnYmFzZTY0Jyk7XG4gIH1cblxuICBjb25zdCByZW1vdGVVcmwgPSB1cmwucGFyc2UocmVtb3RlUGF0aCk7XG4gIGxldCBvcHRpb25zID0ge307XG4gIGNvbnN0IHt1c2VyLCBwYXNzLCBtZXRob2R9ID0gdXBsb2FkT3B0aW9ucztcbiAgaWYgKHJlbW90ZVVybC5wcm90b2NvbC5zdGFydHNXaXRoKCdodHRwJykpIHtcbiAgICBvcHRpb25zID0ge1xuICAgICAgdXJsOiByZW1vdGVVcmwuaHJlZixcbiAgICAgIG1ldGhvZDogbWV0aG9kIHx8ICdQVVQnLFxuICAgICAgbXVsdGlwYXJ0OiBbeyBib2R5OiBfZnMuY3JlYXRlUmVhZFN0cmVhbShsb2NhbEZpbGUpIH1dLFxuICAgIH07XG4gICAgaWYgKHVzZXIgJiYgcGFzcykge1xuICAgICAgb3B0aW9ucy5hdXRoID0ge3VzZXIsIHBhc3N9O1xuICAgIH1cbiAgfSBlbHNlIGlmIChyZW1vdGVVcmwucHJvdG9jb2wuc3RhcnRzV2l0aCgnZnRwJykpIHtcbiAgICBvcHRpb25zID0ge1xuICAgICAgaG9zdDogcmVtb3RlVXJsLmhvc3RuYW1lLFxuICAgICAgcG9ydDogcmVtb3RlVXJsLnBvcnQgfHwgMjEsXG4gICAgfTtcbiAgICBpZiAodXNlciAmJiBwYXNzKSB7XG4gICAgICBvcHRpb25zLnVzZXIgPSB1c2VyO1xuICAgICAgb3B0aW9ucy5wYXNzID0gcGFzcztcbiAgICB9XG4gIH1cbiAgYXdhaXQgbmV0LnVwbG9hZEZpbGUobG9jYWxGaWxlLCByZW1vdGVQYXRoLCBvcHRpb25zKTtcbiAgcmV0dXJuICcnO1xufVxuXG5hc3luYyBmdW5jdGlvbiB2ZXJpZnlTY3JlZW5SZWNvcmRJc1N1cHBvcnRlZCAoYWRiLCBpc0VtdWxhdG9yKSB7XG4gIGNvbnN0IGFwaUxldmVsID0gYXdhaXQgYWRiLmdldEFwaUxldmVsKCk7XG4gIGlmIChpc0VtdWxhdG9yICYmIGFwaUxldmVsIDwgTUlOX0VNVUxBVE9SX0FQSV9MRVZFTCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgU2NyZWVuIHJlY29yZGluZyBkb2VzIG5vdCB3b3JrIG9uIGVtdWxhdG9ycyBydW5uaW5nIEFuZHJvaWQgQVBJIGxldmVsIGxlc3MgdGhhbiAke01JTl9FTVVMQVRPUl9BUElfTEVWRUx9YCk7XG4gIH1cbiAgaWYgKGFwaUxldmVsIDwgMTkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFNjcmVlbiByZWNvcmRpbmcgbm90IGF2YWlsYWJsZSBvbiBBUEkgTGV2ZWwgJHthcGlMZXZlbH0uIE1pbmltdW0gQVBJIExldmVsIGlzIDE5LmApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNjaGVkdWxlU2NyZWVuUmVjb3JkIChhZGIsIHJlY29yZGluZ1Byb3BlcnRpZXMpIHtcbiAgaWYgKHJlY29yZGluZ1Byb3BlcnRpZXMuc3RvcHBlZCkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IHtcbiAgICBzdGFydFRpbWVzdGFtcCxcbiAgICB2aWRlb1NpemUsXG4gICAgYml0UmF0ZSxcbiAgICB0aW1lTGltaXQsXG4gICAgYnVnUmVwb3J0LFxuICB9ID0gcmVjb3JkaW5nUHJvcGVydGllcztcblxuICBsZXQgY3VycmVudFRpbWVMaW1pdCA9IE1BWF9SRUNPUkRJTkdfVElNRV9TRUM7XG4gIGlmICh1dGlsLmhhc1ZhbHVlKHJlY29yZGluZ1Byb3BlcnRpZXMuY3VycmVudFRpbWVMaW1pdCkpIHtcbiAgICBjb25zdCBjdXJyZW50VGltZUxpbWl0SW50ID0gcGFyc2VJbnQocmVjb3JkaW5nUHJvcGVydGllcy5jdXJyZW50VGltZUxpbWl0LCAxMCk7XG4gICAgaWYgKCFpc05hTihjdXJyZW50VGltZUxpbWl0SW50KSAmJiBjdXJyZW50VGltZUxpbWl0SW50IDwgTUFYX1JFQ09SRElOR19USU1FX1NFQykge1xuICAgICAgY3VycmVudFRpbWVMaW1pdCA9IGN1cnJlbnRUaW1lTGltaXRJbnQ7XG4gICAgfVxuICB9XG4gIGNvbnN0IHBhdGhPbkRldmljZSA9IGAvc2RjYXJkLyR7TWF0aC5mbG9vcihuZXcgRGF0ZSgpKX0ke0RFRkFVTFRfRVhUfWA7XG4gIGNvbnN0IHJlY29yZGluZ1Byb2MgPSBhZGIuc2NyZWVucmVjb3JkKHBhdGhPbkRldmljZSwge1xuICAgIHZpZGVvU2l6ZSxcbiAgICBiaXRSYXRlLFxuICAgIHRpbWVMaW1pdDogY3VycmVudFRpbWVMaW1pdCxcbiAgICBidWdSZXBvcnQsXG4gIH0pO1xuXG4gIHJlY29yZGluZ1Byb2Mub24oJ2VuZCcsICgpID0+IHtcbiAgICBpZiAocmVjb3JkaW5nUHJvcGVydGllcy5zdG9wcGVkIHx8ICF1dGlsLmhhc1ZhbHVlKHRpbWVMaW1pdCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgY3VycmVudER1cmF0aW9uID0gcHJvY2Vzcy5ocnRpbWUoc3RhcnRUaW1lc3RhbXApWzBdO1xuICAgIGxvZy5kZWJ1ZyhgVGhlIG92ZXJhbGwgc2NyZWVuIHJlY29yZGluZyBkdXJhdGlvbiBpcyAke2N1cnJlbnREdXJhdGlvbn1zIHNvIGZhcmApO1xuICAgIGNvbnN0IHRpbWVMaW1pdEludCA9IHBhcnNlSW50KHRpbWVMaW1pdCwgMTApO1xuICAgIGlmIChpc05hTih0aW1lTGltaXRJbnQpIHx8IGN1cnJlbnREdXJhdGlvbiA+PSB0aW1lTGltaXRJbnQpIHtcbiAgICAgIGxvZy5kZWJ1ZygnVGhlcmUgaXMgbm8gbmVlZCB0byBzdGFydCB0aGUgbmV4dCByZWNvcmRpbmcgY2h1bmsnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICByZWNvcmRpbmdQcm9wZXJ0aWVzLmN1cnJlbnRUaW1lTGltaXQgPSB0aW1lTGltaXRJbnQgLSBjdXJyZW50RHVyYXRpb247XG4gICAgY29uc3QgY2h1bmtEdXJhdGlvbiA9IHJlY29yZGluZ1Byb3BlcnRpZXMuY3VycmVudFRpbWVMaW1pdCA8IE1BWF9SRUNPUkRJTkdfVElNRV9TRUNcbiAgICAgID8gcmVjb3JkaW5nUHJvcGVydGllcy5jdXJyZW50VGltZUxpbWl0XG4gICAgICA6IE1BWF9SRUNPUkRJTkdfVElNRV9TRUM7XG4gICAgbG9nLmRlYnVnKGBTdGFydGluZyB0aGUgbmV4dCAke2NodW5rRHVyYXRpb259cy1jaHVuayBgICtcbiAgICAgIGBvZiBzY3JlZW4gcmVjb3JkaW5nIGluIG9yZGVyIHRvIGFjaGlldmUgJHt0aW1lTGltaXRJbnR9cyB0b3RhbCBkdXJhdGlvbmApO1xuICAgIHNjaGVkdWxlU2NyZWVuUmVjb3JkKGFkYiwgcmVjb3JkaW5nUHJvcGVydGllcylcbiAgICAgIC5jYXRjaCgoZSkgPT4ge1xuICAgICAgICBsb2cuZXJyb3IoZS5zdGFjayk7XG4gICAgICAgIHJlY29yZGluZ1Byb3BlcnRpZXMuc3RvcHBlZCA9IHRydWU7XG4gICAgICB9KTtcbiAgfSk7XG5cbiAgYXdhaXQgcmVjb3JkaW5nUHJvYy5zdGFydCgwKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IGF3YWl0IGFkYi5maWxlRXhpc3RzKHBhdGhPbkRldmljZSksXG4gICAgICB7d2FpdE1zOiBSRVRSWV9USU1FT1VULCBpbnRlcnZhbE1zOiBSRVRSWV9QQVVTRX0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgZXhwZWN0ZWQgc2NyZWVuIHJlY29yZCBmaWxlICcke3BhdGhPbkRldmljZX0nIGRvZXMgbm90IGV4aXN0IGFmdGVyICR7UkVUUllfVElNRU9VVH1tc2ApO1xuICB9XG5cbiAgcmVjb3JkaW5nUHJvcGVydGllcy5yZWNvcmRzLnB1c2gocGF0aE9uRGV2aWNlKTtcbiAgcmVjb3JkaW5nUHJvcGVydGllcy5yZWNvcmRpbmdQcm9jZXNzID0gcmVjb3JkaW5nUHJvYztcbn1cblxuYXN5bmMgZnVuY3Rpb24gbWVyZ2VTY3JlZW5SZWNvcmRzIChtZWRpYUZpbGVzKSB7XG4gIHRyeSB7XG4gICAgYXdhaXQgZnMud2hpY2goRkZNUEVHX0JJTkFSWSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYCR7RkZNUEVHX0JJTkFSWX0gdXRpbGl0eSBpcyBub3QgYXZhaWxhYmxlIGluIFBBVEguIFBsZWFzZSBpbnN0YWxsIGl0IGZyb20gaHR0cHM6Ly93d3cuZmZtcGVnLm9yZy9gKTtcbiAgfVxuICBjb25zdCBjb25maWdDb250ZW50ID0gbWVkaWFGaWxlc1xuICAgIC5tYXAoKHgpID0+IGBmaWxlICcke3h9J2ApXG4gICAgLmpvaW4oJ1xcbicpO1xuICBjb25zdCBjb25maWdGaWxlID0gcGF0aC5yZXNvbHZlKHBhdGguZGlybmFtZShtZWRpYUZpbGVzWzBdKSwgJ2NvbmZpZy50eHQnKTtcbiAgYXdhaXQgZnMud3JpdGVGaWxlKGNvbmZpZ0ZpbGUsIGNvbmZpZ0NvbnRlbnQsICd1dGY4Jyk7XG4gIGxvZy5kZWJ1ZyhgR2VuZXJhdGVkIGZmbXBlZyBtZXJnaW5nIGNvbmZpZyAnJHtjb25maWdGaWxlfScgd2l0aCBpdGVtczpcXG4ke2NvbmZpZ0NvbnRlbnR9YCk7XG4gIGNvbnN0IHJlc3VsdCA9IHBhdGgucmVzb2x2ZShwYXRoLmRpcm5hbWUobWVkaWFGaWxlc1swXSksIGBtZXJnZV8ke01hdGguZmxvb3IobmV3IERhdGUoKSl9JHtERUZBVUxUX0VYVH1gKTtcbiAgY29uc3QgYXJncyA9IFsnLXNhZmUnLCAnMCcsICctZicsICdjb25jYXQnLCAnLWknLCBjb25maWdGaWxlLCAnLWMnLCAnY29weScsIHJlc3VsdF07XG4gIGxvZy5pbmZvKGBJbml0aWF0aW5nIHNjcmVlbiByZWNvcmRzIG1lcmdpbmcgdXNpbmcgdGhlIGNvbW1hbmQgJyR7RkZNUEVHX0JJTkFSWX0gJHthcmdzLmpvaW4oJyAnKX0nYCk7XG4gIGF3YWl0IGV4ZWMoRkZNUEVHX0JJTkFSWSwgYXJncyk7XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHRlcm1pbmF0ZUJhY2tncm91bmRTY3JlZW5SZWNvcmRpbmcgKGFkYiwgZm9yY2UgPSB0cnVlKSB7XG4gIGNvbnN0IHBpZHMgPSAoYXdhaXQgYWRiLmdldFBJRHNCeU5hbWUoU0NSRUVOUkVDT1JEX0JJTkFSWSkpXG4gICAgLm1hcCgocCkgPT4gYCR7cH1gKTtcbiAgaWYgKF8uaXNFbXB0eShwaWRzKSkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgYXdhaXQgYWRiLnNoZWxsKFsna2lsbCcsIGZvcmNlID8gJy0xNScgOiAnLTInLCAuLi5waWRzXSk7XG4gICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbihhc3luYyAoKSA9PiBfLmlzRW1wdHkoYXdhaXQgYWRiLmdldFBJRHNCeU5hbWUoU0NSRUVOUkVDT1JEX0JJTkFSWSkpLCB7XG4gICAgICB3YWl0TXM6IFBST0NFU1NfU0hVVERPV05fVElNRU9VVCxcbiAgICAgIGludGVydmFsTXM6IDUwMCxcbiAgICB9KTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gc3RvcCB0aGUgYmFja2dyb3VuZCBzY3JlZW4gcmVjb3JkaW5nOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG59XG5cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBTdGFydFJlY29yZGluZ09wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHJlbW90ZVBhdGggLSBUaGUgcGF0aCB0byB0aGUgcmVtb3RlIGxvY2F0aW9uLCB3aGVyZSB0aGUgY2FwdHVyZWQgdmlkZW8gc2hvdWxkIGJlIHVwbG9hZGVkLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIGZvbGxvd2luZyBwcm90b2NvbHMgYXJlIHN1cHBvcnRlZDogaHR0cC9odHRwcywgZnRwLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTnVsbCBvciBlbXB0eSBzdHJpbmcgdmFsdWUgKHRoZSBkZWZhdWx0IHNldHRpbmcpIG1lYW5zIHRoZSBjb250ZW50IG9mIHJlc3VsdGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZSBzaG91bGQgYmUgZW5jb2RlZCBhcyBCYXNlNjQgYW5kIHBhc3NlZCBhcyB0aGUgZW5kcG91bnQgcmVzcG9uc2UgdmFsdWUuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBbiBleGNlcHRpb24gd2lsbCBiZSB0aHJvd24gaWYgdGhlIGdlbmVyYXRlZCBtZWRpYSBmaWxlIGlzIHRvbyBiaWcgdG9cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpdCBpbnRvIHRoZSBhdmFpbGFibGUgcHJvY2VzcyBtZW1vcnkuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGlzIG9wdGlvbiBvbmx5IGhhcyBhbiBlZmZlY3QgaWYgdGhlcmUgaXMgc2NyZWVuIHJlY29yZGluZyBwcm9jZXNzIGluIHByb2dyZWVzc1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5kIGBmb3JjZVJlc3RhcnRgIHBhcmFtZXRlciBpcyBub3Qgc2V0IHRvIGB0cnVlYC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdXNlciAtIFRoZSBuYW1lIG9mIHRoZSB1c2VyIGZvciB0aGUgcmVtb3RlIGF1dGhlbnRpY2F0aW9uLiBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcGFzcyAtIFRoZSBwYXNzd29yZCBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi4gT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IG1ldGhvZCAtIFRoZSBodHRwIG11bHRpcGFydCB1cGxvYWQgbWV0aG9kIG5hbWUuIFRoZSAnUFVUJyBvbmUgaXMgdXNlZCBieSBkZWZhdWx0LlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdmlkZW9TaXplIC0gVGhlIGZvcm1hdCBpcyB3aWR0aHhoZWlnaHQuXG4gKiAgICAgICAgICAgICAgICAgIFRoZSBkZWZhdWx0IHZhbHVlIGlzIHRoZSBkZXZpY2UncyBuYXRpdmUgZGlzcGxheSByZXNvbHV0aW9uIChpZiBzdXBwb3J0ZWQpLFxuICogICAgICAgICAgICAgICAgICAxMjgweDcyMCBpZiBub3QuIEZvciBiZXN0IHJlc3VsdHMsXG4gKiAgICAgICAgICAgICAgICAgIHVzZSBhIHNpemUgc3VwcG9ydGVkIGJ5IHlvdXIgZGV2aWNlJ3MgQWR2YW5jZWQgVmlkZW8gQ29kaW5nIChBVkMpIGVuY29kZXIuXG4gKiAgICAgICAgICAgICAgICAgIEZvciBleGFtcGxlLCBcIjEyODB4NzIwXCJcbiAqIEBwcm9wZXJ0eSB7P2Jvb2xlYW59IGJ1Z1JlcG9ydCAtIFNldCBpdCB0byBgdHJ1ZWAgaW4gb3JkZXIgdG8gZGlzcGxheSBhZGRpdGlvbmFsIGluZm9ybWF0aW9uIG9uIHRoZSB2aWRlbyBvdmVybGF5LFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VjaCBhcyBhIHRpbWVzdGFtcCwgdGhhdCBpcyBoZWxwZnVsIGluIHZpZGVvcyBjYXB0dXJlZCB0byBpbGx1c3RyYXRlIGJ1Z3MuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGlzIG9wdGlvbiBpcyBvbmx5IHN1cHBvcnRlZCBzaW5jZSBBUEkgbGV2ZWwgMjcgKEFuZHJvaWQgUCkuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd8bnVtYmVyfSB0aW1lTGltaXQgLSBUaGUgbWF4aW11bSByZWNvcmRpbmcgdGltZSwgaW4gc2Vjb25kcy4gVGhlIGRlZmF1bHQgdmFsdWUgaXMgMTgwICgzIG1pbnV0ZXMpLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIG1heGltdW0gdmFsdWUgaXMgMTgwMCAoMzAgbWludXRlcykuIElmIHRoZSBwYXNzZWQgdmFsdWUgaXMgZ3JlYXRlciB0aGFuIDE4MCB0aGVuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGUgYWxnb3JpdGhtIHdpbGwgdHJ5IHRvIHNjaGVkdWxlIG11bHRpcGxlIHNjcmVlbiByZWNvcmRpbmcgY2h1bmtzIGFuZCBtZXJnZSB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdGluZyB2aWRlb3MgaW50byBhIHNpbmdsZSBtZWRpYSBmaWxlIHVzaW5nIGBmZm1wZWdgIHV0aWxpdHkuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJZiB0aGUgdXRpbGl0eSBpcyBub3QgYXZhaWxhYmxlIGluIFBBVEggdGhlbiB0aGUgbW9zdCByZWNlbnQgc2NyZWVuIHJlY29yZGluZyBjaHVuayBpc1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ29pbmcgdG8gYmUgcmV0dXJuZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd8bnVtYmVyfSBiaXRSYXRlIC0gVGhlIHZpZGVvIGJpdCByYXRlIGZvciB0aGUgdmlkZW8sIGluIG1lZ2FiaXRzIHBlciBzZWNvbmQuXG4gKiAgICAgICAgICAgICAgICBUaGUgZGVmYXVsdCB2YWx1ZSBpcyA0LiBZb3UgY2FuIGluY3JlYXNlIHRoZSBiaXQgcmF0ZSB0byBpbXByb3ZlIHZpZGVvIHF1YWxpdHksXG4gKiAgICAgICAgICAgICAgICBidXQgZG9pbmcgc28gcmVzdWx0cyBpbiBsYXJnZXIgbW92aWUgZmlsZXMuXG4gKiBAcHJvcGVydHkgez9ib29sZWFufSBmb3JjZVJlc3RhcnQgLSBXaGV0aGVyIHRvIHRyeSB0byBjYXRjaCBhbmQgdXBsb2FkL3JldHVybiB0aGUgY3VycmVudGx5IHJ1bm5pbmcgc2NyZWVuIHJlY29yZGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGBmYWxzZWAsIHRoZSBkZWZhdWx0IHNldHRpbmcpIG9yIGlnbm9yZSB0aGUgcmVzdWx0IG9mIGl0IGFuZCBzdGFydCBhIG5ldyByZWNvcmRpbmdcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltbWVkaWF0ZWx5IChgdHJ1ZWApLlxuICovXG5cbi8qKlxuICogUmVjb3JkIHRoZSBkaXNwbGF5IG9mIGEgcmVhbCBkZXZpY2VzIHJ1bm5pbmcgQW5kcm9pZCA0LjQgKEFQSSBsZXZlbCAxOSkgYW5kIGhpZ2hlci5cbiAqIEVtdWxhdG9ycyBhcmUgc3VwcG9ydGVkIHNpbmNlIEFQSSBsZXZlbCAyNyAoQW5kcm9pZCBQKS5cbiAqIEl0IHJlY29yZHMgc2NyZWVuIGFjdGl2aXR5IHRvIGFuIE1QRUctNCBmaWxlLiBBdWRpbyBpcyBub3QgcmVjb3JkZWQgd2l0aCB0aGUgdmlkZW8gZmlsZS5cbiAqIElmIHNjcmVlbiByZWNvcmRpbmcgaGFzIGJlZW4gYWxyZWFkeSBzdGFydGVkIHRoZW4gdGhlIGNvbW1hbmQgd2lsbCBzdG9wIGl0IGZvcmNlZnVsbHkgYW5kIHN0YXJ0IGEgbmV3IG9uZS5cbiAqIFRoZSBwcmV2aW91c2x5IHJlY29yZGVkIHZpZGVvIGZpbGUgd2lsbCBiZSBkZWxldGVkLlxuICpcbiAqIEBwYXJhbSB7P1N0YXJ0UmVjb3JkaW5nT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBhdmFpbGFibGUgb3B0aW9ucy5cbiAqIEByZXR1cm5zIHtzdHJpbmd9IEJhc2U2NC1lbmNvZGVkIGNvbnRlbnQgb2YgdGhlIHJlY29yZGVkIG1lZGlhIGZpbGUgaWZcbiAqICAgICAgICAgICAgICAgICAgIGFueSBzY3JlZW4gcmVjb3JkaW5nIGlzIGN1cnJlbnRseSBydW5uaW5nIG9yIGFuIGVtcHR5IHN0cmluZy5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBzY3JlZW4gcmVjb3JkaW5nIGhhcyBmYWlsZWQgdG8gc3RhcnQgb3IgaXMgbm90IHN1cHBvcnRlZCBvbiB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKi9cbmNvbW1hbmRzLnN0YXJ0UmVjb3JkaW5nU2NyZWVuID0gYXN5bmMgZnVuY3Rpb24gc3RhcnRSZWNvcmRpbmdTY3JlZW4gKG9wdGlvbnMgPSB7fSkge1xuICBhd2FpdCB2ZXJpZnlTY3JlZW5SZWNvcmRJc1N1cHBvcnRlZCh0aGlzLmFkYiwgdGhpcy5pc0VtdWxhdG9yKCkpO1xuXG4gIGxldCByZXN1bHQgPSAnJztcbiAgY29uc3Qge3ZpZGVvU2l6ZSwgdGltZUxpbWl0ID0gREVGQVVMVF9SRUNPUkRJTkdfVElNRV9TRUMsIGJ1Z1JlcG9ydCwgYml0UmF0ZSwgZm9yY2VSZXN0YXJ0fSA9IG9wdGlvbnM7XG4gIGlmICghZm9yY2VSZXN0YXJ0KSB7XG4gICAgcmVzdWx0ID0gYXdhaXQgdGhpcy5zdG9wUmVjb3JkaW5nU2NyZWVuKG9wdGlvbnMpO1xuICB9XG5cbiAgaWYgKGF3YWl0IHRlcm1pbmF0ZUJhY2tncm91bmRTY3JlZW5SZWNvcmRpbmcodGhpcy5hZGIsIHRydWUpKSB7XG4gICAgbG9nLndhcm4oYFRoZXJlIHdlcmUgc29tZSAke1NDUkVFTlJFQ09SRF9CSU5BUll9IHByb2Nlc3MgbGVmdG92ZXJzIHJ1bm5pbmcgYCArXG4gICAgICBgaW4gdGhlIGJhY2tncm91bmQuIE1ha2Ugc3VyZSB5b3Ugc3RvcCBzY3JlZW4gcmVjb3JkaW5nIGVhY2ggdGltZSBhZnRlciBpdCBpcyBzdGFydGVkLCBgICtcbiAgICAgIGBvdGhlcndpc2UgdGhlIHJlY29yZGVkIG1lZGlhIG1pZ2h0IHF1aWNrbHkgZXhjZWVkIGFsbCB0aGUgZnJlZSBzcGFjZSBvbiB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuYCk7XG4gIH1cblxuICBpZiAoIV8uaXNFbXB0eSh0aGlzLl9zY3JlZW5SZWNvcmRpbmdQcm9wZXJ0aWVzKSkge1xuICAgIGZvciAoY29uc3QgcmVjb3JkIG9mICh0aGlzLl9zY3JlZW5SZWNvcmRpbmdQcm9wZXJ0aWVzLnJlY29yZHMgfHwgW10pKSB7XG4gICAgICBhd2FpdCB0aGlzLmFkYi5yaW1yYWYocmVjb3JkKTtcbiAgICB9XG4gICAgdGhpcy5fc2NyZWVuUmVjb3JkaW5nUHJvcGVydGllcyA9IG51bGw7XG4gIH1cblxuICBjb25zdCB0aW1lb3V0ID0gcGFyc2VGbG9hdCh0aW1lTGltaXQpO1xuICBpZiAoaXNOYU4odGltZW91dCkgfHwgdGltZW91dCA+IE1BWF9USU1FX1NFQyB8fCB0aW1lb3V0IDw9IDApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSB0aW1lTGltaXQgdmFsdWUgbXVzdCBiZSBpbiByYW5nZSBbMSwgJHtNQVhfVElNRV9TRUN9XSBzZWNvbmRzLiBgICtcbiAgICAgIGBUaGUgdmFsdWUgb2YgJyR7dGltZUxpbWl0fScgaGFzIGJlZW4gcGFzc2VkIGluc3RlYWQuYCk7XG4gIH1cblxuICB0aGlzLl9zY3JlZW5SZWNvcmRpbmdQcm9wZXJ0aWVzID0ge1xuICAgIHN0YXJ0VGltZXN0YW1wOiBwcm9jZXNzLmhydGltZSgpLFxuICAgIHZpZGVvU2l6ZSxcbiAgICB0aW1lTGltaXQsXG4gICAgY3VycmVudFRpbWVMaW1pdDogdGltZUxpbWl0LFxuICAgIGJpdFJhdGUsXG4gICAgYnVnUmVwb3J0LFxuICAgIHJlY29yZHM6IFtdLFxuICAgIHJlY29yZGluZ1Byb2Nlc3M6IG51bGwsXG4gICAgc3RvcHBlZDogZmFsc2UsXG4gIH07XG4gIGF3YWl0IHNjaGVkdWxlU2NyZWVuUmVjb3JkKHRoaXMuYWRiLCB0aGlzLl9zY3JlZW5SZWNvcmRpbmdQcm9wZXJ0aWVzKTtcbiAgcmV0dXJuIHJlc3VsdDtcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gU3RvcFJlY29yZGluZ09wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHJlbW90ZVBhdGggLSBUaGUgcGF0aCB0byB0aGUgcmVtb3RlIGxvY2F0aW9uLCB3aGVyZSB0aGUgcmVzdWx0aW5nIHZpZGVvIHNob3VsZCBiZSB1cGxvYWRlZC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBmb2xsb3dpbmcgcHJvdG9jb2xzIGFyZSBzdXBwb3J0ZWQ6IGh0dHAvaHR0cHMsIGZ0cC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE51bGwgb3IgZW1wdHkgc3RyaW5nIHZhbHVlICh0aGUgZGVmYXVsdCBzZXR0aW5nKSBtZWFucyB0aGUgY29udGVudCBvZiByZXN1bHRpbmdcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGUgc2hvdWxkIGJlIGVuY29kZWQgYXMgQmFzZTY0IGFuZCBwYXNzZWQgYXMgdGhlIGVuZHBvdW50IHJlc3BvbnNlIHZhbHVlLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQW4gZXhjZXB0aW9uIHdpbGwgYmUgdGhyb3duIGlmIHRoZSBnZW5lcmF0ZWQgbWVkaWEgZmlsZSBpcyB0b28gYmlnIHRvXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXQgaW50byB0aGUgYXZhaWxhYmxlIHByb2Nlc3MgbWVtb3J5LlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB1c2VyIC0gVGhlIG5hbWUgb2YgdGhlIHVzZXIgZm9yIHRoZSByZW1vdGUgYXV0aGVudGljYXRpb24uXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHBhc3MgLSBUaGUgcGFzc3dvcmQgZm9yIHRoZSByZW1vdGUgYXV0aGVudGljYXRpb24uXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IG1ldGhvZCAtIFRoZSBodHRwIG11bHRpcGFydCB1cGxvYWQgbWV0aG9kIG5hbWUuIFRoZSAnUFVUJyBvbmUgaXMgdXNlZCBieSBkZWZhdWx0LlxuICovXG5cbi8qKlxuICogU3RvcCByZWNvcmRpbmcgdGhlIHNjcmVlbi5cbiAqIElmIG5vIHNjcmVlbiByZWNvcmRpbmcgaGFzIGJlZW4gc3RhcnRlZCBiZWZvcmUgdGhlbiB0aGUgbWV0aG9kIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nLlxuICpcbiAqIEBwYXJhbSB7P1N0b3BSZWNvcmRpbmdPcHRpb25zfSBvcHRpb25zIC0gVGhlIGF2YWlsYWJsZSBvcHRpb25zLlxuICogQHJldHVybnMge3N0cmluZ30gQmFzZTY0LWVuY29kZWQgY29udGVudCBvZiB0aGUgcmVjb3JkZWQgbWVkaWEgZmlsZSBpZiAncmVtb3RlUGF0aCdcbiAqICAgICAgICAgICAgICAgICAgIHBhcmFtZXRlciBpcyBmYWxzeSBvciBhbiBlbXB0eSBzdHJpbmcuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGdldHRpbmcgdGhlIG5hbWUgb2YgYSBtZWRpYSBmaWxlXG4gKiAgICAgICAgICAgICAgICAgb3IgdGhlIGZpbGUgY29udGVudCBjYW5ub3QgYmUgdXBsb2FkZWQgdG8gdGhlIHJlbW90ZSBsb2NhdGlvblxuICogICAgICAgICAgICAgICAgIG9yIHNjcmVlbiByZWNvcmRpbmcgaXMgbm90IHN1cHBvcnRlZCBvbiB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKi9cbmNvbW1hbmRzLnN0b3BSZWNvcmRpbmdTY3JlZW4gPSBhc3luYyBmdW5jdGlvbiBzdG9wUmVjb3JkaW5nU2NyZWVuIChvcHRpb25zID0ge30pIHtcbiAgYXdhaXQgdmVyaWZ5U2NyZWVuUmVjb3JkSXNTdXBwb3J0ZWQodGhpcy5hZGIsIHRoaXMuaXNFbXVsYXRvcigpKTtcblxuICBpZiAoIV8uaXNFbXB0eSh0aGlzLl9zY3JlZW5SZWNvcmRpbmdQcm9wZXJ0aWVzKSkge1xuICAgIHRoaXMuX3NjcmVlblJlY29yZGluZ1Byb3BlcnRpZXMuc3RvcHBlZCA9IHRydWU7XG4gIH1cblxuICB0cnkge1xuICAgIGF3YWl0IHRlcm1pbmF0ZUJhY2tncm91bmRTY3JlZW5SZWNvcmRpbmcodGhpcy5hZGIsIGZhbHNlKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oZXJyLm1lc3NhZ2UpO1xuICAgIGlmICghXy5pc0VtcHR5KHRoaXMuX3NjcmVlblJlY29yZGluZ1Byb3BlcnRpZXMpKSB7XG4gICAgICBsb2cud2FybignVGhlIHJlc3VsdGluZyB2aWRlbyBtaWdodCBiZSBjb3JydXB0ZWQnKTtcbiAgICB9XG4gIH1cblxuICBpZiAoXy5pc0VtcHR5KHRoaXMuX3NjcmVlblJlY29yZGluZ1Byb3BlcnRpZXMpKSB7XG4gICAgbG9nLmluZm8oYFNjcmVlbiByZWNvcmRpbmcgaGFzIG5vdCBiZWVuIHByZXZpb3VzbHkgc3RhcnRlZCBieSBBcHBpdW0uIFRoZXJlIGlzIG5vdGhpbmcgdG8gc3RvcGApO1xuICAgIHJldHVybiAnJztcbiAgfVxuXG4gIGlmICh0aGlzLl9zY3JlZW5SZWNvcmRpbmdQcm9wZXJ0aWVzLnJlY29yZGluZ1Byb2Nlc3MgJiYgdGhpcy5fc2NyZWVuUmVjb3JkaW5nUHJvcGVydGllcy5yZWNvcmRpbmdQcm9jZXNzLmlzUnVubmluZykge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLl9zY3JlZW5SZWNvcmRpbmdQcm9wZXJ0aWVzLnJlY29yZGluZ1Byb2Nlc3Muc3RvcCgnU0lHSU5UJywgUFJPQ0VTU19TSFVURE9XTl9USU1FT1VUKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgVW5hYmxlIHRvIHN0b3Agc2NyZWVuIHJlY29yZGluZyB3aXRoaW4gJHtQUk9DRVNTX1NIVVRET1dOX1RJTUVPVVR9bXNgKTtcbiAgICB9XG4gICAgdGhpcy5fc2NyZWVuUmVjb3JkaW5nUHJvcGVydGllcy5yZWNvcmRpbmdQcm9jZXNzID0gbnVsbDtcbiAgfVxuXG4gIGlmIChfLmlzRW1wdHkodGhpcy5fc2NyZWVuUmVjb3JkaW5nUHJvcGVydGllcy5yZWNvcmRzKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBObyBzY3JlZW4gcmVjb3JkaW5ncyBoYXZlIGJlZW4gc3RvcmVkIG9uIHRoZSBkZXZpY2Ugc28gZmFyLiBgICtcbiAgICAgIGBBcmUgeW91IHN1cmUgdGhlICR7U0NSRUVOUkVDT1JEX0JJTkFSWX0gdXRpbGl0eSB3b3JrcyBhcyBleHBlY3RlZD9gKTtcbiAgfVxuXG4gIGNvbnN0IHRtcFJvb3QgPSBhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKTtcbiAgdHJ5IHtcbiAgICBjb25zdCBsb2NhbFJlY29yZHMgPSBbXTtcbiAgICBmb3IgKGNvbnN0IHBhdGhPbkRldmljZSBvZiB0aGlzLl9zY3JlZW5SZWNvcmRpbmdQcm9wZXJ0aWVzLnJlY29yZHMpIHtcbiAgICAgIGxvY2FsUmVjb3Jkcy5wdXNoKHBhdGgucmVzb2x2ZSh0bXBSb290LCBwYXRoLnBvc2l4LmJhc2VuYW1lKHBhdGhPbkRldmljZSkpKTtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnB1bGwocGF0aE9uRGV2aWNlLCBfLmxhc3QobG9jYWxSZWNvcmRzKSk7XG4gICAgICBhd2FpdCB0aGlzLmFkYi5yaW1yYWYocGF0aE9uRGV2aWNlKTtcbiAgICB9XG4gICAgbGV0IHJlc3VsdEZpbGVQYXRoID0gXy5sYXN0KGxvY2FsUmVjb3Jkcyk7XG4gICAgaWYgKGxvY2FsUmVjb3Jkcy5sZW5ndGggPiAxKSB7XG4gICAgICBsb2cuaW5mbyhgR290ICR7bG9jYWxSZWNvcmRzLmxlbmd0aH0gc2NyZWVuIHJlY29yZGluZ3MuIFRyeWluZyB0byBtZXJnZSB0aGVtYCk7XG4gICAgICB0cnkge1xuICAgICAgICByZXN1bHRGaWxlUGF0aCA9IGF3YWl0IG1lcmdlU2NyZWVuUmVjb3Jkcyhsb2NhbFJlY29yZHMpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cud2FybihgQ2Fubm90IG1lcmdlIHRoZSByZWNvcmRlZCBmaWxlcy4gVGhlIG1vc3QgcmVjZW50IHNjcmVlbiByZWNvcmRpbmcgaXMgZ29pbmcgdG8gYmUgcmV0dXJuZWQgYXMgdGhlIHJlc3VsdC4gYCArXG4gICAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3Qge3JlbW90ZVBhdGgsIHVzZXIsIHBhc3MsIG1ldGhvZH0gPSBvcHRpb25zO1xuICAgIHJldHVybiBhd2FpdCB1cGxvYWRSZWNvcmRlZE1lZGlhKHRoaXMuYWRiLCByZXN1bHRGaWxlUGF0aCwgcmVtb3RlUGF0aCwge3VzZXIsIHBhc3MsIG1ldGhvZH0pO1xuICB9IGZpbmFsbHkge1xuICAgIGF3YWl0IGZzLnJpbXJhZih0bXBSb290KTtcbiAgICB0aGlzLl9zY3JlZW5SZWNvcmRpbmdQcm9wZXJ0aWVzID0gbnVsbDtcbiAgfVxufTtcblxuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzKTtcbmV4cG9ydCB7IGNvbW1hbmRzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvcmVjb3Jkc2NyZWVuLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
