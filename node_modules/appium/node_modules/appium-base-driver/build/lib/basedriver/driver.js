"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.BaseDriver = void 0;

require("source-map-support/register");

var _protocol = require("../protocol");

var _os = _interopRequireDefault(require("os"));

var _commands = _interopRequireDefault(require("./commands"));

var helpers = _interopRequireWildcard(require("./helpers"));

var _logger = _interopRequireDefault(require("./logger"));

var _deviceSettings = _interopRequireDefault(require("./device-settings"));

var _desiredCaps = require("./desired-caps");

var _capabilities = require("./capabilities");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _imageElement = require("./image-element");

_bluebird.default.config({
  cancellation: true
});

const NEW_COMMAND_TIMEOUT_MS = 60 * 1000;
const EVENT_SESSION_INIT = 'newSessionRequested';
const EVENT_SESSION_START = 'newSessionStarted';
const EVENT_SESSION_QUIT_START = 'quitSessionRequested';
const EVENT_SESSION_QUIT_DONE = 'quitSessionFinished';

class BaseDriver extends _protocol.Protocol {
  constructor(opts = {}, shouldValidateCaps = true) {
    super();
    this.sessionId = null;
    this.opts = opts;
    this.caps = null;
    this.helpers = helpers;
    this.newCommandTimeoutMs = NEW_COMMAND_TIMEOUT_MS;
    this.implicitWaitMs = 0;
    this._constraints = _lodash.default.cloneDeep(_desiredCaps.desiredCapabilityConstraints);
    this.locatorStrategies = [];
    this.webLocatorStrategies = [];
    this.opts.tmpDir = this.opts.tmpDir || process.env.APPIUM_TMP_DIR || _os.default.tmpdir();
    this.curCommand = _bluebird.default.resolve();
    this.curCommandCancellable = _bluebird.default.resolve();
    this.shutdownUnexpectedly = false;
    this.noCommandTimer = null;
    this.shouldValidateCaps = shouldValidateCaps;
    this.settings = new _deviceSettings.default({}, _lodash.default.noop);
    this.resetOnUnexpectedShutdown();
    this.initialOpts = _lodash.default.cloneDeep(this.opts);
    this.managedDrivers = [];
    this._eventHistory = {
      commands: []
    };
    this._imgElCache = (0, _imageElement.makeImageElementCache)();
    this.protocol = null;
  }

  get driverData() {
    return {};
  }

  get isCommandsQueueEnabled() {
    return true;
  }

  get eventHistory() {
    return _lodash.default.cloneDeep(this._eventHistory);
  }

  logEvent(eventName) {
    if (eventName === 'commands') {
      throw new Error('Cannot log commands directly');
    }

    if (typeof eventName !== 'string') {
      throw new Error(`Invalid eventName ${eventName}`);
    }

    if (!this._eventHistory[eventName]) {
      this._eventHistory[eventName] = [];
    }

    let ts = Date.now();
    let logTime = new Date(ts).toTimeString();

    this._eventHistory[eventName].push(ts);

    _logger.default.debug(`Event '${eventName}' logged at ${ts} (${logTime})`);
  }

  async getStatus() {
    return {};
  }

  resetOnUnexpectedShutdown() {
    if (this.onUnexpectedShutdown && !this.onUnexpectedShutdown.isFulfilled()) {
      this.onUnexpectedShutdown.cancel();
    }

    this.onUnexpectedShutdown = new _bluebird.default((resolve, reject, onCancel) => {
      onCancel(() => reject(new _bluebird.default.CancellationError()));
      this.unexpectedShutdownDeferred = {
        resolve,
        reject
      };
    });
    this.onUnexpectedShutdown.catch(() => {});
  }

  set desiredCapConstraints(constraints) {
    this._constraints = Object.assign(this._constraints, constraints);

    for (const [, value] of _lodash.default.toPairs(this._constraints)) {
      if (value && value.presence === true) {
        value.presence = {
          allowEmpty: false
        };
      }
    }
  }

  get desiredCapConstraints() {
    return this._constraints;
  }

  sessionExists(sessionId) {
    if (!sessionId) return false;
    return sessionId === this.sessionId;
  }

  driverForSession() {
    return this;
  }

  logExtraCaps(caps) {
    let extraCaps = _lodash.default.difference(_lodash.default.keys(caps), _lodash.default.keys(this._constraints));

    if (extraCaps.length) {
      _logger.default.warn(`The following capabilities were provided, but are not ` + `recognized by appium: ${extraCaps.join(', ')}.`);
    }
  }

  validateDesiredCaps(caps) {
    if (!this.shouldValidateCaps) {
      return true;
    }

    try {
      (0, _capabilities.validateCaps)(caps, this._constraints);
    } catch (e) {
      _logger.default.errorAndThrow(new _protocol.errors.SessionNotCreatedError(`The desiredCapabilities object was not valid for the ` + `following reason(s): ${e.message}`));
    }

    this.logExtraCaps(caps);
    return true;
  }

  isMjsonwpProtocol() {
    return this.protocol === BaseDriver.DRIVER_PROTOCOL.MJSONWP;
  }

  isW3CProtocol() {
    return this.protocol === BaseDriver.DRIVER_PROTOCOL.W3C;
  }

  setProtocolMJSONWP() {
    this.protocol = BaseDriver.DRIVER_PROTOCOL.MJSONWP;
  }

  setProtocolW3C() {
    this.protocol = BaseDriver.DRIVER_PROTOCOL.W3C;
  }

  static determineProtocol(desiredCapabilities, requiredCapabilities, capabilities) {
    return _lodash.default.isPlainObject(capabilities) ? BaseDriver.DRIVER_PROTOCOL.W3C : BaseDriver.DRIVER_PROTOCOL.MJSONWP;
  }

  async executeCommand(cmd, ...args) {
    let startTime = Date.now();

    if (cmd === 'createSession') {
      this.protocol = BaseDriver.determineProtocol(...args);
      this.logEvent(EVENT_SESSION_INIT);
    } else if (cmd === 'deleteSession') {
      this.logEvent(EVENT_SESSION_QUIT_START);
    }

    this.clearNewCommandTimeout();
    const imgElId = (0, _imageElement.getImgElFromArgs)(args);

    if (!this[cmd] && !imgElId) {
      throw new _protocol.errors.NotYetImplementedError();
    }

    let res;

    if (this.isCommandsQueueEnabled) {
      const nextCommand = this.curCommand.then(() => {
        if (this.shutdownUnexpectedly) {
          return _bluebird.default.reject(new _protocol.errors.NoSuchDriverError('The driver was unexpectedly shut down!'));
        }

        let reject;
        this.curCommandCancellable = _bluebird.default.resolve().then(() => {
          const cancelPromise = new _bluebird.default(function (_, _reject) {
            reject = _reject;
          });
          return _bluebird.default.race([imgElId ? _imageElement.ImageElement.execute(this, cmd, imgElId) : this[cmd](...args), cancelPromise]);
        });

        this.curCommandCancellable.cancel = function cancel(err) {
          if (reject) {
            reject(err);
          }
        };

        return this.curCommandCancellable;
      });
      this.curCommand = nextCommand.catch(() => {});
      res = await nextCommand;
    } else {
      if (this.shutdownUnexpectedly) {
        throw new _protocol.errors.NoSuchDriverError('The driver was unexpectedly shut down!');
      }

      res = await this[cmd](...args);
    }

    if (this.isCommandsQueueEnabled && cmd !== 'deleteSession') {
      this.startNewCommandTimeout();
    }

    const endTime = Date.now();

    this._eventHistory.commands.push({
      cmd,
      startTime,
      endTime
    });

    if (cmd === 'createSession') {
      this.logEvent(EVENT_SESSION_START);
    } else if (cmd === 'deleteSession') {
      this.logEvent(EVENT_SESSION_QUIT_DONE);
    }

    return res;
  }

  async startUnexpectedShutdown(err = new _protocol.errors.NoSuchDriverError('The driver was unexpectedly shut down!')) {
    this.unexpectedShutdownDeferred.reject(err);
    this.shutdownUnexpectedly = true;
    await this.deleteSession(this.sessionId);
    this.shutdownUnexpectedly = false;
    this.curCommandCancellable.cancel(err);
  }

  validateLocatorStrategy(strategy, webContext = false) {
    let validStrategies = this.locatorStrategies;

    _logger.default.debug(`Valid locator strategies for this request: ${validStrategies.join(', ')}`);

    if (webContext) {
      validStrategies = validStrategies.concat(this.webLocatorStrategies);
    }

    if (!_lodash.default.includes(validStrategies, strategy)) {
      throw new _protocol.errors.InvalidSelectorError(`Locator Strategy '${strategy}' is not supported for this session`);
    }
  }

  async reset() {
    _logger.default.debug('Resetting app mid-session');

    _logger.default.debug('Running generic full reset');

    let currentConfig = {};

    for (let property of ['implicitWaitMs', 'newCommandTimeoutMs', 'sessionId', 'resetOnUnexpectedShutdown']) {
      currentConfig[property] = this[property];
    }

    this.resetOnUnexpectedShutdown = () => {};

    const args = this.protocol === BaseDriver.DRIVER_PROTOCOL.W3C ? [undefined, undefined, {
      alwaysMatch: this.caps,
      firstMatch: [{}]
    }] : [this.caps];

    try {
      await this.deleteSession(this.sessionId);

      _logger.default.debug('Restarting app');

      await this.createSession(...args);
    } finally {
      for (let [key, value] of _lodash.default.toPairs(currentConfig)) {
        this[key] = value;
      }
    }

    this.clearNewCommandTimeout();
  }

  async getSwipeOptions(gestures, touchCount = 1) {
    let startX = this.helpers.getCoordDefault(gestures[0].options.x),
        startY = this.helpers.getCoordDefault(gestures[0].options.y),
        endX = this.helpers.getCoordDefault(gestures[2].options.x),
        endY = this.helpers.getCoordDefault(gestures[2].options.y),
        duration = this.helpers.getSwipeTouchDuration(gestures[1]),
        element = gestures[0].options.element,
        destElement = gestures[2].options.element || gestures[0].options.element;

    if (_appiumSupport.util.hasValue(destElement)) {
      let locResult = await this.getLocationInView(destElement);
      let sizeResult = await this.getSize(destElement);
      let offsetX = Math.abs(endX) < 1 && Math.abs(endX) > 0 ? sizeResult.width * endX : endX;
      let offsetY = Math.abs(endY) < 1 && Math.abs(endY) > 0 ? sizeResult.height * endY : endY;
      endX = locResult.x + offsetX;
      endY = locResult.y + offsetY;

      if (_appiumSupport.util.hasValue(element)) {
        let firstElLocation = await this.getLocationInView(element);
        endX -= firstElLocation.x;
        endY -= firstElLocation.y;
      }
    }

    return {
      startX,
      startY,
      endX,
      endY,
      duration,
      touchCount,
      element
    };
  }

  proxyActive() {
    return false;
  }

  getProxyAvoidList() {
    return [];
  }

  canProxy() {
    return false;
  }

  proxyRouteIsAvoided(sessionId, method, url) {
    for (let avoidSchema of this.getProxyAvoidList(sessionId)) {
      if (!_lodash.default.isArray(avoidSchema) || avoidSchema.length !== 2) {
        throw new Error('Proxy avoidance must be a list of pairs');
      }

      let [avoidMethod, avoidPathRegex] = avoidSchema;

      if (!_lodash.default.includes(['GET', 'POST', 'DELETE'], avoidMethod)) {
        throw new Error(`Unrecognized proxy avoidance method '${avoidMethod}'`);
      }

      if (!_lodash.default.isRegExp(avoidPathRegex)) {
        throw new Error('Proxy avoidance path must be a regular expression');
      }

      let normalizedUrl = url.replace(/^\/wd\/hub/, '');

      if (avoidMethod === method && avoidPathRegex.test(normalizedUrl)) {
        return true;
      }
    }

    return false;
  }

  addManagedDriver(driver) {
    this.managedDrivers.push(driver);
  }

  getManagedDrivers() {
    return this.managedDrivers;
  }

}

exports.BaseDriver = BaseDriver;
BaseDriver.DRIVER_PROTOCOL = {
  W3C: 'W3C',
  MJSONWP: 'MJSONWP'
};

for (let [cmd, fn] of _lodash.default.toPairs(_commands.default)) {
  BaseDriver.prototype[cmd] = fn;
}

var _default = BaseDriver;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2RyaXZlci5qcyJdLCJuYW1lcyI6WyJCIiwiY29uZmlnIiwiY2FuY2VsbGF0aW9uIiwiTkVXX0NPTU1BTkRfVElNRU9VVF9NUyIsIkVWRU5UX1NFU1NJT05fSU5JVCIsIkVWRU5UX1NFU1NJT05fU1RBUlQiLCJFVkVOVF9TRVNTSU9OX1FVSVRfU1RBUlQiLCJFVkVOVF9TRVNTSU9OX1FVSVRfRE9ORSIsIkJhc2VEcml2ZXIiLCJQcm90b2NvbCIsImNvbnN0cnVjdG9yIiwib3B0cyIsInNob3VsZFZhbGlkYXRlQ2FwcyIsInNlc3Npb25JZCIsImNhcHMiLCJoZWxwZXJzIiwibmV3Q29tbWFuZFRpbWVvdXRNcyIsImltcGxpY2l0V2FpdE1zIiwiX2NvbnN0cmFpbnRzIiwiXyIsImNsb25lRGVlcCIsImRlc2lyZWRDYXBhYmlsaXR5Q29uc3RyYWludHMiLCJsb2NhdG9yU3RyYXRlZ2llcyIsIndlYkxvY2F0b3JTdHJhdGVnaWVzIiwidG1wRGlyIiwicHJvY2VzcyIsImVudiIsIkFQUElVTV9UTVBfRElSIiwib3MiLCJ0bXBkaXIiLCJjdXJDb21tYW5kIiwicmVzb2x2ZSIsImN1ckNvbW1hbmRDYW5jZWxsYWJsZSIsInNodXRkb3duVW5leHBlY3RlZGx5Iiwibm9Db21tYW5kVGltZXIiLCJzZXR0aW5ncyIsIkRldmljZVNldHRpbmdzIiwibm9vcCIsInJlc2V0T25VbmV4cGVjdGVkU2h1dGRvd24iLCJpbml0aWFsT3B0cyIsIm1hbmFnZWREcml2ZXJzIiwiX2V2ZW50SGlzdG9yeSIsImNvbW1hbmRzIiwiX2ltZ0VsQ2FjaGUiLCJwcm90b2NvbCIsImRyaXZlckRhdGEiLCJpc0NvbW1hbmRzUXVldWVFbmFibGVkIiwiZXZlbnRIaXN0b3J5IiwibG9nRXZlbnQiLCJldmVudE5hbWUiLCJFcnJvciIsInRzIiwiRGF0ZSIsIm5vdyIsImxvZ1RpbWUiLCJ0b1RpbWVTdHJpbmciLCJwdXNoIiwibG9nIiwiZGVidWciLCJnZXRTdGF0dXMiLCJvblVuZXhwZWN0ZWRTaHV0ZG93biIsImlzRnVsZmlsbGVkIiwiY2FuY2VsIiwicmVqZWN0Iiwib25DYW5jZWwiLCJDYW5jZWxsYXRpb25FcnJvciIsInVuZXhwZWN0ZWRTaHV0ZG93bkRlZmVycmVkIiwiY2F0Y2giLCJkZXNpcmVkQ2FwQ29uc3RyYWludHMiLCJjb25zdHJhaW50cyIsIk9iamVjdCIsImFzc2lnbiIsInZhbHVlIiwidG9QYWlycyIsInByZXNlbmNlIiwiYWxsb3dFbXB0eSIsInNlc3Npb25FeGlzdHMiLCJkcml2ZXJGb3JTZXNzaW9uIiwibG9nRXh0cmFDYXBzIiwiZXh0cmFDYXBzIiwiZGlmZmVyZW5jZSIsImtleXMiLCJsZW5ndGgiLCJ3YXJuIiwiam9pbiIsInZhbGlkYXRlRGVzaXJlZENhcHMiLCJlIiwiZXJyb3JBbmRUaHJvdyIsImVycm9ycyIsIlNlc3Npb25Ob3RDcmVhdGVkRXJyb3IiLCJtZXNzYWdlIiwiaXNNanNvbndwUHJvdG9jb2wiLCJEUklWRVJfUFJPVE9DT0wiLCJNSlNPTldQIiwiaXNXM0NQcm90b2NvbCIsIlczQyIsInNldFByb3RvY29sTUpTT05XUCIsInNldFByb3RvY29sVzNDIiwiZGV0ZXJtaW5lUHJvdG9jb2wiLCJkZXNpcmVkQ2FwYWJpbGl0aWVzIiwicmVxdWlyZWRDYXBhYmlsaXRpZXMiLCJjYXBhYmlsaXRpZXMiLCJpc1BsYWluT2JqZWN0IiwiZXhlY3V0ZUNvbW1hbmQiLCJjbWQiLCJhcmdzIiwic3RhcnRUaW1lIiwiY2xlYXJOZXdDb21tYW5kVGltZW91dCIsImltZ0VsSWQiLCJOb3RZZXRJbXBsZW1lbnRlZEVycm9yIiwicmVzIiwibmV4dENvbW1hbmQiLCJ0aGVuIiwiTm9TdWNoRHJpdmVyRXJyb3IiLCJjYW5jZWxQcm9taXNlIiwiX3JlamVjdCIsInJhY2UiLCJJbWFnZUVsZW1lbnQiLCJleGVjdXRlIiwiZXJyIiwic3RhcnROZXdDb21tYW5kVGltZW91dCIsImVuZFRpbWUiLCJzdGFydFVuZXhwZWN0ZWRTaHV0ZG93biIsImRlbGV0ZVNlc3Npb24iLCJ2YWxpZGF0ZUxvY2F0b3JTdHJhdGVneSIsInN0cmF0ZWd5Iiwid2ViQ29udGV4dCIsInZhbGlkU3RyYXRlZ2llcyIsImNvbmNhdCIsImluY2x1ZGVzIiwiSW52YWxpZFNlbGVjdG9yRXJyb3IiLCJyZXNldCIsImN1cnJlbnRDb25maWciLCJwcm9wZXJ0eSIsInVuZGVmaW5lZCIsImFsd2F5c01hdGNoIiwiZmlyc3RNYXRjaCIsImNyZWF0ZVNlc3Npb24iLCJrZXkiLCJnZXRTd2lwZU9wdGlvbnMiLCJnZXN0dXJlcyIsInRvdWNoQ291bnQiLCJzdGFydFgiLCJnZXRDb29yZERlZmF1bHQiLCJvcHRpb25zIiwieCIsInN0YXJ0WSIsInkiLCJlbmRYIiwiZW5kWSIsImR1cmF0aW9uIiwiZ2V0U3dpcGVUb3VjaER1cmF0aW9uIiwiZWxlbWVudCIsImRlc3RFbGVtZW50IiwidXRpbCIsImhhc1ZhbHVlIiwibG9jUmVzdWx0IiwiZ2V0TG9jYXRpb25JblZpZXciLCJzaXplUmVzdWx0IiwiZ2V0U2l6ZSIsIm9mZnNldFgiLCJNYXRoIiwiYWJzIiwid2lkdGgiLCJvZmZzZXRZIiwiaGVpZ2h0IiwiZmlyc3RFbExvY2F0aW9uIiwicHJveHlBY3RpdmUiLCJnZXRQcm94eUF2b2lkTGlzdCIsImNhblByb3h5IiwicHJveHlSb3V0ZUlzQXZvaWRlZCIsIm1ldGhvZCIsInVybCIsImF2b2lkU2NoZW1hIiwiaXNBcnJheSIsImF2b2lkTWV0aG9kIiwiYXZvaWRQYXRoUmVnZXgiLCJpc1JlZ0V4cCIsIm5vcm1hbGl6ZWRVcmwiLCJyZXBsYWNlIiwidGVzdCIsImFkZE1hbmFnZWREcml2ZXIiLCJkcml2ZXIiLCJnZXRNYW5hZ2VkRHJpdmVycyIsImZuIiwicHJvdG90eXBlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0FBLGtCQUFFQyxNQUFGLENBQVM7QUFDUEMsRUFBQUEs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LElBQTBCSyxjQUFjLENBQUNJLElBQWYsQ0FBb0JGLGFBQXBCLENBQTlCLEVBQWtFO0FBQ2hFLGVBQU8sSUFBUDtBQUNEO0FBQ0Y7O0FBQ0QsV0FBTyxLQUFQO0FBQ0Q7O0FBRURHLEVBQUFBLGdCQUFnQixDQUFFQyxNQUFGLEVBQVU7QUFDeEIsU0FBSzlJLGNBQUwsQ0FBb0JnQixJQUFwQixDQUF5QjhILE1BQXpCO0FBQ0Q7O0FBRURDLEVBQUFBLGlCQUFpQixHQUFJO0FBQ25CLFdBQU8sS0FBSy9JLGNBQVo7QUFDRDs7QUFyYytCOzs7QUF3Y2xDaEMsVUFBVSxDQUFDb0YsZUFBWCxHQUE2QjtBQUMzQkcsRUFBQUEsR0FBRyxFQUFFLEtBRHNCO0FBRTNCRixFQUFBQSxPQUFPLEVBQUU7QUFGa0IsQ0FBN0I7O0FBS0EsS0FBSyxJQUFJLENBQUNXLEdBQUQsRUFBTWdGLEVBQU4sQ0FBVCxJQUFzQnJLLGdCQUFFc0QsT0FBRixDQUFVL0IsaUJBQVYsQ0FBdEIsRUFBMkM7QUFDekNsQyxFQUFBQSxVQUFVLENBQUNpTCxTQUFYLENBQXFCakYsR0FBckIsSUFBNEJnRixFQUE1QjtBQUNEOztlQUdjaEwsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFByb3RvY29sLCBlcnJvcnMgfSBmcm9tICcuLi9wcm90b2NvbCc7XG5pbXBvcnQgb3MgZnJvbSAnb3MnO1xuaW1wb3J0IGNvbW1hbmRzIGZyb20gJy4vY29tbWFuZHMnO1xuaW1wb3J0ICogYXMgaGVscGVycyBmcm9tICcuL2hlbHBlcnMnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgRGV2aWNlU2V0dGluZ3MgZnJvbSAnLi9kZXZpY2Utc2V0dGluZ3MnO1xuaW1wb3J0IHsgZGVzaXJlZENhcGFiaWxpdHlDb25zdHJhaW50cyB9IGZyb20gJy4vZGVzaXJlZC1jYXBzJztcbmltcG9ydCB7IHZhbGlkYXRlQ2FwcyB9IGZyb20gJy4vY2FwYWJpbGl0aWVzJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgSW1hZ2VFbGVtZW50LCBtYWtlSW1hZ2VFbGVtZW50Q2FjaGUsIGdldEltZ0VsRnJvbUFyZ3MgfSBmcm9tICcuL2ltYWdlLWVsZW1lbnQnO1xuXG5cbkIuY29uZmlnKHtcbiAgY2FuY2VsbGF0aW9uOiB0cnVlLFxufSk7XG5cbmNvbnN0IE5FV19DT01NQU5EX1RJTUVPVVRfTVMgPSA2MCAqIDEwMDA7XG5cbmNvbnN0IEVWRU5UX1NFU1NJT05fSU5JVCA9ICduZXdTZXNzaW9uUmVxdWVzdGVkJztcbmNvbnN0IEVWRU5UX1NFU1NJT05fU1RBUlQgPSAnbmV3U2Vzc2lvblN0YXJ0ZWQnO1xuY29uc3QgRVZFTlRfU0VTU0lPTl9RVUlUX1NUQVJUID0gJ3F1aXRTZXNzaW9uUmVxdWVzdGVkJztcbmNvbnN0IEVWRU5UX1NFU1NJT05fUVVJVF9ET05FID0gJ3F1aXRTZXNzaW9uRmluaXNoZWQnO1xuXG5jbGFzcyBCYXNlRHJpdmVyIGV4dGVuZHMgUHJvdG9jb2wge1xuXG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30sIHNob3VsZFZhbGlkYXRlQ2FwcyA9IHRydWUpIHtcbiAgICBzdXBlcigpO1xuXG4gICAgLy8gc2V0dXAgc3RhdGVcbiAgICB0aGlzLnNlc3Npb25JZCA9IG51bGw7XG4gICAgdGhpcy5vcHRzID0gb3B0cztcbiAgICB0aGlzLmNhcHMgPSBudWxsO1xuICAgIHRoaXMuaGVscGVycyA9IGhlbHBlcnM7XG5cbiAgICAvLyB0aW1lb3V0IGluaXRpYWxpemF0aW9uXG4gICAgdGhpcy5uZXdDb21tYW5kVGltZW91dE1zID0gTkVXX0NPTU1BTkRfVElNRU9VVF9NUztcbiAgICB0aGlzLmltcGxpY2l0V2FpdE1zID0gMDtcblxuICAgIHRoaXMuX2NvbnN0cmFpbnRzID0gXy5jbG9uZURlZXAoZGVzaXJlZENhcGFiaWxpdHlDb25zdHJhaW50cyk7XG4gICAgdGhpcy5sb2NhdG9yU3RyYXRlZ2llcyA9IFtdO1xuICAgIHRoaXMud2ViTG9jYXRvclN0cmF0ZWdpZXMgPSBbXTtcblxuICAgIC8vIHVzZSBhIGN1c3RvbSB0bXAgZGlyIHRvIGF2b2lkIGxvc2luZyBkYXRhIGFuZCBhcHAgd2hlbiBjb21wdXRlciBpc1xuICAgIC8vIHJlc3RhcnRlZFxuICAgIHRoaXMub3B0cy50bXBEaXIgPSB0aGlzLm9wdHMudG1wRGlyIHx8XG4gICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3MuZW52LkFQUElVTV9UTVBfRElSIHx8XG4gICAgICAgICAgICAgICAgICAgICAgIG9zLnRtcGRpcigpO1xuXG4gICAgLy8gYmFzZS1kcml2ZXIgaW50ZXJuYWxzXG4gICAgdGhpcy5jdXJDb21tYW5kID0gQi5yZXNvbHZlKCk7IC8vIHNlZSBub3RlIGluIGV4ZWN1dGVcbiAgICB0aGlzLmN1ckNvbW1hbmRDYW5jZWxsYWJsZSA9IEIucmVzb2x2ZSgpOyAvLyBzZWUgbm90ZSBpbiBleGVjdXRlXG4gICAgdGhpcy5zaHV0ZG93blVuZXhwZWN0ZWRseSA9IGZhbHNlO1xuICAgIHRoaXMubm9Db21tYW5kVGltZXIgPSBudWxsO1xuICAgIHRoaXMuc2hvdWxkVmFsaWRhdGVDYXBzID0gc2hvdWxkVmFsaWRhdGVDYXBzO1xuXG4gICAgLy8gc2V0dGluZ3Mgc2hvdWxkIGJlIGluc3RhbnRpYXRlZCBieSBkcml2ZXJzIHdoaWNoIGV4dGVuZCBCYXNlRHJpdmVyLCBidXRcbiAgICAvLyB3ZSBzZXQgaXQgdG8gYW4gZW1wdHkgRGV2aWNlU2V0dGluZ3MgaW5zdGFuY2UgaGVyZSB0byBtYWtlIHN1cmUgdGhhdCB0aGVcbiAgICAvLyBkZWZhdWx0IHNldHRpbmdzIGFyZSBhcHBsaWVkIGV2ZW4gaWYgYW4gZXh0ZW5kaW5nIGRyaXZlciBkb2Vzbid0IHV0aWxpemVcbiAgICAvLyB0aGUgc2V0dGluZ3MgZnVuY3Rpb25hbGl0eSBpdHNlbGZcbiAgICB0aGlzLnNldHRpbmdzID0gbmV3IERldmljZVNldHRpbmdzKHt9LCBfLm5vb3ApO1xuXG4gICAgdGhpcy5yZXNldE9uVW5leHBlY3RlZFNodXRkb3duKCk7XG5cbiAgICAvLyBrZWVwaW5nIHRyYWNrIG9mIGluaXRpYWwgb3B0c1xuICAgIHRoaXMuaW5pdGlhbE9wdHMgPSBfLmNsb25lRGVlcCh0aGlzLm9wdHMpO1xuXG4gICAgLy8gYWxsb3cgc3ViY2xhc3NlcyB0byBoYXZlIGludGVybmFsIGRyaXZlcnNcbiAgICB0aGlzLm1hbmFnZWREcml2ZXJzID0gW107XG5cbiAgICAvLyBzdG9yZSBldmVudCB0aW1pbmdzXG4gICAgdGhpcy5fZXZlbnRIaXN0b3J5ID0ge1xuICAgICAgY29tbWFuZHM6IFtdIC8vIGNvbW1hbmRzIGdldCBhIHNwZWNpYWwgcGxhY2VcbiAgICB9O1xuXG4gICAgLy8gY2FjaGUgdGhlIGltYWdlIGVsZW1lbnRzXG4gICAgdGhpcy5faW1nRWxDYWNoZSA9IG1ha2VJbWFnZUVsZW1lbnRDYWNoZSgpO1xuXG4gICAgdGhpcy5wcm90b2NvbCA9IG51bGw7XG4gIH1cblxuICAvKipcbiAgICogVGhpcyBwcm9wZXJ0eSBpcyB1c2VkIGJ5IEFwcGl1bURyaXZlciB0byBzdG9yZSB0aGUgZGF0YSBvZiB0aGVcbiAgICogc3BlY2lmaWMgZHJpdmVyIHNlc3Npb25zLiBUaGlzIGRhdGEgY2FuIGJlIGxhdGVyIHVzZWQgdG8gYWRqdXN0XG4gICAqIHByb3BlcnRpZXMgZm9yIGRyaXZlciBpbnN0YW5jZXMgcnVubmluZyBpbiBwYXJhbGxlbC5cbiAgICogT3ZlcnJpZGUgaXQgaW4gaW5oZXJpdGVkIGRyaXZlciBjbGFzc2VzIGlmIG5lY2Vzc2FyeS5cbiAgICpcbiAgICogQHJldHVybiB7b2JqZWN0fSBEcml2ZXIgcHJvcGVydGllcyBtYXBwaW5nXG4gICAqL1xuICBnZXQgZHJpdmVyRGF0YSAoKSB7XG4gICAgcmV0dXJuIHt9O1xuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgcHJvcGVydHkgY29udHJvbHMgdGhlIHdheSB7I2V4ZWN1dGVDb21tYW5kfSBtZXRob2RcbiAgICogaGFuZGxlcyBuZXcgZHJpdmVyIGNvbW1hbmRzIHJlY2VpdmVkIGZyb20gdGhlIGNsaWVudC5cbiAgICogT3ZlcnJpZGUgaXQgZm9yIGluaGVyaXRlZCBjbGFzc2VzIG9ubHkgaW4gc3BlY2lhbCBjYXNlcy5cbiAgICpcbiAgICogQHJldHVybiB7Ym9vbGVhbn0gSWYgdGhlIHJldHVybmVkIHZhbHVlIGlzIHRydWUgKGRlZmF1bHQpIHRoZW4gYWxsIHRoZSBjb21tYW5kc1xuICAgKiAgIHJlY2VpdmVkIGJ5IHRoZSBwYXJ0aWN1bGFyIGRyaXZlciBpbnN0YW5jZSBhcmUgZ29pbmcgdG8gYmUgcHV0IGludG8gdGhlIHF1ZXVlLFxuICAgKiAgIHNvIGVhY2ggZm9sbG93aW5nIGNvbW1hbmQgd2lsbCBub3QgYmUgZXhlY3V0ZWQgdW50aWwgdGhlIHByZXZpb3VzIGNvbW1hbmRcbiAgICogICBleGVjdXRpb24gaXMgY29tcGxldGVkLiBGYWxzZSB2YWx1ZSBkaXNhYmxlcyB0aGF0IHF1ZXVlLCBzbyBlYWNoIGRyaXZlciBjb21tYW5kXG4gICAqICAgaXMgZXhlY3V0ZWQgaW5kZXBlbmRlbnRseSBhbmQgZG9lcyBub3Qgd2FpdCBmb3IgYW55dGhpbmcuXG4gICAqL1xuICBnZXQgaXNDb21tYW5kc1F1ZXVlRW5hYmxlZCAoKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKlxuICAgKiBtYWtlIGV2ZW50SGlzdG9yeSBhIHByb3BlcnR5IGFuZCByZXR1cm4gYSBjbG9uZWQgb2JqZWN0IHNvIGEgY29uc3VtZXIgY2FuJ3RcbiAgICogaW5hZHZlcnRlbnRseSBjaGFuZ2UgZGF0YSBvdXRzaWRlIG9mIGxvZ0V2ZW50XG4gICAqL1xuICBnZXQgZXZlbnRIaXN0b3J5ICgpIHtcbiAgICByZXR1cm4gXy5jbG9uZURlZXAodGhpcy5fZXZlbnRIaXN0b3J5KTtcbiAgfVxuXG4gIC8qXG4gICAqIEFQSSBtZXRob2QgZm9yIGRyaXZlciBkZXZlbG9wZXJzIHRvIGxvZyB0aW1pbmdzIGZvciBpbXBvcnRhbnQgZXZlbnRzXG4gICAqL1xuICBsb2dFdmVudCAoZXZlbnROYW1lKSB7XG4gICAgaWYgKGV2ZW50TmFtZSA9PT0gJ2NvbW1hbmRzJykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgbG9nIGNvbW1hbmRzIGRpcmVjdGx5Jyk7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgZXZlbnROYW1lICE9PSAnc3RyaW5nJykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGV2ZW50TmFtZSAke2V2ZW50TmFtZX1gKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLl9ldmVudEhpc3RvcnlbZXZlbnROYW1lXSkge1xuICAgICAgdGhpcy5fZXZlbnRIaXN0b3J5W2V2ZW50TmFtZV0gPSBbXTtcbiAgICB9XG4gICAgbGV0IHRzID0gRGF0ZS5ub3coKTtcbiAgICBsZXQgbG9nVGltZSA9IChuZXcgRGF0ZSh0cykpLnRvVGltZVN0cmluZygpO1xuICAgIHRoaXMuX2V2ZW50SGlzdG9yeVtldmVudE5hbWVdLnB1c2godHMpO1xuICAgIGxvZy5kZWJ1ZyhgRXZlbnQgJyR7ZXZlbnROYW1lfScgbG9nZ2VkIGF0ICR7dHN9ICgke2xvZ1RpbWV9KWApO1xuICB9XG5cbiAgLypcbiAgICogT3ZlcnJpZGRlbiBpbiBhcHBpdW0gZHJpdmVyLCBidXQgaGVyZSBzbyB0aGF0IGluZGl2aWR1YWwgZHJpdmVycyBjYW4gYmVcbiAgICogdGVzdGVkIHdpdGggY2xpZW50cyB0aGF0IHBvbGxcbiAgICovXG4gIGFzeW5jIGdldFN0YXR1cyAoKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1hd2FpdFxuICAgIHJldHVybiB7fTtcbiAgfVxuXG4gIC8qXG4gICAqIEluaXRpYWxpemUgYSBuZXcgb25VbmV4cGVjdGVkU2h1dGRvd24gcHJvbWlzZSwgY2FuY2VsbGluZyBleGlzdGluZyBvbmUuXG4gICAqL1xuICByZXNldE9uVW5leHBlY3RlZFNodXRkb3duICgpIHtcbiAgICBpZiAodGhpcy5vblVuZXhwZWN0ZWRTaHV0ZG93biAmJiAhdGhpcy5vblVuZXhwZWN0ZWRTaHV0ZG93bi5pc0Z1bGZpbGxlZCgpKSB7XG4gICAgICB0aGlzLm9uVW5leHBlY3RlZFNodXRkb3duLmNhbmNlbCgpO1xuICAgIH1cbiAgICB0aGlzLm9uVW5leHBlY3RlZFNodXRkb3duID0gbmV3IEIoKHJlc29sdmUsIHJlamVjdCwgb25DYW5jZWwpID0+IHtcbiAgICAgIG9uQ2FuY2VsKCgpID0+IHJlamVjdChuZXcgQi5DYW5jZWxsYXRpb25FcnJvcigpKSk7XG4gICAgICB0aGlzLnVuZXhwZWN0ZWRTaHV0ZG93bkRlZmVycmVkID0ge3Jlc29sdmUsIHJlamVjdH07XG4gICAgfSk7XG4gICAgLy8gbm9vcCBoYW5kbGVyIHRvIGF2b2lkIHdhcm5pbmcuXG4gICAgdGhpcy5vblVuZXhwZWN0ZWRTaHV0ZG93bi5jYXRjaCgoKSA9PiB7fSk7XG4gIH1cblxuICAvLyB3ZSBvbmx5IHdhbnQgc3ViY2xhc3NlcyB0byBldmVyIGV4dGVuZCB0aGUgY29udHJhaW50c1xuICBzZXQgZGVzaXJlZENhcENvbnN0cmFpbnRzIChjb25zdHJhaW50cykge1xuICAgIHRoaXMuX2NvbnN0cmFpbnRzID0gT2JqZWN0LmFzc2lnbih0aGlzLl9jb25zdHJhaW50cywgY29uc3RyYWludHMpO1xuICAgIC8vICdwcmVzZW5jZScgbWVhbnMgZGlmZmVyZW50IHRoaW5ncyBpbiBkaWZmZXJlbnQgdmVyc2lvbnMgb2YgdGhlIHZhbGlkYXRvcixcbiAgICAvLyB3aGVuIHdlIHNheSAndHJ1ZScgd2UgbWVhbiB0aGF0IGl0IHNob3VsZCBub3QgYmUgYWJsZSB0byBiZSBlbXB0eVxuICAgIGZvciAoY29uc3QgWywgdmFsdWVdIG9mIF8udG9QYWlycyh0aGlzLl9jb25zdHJhaW50cykpIHtcbiAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZS5wcmVzZW5jZSA9PT0gdHJ1ZSkge1xuICAgICAgICB2YWx1ZS5wcmVzZW5jZSA9IHtcbiAgICAgICAgICBhbGxvd0VtcHR5OiBmYWxzZSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBnZXQgZGVzaXJlZENhcENvbnN0cmFpbnRzICgpIHtcbiAgICByZXR1cm4gdGhpcy5fY29uc3RyYWludHM7XG4gIH1cblxuICAvLyBtZXRob2QgcmVxdWlyZWQgYnkgTUpTT05XUCBpbiBvcmRlciB0byBkZXRlcm1pbmUgd2hldGhlciBpdCBzaG91bGRcbiAgLy8gcmVzcG9uZCB3aXRoIGFuIGludmFsaWQgc2Vzc2lvbiByZXNwb25zZVxuICBzZXNzaW9uRXhpc3RzIChzZXNzaW9uSWQpIHtcbiAgICBpZiAoIXNlc3Npb25JZCkgcmV0dXJuIGZhbHNlOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGN1cmx5XG4gICAgcmV0dXJuIHNlc3Npb25JZCA9PT0gdGhpcy5zZXNzaW9uSWQ7XG4gIH1cblxuICAvLyBtZXRob2QgcmVxdWlyZWQgYnkgTUpTT05XUCBpbiBvcmRlciB0byBkZXRlcm1pbmUgaWYgdGhlIGNvbW1hbmQgc2hvdWxkXG4gIC8vIGJlIHByb3hpZWQgZGlyZWN0bHkgdG8gdGhlIGRyaXZlclxuICBkcml2ZXJGb3JTZXNzaW9uICgvKnNlc3Npb25JZCovKSB7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBsb2dFeHRyYUNhcHMgKGNhcHMpIHtcbiAgICBsZXQgZXh0cmFDYXBzID0gXy5kaWZmZXJlbmNlKF8ua2V5cyhjYXBzKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8ua2V5cyh0aGlzLl9jb25zdHJhaW50cykpO1xuICAgIGlmIChleHRyYUNhcHMubGVuZ3RoKSB7XG4gICAgICBsb2cud2FybihgVGhlIGZvbGxvd2luZyBjYXBhYmlsaXRpZXMgd2VyZSBwcm92aWRlZCwgYnV0IGFyZSBub3QgYCArXG4gICAgICAgICAgICAgICBgcmVjb2duaXplZCBieSBhcHBpdW06ICR7ZXh0cmFDYXBzLmpvaW4oJywgJyl9LmApO1xuICAgIH1cbiAgfVxuXG4gIHZhbGlkYXRlRGVzaXJlZENhcHMgKGNhcHMpIHtcbiAgICBpZiAoIXRoaXMuc2hvdWxkVmFsaWRhdGVDYXBzKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgdmFsaWRhdGVDYXBzKGNhcHMsIHRoaXMuX2NvbnN0cmFpbnRzKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhuZXcgZXJyb3JzLlNlc3Npb25Ob3RDcmVhdGVkRXJyb3IoYFRoZSBkZXNpcmVkQ2FwYWJpbGl0aWVzIG9iamVjdCB3YXMgbm90IHZhbGlkIGZvciB0aGUgYCArXG4gICAgICAgICAgICAgICAgICAgIGBmb2xsb3dpbmcgcmVhc29uKHMpOiAke2UubWVzc2FnZX1gKSk7XG4gICAgfVxuXG4gICAgdGhpcy5sb2dFeHRyYUNhcHMoY2Fwcyk7XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGlzTWpzb253cFByb3RvY29sICgpIHtcbiAgICByZXR1cm4gdGhpcy5wcm90b2NvbCA9PT0gQmFzZURyaXZlci5EUklWRVJfUFJPVE9DT0wuTUpTT05XUDtcbiAgfVxuXG4gIGlzVzNDUHJvdG9jb2wgKCkge1xuICAgIHJldHVybiB0aGlzLnByb3RvY29sID09PSBCYXNlRHJpdmVyLkRSSVZFUl9QUk9UT0NPTC5XM0M7XG4gIH1cblxuICBzZXRQcm90b2NvbE1KU09OV1AgKCkge1xuICAgIHRoaXMucHJvdG9jb2wgPSBCYXNlRHJpdmVyLkRSSVZFUl9QUk9UT0NPTC5NSlNPTldQO1xuICB9XG5cbiAgc2V0UHJvdG9jb2xXM0MgKCkge1xuICAgIHRoaXMucHJvdG9jb2wgPSBCYXNlRHJpdmVyLkRSSVZFUl9QUk9UT0NPTC5XM0M7XG4gIH1cblxuICAvKipcbiAgICogVGVzdCBjcmVhdGVTZXNzaW9uIGlucHV0cyB0byBzZWUgaWYgdGhpcyBpcyBhIFczQyBTZXNzaW9uIG9yIGEgTUpTT05XUCBTZXNzaW9uXG4gICAqL1xuICBzdGF0aWMgZGV0ZXJtaW5lUHJvdG9jb2wgKGRlc2lyZWRDYXBhYmlsaXRpZXMsIHJlcXVpcmVkQ2FwYWJpbGl0aWVzLCBjYXBhYmlsaXRpZXMpIHtcbiAgICByZXR1cm4gXy5pc1BsYWluT2JqZWN0KGNhcGFiaWxpdGllcykgP1xuICAgICAgQmFzZURyaXZlci5EUklWRVJfUFJPVE9DT0wuVzNDIDpcbiAgICAgIEJhc2VEcml2ZXIuRFJJVkVSX1BST1RPQ09MLk1KU09OV1A7XG4gIH1cblxuICAvLyBUaGlzIGlzIHRoZSBtYWluIGNvbW1hbmQgaGFuZGxlciBmb3IgdGhlIGRyaXZlci4gSXQgd3JhcHMgY29tbWFuZFxuICAvLyBleGVjdXRpb24gd2l0aCB0aW1lb3V0IGxvZ2ljLCBjaGVja2luZyB0aGF0IHdlIGhhdmUgYSB2YWxpZCBzZXNzaW9uLFxuICAvLyBhbmQgZW5zdXJpbmcgdGhhdCB3ZSBleGVjdXRlIGNvbW1hbmRzIG9uZSBhdCBhIHRpbWUuIFRoaXMgbWV0aG9kIGlzIGNhbGxlZFxuICAvLyBieSBNSlNPTldQJ3MgZXhwcmVzcyByb3V0ZXIuXG4gIGFzeW5jIGV4ZWN1dGVDb21tYW5kIChjbWQsIC4uLmFyZ3MpIHtcbiAgICAvLyBnZXQgc3RhcnQgdGltZSBmb3IgdGhpcyBjb21tYW5kLCBhbmQgbG9nIGluIHNwZWNpYWwgY2FzZXNcbiAgICBsZXQgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBpZiAoY21kID09PSAnY3JlYXRlU2Vzc2lvbicpIHtcbiAgICAgIC8vIElmIGNyZWF0aW5nIGEgc2Vzc2lvbiBkZXRlcm1pbmUgaWYgVzNDIG9yIE1KU09OV1AgcHJvdG9jb2wgd2FzIHJlcXVlc3RlZCBhbmQgcmVtZW1iZXIgdGhlIGNob2ljZVxuICAgICAgdGhpcy5wcm90b2NvbCA9IEJhc2VEcml2ZXIuZGV0ZXJtaW5lUHJvdG9jb2woLi4uYXJncyk7XG4gICAgICB0aGlzLmxvZ0V2ZW50KEVWRU5UX1NFU1NJT05fSU5JVCk7XG4gICAgfSBlbHNlIGlmIChjbWQgPT09ICdkZWxldGVTZXNzaW9uJykge1xuICAgICAgdGhpcy5sb2dFdmVudChFVkVOVF9TRVNTSU9OX1FVSVRfU1RBUlQpO1xuICAgIH1cblxuICAgIC8vIGlmIHdlIGhhZCBhIGNvbW1hbmQgdGltZXIgcnVubmluZywgY2xlYXIgaXQgbm93IHRoYXQgd2UncmUgc3RhcnRpbmdcbiAgICAvLyBhIG5ldyBjb21tYW5kIGFuZCBzbyBkb24ndCB3YW50IHRvIHRpbWUgb3V0XG4gICAgdGhpcy5jbGVhck5ld0NvbW1hbmRUaW1lb3V0KCk7XG5cbiAgICAvLyBJZiB3ZSBkb24ndCBoYXZlIHRoaXMgY29tbWFuZCwgaXQgbXVzdCBub3QgYmUgaW1wbGVtZW50ZWRcbiAgICAvLyBJZiB0aGUgdGFyZ2V0IGVsZW1lbnQgaXMgSW1hZ2VFbGVtZW50LCB3ZSBtdXN0IHRyeSB0byBjYWxsIGBJbWFnZUVsZW1lbnQuZXhlY3V0ZWAgd2hpY2ggZXhpc3QgZm9sbG93aW5nIGxpbmVzXG4gICAgLy8gc2luY2UgSW1hZ2VFbGVtZW50IHN1cHBvcnRzIGZldyBjb21tYW5kcyBieSBpdHNlbGZcbiAgICBjb25zdCBpbWdFbElkID0gZ2V0SW1nRWxGcm9tQXJncyhhcmdzKTtcbiAgICBpZiAoIXRoaXNbY21kXSAmJiAhaW1nRWxJZCkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RZZXRJbXBsZW1lbnRlZEVycm9yKCk7XG4gICAgfVxuXG4gICAgbGV0IHJlcztcbiAgICBpZiAodGhpcy5pc0NvbW1hbmRzUXVldWVFbmFibGVkKSB7XG4gICAgICAvLyBXaGF0IHdlJ3JlIGRvaW5nIGhlcmUgaXMgcHJldHR5IGNsZXZlci4gdGhpcy5jdXJDb21tYW5kIGlzIGFsd2F5c1xuICAgICAgLy8gYSBwcm9taXNlIHJlcHJlc2VudGluZyB0aGUgY29tbWFuZCBjdXJyZW50bHkgYmVpbmcgZXhlY3V0ZWQgYnkgdGhlXG4gICAgICAvLyBkcml2ZXIsIG9yIHRoZSBsYXN0IGNvbW1hbmQgZXhlY3V0ZWQgYnkgdGhlIGRyaXZlciAoaXQgc3RhcnRzIG9mZiBhc1xuICAgICAgLy8gZXNzZW50aWFsbHkgYSBwcmUtcmVzb2x2ZWQgcHJvbWlzZSkuIFdoZW4gYSBjb21tYW5kIGNvbWVzIGluLCB3ZSB0YWNrIGl0XG4gICAgICAvLyB0byB0aGUgZW5kIG9mIHRoaXMuY3VyQ29tbWFuZCwgZXNzZW50aWFsbHkgc2F5aW5nIHdlIHdhbnQgdG8gZXhlY3V0ZSBpdFxuICAgICAgLy8gd2hlbmV2ZXIgdGhpcy5jdXJDb21tYW5kIGlzIGRvbmUuIFdlIGNhbGwgdGhpcyBuZXcgcHJvbWlzZSBuZXh0Q29tbWFuZCxcbiAgICAgIC8vIGFuZCBpdHMgcmVzb2x1dGlvbiBpcyB3aGF0IHdlIHVsdGltYXRlbHkgd2lsbCByZXR1cm4gdG8gd2hvbWV2ZXIgY2FsbGVkXG4gICAgICAvLyB1cy4gTWVhbndoaWxlLCB3ZSByZXNldCB0aGlzLmN1ckNvbW1hbmQgdG8gX2JlXyBuZXh0Q29tbWFuZCAoYnV0XG4gICAgICAvLyBpZ25vcmluZyBhbnkgcmVqZWN0aW9ucyksIHNvIHRoYXQgaWYgYW5vdGhlciBjb21tYW5kIGNvbWVzIGludG8gdGhlXG4gICAgICAvLyBzZXJ2ZXIsIGl0IGdldHMgdGFja2VkIG9uIHRvIHRoZSBlbmQgb2YgbmV4dENvbW1hbmQuIFRodXMgd2UgY3JlYXRlXG4gICAgICAvLyBhIGNoYWluIG9mIHByb21pc2VzIHRoYXQgYWN0cyBhcyBhIHF1ZXVlIHdpdGggc2luZ2xlIGNvbmN1cnJlbmN5LlxuICAgICAgY29uc3QgbmV4dENvbW1hbmQgPSB0aGlzLmN1ckNvbW1hbmQudGhlbigoKSA9PiB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tdGhlblxuICAgICAgICAvLyBpZiB3ZSB1bmV4cGVjdGVkbHkgc2h1dCBkb3duLCB3ZSBuZWVkIHRvIHJlamVjdCBldmVyeSBjb21tYW5kIGluXG4gICAgICAgIC8vIHRoZSBxdWV1ZSBiZWZvcmUgd2UgYWN0dWFsbHkgdHJ5IHRvIHJ1biBpdFxuICAgICAgICBpZiAodGhpcy5zaHV0ZG93blVuZXhwZWN0ZWRseSkge1xuICAgICAgICAgIHJldHVybiBCLnJlamVjdChuZXcgZXJyb3JzLk5vU3VjaERyaXZlckVycm9yKCdUaGUgZHJpdmVyIHdhcyB1bmV4cGVjdGVkbHkgc2h1dCBkb3duIScpKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBXZSBhbHNvIG5lZWQgdG8gdHVybiB0aGUgY29tbWFuZCBpbnRvIGEgY2FuY2VsbGFibGUgcHJvbWlzZSBzbyBpZiB3ZVxuICAgICAgICAvLyBoYXZlIGFuIHVuZXhwZWN0ZWQgc2h1dGRvd24gZXZlbnQsIGZvciBleGFtcGxlLCB3ZSBjYW4gY2FuY2VsIGl0IGZyb21cbiAgICAgICAgLy8gb3V0c2lkZSwgcmVqZWN0aW5nIHRoZSBjdXJyZW50IGNvbW1hbmQgaW1tZWRpYXRlbHlcbiAgICAgICAgbGV0IHJlamVjdDtcbiAgICAgICAgdGhpcy5jdXJDb21tYW5kQ2FuY2VsbGFibGUgPSBCLnJlc29sdmUoKS50aGVuKCgpID0+IHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBwcm9taXNlL3ByZWZlci1hd2FpdC10by10aGVuXG4gICAgICAgICAgLy8gaW4gb3JkZXIgdG8gYWJvcnQgdGhlIHByb21pc2UsIHdlIG5lZWQgdG8gaGF2ZSBpdCBpbiBhIHJhY2VcbiAgICAgICAgICAvLyB3aXRoIG9uZSB3ZSBjYW4gcmVqZWN0IGZyb20gb3V0c2lkZVxuICAgICAgICAgIGNvbnN0IGNhbmNlbFByb21pc2UgPSBuZXcgQihmdW5jdGlvbiAoXywgX3JlamVjdCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVudXNlZC12YXJzXG4gICAgICAgICAgICByZWplY3QgPSBfcmVqZWN0O1xuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgLy8gaWYgb25lIG9mIHRoZSBhcmdzIGlzIGFuIGltYWdlIGVsZW1lbnQsIGhhbmRsZSBpdCBzZXBhcmF0ZWx5XG4gICAgICAgICAgcmV0dXJuIEIucmFjZShbXG4gICAgICAgICAgICBpbWdFbElkID8gSW1hZ2VFbGVtZW50LmV4ZWN1dGUodGhpcywgY21kLCBpbWdFbElkKSA6IHRoaXNbY21kXSguLi5hcmdzKSxcbiAgICAgICAgICAgIGNhbmNlbFByb21pc2UsXG4gICAgICAgICAgXSk7XG4gICAgICAgIH0pO1xuICAgICAgICAvLyBvdmVycmlkZSB0aGUgQiNjYW5jZWwgZnVuY3Rpb24sIHdoaWNoIGp1c3QgdHVybnMgb2ZmIGxpc3RlbmVyc1xuICAgICAgICB0aGlzLmN1ckNvbW1hbmRDYW5jZWxsYWJsZS5jYW5jZWwgPSBmdW5jdGlvbiBjYW5jZWwgKGVycikge1xuICAgICAgICAgIGlmIChyZWplY3QpIHtcbiAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3VyQ29tbWFuZENhbmNlbGxhYmxlO1xuICAgICAgfSk7XG4gICAgICB0aGlzLmN1ckNvbW1hbmQgPSBuZXh0Q29tbWFuZC5jYXRjaCgoKSA9PiB7fSk7XG4gICAgICByZXMgPSBhd2FpdCBuZXh0Q29tbWFuZDtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMuc2h1dGRvd25VbmV4cGVjdGVkbHkpIHtcbiAgICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hEcml2ZXJFcnJvcignVGhlIGRyaXZlciB3YXMgdW5leHBlY3RlZGx5IHNodXQgZG93biEnKTtcbiAgICAgIH1cbiAgICAgIHJlcyA9IGF3YWl0IHRoaXNbY21kXSguLi5hcmdzKTtcbiAgICB9XG5cbiAgICAvLyBpZiB3ZSBoYXZlIHNldCBhIG5ldyBjb21tYW5kIHRpbWVvdXQgKHdoaWNoIGlzIHRoZSBkZWZhdWx0KSwgc3RhcnQgYVxuICAgIC8vIHRpbWVyIG9uY2Ugd2UndmUgZmluaXNoZWQgZXhlY3V0aW5nIHRoaXMgY29tbWFuZC4gSWYgd2UgZG9uJ3QgY2xlYXJcbiAgICAvLyB0aGUgdGltZXIgKHdoaWNoIGlzIGRvbmUgd2hlbiBhIG5ldyBjb21tYW5kIGNvbWVzIGluKSwgd2Ugd2lsbCB0cmlnZ2VyXG4gICAgLy8gYXV0b21hdGljIHNlc3Npb24gZGVsZXRpb24gaW4gdGhpcy5vbkNvbW1hbmRUaW1lb3V0LiBPZiBjb3Vyc2Ugd2UgZG9uJ3RcbiAgICAvLyB3YW50IHRvIHRyaWdnZXIgdGhlIHRpbWVyIHdoZW4gdGhlIHVzZXIgaXMgc2h1dHRpbmcgZG93biB0aGUgc2Vzc2lvblxuICAgIC8vIGludGVudGlvbmFsbHlcbiAgICBpZiAodGhpcy5pc0NvbW1hbmRzUXVldWVFbmFibGVkICYmIGNtZCAhPT0gJ2RlbGV0ZVNlc3Npb24nKSB7XG4gICAgICAvLyByZXNldGluZyBleGlzdGluZyB0aW1lb3V0XG4gICAgICB0aGlzLnN0YXJ0TmV3Q29tbWFuZFRpbWVvdXQoKTtcbiAgICB9XG5cbiAgICAvLyBsb2cgdGltaW5nIGluZm9ybWF0aW9uIGFib3V0IHRoaXMgY29tbWFuZFxuICAgIGNvbnN0IGVuZFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIHRoaXMuX2V2ZW50SGlzdG9yeS5jb21tYW5kcy5wdXNoKHtjbWQsIHN0YXJ0VGltZSwgZW5kVGltZX0pO1xuICAgIGlmIChjbWQgPT09ICdjcmVhdGVTZXNzaW9uJykge1xuICAgICAgdGhpcy5sb2dFdmVudChFVkVOVF9TRVNTSU9OX1NUQVJUKTtcbiAgICB9IGVsc2UgaWYgKGNtZCA9PT0gJ2RlbGV0ZVNlc3Npb24nKSB7XG4gICAgICB0aGlzLmxvZ0V2ZW50KEVWRU5UX1NFU1NJT05fUVVJVF9ET05FKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRVbmV4cGVjdGVkU2h1dGRvd24gKGVyciA9IG5ldyBlcnJvcnMuTm9TdWNoRHJpdmVyRXJyb3IoJ1RoZSBkcml2ZXIgd2FzIHVuZXhwZWN0ZWRseSBzaHV0IGRvd24hJykpIHtcbiAgICB0aGlzLnVuZXhwZWN0ZWRTaHV0ZG93bkRlZmVycmVkLnJlamVjdChlcnIpOyAvLyBhbGxvdyBvdGhlcnMgdG8gbGlzdGVuIGZvciB0aGlzXG4gICAgdGhpcy5zaHV0ZG93blVuZXhwZWN0ZWRseSA9IHRydWU7XG4gICAgYXdhaXQgdGhpcy5kZWxldGVTZXNzaW9uKHRoaXMuc2Vzc2lvbklkKTtcbiAgICB0aGlzLnNodXRkb3duVW5leHBlY3RlZGx5ID0gZmFsc2U7XG4gICAgdGhpcy5jdXJDb21tYW5kQ2FuY2VsbGFibGUuY2FuY2VsKGVycik7XG4gIH1cblxuICB2YWxpZGF0ZUxvY2F0b3JTdHJhdGVneSAoc3RyYXRlZ3ksIHdlYkNvbnRleHQgPSBmYWxzZSkge1xuICAgIGxldCB2YWxpZFN0cmF0ZWdpZXMgPSB0aGlzLmxvY2F0b3JTdHJhdGVnaWVzO1xuICAgIGxvZy5kZWJ1ZyhgVmFsaWQgbG9jYXRvciBzdHJhdGVnaWVzIGZvciB0aGlzIHJlcXVlc3Q6ICR7dmFsaWRTdHJhdGVnaWVzLmpvaW4oJywgJyl9YCk7XG5cbiAgICBpZiAod2ViQ29udGV4dCkge1xuICAgICAgdmFsaWRTdHJhdGVnaWVzID0gdmFsaWRTdHJhdGVnaWVzLmNvbmNhdCh0aGlzLndlYkxvY2F0b3JTdHJhdGVnaWVzKTtcbiAgICB9XG5cbiAgICBpZiAoIV8uaW5jbHVkZXModmFsaWRTdHJhdGVnaWVzLCBzdHJhdGVneSkpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZFNlbGVjdG9yRXJyb3IoYExvY2F0b3IgU3RyYXRlZ3kgJyR7c3RyYXRlZ3l9JyBpcyBub3Qgc3VwcG9ydGVkIGZvciB0aGlzIHNlc3Npb25gKTtcbiAgICB9XG4gIH1cblxuICAvKlxuICAgKiBSZXN0YXJ0IHRoZSBzZXNzaW9uIHdpdGggdGhlIG9yaWdpbmFsIGNhcHMsXG4gICAqIHByZXNlcnZpbmcgdGhlIHRpbWVvdXQgY29uZmlnLlxuICAgKi9cbiAgYXN5bmMgcmVzZXQgKCkge1xuICAgIGxvZy5kZWJ1ZygnUmVzZXR0aW5nIGFwcCBtaWQtc2Vzc2lvbicpO1xuICAgIGxvZy5kZWJ1ZygnUnVubmluZyBnZW5lcmljIGZ1bGwgcmVzZXQnKTtcblxuICAgIC8vIHByZXNlcnZpbmcgc3RhdGVcbiAgICBsZXQgY3VycmVudENvbmZpZyA9IHt9O1xuICAgIGZvciAobGV0IHByb3BlcnR5IG9mIFsnaW1wbGljaXRXYWl0TXMnLCAnbmV3Q29tbWFuZFRpbWVvdXRNcycsICdzZXNzaW9uSWQnLCAncmVzZXRPblVuZXhwZWN0ZWRTaHV0ZG93biddKSB7XG4gICAgICBjdXJyZW50Q29uZmlnW3Byb3BlcnR5XSA9IHRoaXNbcHJvcGVydHldO1xuICAgIH1cblxuICAgIC8vIFdlIGFsc28gbmVlZCB0byBwcmVzZXJ2ZSB0aGUgdW5leHBlY3RlZCBzaHV0ZG93biwgYW5kIG1ha2Ugc3VyZSBpdCBpcyBub3QgY2FuY2VsbGVkIGR1cmluZyByZXNldC5cbiAgICB0aGlzLnJlc2V0T25VbmV4cGVjdGVkU2h1dGRvd24gPSAoKSA9PiB7fTtcblxuICAgIC8vIENvbnN0cnVjdCB0aGUgYXJndW1lbnRzIGZvciBjcmVhdGVTZXNzaW9uIGRlcGVuZGluZyBvbiB0aGUgcHJvdG9jb2wgdHlwZVxuICAgIGNvbnN0IGFyZ3MgPSB0aGlzLnByb3RvY29sID09PSBCYXNlRHJpdmVyLkRSSVZFUl9QUk9UT0NPTC5XM0MgP1xuICAgICAgW3VuZGVmaW5lZCwgdW5kZWZpbmVkLCB7YWx3YXlzTWF0Y2g6IHRoaXMuY2FwcywgZmlyc3RNYXRjaDogW3t9XX1dIDpcbiAgICAgIFt0aGlzLmNhcHNdO1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuZGVsZXRlU2Vzc2lvbih0aGlzLnNlc3Npb25JZCk7XG4gICAgICBsb2cuZGVidWcoJ1Jlc3RhcnRpbmcgYXBwJyk7XG4gICAgICBhd2FpdCB0aGlzLmNyZWF0ZVNlc3Npb24oLi4uYXJncyk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIC8vIGFsd2F5cyByZXN0b3JlIHN0YXRlLlxuICAgICAgZm9yIChsZXQgW2tleSwgdmFsdWVdIG9mIF8udG9QYWlycyhjdXJyZW50Q29uZmlnKSkge1xuICAgICAgICB0aGlzW2tleV0gPSB2YWx1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5jbGVhck5ld0NvbW1hbmRUaW1lb3V0KCk7XG4gIH1cblxuICBhc3luYyBnZXRTd2lwZU9wdGlvbnMgKGdlc3R1cmVzLCB0b3VjaENvdW50ID0gMSkge1xuICAgIGxldCBzdGFydFggPSB0aGlzLmhlbHBlcnMuZ2V0Q29vcmREZWZhdWx0KGdlc3R1cmVzWzBdLm9wdGlvbnMueCksXG4gICAgICAgIHN0YXJ0WSA9IHRoaXMuaGVscGVycy5nZXRDb29yZERlZmF1bHQoZ2VzdHVyZXNbMF0ub3B0aW9ucy55KSxcbiAgICAgICAgZW5kWCA9IHRoaXMuaGVscGVycy5nZXRDb29yZERlZmF1bHQoZ2VzdHVyZXNbMl0ub3B0aW9ucy54KSxcbiAgICAgICAgZW5kWSA9IHRoaXMuaGVscGVycy5nZXRDb29yZERlZmF1bHQoZ2VzdHVyZXNbMl0ub3B0aW9ucy55KSxcbiAgICAgICAgZHVyYXRpb24gPSB0aGlzLmhlbHBlcnMuZ2V0U3dpcGVUb3VjaER1cmF0aW9uKGdlc3R1cmVzWzFdKSxcbiAgICAgICAgZWxlbWVudCA9IGdlc3R1cmVzWzBdLm9wdGlvbnMuZWxlbWVudCxcbiAgICAgICAgZGVzdEVsZW1lbnQgPSBnZXN0dXJlc1syXS5vcHRpb25zLmVsZW1lbnQgfHwgZ2VzdHVyZXNbMF0ub3B0aW9ucy5lbGVtZW50O1xuXG4gICAgLy8gdGhlcmUncyBubyBkZXN0aW5hdGlvbiBlbGVtZW50IGhhbmRsaW5nIGluIGJvb3RzdHJhcCBhbmQgc2luY2UgaXQgYXBwbGllcyB0byBhbGwgcGxhdGZvcm1zLCB3ZSBoYW5kbGUgaXQgaGVyZVxuICAgIGlmICh1dGlsLmhhc1ZhbHVlKGRlc3RFbGVtZW50KSkge1xuICAgICAgbGV0IGxvY1Jlc3VsdCA9IGF3YWl0IHRoaXMuZ2V0TG9jYXRpb25JblZpZXcoZGVzdEVsZW1lbnQpO1xuICAgICAgbGV0IHNpemVSZXN1bHQgPSBhd2FpdCB0aGlzLmdldFNpemUoZGVzdEVsZW1lbnQpO1xuICAgICAgbGV0IG9mZnNldFggPSAoTWF0aC5hYnMoZW5kWCkgPCAxICYmIE1hdGguYWJzKGVuZFgpID4gMCkgPyBzaXplUmVzdWx0LndpZHRoICogZW5kWCA6IGVuZFg7XG4gICAgICBsZXQgb2Zmc2V0WSA9IChNYXRoLmFicyhlbmRZKSA8IDEgJiYgTWF0aC5hYnMoZW5kWSkgPiAwKSA/IHNpemVSZXN1bHQuaGVpZ2h0ICogZW5kWSA6IGVuZFk7XG4gICAgICBlbmRYID0gbG9jUmVzdWx0LnggKyBvZmZzZXRYO1xuICAgICAgZW5kWSA9IGxvY1Jlc3VsdC55ICsgb2Zmc2V0WTtcbiAgICAgIC8vIGlmIHRoZSB0YXJnZXQgZWxlbWVudCB3YXMgcHJvdmlkZWQsIHRoZSBjb29yZGluYXRlcyBmb3IgdGhlIGRlc3RpbmF0aW9uIG5lZWQgdG8gYmUgcmVsYXRpdmUgdG8gaXQuXG4gICAgICBpZiAodXRpbC5oYXNWYWx1ZShlbGVtZW50KSkge1xuICAgICAgICBsZXQgZmlyc3RFbExvY2F0aW9uID0gYXdhaXQgdGhpcy5nZXRMb2NhdGlvbkluVmlldyhlbGVtZW50KTtcbiAgICAgICAgZW5kWCAtPSBmaXJzdEVsTG9jYXRpb24ueDtcbiAgICAgICAgZW5kWSAtPSBmaXJzdEVsTG9jYXRpb24ueTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gY2xpZW50cyBhcmUgcmVzcG9uc2libGUgdG8gdXNlIHRoZXNlIG9wdGlvbnMgY29ycmVjdGx5XG4gICAgcmV0dXJuIHtzdGFydFgsIHN0YXJ0WSwgZW5kWCwgZW5kWSwgZHVyYXRpb24sIHRvdWNoQ291bnQsIGVsZW1lbnR9O1xuICB9XG5cbiAgcHJveHlBY3RpdmUgKC8qIHNlc3Npb25JZCAqLykge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGdldFByb3h5QXZvaWRMaXN0ICgvKiBzZXNzaW9uSWQgKi8pIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICBjYW5Qcm94eSAoLyogc2Vzc2lvbklkICovKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLyoqXG4gICAqIFdoZXRoZXIgYSBnaXZlbiBjb21tYW5kIHJvdXRlIChleHByZXNzZWQgYXMgbWV0aG9kIGFuZCB1cmwpIHNob3VsZCBub3QgYmVcbiAgICogcHJveGllZCBhY2NvcmRpbmcgdG8gdGhpcyBkcml2ZXJcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHNlc3Npb25JZCAtIHRoZSBjdXJyZW50IHNlc3Npb25JZCAoaW4gY2FzZSB0aGUgZHJpdmVyIHJ1bnNcbiAgICogbXVsdGlwbGUgc2Vzc2lvbiBpZHMgYW5kIHJlcXVpcmVzIGl0KS4gVGhpcyBpcyBub3QgdXNlZCBpbiB0aGlzIG1ldGhvZCBidXRcbiAgICogc2hvdWxkIGJlIG1hZGUgYXZhaWxhYmxlIHRvIG92ZXJyaWRkZW4gbWV0aG9kcy5cbiAgICogQHBhcmFtIHtzdHJpbmd9IG1ldGhvZCAtIEhUVFAgbWV0aG9kIG9mIHRoZSByb3V0ZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gdXJsIG9mIHRoZSByb3V0ZVxuICAgKlxuICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gLSB3aGV0aGVyIHRoZSByb3V0ZSBzaG91bGQgYmUgYXZvaWRlZFxuICAgKi9cbiAgcHJveHlSb3V0ZUlzQXZvaWRlZCAoc2Vzc2lvbklkLCBtZXRob2QsIHVybCkge1xuICAgIGZvciAobGV0IGF2b2lkU2NoZW1hIG9mIHRoaXMuZ2V0UHJveHlBdm9pZExpc3Qoc2Vzc2lvbklkKSkge1xuICAgICAgaWYgKCFfLmlzQXJyYXkoYXZvaWRTY2hlbWEpIHx8IGF2b2lkU2NoZW1hLmxlbmd0aCAhPT0gMikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Byb3h5IGF2b2lkYW5jZSBtdXN0IGJlIGEgbGlzdCBvZiBwYWlycycpO1xuICAgICAgfVxuICAgICAgbGV0IFthdm9pZE1ldGhvZCwgYXZvaWRQYXRoUmVnZXhdID0gYXZvaWRTY2hlbWE7XG4gICAgICBpZiAoIV8uaW5jbHVkZXMoWydHRVQnLCAnUE9TVCcsICdERUxFVEUnXSwgYXZvaWRNZXRob2QpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5yZWNvZ25pemVkIHByb3h5IGF2b2lkYW5jZSBtZXRob2QgJyR7YXZvaWRNZXRob2R9J2ApO1xuICAgICAgfVxuICAgICAgaWYgKCFfLmlzUmVnRXhwKGF2b2lkUGF0aFJlZ2V4KSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Byb3h5IGF2b2lkYW5jZSBwYXRoIG11c3QgYmUgYSByZWd1bGFyIGV4cHJlc3Npb24nKTtcbiAgICAgIH1cbiAgICAgIGxldCBub3JtYWxpemVkVXJsID0gdXJsLnJlcGxhY2UoL15cXC93ZFxcL2h1Yi8sICcnKTtcbiAgICAgIGlmIChhdm9pZE1ldGhvZCA9PT0gbWV0aG9kICYmIGF2b2lkUGF0aFJlZ2V4LnRlc3Qobm9ybWFsaXplZFVybCkpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGFkZE1hbmFnZWREcml2ZXIgKGRyaXZlcikge1xuICAgIHRoaXMubWFuYWdlZERyaXZlcnMucHVzaChkcml2ZXIpO1xuICB9XG5cbiAgZ2V0TWFuYWdlZERyaXZlcnMgKCkge1xuICAgIHJldHVybiB0aGlzLm1hbmFnZWREcml2ZXJzO1xuICB9XG59XG5cbkJhc2VEcml2ZXIuRFJJVkVSX1BST1RPQ09MID0ge1xuICBXM0M6ICdXM0MnLFxuICBNSlNPTldQOiAnTUpTT05XUCcsXG59O1xuXG5mb3IgKGxldCBbY21kLCBmbl0gb2YgXy50b1BhaXJzKGNvbW1hbmRzKSkge1xuICBCYXNlRHJpdmVyLnByb3RvdHlwZVtjbWRdID0gZm47XG59XG5cbmV4cG9ydCB7IEJhc2VEcml2ZXIgfTtcbmV4cG9ydCBkZWZhdWx0IEJhc2VEcml2ZXI7XG4iXSwiZmlsZSI6ImxpYi9iYXNlZHJpdmVyL2RyaXZlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
