"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.parseCaps = parseCaps;
exports.processCapabilities = processCapabilities;
exports.validateCaps = validateCaps;
exports.mergeCaps = mergeCaps;
exports.findNonPrefixedCaps = findNonPrefixedCaps;

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _desiredCaps = require("./desired-caps");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("./logger"));

var _errors = require("../protocol/errors");

function mergeCaps(primary = {}, secondary = {}) {
  let result = Object.assign({}, primary);

  for (let [name, value] of _lodash.default.toPairs(secondary)) {
    if (!_lodash.default.isUndefined(primary[name])) {
      throw new _errors.errors.InvalidArgumentError(`property '${name}' should not exist on both primary (${JSON.stringify(primary)}) and secondary (${JSON.stringify(secondary)}) object`);
    }

    result[name] = value;
  }

  return result;
}

function validateCaps(caps, constraints = {}, opts = {}) {
  let {
    skipPresenceConstraint
  } = opts;

  if (!_lodash.default.isPlainObject(caps)) {
    throw new _errors.errors.InvalidArgumentError(`must be a JSON object`);
  }

  constraints = _lodash.default.cloneDeep(constraints);

  if (skipPresenceConstraint) {
    for (let key of _lodash.default.keys(constraints)) {
      delete constraints[key].presence;
    }
  }

  let validationErrors = _desiredCaps.validator.validate(_lodash.default.pickBy(caps, _appiumSupport.util.hasValue), constraints, {
    fullMessages: false
  });

  if (validationErrors) {
    let message = [];

    for (let [attribute, reasons] of _lodash.default.toPairs(validationErrors)) {
      for (let reason of reasons) {
        message.push(`'${attribute}' ${reason}`);
      }
    }

    throw new _errors.errors.InvalidArgumentError(message.join('; '));
  }

  return caps;
}

const STANDARD_CAPS = ['browserName', 'browserVersion', 'platformName', 'acceptInsecureCerts', 'pageLoadStrategy', 'proxy', 'setWindowRect', 'timeouts', 'unhandledPromptBehavior'];

function isStandardCap(cap) {
  return !!_lodash.default.find(STANDARD_CAPS, standardCap => standardCap.toLowerCase() === `${cap}`.toLowerCase());
}

function stripAppiumPrefixes(caps) {
  const prefix = 'appium:';

  const prefixedCaps = _lodash.default.filter(_lodash.default.keys(caps), cap => `${cap}`.startsWith(prefix));

  const badPrefixedCaps = [];

  for (let prefixedCap of prefixedCaps) {
    const strippedCapName = prefixedCap.substr(prefix.length);

    if (isStandardCap(strippedCapName)) {
      badPrefixedCaps.push(strippedCapName);
    }

    caps[strippedCapName] = caps[prefixedCap];
    delete caps[prefixedCap];
  }

  if (badPrefixedCaps.length > 0) {
    throw new _errors.errors.InvalidArgumentError(`The capabilities ${JSON.stringify(badPrefixedCaps)} are standard capabilities and should not have the "appium:" prefix`);
  }
}

function findNonPrefixedCaps({
  alwaysMatch = {},
  firstMatch = []
}) {
  return _lodash.default.chain([alwaysMatch, ...firstMatch]).reduce((unprefixedCaps, caps) => [...unprefixedCaps, ...(0, _lodash.default)(caps).keys().filter(cap => !cap.includes(':') && !isStandardCap(cap))], []).uniq().value();
}

function parseCaps(caps, constraints = {}, shouldValidateCaps = true) {
  if (!_lodash.default.isPlainObject(caps)) {
    throw new _errors.errors.InvalidArgumentError('The capabilities argument was not valid for the following reason(s): "capabilities" must be a JSON object.');
  }

  let {
    alwaysMatch: requiredCaps = {},
    firstMatch: allFirstMatchCaps = [{}]
  } = caps;

  if (!_lodash.default.isArray(allFirstMatchCaps)) {
    throw new _errors.errors.InvalidArgumentError('The capabilities.firstMatch argument was not valid for the following reason(s): "capabilities.firstMatch" must be a JSON array or undefined');
  }

  if (allFirstMatchCaps.length === 0) {
    allFirstMatchCaps.push({});
  }

  let nonPrefixedCaps = findNonPrefixedCaps(caps);

  if (!_lodash.default.isEmpty(nonPrefixedCaps)) {
    _logger.default.warn(`The capabilities ${JSON.stringify(nonPrefixedCaps)} are not standard capabilities and should have an extension prefix`);
  }

  stripAppiumPrefixes(requiredCaps);

  for (let firstMatchCaps of allFirstMatchCaps) {
    stripAppiumPrefixes(firstMatchCaps);
  }

  if (shouldValidateCaps) {
    requiredCaps = validateCaps(requiredCaps, constraints, {
      skipPresenceConstraint: true
    });
  }

  let filteredConstraints = (0, _objectSpread2.default)({}, constraints);

  let requiredCapsKeys = _lodash.default.keys(requiredCaps);

  for (let key of _lodash.default.keys(filteredConstraints)) {
    if (requiredCapsKeys.includes(key)) {
      delete filteredConstraints[key];
    }
  }

  let validationErrors = [];
  let validatedFirstMatchCaps = allFirstMatchCaps.map(firstMatchCaps => {
    try {
      return shouldValidateCaps ? validateCaps(firstMatchCaps, filteredConstraints) : firstMatchCaps;
    } catch (e) {
      validationErrors.push(e.message);
      return null;
    }
  }).filter(caps => !_lodash.default.isNull(caps));
  let matchedCaps = null;

  for (let firstMatchCaps of validatedFirstMatchCaps) {
    try {
      matchedCaps = mergeCaps(requiredCaps, firstMatchCaps);

      if (matchedCaps) {
        break;
      }
    } catch (err) {
      _logger.default.warn(err.message);
    }
  }

  return {
    requiredCaps,
    allFirstMatchCaps,
    validatedFirstMatchCaps,
    matchedCaps,
    validationErrors
  };
}

function processCapabilities(caps, constraints = {}, shouldValidateCaps = true) {
  const {
    matchedCaps,
    validationErrors
  } = parseCaps(caps, constraints, shouldValidateCaps);

  if (!_appiumSupport.util.hasValue(matchedCaps)) {
    if (_lodash.default.isArray(caps.firstMatch) && caps.firstMatch.length > 1) {
      throw new _errors.errors.InvalidArgumentError(`Could not find matching capabilities from ${JSON.stringify(caps)}:\n ${validationErrors.join('\n')}`);
    } else {
      throw new _errors.errors.InvalidArgumentError(validationErrors[0]);
    }
  }

  return matchedCaps;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2NhcGFiaWxpdGllcy5qcyJdLCJuYW1lcyI6WyJtZXJnZUNhcHMiLCJwcmltYXJ5Iiwic2Vjb25kYXJ5IiwicmVzdWx0IiwiT2JqZWN0IiwiYXNzaWduIiwibmFtZSIsInZhbHVlIiwiXyIsInRvUGFpcnMiLCJpc1VuZGVmaW5lZCIsImVycm9ycyIsIkludmFsaWRBcmd1bWVudEVycm9yIiwiSlNPTiIsInN0cmluZ2lmeSIsInZhbGlkYXRlQ2FwcyIsImNhcHMiLCJjb25zdHJhaW50cyIsIm9wdHMiLCJza2lwUHJlc2VuY2VDb25zdHJhaW50IiwiaXNQbGFpbk9iamVjdCIsImNsb25lRGVlcCIsImtleSIsImtleXMiLCJwcmVzZW5jZSIsInZhbGlkYXRpb25FcnJvcnMiLCJ2YWxpZGF0b3IiLCJ2YWxpZGF0ZSIsInBpY2tCeSIsInV0aWwiLCJoYXNWYWx1ZSIsImZ1bGxNZXNzYWdlcyIsIm1lc3NhZ2UiLCJhdHRyaWJ1dGUiLCJyZWFzb25zIiwicmVhc29uIiwicHVzaCIsImpvaW4iLCJTVEFOREFSRF9DQVBTIiwiaXNTdGFuZGFyZENhcCIsImNhcCIsImZpbmQiLCJzdGFuZGFyZENhcCIsInRvTG93ZXJDYXNlIiwic3RyaXBBcHBpdW1QcmVmaXhlcyIsInByZWZpeCIsInByZWZpeGVkQ2FwcyIsImZpbHRlciIsInN0YXJ0c1dpdGgiLCJiYWRQcmVmaXhlZENhcHMiLCJwcmVmaXhlZENhcCIsInN0cmlwcGVkQ2FwTmFtZSIsInN1YnN0ciIsImxlbmd0aCIsImZpbmROb25QcmVmaXhlZENhcHMiLCJhbHdheXNNYXRjaCIsImZpcnN0TWF0Y2giLCJjaGFpbiIsInJlZHVjZSIsInVucHJlZml4ZWRDYXBzIiwiaW5jbHVkZXMiLCJ1bmlxIiwicGFyc2VDYXBzIiwic2hvdWxkVmFsaWRhdGVDYXBzIiwicmVxdWlyZWRDYXBzIiwiYWxsRmlyc3RNYXRjaENhcHMiLCJpc0FycmF5Iiwibm9uUHJlZml4ZWRDYXBzIiwiaXNFbXB0eSIsImxvZyIsIndhcm4iLCJmaXJzdE1hdGNoQ2FwcyIsImZpbHRlcmVkQ29uc3RyYWludHMiLCJyZXF1aXJlZENhcHNLZXlzIiwidmFsaWRhdGVkRmlyc3RNYXRjaENhcHMiLCJtYXAiLCJlIiwiaXNOdWxsIiwibWF0Y2hlZENhcHMiLCJlcnIiLCJwcm9jZXNzQ2FwYWJpbGl0aWVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUlBLFNBQVNBLFNBQVQsQ0FBb0JDLE9BQU8sR0FBRyxFQUE5QixFQUFrQ0MsU0FBUyxHQUFHLEVBQTlDLEVBQWtEO0FBQ2hELE1BQUlDLE1BQU0sR0FBR0MsTUFBTSxDQUFDQyxNQUFQLENBQWMsRUFBZCxFQUFrQkosT0FBbEIsQ0FBYjs7QUFFQSxPQUFLLElBQUksQ0FBQ0ssSUFBRCxFQUFPQyxLQUFQLENBQVQsSUFBMEJDLGdCQUFFQyxPQUFGLENBQVVQLFNBQVYsQ0FBMUIsRUFBZ0Q7QUFFOUMsUUFBSSxDQUFDTSxnQkFBRUUsV0FBRixDQUFjVCxPQUFPLENBQUNLLElBQUQsQ0FBckIsQ0FBTCxFQUFtQztBQUNqQyxZQUFNLElBQUlLLGVBQU9DLG9CQUFYLENBQWlDLGFBQVlOLElBQUssdUNBQXNDTyxJQUFJLENBQUNDLFNBQUwsQ0FBZWIsT0FBZixDQUF3QixvQkFBbUJZLElBQUksQ0FBQ0MsU0FBTCxDQUFlWixTQUFmLENBQTBCLFVBQTdKLENBQU47QUFDRDs7QUFDREMsSUFBQUEsTUFBTSxDQUFDRyxJQUFELENBQU4sR0FBZUMsS0FBZjtBQUNEOztBQUVELFNBQU9KLE1BQVA7QUFDRDs7QUFHRCxTQUFTWSxZQUFULENBQXVCQyxJQUF2QixFQUE2QkMsV0FBVyxHQUFHLEVBQTNDLEVBQStDQyxJQUFJLEdBQUcsRUFBdEQsRUFBMEQ7QUFFeEQsTUFBSTtBQUFDQyxJQUFBQTtBQUFELE1BQTJCRCxJQUEvQjs7QUFFQSxNQUFJLENBQUNWLGdCQUFFWSxhQUFGLENBQWdCSixJQUFoQixDQUFMLEVBQTRCO0FBQzFC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Qyw2Q0FBNENDLElBQUksQ0FBQ0MsU0FBTCxDQUFlRSxJQUFmLENBQXFCLE9BQU1TLGdCQUFnQixDQUFDWSxJQUFqQixDQUFzQixJQUF0QixDQUE0QixFQUFwSSxDQUFOO0FBQ0QsS0FIRCxNQUdPO0FBRUwsWUFBTSxJQUFJMUIsZUFBT0Msb0JBQVgsQ0FBZ0NhLGdCQUFnQixDQUFDLENBQUQsQ0FBaEQsQ0FBTjtBQUNEO0FBQ0Y7O0FBRUQsU0FBT3FELFdBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyB2YWxpZGF0b3IgfSBmcm9tICcuL2Rlc2lyZWQtY2Fwcyc7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICcuLi9wcm90b2NvbC9lcnJvcnMnO1xuXG4vLyBUYWtlcyBwcmltYXJ5IGNhcHMgb2JqZWN0IGFuZCBtZXJnZXMgaXQgaW50byBhIHNlY29uZGFyeSBjYXBzIG9iamVjdC5cbi8vIChzZWUgaHR0cHM6Ly93d3cudzMub3JnL1RSL3dlYmRyaXZlci8jZGZuLW1lcmdpbmctY2FwYWJpbGl0aWVzKVxuZnVuY3Rpb24gbWVyZ2VDYXBzIChwcmltYXJ5ID0ge30sIHNlY29uZGFyeSA9IHt9KSB7XG4gIGxldCByZXN1bHQgPSBPYmplY3QuYXNzaWduKHt9LCBwcmltYXJ5KTtcblxuICBmb3IgKGxldCBbbmFtZSwgdmFsdWVdIG9mIF8udG9QYWlycyhzZWNvbmRhcnkpKSB7XG4gICAgLy8gT3ZlcndyaXRpbmcgaXMgbm90IGFsbG93ZWQuIFByaW1hcnkgYW5kIHNlY29uZGFyeSBtdXN0IGhhdmUgZGlmZmVyZW50IHByb3BlcnRpZXMgKHczYyBydWxlIDQuNClcbiAgICBpZiAoIV8uaXNVbmRlZmluZWQocHJpbWFyeVtuYW1lXSkpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEFyZ3VtZW50RXJyb3IoYHByb3BlcnR5ICcke25hbWV9JyBzaG91bGQgbm90IGV4aXN0IG9uIGJvdGggcHJpbWFyeSAoJHtKU09OLnN0cmluZ2lmeShwcmltYXJ5KX0pIGFuZCBzZWNvbmRhcnkgKCR7SlNPTi5zdHJpbmdpZnkoc2Vjb25kYXJ5KX0pIG9iamVjdGApO1xuICAgIH1cbiAgICByZXN1bHRbbmFtZV0gPSB2YWx1ZTtcbiAgfVxuXG4gIHJldHVybiByZXN1bHQ7XG59XG5cbi8vIFZhbGlkYXRlcyBjYXBzIGFnYWluc3QgYSBzZXQgb2YgY29uc3RyYWludHNcbmZ1bmN0aW9uIHZhbGlkYXRlQ2FwcyAoY2FwcywgY29uc3RyYWludHMgPSB7fSwgb3B0cyA9IHt9KSB7XG5cbiAgbGV0IHtza2lwUHJlc2VuY2VDb25zdHJhaW50fSA9IG9wdHM7XG5cbiAgaWYgKCFfLmlzUGxhaW5PYmplY3QoY2FwcykpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWRBcmd1bWVudEVycm9yKGBtdXN0IGJlIGEgSlNPTiBvYmplY3RgKTtcbiAgfVxuXG4gIGNvbnN0cmFpbnRzID0gXy5jbG9uZURlZXAoY29uc3RyYWludHMpOyAvLyBEZWZlbnNpdmUgY29weVxuXG4gIGlmIChza2lwUHJlc2VuY2VDb25zdHJhaW50KSB7XG4gICAgLy8gUmVtb3ZlIHRoZSAncHJlc2VuY2UnIGNvbnN0cmFpbnQgaWYgd2UncmUgbm90IGNoZWNraW5nIGZvciBpdFxuICAgIGZvciAobGV0IGtleSBvZiBfLmtleXMoY29uc3RyYWludHMpKSB7XG4gICAgICBkZWxldGUgY29uc3RyYWludHNba2V5XS5wcmVzZW5jZTtcbiAgICB9XG4gIH1cblxuICBsZXQgdmFsaWRhdGlvbkVycm9ycyA9IHZhbGlkYXRvci52YWxpZGF0ZShfLnBpY2tCeShjYXBzLCB1dGlsLmhhc1ZhbHVlKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdHJhaW50cyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7ZnVsbE1lc3NhZ2VzOiBmYWxzZX0pO1xuXG4gIGlmICh2YWxpZGF0aW9uRXJyb3JzKSB7XG4gICAgbGV0IG1lc3NhZ2UgPSBbXTtcbiAgICBmb3IgKGxldCBbYXR0cmlidXRlLCByZWFzb25zXSBvZiBfLnRvUGFpcnModmFsaWRhdGlvbkVycm9ycykpIHtcbiAgICAgIGZvciAobGV0IHJlYXNvbiBvZiByZWFzb25zKSB7XG4gICAgICAgIG1lc3NhZ2UucHVzaChgJyR7YXR0cmlidXRlfScgJHtyZWFzb259YCk7XG4gICAgICB9XG4gICAgfVxuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEFyZ3VtZW50RXJyb3IobWVzc2FnZS5qb2luKCc7ICcpKTtcbiAgfVxuXG4gIC8vIFJldHVybiBjYXBzXG4gIHJldHVybiBjYXBzO1xufVxuXG4vLyBTdGFuZGFyZCwgbm9uLXByZWZpeGVkIGNhcGFiaWxpdGllcyAoc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi93ZWJkcml2ZXIvI2Rmbi10YWJsZS1vZi1zdGFuZGFyZC1jYXBhYmlsaXRpZXMpXG5jb25zdCBTVEFOREFSRF9DQVBTID0gW1xuICAnYnJvd3Nlck5hbWUnLFxuICAnYnJvd3NlclZlcnNpb24nLFxuICAncGxhdGZvcm1OYW1lJyxcbiAgJ2FjY2VwdEluc2VjdXJlQ2VydHMnLFxuICAncGFnZUxvYWRTdHJhdGVneScsXG4gICdwcm94eScsXG4gICdzZXRXaW5kb3dSZWN0JyxcbiAgJ3RpbWVvdXRzJyxcbiAgJ3VuaGFuZGxlZFByb21wdEJlaGF2aW9yJ1xuXTtcblxuZnVuY3Rpb24gaXNTdGFuZGFyZENhcCAoY2FwKSB7XG4gIHJldHVybiAhIV8uZmluZChTVEFOREFSRF9DQVBTLCAoc3RhbmRhcmRDYXApID0+IHN0YW5kYXJkQ2FwLnRvTG93ZXJDYXNlKCkgPT09IGAke2NhcH1gLnRvTG93ZXJDYXNlKCkpO1xufVxuXG4vLyBJZiB0aGUgJ2FwcGl1bTonIHByZWZpeCB3YXMgcHJvdmlkZWQgYW5kIGl0J3MgYSB2YWxpZCBjYXBhYmlsaXR5LCBzdHJpcCBvdXQgdGhlIHByZWZpeCAoc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi93ZWJkcml2ZXIvI2Rmbi1leHRlbnNpb24tY2FwYWJpbGl0aWVzKVxuLy8gKE5PVEU6IE1ldGhvZCBpcyBkZXN0cnVjdGl2ZSBhbmQgbXV0YXRlcyBjb250ZW50cyBvZiBjYXBzKVxuZnVuY3Rpb24gc3RyaXBBcHBpdW1QcmVmaXhlcyAoY2Fwcykge1xuICBjb25zdCBwcmVmaXggPSAnYXBwaXVtOic7XG4gIGNvbnN0IHByZWZpeGVkQ2FwcyA9IF8uZmlsdGVyKF8ua2V5cyhjYXBzKSwgY2FwID0+IGAke2NhcH1gLnN0YXJ0c1dpdGgocHJlZml4KSk7XG4gIGNvbnN0IGJhZFByZWZpeGVkQ2FwcyA9IFtdO1xuXG4gIC8vIFN0cmlwIG91dCB0aGUgJ2FwcGl1bTonIHByZWZpeFxuICBmb3IgKGxldCBwcmVmaXhlZENhcCBvZiBwcmVmaXhlZENhcHMpIHtcbiAgICBjb25zdCBzdHJpcHBlZENhcE5hbWUgPSBwcmVmaXhlZENhcC5zdWJzdHIocHJlZml4Lmxlbmd0aCk7XG5cbiAgICAvLyBJZiBpdCdzIHN0YW5kYXJkIGNhcGFiaWxpdHkgdGhhdCB3YXMgcHJlZml4ZWQsIGFkZCBpdCB0byBhbiBhcnJheSBvZiBpbmNvcnJlY3RseSBwcmVmaXhlZCBjYXBhYmlsaXRpZXNcbiAgICBpZiAoaXNTdGFuZGFyZENhcChzdHJpcHBlZENhcE5hbWUpKSB7XG4gICAgICBiYWRQcmVmaXhlZENhcHMucHVzaChzdHJpcHBlZENhcE5hbWUpO1xuICAgIH1cblxuICAgIC8vIFN0cmlwIG91dCB0aGUgcHJlZml4XG4gICAgY2Fwc1tzdHJpcHBlZENhcE5hbWVdID0gY2Fwc1twcmVmaXhlZENhcF07XG4gICAgZGVsZXRlIGNhcHNbcHJlZml4ZWRDYXBdO1xuICB9XG5cbiAgLy8gSWYgd2UgZm91bmQgc3RhbmRhcmQgY2FwcyB0aGF0IHdlcmUgaW5jb3JyZWN0bHkgcHJlZml4ZWQsIHRocm93IGFuIGV4Y2VwdGlvbiAoZS5nLjogZG9uJ3QgYWNjZXB0ICdhcHBpdW06cGxhdGZvcm1OYW1lJywgb25seSBhY2NlcHQganVzdCAncGxhdGZvcm1OYW1lJylcbiAgaWYgKGJhZFByZWZpeGVkQ2Fwcy5sZW5ndGggPiAwKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkQXJndW1lbnRFcnJvcihgVGhlIGNhcGFiaWxpdGllcyAke0pTT04uc3RyaW5naWZ5KGJhZFByZWZpeGVkQ2Fwcyl9IGFyZSBzdGFuZGFyZCBjYXBhYmlsaXRpZXMgYW5kIHNob3VsZCBub3QgaGF2ZSB0aGUgXCJhcHBpdW06XCIgcHJlZml4YCk7XG4gIH1cbn1cblxuLyoqXG4gKiBHZXQgYW4gYXJyYXkgb2YgYWxsIHRoZSB1bnByZWZpeGVkIGNhcHMgdGhhdCBhcmUgYmVpbmcgdXNlZCBpbiAnYWx3YXlzTWF0Y2gnIGFuZCBhbGwgb2YgdGhlICdmaXJzdE1hdGNoJyBvYmplY3RcbiAqIEBwYXJhbSB7T2JqZWN0fSBjYXBzIEEgY2FwYWJpbGl0aWVzIG9iamVjdFxuICovXG5mdW5jdGlvbiBmaW5kTm9uUHJlZml4ZWRDYXBzICh7YWx3YXlzTWF0Y2ggPSB7fSwgZmlyc3RNYXRjaCA9IFtdfSkge1xuICByZXR1cm4gXy5jaGFpbihbYWx3YXlzTWF0Y2gsIC4uLmZpcnN0TWF0Y2hdKVxuICAgIC5yZWR1Y2UoKHVucHJlZml4ZWRDYXBzLCBjYXBzKSA9PiBbXG4gICAgICAuLi51bnByZWZpeGVkQ2FwcyxcbiAgICAgIC4uLl8oY2Fwcykua2V5cygpLmZpbHRlcigoY2FwKSA9PiAhY2FwLmluY2x1ZGVzKCc6JykgJiYgIWlzU3RhbmRhcmRDYXAoY2FwKSksXG4gICAgXSwgW10pXG4gICAgLnVuaXEoKVxuICAgIC52YWx1ZSgpO1xufVxuXG4vLyBQYXJzZSBjYXBhYmlsaXRpZXMgKGJhc2VkIG9uIGh0dHBzOi8vd3d3LnczLm9yZy9UUi93ZWJkcml2ZXIvI3Byb2Nlc3NpbmctY2FwYWJpbGl0aWVzKVxuZnVuY3Rpb24gcGFyc2VDYXBzIChjYXBzLCBjb25zdHJhaW50cyA9IHt9LCBzaG91bGRWYWxpZGF0ZUNhcHMgPSB0cnVlKSB7XG4gIC8vIElmIGNhcGFiaWxpdGllcyByZXF1ZXN0IGlzIG5vdCBhbiBvYmplY3QsIHJldHVybiBlcnJvciAoIzEuMSlcbiAgaWYgKCFfLmlzUGxhaW5PYmplY3QoY2FwcykpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWRBcmd1bWVudEVycm9yKCdUaGUgY2FwYWJpbGl0aWVzIGFyZ3VtZW50IHdhcyBub3QgdmFsaWQgZm9yIHRoZSBmb2xsb3dpbmcgcmVhc29uKHMpOiBcImNhcGFiaWxpdGllc1wiIG11c3QgYmUgYSBKU09OIG9iamVjdC4nKTtcbiAgfVxuXG4gIC8vIExldCAncmVxdWlyZWRDYXBzJyBiZSBwcm9wZXJ0eSBuYW1lZCAnYWx3YXlzTWF0Y2gnIGZyb20gY2FwYWJpbGl0aWVzIHJlcXVlc3QgKCMyKSBhbmQgJ2FsbEZpcnN0TWF0Y2hDYXBzJyBiZSBwcm9wZXJ0eSBuYW1lZCAnZmlyc3RNYXRjaCBmcm9tIGNhcGFiaWxpdGllcyByZXF1ZXN0ICgjMylcbiAgbGV0IHtcbiAgICBhbHdheXNNYXRjaDogcmVxdWlyZWRDYXBzID0ge30sIC8vIElmICdyZXF1aXJlZENhcHMnIGlzIHVuZGVmaW5lZCwgc2V0IGl0IHRvIGFuIGVtcHR5IEpTT04gb2JqZWN0ICgjMi4xKVxuICAgIGZpcnN0TWF0Y2g6IGFsbEZpcnN0TWF0Y2hDYXBzID0gW3t9XSwgLy8gSWYgJ2ZpcnN0TWF0Y2gnIGlzIHVuZGVmaW5lZCBzZXQgaXQgdG8gYSBzaW5nbGV0b24gbGlzdCB3aXRoIG9uZSBlbXB0eSBvYmplY3QgKCMzLjEpXG4gIH0gPSBjYXBzO1xuXG4gIC8vIFJlamVjdCAnZmlyc3RNYXRjaCcgYXJndW1lbnQgaWYgaXQncyBub3QgYW4gYXJyYXkgKCMzLjIpXG4gIGlmICghXy5pc0FycmF5KGFsbEZpcnN0TWF0Y2hDYXBzKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEFyZ3VtZW50RXJyb3IoJ1RoZSBjYXBhYmlsaXRpZXMuZmlyc3RNYXRjaCBhcmd1bWVudCB3YXMgbm90IHZhbGlkIGZvciB0aGUgZm9sbG93aW5nIHJlYXNvbihzKTogXCJjYXBhYmlsaXRpZXMuZmlyc3RNYXRjaFwiIG11c3QgYmUgYSBKU09OIGFycmF5IG9yIHVuZGVmaW5lZCcpO1xuICB9XG5cbiAgLy8gSWYgYW4gZW1wdHkgYXJyYXkgYXMgcHJvdmlkZWQsIHdlJ2xsIGJlIGZvcmdpdmluZyBhbmQgbWFrZSBpdCBhbiBhcnJheSBvZiBvbmUgZW1wdHkgb2JqZWN0XG4gIGlmIChhbGxGaXJzdE1hdGNoQ2Fwcy5sZW5ndGggPT09IDApIHtcbiAgICBhbGxGaXJzdE1hdGNoQ2Fwcy5wdXNoKHt9KTtcbiAgfVxuXG4gIC8vIENoZWNrIGZvciBub24tcHJlZml4ZWQsIG5vbi1zdGFuZGFyZCBjYXBhYmlsaXRpZXMgYW5kIGxvZyB3YXJuaW5ncyBpZiB0aGV5IGFyZSBmb3VuZFxuICBsZXQgbm9uUHJlZml4ZWRDYXBzID0gZmluZE5vblByZWZpeGVkQ2FwcyhjYXBzKTtcbiAgaWYgKCFfLmlzRW1wdHkobm9uUHJlZml4ZWRDYXBzKSkge1xuICAgIGxvZy53YXJuKGBUaGUgY2FwYWJpbGl0aWVzICR7SlNPTi5zdHJpbmdpZnkobm9uUHJlZml4ZWRDYXBzKX0gYXJlIG5vdCBzdGFuZGFyZCBjYXBhYmlsaXRpZXMgYW5kIHNob3VsZCBoYXZlIGFuIGV4dGVuc2lvbiBwcmVmaXhgKTtcbiAgfVxuXG4gIC8vIFN0cmlwIG91dCB0aGUgJ2FwcGl1bTonIHByZWZpeCBmcm9tIGFsbFxuICBzdHJpcEFwcGl1bVByZWZpeGVzKHJlcXVpcmVkQ2Fwcyk7XG4gIGZvciAobGV0IGZpcnN0TWF0Y2hDYXBzIG9mIGFsbEZpcnN0TWF0Y2hDYXBzKSB7XG4gICAgc3RyaXBBcHBpdW1QcmVmaXhlcyhmaXJzdE1hdGNoQ2Fwcyk7XG4gIH1cblxuICAvLyBWYWxpZGF0ZSB0aGUgcmVxdWlyZWRDYXBzLiBCdXQgZG9uJ3QgdmFsaWRhdGUgJ3ByZXNlbmNlJyBiZWNhdXNlIGlmIHRoYXQgY29uc3RyYWludCBmYWlscyBvbiAnYWx3YXlzTWF0Y2gnIGl0IGNvdWxkIHN0aWxsIHBhc3Mgb24gb25lIG9mIHRoZSAnZmlyc3RNYXRjaCcga2V5c1xuICBpZiAoc2hvdWxkVmFsaWRhdGVDYXBzKSB7XG4gICAgcmVxdWlyZWRDYXBzID0gdmFsaWRhdGVDYXBzKHJlcXVpcmVkQ2FwcywgY29uc3RyYWludHMsIHtza2lwUHJlc2VuY2VDb25zdHJhaW50OiB0cnVlfSk7XG4gIH1cblxuXG4gIC8vIFJlbW92ZSB0aGUgJ3ByZXNlbmNlJyBjb25zdHJhaW50IGZvciBhbnkga2V5cyB0aGF0IGFyZSBhbHJlYWR5IHByZXNlbnQgaW4gJ3JlcXVpcmVkQ2FwcydcbiAgLy8gc2luY2Ugd2Uga25vdyB0aGF0IHRoaXMgY29uc3RyYWludCBoYXMgYWxyZWFkeSBwYXNzZWRcbiAgbGV0IGZpbHRlcmVkQ29uc3RyYWludHMgPSB7Li4uY29uc3RyYWludHN9O1xuICBsZXQgcmVxdWlyZWRDYXBzS2V5cyA9IF8ua2V5cyhyZXF1aXJlZENhcHMpO1xuICBmb3IgKGxldCBrZXkgb2YgXy5rZXlzKGZpbHRlcmVkQ29uc3RyYWludHMpKSB7XG4gICAgaWYgKHJlcXVpcmVkQ2Fwc0tleXMuaW5jbHVkZXMoa2V5KSkge1xuICAgICAgZGVsZXRlIGZpbHRlcmVkQ29uc3RyYWludHNba2V5XTtcbiAgICB9XG4gIH1cblxuICAvLyBWYWxpZGF0ZSBhbGwgb2YgdGhlIGZpcnN0IG1hdGNoIGNhcGFiaWxpdGllcyBhbmQgcmV0dXJuIGFuIGFycmF5IHdpdGggb25seSB0aGUgdmFsaWQgY2FwcyAoc2VlIHNwZWMgIzUpXG4gIGxldCB2YWxpZGF0aW9uRXJyb3JzID0gW107XG4gIGxldCB2YWxpZGF0ZWRGaXJzdE1hdGNoQ2FwcyA9IGFsbEZpcnN0TWF0Y2hDYXBzLm1hcCgoZmlyc3RNYXRjaENhcHMpID0+IHtcbiAgICB0cnkge1xuICAgICAgLy8gVmFsaWRhdGUgZmlyc3RNYXRjaCBjYXBzXG4gICAgICByZXR1cm4gc2hvdWxkVmFsaWRhdGVDYXBzID8gdmFsaWRhdGVDYXBzKGZpcnN0TWF0Y2hDYXBzLCBmaWx0ZXJlZENvbnN0cmFpbnRzKSA6IGZpcnN0TWF0Y2hDYXBzO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHZhbGlkYXRpb25FcnJvcnMucHVzaChlLm1lc3NhZ2UpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9KS5maWx0ZXIoKGNhcHMpID0+ICFfLmlzTnVsbChjYXBzKSk7XG5cbiAgLy8gVHJ5IHRvIG1lcmdlIHJlcXVpcmVkQ2FwcyB3aXRoIGZpcnN0IG1hdGNoIGNhcGFiaWxpdGllcywgYnJlYWsgb25jZSBpdCBmaW5kcyBpdHMgZmlyc3QgbWF0Y2ggKHNlZSBzcGVjICM2KVxuICBsZXQgbWF0Y2hlZENhcHMgPSBudWxsO1xuICBmb3IgKGxldCBmaXJzdE1hdGNoQ2FwcyBvZiB2YWxpZGF0ZWRGaXJzdE1hdGNoQ2Fwcykge1xuICAgIHRyeSB7XG4gICAgICBtYXRjaGVkQ2FwcyA9IG1lcmdlQ2FwcyhyZXF1aXJlZENhcHMsIGZpcnN0TWF0Y2hDYXBzKTtcbiAgICAgIGlmIChtYXRjaGVkQ2Fwcykge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGVyci5tZXNzYWdlKTtcbiAgICB9XG4gIH1cblxuICAvLyBSZXR1cm5zIHZhcmlhYmxlcyBmb3IgdGVzdGluZyBwdXJwb3Nlc1xuICByZXR1cm4ge3JlcXVpcmVkQ2FwcywgYWxsRmlyc3RNYXRjaENhcHMsIHZhbGlkYXRlZEZpcnN0TWF0Y2hDYXBzLCBtYXRjaGVkQ2FwcywgdmFsaWRhdGlvbkVycm9yc307XG59XG5cbi8vIENhbGxzIHBhcnNlQ2FwcyBhbmQganVzdCByZXR1cm5zIHRoZSBtYXRjaGVkQ2FwcyB2YXJpYWJsZVxuZnVuY3Rpb24gcHJvY2Vzc0NhcGFiaWxpdGllcyAoY2FwcywgY29uc3RyYWludHMgPSB7fSwgc2hvdWxkVmFsaWRhdGVDYXBzID0gdHJ1ZSkge1xuICBjb25zdCB7bWF0Y2hlZENhcHMsIHZhbGlkYXRpb25FcnJvcnN9ID0gcGFyc2VDYXBzKGNhcHMsIGNvbnN0cmFpbnRzLCBzaG91bGRWYWxpZGF0ZUNhcHMpO1xuXG4gIC8vIElmIHdlIGZvdW5kIGFuIGVycm9yIHRocm93IGFuIGV4Y2VwdGlvblxuICBpZiAoIXV0aWwuaGFzVmFsdWUobWF0Y2hlZENhcHMpKSB7XG4gICAgaWYgKF8uaXNBcnJheShjYXBzLmZpcnN0TWF0Y2gpICYmIGNhcHMuZmlyc3RNYXRjaC5sZW5ndGggPiAxKSB7XG4gICAgICAvLyBJZiB0aGVyZSB3YXMgbW9yZSB0aGFuIG9uZSAnZmlyc3RNYXRjaCcgY2FwLCBpbmRpY2F0ZSB0aGF0IHdlIGNvdWxkbid0IGZpbmQgYSBtYXRjaGluZyBjYXBhYmlsaXRpZXMgc2V0IGFuZCBzaG93IGFsbCB0aGUgZXJyb3JzXG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWRBcmd1bWVudEVycm9yKGBDb3VsZCBub3QgZmluZCBtYXRjaGluZyBjYXBhYmlsaXRpZXMgZnJvbSAke0pTT04uc3RyaW5naWZ5KGNhcHMpfTpcXG4gJHt2YWxpZGF0aW9uRXJyb3JzLmpvaW4oJ1xcbicpfWApO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBPdGhlcndpc2UsIGp1c3Qgc2hvdyB0aGUgc2luZ3VsYXIgZXJyb3IgbWVzc2FnZVxuICAgICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkQXJndW1lbnRFcnJvcih2YWxpZGF0aW9uRXJyb3JzWzBdKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gbWF0Y2hlZENhcHM7XG59XG5cblxuZXhwb3J0IHsgcGFyc2VDYXBzLCBwcm9jZXNzQ2FwYWJpbGl0aWVzLCB2YWxpZGF0ZUNhcHMsIG1lcmdlQ2FwcywgZmluZE5vblByZWZpeGVkQ2FwcyB9O1xuIl0sImZpbGUiOiJsaWIvYmFzZWRyaXZlci9jYXBhYmlsaXRpZXMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
