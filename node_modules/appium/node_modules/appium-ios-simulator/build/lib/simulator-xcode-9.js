"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _simulatorXcode = _interopRequireDefault(require("./simulator-xcode-8"));

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _asyncLock = _interopRequireDefault(require("async-lock"));

var _logger = _interopRequireDefault(require("./logger"));

var _nodeSimctl = require("node-simctl");

var _asyncbox = require("asyncbox");

var _utils = require("./utils.js");

var fbsimctl = _interopRequireWildcard(require("./fbsimctl-utils"));

const SIMULATOR_SHUTDOWN_TIMEOUT = 15 * 1000;
const startupLock = new _asyncLock.default();
const preferencesPlistGuard = new _asyncLock.default();
const ENROLLMENT_NOTIFICATION_RECEIVER = 'com.apple.BiometricKit.enrollmentChanged';

class SimulatorXcode9 extends _simulatorXcode.default {
  constructor(udid, xcodeVersion) {
    super(udid, xcodeVersion);
  }

  async run(opts = {}) {
    opts = Object.assign({
      devicePreferences: {},
      isHeadless: false,
      startupTimeout: this.startupTimeout
    }, opts);

    if (opts.scaleFactor) {
      opts.devicePreferences.SimulatorWindowLastScale = parseFloat(opts.scaleFactor);
    }

    const commonPreferences = {
      RotateWindowWhenSignaledByGuest: true
    };

    if (_lodash.default.isBoolean(opts.connectHardwareKeyboard)) {
      opts.devicePreferences.ConnectHardwareKeyboard = opts.connectHardwareKeyboard;
      commonPreferences.ConnectHardwareKeyboard = opts.connectHardwareKeyboard;
    }

    if (!_lodash.default.isEmpty(opts.devicePreferences) || !_lodash.default.isEmpty(commonPreferences)) {
      await this.updatePreferences(opts.devicePreferences, commonPreferences);
    }

    const bootSimulator = async () => {
      try {
        await (0, _asyncbox.retryInterval)(3, 2000, async () => await (0, _nodeSimctl.bootDevice)(this.udid));
      } catch (err) {
        _logger.default.warn(`'xcrun simctl boot ${this.udid}' command has returned non-zero code. The problem was: ${err.stderr}`);
      }
    };

    const waitForShutdown = async () => {
      try {
        await (0, _asyncbox.waitForCondition)(async () => {
          const {
            state
          } = await this.stat();
          return state === 'Shutdown';
        }, {
          waitMs: SIMULATOR_SHUTDOWN_TIMEOUT,
          intervalMs: 500
        });
      } catch (err) {
        throw new Error(`Simulator is not in 'Shutdown' state after ${SIMULATOR_SHUTDOWN_TIMEOUT}ms`);
      }
    };

    let shouldWaitForBoot = true;
    const startTime = process.hrtime();
    await startupLock.acquire(this.uiClientBundleId, async () => {
      const stat = await this.stat();
      const serverState = stat.state;
      const isServerRunning = serverState === 'Booted';
      const isUIClientRunning = await this.isUIClientRunning();

      if (opts.isHeadless) {
        if (isServerRunning && !isUIClientRunning) {
          _logger.default.info(`Simulator with UDID ${this.udid} already booted in headless mode.`);

          shouldWaitForBoot = false;
          return;
        }

        if (await this.killUIClient()) {
          _logger.default.info(`Detected the UI client was running and killed it. Verifying the Simulator is in Shutdown state...`);

          await waitForShutdown();
        }

        _logger.default.info(`Booting Simulator with UDID ${this.udid} in headless mode. All UI-related capabilities are going to be ignored.`);

        await bootSimulator();
      } else {
        if (isServerRunning && isUIClientRunning) {
          _logger.default.info(`Both Simulator with UDID ${this.udid} and the UI client are currently running`);

          shouldWaitForBoot = false;
          return;
        }

        if (['Shutdown', 'Booted'].indexOf(serverState) === -1) {
          if (serverState !== 'Shutting Down') {
            _logger.default.info(`Simulator ${this.udid} is in '${serverState}' state. Trying to shutdown...`);

            try {
              await this.shutdown();
            } catch (err) {
              _logger.default.warn(`Error on Simulator shutdown: ${err.message}`);
            }
          }

          await waitForShutdown();
        }

        _logger.default.info(`Booting Simulator with UDID ${this.udid}...`);

        await bootSimulator();

        if (!isUIClientRunning) {
          await this.startUIClient(opts);
        }
      }
    });

    if (shouldWaitForBoot) {
      await this.waitForBoot(opts.startupTimeout);

      _logger.default.info(`Simulator with UDID ${this.udid} booted in ${process.hrtime(startTime)[0]} seconds`);
    }
  }

  verifyDevicePreferences(prefs = {}) {
    if (_lodash.default.isEmpty(prefs)) {
      return;
    }

    if (!_lodash.default.isUndefined(prefs.SimulatorWindowLastScale)) {
      if (!_lodash.default.isNumber(prefs.SimulatorWindowLastScale) || prefs.SimulatorWindowLastScale <= 0) {
        _logger.default.errorAndThrow(`SimulatorWindowLastScale is expected to be a positive float value. ` + `'${prefs.SimulatorWindowLastScale}' is assigned instead.`);
      }
    }

    if (!_lodash.default.isUndefined(prefs.SimulatorWindowCenter)) {
      const verificationPattern = /{-?\d+(\.\d+)?,-?\d+(\.\d+)?}/;

      if (!_lodash.default.isString(prefs.SimulatorWindowCenter) || !verificationPattern.test(prefs.SimulatorWindowCenter)) {
        _logger.default.errorAndThrow(`SimulatorWindowCenter is expected to match "{floatXPosition,floatYPosition}" format (without spaces). ` + `'${prefs.SimulatorWindowCenter}' is assigned instead.`);
      }
    }

    if (!_lodash.default.isUndefined(prefs.SimulatorWindowOrientation)) {
      const acceptableValues = ['Portrait', 'LandscapeLeft', 'PortraitUpsideDown', 'LandscapeRight'];

      if (acceptableValues.indexOf(prefs.SimulatorWindowOrientation) === -1) {
        _logger.default.errorAndThrow(`SimulatorWindowOrientation is expected to be one of ${acceptableValues}. ` + `'${prefs.SimulatorWindowOrientation}' is assigned instead.`);
      }
    }

    if (!_lodash.default.isUndefined(prefs.SimulatorWindowRotationAngle)) {
      if (!_lodash.default.isNumber(prefs.SimulatorWindowRotationAngle)) {
        _logger.default.errorAndThrow(`SimulatorWindowRotationAngle is expected to be a valid number. ` + `'${prefs.SimulatorWindowRotationAngle}' is assigned instead.`);
      }
    }
  }

  async updatePreferences(devicePrefs = {}, commonPrefs = {}) {
    if (!_lodash.default.isEmpty(devicePrefs)) {
      _logger.default.debug(`Setting preferences of ${this.udid} Simulator to ${JSON.stringify(devicePrefs)}`);
    }

    if (!_lodash.default.isEmpty(commonPrefs)) {
      _logger.default.debug(`Setting common Simulator preferences to ${JSON.stringify(commonPrefs)}`);
    }

    const homeFolderPath = process.env.HOME;

    if (!homeFolderPath) {
      _logger.default.warn(`Cannot get the path to HOME folder from the process environment. ` + `Ignoring Simulator preferences update.`);

      return false;
    }

    this.verifyDevicePreferences(devicePrefs);

    const plistPath = _path.default.resolve(homeFolderPath, 'Library', 'Preferences', 'com.apple.iphonesimulator.plist');

    if (!(await _appiumSupport.fs.hasAccess(plistPath))) {
      _logger.default.warn(`Simulator preferences file '${plistPath}' is not accessible. ` + `Ignoring Simulator preferences update.`);

      return false;
    }

    let newPrefs = {};

    if (!_lodash.default.isEmpty(devicePrefs)) {
      newPrefs.DevicePreferences = {
        [this.udid.toUpperCase()]: devicePrefs
      };
    }

    newPrefs = _lodash.default.merge(newPrefs, commonPrefs);
    return await preferencesPlistGuard.acquire(SimulatorXcode9.name, async () => {
      try {
        const currentPlistContent = await _appiumSupport.plist.parsePlistFile(plistPath);
        await _appiumSupport.plist.updatePlistFile(plistPath, _lodash.default.merge(currentPlistContent, newPrefs), true);

        _logger.default.debug(`Updated ${this.udid} Simulator preferences at '${plistPath}' with ${JSON.stringify(newPrefs)}`);

        return true;
      } catch (e) {
        _logger.default.warn(`Cannot update ${this.udid} Simulator preferences at '${plistPath}'. ` + `Try to delete the file manually in order to reset it. Original error: ${e.message}`);

        return false;
      }
    });
  }

  async shutdown() {
    const {
      state
    } = await this.stat();

    if (state === 'Shutdown') {
      return;
    }

    await (0, _asyncbox.retryInterval)(5, 500, _nodeSimctl.shutdown, this.udid);
  }

  async clean() {
    _logger.default.info(`Cleaning simulator ${this.udid}`);

    await (0, _nodeSimctl.eraseDevice)(this.udid, 10000);
  }

  async _activateWindow() {
    try {
      await fbsimctl.focus(this.udid);
    } catch (err) {
      _logger.default.warn(`Cannot focus Simulator window with fbsimctl. Defaulting to AppleScript. ` + `Original error: ${err.message}`);

      const {
        name,
        sdk
      } = await this.stat();
      return `
        tell application "System Events"
          tell process "Simulator"
            set frontmost to false
            set frontmost to true
            click (menu item 1 where (its name contains "${name} -" and its name contains "${sdk}")) of menu 1 of menu bar item "Window" of menu bar 1
          end tell
        end tell
      `;
    }
  }

  async isBiometricEnrolled() {
    const {
      stdout
    } = await (0, _nodeSimctl.spawn)(this.udid, ['notifyutil', '-g', ENROLLMENT_NOTIFICATION_RECEIVER]);
    const match = new RegExp(`${_lodash.default.escapeRegExp(ENROLLMENT_NOTIFICATION_RECEIVER)}\\s+([01])`).exec(stdout);

    if (!match) {
      throw new Error(`Cannot parse biometric enrollment state from '${stdout}'`);
    }

    _logger.default.info(`Current biometric enrolled state for ${this.udid} Simulator: ${match[1]}`);

    return match[1] === '1';
  }

  async enrollBiometric(isEnabled = true) {
    _logger.default.debug(`Setting biometric enrolled state for ${this.udid} Simulator to '${isEnabled ? 'enabled' : 'disabled'}'`);

    await (0, _nodeSimctl.spawn)(this.udid, ['notifyutil', '-s', ENROLLMENT_NOTIFICATION_RECEIVER, isEnabled ? '1' : '0']);
    await (0, _nodeSimctl.spawn)(this.udid, ['notifyutil', '-p', ENROLLMENT_NOTIFICATION_RECEIVER]);

    if ((await this.isBiometricEnrolled()) !== isEnabled) {
      throw new Error(`Cannot set biometric enrolled state for ${this.udid} Simulator to '${isEnabled ? 'enabled' : 'disabled'}'`);
    }
  }

  async sendBiometricMatch(shouldMatch = true, biometricName = 'touchId') {
    const domainComponent = (0, _utils.toBiometricDomainComponent)(biometricName);
    const domain = `com.apple.BiometricKit_Sim.${domainComponent}.${shouldMatch ? '' : 'no'}match`;
    await (0, _nodeSimctl.spawn)(this.udid, ['notifyutil', '-p', domain]);

    _logger.default.info(`Sent notification ${domain} to ${shouldMatch ? 'match' : 'not match'} ${biometricName} biometric ` + `for ${this.udid} Simulator`);
  }

  async getLaunchDaemonsRoot() {
    const devRoot = await (0, _utils.getDeveloperRoot)();
    return _path.default.resolve(devRoot, 'Platforms/iPhoneOS.platform/Developer/Library/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/System/Library/LaunchDaemons');
  }

}

var _default = SimulatorXcode9;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3IteGNvZGUtOS5qcyJdLCJuYW1lcyI6WyJTSU1VTEFUT1JfU0hVVERPV05fVElNRU9VVCIsInN0YXJ0dXBMb2NrIiwiQXN5bmNMb2NrIiwicHJlZmVyZW5jZXNQbGlzdEd1YXJkIiwiRU5ST0xMTUVOVF9OT1RJRklDQVRJT05fUkVDRUlWRVIiLCJTaW11bGF0b3JYY29kZTkiLCJTaW11bGF0b3JYY29kZTgiLCJjb25zdHJ1Y3RvciIsInVkaWQiLCJ4Y29kZVZlcnNpb24iLCJydW4iLCJvcHRzIiwiT2JqZWN0IiwiYXNzaWduIiwiZGV2aWNlUHJlZmVyZW5jZXMiLCJpc0hlYWRsZXNzIiwic3RhcnR1cFRpbWVvdXQiLCJzY2FsZUZhY3RvciIsIlNpbXVsYXRvcldpbmRvd0xhc3RTY2FsZSIsInBhcnNlRmxvYXQiLCJjb21tb25QcmVmZXJlbmNlcyIsIlJvdGF0ZVdpbmRvd1doZW5TaWduYWxlZEJ5R3Vlc3QiLCJfIiwiaXNCb29sZWFuIiwiY29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQiLCJDb25uZWN0SGFyZHdhcmVLZXlib2FyZCIsImlzRW1wdHkiLCJ1cGRhdGVQcmVmZXJlbmNlcyIsImJvb3RTaW11bGF0b3IiLCJlcnIiLCJsb2ciLCJ3YXJuIiwic3RkZXJyIiwid2FpdEZvclNodXRkb3duIiwic3RhdGUiLCJzdGF0Iiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsIkVycm9yIiwic2hvdWxkV2FpdEZvckJvb3QiLCJzdGFydFRpbWUiLCJwcm9jZXNzIiwiaHJ0aW1lIiwiYWNxdWlyZSIsInVpQ2xpZW50QnVuZGxlSWQiLCJzZXJ2ZXJTdGF0ZSIsImlzU2VydmVyUnVubmluZyIsImlzVUlDbGllbnRSdW5uaW5nIiwiaW5mbyIsImtpbGxVSUNsaWVudCIsImluZGV4T2YiLCJzaHV0ZG93biIsIm1lc3NhZ2UiLCJzdGFydFVJQ2xpZW50Iiwid2FpdEZvckJvb3QiLCJ2ZXJpZnlEZXZpY2VQcmVmZXJlbmNlcyIsInByZWZzIiwiaXNVbmRlZmluZWQiLCJpc051bWJlciIsImVycm9yQW5kVGhyb3ciLCJTaW11bGF0b3JXaW5kb3dDZW50ZXIiLCJ2ZXJpZmljYXRpb25QYXR0ZXJuIiwiaXNTdHJpbmciLCJ0ZXN0IiwiU2ltdWxhdG9yV2luZG93T3JpZW50YXRpb24iLCJhY2NlcHRhYmxlVmFsdWVzIiwiU2ltdWxhdG9yV2luZG93Um90YXRpb25BbmdsZSIsImRldmljZVByZWZzIiwiY29tbW9uUHJlZnMiLCJkZWJ1ZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJob21lRm9sZGVyUGF0aCIsImVudiIsIkhPTUUiLCJwbGlzdFBhdGgiLCJwYXRoIiwicmVzb2x2ZSIsImZzIiwiaGFzQWNjZXNzIiwibmV3UHJlZnMiLCJEZXZpY2VQcmVmZXJlbmNlcyIsInRvVXBwZXJDYXNlIiwibWVyZ2UiLCJuYW1lIiwiY3VycmVudFBsaXN0Q29udGVudCIsInBsaXN0IiwicGFyc2VQbGlzdEZpbGUiLCJ1cGRhdGVQbGlzdEZpbGUiLCJlIiwic2ltY3RsU2h1dGRvd24iLCJjbGVhbiIsIl9hY3RpdmF0ZVdpbmRvdyIsImZic2ltY3RsIiwiZm9jdXMiLCJzZGsiLCJpc0Jpb21ldHJpY0Vucm9sbGVkIiwic3Rkb3V0IiwibWF0Y2giLCJSZWdFeHAiLCJlc2NhcGVSZWdFeHAiLCJleGVjIiwiZW5yb2xsQmlvbWV0cmljIiwiaXNFbmFibGVkIiwic2VuZEJpb21ldHJpY01hdGNoIiwic2hvdWxkTWF0Y2giLCJiaW9tZXRyaWNOYW1lIiwiZG9tYWluQ29tcG9uZW50IiwiZG9tYWluIiwiZ2V0TGF1bmNoRGFlbW9uc1Jvb3QiLCJkZXZSb290Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsMEJBQTBCLEdBQUcsS0FBSyxJQUF4QztBQUNBLE1BQU1DLFdBQVcsR0FBRyxJQUFJQyxrQkFBSixFQUFwQjtBQUNBLE1BQU1DLHFCQUFxQixHQUFHLElBQUlE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SWpFLEtBQUosQ0FBVywyQ0FBMEMsS0FBSzlCLElBQUssa0JBQWlCK0YsU0FBUyxHQUFHLFNBQUgsR0FBZSxVQUFXLEdBQW5ILENBQU47QUFDRDtBQUNGOztBQVVELFFBQU1DLGtCQUFOLENBQTBCQyxXQUFXLEdBQUcsSUFBeEMsRUFBOENDLGFBQWEsR0FBRyxTQUE5RCxFQUF5RTtBQUN2RSxVQUFNQyxlQUFlLEdBQUcsdUNBQTJCRCxhQUEzQixDQUF4QjtBQUNBLFVBQU1FLE1BQU0sR0FBSSw4QkFBNkJELGVBQWdCLElBQUdGLFdBQVcsR0FBRyxFQUFILEdBQVEsSUFBSyxPQUF4RjtBQUNBLFVBQU0sdUJBQU0sS0FBS2pHLElBQVgsRUFBaUIsQ0FDckIsWUFEcUIsRUFFckIsSUFGcUIsRUFFZm9HLE1BRmUsQ0FBakIsQ0FBTjs7QUFJQTlFLG9CQUFJa0IsSUFBSixDQUFVLHFCQUFvQjRELE1BQU8sT0FBTUgsV0FBVyxHQUFHLE9BQUgsR0FBYSxXQUFZLElBQUdDLGFBQWMsYUFBdkYsR0FDTixPQUFNLEtBQUtsRyxJQUFLLFlBRG5CO0FBRUQ7O0FBS0QsUUFBTXFHLG9CQUFOLEdBQThCO0FBQzVCLFVBQU1DLE9BQU8sR0FBRyxNQUFNLDhCQUF0QjtBQUNBLFdBQU9sQyxjQUFLQyxPQUFMLENBQWFpQyxPQUFiLEVBQ0wsMEpBREssQ0FBUDtBQUVEOztBQWhWMkM7O2VBb1YvQnpHLGUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU2ltdWxhdG9yWGNvZGU4IGZyb20gJy4vc2ltdWxhdG9yLXhjb2RlLTgnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZnMsIHBsaXN0IH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IEFzeW5jTG9jayBmcm9tICdhc3luYy1sb2NrJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgc2h1dGRvd24gYXMgc2ltY3RsU2h1dGRvd24sIGJvb3REZXZpY2UsIGVyYXNlRGV2aWNlLCBzcGF3biB9IGZyb20gJ25vZGUtc2ltY3RsJztcbmltcG9ydCB7IHdhaXRGb3JDb25kaXRpb24sIHJldHJ5SW50ZXJ2YWwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyB0b0Jpb21ldHJpY0RvbWFpbkNvbXBvbmVudCwgZ2V0RGV2ZWxvcGVyUm9vdCB9IGZyb20gJy4vdXRpbHMuanMnO1xuaW1wb3J0ICogYXMgZmJzaW1jdGwgZnJvbSAnLi9mYnNpbWN0bC11dGlscyc7XG5cbmNvbnN0IFNJTVVMQVRPUl9TSFVURE9XTl9USU1FT1VUID0gMTUgKiAxMDAwO1xuY29uc3Qgc3RhcnR1cExvY2sgPSBuZXcgQXN5bmNMb2NrKCk7XG5jb25zdCBwcmVmZXJlbmNlc1BsaXN0R3VhcmQgPSBuZXcgQXN5bmNMb2NrKCk7XG5jb25zdCBFTlJPTExNRU5UX05PVElGSUNBVElPTl9SRUNFSVZFUiA9ICdjb20uYXBwbGUuQmlvbWV0cmljS2l0LmVucm9sbG1lbnRDaGFuZ2VkJztcblxuY2xhc3MgU2ltdWxhdG9yWGNvZGU5IGV4dGVuZHMgU2ltdWxhdG9yWGNvZGU4IHtcbiAgY29uc3RydWN0b3IgKHVkaWQsIHhjb2RlVmVyc2lvbikge1xuICAgIHN1cGVyKHVkaWQsIHhjb2RlVmVyc2lvbik7XG4gIH1cblxuICAvKipcbiAgICogQHR5cGVkZWYge09iamVjdH0gRGV2aWNlUHJlZmVyZW5jZXNcbiAgICogQHByb3BlcnR5IHs/bnVtYmVyfSBTaW11bGF0b3JFeHRlcm5hbERpc3BsYXkgLSBUQkQuIEV4YW1wbGUgdmFsdWU6IDIuMTE0XG4gICAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gQ2hyb21lVGludCAtIFRCRC4gRXhhbXBsZSB2YWx1ZTogJydcbiAgICogQHByb3BlcnR5IHs/bnVtYmVyfSBTaW11bGF0b3JXaW5kb3dMYXN0U2NhbGUgLSBTY2FsZSB2YWx1ZSBmb3IgdGhlIHBhcnRpY3VsYXIgU2ltdWxhdG9yIHdpbmRvdy5cbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxLjAgbWVhbnMgMTAwJSBzY2FsZS5cbiAgICogQHByb3BlcnR5IHs/c3RyaW5nfSBTaW11bGF0b3JXaW5kb3dPcmllbnRhdGlvbiAtIFNpbXVsYXRvciB3aW5kb3cgb3JpZW50YXRpb24uIFBvc3NpYmxlIHZhbHVlcyBhcmU6XG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnUG9ydHJhaXQnLCAnTGFuZHNjYXBlTGVmdCcsICdQb3J0cmFpdFVwc2lkZURvd24nIGFuZCAnTGFuZHNjYXBlUmlnaHQnLlxuICAgKiBAcHJvcGVydHkgez9udW1iZXJ9IFNpbXVsYXRvcldpbmRvd1JvdGF0aW9uQW5nbGUgLSBXaW5kb3cgcm90YXRpb24gYW5nbGUuIFRoaXMgdmFsdWUgaXMgZXhwZWN0ZWQgdG8gYmUgaW4gc3luY1xuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRoIF9TaW11bGF0b3JXaW5kb3dPcmllbnRhdGlvbl8uIFRoZSBjb3JyZXNwb25kaW5nIHZhbHVlcyBhcmU6XG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAsIDkwLCAxODAgYW5kIDI3MC5cbiAgICogQHByb3BlcnR5IHs/c3RyaW5nfSBTaW11bGF0b3JXaW5kb3dDZW50ZXIgLSBUaGUgY29vcmRpbmF0ZXMgb2YgU2ltdWxhdG9yJ3Mgd2luZG93IGNlbnRlciBpbiBwaXhlbHMsXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGV4YW1wbGUgJ3stMTI5NC41LCA3NzUuNX0nLlxuICAgKiBAcHJvcGVydHkgez9ib29sZWFufSBDb25uZWN0SGFyZHdhcmVLZXlib2FyZCAtIEVxdWFscyB0byAxIGlmIGhhcmR3YXJlIGtleWJvYXJkIHNob3VsZCBiZSBjb25uZWN0ZWQuXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgT3RoZXJ3aXNlIDAuXG4gICAqL1xuXG4gIC8qKlxuICAgKiBAdHlwZWRlZiB7T2JqZWN0fSBDb21tb25QcmVmZXJlbmNlc1xuICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IENvbm5lY3RIYXJkd2FyZUtleWJvYXJkIC0gV2hldGhlciB0byBjb25uZWN0IGhhcmR3YXJlIGtleWJvYXJkXG4gICAqL1xuXG4gIC8qKlxuICAgKiBFeGVjdXRlcyBnaXZlbiBTaW11bGF0b3Igd2l0aCBvcHRpb25zLiBUaGUgU2ltdWxhdG9yIHdpbGwgbm90IGJlIHJlc3RhcnRlZCBpZlxuICAgKiBpdCBpcyBhbHJlYWR5IHJ1bm5pbmcgYW5kIHRoZSBjdXJyZW50IFVJIHN0YXRlIG1hdGNoZXMgdG8gYGlzSGVhZGxlc3NgIG9wdGlvbi5cbiAgICogQG92ZXJyaWRlXG4gICAqXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRzIC0gT25lIG9yIG1vcmUgb2YgYXZhaWxhYmxlIFNpbXVsYXRvciBvcHRpb25zOlxuICAgKiAgIC0ge3N0cmluZ30gc2NhbGVGYWN0b3I6IEFueSBwb3NpdGl2ZSBmbG9hdCB2YWx1ZS4gMS4wIG1lYW5zIDE6MSBzY2FsZS5cbiAgICogICBEZWZpbmVzIHRoZSB3aW5kb3cgc2NhbGUgdmFsdWUgZm9yIHRoZSBVSSBjbGllbnQgd2luZG93IGZvciB0aGUgY3VycmVudCBTaW11bGF0b3IuXG4gICAqICAgRXF1YWxzIHRvIGBudWxsYCBieSBkZWZhdWx0LCB3aGljaCBrZWVwcyB0aGUgY3VycmVudCBzY2FsZSB1bmNoYW5nZWQuXG4gICAqICAgLSB7Ym9vbGVhbn0gY29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQ6IHdoZXRoZXIgdG8gY29ubmVjdCB0aGUgaGFyZHdhcmUga2V5Ym9hcmQgdG8gdGhlXG4gICAqICAgU2ltdWxhdG9yIFVJIGNsaWVudC4gRXF1YWxzIHRvIGBmYWxzZWAgYnkgZGVmYXVsdC5cbiAgICogICAtIHtudW1iZXJ9IHN0YXJ0dXBUaW1lb3V0OiBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQgdW50aWwgU2ltdWxhdG9yIGJvb3RpbmdcbiAgICogICBwcm9jZXNzIGlzIGNvbXBsZXRlZC4gVGhlIGRlZmF1bHQgdGltZW91dCB3aWxsIGJlIHVzZWQgaWYgbm90IHNldCBleHBsaWNpdGx5LlxuICAgKiAgIC0ge2Jvb2xlYW59IGlzSGVhZGxlc3M6IHdoZXRoZXIgdG8gc3RhcnQgdGhlIFNpbXVsYXRvciBpbiBoZWFkbGVzcyBtb2RlICh3aXRoIFVJXG4gICAqICAgY2xpZW50IGludmlzaWJsZSkuIGBmYWxzZWAgYnkgZGVmYXVsdC5cbiAgICogICAtIHtEZXZpY2VQcmVmZXJlbmNlc30gZGV2aWNlUHJlZmVyZW5jZXM6IHByZWZlcmVuY2VzIG9mIHRoZSBuZXdseSBjcmVhdGVkIFNpbXVsYXRvclxuICAgKiAgIGRldmljZVxuICAgKi9cbiAgYXN5bmMgcnVuIChvcHRzID0ge30pIHtcbiAgICBvcHRzID0gT2JqZWN0LmFzc2lnbih7XG4gICAgICBkZXZpY2VQcmVmZXJlbmNlczoge30sXG4gICAgICBpc0hlYWRsZXNzOiBmYWxzZSxcbiAgICAgIHN0YXJ0dXBUaW1lb3V0OiB0aGlzLnN0YXJ0dXBUaW1lb3V0LFxuICAgIH0sIG9wdHMpO1xuICAgIGlmIChvcHRzLnNjYWxlRmFjdG9yKSB7XG4gICAgICBvcHRzLmRldmljZVByZWZlcmVuY2VzLlNpbXVsYXRvcldpbmRvd0xhc3RTY2FsZSA9IHBhcnNlRmxvYXQob3B0cy5zY2FsZUZhY3Rvcik7XG4gICAgfVxuICAgIC8vIFRoaXMgb3B0aW9uIGlzIG5lY2Vzc2FyeSB0byBtYWtlIHRoZSBTaW11bGF0b3Igd2luZG93IGZvbGxvd1xuICAgIC8vIHRoZSBhY3R1YWwgWENVSURldmljZSBvcmllbnRhdGlvblxuICAgIGNvbnN0IGNvbW1vblByZWZlcmVuY2VzID0ge1xuICAgICAgUm90YXRlV2luZG93V2hlblNpZ25hbGVkQnlHdWVzdDogdHJ1ZVxuICAgIH07XG4gICAgaWYgKF8uaXNCb29sZWFuKG9wdHMuY29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQpKSB7XG4gICAgICBvcHRzLmRldmljZVByZWZlcmVuY2VzLkNvbm5lY3RIYXJkd2FyZUtleWJvYXJkID0gb3B0cy5jb25uZWN0SGFyZHdhcmVLZXlib2FyZDtcbiAgICAgIGNvbW1vblByZWZlcmVuY2VzLkNvbm5lY3RIYXJkd2FyZUtleWJvYXJkID0gb3B0cy5jb25uZWN0SGFyZHdhcmVLZXlib2FyZDtcbiAgICB9XG4gICAgaWYgKCFfLmlzRW1wdHkob3B0cy5kZXZpY2VQcmVmZXJlbmNlcykgfHwgIV8uaXNFbXB0eShjb21tb25QcmVmZXJlbmNlcykpIHtcbiAgICAgIGF3YWl0IHRoaXMudXBkYXRlUHJlZmVyZW5jZXMob3B0cy5kZXZpY2VQcmVmZXJlbmNlcywgY29tbW9uUHJlZmVyZW5jZXMpO1xuICAgIH1cbiAgICBjb25zdCBib290U2ltdWxhdG9yID0gYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgcmV0cnlJbnRlcnZhbCgzLCAyMDAwLCBhc3luYyAoKSA9PiBhd2FpdCBib290RGV2aWNlKHRoaXMudWRpZCkpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGxvZy53YXJuKGAneGNydW4gc2ltY3RsIGJvb3QgJHt0aGlzLnVkaWR9JyBjb21tYW5kIGhhcyByZXR1cm5lZCBub24temVybyBjb2RlLiBUaGUgcHJvYmxlbSB3YXM6ICR7ZXJyLnN0ZGVycn1gKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIGNvbnN0IHdhaXRGb3JTaHV0ZG93biA9IGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oYXN5bmMgKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHtzdGF0ZX0gPSBhd2FpdCB0aGlzLnN0YXQoKTtcbiAgICAgICAgICByZXR1cm4gc3RhdGUgPT09ICdTaHV0ZG93bic7XG4gICAgICAgIH0sIHt3YWl0TXM6IFNJTVVMQVRPUl9TSFVURE9XTl9USU1FT1VULCBpbnRlcnZhbE1zOiA1MDB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFNpbXVsYXRvciBpcyBub3QgaW4gJ1NodXRkb3duJyBzdGF0ZSBhZnRlciAke1NJTVVMQVRPUl9TSFVURE9XTl9USU1FT1VUfW1zYCk7XG4gICAgICB9XG4gICAgfTtcbiAgICBsZXQgc2hvdWxkV2FpdEZvckJvb3QgPSB0cnVlO1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IHByb2Nlc3MuaHJ0aW1lKCk7XG4gICAgYXdhaXQgc3RhcnR1cExvY2suYWNxdWlyZSh0aGlzLnVpQ2xpZW50QnVuZGxlSWQsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHN0YXQgPSBhd2FpdCB0aGlzLnN0YXQoKTtcbiAgICAgIGNvbnN0IHNlcnZlclN0YXRlID0gc3RhdC5zdGF0ZTtcbiAgICAgIGNvbnN0IGlzU2VydmVyUnVubmluZyA9IHNlcnZlclN0YXRlID09PSAnQm9vdGVkJztcbiAgICAgIGNvbnN0IGlzVUlDbGllbnRSdW5uaW5nID0gYXdhaXQgdGhpcy5pc1VJQ2xpZW50UnVubmluZygpO1xuICAgICAgaWYgKG9wdHMuaXNIZWFkbGVzcykge1xuICAgICAgICBpZiAoaXNTZXJ2ZXJSdW5uaW5nICYmICFpc1VJQ2xpZW50UnVubmluZykge1xuICAgICAgICAgIGxvZy5pbmZvKGBTaW11bGF0b3Igd2l0aCBVRElEICR7dGhpcy51ZGlkfSBhbHJlYWR5IGJvb3RlZCBpbiBoZWFkbGVzcyBtb2RlLmApO1xuICAgICAgICAgIHNob3VsZFdhaXRGb3JCb290ID0gZmFsc2U7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChhd2FpdCB0aGlzLmtpbGxVSUNsaWVudCgpKSB7XG4gICAgICAgICAgLy8gU3RvcHBpbmcgdGhlIFVJIGNsaWVudCBhbHNvIGtpbGxzIGFsbCBydW5uaW5nIHNlcnZlcnMuIFNhZCBidXQgdHJ1ZVxuICAgICAgICAgIGxvZy5pbmZvKGBEZXRlY3RlZCB0aGUgVUkgY2xpZW50IHdhcyBydW5uaW5nIGFuZCBraWxsZWQgaXQuIFZlcmlmeWluZyB0aGUgU2ltdWxhdG9yIGlzIGluIFNodXRkb3duIHN0YXRlLi4uYCk7XG4gICAgICAgICAgYXdhaXQgd2FpdEZvclNodXRkb3duKCk7XG4gICAgICAgIH1cbiAgICAgICAgbG9nLmluZm8oYEJvb3RpbmcgU2ltdWxhdG9yIHdpdGggVURJRCAke3RoaXMudWRpZH0gaW4gaGVhZGxlc3MgbW9kZS4gQWxsIFVJLXJlbGF0ZWQgY2FwYWJpbGl0aWVzIGFyZSBnb2luZyB0byBiZSBpZ25vcmVkLmApO1xuICAgICAgICBhd2FpdCBib290U2ltdWxhdG9yKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoaXNTZXJ2ZXJSdW5uaW5nICYmIGlzVUlDbGllbnRSdW5uaW5nKSB7XG4gICAgICAgICAgbG9nLmluZm8oYEJvdGggU2ltdWxhdG9yIHdpdGggVURJRCAke3RoaXMudWRpZH0gYW5kIHRoZSBVSSBjbGllbnQgYXJlIGN1cnJlbnRseSBydW5uaW5nYCk7XG4gICAgICAgICAgc2hvdWxkV2FpdEZvckJvb3QgPSBmYWxzZTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFsnU2h1dGRvd24nLCAnQm9vdGVkJ10uaW5kZXhPZihzZXJ2ZXJTdGF0ZSkgPT09IC0xKSB7XG4gICAgICAgICAgaWYgKHNlcnZlclN0YXRlICE9PSAnU2h1dHRpbmcgRG93bicpIHtcbiAgICAgICAgICAgIGxvZy5pbmZvKGBTaW11bGF0b3IgJHt0aGlzLnVkaWR9IGlzIGluICcke3NlcnZlclN0YXRlfScgc3RhdGUuIFRyeWluZyB0byBzaHV0ZG93bi4uLmApO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgYXdhaXQgdGhpcy5zaHV0ZG93bigpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgIGxvZy53YXJuKGBFcnJvciBvbiBTaW11bGF0b3Igc2h1dGRvd246ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGF3YWl0IHdhaXRGb3JTaHV0ZG93bigpO1xuICAgICAgICB9XG4gICAgICAgIGxvZy5pbmZvKGBCb290aW5nIFNpbXVsYXRvciB3aXRoIFVESUQgJHt0aGlzLnVkaWR9Li4uYCk7XG4gICAgICAgIGF3YWl0IGJvb3RTaW11bGF0b3IoKTtcbiAgICAgICAgaWYgKCFpc1VJQ2xpZW50UnVubmluZykge1xuICAgICAgICAgIGF3YWl0IHRoaXMuc3RhcnRVSUNsaWVudChvcHRzKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaWYgKHNob3VsZFdhaXRGb3JCb290KSB7XG4gICAgICBhd2FpdCB0aGlzLndhaXRGb3JCb290KG9wdHMuc3RhcnR1cFRpbWVvdXQpO1xuICAgICAgbG9nLmluZm8oYFNpbXVsYXRvciB3aXRoIFVESUQgJHt0aGlzLnVkaWR9IGJvb3RlZCBpbiAke3Byb2Nlc3MuaHJ0aW1lKHN0YXJ0VGltZSlbMF19IHNlY29uZHNgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybSB2ZXJpZmljYXRpb24gb2YgZGV2aWNlIHByZWZlcmVuY2VzIGNvcnJlY3RuZXNzLlxuICAgKlxuICAgKiBAcGFyYW0ge0RldmljZVByZWZlcmVuY2VzfSBwcmVmcyBbe31dIC0gVGhlIHByZWZlcmVuY2VzIHRvIGJlIHZlcmlmaWVkXG4gICAqIEB0aHJvd3Mge0Vycm9yfSBJZiBhbnkgb2YgdGhlIGdpdmVuIHByZWZlcmVuY2UgdmFsdWVzIGRvZXMgbm90IG1hdGNoIHRoZSBleHBlY3RlZFxuICAgKiBmb3JtYXQuXG4gICAqL1xuICB2ZXJpZnlEZXZpY2VQcmVmZXJlbmNlcyAocHJlZnMgPSB7fSkge1xuICAgIGlmIChfLmlzRW1wdHkocHJlZnMpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCFfLmlzVW5kZWZpbmVkKHByZWZzLlNpbXVsYXRvcldpbmRvd0xhc3RTY2FsZSkpIHtcbiAgICAgIGlmICghXy5pc051bWJlcihwcmVmcy5TaW11bGF0b3JXaW5kb3dMYXN0U2NhbGUpIHx8IHByZWZzLlNpbXVsYXRvcldpbmRvd0xhc3RTY2FsZSA8PSAwKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBTaW11bGF0b3JXaW5kb3dMYXN0U2NhbGUgaXMgZXhwZWN0ZWQgdG8gYmUgYSBwb3NpdGl2ZSBmbG9hdCB2YWx1ZS4gYCArXG4gICAgICAgICAgYCcke3ByZWZzLlNpbXVsYXRvcldpbmRvd0xhc3RTY2FsZX0nIGlzIGFzc2lnbmVkIGluc3RlYWQuYCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCFfLmlzVW5kZWZpbmVkKHByZWZzLlNpbXVsYXRvcldpbmRvd0NlbnRlcikpIHtcbiAgICAgIC8vIGh0dHBzOi8vcmVnZXgxMDEuY29tL3IvMlpYT2lqLzJcbiAgICAgIGNvbnN0IHZlcmlmaWNhdGlvblBhdHRlcm4gPSAvey0/XFxkKyhcXC5cXGQrKT8sLT9cXGQrKFxcLlxcZCspP30vO1xuICAgICAgaWYgKCFfLmlzU3RyaW5nKHByZWZzLlNpbXVsYXRvcldpbmRvd0NlbnRlcikgfHwgIXZlcmlmaWNhdGlvblBhdHRlcm4udGVzdChwcmVmcy5TaW11bGF0b3JXaW5kb3dDZW50ZXIpKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBTaW11bGF0b3JXaW5kb3dDZW50ZXIgaXMgZXhwZWN0ZWQgdG8gbWF0Y2ggXCJ7ZmxvYXRYUG9zaXRpb24sZmxvYXRZUG9zaXRpb259XCIgZm9ybWF0ICh3aXRob3V0IHNwYWNlcykuIGAgK1xuICAgICAgICAgIGAnJHtwcmVmcy5TaW11bGF0b3JXaW5kb3dDZW50ZXJ9JyBpcyBhc3NpZ25lZCBpbnN0ZWFkLmApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghXy5pc1VuZGVmaW5lZChwcmVmcy5TaW11bGF0b3JXaW5kb3dPcmllbnRhdGlvbikpIHtcbiAgICAgIGNvbnN0IGFjY2VwdGFibGVWYWx1ZXMgPSBbJ1BvcnRyYWl0JywgJ0xhbmRzY2FwZUxlZnQnLCAnUG9ydHJhaXRVcHNpZGVEb3duJywgJ0xhbmRzY2FwZVJpZ2h0J107XG4gICAgICBpZiAoYWNjZXB0YWJsZVZhbHVlcy5pbmRleE9mKHByZWZzLlNpbXVsYXRvcldpbmRvd09yaWVudGF0aW9uKSA9PT0gLTEpIHtcbiAgICAgICAgbG9nLmVycm9yQW5kVGhyb3coYFNpbXVsYXRvcldpbmRvd09yaWVudGF0aW9uIGlzIGV4cGVjdGVkIHRvIGJlIG9uZSBvZiAke2FjY2VwdGFibGVWYWx1ZXN9LiBgICtcbiAgICAgICAgICBgJyR7cHJlZnMuU2ltdWxhdG9yV2luZG93T3JpZW50YXRpb259JyBpcyBhc3NpZ25lZCBpbnN0ZWFkLmApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghXy5pc1VuZGVmaW5lZChwcmVmcy5TaW11bGF0b3JXaW5kb3dSb3RhdGlvbkFuZ2xlKSkge1xuICAgICAgaWYgKCFfLmlzTnVtYmVyKHByZWZzLlNpbXVsYXRvcldpbmRvd1JvdGF0aW9uQW5nbGUpKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBTaW11bGF0b3JXaW5kb3dSb3RhdGlvbkFuZ2xlIGlzIGV4cGVjdGVkIHRvIGJlIGEgdmFsaWQgbnVtYmVyLiBgICtcbiAgICAgICAgICBgJyR7cHJlZnMuU2ltdWxhdG9yV2luZG93Um90YXRpb25BbmdsZX0nIGlzIGFzc2lnbmVkIGluc3RlYWQuYCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSB0aGUgY29tbW9uIGlPUyBTaW11bGF0b3IgcHJlZmVyZW5jZXMgZmlsZSB3aXRoIG5ldyB2YWx1ZXMuXG4gICAqIEl0IGlzIG5lY2Vzc2FyeSB0byByZXN0YXJ0IHRoZSBjb3JyZXNwb25kaW5nIFNpbXVsYXRvciBiZWZvcmVcbiAgICogdGhlc2UgY2hhbmdlcyBhcmUgYXBwbGllZC5cbiAgICpcbiAgICogQHBhcmFtIHtEZXZpY2VQcmVmZXJlbmNlc30gZGV2aWNlUHJlZnMgW3t9XSAtIFRoZSBtYXBwaW5nLCB3aGljaCByZXByZXNlbnRzIG5ldyBkZXZpY2UgcHJlZmVyZW5jZSB2YWx1ZXNcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciB0aGUgZ2l2ZW4gU2ltdWxhdG9yLlxuICAgKiBAcGFyYW0ge0NvbW1vblByZWZlcmVuY2VzfSBjb21tb25QcmVmcyBbe31dIC0gVGhlIG1hcHBpbmcsIHdoaWNoIHJlcHJlc2VudHMgbmV3IGNvbW1vbiBwcmVmZXJlbmNlIHZhbHVlc1xuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGFsbCBTaW11bGF0b3JzLlxuICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBwcmVmZXJlbmNlcyB3ZXJlIHN1Y2Nlc3NmdWxseSB1cGRhdGVkLlxuICAgKi9cbiAgYXN5bmMgdXBkYXRlUHJlZmVyZW5jZXMgKGRldmljZVByZWZzID0ge30sIGNvbW1vblByZWZzID0ge30pIHtcbiAgICBpZiAoIV8uaXNFbXB0eShkZXZpY2VQcmVmcykpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgU2V0dGluZyBwcmVmZXJlbmNlcyBvZiAke3RoaXMudWRpZH0gU2ltdWxhdG9yIHRvICR7SlNPTi5zdHJpbmdpZnkoZGV2aWNlUHJlZnMpfWApO1xuICAgIH1cbiAgICBpZiAoIV8uaXNFbXB0eShjb21tb25QcmVmcykpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgU2V0dGluZyBjb21tb24gU2ltdWxhdG9yIHByZWZlcmVuY2VzIHRvICR7SlNPTi5zdHJpbmdpZnkoY29tbW9uUHJlZnMpfWApO1xuICAgIH1cbiAgICBjb25zdCBob21lRm9sZGVyUGF0aCA9IHByb2Nlc3MuZW52LkhPTUU7XG4gICAgaWYgKCFob21lRm9sZGVyUGF0aCkge1xuICAgICAgbG9nLndhcm4oYENhbm5vdCBnZXQgdGhlIHBhdGggdG8gSE9NRSBmb2xkZXIgZnJvbSB0aGUgcHJvY2VzcyBlbnZpcm9ubWVudC4gYCArXG4gICAgICAgIGBJZ25vcmluZyBTaW11bGF0b3IgcHJlZmVyZW5jZXMgdXBkYXRlLmApO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB0aGlzLnZlcmlmeURldmljZVByZWZlcmVuY2VzKGRldmljZVByZWZzKTtcbiAgICBjb25zdCBwbGlzdFBhdGggPSBwYXRoLnJlc29sdmUoaG9tZUZvbGRlclBhdGgsICdMaWJyYXJ5JywgJ1ByZWZlcmVuY2VzJywgJ2NvbS5hcHBsZS5pcGhvbmVzaW11bGF0b3IucGxpc3QnKTtcbiAgICBpZiAoIWF3YWl0IGZzLmhhc0FjY2VzcyhwbGlzdFBhdGgpKSB7XG4gICAgICBsb2cud2FybihgU2ltdWxhdG9yIHByZWZlcmVuY2VzIGZpbGUgJyR7cGxpc3RQYXRofScgaXMgbm90IGFjY2Vzc2libGUuIGAgK1xuICAgICAgICBgSWdub3JpbmcgU2ltdWxhdG9yIHByZWZlcmVuY2VzIHVwZGF0ZS5gKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgbGV0IG5ld1ByZWZzID0ge307XG4gICAgaWYgKCFfLmlzRW1wdHkoZGV2aWNlUHJlZnMpKSB7XG4gICAgICBuZXdQcmVmcy5EZXZpY2VQcmVmZXJlbmNlcyA9IHtbdGhpcy51ZGlkLnRvVXBwZXJDYXNlKCldOiBkZXZpY2VQcmVmc307XG4gICAgfVxuICAgIG5ld1ByZWZzID0gXy5tZXJnZShuZXdQcmVmcywgY29tbW9uUHJlZnMpO1xuICAgIHJldHVybiBhd2FpdCBwcmVmZXJlbmNlc1BsaXN0R3VhcmQuYWNxdWlyZShTaW11bGF0b3JYY29kZTkubmFtZSwgYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgY3VycmVudFBsaXN0Q29udGVudCA9IGF3YWl0IHBsaXN0LnBhcnNlUGxpc3RGaWxlKHBsaXN0UGF0aCk7XG4gICAgICAgIGF3YWl0IHBsaXN0LnVwZGF0ZVBsaXN0RmlsZShwbGlzdFBhdGgsIF8ubWVyZ2UoY3VycmVudFBsaXN0Q29udGVudCwgbmV3UHJlZnMpLCB0cnVlKTtcbiAgICAgICAgbG9nLmRlYnVnKGBVcGRhdGVkICR7dGhpcy51ZGlkfSBTaW11bGF0b3IgcHJlZmVyZW5jZXMgYXQgJyR7cGxpc3RQYXRofScgd2l0aCAke0pTT04uc3RyaW5naWZ5KG5ld1ByZWZzKX1gKTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy53YXJuKGBDYW5ub3QgdXBkYXRlICR7dGhpcy51ZGlkfSBTaW11bGF0b3IgcHJlZmVyZW5jZXMgYXQgJyR7cGxpc3RQYXRofScuIGAgK1xuICAgICAgICAgICAgICAgICBgVHJ5IHRvIGRlbGV0ZSB0aGUgZmlsZSBtYW51YWxseSBpbiBvcmRlciB0byByZXNldCBpdC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogU2h1dCBkb3duIHRoZSBjdXJyZW50IFNpbXVsYXRvci5cbiAgICogQG92ZXJyaWRlXG4gICAqL1xuICBhc3luYyBzaHV0ZG93biAoKSB7XG4gICAgY29uc3Qge3N0YXRlfSA9IGF3YWl0IHRoaXMuc3RhdCgpO1xuICAgIGlmIChzdGF0ZSA9PT0gJ1NodXRkb3duJykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBhd2FpdCByZXRyeUludGVydmFsKDUsIDUwMCwgc2ltY3RsU2h1dGRvd24sIHRoaXMudWRpZCk7XG4gIH1cblxuICAvKipcbiAgICogUmVzZXQgdGhlIGN1cnJlbnQgU2ltdWxhdG9yIHRvIHRoZSBjbGVhbiBzdGF0ZS5cbiAgICogQG92ZXJyaWRlXG4gICAqL1xuICBhc3luYyBjbGVhbiAoKSB7XG4gICAgbG9nLmluZm8oYENsZWFuaW5nIHNpbXVsYXRvciAke3RoaXMudWRpZH1gKTtcbiAgICBhd2FpdCBlcmFzZURldmljZSh0aGlzLnVkaWQsIDEwMDAwKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKiBAb3ZlcnJpZGVcbiAgICogQHByaXZhdGVcbiAgICovXG4gIGFzeW5jIF9hY3RpdmF0ZVdpbmRvdyAoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGZic2ltY3RsLmZvY3VzKHRoaXMudWRpZCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihgQ2Fubm90IGZvY3VzIFNpbXVsYXRvciB3aW5kb3cgd2l0aCBmYnNpbWN0bC4gRGVmYXVsdGluZyB0byBBcHBsZVNjcmlwdC4gYCArXG4gICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIGNvbnN0IHtuYW1lLCBzZGt9ID0gYXdhaXQgdGhpcy5zdGF0KCk7XG4gICAgICByZXR1cm4gYFxuICAgICAgICB0ZWxsIGFwcGxpY2F0aW9uIFwiU3lzdGVtIEV2ZW50c1wiXG4gICAgICAgICAgdGVsbCBwcm9jZXNzIFwiU2ltdWxhdG9yXCJcbiAgICAgICAgICAgIHNldCBmcm9udG1vc3QgdG8gZmFsc2VcbiAgICAgICAgICAgIHNldCBmcm9udG1vc3QgdG8gdHJ1ZVxuICAgICAgICAgICAgY2xpY2sgKG1lbnUgaXRlbSAxIHdoZXJlIChpdHMgbmFtZSBjb250YWlucyBcIiR7bmFtZX0gLVwiIGFuZCBpdHMgbmFtZSBjb250YWlucyBcIiR7c2RrfVwiKSkgb2YgbWVudSAxIG9mIG1lbnUgYmFyIGl0ZW0gXCJXaW5kb3dcIiBvZiBtZW51IGJhciAxXG4gICAgICAgICAgZW5kIHRlbGxcbiAgICAgICAgZW5kIHRlbGxcbiAgICAgIGA7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0ZG9jXG4gICAqIEBvdmVycmlkZVxuICAgKi9cbiAgYXN5bmMgaXNCaW9tZXRyaWNFbnJvbGxlZCAoKSB7XG4gICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCBzcGF3bih0aGlzLnVkaWQsIFtcbiAgICAgICdub3RpZnl1dGlsJyxcbiAgICAgICctZycsIEVOUk9MTE1FTlRfTk9USUZJQ0FUSU9OX1JFQ0VJVkVSXG4gICAgXSk7XG4gICAgY29uc3QgbWF0Y2ggPSAobmV3IFJlZ0V4cChgJHtfLmVzY2FwZVJlZ0V4cChFTlJPTExNRU5UX05PVElGSUNBVElPTl9SRUNFSVZFUil9XFxcXHMrKFswMV0pYCkpXG4gICAgICAuZXhlYyhzdGRvdXQpO1xuICAgIGlmICghbWF0Y2gpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHBhcnNlIGJpb21ldHJpYyBlbnJvbGxtZW50IHN0YXRlIGZyb20gJyR7c3Rkb3V0fSdgKTtcbiAgICB9XG4gICAgbG9nLmluZm8oYEN1cnJlbnQgYmlvbWV0cmljIGVucm9sbGVkIHN0YXRlIGZvciAke3RoaXMudWRpZH0gU2ltdWxhdG9yOiAke21hdGNoWzFdfWApO1xuICAgIHJldHVybiBtYXRjaFsxXSA9PT0gJzEnO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0ZG9jXG4gICAqIEBvdmVycmlkZVxuICAgKi9cbiAgYXN5bmMgZW5yb2xsQmlvbWV0cmljIChpc0VuYWJsZWQgPSB0cnVlKSB7XG4gICAgbG9nLmRlYnVnKGBTZXR0aW5nIGJpb21ldHJpYyBlbnJvbGxlZCBzdGF0ZSBmb3IgJHt0aGlzLnVkaWR9IFNpbXVsYXRvciB0byAnJHtpc0VuYWJsZWQgPyAnZW5hYmxlZCcgOiAnZGlzYWJsZWQnfSdgKTtcbiAgICBhd2FpdCBzcGF3bih0aGlzLnVkaWQsIFtcbiAgICAgICdub3RpZnl1dGlsJyxcbiAgICAgICctcycsIEVOUk9MTE1FTlRfTk9USUZJQ0FUSU9OX1JFQ0VJVkVSLCBpc0VuYWJsZWQgPyAnMScgOiAnMCdcbiAgICBdKTtcbiAgICBhd2FpdCBzcGF3bih0aGlzLnVkaWQsIFtcbiAgICAgICdub3RpZnl1dGlsJyxcbiAgICAgICctcCcsIEVOUk9MTE1FTlRfTk9USUZJQ0FUSU9OX1JFQ0VJVkVSXG4gICAgXSk7XG4gICAgaWYgKGF3YWl0IHRoaXMuaXNCaW9tZXRyaWNFbnJvbGxlZCgpICE9PSBpc0VuYWJsZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHNldCBiaW9tZXRyaWMgZW5yb2xsZWQgc3RhdGUgZm9yICR7dGhpcy51ZGlkfSBTaW11bGF0b3IgdG8gJyR7aXNFbmFibGVkID8gJ2VuYWJsZWQnIDogJ2Rpc2FibGVkJ30nYCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNlbmRzIGEgbm90aWZpY2F0aW9uIHRvIG1hdGNoL25vdCBtYXRjaCB0aGUgcGFydGljdWxhciBiaW9tZXRyaWMuXG4gICAqIEBvdmVycmlkZVxuICAgKlxuICAgKiBAcGFyYW0gez9ib29sZWFufSBzaG91bGRNYXRjaCBbdHJ1ZV0gLSBTZXQgaXQgdG8gdHJ1ZSBvciBmYWxzZSBpbiBvcmRlciB0byBlbXVsYXRlXG4gICAqIG1hdGNoaW5nL25vdCBtYXRjaGluZyB0aGUgY29ycmVzcG9uZGluZyBiaW9tZXRyaWNcbiAgICogQHBhcmFtIHs/c3RyaW5nfSBiaW9tZXRyaWNOYW1lIFt0b3VjaElkXSAtIEVpdGhlciB0b3VjaElkIG9yIGZhY2VJZCAoZmFjZUlkIGlzIG9ubHkgYXZhaWxhYmxlIHNpbmNlIGlPUyAxMSlcbiAgICovXG4gIGFzeW5jIHNlbmRCaW9tZXRyaWNNYXRjaCAoc2hvdWxkTWF0Y2ggPSB0cnVlLCBiaW9tZXRyaWNOYW1lID0gJ3RvdWNoSWQnKSB7XG4gICAgY29uc3QgZG9tYWluQ29tcG9uZW50ID0gdG9CaW9tZXRyaWNEb21haW5Db21wb25lbnQoYmlvbWV0cmljTmFtZSk7XG4gICAgY29uc3QgZG9tYWluID0gYGNvbS5hcHBsZS5CaW9tZXRyaWNLaXRfU2ltLiR7ZG9tYWluQ29tcG9uZW50fS4ke3Nob3VsZE1hdGNoID8gJycgOiAnbm8nfW1hdGNoYDtcbiAgICBhd2FpdCBzcGF3bih0aGlzLnVkaWQsIFtcbiAgICAgICdub3RpZnl1dGlsJyxcbiAgICAgICctcCcsIGRvbWFpblxuICAgIF0pO1xuICAgIGxvZy5pbmZvKGBTZW50IG5vdGlmaWNhdGlvbiAke2RvbWFpbn0gdG8gJHtzaG91bGRNYXRjaCA/ICdtYXRjaCcgOiAnbm90IG1hdGNoJ30gJHtiaW9tZXRyaWNOYW1lfSBiaW9tZXRyaWMgYCArXG4gICAgICBgZm9yICR7dGhpcy51ZGlkfSBTaW11bGF0b3JgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAb3ZlcnJpZGVcbiAgICovXG4gIGFzeW5jIGdldExhdW5jaERhZW1vbnNSb290ICgpIHtcbiAgICBjb25zdCBkZXZSb290ID0gYXdhaXQgZ2V0RGV2ZWxvcGVyUm9vdCgpO1xuICAgIHJldHVybiBwYXRoLnJlc29sdmUoZGV2Um9vdCxcbiAgICAgICdQbGF0Zm9ybXMvaVBob25lT1MucGxhdGZvcm0vRGV2ZWxvcGVyL0xpYnJhcnkvQ29yZVNpbXVsYXRvci9Qcm9maWxlcy9SdW50aW1lcy9pT1Muc2ltcnVudGltZS9Db250ZW50cy9SZXNvdXJjZXMvUnVudGltZVJvb3QvU3lzdGVtL0xpYnJhcnkvTGF1bmNoRGFlbW9ucycpO1xuICB9XG5cbn1cblxuZXhwb3J0IGRlZmF1bHQgU2ltdWxhdG9yWGNvZGU5O1xuIl0sImZpbGUiOiJsaWIvc2ltdWxhdG9yLXhjb2RlLTkuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
