"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _simulatorXcode = require("./simulator-xcode-6");

var _simulatorXcode2 = _interopRequireDefault(require("./simulator-xcode-7"));

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _asyncbox = require("asyncbox");

var _teen_process = require("teen_process");

var _nodeSimctl = require("node-simctl");

var fbsimctl = _interopRequireWildcard(require("./fbsimctl-utils"));

const STARTUP_TIMEOUT = 120 * 1000;
const SAFARI_STARTUP_TIMEOUT = 25 * 1000;
const MOBILE_SAFARI_BUNDLE_ID = 'com.apple.mobilesafari';

const PROCESS_LAUNCH_OK_PATTERN = bundleId => new RegExp(`${bundleId.replace('.', '\\.')}:\\s+\\d+`);

class SimulatorXcode8 extends _simulatorXcode2.default {
  constructor(udid, xcodeVersion) {
    super(udid, xcodeVersion);
    this.isFreshFiles = ['Library/Cookies', 'Library/Preferences/.GlobalPreferences.plist', 'Library/Preferences/com.apple.springboard.plist', 'var/run/syslog.pid'];
  }

  async killUIClient(force = false) {
    const pid = await this.getUIClientPid();

    if (!pid) {
      return false;
    }

    _logger.default.debug(`Sending ${force ? 'forced ' : ''}kill signal to Simulator UI client with PID ${pid}`);

    try {
      await (0, _teen_process.exec)('kill', force ? ['-9', pid] : [pid]);
      return true;
    } catch (e) {
      throw new Error(`Cannot kill the Simulator UI client. Original error: ${e.message}`);
    }
  }

  async isAppInstalled(bundleId) {
    try {
      const appContainer = await (0, _nodeSimctl.getAppContainer)(this.udid, bundleId, false);
      return appContainer.endsWith('.app');
    } catch (err) {
      try {
        const info = await (0, _nodeSimctl.appInfo)(this.udid, bundleId);
        return info.includes('ApplicationType');
      } catch (e) {
        return false;
      }
    }
  }

  get startupTimeout() {
    return STARTUP_TIMEOUT;
  }

  async waitForBoot(startupTimeout) {
    await (0, _nodeSimctl.startBootMonitor)(this.udid, {
      timeout: startupTimeout
    });
    this.emit(_simulatorXcode.BOOT_COMPLETED_EVENT);
  }

  async openUrl(url) {
    if (!(await this.isRunning())) {
      throw new Error(`Tried to open ${url}, but Simulator is not in Booted state`);
    }

    const launchTimestamp = process.hrtime();
    let lastError = null;

    try {
      await (0, _asyncbox.waitForCondition)(async () => {
        try {
          const {
            stdout
          } = await (0, _teen_process.exec)('xcrun', ['simctl', 'launch', this.udid, MOBILE_SAFARI_BUNDLE_ID]);

          if (PROCESS_LAUNCH_OK_PATTERN(MOBILE_SAFARI_BUNDLE_ID).test(stdout)) {
            await (0, _nodeSimctl.openUrl)(this.udid, url);
            return true;
          }
        } catch (err) {
          _logger.default.error(`Failed to open '${url}' in Safari. Retrying...`);

          lastError = err.stderr || err.message;
        }

        return false;
      }, {
        waitMs: SAFARI_STARTUP_TIMEOUT,
        intervalMs: 500
      });
    } catch (err) {
      _logger.default.errorAndThrow(`Safari cannot open '${url}' after ${process.hrtime(launchTimestamp)[0]} seconds ` + `because of: ${lastError || 'an unknown error'}`);
    }

    _logger.default.debug(`Safari has successfully opened '${url}' in ${process.hrtime(launchTimestamp)[0]} seconds`);
  }

  async cleanSafari(keepPrefs = true) {
    try {
      if (await this.isRunning()) {
        await (0, _nodeSimctl.terminate)(this.udid, MOBILE_SAFARI_BUNDLE_ID);
      }
    } catch (ign) {}

    await super.cleanSafari(keepPrefs);
  }

  async cleanCustomApp(appFile, appBundleId, scrub = false) {
    try {
      await (0, _nodeSimctl.terminate)(this.udid, appBundleId);
    } catch (ign) {}

    await super.cleanCustomApp(appFile, appBundleId, scrub);
  }

  async shake() {
    _logger.default.info(`Performing shake gesture on ${this.udid} Simulator`);

    await (0, _nodeSimctl.spawn)(this.udid, ['notifyutil', '-p', 'com.apple.UIKit.SimulatorShake']);
  }

  async _activateWindow() {
    try {
      await fbsimctl.focus(this.udid);
    } catch (err) {
      _logger.default.warn(`Cannot focus Simulator window with fbsimctl. Defaulting to AppleScript. ` + `Original error: ${err.message}`);

      return await super._activateWindow();
    }
  }

  async isBiometricEnrolled() {
    const output = await this.executeUIClientScript(`
      tell application "System Events"
        tell process "Simulator"
          set dstMenuItem to menu item "Toggle Enrolled State" of menu 1 of menu item "Touch ID" of menu 1 of menu bar item "Hardware" of menu bar 1
          set isChecked to (value of attribute "AXMenuItemMarkChar" of dstMenuItem) is "✓"
        end tell
      end tell
    `);

    _logger.default.debug(`Touch ID enrolled state: ${output}`);

    return _lodash.default.isString(output) && output.trim() === 'true';
  }

  async enrollBiometric(isEnabled = true) {
    await this.executeUIClientScript(`
      tell application "System Events"
        tell process "Simulator"
          set dstMenuItem to menu item "Toggle Enrolled State" of menu 1 of menu item "Touch ID" of menu 1 of menu bar item "Hardware" of menu bar 1
          set isChecked to (value of attribute "AXMenuItemMarkChar" of dstMenuItem) is "✓"
          if ${isEnabled ? 'not ' : ''}isChecked then
            click dstMenuItem
          end if
        end tell
      end tell
    `);
  }

  async sendBiometricMatch(shouldMatch = true) {
    await this.executeUIClientScript(`
      tell application "System Events"
        tell process "Simulator"
          set dstMenuItem to menu item "${shouldMatch ? 'Matching Touch' : 'Non-matching Touch'}" of menu 1 of menu item "Touch ID" of menu 1 of menu bar item "Hardware" of menu bar 1
          click dstMenuItem
        end tell
      end tell
    `);
  }

  async setGeolocation(latitude, longitude) {
    try {
      await fbsimctl.setGeoLocation(this.udid, latitude, longitude);
      return true;
    } catch (e) {
      _logger.default.warn(`Cannot set geolocation with fbsimctl. Defaulting to AppleScript. Original error: ${e.message}`);

      const output = await this.executeUIClientScript(`
        tell application "System Events"
          tell process "Simulator"
            set featureName to "Custom Location"
            set dstMenuItem to menu item (featureName & "…") of menu 1 of menu item "Location" of menu 1 of menu bar item "Debug" of menu bar 1
            click dstMenuItem
            delay 1
            set value of text field 1 of window featureName to "${latitude}"
            delay 0.5
            set value of text field 2 of window featureName to "${longitude}"
            delay 0.5
            click button "OK" of window featureName
            delay 0.5
            set isInvisible to (not (exists (window featureName)))
          end tell
        end tell
      `);

      _logger.default.debug(`Geolocation parameters dialog accepted: ${output}`);

      return _lodash.default.isString(output) && output.trim() === 'true';
    }
  }

}

var _default = SimulatorXcode8;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3IteGNvZGUtOC5qcyJdLCJuYW1lcyI6WyJTVEFSVFVQX1RJTUVPVVQiLCJTQUZBUklfU1RBUlRVUF9USU1FT1VUIiwiTU9CSUxFX1NBRkFSSV9CVU5ETEVfSUQiLCJQUk9DRVNTX0xBVU5DSF9PS19QQVRURVJOIiwiYnVuZGxlSWQiLCJSZWdFeHAiLCJyZXBsYWNlIiwiU2ltdWxhdG9yWGNvZGU4IiwiU2ltdWxhdG9yWGNvZGU3IiwiY29uc3RydWN0b3IiLCJ1ZGlkIiwieGNvZGVWZXJzaW9uIiwiaXNGcmVzaEZpbGVzIiwia2lsbFVJQ2xpZW50IiwiZm9yY2UiLCJwaWQiLCJnZXRVSUNsaWVudFBpZCIsImxvZyIsImRlYnVnIiwiZSIsIkVycm9yIiwibWVzc2FnZSIsImlzQXBwSW5zdGFsbGVkIiwiYXBwQ29udGFpbmVyIiwiZW5kc1dpdGgiLCJlcnIiLCJpbmZvIiwiaW5jbHVkZXMiLCJzdGFydHVwVGltZW91dCIsIndhaXRGb3JCb290IiwidGltZW91dCIsImVtaXQiLCJCT09UX0NPTVBMRVRFRF9FVkVOVCIsIm9wZW5VcmwiLCJ1cmwiLCJpc1J1bm5pbmciLCJsYXVuY2hUaW1lc3RhbXAiLCJwcm9jZXNzIiwiaHJ0aW1lIiwibGFzdEVycm9yIiwic3Rkb3V0IiwidGVzdCIsImVycm9yIiwic3RkZXJyIiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsImVycm9yQW5kVGhyb3ciLCJjbGVhblNhZmFyaSIsImtlZXBQcmVmcyIsImlnbiIsImNsZWFuQ3VzdG9tQXBwIiwiYXBwRmlsZSIsImFwcEJ1bmRsZUlkIiwic2NydWIiLCJzaGFrZSIsIl9hY3RpdmF0ZVdpbmRvdyIsImZic2ltY3RsIiwiZm9jdXMiLCJ3YXJuIiwiaXNCaW9tZXRyaWNFbnJvbGxlZCIsIm91dHB1dCIsImV4ZWN1dGVVSUNsaWVudFNjcmlwdCIsIl8iLCJpc1N0cmluZyIsInRyaW0iLCJlbnJvbGxCaW9tZXRyaWMiLCJpc0VuYWJsZWQiLCJzZW5kQmlvbWV0cmljTWF0Y2giLCJzaG91bGRNYXRjaCIsInNldEdlb2xvY2F0aW9uIiwibGF0aXR1ZGUiLCJsb25naXR1ZGUiLCJzZXRHZW9Mb2NhdGlvbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUdBLE1BQU1BLGVBQWUsR0FBRyxNQUFNLElBQTlCO0FBQ0EsTUFBTUMsc0JBQXNCLEdBQUcsS0FBSyxJQUFwQztBQUNBLE1BQU1DLHVCQUF1QixHQUFHLHdCQUFoQzs7QUFDQSxNQUFNQyx5QkFBeUIsR0FBSUMsUUFBRCxJQUFjLElBQUlDLE1BQUosQ0FBWSxHQUFFRCxRQUFRLENBQUNFLE9BQVQsQ0FBaUIsR0FBakIsRUFBc0IsS0FBdEIsQ0FBNkIsV0FBM0MsQ0FBaEQ7O0FBRUEsTUFBTUMsZUFBTixTQUE4QkMsd0JBQTlCLENBQThDO0FBQzVDQyxFQUFBQSxXQUFXLENBQUVDLElBQUYsRUFBUUMsWUFBUixFQUFzQjtBQUMvQixVQUFNRCxJQUFOLEVBQVlDLFlBQVo7QUFLQSxTQUFLQyxZQUFMLEdBQW9CLENBQ2xCLGlCQURrQixFQUVsQiw4Q0FGa0IsRUFHbEIsaURBSGtCLEVBSWxCLG9CQUprQixDQUFwQjtBQU1EOztBQVdELFFBQU1DLFlBQU4sQ0FBb0JDLEtBQUssR0FBRyxLQUE1QixFQUFtQztBQUNqQyxVQUFNQyxHQUFHLEdBQUcsTUFBTSxLQUFLQyxjQUFMLEVBQWxCOztBQUNBLFFBQUksQ0FBQ0QsR0FBTCxFQUFVO0FBQ1IsYUFBTyxLQUFQO0FBQ0Q7O0FBRURFLG9CQUFJQyxLQUFKLENBQVcsV0FBVUosS0FBSyxHQUFHLFNBQUgsR0FBZSxFQUFHLCtDQUE4Q0MsR0FBSSxFQUE5Rjs7QUFDQSxRQUFJO0FBQ0YsWUFBTSx3QkFBSyxNQUFMLEVBQWFELEtBQUssR0FBRyxDQUFDLElBQUQsRUFBT0MsR0FBUCxDQUFILEdBQWlCLENBQUNBLEdBQUQsQ0FBbkMsQ0FBTjtBQUNBLGFBQU8sSUFBUDtBQUNELEtBSEQsQ0FHRSxP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TUFBWCxLQUFzQkEsTUFBTSxDQUFDSSxJQUFQLE9BQWtCLE1BQS9DO0FBQ0Q7O0FBTUQsUUFBTUMsZUFBTixDQUF1QkMsU0FBUyxHQUFHLElBQW5DLEVBQXlDO0FBQ3ZDLFVBQU0sS0FBS0wscUJBQUwsQ0FBNEI7Ozs7O2VBS3ZCSyxTQUFTLEdBQUcsTUFBSCxHQUFZLEVBQUc7Ozs7O0tBTDdCLENBQU47QUFXRDs7QUFNRCxRQUFNQyxrQkFBTixDQUEwQkMsV0FBVyxHQUFHLElBQXhDLEVBQThDO0FBQzVDLFVBQU0sS0FBS1AscUJBQUwsQ0FBNEI7OzswQ0FHSU8sV0FBVyxHQUFHLGdCQUFILEdBQXNCLG9CQUFxQjs7OztLQUh0RixDQUFOO0FBUUQ7O0FBV0QsUUFBTUMsY0FBTixDQUFzQkMsUUFBdEIsRUFBZ0NDLFNBQWhDLEVBQTJDO0FBQ3pDLFFBQUk7QUFDRixZQUFNZixRQUFRLENBQUNnQixjQUFULENBQXdCLEtBQUs5RCxJQUE3QixFQUFtQzRELFFBQW5DLEVBQTZDQyxTQUE3QyxDQUFOO0FBQ0EsYUFBTyxJQUFQO0FBQ0QsS0FIRCxDQUdFLE9BQU9wRCxDQUFQLEVBQVU7QUFDVkYsc0JBQUl5QyxJQUFKLENBQVUsb0ZBQW1GdkMsQ0FBQyxDQUFDRSxPQUFRLEVBQXZHOztBQUNBLFlBQU11QyxNQUFNLEdBQUcsTUFBTSxLQUFLQyxxQkFBTCxDQUE0Qjs7Ozs7OztrRUFPV1MsUUFBUzs7a0VBRVRDLFNBQVU7Ozs7Ozs7T0FUakQsQ0FBckI7O0FBaUJBdEQsc0JBQUlDLEtBQUosQ0FBVywyQ0FBMEMwQyxNQUFPLEVBQTVEOztBQUNBLGFBQU9FLGdCQUFFQyxRQUFGLENBQVdILE1BQVgsS0FBc0JBLE1BQU0sQ0FBQ0ksSUFBUCxPQUFrQixNQUEvQztBQUNEO0FBQ0Y7O0FBelEyQzs7ZUE0US9CekQsZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJPT1RfQ09NUExFVEVEX0VWRU5UIH0gZnJvbSAnLi9zaW11bGF0b3IteGNvZGUtNic7XG5pbXBvcnQgU2ltdWxhdG9yWGNvZGU3IGZyb20gJy4vc2ltdWxhdG9yLXhjb2RlLTcnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHsgZ2V0QXBwQ29udGFpbmVyLCBvcGVuVXJsIGFzIHNpbWN0bE9wZW5VcmwsIHRlcm1pbmF0ZSxcbiAgICAgICAgIGFwcEluZm8sIHNwYXduLCBzdGFydEJvb3RNb25pdG9yIH0gZnJvbSAnbm9kZS1zaW1jdGwnO1xuaW1wb3J0ICogYXMgZmJzaW1jdGwgZnJvbSAnLi9mYnNpbWN0bC11dGlscyc7XG5cbi8vIHRoZXNlIHNpbXMgYXJlIHNsb29vb29vb293XG5jb25zdCBTVEFSVFVQX1RJTUVPVVQgPSAxMjAgKiAxMDAwO1xuY29uc3QgU0FGQVJJX1NUQVJUVVBfVElNRU9VVCA9IDI1ICogMTAwMDtcbmNvbnN0IE1PQklMRV9TQUZBUklfQlVORExFX0lEID0gJ2NvbS5hcHBsZS5tb2JpbGVzYWZhcmknO1xuY29uc3QgUFJPQ0VTU19MQVVOQ0hfT0tfUEFUVEVSTiA9IChidW5kbGVJZCkgPT4gbmV3IFJlZ0V4cChgJHtidW5kbGVJZC5yZXBsYWNlKCcuJywgJ1xcXFwuJyl9OlxcXFxzK1xcXFxkK2ApO1xuXG5jbGFzcyBTaW11bGF0b3JYY29kZTggZXh0ZW5kcyBTaW11bGF0b3JYY29kZTcge1xuICBjb25zdHJ1Y3RvciAodWRpZCwgeGNvZGVWZXJzaW9uKSB7XG4gICAgc3VwZXIodWRpZCwgeGNvZGVWZXJzaW9uKTtcblxuICAgIC8vIGxpc3Qgb2YgZmlsZXMgdG8gY2hlY2sgZm9yIHdoZW4gc2VlaW5nIGlmIGEgc2ltdWxhdG9yIGlzIFwiZnJlc2hcIlxuICAgIC8vIChtZWFuaW5nIGl0IGhhcyBuZXZlciBiZWVuIGJvb3RlZCkuXG4gICAgLy8gSWYgdGhlc2UgZmlsZXMgYXJlIHByZXNlbnQsIHdlIGFzc3VtZSBpdCdzIGJlZW4gc3VjY2Vzc2Z1bGx5IGJvb3RlZFxuICAgIHRoaXMuaXNGcmVzaEZpbGVzID0gW1xuICAgICAgJ0xpYnJhcnkvQ29va2llcycsXG4gICAgICAnTGlicmFyeS9QcmVmZXJlbmNlcy8uR2xvYmFsUHJlZmVyZW5jZXMucGxpc3QnLFxuICAgICAgJ0xpYnJhcnkvUHJlZmVyZW5jZXMvY29tLmFwcGxlLnNwcmluZ2JvYXJkLnBsaXN0JyxcbiAgICAgICd2YXIvcnVuL3N5c2xvZy5waWQnXG4gICAgXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBLaWxsIHRoZSBVSSBjbGllbnQgaWYgaXQgaXMgcnVubmluZy5cbiAgICpcbiAgICogQHBhcmFtIHtib29sZWFufSBmb3JjZSAtIFNldCBpdCB0byB0cnVlIHRvIHNlbmQgU0lHS0lMTCBzaWduYWwgdG8gU2ltdWxhdG9yIHByb2Nlc3MuXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICBTSUdURVJNIHdpbGwgYmUgc2VudCBieSBkZWZhdWx0LlxuICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBVSSBjbGllbnQgd2FzIHN1Y2Nlc3NmdWxseSBraWxsZWQgb3IgZmFsc2VcbiAgICogICAgICAgICAgICAgICAgICAgaWYgaXQgaXMgbm90IHJ1bm5pbmcuXG4gICAqIEB0aHJvd3Mge0Vycm9yfSBJZiBzZW5kaW5nIHRoZSBzaWduYWwgdG8gdGhlIGNsaWVudCBwcm9jZXNzIGZhaWxzXG4gICAqL1xuICBhc3luYyBraWxsVUlDbGllbnQgKGZvcmNlID0gZmFsc2UpIHtcbiAgICBjb25zdCBwaWQgPSBhd2FpdCB0aGlzLmdldFVJQ2xpZW50UGlkKCk7XG4gICAgaWYgKCFwaWQpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBsb2cuZGVidWcoYFNlbmRpbmcgJHtmb3JjZSA/ICdmb3JjZWQgJyA6ICcnfWtpbGwgc2lnbmFsIHRvIFNpbXVsYXRvciBVSSBjbGllbnQgd2l0aCBQSUQgJHtwaWR9YCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGV4ZWMoJ2tpbGwnLCBmb3JjZSA/IFsnLTknLCBwaWRdIDogW3BpZF0pO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3Qga2lsbCB0aGUgU2ltdWxhdG9yIFVJIGNsaWVudC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZnkgd2hldGhlciB0aGUgcGFydGljdWxhciBhcHBsaWNhdGlvbiBpcyBpbnN0YWxsZWQgb24gU2ltdWxhdG9yLlxuICAgKiBAb3ZlcnJpZGVcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGJ1bmRsZUlkIC0gVGhlIGJ1bmRsZSBpZCBvZiB0aGUgYXBwbGljYXRpb24gdG8gYmUgY2hlY2tlZC5cbiAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgZ2l2ZW4gYXBwbGljYXRpb24gaXMgaW5zdGFsbGVkLlxuICAgKi9cbiAgYXN5bmMgaXNBcHBJbnN0YWxsZWQgKGJ1bmRsZUlkKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGFwcENvbnRhaW5lciA9IGF3YWl0IGdldEFwcENvbnRhaW5lcih0aGlzLnVkaWQsIGJ1bmRsZUlkLCBmYWxzZSk7XG4gICAgICByZXR1cm4gYXBwQ29udGFpbmVyLmVuZHNXaXRoKCcuYXBwJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBnZXRfYXBwX2NvbnRhaW5lciBzdWJjb21tYW5kIGZhaWxzIGZvciBzeXN0ZW0gYXBwbGljYXRpb25zLFxuICAgICAgLy8gc28gd2UgdHJ5IHRoZSBoaWRkZW4gYXBwaW5mbyBzdWJjb21tYW5kLCB3aGljaCBwcmludHMgY29ycmVjdCBpbmZvIGZvclxuICAgICAgLy8gc3lzdGVtL2hpZGRlbiBhcHBzXG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBpbmZvID0gYXdhaXQgYXBwSW5mbyh0aGlzLnVkaWQsIGJ1bmRsZUlkKTtcbiAgICAgICAgcmV0dXJuIGluZm8uaW5jbHVkZXMoJ0FwcGxpY2F0aW9uVHlwZScpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm4ge251bWJlcn0gVGhlIG1heCBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQgdW50aWwgU2ltdWxhdG9yIGJvb3RpbmcgaXMgY29tcGxldGVkLlxuICAgKi9cbiAgZ2V0IHN0YXJ0dXBUaW1lb3V0ICgpIHtcbiAgICByZXR1cm4gU1RBUlRVUF9USU1FT1VUO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmeSB3aGV0aGVyIHRoZSBTaW11bGF0b3IgYm9vdGluZyBpcyBjb21wbGV0ZWQgYW5kL29yIHdhaXQgZm9yIGl0XG4gICAqIHVudGlsIHRoZSB0aW1lb3V0IGV4cGlyZXMuXG4gICAqIEBvdmVycmlkZVxuICAgKlxuICAgKiBAcGFyYW0ge251bWJlcn0gc3RhcnR1cFRpbWVvdXQgLSB0aGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB3YWl0IHVudGlsIGJvb3RpbmcgaXMgY29tcGxldGVkLlxuICAgKiBAZW1pdHMgQk9PVF9DT01QTEVURURfRVZFTlQgaWYgdGhlIGN1cnJlbnQgU2ltdWxhdG9yIGlzIHJlYWR5IHRvIGFjY2VwdCBzaW1jdGwgY29tbWFuZHMsIGxpa2UgJ2luc3RhbGwnLlxuICAgKi9cbiAgYXN5bmMgd2FpdEZvckJvb3QgKHN0YXJ0dXBUaW1lb3V0KSB7XG4gICAgYXdhaXQgc3RhcnRCb290TW9uaXRvcih0aGlzLnVkaWQsIHt0aW1lb3V0OiBzdGFydHVwVGltZW91dH0pO1xuICAgIHRoaXMuZW1pdChCT09UX0NPTVBMRVRFRF9FVkVOVCk7XG4gIH1cblxuICAvKipcbiAgICogT3BlbiB0aGUgZ2l2ZW4gVVJMIGluIG1vYmlsZSBTYWZhcmkgYnJvd3Nlci5cbiAgICogVGhlIGJyb3dzZXIgd2lsbCBiZSBzdGFydGVkIGF1dG9tYXRpY2FsbHkgaWYgaXQgaXMgbm90IHJ1bm5pbmcuXG4gICAqIEBvdmVycmlkZVxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVGhlIFVSTCB0byBiZSBvcGVuZWQuXG4gICAqL1xuICBhc3luYyBvcGVuVXJsICh1cmwpIHtcbiAgICBpZiAoIWF3YWl0IHRoaXMuaXNSdW5uaW5nKCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVHJpZWQgdG8gb3BlbiAke3VybH0sIGJ1dCBTaW11bGF0b3IgaXMgbm90IGluIEJvb3RlZCBzdGF0ZWApO1xuICAgIH1cbiAgICBjb25zdCBsYXVuY2hUaW1lc3RhbXAgPSBwcm9jZXNzLmhydGltZSgpO1xuICAgIGxldCBsYXN0RXJyb3IgPSBudWxsO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAvLyBUaGlzIGlzIHRvIG1ha2Ugc3VyZSBTYWZhcmkgaXMgYWxyZWFkeSBydW5uaW5nXG4gICAgICAgICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCBleGVjKCd4Y3J1bicsIFsnc2ltY3RsJywgJ2xhdW5jaCcsIHRoaXMudWRpZCwgTU9CSUxFX1NBRkFSSV9CVU5ETEVfSURdKTtcbiAgICAgICAgICBpZiAoUFJPQ0VTU19MQVVOQ0hfT0tfUEFUVEVSTihNT0JJTEVfU0FGQVJJX0JVTkRMRV9JRCkudGVzdChzdGRvdXQpKSB7XG4gICAgICAgICAgICBhd2FpdCBzaW1jdGxPcGVuVXJsKHRoaXMudWRpZCwgdXJsKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgbG9nLmVycm9yKGBGYWlsZWQgdG8gb3BlbiAnJHt1cmx9JyBpbiBTYWZhcmkuIFJldHJ5aW5nLi4uYCk7XG4gICAgICAgICAgbGFzdEVycm9yID0gZXJyLnN0ZGVyciB8fCBlcnIubWVzc2FnZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9LCB7d2FpdE1zOiBTQUZBUklfU1RBUlRVUF9USU1FT1VULCBpbnRlcnZhbE1zOiA1MDB9KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBTYWZhcmkgY2Fubm90IG9wZW4gJyR7dXJsfScgYWZ0ZXIgJHtwcm9jZXNzLmhydGltZShsYXVuY2hUaW1lc3RhbXApWzBdfSBzZWNvbmRzIGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgYGJlY2F1c2Ugb2Y6ICR7bGFzdEVycm9yIHx8ICdhbiB1bmtub3duIGVycm9yJ31gKTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBTYWZhcmkgaGFzIHN1Y2Nlc3NmdWxseSBvcGVuZWQgJyR7dXJsfScgaW4gJHtwcm9jZXNzLmhydGltZShsYXVuY2hUaW1lc3RhbXApWzBdfSBzZWNvbmRzYCk7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYW4gdXAgdGhlIGRpcmVjdG9yaWVzIGZvciBtb2JpbGUgU2FmYXJpLlxuICAgKiBAb3ZlcnJpZGVcbiAgICpcbiAgICogQHBhcmFtIHtib29sZWFufSBrZWVwUHJlZnMgLSBXaGV0aGVyIHRvIGtlZXAgU2FmYXJpIHByZWZlcmVuY2VzIGZyb20gYmVpbmcgZGVsZXRlZC5cbiAgICovXG4gIGFzeW5jIGNsZWFuU2FmYXJpIChrZWVwUHJlZnMgPSB0cnVlKSB7XG4gICAgdHJ5IHtcbiAgICAgIGlmIChhd2FpdCB0aGlzLmlzUnVubmluZygpKSB7XG4gICAgICAgIGF3YWl0IHRlcm1pbmF0ZSh0aGlzLnVkaWQsIE1PQklMRV9TQUZBUklfQlVORExFX0lEKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChpZ24pIHtcbiAgICAgIC8vIGlnbm9yZSBlcnJvclxuICAgIH1cbiAgICBhd2FpdCBzdXBlci5jbGVhblNhZmFyaShrZWVwUHJlZnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFuL3NjcnViIHRoZSBwYXJ0aWN1bGFyIGFwcGxpY2F0aW9uIG9uIFNpbXVsYXRvci5cbiAgICogQG92ZXJyaWRlXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBhcHBGaWxlIC0gQXBwbGljYXRpb24gbmFtZSBtaW51cyBcIi5hcHBcIi5cbiAgICogQHBhcmFtIHtzdHJpbmd9IGFwcEJ1bmRsZUlkIC0gQnVuZGxlIGlkZW50aWZpZXIgb2YgdGhlIGFwcGxpY2F0aW9uLlxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IHNjcnViIC0gSWYgYHNjcnViYCBpcyBmYWxzZSwgd2Ugd2FudCB0byBjbGVhbiBieSBkZWxldGluZyB0aGUgYXBwIGFuZCBhbGxcbiAgICogICBmaWxlcyBhc3NvY2lhdGVkIHdpdGggaXQuIElmIGBzY3J1YmAgaXMgdHJ1ZSwgd2UganVzdCB3YW50IHRvIGRlbGV0ZSB0aGUgcHJlZmVyZW5jZXMgYW5kXG4gICAqICAgY2hhbmdlZCBmaWxlcy5cbiAgICovXG4gIGFzeW5jIGNsZWFuQ3VzdG9tQXBwIChhcHBGaWxlLCBhcHBCdW5kbGVJZCwgc2NydWIgPSBmYWxzZSkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0ZXJtaW5hdGUodGhpcy51ZGlkLCBhcHBCdW5kbGVJZCk7XG4gICAgfSBjYXRjaCAoaWduKSB7XG4gICAgICAvLyBpZ25vcmUgZXJyb3JcbiAgICB9XG4gICAgYXdhaXQgc3VwZXIuY2xlYW5DdXN0b21BcHAoYXBwRmlsZSwgYXBwQnVuZGxlSWQsIHNjcnViKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQZXJmb3JtIFNoYWtlIGdlc3R1cmUgb24gU2ltdWxhdG9yIHdpbmRvdy5cbiAgICovXG4gIGFzeW5jIHNoYWtlICgpIHtcbiAgICBsb2cuaW5mbyhgUGVyZm9ybWluZyBzaGFrZSBnZXN0dXJlIG9uICR7dGhpcy51ZGlkfSBTaW11bGF0b3JgKTtcbiAgICBhd2FpdCBzcGF3bih0aGlzLnVkaWQsIFtcbiAgICAgICdub3RpZnl1dGlsJyxcbiAgICAgICctcCcsICdjb20uYXBwbGUuVUlLaXQuU2ltdWxhdG9yU2hha2UnXG4gICAgXSk7XG4gIH1cblxuICAvKipcbiAgICogQGluaGVyaXRkb2NcbiAgICogQG92ZXJyaWRlXG4gICAqIEBwcml2YXRlXG4gICAqL1xuICBhc3luYyBfYWN0aXZhdGVXaW5kb3cgKCkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBmYnNpbWN0bC5mb2N1cyh0aGlzLnVkaWQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oYENhbm5vdCBmb2N1cyBTaW11bGF0b3Igd2luZG93IHdpdGggZmJzaW1jdGwuIERlZmF1bHRpbmcgdG8gQXBwbGVTY3JpcHQuIGAgK1xuICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICByZXR1cm4gYXdhaXQgc3VwZXIuX2FjdGl2YXRlV2luZG93KCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0ZG9jXG4gICAqIEBvdmVycmlkZVxuICAgKi9cbiAgYXN5bmMgaXNCaW9tZXRyaWNFbnJvbGxlZCAoKSB7XG4gICAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgdGhpcy5leGVjdXRlVUlDbGllbnRTY3JpcHQoYFxuICAgICAgdGVsbCBhcHBsaWNhdGlvbiBcIlN5c3RlbSBFdmVudHNcIlxuICAgICAgICB0ZWxsIHByb2Nlc3MgXCJTaW11bGF0b3JcIlxuICAgICAgICAgIHNldCBkc3RNZW51SXRlbSB0byBtZW51IGl0ZW0gXCJUb2dnbGUgRW5yb2xsZWQgU3RhdGVcIiBvZiBtZW51IDEgb2YgbWVudSBpdGVtIFwiVG91Y2ggSURcIiBvZiBtZW51IDEgb2YgbWVudSBiYXIgaXRlbSBcIkhhcmR3YXJlXCIgb2YgbWVudSBiYXIgMVxuICAgICAgICAgIHNldCBpc0NoZWNrZWQgdG8gKHZhbHVlIG9mIGF0dHJpYnV0ZSBcIkFYTWVudUl0ZW1NYXJrQ2hhclwiIG9mIGRzdE1lbnVJdGVtKSBpcyBcIuKck1wiXG4gICAgICAgIGVuZCB0ZWxsXG4gICAgICBlbmQgdGVsbFxuICAgIGApO1xuICAgIGxvZy5kZWJ1ZyhgVG91Y2ggSUQgZW5yb2xsZWQgc3RhdGU6ICR7b3V0cHV0fWApO1xuICAgIHJldHVybiBfLmlzU3RyaW5nKG91dHB1dCkgJiYgb3V0cHV0LnRyaW0oKSA9PT0gJ3RydWUnO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0ZG9jXG4gICAqIEBvdmVycmlkZVxuICAgKi9cbiAgYXN5bmMgZW5yb2xsQmlvbWV0cmljIChpc0VuYWJsZWQgPSB0cnVlKSB7XG4gICAgYXdhaXQgdGhpcy5leGVjdXRlVUlDbGllbnRTY3JpcHQoYFxuICAgICAgdGVsbCBhcHBsaWNhdGlvbiBcIlN5c3RlbSBFdmVudHNcIlxuICAgICAgICB0ZWxsIHByb2Nlc3MgXCJTaW11bGF0b3JcIlxuICAgICAgICAgIHNldCBkc3RNZW51SXRlbSB0byBtZW51IGl0ZW0gXCJUb2dnbGUgRW5yb2xsZWQgU3RhdGVcIiBvZiBtZW51IDEgb2YgbWVudSBpdGVtIFwiVG91Y2ggSURcIiBvZiBtZW51IDEgb2YgbWVudSBiYXIgaXRlbSBcIkhhcmR3YXJlXCIgb2YgbWVudSBiYXIgMVxuICAgICAgICAgIHNldCBpc0NoZWNrZWQgdG8gKHZhbHVlIG9mIGF0dHJpYnV0ZSBcIkFYTWVudUl0ZW1NYXJrQ2hhclwiIG9mIGRzdE1lbnVJdGVtKSBpcyBcIuKck1wiXG4gICAgICAgICAgaWYgJHtpc0VuYWJsZWQgPyAnbm90ICcgOiAnJ31pc0NoZWNrZWQgdGhlblxuICAgICAgICAgICAgY2xpY2sgZHN0TWVudUl0ZW1cbiAgICAgICAgICBlbmQgaWZcbiAgICAgICAgZW5kIHRlbGxcbiAgICAgIGVuZCB0ZWxsXG4gICAgYCk7XG4gIH1cblxuICAvKipcbiAgICogQGluaGVyaXRkb2NcbiAgICogQG92ZXJyaWRlXG4gICAqL1xuICBhc3luYyBzZW5kQmlvbWV0cmljTWF0Y2ggKHNob3VsZE1hdGNoID0gdHJ1ZSkge1xuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZVVJQ2xpZW50U2NyaXB0KGBcbiAgICAgIHRlbGwgYXBwbGljYXRpb24gXCJTeXN0ZW0gRXZlbnRzXCJcbiAgICAgICAgdGVsbCBwcm9jZXNzIFwiU2ltdWxhdG9yXCJcbiAgICAgICAgICBzZXQgZHN0TWVudUl0ZW0gdG8gbWVudSBpdGVtIFwiJHtzaG91bGRNYXRjaCA/ICdNYXRjaGluZyBUb3VjaCcgOiAnTm9uLW1hdGNoaW5nIFRvdWNoJ31cIiBvZiBtZW51IDEgb2YgbWVudSBpdGVtIFwiVG91Y2ggSURcIiBvZiBtZW51IDEgb2YgbWVudSBiYXIgaXRlbSBcIkhhcmR3YXJlXCIgb2YgbWVudSBiYXIgMVxuICAgICAgICAgIGNsaWNrIGRzdE1lbnVJdGVtXG4gICAgICAgIGVuZCB0ZWxsXG4gICAgICBlbmQgdGVsbFxuICAgIGApO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCBjdXN0b20gZ2VvbG9jYXRpb24gcGFyYW1ldGVycyBmb3IgdGhlIGdpdmVuIFNpbXVsYXRvciB1c2luZyBBcHBsZVNjcmlwdC5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBsYXRpdHVkZSAtIFRoZSBsYXRpdHVkZSB2YWx1ZSwgd2hpY2ggaXMgZ29pbmcgdG8gYmUgZW50ZXJlZFxuICAgKiAgIGludG8gdGhlIGNvcnJlc3BvbmRpbmcgZWRpdCBmaWVsZCwgZm9yIGV4YW1wbGUgJzM5LDAwMDYnLlxuICAgKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IGxvbmdpdHVkZSAtIFRoZSBsb25naXR1ZGUgdmFsdWUsIHdoaWNoIGlzIGdvaW5nIHRvIGJlIGVudGVyZWRcbiAgICogICBpbnRvIHRoZSBjb3JyZXNwb25kaW5nIGVkaXQgZmllbGQsIGZvciBleGFtcGxlICcxOSwwMDY4Jy5cbiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgdGhlIGdpdmVuIHBhcmFtZXRlcnMgaGF2ZSBjb3JyZWN0IGZvcm1hdCBhbmQgd2VyZSBzdWNjZXNzZnVsbHkgYWNjZXB0ZWQuXG4gICAqL1xuICBhc3luYyBzZXRHZW9sb2NhdGlvbiAobGF0aXR1ZGUsIGxvbmdpdHVkZSkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBmYnNpbWN0bC5zZXRHZW9Mb2NhdGlvbih0aGlzLnVkaWQsIGxhdGl0dWRlLCBsb25naXR1ZGUpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nLndhcm4oYENhbm5vdCBzZXQgZ2VvbG9jYXRpb24gd2l0aCBmYnNpbWN0bC4gRGVmYXVsdGluZyB0byBBcHBsZVNjcmlwdC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgdGhpcy5leGVjdXRlVUlDbGllbnRTY3JpcHQoYFxuICAgICAgICB0ZWxsIGFwcGxpY2F0aW9uIFwiU3lzdGVtIEV2ZW50c1wiXG4gICAgICAgICAgdGVsbCBwcm9jZXNzIFwiU2ltdWxhdG9yXCJcbiAgICAgICAgICAgIHNldCBmZWF0dXJlTmFtZSB0byBcIkN1c3RvbSBMb2NhdGlvblwiXG4gICAgICAgICAgICBzZXQgZHN0TWVudUl0ZW0gdG8gbWVudSBpdGVtIChmZWF0dXJlTmFtZSAmIFwi4oCmXCIpIG9mIG1lbnUgMSBvZiBtZW51IGl0ZW0gXCJMb2NhdGlvblwiIG9mIG1lbnUgMSBvZiBtZW51IGJhciBpdGVtIFwiRGVidWdcIiBvZiBtZW51IGJhciAxXG4gICAgICAgICAgICBjbGljayBkc3RNZW51SXRlbVxuICAgICAgICAgICAgZGVsYXkgMVxuICAgICAgICAgICAgc2V0IHZhbHVlIG9mIHRleHQgZmllbGQgMSBvZiB3aW5kb3cgZmVhdHVyZU5hbWUgdG8gXCIke2xhdGl0dWRlfVwiXG4gICAgICAgICAgICBkZWxheSAwLjVcbiAgICAgICAgICAgIHNldCB2YWx1ZSBvZiB0ZXh0IGZpZWxkIDIgb2Ygd2luZG93IGZlYXR1cmVOYW1lIHRvIFwiJHtsb25naXR1ZGV9XCJcbiAgICAgICAgICAgIGRlbGF5IDAuNVxuICAgICAgICAgICAgY2xpY2sgYnV0dG9uIFwiT0tcIiBvZiB3aW5kb3cgZmVhdHVyZU5hbWVcbiAgICAgICAgICAgIGRlbGF5IDAuNVxuICAgICAgICAgICAgc2V0IGlzSW52aXNpYmxlIHRvIChub3QgKGV4aXN0cyAod2luZG93IGZlYXR1cmVOYW1lKSkpXG4gICAgICAgICAgZW5kIHRlbGxcbiAgICAgICAgZW5kIHRlbGxcbiAgICAgIGApO1xuICAgICAgbG9nLmRlYnVnKGBHZW9sb2NhdGlvbiBwYXJhbWV0ZXJzIGRpYWxvZyBhY2NlcHRlZDogJHtvdXRwdXR9YCk7XG4gICAgICByZXR1cm4gXy5pc1N0cmluZyhvdXRwdXQpICYmIG91dHB1dC50cmltKCkgPT09ICd0cnVlJztcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgU2ltdWxhdG9yWGNvZGU4O1xuIl0sImZpbGUiOiJsaWIvc2ltdWxhdG9yLXhjb2RlLTguanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
