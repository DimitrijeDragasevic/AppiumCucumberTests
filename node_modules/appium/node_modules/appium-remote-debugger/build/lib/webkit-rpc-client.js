"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _remoteDebugger = require("./remote-debugger");

var _ws = _interopRequireDefault(require("ws"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _lodash = _interopRequireDefault(require("lodash"));

var _helpers = require("./helpers");

var _es6Error = _interopRequireDefault(require("es6-error"));

var _appiumSupport = require("appium-support");

var _rpcClient = _interopRequireDefault(require("./rpc-client"));

const DATA_LOG_LENGTH = {
  length: 200
};

class WebKitRpcClient extends _rpcClient.default {
  constructor(opts = {}) {
    super();
    const {
      host,
      port = _remoteDebugger.REMOTE_DEBUGGER_PORT,
      responseTimeout = _remoteDebugger.RPC_RESPONSE_TIMEOUT_MS,
      platformVersion = {},
      isSafari = true
    } = opts;
    this.host = host || 'localhost';
    this.port = port;
    this.responseTimeout = responseTimeout;
    this.platformVersion = platformVersion;
    this.isSafari = isSafari;
    this.curMsgId = 0;
    this.dataHandlers = {};
    this.dataMethods = {};
    this.errorHandlers = {};
    this.setCommunicationProtocol((0, _helpers.isTargetBased)(isSafari, platformVersion));
  }

  async connect(pageId) {
    return await new _bluebird.default((resolve, reject) => {
      const url = `ws://${this.host}:${this.port}/devtools/page/${pageId}`;
      this.pageIdKey = pageId;

      _logger.default.debug(`Connecting to WebKit socket: '${url}'`);

      this.socket = new _ws.default(url);
      this.socket.on('open', () => {
        _logger.default.debug(`WebKit debugger web socket connected to url: ${url}`);

        this.connected = true;
        resolve();
      });
      this.socket.on('close', () => {
        _logger.default.debug('WebKit remote debugger socket disconnected');

        this.connected = false;
      });
      this.socket.on('error', exception => {
        if (this.connected) {
          _logger.default.debug(`WebKit debugger web socket error: ${exception.message}`);

          this.connected = false;
        }

        reject(exception);
      });
      this.socket.on('message', this.receive.bind(this));
    });
  }

  disconnect() {
    _logger.default.debug('Disconnecting from WebKit remote debugger');

    if (this.isConnected()) {
      this.socket.close(1001);
    }

    this.connected = false;
  }

  isConnected() {
    return this.socket !== null && this.connected;
  }

  async sendMessage(command, opts) {
    let data = this.remoteMessages.getRemoteCommand(command, _lodash.default.defaults({
      connId: this.connId,
      senderId: this.senderId
    }, opts));

    _logger.default.debug(`Sending WebKit data: ${_lodash.default.truncate(JSON.stringify(data), DATA_LOG_LENGTH)}`);

    _logger.default.debug(`Webkit response timeout: ${this.responseTimeout}`);

    const msgId = this.curMsgId++;
    data.id = msgId;
    let method = data.method;

    if (this.isTargetBased) {
      method = data.params.message.method;
      data.params.id = msgId;
      data.params.message.id = msgId;
      data.params.message = JSON.stringify(data.params.message);
      data.params.targetId = 'page-1';
    }

    const id = msgId.toString();
    return await new _bluebird.default((resolve, reject) => {
      this.dataHandlers[id] = resolve;
      this.dataMethods[id] = method;
      this.errorHandlers[id] = reject;
      this.socket.send(JSON.stringify(data), function socketReceipt(error) {
        if (_appiumSupport.util.hasValue(error)) {
          _logger.default.debug(`WebKit socket error occurred: ${error}`);

          reject(new Error(error));
        }
      });
    }).catch(e => {
      if (e.constructor.name !== WebKitRPCWarning.name) {
        throw e;
      }

      _logger.default.warn(e.message);

      return _bluebird.default.resolve();
    }).finally(res => {
      delete this.dataHandlers[id];
      delete this.dataMethods[id];
      delete this.errorHandlers[id];
      return res;
    }).timeout(this.responseTimeout);
  }

  receive(data) {
    _logger.default.debug(`Received WebKit data: '${_lodash.default.truncate(data, DATA_LOG_LENGTH)}'`);

    data = _appiumSupport.util.safeJsonParse(data);

    const rejectCall = error => {
      if (data && this.errorHandlers[data.id]) {
        return this.errorHandlers[data.id](error);
      }

      if (error.constructor.name === WebKitRPCWarning.name) {
        _logger.default.warn(error.message);
      } else {
        _logger.default.errorAndThrow(error);
      }
    };

    if (!_lodash.default.isPlainObject(data)) {
      return rejectCall(new WebKitRPCWarning(`No parseable data found`));
    }

    if (data.wasThrown || data.result && data.result.wasThrown) {
      const message = data.wasThrown ? data.result.value || data.result.description : data.result.result.value || data.result.result.description;
      return rejectCall(new Error(message));
    }

    let {
      id: msgId,
      result,
      params,
      error
    } = data;
    let method = this.dataMethods[msgId] || data.method;

    if (this.isTargetBased) {
      if (!_lodash.default.startsWith(data.method, 'Target')) {
        _logger.default.debug(`Received receipt for message '${msgId}'`);

        return;
      }

      if (data.params.message) {
        let message;

        try {
          message = JSON.parse(data.params.message);
        } catch (err) {
          _logger.default.error(`Unable to parse message: ${err.message}`);

          _logger.default.error(`Data:`);

          _logger.default.error(`${JSON.stringify(data, null, 2)}`);
        }

        params = message.params || params;

        if (message.result) {
          result = message.result;

          if (message.result.result) {
            result = message.result.result;

            if (message.result.result.value) {
              result = message.result.result.value;

              if (_lodash.default.isString(result)) {
                try {
                  result = JSON.parse(result);
                } catch (ign) {}
              }
            }
          }
        }

        msgId = message.id;
        method = message.method || method;
      }
    }

    if (!method) {
      return rejectCall(new WebKitRPCWarning(`Did not find any handlers for ${msgId ? `'${msgId}'` : 'recent'} message`));
    }

    _logger.default.debug(`Found method '${method}' ${msgId ? `for message '${msgId}'` : ''}`);

    let isEventHandled = false;

    switch (method) {
      case 'Profiler.resetProfiles':
        _logger.default.debug('Device is telling us to reset profiles. Should probably ' + 'do some kind of callback here');

        isEventHandled = true;
        break;

      case 'Timeline.eventRecorded':
        if (this.timelineEventHandler) {
          this.timelineEventHandler(result);
          isEventHandled = true;
        }

        break;

      case 'Console.messagesCleared':
        isEventHandled = true;
        break;

      case 'Console.messageAdded':
        if (this.consoleEventHandler) {
          this.consoleEventHandler(params.message);
          isEventHandled = true;
        }

        break;

      case 'Page.navigate':
        _logger.default.debug(`Received page navigated message: ${(0, _helpers.simpleStringify)(data)}`);

        isEventHandled = true;
        break;

      case 'Network.dataReceived':
      case 'Network.requestWillBeSent':
      case 'Network.responseReceived':
      case 'Network.loadingFinished':
      case 'Network.loadingFailed':
        if (_lodash.default.isFunction(this.networkEventHandler)) {
          this.networkEventHandler(method, params);
          return;
        }

        break;

      case 'Target.targetCreated':
        _logger.default.debug(`Target created: ${JSON.stringify(params.targetInfo)}`);

        isEventHandled = true;
        break;
    }

    if (!data.error && _lodash.default.has(this.dataHandlers, msgId)) {
      return this.dataHandlers[msgId](result);
    }

    if (data.error && _lodash.default.has(this.errorHandlers, msgId)) {
      return this.errorHandlers[msgId](error);
    }

    if (!isEventHandled) {
      _logger.default.debug(`There is no handler scheduled for method '${method}' in ${msgId ? `message '${msgId}'` : 'recent messages'}`);
    }
  }

  setTimelineEventHandler(timelineEventHandler) {
    this.timelineEventHandler = timelineEventHandler;
  }

  setConsoleLogEventHandler(consoleEventHandler) {
    this.consoleEventHandler = consoleEventHandler;
  }

  setNetworkLogEventHandler(networkEventHandler) {
    this.networkEventHandler = networkEventHandler;
  }

}

exports.default = WebKitRpcClient;

class WebKitRPCWarning extends _es6Error.default {}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZWJraXQtcnBjLWNsaWVudC5qcyJdLCJuYW1lcyI6WyJEQVRBX0xPR19MRU5HVEgiLCJsZW5ndGgiLCJXZWJLaXRScGNDbGllbnQiLCJScGNDbGllbnQiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJob3N0IiwicG9ydCIsIlJFTU9URV9ERUJVR0dFUl9QT1JUIiwicmVzcG9uc2VUaW1lb3V0IiwiUlBDX1JFU1BPTlNFX1RJTUVPVVRfTVMiLCJwbGF0Zm9ybVZlcnNpb24iLCJpc1NhZmFyaSIsImN1ck1zZ0lkIiwiZGF0YUhhbmRsZXJzIiwiZGF0YU1ldGhvZHMiLCJlcnJvckhhbmRsZXJzIiwic2V0Q29tbXVuaWNhdGlvblByb3RvY29sIiwiY29ubmVjdCIsInBhZ2VJZCIsIkIiLCJyZXNvbHZlIiwicmVqZWN0IiwidXJsIiwicGFnZUlkS2V5IiwibG9nIiwiZGVidWciLCJzb2NrZXQiLCJXZWJTb2NrZXQiLCJvbiIsImNvbm5lY3RlZCIsImV4Y2VwdGlvbiIsIm1lc3NhZ2UiLCJyZWNlaXZlIiwiYmluZCIsImRpc2Nvbm5lY3QiLCJpc0Nvbm5lY3RlZCIsImNsb3NlIiwic2VuZE1lc3NhZ2UiLCJjb21tYW5kIiwiZGF0YSIsInJlbW90ZU1lc3NhZ2VzIiwiZ2V0UmVtb3RlQ29tbWFuZCIsIl8iLCJkZWZhdWx0cyIsImNvbm5JZCIsInNlbmRlcklkIiwidHJ1bmNhdGUiLCJKU09OIiwic3RyaW5naWZ5IiwibXNnSWQiLCJpZCIsIm1ldGhvZCIsImlzVGFyZ2V0QmFzZWQiLCJwYXJhbXMiLCJ0YXJnZXRJZCIsInRvU3RyaW5nIiwic2VuZCIsInNvY2tldFJlY2VpcHQiLCJlcnJvciIsInV0aWwiLCJoYXNWYWx1ZSIsIkVycm9yIiwiY2F0Y2giLCJlIiwibmFtZSIsIldlYktpdFJQQ1dhcm5pbmciLCJ3YXJuIiwiZmluYWxseSIsInJlcyIsInRpbWVvdXQiLCJzYWZlSnNvblBhcnNlIiwicmVqZWN0Q2FsbCIsImVycm9yQW5kVGhyb3ciLCJpc1BsYWluT2JqZWN0Iiwid2FzVGhyb3duIiwicmVzdWx0IiwidmFsdWUiLCJkZXNjcmlwdGlvbiIsInN0YXJ0c1dpdGgiLCJwYXJzZSIsImVyciIsImlzU3RyaW5nIiwiaWduIiwiaXNFdmVudEhhbmRsZWQiLCJ0aW1lbGluZUV2ZW50SGFuZGxlciIsImNvbnNvbGVFdmVudEhhbmRsZXIiLCJpc0Z1bmN0aW9uIiwibmV0d29ya0V2ZW50SGFuZGxlciIsInRhcmdldEluZm8iLCJoYXMiLCJzZXRUaW1lbGluZUV2ZW50SGFuZGxlciIsInNldENvbnNvbGVMb2dFdmVudEhhbmRsZXIiLCJzZXROZXR3b3JrTG9nRXZlbnRIYW5kbGVyIiwiRVM2RXJyb3IiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsZUFBZSxHQUFHO0FBQUNDLEVBQUFBLE1BQU0sRUFBRTtBQUFULENBQXhCOztBQUVlLE1BQU1DLGVBQU4sU0FBOEJDLGtCQUE5QixDQUF3QztBQUNyREMsRUFBQUEsV0FBVyxDQUFFQyxJQUFJLEdBQUcsRUFBVCxFQUFhO0FBQ3RCO0FBRUEsVUFBTTtBQUNKQyxNQUFBQSxJQURJO0FBRUpDLE1BQUFBLElBQUksR0FBR0Msb0NBRkg7QUFHSkMsTUFBQUEsZUFBZSxHQUFHQyx1Q0FIZDtBQUlKQyxNQUFBQSxlQUFlLEdBQUcsRUFKZDtBQUtKQyxNQUFBQSxRQUFRLEdBQUc7QUFMUCxRQU1GUCxJQU5KO0FBUUEsU0FBS0MsSUFBTCxHQUFZQSxJQUFJLElBQUksV0FBcEI7QUFDQSxTQUFLQyxJQUFMLEdBQVlBLElBQVo7QUFFQSxTQUFLRSxlQUFMLEdBQXVCQSxlQUF2QjtBQUVBLFNBQUtFLGVBQUwsR0FBdUJBLGVBQXZCO0FBQ0EsU0FBS0MsUUFBTCxHQUFnQkEsUUFBaEI7QUFFQSxTQUFLQyxRQUFMLEdBQWdCLENBQWhCO0FBRUEsU0FBS0MsWUFBTCxHQUFvQixFQUFwQjtBQUNBLFNBQUtDLFdBQUwsR0FB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Ozs7QUFzUnZELE1BQU10QixnQkFBTixTQUErQjRCLGlCQUEvQixDQUF3QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgUkVNT1RFX0RFQlVHR0VSX1BPUlQsIFJQQ19SRVNQT05TRV9USU1FT1VUX01TIH0gZnJvbSAnLi9yZW1vdGUtZGVidWdnZXInO1xuaW1wb3J0IFdlYlNvY2tldCBmcm9tICd3cyc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgc2ltcGxlU3RyaW5naWZ5LCBpc1RhcmdldEJhc2VkIH0gZnJvbSAnLi9oZWxwZXJzJztcbmltcG9ydCBFUzZFcnJvciBmcm9tICdlczYtZXJyb3InO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBScGNDbGllbnQgZnJvbSAnLi9ycGMtY2xpZW50JztcblxuXG5jb25zdCBEQVRBX0xPR19MRU5HVEggPSB7bGVuZ3RoOiAyMDB9O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXZWJLaXRScGNDbGllbnQgZXh0ZW5kcyBScGNDbGllbnQge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgc3VwZXIoKTtcblxuICAgIGNvbnN0IHtcbiAgICAgIGhvc3QsXG4gICAgICBwb3J0ID0gUkVNT1RFX0RFQlVHR0VSX1BPUlQsXG4gICAgICByZXNwb25zZVRpbWVvdXQgPSBSUENfUkVTUE9OU0VfVElNRU9VVF9NUyxcbiAgICAgIHBsYXRmb3JtVmVyc2lvbiA9IHt9LFxuICAgICAgaXNTYWZhcmkgPSB0cnVlLFxuICAgIH0gPSBvcHRzO1xuXG4gICAgdGhpcy5ob3N0ID0gaG9zdCB8fCAnbG9jYWxob3N0JztcbiAgICB0aGlzLnBvcnQgPSBwb3J0O1xuXG4gICAgdGhpcy5yZXNwb25zZVRpbWVvdXQgPSByZXNwb25zZVRpbWVvdXQ7XG5cbiAgICB0aGlzLnBsYXRmb3JtVmVyc2lvbiA9IHBsYXRmb3JtVmVyc2lvbjtcbiAgICB0aGlzLmlzU2FmYXJpID0gaXNTYWZhcmk7XG5cbiAgICB0aGlzLmN1ck1zZ0lkID0gMDtcblxuICAgIHRoaXMuZGF0YUhhbmRsZXJzID0ge307XG4gICAgdGhpcy5kYXRhTWV0aG9kcyA9IHt9O1xuICAgIHRoaXMuZXJyb3JIYW5kbGVycyA9IHt9O1xuXG4gICAgLy8gc3RhcnQgd2l0aCBhIGJlc3QgZ3Vlc3MgZm9yIHRoZSBwcm90b2NvbFxuICAgIHRoaXMuc2V0Q29tbXVuaWNhdGlvblByb3RvY29sKGlzVGFyZ2V0QmFzZWQoaXNTYWZhcmksIHBsYXRmb3JtVmVyc2lvbikpO1xuICB9XG5cbiAgYXN5bmMgY29ubmVjdCAocGFnZUlkKSB7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIC8vIHdlIHdpbGwgb25seSByZXNvbHZlIHRoaXMgY2FsbCB3aGVuIHRoZSBzb2NrZXQgaXMgb3BlblxuICAgICAgLy8gV2ViS2l0IHVybFxuICAgICAgY29uc3QgdXJsID0gYHdzOi8vJHt0aGlzLmhvc3R9OiR7dGhpcy5wb3J0fS9kZXZ0b29scy9wYWdlLyR7cGFnZUlkfWA7XG4gICAgICB0aGlzLnBhZ2VJZEtleSA9IHBhZ2VJZDtcblxuICAgICAgLy8gY3JlYXRlIGFuZCBzZXQgdXAgc29ja2V0IHdpdGggYXBwcm9wcmlhdGUgZXZlbnQgaGFuZGxlcnNcbiAgICAgIGxvZy5kZWJ1ZyhgQ29ubmVjdGluZyB0byBXZWJLaXQgc29ja2V0OiAnJHt1cmx9J2ApO1xuICAgICAgdGhpcy5zb2NrZXQgPSBuZXcgV2ViU29ja2V0KHVybCk7XG4gICAgICB0aGlzLnNvY2tldC5vbignb3BlbicsICgpID0+IHtcbiAgICAgICAgbG9nLmRlYnVnKGBXZWJLaXQgZGVidWdnZXIgd2ViIHNvY2tldCBjb25uZWN0ZWQgdG8gdXJsOiAke3VybH1gKTtcbiAgICAgICAgdGhpcy5jb25uZWN0ZWQgPSB0cnVlO1xuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdjbG9zZScsICgpID0+IHtcbiAgICAgICAgbG9nLmRlYnVnKCdXZWJLaXQgcmVtb3RlIGRlYnVnZ2VyIHNvY2tldCBkaXNjb25uZWN0ZWQnKTtcbiAgICAgICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5zb2NrZXQub24oJ2Vycm9yJywgKGV4Y2VwdGlvbikgPT4ge1xuICAgICAgICBpZiAodGhpcy5jb25uZWN0ZWQpIHtcbiAgICAgICAgICBsb2cuZGVidWcoYFdlYktpdCBkZWJ1Z2dlciB3ZWIgc29ja2V0IGVycm9yOiAke2V4Y2VwdGlvbi5tZXNzYWdlfWApO1xuICAgICAgICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICByZWplY3QoZXhjZXB0aW9uKTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5zb2NrZXQub24oJ21lc3NhZ2UnLCB0aGlzLnJlY2VpdmUuYmluZCh0aGlzKSk7XG4gICAgfSk7XG4gIH1cblxuICBkaXNjb25uZWN0ICgpIHtcbiAgICBsb2cuZGVidWcoJ0Rpc2Nvbm5lY3RpbmcgZnJvbSBXZWJLaXQgcmVtb3RlIGRlYnVnZ2VyJyk7XG4gICAgaWYgKHRoaXMuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgdGhpcy5zb2NrZXQuY2xvc2UoMTAwMSk7XG4gICAgfVxuICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2U7XG4gIH1cblxuICBpc0Nvbm5lY3RlZCAoKSB7XG4gICAgcmV0dXJuICh0aGlzLnNvY2tldCAhPT0gbnVsbCAmJiB0aGlzLmNvbm5lY3RlZCk7XG4gIH1cblxuICBhc3luYyBzZW5kTWVzc2FnZSAoY29tbWFuZCwgb3B0cykge1xuICAgIGxldCBkYXRhID0gdGhpcy5yZW1vdGVNZXNzYWdlcy5nZXRSZW1vdGVDb21tYW5kKGNvbW1hbmQsIF8uZGVmYXVsdHMoe2Nvbm5JZDogdGhpcy5jb25uSWQsIHNlbmRlcklkOiB0aGlzLnNlbmRlcklkfSwgb3B0cykpO1xuXG4gICAgbG9nLmRlYnVnKGBTZW5kaW5nIFdlYktpdCBkYXRhOiAke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkoZGF0YSksIERBVEFfTE9HX0xFTkdUSCl9YCk7XG4gICAgbG9nLmRlYnVnKGBXZWJraXQgcmVzcG9uc2UgdGltZW91dDogJHt0aGlzLnJlc3BvbnNlVGltZW91dH1gKTtcblxuICAgIGNvbnN0IG1zZ0lkID0gdGhpcy5jdXJNc2dJZCsrO1xuICAgIGRhdGEuaWQgPSBtc2dJZDtcblxuICAgIGxldCBtZXRob2QgPSBkYXRhLm1ldGhvZDtcbiAgICBpZiAodGhpcy5pc1RhcmdldEJhc2VkKSB7XG4gICAgICBtZXRob2QgPSBkYXRhLnBhcmFtcy5tZXNzYWdlLm1ldGhvZDtcblxuICAgICAgZGF0YS5wYXJhbXMuaWQgPSBtc2dJZDtcbiAgICAgIGRhdGEucGFyYW1zLm1lc3NhZ2UuaWQgPSBtc2dJZDtcbiAgICAgIGRhdGEucGFyYW1zLm1lc3NhZ2UgPSBKU09OLnN0cmluZ2lmeShkYXRhLnBhcmFtcy5tZXNzYWdlKTtcbiAgICAgIGRhdGEucGFyYW1zLnRhcmdldElkID0gJ3BhZ2UtMSc7XG4gICAgfVxuXG4gICAgY29uc3QgaWQgPSBtc2dJZC50b1N0cmluZygpO1xuICAgIHJldHVybiBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAvLyBvbmx5IHJlc29sdmUgdGhlIHNlbmQgY29tbWFuZCB3aGVuIFdlYktpdCByZXR1cm5zIGEgcmVzcG9uc2VcbiAgICAgIC8vIHN0b3JlIHRoZSBoYW5kbGVyIGFuZCB0aGUgZGF0YSBzZW50XG4gICAgICB0aGlzLmRhdGFIYW5kbGVyc1tpZF0gPSByZXNvbHZlO1xuICAgICAgdGhpcy5kYXRhTWV0aG9kc1tpZF0gPSBtZXRob2Q7XG4gICAgICB0aGlzLmVycm9ySGFuZGxlcnNbaWRdID0gcmVqZWN0O1xuXG4gICAgICAvLyBzZW5kIHRoZSBkYXRhXG4gICAgICB0aGlzLnNvY2tldC5zZW5kKEpTT04uc3RyaW5naWZ5KGRhdGEpLCBmdW5jdGlvbiBzb2NrZXRSZWNlaXB0IChlcnJvcikge1xuICAgICAgICBpZiAodXRpbC5oYXNWYWx1ZShlcnJvcikpIHtcbiAgICAgICAgICBsb2cuZGVidWcoYFdlYktpdCBzb2NrZXQgZXJyb3Igb2NjdXJyZWQ6ICR7ZXJyb3J9YCk7XG4gICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihlcnJvcikpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KS5jYXRjaCgoZSkgPT4ge1xuICAgICAgaWYgKGUuY29uc3RydWN0b3IubmFtZSAhPT0gV2ViS2l0UlBDV2FybmluZy5uYW1lKSB7XG4gICAgICAgIHRocm93IGU7XG4gICAgICB9XG4gICAgICBsb2cud2FybihlLm1lc3NhZ2UpO1xuICAgICAgcmV0dXJuIEIucmVzb2x2ZSgpO1xuICAgIH0pLmZpbmFsbHkoKHJlcykgPT4ge1xuICAgICAgLy8gbm8gbmVlZCB0byBob2xkIG9udG8gYW55dGhpbmdcbiAgICAgIGRlbGV0ZSB0aGlzLmRhdGFIYW5kbGVyc1tpZF07XG4gICAgICBkZWxldGUgdGhpcy5kYXRhTWV0aG9kc1tpZF07XG4gICAgICBkZWxldGUgdGhpcy5lcnJvckhhbmRsZXJzW2lkXTtcblxuICAgICAgLy8gYW5kIHBhc3MgYWxvbmcgdGhlIHJlc3VsdFxuICAgICAgcmV0dXJuIHJlcztcbiAgICB9KS50aW1lb3V0KHRoaXMucmVzcG9uc2VUaW1lb3V0KTtcbiAgfVxuXG4gIHJlY2VpdmUgKGRhdGEpIHtcbiAgICBsb2cuZGVidWcoYFJlY2VpdmVkIFdlYktpdCBkYXRhOiAnJHtfLnRydW5jYXRlKGRhdGEsIERBVEFfTE9HX0xFTkdUSCl9J2ApO1xuICAgIGRhdGEgPSB1dGlsLnNhZmVKc29uUGFyc2UoZGF0YSk7XG5cbiAgICBjb25zdCByZWplY3RDYWxsID0gKGVycm9yKSA9PiB7XG4gICAgICBpZiAoZGF0YSAmJiB0aGlzLmVycm9ySGFuZGxlcnNbZGF0YS5pZF0pIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZXJyb3JIYW5kbGVyc1tkYXRhLmlkXShlcnJvcik7XG4gICAgICB9XG5cbiAgICAgIGlmIChlcnJvci5jb25zdHJ1Y3Rvci5uYW1lID09PSBXZWJLaXRSUENXYXJuaW5nLm5hbWUpIHtcbiAgICAgICAgbG9nLndhcm4oZXJyb3IubWVzc2FnZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cuZXJyb3JBbmRUaHJvdyhlcnJvcik7XG4gICAgICB9XG4gICAgfTtcblxuICAgIGlmICghXy5pc1BsYWluT2JqZWN0KGRhdGEpKSB7XG4gICAgICByZXR1cm4gcmVqZWN0Q2FsbChuZXcgV2ViS2l0UlBDV2FybmluZyhgTm8gcGFyc2VhYmxlIGRhdGEgZm91bmRgKSk7XG4gICAgfVxuXG4gICAgLy8gd2UgY2FuIGdldCBhbiBlcnJvciwgb3Igd2UgY2FuIGdldCBhIHJlc3BvbnNlIHRoYXQgaXMgYW4gZXJyb3JcbiAgICBpZiAoZGF0YS53YXNUaHJvd24gfHwgKGRhdGEucmVzdWx0ICYmIGRhdGEucmVzdWx0Lndhc1Rocm93bikpIHtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBkYXRhLndhc1Rocm93blxuICAgICAgICA/IGRhdGEucmVzdWx0LnZhbHVlIHx8IGRhdGEucmVzdWx0LmRlc2NyaXB0aW9uXG4gICAgICAgIDogZGF0YS5yZXN1bHQucmVzdWx0LnZhbHVlIHx8IGRhdGEucmVzdWx0LnJlc3VsdC5kZXNjcmlwdGlvbjtcbiAgICAgIHJldHVybiByZWplY3RDYWxsKG5ldyBFcnJvcihtZXNzYWdlKSk7XG4gICAgfVxuXG4gICAgbGV0IHtcbiAgICAgIGlkOiBtc2dJZCxcbiAgICAgIHJlc3VsdCxcbiAgICAgIHBhcmFtcyxcbiAgICAgIGVycm9yLFxuICAgIH0gPSBkYXRhO1xuXG4gICAgbGV0IG1ldGhvZCA9IHRoaXMuZGF0YU1ldGhvZHNbbXNnSWRdIHx8IGRhdGEubWV0aG9kO1xuICAgIGlmICh0aGlzLmlzVGFyZ2V0QmFzZWQpIHtcbiAgICAgIGlmICghXy5zdGFydHNXaXRoKGRhdGEubWV0aG9kLCAnVGFyZ2V0JykpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBSZWNlaXZlZCByZWNlaXB0IGZvciBtZXNzYWdlICcke21zZ0lkfSdgKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgaWYgKGRhdGEucGFyYW1zLm1lc3NhZ2UpIHtcbiAgICAgICAgbGV0IG1lc3NhZ2U7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgbWVzc2FnZSA9IEpTT04ucGFyc2UoZGF0YS5wYXJhbXMubWVzc2FnZSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIC8vIHRoaXMgc2hvdWxkIG5ldmVyIGhhcHBlbiwgc28gbG9nIGFzIG11Y2ggaW5mb3JtYXRpb24gYXMgcG9zc2libGVcbiAgICAgICAgICAvLyBzaW5jZSB3ZSBuZWVkIHRvIGFjY29tb2RhdGUgc29tZXRoaW5nIHdlIGhhdmUgbm90IHNlZW5cbiAgICAgICAgICBsb2cuZXJyb3IoYFVuYWJsZSB0byBwYXJzZSBtZXNzYWdlOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgICAgIGxvZy5lcnJvcihgRGF0YTpgKTtcbiAgICAgICAgICBsb2cuZXJyb3IoYCR7SlNPTi5zdHJpbmdpZnkoZGF0YSwgbnVsbCwgMil9YCk7XG4gICAgICAgICAgLy8gY29udGludWUuIG1heWJlIHNvbWV0aGluZyBjYW4gYmUgc2FsdmFnZWQ/XG4gICAgICAgIH1cblxuICAgICAgICAvLyBnZXQgbmVzdGVkIHBhcmFtcyBpZiBuZWNlc3NhcnlcbiAgICAgICAgcGFyYW1zID0gbWVzc2FnZS5wYXJhbXMgfHwgcGFyYW1zO1xuXG4gICAgICAgIC8vIHRoZSBtZXNzYWdlIGlzIGFnZ3JhdmF0aW5nbHkgbmVzdGVkXG4gICAgICAgIGlmIChtZXNzYWdlLnJlc3VsdCkge1xuICAgICAgICAgIHJlc3VsdCA9IG1lc3NhZ2UucmVzdWx0O1xuICAgICAgICAgIGlmIChtZXNzYWdlLnJlc3VsdC5yZXN1bHQpIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IG1lc3NhZ2UucmVzdWx0LnJlc3VsdDtcbiAgICAgICAgICAgIGlmIChtZXNzYWdlLnJlc3VsdC5yZXN1bHQudmFsdWUpIHtcbiAgICAgICAgICAgICAgcmVzdWx0ID0gbWVzc2FnZS5yZXN1bHQucmVzdWx0LnZhbHVlO1xuICAgICAgICAgICAgICAvLyBvbmx5IGF0IHRoaXMgbGV2ZWwgaXMgcGFyc2luZyB0aGUgcmVzdWx0IG5lY2Vzc2FyeVxuICAgICAgICAgICAgICBpZiAoXy5pc1N0cmluZyhyZXN1bHQpKSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IEpTT04ucGFyc2UocmVzdWx0KTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBtc2dJZCA9IG1lc3NhZ2UuaWQ7XG4gICAgICAgIG1ldGhvZCA9IG1lc3NhZ2UubWV0aG9kIHx8IG1ldGhvZDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyB3aGVuIHNlbmRpbmcgd2Ugc2V0IGEgZGF0YSBtZXRob2QgYW5kIGFzc29jaWF0ZWQgY2FsbGJhY2suXG4gICAgLy8gZ2V0IHRoYXQsIG9yIHRoZSBnZW5lcmljIChhdXRvbWF0aWNhbGx5IHNlbnQsIG5vdCBhc3NvY2lhdGVkXG4gICAgLy8gd2l0aCBhIHBhcnRpY3VsYXIgcmVxdWVzdCkgbWV0aG9kXG4gICAgaWYgKCFtZXRob2QpIHtcbiAgICAgIHJldHVybiByZWplY3RDYWxsKFxuICAgICAgICBuZXcgV2ViS2l0UlBDV2FybmluZyhgRGlkIG5vdCBmaW5kIGFueSBoYW5kbGVycyBmb3IgJHttc2dJZCA/IGAnJHttc2dJZH0nYCA6ICdyZWNlbnQnfSBtZXNzYWdlYCkpO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYEZvdW5kIG1ldGhvZCAnJHttZXRob2R9JyAke21zZ0lkID8gYGZvciBtZXNzYWdlICcke21zZ0lkfSdgIDogJyd9YCk7XG4gICAgbGV0IGlzRXZlbnRIYW5kbGVkID0gZmFsc2U7XG4gICAgc3dpdGNoIChtZXRob2QpIHtcbiAgICAgIGNhc2UgJ1Byb2ZpbGVyLnJlc2V0UHJvZmlsZXMnOlxuICAgICAgICBsb2cuZGVidWcoJ0RldmljZSBpcyB0ZWxsaW5nIHVzIHRvIHJlc2V0IHByb2ZpbGVzLiBTaG91bGQgcHJvYmFibHkgJyArXG4gICAgICAgICAgICAgICAgICAnZG8gc29tZSBraW5kIG9mIGNhbGxiYWNrIGhlcmUnKTtcbiAgICAgICAgaXNFdmVudEhhbmRsZWQgPSB0cnVlO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ1RpbWVsaW5lLmV2ZW50UmVjb3JkZWQnOlxuICAgICAgICBpZiAodGhpcy50aW1lbGluZUV2ZW50SGFuZGxlcikge1xuICAgICAgICAgIHRoaXMudGltZWxpbmVFdmVudEhhbmRsZXIocmVzdWx0KTtcbiAgICAgICAgICBpc0V2ZW50SGFuZGxlZCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdDb25zb2xlLm1lc3NhZ2VzQ2xlYXJlZCc6XG4gICAgICAgIC8vIHBhc3NcbiAgICAgICAgaXNFdmVudEhhbmRsZWQgPSB0cnVlO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ0NvbnNvbGUubWVzc2FnZUFkZGVkJzpcbiAgICAgICAgaWYgKHRoaXMuY29uc29sZUV2ZW50SGFuZGxlcikge1xuICAgICAgICAgIHRoaXMuY29uc29sZUV2ZW50SGFuZGxlcihwYXJhbXMubWVzc2FnZSk7XG4gICAgICAgICAgaXNFdmVudEhhbmRsZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnUGFnZS5uYXZpZ2F0ZSc6XG4gICAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgcGFnZSBuYXZpZ2F0ZWQgbWVzc2FnZTogJHtzaW1wbGVTdHJpbmdpZnkoZGF0YSl9YCk7XG4gICAgICAgIGlzRXZlbnRIYW5kbGVkID0gdHJ1ZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdOZXR3b3JrLmRhdGFSZWNlaXZlZCc6XG4gICAgICBjYXNlICdOZXR3b3JrLnJlcXVlc3RXaWxsQmVTZW50JzpcbiAgICAgIGNhc2UgJ05ldHdvcmsucmVzcG9uc2VSZWNlaXZlZCc6XG4gICAgICBjYXNlICdOZXR3b3JrLmxvYWRpbmdGaW5pc2hlZCc6XG4gICAgICBjYXNlICdOZXR3b3JrLmxvYWRpbmdGYWlsZWQnOlxuICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMubmV0d29ya0V2ZW50SGFuZGxlcikpIHtcbiAgICAgICAgICB0aGlzLm5ldHdvcmtFdmVudEhhbmRsZXIobWV0aG9kLCBwYXJhbXMpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ1RhcmdldC50YXJnZXRDcmVhdGVkJzpcbiAgICAgICAgbG9nLmRlYnVnKGBUYXJnZXQgY3JlYXRlZDogJHtKU09OLnN0cmluZ2lmeShwYXJhbXMudGFyZ2V0SW5mbyl9YCk7XG4gICAgICAgIGlzRXZlbnRIYW5kbGVkID0gdHJ1ZTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGlmICghZGF0YS5lcnJvciAmJiBfLmhhcyh0aGlzLmRhdGFIYW5kbGVycywgbXNnSWQpKSB7XG4gICAgICByZXR1cm4gdGhpcy5kYXRhSGFuZGxlcnNbbXNnSWRdKHJlc3VsdCk7XG4gICAgfVxuICAgIGlmIChkYXRhLmVycm9yICYmIF8uaGFzKHRoaXMuZXJyb3JIYW5kbGVycywgbXNnSWQpKSB7XG4gICAgICByZXR1cm4gdGhpcy5lcnJvckhhbmRsZXJzW21zZ0lkXShlcnJvcik7XG4gICAgfVxuICAgIGlmICghaXNFdmVudEhhbmRsZWQpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgVGhlcmUgaXMgbm8gaGFuZGxlciBzY2hlZHVsZWQgZm9yIG1ldGhvZCAnJHttZXRob2R9JyBpbiAke21zZ0lkID8gYG1lc3NhZ2UgJyR7bXNnSWR9J2AgOiAncmVjZW50IG1lc3NhZ2VzJ31gKTtcbiAgICB9XG4gIH1cblxuICBzZXRUaW1lbGluZUV2ZW50SGFuZGxlciAodGltZWxpbmVFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLnRpbWVsaW5lRXZlbnRIYW5kbGVyID0gdGltZWxpbmVFdmVudEhhbmRsZXI7XG4gIH1cblxuICBzZXRDb25zb2xlTG9nRXZlbnRIYW5kbGVyIChjb25zb2xlRXZlbnRIYW5kbGVyKSB7XG4gICAgdGhpcy5jb25zb2xlRXZlbnRIYW5kbGVyID0gY29uc29sZUV2ZW50SGFuZGxlcjtcbiAgfVxuXG4gIHNldE5ldHdvcmtMb2dFdmVudEhhbmRsZXIgKG5ldHdvcmtFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLm5ldHdvcmtFdmVudEhhbmRsZXIgPSBuZXR3b3JrRXZlbnRIYW5kbGVyO1xuICB9XG59XG5cblxuY2xhc3MgV2ViS2l0UlBDV2FybmluZyBleHRlbmRzIEVTNkVycm9yIHt9XG4iXSwiZmlsZSI6ImxpYi93ZWJraXQtcnBjLWNsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
