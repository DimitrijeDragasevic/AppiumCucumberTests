"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _bplistCreator = _interopRequireDefault(require("bplist-creator"));

var _bplistParser = _interopRequireDefault(require("bplist-parser"));

var _bufferpack = _interopRequireDefault(require("bufferpack"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _remoteDebugger = require("./remote-debugger");

var _uuidJs = _interopRequireDefault(require("uuid-js"));

var _net = _interopRequireDefault(require("net"));

var _remoteDebuggerMessageHandler = _interopRequireDefault(require("./remote-debugger-message-handler"));

var _helpers = require("./helpers");

var _rpcClient = _interopRequireDefault(require("./rpc-client"));

class RemoteDebuggerRpcClient extends _rpcClient.default {
  constructor(opts = {}) {
    super();
    const {
      platformVersion = {},
      isSafari = true,
      host = '::1',
      port = _remoteDebugger.REMOTE_DEBUGGER_PORT,
      socketPath,
      specialMessageHandlers = {},
      messageProxy
    } = opts;
    this.host = host;
    this.port = port;
    this.socketPath = socketPath;
    this.messageProxy = messageProxy;
    this.socket = null;
    this.connected = false;
    this.connId = _uuidJs.default.create().toString();
    this.senderId = _uuidJs.default.create().toString();
    this.msgId = 0;
    this.received = Buffer.alloc(0);
    this.readPos = 0;
    this.specialMessageHandlers = specialMessageHandlers;
    this.setCommunicationProtocol((0, _helpers.isTargetBased)(isSafari, platformVersion));
  }

  setCommunicationProtocol(isTargetBased = false) {
    super.setCommunicationProtocol(isTargetBased);

    if (!this.messageHandler) {
      this.messageHandler = new _remoteDebuggerMessageHandler.default(this.specialMessageHandlers, isTargetBased);
    } else {
      this.messageHandler.setCommunicationProtocol(isTargetBased);
    }
  }

  async connect() {
    if (this.socketPath) {
      if (this.messageProxy) {
        _logger.default.debug(`Connecting to remote debugger via proxy through unix domain socket: '${this.messageProxy}'`);

        this.socket = _net.default.connect(this.messageProxy);
        this.socket.once('connect', () => {
          _logger.default.debug(`Forwarding the actual web inspector socket to the proxy: '${this.socketPath}'`);

          this.socket.write(JSON.stringify({
            socketPath: this.socketPath
          }));
        });
      } else {
        _logger.default.debug(`Connecting to remote debugger through unix domain socket: '${this.socketPath}'`);

        this.socket = _net.default.connect(this.socketPath);
      }
    } else {
      if (this.messageProxy) {
        this.port = this.messageProxy;
      }

      _logger.default.debug(`Connecting to remote debugger ${this.messageProxy ? 'via proxy ' : ''}through TCP: ${this.host}:${this.port}`);

      this.socket = new _net.default.Socket({
        type: 'tcp6'
      });
      this.socket.connect(this.port, this.host);
    }

    this.socket.setNoDelay(true);
    this.socket.on('close', () => {
      if (this.connected) {
        _logger.default.debug('Debugger socket disconnected');
      }

      this.connected = false;
      this.socket = null;
    });
    this.socket.on('end', () => {
      this.connected = false;
    });
    this.socket.on('data', this.receive.bind(this));
    return await new _bluebird.default((resolve, reject) => {
      this.socket.on('connect', () => {
        _logger.default.debug(`Debugger socket connected`);

        this.connected = true;
        resolve();
      });
      this.socket.on('error', err => {
        if (this.connected) {
          _logger.default.error(`Socket error: ${err.message}`);

          this.connected = false;
        }

        reject(err);
      });
    });
  }

  async disconnect() {
    if (this.isConnected()) {
      _logger.default.debug('Disconnecting from remote debugger');

      this.socket.destroy();
    }

    this.connected = false;
  }

  isConnected() {
    return this.connected;
  }

  setSpecialMessageHandler(key, errorHandler, handler) {
    this.messageHandler.setSpecialMessageHandler(key, errorHandler, handler);
  }

  getSpecialMessageHandler(key) {
    return this.messageHandler.getSpecialMessageHandler(key);
  }

  setDataMessageHandler(key, errorHandler, handler) {
    this.messageHandler.setDataMessageHandler(key, errorHandler, handler);
  }

  allowNavigationWithoutReload(allow = true) {
    this.messageHandler.allowNavigationWithoutReload(allow);
  }

  async selectApp(appIdKey, applicationConnectedHandler) {
    return await new _bluebird.default((resolve, reject) => {
      let onAppChange = dict => {
        let oldAppIdKey = dict.WIRHostApplicationIdentifierKey;
        let correctAppIdKey = dict.WIRApplicationIdentifierKey;

        if (oldAppIdKey && correctAppIdKey !== oldAppIdKey) {
          _logger.default.debug(`We were notified we might have connected to the wrong app. ` + `Using id ${correctAppIdKey} instead of ${oldAppIdKey}`);
        }

        applicationConnectedHandler(dict);
        reject(new Error('New application has connected'));
      };

      this.setSpecialMessageHandler('_rpc_applicationConnected:', reject, onAppChange);
      return (async () => {
        let [connectedAppIdKey, pageDict] = await this.send('connectToApp', {
          appIdKey
        });

        if (_lodash.default.isEmpty(pageDict)) {
          let msg = 'Empty page dictionary received';

          _logger.default.debug(msg);

          reject(new Error(msg));
        } else {
          resolve([connectedAppIdKey, pageDict]);
        }
      })();
    }).finally(() => {
      this.setSpecialMessageHandler('_rpc_applicationConnected:', null, applicationConnectedHandler);
    });
  }

  async sendMessage(command, opts = {}) {
    let onSocketError;
    return await new _bluebird.default((resolve, reject) => {
      const msgId = this.msgId++;

      const sendOpts = _lodash.default.defaults({
        connId: this.connId,
        senderId: this.senderId
      }, opts);

      const cmd = this.remoteMessages.getRemoteCommand(command, sendOpts);
      let socketCb = _lodash.default.noop;

      onSocketError = exception => {
        if (this.connected) {
          _logger.default.error(`Socket error: ${exception.message}`);
        }

        reject(exception);
      };

      this.socket.on('error', onSocketError);

      if (this.messageHandler.hasSpecialMessageHandler(cmd.__selector)) {
        const specialMessageHandler = this.getSpecialMessageHandler(cmd.__selector);
        this.setSpecialMessageHandler(cmd.__selector, reject, (...args) => {
          _logger.default.debug(`Received response from socket send: '${_lodash.default.truncate(JSON.stringify(args), {
            length: 50
          })}'`);

          specialMessageHandler(...args);

          if (this.messageHandler.hasSpecialMessageHandler(cmd.__selector)) {
            this.setSpecialMessageHandler(cmd.__selector, null, specialMessageHandler);
          }

          resolve(args);
        });
      } else if (cmd.__argument && cmd.__argument.WIRSocketDataKey) {
        const errorHandler = function (err) {
          const msg = `Remote debugger error with code '${err.code}': ${err.message}`;
          reject(new Error(msg));
        };

        this.setDataMessageHandler(msgId.toString(), errorHandler, function dataMessageHandler(value) {
          const msg = _lodash.default.truncate(_lodash.default.isString(value) ? value : JSON.stringify(value), {
            length: 50
          });

          _logger.default.debug(`Received data response from socket send: '${msg}'`);

          _logger.default.debug(`Original command: ${command}`);

          resolve(value);
        });

        if (cmd.__argument.WIRSocketDataKey.params) {
          cmd.__argument.WIRSocketDataKey.params.id = msgId;

          if (!cmd.__argument.WIRSocketDataKey.params.targetId) {
            cmd.__argument.WIRSocketDataKey.params.targetId = `page-${sendOpts.pageIdKey}`;
          }

          if (cmd.__argument.WIRSocketDataKey.params.message) {
            cmd.__argument.WIRSocketDataKey.params.message.id = msgId;
            cmd.__argument.WIRSocketDataKey.params.message = JSON.stringify(cmd.__argument.WIRSocketDataKey.params.message);
          }
        }

        cmd.__argument.WIRSocketDataKey.id = msgId;
        cmd.__argument.WIRSocketDataKey = Buffer.from(JSON.stringify(cmd.__argument.WIRSocketDataKey));
      } else {
        socketCb = resolve;
      }

      _logger.default.debug(`Sending '${cmd.__selector}' message to remote debugger (id: ${msgId})`);

      let plist;

      try {
        plist = (0, _bplistCreator.default)(cmd);
      } catch (e) {
        let msg = `Could not create binary plist from data: ${e.message}`;

        _logger.default.error(msg);

        return reject(new Error(msg));
      }

      if (this.socket && this.connected) {
        this.socket.cork();

        try {
          this.socket.write(_bufferpack.default.pack('L', [plist.length]));
          this.socket.write(plist, socketCb);
        } finally {
          this.socket.uncork();
        }
      } else {
        let msg = 'Attempted to write data to socket after it was closed!';

        _logger.default.error(msg);

        reject(new Error(msg));
      }
    }).finally(() => {
      if (_lodash.default.isFunction(onSocketError)) {
        this.socket.removeListener('error', onSocketError);
      }
    });
  }

  async receive(data) {
    this.received = Buffer.concat([this.received, data]);
    let dataLeftOver = true;

    while (dataLeftOver) {
      const oldReadPos = this.readPos;
      const prefix = this.received.slice(this.readPos, this.readPos + 4);

      if (_lodash.default.isEmpty(prefix)) {
        return;
      }

      let msgLength;

      try {
        msgLength = _bufferpack.default.unpack('L', prefix)[0];
      } catch (err) {
        _logger.default.error(`Buffer could not unpack: ${err}`);

        return;
      }

      this.readPos += 4;

      if (this.received.length < msgLength + this.readPos) {
        this.readPos = oldReadPos;
        break;
      }

      const body = this.received.slice(this.readPos, msgLength + this.readPos);
      let plist;

      try {
        plist = _bplistParser.default.parseBuffer(body);
      } catch (e) {
        _logger.default.error(`Error parsing binary plist: ${e}`);

        return;
      }

      if (plist.length === 1) {
        plist = plist[0];
      }

      for (const key of ['WIRMessageDataKey', 'WIRDestinationKey', 'WIRSocketDataKey']) {
        if (!_lodash.default.isUndefined(plist[key])) {
          plist[key] = plist[key].toString('utf8');
        }
      }

      this.readPos += msgLength;
      let leftOver = this.received.length - this.readPos;

      if (leftOver !== 0) {
        let chunk = Buffer.alloc(leftOver);
        this.received.copy(chunk, 0, this.readPos);
        this.received = chunk;
      } else {
        this.received = Buffer.alloc(0);
        dataLeftOver = false;
      }

      this.readPos = 0;

      if (plist) {
        await this.messageHandler.handleMessage(plist);
      }
    }
  }

  setTimelineEventHandler(timelineEventHandler) {
    this.timelineEventHandler = timelineEventHandler;
    this.messageHandler.setTimelineEventHandler(timelineEventHandler);
  }

  setConsoleLogEventHandler(consoleEventHandler) {
    this.consoleEventHandler = consoleEventHandler;
    this.messageHandler.setConsoleLogEventHandler(consoleEventHandler);
  }

  setNetworkLogEventHandler(networkEventHandler) {
    this.networkEventHandler = networkEventHandler;
    this.messageHandler.setNetworkEventHandler(networkEventHandler);
  }

}

exports.default = RemoteDebuggerRpcClient;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9yZW1vdGUtZGVidWdnZXItcnBjLWNsaWVudC5qcyJdLCJuYW1lcyI6WyJSZW1vdGVEZWJ1Z2dlclJwY0NsaWVudCIsIlJwY0NsaWVudCIsImNvbnN0cnVjdG9yIiwib3B0cyIsInBsYXRmb3JtVmVyc2lvbiIsImlzU2FmYXJpIiwiaG9zdCIsInBvcnQiLCJSRU1PVEVfREVCVUdHRVJfUE9SVCIsInNvY2tldFBhdGgiLCJzcGVjaWFsTWVzc2FnZUhhbmRsZXJzIiwibWVzc2FnZVByb3h5Iiwic29ja2V0IiwiY29ubmVjdGVkIiwiY29ubklkIiwiVVVJRCIsImNyZWF0ZSIsInRvU3RyaW5nIiwic2VuZGVySWQiLCJtc2dJZCIsInJlY2VpdmVkIiwiQnVmZmVyIiwiYWxsb2MiLCJyZWFkUG9zIiwic2V0Q29tbXVuaWNhdGlvblByb3RvY29sIiwiaXNUYXJnZXRCYXNlZCIsIm1lc3NhZ2VIYW5kbGVyIiwiUnBjTWVzc2FnZUhhbmRsZXIiLCJjb25uZWN0IiwibG9nIiwiZGVidWciLCJuZXQiLCJvbmNlIiwid3JpdGUiLCJKU09OIiwic3RyaW5naWZ5IiwiU29ja2V0IiwidHlwZSIsInNldE5vRGVsYXkiLCJvbiIsInJlY2VpdmUiLCJiaW5kIiwiQiIsInJlc29sdmUiLCJyZWplY3QiLCJlcnIiLCJlcnJvciIsIm1lc3NhZ2UiLCJkaXNjb25uZWN0IiwiaXNDb25uZWN0ZWQiLCJkZXN0cm95Iiwic2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyIiwia2V5IiwiZXJyb3JIYW5kbGVyIiwiaGFuZGxlciIsImdldFNwZWNpYWxNZXNzYWdlSGFuZGxlciIsInNldERhdGFNZXNzYWdlSGFuZGxlciIsImFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQiLCJhbGxvdyIsInNlbGVjdEFwcCIsImFwcElkS2V5IiwiYXBwbGljYXRpb25Db25uZWN0ZWRIYW5kbGVyIiwib25BcHBDaGFuZ2UiLCJkaWN0Iiwib2xkQXBwSWRLZXkiLCJXSVJIb3N0QXBwbGljYXRpb25JZGVudGlmaWVyS2V5IiwiY29ycmVjdEFwcElkS2V5IiwiV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5IiwiRXJyb3IiLCJjb25uZWN0ZWRBcHBJZEtleSIsInBhZ2VEaWN0Iiwic2VuZCIsIl8iLCJpc0VtcHR5IiwibXNnIiwiZmluYWxseSIsInNlbmRNZXNzYWdlIiwiY29tbWFuZCIsIm9uU29ja2V0RXJyb3IiLCJzZW5kT3B0cyIsImRlZmF1bHRzIiwiY21kIiwicmVtb3RlTWVzc2FnZXMiLCJnZXRSZW1vdGVDb21tYW5kIiwic29ja2V0Q2IiLCJub29wIiwiZXhjZXB0aW9uIiwiaGFzU3BlY2lhbE1lc3NhZ2VIYW5kbGVyIiwiX19zZWxlY3RvciIsInNwZWNpYWxNZXNzYWdlSGFuZGxlciIsImFyZ3MiLCJ0cnVuY2F0ZSIsImxlbmd0aCIsIl9fYXJndW1lbnQiLCJXSVJTb2NrZXREYXRhS2V5IiwiY29kZSIsImRhdGFNZXNzYWdlSGFuZGxlciIsInZhbHVlIiwiaXNTdHJpbmciLCJwYXJhbXMiLCJpZCIsInRhcmdldElkIiwicGFnZUlkS2V5IiwiZnJvbSIsInBsaXN0IiwiZSIsImNvcmsiLCJidWZmZXJwYWNrIiwicGFjayIsInVuY29yayIsImlzRnVuY3Rpb24iLCJyZW1vdmVMaXN0ZW5lciIsImRhdGEiLCJjb25jYXQiLCJkYXRhTGVmdE92ZXIiLCJvbGRSZWFkUG9zIiwicHJlZml4Iiwic2xpY2UiLCJtc2dMZW5ndGgiLCJ1bnBhY2siLCJib2R5IiwiYnBsaXN0UGFyc2VyIiwicGFyc2VCdWZmZXIiLCJpc1VuZGVmaW5lZCIsImxlZnRPdmVyIiwiY2h1bmsiLCJjb3B5IiwiaGFuZGxlTWVzc2FnZSIsInNldFRpbWVsaW5lRXZlbnRIYW5kbGVyIiwidGltZWxpbmVFdmVudEhhbmRsZXIiLCJzZXRDb25zb2xlTG9nRXZlbnRIYW5kbGVyIiwiY29uc29sZUV2ZW50SGFuZGxlciIsInNldE5ldHdvcmtMb2dFdmVudEhhbmRsZXIiLCJuZXR3b3JrRXZlbnRIYW5kbGVyIiwic2V0TmV0d29ya0V2ZW50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QUFNLENBQUNDLEtBQVAsQ0FBYSxDQUFiLENBQWhCO0FBQ0E0RixRQUFBQSxZQUFZLEdBQUcsS0FBZjtBQUNEOztBQUdELFdBQUszRixPQUFMLEdBQWUsQ0FBZjs7QUFHQSxVQUFJaUYsS0FBSixFQUFXO0FBQ1QsY0FBTSxLQUFLOUUsY0FBTCxDQUFvQnFHLGFBQXBCLENBQWtDdkIsS0FBbEMsQ0FBTjtBQUNEO0FBQ0Y7QUFDRjs7QUFFRHdCLEVBQUFBLHVCQUF1QixDQUFFQyxvQkFBRixFQUF3QjtBQUM3QyxTQUFLQSxvQkFBTCxHQUE0QkEsb0JBQTVCO0FBQ0EsU0FBS3ZHLGNBQUwsQ0FBb0JzRyx1QkFBcEIsQ0FBNENDLG9CQUE1QztBQUNEOztBQUVEQyxFQUFBQSx5QkFBeUIsQ0FBRUMsbUJBQUYsRUFBdUI7QUFDOUMsU0FBS0EsbUJBQUwsR0FBMkJBLG1CQUEzQjtBQUNBLFNBQUt6RyxjQUFMLENBQW9Cd0cseUJBQXBCLENBQThDQyxtQkFBOUM7QUFDRDs7QUFFREMsRUFBQUEseUJBQXlCLENBQUVDLG1CQUFGLEVBQXVCO0FBQzlDLFNBQUtBLG1CQUFMLEdBQTJCQSxtQkFBM0I7QUFDQSxTQUFLM0csY0FBTCxDQUFvQjRHLHNCQUFwQixDQUEyQ0QsbUJBQTNDO0FBQ0Q7O0FBN1k0RCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBicGxpc3RDcmVhdGUgZnJvbSAnYnBsaXN0LWNyZWF0b3InO1xuaW1wb3J0IGJwbGlzdFBhcnNlciBmcm9tICdicGxpc3QtcGFyc2VyJztcbmltcG9ydCBidWZmZXJwYWNrIGZyb20gJ2J1ZmZlcnBhY2snO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgUkVNT1RFX0RFQlVHR0VSX1BPUlQgfSBmcm9tICcuL3JlbW90ZS1kZWJ1Z2dlcic7XG5pbXBvcnQgVVVJRCBmcm9tICd1dWlkLWpzJztcbmltcG9ydCBuZXQgZnJvbSAnbmV0JztcbmltcG9ydCBScGNNZXNzYWdlSGFuZGxlciBmcm9tICcuL3JlbW90ZS1kZWJ1Z2dlci1tZXNzYWdlLWhhbmRsZXInO1xuaW1wb3J0IHsgaXNUYXJnZXRCYXNlZCB9IGZyb20gJy4vaGVscGVycyc7XG5pbXBvcnQgUnBjQ2xpZW50IGZyb20gJy4vcnBjLWNsaWVudCc7XG5cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUmVtb3RlRGVidWdnZXJScGNDbGllbnQgZXh0ZW5kcyBScGNDbGllbnQge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgc3VwZXIoKTtcblxuICAgIGNvbnN0IHtcbiAgICAgIHBsYXRmb3JtVmVyc2lvbiA9IHt9LFxuICAgICAgaXNTYWZhcmkgPSB0cnVlLFxuICAgICAgaG9zdCA9ICc6OjEnLFxuICAgICAgcG9ydCA9IFJFTU9URV9ERUJVR0dFUl9QT1JULFxuICAgICAgc29ja2V0UGF0aCxcbiAgICAgIHNwZWNpYWxNZXNzYWdlSGFuZGxlcnMgPSB7fSxcbiAgICAgIG1lc3NhZ2VQcm94eSxcbiAgICB9ID0gb3B0cztcblxuICAgIC8vIGhvc3QvcG9ydCBjb25maWcgZm9yIFRDUCBjb21tdW5pY2F0aW9uLCBzb2NrZXRQYXRoIGZvciB1bml4IGRvbWFpbiBzb2NrZXRzXG4gICAgdGhpcy5ob3N0ID0gaG9zdDtcbiAgICB0aGlzLnBvcnQgPSBwb3J0O1xuICAgIHRoaXMuc29ja2V0UGF0aCA9IHNvY2tldFBhdGg7XG4gICAgdGhpcy5tZXNzYWdlUHJveHkgPSBtZXNzYWdlUHJveHk7XG5cbiAgICB0aGlzLnNvY2tldCA9IG51bGw7XG4gICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgICB0aGlzLmNvbm5JZCA9IFVVSUQuY3JlYXRlKCkudG9TdHJpbmcoKTtcbiAgICB0aGlzLnNlbmRlcklkID0gVVVJRC5jcmVhdGUoKS50b1N0cmluZygpO1xuICAgIHRoaXMubXNnSWQgPSAwO1xuICAgIHRoaXMucmVjZWl2ZWQgPSBCdWZmZXIuYWxsb2MoMCk7XG4gICAgdGhpcy5yZWFkUG9zID0gMDtcblxuICAgIC8vIG1lc3NhZ2UgaGFuZGxlcnNcbiAgICB0aGlzLnNwZWNpYWxNZXNzYWdlSGFuZGxlcnMgPSBzcGVjaWFsTWVzc2FnZUhhbmRsZXJzO1xuXG4gICAgLy8gc3RhcnQgd2l0aCBhIGJlc3QgZ3Vlc3MgZm9yIHRoZSBwcm90b2NvbFxuICAgIHRoaXMuc2V0Q29tbXVuaWNhdGlvblByb3RvY29sKGlzVGFyZ2V0QmFzZWQoaXNTYWZhcmksIHBsYXRmb3JtVmVyc2lvbikpO1xuICB9XG5cbiAgc2V0Q29tbXVuaWNhdGlvblByb3RvY29sIChpc1RhcmdldEJhc2VkID0gZmFsc2UpIHtcbiAgICBzdXBlci5zZXRDb21tdW5pY2F0aW9uUHJvdG9jb2woaXNUYXJnZXRCYXNlZCk7XG5cbiAgICBpZiAoIXRoaXMubWVzc2FnZUhhbmRsZXIpIHtcbiAgICAgIHRoaXMubWVzc2FnZUhhbmRsZXIgPSBuZXcgUnBjTWVzc2FnZUhhbmRsZXIodGhpcy5zcGVjaWFsTWVzc2FnZUhhbmRsZXJzLCBpc1RhcmdldEJhc2VkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5tZXNzYWdlSGFuZGxlci5zZXRDb21tdW5pY2F0aW9uUHJvdG9jb2woaXNUYXJnZXRCYXNlZCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY29ubmVjdCAoKSB7XG4gICAgLy8gY3JlYXRlIHNvY2tldCBhbmQgaGFuZGxlIGl0cyBtZXNzYWdlc1xuICAgIGlmICh0aGlzLnNvY2tldFBhdGgpIHtcbiAgICAgIGlmICh0aGlzLm1lc3NhZ2VQcm94eSkge1xuICAgICAgICAvLyB1bml4IGRvbWFpbiBzb2NrZXQgdmlhIHByb3h5XG4gICAgICAgIGxvZy5kZWJ1ZyhgQ29ubmVjdGluZyB0byByZW1vdGUgZGVidWdnZXIgdmlhIHByb3h5IHRocm91Z2ggdW5peCBkb21haW4gc29ja2V0OiAnJHt0aGlzLm1lc3NhZ2VQcm94eX0nYCk7XG4gICAgICAgIHRoaXMuc29ja2V0ID0gbmV0LmNvbm5lY3QodGhpcy5tZXNzYWdlUHJveHkpO1xuXG4gICAgICAgIC8vIEZvcndhcmQgdGhlIGFjdHVhbCBzb2NrZXRQYXRoIHRvIHRoZSBwcm94eVxuICAgICAgICB0aGlzLnNvY2tldC5vbmNlKCdjb25uZWN0JywgKCkgPT4ge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgRm9yd2FyZGluZyB0aGUgYWN0dWFsIHdlYiBpbnNwZWN0b3Igc29ja2V0IHRvIHRoZSBwcm94eTogJyR7dGhpcy5zb2NrZXRQYXRofSdgKTtcbiAgICAgICAgICB0aGlzLnNvY2tldC53cml0ZShKU09OLnN0cmluZ2lmeSh7c29ja2V0UGF0aDogdGhpcy5zb2NrZXRQYXRofSkpO1xuICAgICAgICB9KTtcblxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gdW5peCBkb21haW4gc29ja2V0XG4gICAgICAgIGxvZy5kZWJ1ZyhgQ29ubmVjdGluZyB0byByZW1vdGUgZGVidWdnZXIgdGhyb3VnaCB1bml4IGRvbWFpbiBzb2NrZXQ6ICcke3RoaXMuc29ja2V0UGF0aH0nYCk7XG4gICAgICAgIHRoaXMuc29ja2V0ID0gbmV0LmNvbm5lY3QodGhpcy5zb2NrZXRQYXRoKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMubWVzc2FnZVByb3h5KSB7XG4gICAgICAgIC8vIGNvbm5lY3QgdG8gdGhlIHByb3h5IGluc3RlYWQgb2YgdGhlIHJlbW90ZSBkZWJ1Z2dlciBkaXJlY3RseVxuICAgICAgICB0aGlzLnBvcnQgPSB0aGlzLm1lc3NhZ2VQcm94eTtcbiAgICAgIH1cblxuICAgICAgLy8gdGNwIHNvY2tldFxuICAgICAgbG9nLmRlYnVnKGBDb25uZWN0aW5nIHRvIHJlbW90ZSBkZWJ1Z2dlciAke3RoaXMubWVzc2FnZVByb3h5ID8gJ3ZpYSBwcm94eSAnIDogJyd9dGhyb3VnaCBUQ1A6ICR7dGhpcy5ob3N0fToke3RoaXMucG9ydH1gKTtcbiAgICAgIHRoaXMuc29ja2V0ID0gbmV3IG5ldC5Tb2NrZXQoe3R5cGU6ICd0Y3A2J30pO1xuICAgICAgdGhpcy5zb2NrZXQuY29ubmVjdCh0aGlzLnBvcnQsIHRoaXMuaG9zdCk7XG4gICAgfVxuXG4gICAgdGhpcy5zb2NrZXQuc2V0Tm9EZWxheSh0cnVlKTtcbiAgICB0aGlzLnNvY2tldC5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgICBpZiAodGhpcy5jb25uZWN0ZWQpIHtcbiAgICAgICAgbG9nLmRlYnVnKCdEZWJ1Z2dlciBzb2NrZXQgZGlzY29ubmVjdGVkJyk7XG4gICAgICB9XG4gICAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlO1xuICAgICAgdGhpcy5zb2NrZXQgPSBudWxsO1xuICAgIH0pO1xuICAgIHRoaXMuc29ja2V0Lm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlO1xuICAgIH0pO1xuICAgIHRoaXMuc29ja2V0Lm9uKCdkYXRhJywgdGhpcy5yZWNlaXZlLmJpbmQodGhpcykpO1xuXG4gICAgLy8gY29ubmVjdCB0aGUgc29ja2V0XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIC8vIG9ubHkgcmVzb2x2ZSB0aGlzIGZ1bmN0aW9uIHdoZW4gd2UgYXJlIGFjdHVhbGx5IGNvbm5lY3RlZFxuICAgICAgdGhpcy5zb2NrZXQub24oJ2Nvbm5lY3QnLCAoKSA9PiB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgRGVidWdnZXIgc29ja2V0IGNvbm5lY3RlZGApO1xuICAgICAgICB0aGlzLmNvbm5lY3RlZCA9IHRydWU7XG5cbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSk7XG4gICAgICB0aGlzLnNvY2tldC5vbignZXJyb3InLCAoZXJyKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLmNvbm5lY3RlZCkge1xuICAgICAgICAgIGxvZy5lcnJvcihgU29ja2V0IGVycm9yOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICAvLyB0aGUgY29ubmVjdGlvbiB3YXMgcmVmdXNlZCwgc28gcmVqZWN0IHRoZSBjb25uZWN0IHByb21pc2VcbiAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGRpc2Nvbm5lY3QgKCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgICBpZiAodGhpcy5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICBsb2cuZGVidWcoJ0Rpc2Nvbm5lY3RpbmcgZnJvbSByZW1vdGUgZGVidWdnZXInKTtcbiAgICAgIHRoaXMuc29ja2V0LmRlc3Ryb3koKTtcbiAgICB9XG4gICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgfVxuXG4gIGlzQ29ubmVjdGVkICgpIHtcbiAgICByZXR1cm4gdGhpcy5jb25uZWN0ZWQ7XG4gIH1cblxuICBzZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIgKGtleSwgZXJyb3JIYW5kbGVyLCBoYW5kbGVyKSB7XG4gICAgdGhpcy5tZXNzYWdlSGFuZGxlci5zZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIoa2V5LCBlcnJvckhhbmRsZXIsIGhhbmRsZXIpO1xuICB9XG5cbiAgZ2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyIChrZXkpIHtcbiAgICByZXR1cm4gdGhpcy5tZXNzYWdlSGFuZGxlci5nZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIoa2V5KTtcbiAgfVxuXG4gIHNldERhdGFNZXNzYWdlSGFuZGxlciAoa2V5LCBlcnJvckhhbmRsZXIsIGhhbmRsZXIpIHtcbiAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNldERhdGFNZXNzYWdlSGFuZGxlcihrZXksIGVycm9ySGFuZGxlciwgaGFuZGxlcik7XG4gIH1cblxuICBhbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkIChhbGxvdyA9IHRydWUpIHtcbiAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyLmFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQoYWxsb3cpO1xuICB9XG5cbiAgYXN5bmMgc2VsZWN0QXBwIChhcHBJZEtleSwgYXBwbGljYXRpb25Db25uZWN0ZWRIYW5kbGVyKSB7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIC8vIGxvY2FsIGNhbGxiYWNrLCB0ZW1wb3JhcmlseSBhZGRlZCBhcyBjYWxsYmFjayB0b1xuICAgICAgLy8gYF9ycGNfYXBwbGljYXRpb25Db25uZWN0ZWQ6YCByZW1vdGUgZGVidWdnZXIgcmVzcG9uc2VcbiAgICAgIC8vIHRvIGhhbmRsZSB0aGUgaW5pdGlhbCBjb25uZWN0aW9uXG4gICAgICBsZXQgb25BcHBDaGFuZ2UgPSAoZGljdCkgPT4ge1xuICAgICAgICAvLyBmcm9tIHRoZSBkaWN0aW9uYXJ5IHJldHVybmVkLCBnZXQgdGhlIGlkc1xuICAgICAgICBsZXQgb2xkQXBwSWRLZXkgPSBkaWN0LldJUkhvc3RBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk7XG4gICAgICAgIGxldCBjb3JyZWN0QXBwSWRLZXkgPSBkaWN0LldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTtcblxuICAgICAgICAvLyBpZiB0aGlzIGlzIGEgcmVwb3J0IG9mIGEgcHJveHkgcmVkaXJlY3QgZnJvbSB0aGUgcmVtb3RlIGRlYnVnZ2VyXG4gICAgICAgIC8vIHdlIHdhbnQgdG8gdXBkYXRlIG91ciBkaWN0aW9uYXJ5IGFuZCBnZXQgYSBuZXcgYXBwIGlkXG4gICAgICAgIGlmIChvbGRBcHBJZEtleSAmJiBjb3JyZWN0QXBwSWRLZXkgIT09IG9sZEFwcElkS2V5KSB7XG4gICAgICAgICAgbG9nLmRlYnVnKGBXZSB3ZXJlIG5vdGlmaWVkIHdlIG1pZ2h0IGhhdmUgY29ubmVjdGVkIHRvIHRoZSB3cm9uZyBhcHAuIGAgK1xuICAgICAgICAgICAgICAgICAgICBgVXNpbmcgaWQgJHtjb3JyZWN0QXBwSWRLZXl9IGluc3RlYWQgb2YgJHtvbGRBcHBJZEtleX1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGFwcGxpY2F0aW9uQ29ubmVjdGVkSGFuZGxlcihkaWN0KTtcbiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignTmV3IGFwcGxpY2F0aW9uIGhhcyBjb25uZWN0ZWQnKSk7XG4gICAgICB9O1xuICAgICAgdGhpcy5zZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIoJ19ycGNfYXBwbGljYXRpb25Db25uZWN0ZWQ6JywgcmVqZWN0LCBvbkFwcENoYW5nZSk7XG5cbiAgICAgIC8vIGRvIHRoZSBhY3R1YWwgY29ubmVjdGluZyB0byB0aGUgYXBwXG4gICAgICByZXR1cm4gKGFzeW5jICgpID0+IHtcbiAgICAgICAgbGV0IFtjb25uZWN0ZWRBcHBJZEtleSwgcGFnZURpY3RdID0gYXdhaXQgdGhpcy5zZW5kKCdjb25uZWN0VG9BcHAnLCB7XG4gICAgICAgICAgYXBwSWRLZXlcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gc29tZXRpbWVzIHRoZSBjb25uZWN0IGxvZ2ljIGhhcHBlbnMsIGJ1dCB3aXRoIGFuIGVtcHR5IGRpY3Rpb25hcnlcbiAgICAgICAgLy8gd2hpY2ggbGVhZHMgdG8gdGhlIHJlbW90ZSBkZWJ1Z2dlciBnZXR0aW5nIGRpc2Nvbm5lY3RlZCwgYW5kIGludG8gYSBsb29wXG4gICAgICAgIGlmIChfLmlzRW1wdHkocGFnZURpY3QpKSB7XG4gICAgICAgICAgbGV0IG1zZyA9ICdFbXB0eSBwYWdlIGRpY3Rpb25hcnkgcmVjZWl2ZWQnO1xuICAgICAgICAgIGxvZy5kZWJ1Zyhtc2cpO1xuICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IobXNnKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzb2x2ZShbY29ubmVjdGVkQXBwSWRLZXksIHBhZ2VEaWN0XSk7XG4gICAgICAgIH1cbiAgICAgIH0pKCk7XG4gICAgfSkuZmluYWxseSgoKSA9PiB7XG4gICAgICAvLyBubyBtYXR0ZXIgd2hhdCwgd2Ugd2FudCB0byByZXN0b3JlIHRoZSBoYW5kbGVyIHRoYXQgd2FzIGNoYW5nZWQuXG4gICAgICB0aGlzLnNldFNwZWNpYWxNZXNzYWdlSGFuZGxlcignX3JwY19hcHBsaWNhdGlvbkNvbm5lY3RlZDonLCBudWxsLCBhcHBsaWNhdGlvbkNvbm5lY3RlZEhhbmRsZXIpO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgc2VuZE1lc3NhZ2UgKGNvbW1hbmQsIG9wdHMgPSB7fSkge1xuICAgIC8vIGVycm9yIGxpc3RlbmVyLCB3aGljaCBuZWVkcyB0byBiZSByZW1vdmVkIGFmdGVyIHRoZSBwcm9taXNlIGlzIHJlc29sdmVkXG4gICAgbGV0IG9uU29ja2V0RXJyb3I7XG5cbiAgICByZXR1cm4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLy8gcHJvbWlzZSB0byBiZSByZXNvbHZlZCB3aGVuZXZlciByZW1vdGUgZGVidWdnZXJcbiAgICAgIC8vIHJlcGxpZXMgdG8gb3VyIHJlcXVlc3RcblxuICAgICAgLy8ga2VlcCB0cmFjayBvZiB0aGUgbWVzc2FnZXMgY29taW5nIGFuZCBnb2luZyB1c2luZyBhIHNpbXBsZSBzZXF1ZW50aWFsIGlkXG4gICAgICBjb25zdCBtc2dJZCA9IHRoaXMubXNnSWQrKztcblxuICAgICAgLy8gcmV0cmlldmUgdGhlIGNvcnJlY3QgY29tbWFuZCB0byBzZW5kXG4gICAgICBjb25zdCBzZW5kT3B0cyA9IF8uZGVmYXVsdHMoe2Nvbm5JZDogdGhpcy5jb25uSWQsIHNlbmRlcklkOiB0aGlzLnNlbmRlcklkfSwgb3B0cyk7XG4gICAgICBjb25zdCBjbWQgPSB0aGlzLnJlbW90ZU1lc3NhZ2VzLmdldFJlbW90ZUNvbW1hbmQoY29tbWFuZCwgc2VuZE9wdHMpO1xuXG4gICAgICAvLyBtb3N0IG9mIHRoZSB0aW1lIHdlIGRvbid0IGNhcmUgd2hlbiBzb2NrZXQud3JpdGUgZG9lc1xuICAgICAgLy8gc28gZ2l2ZSBpdCBhbiBlbXB0eSBmdW5jdGlvblxuICAgICAgbGV0IHNvY2tldENiID0gXy5ub29wO1xuXG4gICAgICAvLyBoYW5kbGUgc29ja2V0IHByb2JsZW1zXG4gICAgICBvblNvY2tldEVycm9yID0gKGV4Y2VwdGlvbikgPT4ge1xuICAgICAgICBpZiAodGhpcy5jb25uZWN0ZWQpIHtcbiAgICAgICAgICBsb2cuZXJyb3IoYFNvY2tldCBlcnJvcjogJHtleGNlcHRpb24ubWVzc2FnZX1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHRoZSBjb25uZWN0aW9uIHdhcyByZWZ1c2VkLCBzbyByZWplY3QgdGhlIGNvbm5lY3QgcHJvbWlzZVxuICAgICAgICByZWplY3QoZXhjZXB0aW9uKTtcbiAgICAgIH07XG4gICAgICB0aGlzLnNvY2tldC5vbignZXJyb3InLCBvblNvY2tldEVycm9yKTtcblxuICAgICAgaWYgKHRoaXMubWVzc2FnZUhhbmRsZXIuaGFzU3BlY2lhbE1lc3NhZ2VIYW5kbGVyKGNtZC5fX3NlbGVjdG9yKSkge1xuICAgICAgICAvLyBzcGVjaWFsIHJlcGxpZXMgd2lsbCByZXR1cm4gYW55IG51bWJlciBvZiBhcmd1bWVudHNcbiAgICAgICAgLy8gdGVtcG9yYXJpbHkgd3JhcCB3aXRoIHByb21pc2UgaGFuZGxpbmdcbiAgICAgICAgY29uc3Qgc3BlY2lhbE1lc3NhZ2VIYW5kbGVyID0gdGhpcy5nZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIoY21kLl9fc2VsZWN0b3IpO1xuICAgICAgICB0aGlzLnNldFNwZWNpYWxNZXNzYWdlSGFuZGxlcihjbWQuX19zZWxlY3RvciwgcmVqZWN0LCAoLi4uYXJncykgPT4ge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgcmVzcG9uc2UgZnJvbSBzb2NrZXQgc2VuZDogJyR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShhcmdzKSwge2xlbmd0aDogNTB9KX0nYCk7XG5cbiAgICAgICAgICAvLyBjYWxsIHRoZSBvcmlnaW5hbCBsaXN0ZW5lciwgYW5kIHB1dCBpdCBiYWNrLCBpZiBuZWNlc3NhcnlcbiAgICAgICAgICBzcGVjaWFsTWVzc2FnZUhhbmRsZXIoLi4uYXJncyk7XG4gICAgICAgICAgaWYgKHRoaXMubWVzc2FnZUhhbmRsZXIuaGFzU3BlY2lhbE1lc3NhZ2VIYW5kbGVyKGNtZC5fX3NlbGVjdG9yKSkge1xuICAgICAgICAgICAgLy8gdGhpcyBtZWFucyB0aGF0IHRoZSBzeXN0ZW0gaGFzIG5vdCByZW1vdmVkIHRoaXMgbGlzdGVuZXJcbiAgICAgICAgICAgIHRoaXMuc2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyKGNtZC5fX3NlbGVjdG9yLCBudWxsLCBzcGVjaWFsTWVzc2FnZUhhbmRsZXIpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJlc29sdmUoYXJncyk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIGlmIChjbWQuX19hcmd1bWVudCAmJiBjbWQuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5KSB7XG4gICAgICAgIGNvbnN0IGVycm9ySGFuZGxlciA9IGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICBjb25zdCBtc2cgPSBgUmVtb3RlIGRlYnVnZ2VyIGVycm9yIHdpdGggY29kZSAnJHtlcnIuY29kZX0nOiAke2Vyci5tZXNzYWdlfWA7XG4gICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihtc2cpKTtcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLnNldERhdGFNZXNzYWdlSGFuZGxlcihtc2dJZC50b1N0cmluZygpLCBlcnJvckhhbmRsZXIsIGZ1bmN0aW9uIGRhdGFNZXNzYWdlSGFuZGxlciAodmFsdWUpIHtcbiAgICAgICAgICBjb25zdCBtc2cgPSBfLnRydW5jYXRlKF8uaXNTdHJpbmcodmFsdWUpID8gdmFsdWUgOiBKU09OLnN0cmluZ2lmeSh2YWx1ZSksIHtsZW5ndGg6IDUwfSk7XG4gICAgICAgICAgbG9nLmRlYnVnKGBSZWNlaXZlZCBkYXRhIHJlc3BvbnNlIGZyb20gc29ja2V0IHNlbmQ6ICcke21zZ30nYCk7XG4gICAgICAgICAgbG9nLmRlYnVnKGBPcmlnaW5hbCBjb21tYW5kOiAke2NvbW1hbmR9YCk7XG4gICAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIG1ha2Ugc3VyZSB0aGUgbWVzc2FnZSBiZWluZyBzZW50IGhhcyBhbGwgdGhlIGluZm9ybWF0aW9uIHRoYXQgaXMgbmVlZGVkXG4gICAgICAgIGlmIChjbWQuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5LnBhcmFtcykge1xuICAgICAgICAgIGNtZC5fX2FyZ3VtZW50LldJUlNvY2tldERhdGFLZXkucGFyYW1zLmlkID0gbXNnSWQ7XG4gICAgICAgICAgaWYgKCFjbWQuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5LnBhcmFtcy50YXJnZXRJZCkge1xuICAgICAgICAgICAgY21kLl9fYXJndW1lbnQuV0lSU29ja2V0RGF0YUtleS5wYXJhbXMudGFyZ2V0SWQgPSBgcGFnZS0ke3NlbmRPcHRzLnBhZ2VJZEtleX1gO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoY21kLl9fYXJndW1lbnQuV0lSU29ja2V0RGF0YUtleS5wYXJhbXMubWVzc2FnZSkge1xuICAgICAgICAgICAgY21kLl9fYXJndW1lbnQuV0lSU29ja2V0RGF0YUtleS5wYXJhbXMubWVzc2FnZS5pZCA9IG1zZ0lkO1xuICAgICAgICAgICAgY21kLl9fYXJndW1lbnQuV0lSU29ja2V0RGF0YUtleS5wYXJhbXMubWVzc2FnZSA9IEpTT04uc3RyaW5naWZ5KGNtZC5fX2FyZ3VtZW50LldJUlNvY2tldERhdGFLZXkucGFyYW1zLm1lc3NhZ2UpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjbWQuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5LmlkID0gbXNnSWQ7XG4gICAgICAgIGNtZC5fX2FyZ3VtZW50LldJUlNvY2tldERhdGFLZXkgPVxuICAgICAgICAgIEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KGNtZC5fX2FyZ3VtZW50LldJUlNvY2tldERhdGFLZXkpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIHdlIHdhbnQgdG8gaW1tZWRpYXRlbHkgcmVzb2x2ZSB0aGlzIHNvY2tldC53cml0ZVxuICAgICAgICAvLyBhbnkgbG9uZyB0ZXJtIGNhbGxiYWNrcyB3aWxsIGRvIHRoZWlyIGJ1c2luZXNzIGluIHRoZSBiYWNrZ3JvdW5kXG4gICAgICAgIHNvY2tldENiID0gcmVzb2x2ZTtcbiAgICAgIH1cblxuICAgICAgbG9nLmRlYnVnKGBTZW5kaW5nICcke2NtZC5fX3NlbGVjdG9yfScgbWVzc2FnZSB0byByZW1vdGUgZGVidWdnZXIgKGlkOiAke21zZ0lkfSlgKTtcblxuICAgICAgLy8gcmVtb3RlIGRlYnVnZ2VyIGV4cGVjdHMgYSBiaW5hcnkgcGxpc3QgYXMgZGF0YVxuICAgICAgbGV0IHBsaXN0O1xuICAgICAgdHJ5IHtcbiAgICAgICAgcGxpc3QgPSBicGxpc3RDcmVhdGUoY21kKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbGV0IG1zZyA9IGBDb3VsZCBub3QgY3JlYXRlIGJpbmFyeSBwbGlzdCBmcm9tIGRhdGE6ICR7ZS5tZXNzYWdlfWA7XG4gICAgICAgIGxvZy5lcnJvcihtc2cpO1xuICAgICAgICByZXR1cm4gcmVqZWN0KG5ldyBFcnJvcihtc2cpKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMuc29ja2V0ICYmIHRoaXMuY29ubmVjdGVkKSB7XG4gICAgICAgIC8vIGNvcmsgYW5kIHVuY29yayBpbiBvcmRlciB0byBub3QgYnVmZmVyIHRoZSB3cml0ZVxuICAgICAgICAvLyBvbiBzb21lIHN5c3RlbXMgdGhpcyBpcyBuZWNlc3Nhcnkgb3IgdGhlIHNlcnZlclxuICAgICAgICAvLyBnZXRzIGNvbmZ1c2VkLlxuICAgICAgICB0aGlzLnNvY2tldC5jb3JrKCk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgdGhpcy5zb2NrZXQud3JpdGUoYnVmZmVycGFjay5wYWNrKCdMJywgW3BsaXN0Lmxlbmd0aF0pKTtcbiAgICAgICAgICB0aGlzLnNvY2tldC53cml0ZShwbGlzdCwgc29ja2V0Q2IpO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgIHRoaXMuc29ja2V0LnVuY29yaygpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsZXQgbXNnID0gJ0F0dGVtcHRlZCB0byB3cml0ZSBkYXRhIHRvIHNvY2tldCBhZnRlciBpdCB3YXMgY2xvc2VkISc7XG4gICAgICAgIGxvZy5lcnJvcihtc2cpO1xuICAgICAgICByZWplY3QobmV3IEVycm9yKG1zZykpO1xuICAgICAgfVxuICAgIH0pXG4gICAgLmZpbmFsbHkoKCkgPT4ge1xuICAgICAgLy8gcmVtb3ZlIHRoaXMgbGlzdGVuZXIsIHNvIHdlIGRvbid0IGV4aGF1c3QgdGhlIHN5c3RlbVxuICAgICAgaWYgKF8uaXNGdW5jdGlvbihvblNvY2tldEVycm9yKSkge1xuICAgICAgICB0aGlzLnNvY2tldC5yZW1vdmVMaXN0ZW5lcignZXJyb3InLCBvblNvY2tldEVycm9yKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHJlY2VpdmUgKGRhdGEpIHtcbiAgICAvLyBBcHBlbmQgdGhpcyBuZXcgZGF0YSB0byB0aGUgZXhpc3RpbmcgQnVmZmVyXG4gICAgdGhpcy5yZWNlaXZlZCA9IEJ1ZmZlci5jb25jYXQoW3RoaXMucmVjZWl2ZWQsIGRhdGFdKTtcbiAgICBsZXQgZGF0YUxlZnRPdmVyID0gdHJ1ZTtcblxuICAgIC8vIFBhcnNlIG11bHRpcGxlIG1lc3NhZ2VzIGluIHRoZSBzYW1lIHBhY2tldFxuICAgIHdoaWxlIChkYXRhTGVmdE92ZXIpIHtcbiAgICAgIC8vIFN0b3JlIGEgcmVmZXJlbmNlIHRvIHdoZXJlIHdlIHdlcmVcbiAgICAgIGNvbnN0IG9sZFJlYWRQb3MgPSB0aGlzLnJlYWRQb3M7XG5cbiAgICAgIC8vIFJlYWQgdGhlIHByZWZpeCAocGxpc3QgbGVuZ3RoKSB0byBzZWUgaG93IGZhciB0byByZWFkIG5leHRcbiAgICAgIC8vIEl0J3MgYWx3YXlzIDQgYnl0ZXMgbG9uZ1xuICAgICAgY29uc3QgcHJlZml4ID0gdGhpcy5yZWNlaXZlZC5zbGljZSh0aGlzLnJlYWRQb3MsIHRoaXMucmVhZFBvcyArIDQpO1xuICAgICAgaWYgKF8uaXNFbXB0eShwcmVmaXgpKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgbGV0IG1zZ0xlbmd0aDtcbiAgICAgIHRyeSB7XG4gICAgICAgIG1zZ0xlbmd0aCA9IGJ1ZmZlcnBhY2sudW5wYWNrKCdMJywgcHJlZml4KVswXTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBsb2cuZXJyb3IoYEJ1ZmZlciBjb3VsZCBub3QgdW5wYWNrOiAke2Vycn1gKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBKdW1wIGZvcndhcmQgNCBieXRlc1xuICAgICAgdGhpcy5yZWFkUG9zICs9IDQ7XG5cbiAgICAgIC8vIElzIHRoZXJlIGVub3VnaCBkYXRhIGhlcmU/XG4gICAgICAvLyBJZiBub3QsIGp1bXAgYmFjayB0byBvdXIgb3JpZ2luYWwgcG9zaXRpb24gYW5kIGd0Zm9cbiAgICAgIGlmICh0aGlzLnJlY2VpdmVkLmxlbmd0aCA8IG1zZ0xlbmd0aCArIHRoaXMucmVhZFBvcykge1xuICAgICAgICB0aGlzLnJlYWRQb3MgPSBvbGRSZWFkUG9zO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cblxuICAgICAgLy8gRXh0cmFjdCB0aGUgbWFpbiBib2R5IG9mIHRoZSBtZXNzYWdlICh3aGVyZSB0aGUgcGxpc3Qgc2hvdWxkIGJlKVxuICAgICAgY29uc3QgYm9keSA9IHRoaXMucmVjZWl2ZWQuc2xpY2UodGhpcy5yZWFkUG9zLCBtc2dMZW5ndGggKyB0aGlzLnJlYWRQb3MpO1xuXG4gICAgICAvLyBFeHRyYWN0IHRoZSBwbGlzdFxuICAgICAgbGV0IHBsaXN0O1xuICAgICAgdHJ5IHtcbiAgICAgICAgcGxpc3QgPSBicGxpc3RQYXJzZXIucGFyc2VCdWZmZXIoYm9keSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy5lcnJvcihgRXJyb3IgcGFyc2luZyBiaW5hcnkgcGxpc3Q6ICR7ZX1gKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBicGxpc3RQYXJzZXIucGFyc2VCdWZmZXIgcmV0dXJucyBhbiBhcnJheVxuICAgICAgaWYgKHBsaXN0Lmxlbmd0aCA9PT0gMSkge1xuICAgICAgICBwbGlzdCA9IHBsaXN0WzBdO1xuICAgICAgfVxuXG4gICAgICBmb3IgKGNvbnN0IGtleSBvZiBbJ1dJUk1lc3NhZ2VEYXRhS2V5JywgJ1dJUkRlc3RpbmF0aW9uS2V5JywgJ1dJUlNvY2tldERhdGFLZXknXSkge1xuICAgICAgICBpZiAoIV8uaXNVbmRlZmluZWQocGxpc3Rba2V5XSkpIHtcbiAgICAgICAgICBwbGlzdFtrZXldID0gcGxpc3Rba2V5XS50b1N0cmluZygndXRmOCcpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIEp1bXAgZm9yd2FyZCB0aGUgbGVuZ3RoIG9mIHRoZSBwbGlzdFxuICAgICAgdGhpcy5yZWFkUG9zICs9IG1zZ0xlbmd0aDtcblxuICAgICAgLy8gQ2FsY3VsYXRlIGhvdyBtdWNoIGJ1ZmZlciBpcyBsZWZ0XG4gICAgICBsZXQgbGVmdE92ZXIgPSB0aGlzLnJlY2VpdmVkLmxlbmd0aCAtIHRoaXMucmVhZFBvcztcblxuICAgICAgLy8gSXMgdGhlcmUgc29tZSBsZWZ0IG92ZXI/XG4gICAgICBpZiAobGVmdE92ZXIgIT09IDApIHtcbiAgICAgICAgLy8gQ29weSB3aGF0J3MgbGVmdCBvdmVyIGludG8gYSBuZXcgYnVmZmVyLCBhbmQgc2F2ZSBpdCBmb3IgbmV4dCB0aW1lXG4gICAgICAgIGxldCBjaHVuayA9IEJ1ZmZlci5hbGxvYyhsZWZ0T3Zlcik7XG4gICAgICAgIHRoaXMucmVjZWl2ZWQuY29weShjaHVuaywgMCwgdGhpcy5yZWFkUG9zKTtcbiAgICAgICAgdGhpcy5yZWNlaXZlZCA9IGNodW5rO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gT3RoZXJ3aXNlLCBlbXB0eSB0aGUgYnVmZmVyIGFuZCBnZXQgb3V0IG9mIHRoZSBsb29wXG4gICAgICAgIHRoaXMucmVjZWl2ZWQgPSBCdWZmZXIuYWxsb2MoMCk7XG4gICAgICAgIGRhdGFMZWZ0T3ZlciA9IGZhbHNlO1xuICAgICAgfVxuXG4gICAgICAvLyBSZXNldCB0aGUgcmVhZCBwb3NpdGlvblxuICAgICAgdGhpcy5yZWFkUG9zID0gMDtcblxuICAgICAgLy8gTm93IGRvIHNvbWV0aGluZyB3aXRoIHRoZSBwbGlzdFxuICAgICAgaWYgKHBsaXN0KSB7XG4gICAgICAgIGF3YWl0IHRoaXMubWVzc2FnZUhhbmRsZXIuaGFuZGxlTWVzc2FnZShwbGlzdCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgc2V0VGltZWxpbmVFdmVudEhhbmRsZXIgKHRpbWVsaW5lRXZlbnRIYW5kbGVyKSB7XG4gICAgdGhpcy50aW1lbGluZUV2ZW50SGFuZGxlciA9IHRpbWVsaW5lRXZlbnRIYW5kbGVyO1xuICAgIHRoaXMubWVzc2FnZUhhbmRsZXIuc2V0VGltZWxpbmVFdmVudEhhbmRsZXIodGltZWxpbmVFdmVudEhhbmRsZXIpO1xuICB9XG5cbiAgc2V0Q29uc29sZUxvZ0V2ZW50SGFuZGxlciAoY29uc29sZUV2ZW50SGFuZGxlcikge1xuICAgIHRoaXMuY29uc29sZUV2ZW50SGFuZGxlciA9IGNvbnNvbGVFdmVudEhhbmRsZXI7XG4gICAgdGhpcy5tZXNzYWdlSGFuZGxlci5zZXRDb25zb2xlTG9nRXZlbnRIYW5kbGVyKGNvbnNvbGVFdmVudEhhbmRsZXIpO1xuICB9XG5cbiAgc2V0TmV0d29ya0xvZ0V2ZW50SGFuZGxlciAobmV0d29ya0V2ZW50SGFuZGxlcikge1xuICAgIHRoaXMubmV0d29ya0V2ZW50SGFuZGxlciA9IG5ldHdvcmtFdmVudEhhbmRsZXI7XG4gICAgdGhpcy5tZXNzYWdlSGFuZGxlci5zZXROZXR3b3JrRXZlbnRIYW5kbGVyKG5ldHdvcmtFdmVudEhhbmRsZXIpO1xuICB9XG59XG4iXSwiZmlsZSI6ImxpYi9yZW1vdGUtZGVidWdnZXItcnBjLWNsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
