"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _asyncbox = require("asyncbox");

var _logger = _interopRequireDefault(require("./logger"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _installer = require("./installer");

const REQD_PARAMS = ['adb', 'appPackage', 'appActivity', 'tmpDir', 'apk', 'host', 'systemPort', 'devicePort'];

class SelendroidServer {
  constructor(opts = {}) {
    for (let req of REQD_PARAMS) {
      if (!opts || !opts[req]) {
        throw new Error(`Option '${req}' is required!`);
      }

      this[req] = opts[req];
    }

    this.modServerPkg = `selendroid.${this.appPackage}`;
    this.modServerPath = _path.default.resolve(this.tmpDir, `${this.modServerPkg}.apk`);
    this.jwproxy = new _appiumBaseDriver.JWProxy({
      server: this.host,
      port: this.systemPort
    });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
  }

  async prepareModifiedServer() {
    let needsUninstall = false;

    if (!(await _appiumSupport.fs.exists(this.modServerPath))) {
      await this.buildNewModServer();
      needsUninstall = true;
    }

    needsUninstall = (await this.checkAndSignCert(this.modServerPath)) || needsUninstall;

    if (needsUninstall) {
      _logger.default.info("New server was built, uninstalling any instances of it");

      await this.adb.uninstallApk(this.modServerPkg);
    }
  }

  async installModifiedServer() {
    let installed = await this.adb.isAppInstalled(this.modServerPkg);

    if (!installed) {
      await this.adb.install(this.modServerPath);
    }
  }

  async buildNewModServer() {
    _logger.default.info(`Repackaging selendroid for: '${this.appPackage}'`);

    let packageTmpDir = _path.default.resolve(this.tmpDir, this.appPackage);

    let newManifestPath = _path.default.resolve(this.tmpDir, 'AndroidManifest.xml');

    _logger.default.info(`Creating new manifest: '${newManifestPath}'`);

    await _appiumSupport.fs.mkdir(packageTmpDir);
    await _appiumSupport.fs.copyFile(_installer.SE_MANIFEST_PATH, newManifestPath);
    await this.adb.initAapt();
    await this.adb.compileManifest(newManifestPath, this.modServerPkg, this.appPackage);
    await this.adb.insertManifest(newManifestPath, _installer.SE_APK_PATH, this.modServerPath);

    _logger.default.info(`Repackaged selendroid ready: '${this.modServerPath}'`);
  }

  async checkAndSignCert(apk) {
    let signed = await this.adb.checkApkCert(apk, this.appPackage);

    if (!signed) {
      await this.adb.sign(apk);
    }

    return !signed;
  }

  async startSession(caps) {
    let instrumentWith = `${this.modServerPkg}/` + `io.selendroid.server.ServerInstrumentation`;

    _logger.default.info(`Starting selendroid server with instrumentation: ` + `${instrumentWith}`);

    await this.adb.instrument(this.appPackage, this.appActivity, instrumentWith);

    _logger.default.info('Waiting for Selendroid to be online...');

    await (0, _asyncbox.retryInterval)(20, 1000, async () => {
      await this.jwproxy.command('/status', 'GET');
    });
    await this.jwproxy.command('/session', 'POST', {
      desiredCapabilities: caps
    });
  }

  async deleteSession() {
    _logger.default.debug('Deleting Selendroid server session');

    try {
      await this.jwproxy.command('/', 'DELETE');
    } catch (err) {
      _logger.default.warn(`Did not get confirmation Selendroid deleteSession worked; ` + `Error was: ${err}`);
    }
  }

}

var _default = SelendroidServer;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zZWxlbmRyb2lkLmpzIl0sIm5hbWVzIjpbIlJFUURfUEFSQU1TIiwiU2VsZW5kcm9pZFNlcnZlciIsImNvbnN0cnVjdG9yIiwib3B0cyIsInJlcSIsIkVycm9yIiwibW9kU2VydmVyUGtnIiwiYXBwUGFja2FnZSIsIm1vZFNlcnZlclBhdGgiLCJwYXRoIiwicmVzb2x2ZSIsInRtcERpciIsImp3cHJveHkiLCJKV1Byb3h5Iiwic2VydmVyIiwiaG9zdCIsInBvcnQiLCJzeXN0ZW1Qb3J0IiwicHJveHlSZXFSZXMiLCJiaW5kIiwicHJlcGFyZU1vZGlmaWVkU2VydmVyIiwibmVlZHNVbmluc3RhbGwiLCJmcyIsImV4aXN0cyIsImJ1aWxkTmV3TW9kU2VydmVyIiwiY2hlY2tBbmRTaWduQ2VydCIsImxvZ2dlciIsImluZm8iLCJhZGIiLCJ1bmluc3RhbGxBcGsiLCJpbnN0YWxsTW9kaWZpZWRTZXJ2ZXIiLCJpbnN0YWxsZWQiLCJpc0FwcEluc3RhbGxlZCIsImluc3RhbGwiLCJwYWNrYWdlVG1wRGlyIiwibmV3TWFuaWZlc3RQYXRoIiwibWtkaXIiLCJjb3B5RmlsZSIsIlNFX01BTklGRVNUX1BBVEgiLCJpbml0QWFwdCIsImNvbXBpbGVNYW5pZmVzdCIsImluc2VydE1hbmlmZXN0IiwiU0VfQVBLX1BBVEgiLCJhcGsiLCJzaWduZWQiLCJjaGVja0Fwa0NlcnQiLCJzaWduIiwic3RhcnRTZXNzaW9uIiwiY2FwcyIsImluc3RydW1lbnRXaXRoIiwiaW5zdHJ1bWVudCIsImFwcEFjdGl2aXR5IiwiY29tbWFuZCIsImRlc2lyZWRDYXBhYmlsaXRpZXMiLCJkZWxldGVTZXNzaW9uIiwiZGVidWciLCJlcnIiLCJ3YXJuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLFdBQVcsR0FBRyxDQUNsQixLQURrQixFQUNYLFlBRFcsRUFDRyxhQURILEVBQ2tCLFFBRGxCLEVBQzRCLEtB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RUFBMEIsUUFBMUIsQ0FBTjtBQUNELEtBRkQsQ0FFRSxPQUFPSSxHQUFQLEVBQVk7QUFDWjlCLHNCQUFPK0IsSUFBUCxDQUFhLDREQUFELEdBQ0MsY0FBYUQsR0FBSSxFQUQ5QjtBQUVEO0FBQ0Y7O0FBMUZvQjs7ZUE2RlJ2RCxnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEpXUHJveHkgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IFNFX0FQS19QQVRILCBTRV9NQU5JRkVTVF9QQVRIIH0gZnJvbSAnLi9pbnN0YWxsZXInO1xuXG5cbmNvbnN0IFJFUURfUEFSQU1TID0gW1xuICAnYWRiJywgJ2FwcFBhY2thZ2UnLCAnYXBwQWN0aXZpdHknLCAndG1wRGlyJywgJ2FwaycsICdob3N0JywgJ3N5c3RlbVBvcnQnLFxuICAnZGV2aWNlUG9ydCcsXG5dO1xuXG5jbGFzcyBTZWxlbmRyb2lkU2VydmVyIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIGZvciAobGV0IHJlcSBvZiBSRVFEX1BBUkFNUykge1xuICAgICAgaWYgKCFvcHRzIHx8ICFvcHRzW3JlcV0pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBPcHRpb24gJyR7cmVxfScgaXMgcmVxdWlyZWQhYCk7XG4gICAgICB9XG4gICAgICB0aGlzW3JlcV0gPSBvcHRzW3JlcV07XG4gICAgfVxuXG4gICAgLy8gbmV3IHBhY2thZ2UgbmFtZSBmb3IgcmVwYWNrYWdlZCBzZWxlbmRyb2lkIHNlcnZlclxuICAgIHRoaXMubW9kU2VydmVyUGtnID0gYHNlbGVuZHJvaWQuJHt0aGlzLmFwcFBhY2thZ2V9YDtcbiAgICAvLyBwYXRoIHRvIHRoZSByZXBhY2thZ2VkIHNlbGVuZHJvaWQgc2VydmVyIHNwZWNpZmljIHRvIHRoaXMgYXBwXG4gICAgdGhpcy5tb2RTZXJ2ZXJQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMudG1wRGlyLCBgJHt0aGlzLm1vZFNlcnZlclBrZ30uYXBrYCk7XG4gICAgdGhpcy5qd3Byb3h5ID0gbmV3IEpXUHJveHkoe3NlcnZlcjogdGhpcy5ob3N0LCBwb3J0OiB0aGlzLnN5c3RlbVBvcnR9KTtcbiAgICB0aGlzLnByb3h5UmVxUmVzID0gdGhpcy5qd3Byb3h5LnByb3h5UmVxUmVzLmJpbmQodGhpcy5qd3Byb3h5KTtcbiAgfVxuXG4gIGFzeW5jIHByZXBhcmVNb2RpZmllZFNlcnZlciAoKSB7XG4gICAgLy8gVE9ETyBtaWdodCBoYXZlIGEgcmFjZSBjb25kaXRpb24gaWYgd2UgdHJ5IGJ1aWxkaW5nIHRoaXMgd2l0aCBtdWx0aXBsZVxuICAgIC8vIHNlc3Npb25zIGF0IHRoZSBzYW1lIHRpbWUuIE9UT0ggd2UgcHJvYmFibHkgd2FudCB0byBzaGFyZSB0aGUgbW9kXG4gICAgLy8gc2VydmVyLi4uXG4gICAgbGV0IG5lZWRzVW5pbnN0YWxsID0gZmFsc2U7XG4gICAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKHRoaXMubW9kU2VydmVyUGF0aCkpKSB7XG4gICAgICBhd2FpdCB0aGlzLmJ1aWxkTmV3TW9kU2VydmVyKCk7XG4gICAgICBuZWVkc1VuaW5zdGFsbCA9IHRydWU7XG4gICAgfVxuICAgIG5lZWRzVW5pbnN0YWxsID0gYXdhaXQgdGhpcy5jaGVja0FuZFNpZ25DZXJ0KHRoaXMubW9kU2VydmVyUGF0aCkgfHwgbmVlZHNVbmluc3RhbGw7XG4gICAgaWYgKG5lZWRzVW5pbnN0YWxsKSB7XG4gICAgICBsb2dnZXIuaW5mbyhcIk5ldyBzZXJ2ZXIgd2FzIGJ1aWx0LCB1bmluc3RhbGxpbmcgYW55IGluc3RhbmNlcyBvZiBpdFwiKTtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnVuaW5zdGFsbEFwayh0aGlzLm1vZFNlcnZlclBrZyk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgaW5zdGFsbE1vZGlmaWVkU2VydmVyICgpIHtcbiAgICBsZXQgaW5zdGFsbGVkID0gYXdhaXQgdGhpcy5hZGIuaXNBcHBJbnN0YWxsZWQodGhpcy5tb2RTZXJ2ZXJQa2cpO1xuICAgIGlmICghaW5zdGFsbGVkKSB7XG4gICAgICBhd2FpdCB0aGlzLmFkYi5pbnN0YWxsKHRoaXMubW9kU2VydmVyUGF0aCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgYnVpbGROZXdNb2RTZXJ2ZXIgKCkge1xuICAgIGxvZ2dlci5pbmZvKGBSZXBhY2thZ2luZyBzZWxlbmRyb2lkIGZvcjogJyR7dGhpcy5hcHBQYWNrYWdlfSdgKTtcbiAgICBsZXQgcGFja2FnZVRtcERpciA9IHBhdGgucmVzb2x2ZSh0aGlzLnRtcERpciwgdGhpcy5hcHBQYWNrYWdlKTtcbiAgICBsZXQgbmV3TWFuaWZlc3RQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMudG1wRGlyLCAnQW5kcm9pZE1hbmlmZXN0LnhtbCcpO1xuICAgIGxvZ2dlci5pbmZvKGBDcmVhdGluZyBuZXcgbWFuaWZlc3Q6ICcke25ld01hbmlmZXN0UGF0aH0nYCk7XG4gICAgYXdhaXQgZnMubWtkaXIocGFja2FnZVRtcERpcik7XG4gICAgYXdhaXQgZnMuY29weUZpbGUoU0VfTUFOSUZFU1RfUEFUSCwgbmV3TWFuaWZlc3RQYXRoKTtcbiAgICBhd2FpdCB0aGlzLmFkYi5pbml0QWFwdCgpOyAvLyBUT0RPIHRoaXMgc2hvdWxkIGJlIGludGVybmFsIHRvIGFkYlxuICAgIGF3YWl0IHRoaXMuYWRiLmNvbXBpbGVNYW5pZmVzdChuZXdNYW5pZmVzdFBhdGgsIHRoaXMubW9kU2VydmVyUGtnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcFBhY2thZ2UpO1xuICAgIGF3YWl0IHRoaXMuYWRiLmluc2VydE1hbmlmZXN0KG5ld01hbmlmZXN0UGF0aCwgU0VfQVBLX1BBVEgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RTZXJ2ZXJQYXRoKTtcbiAgICBsb2dnZXIuaW5mbyhgUmVwYWNrYWdlZCBzZWxlbmRyb2lkIHJlYWR5OiAnJHt0aGlzLm1vZFNlcnZlclBhdGh9J2ApO1xuICB9XG5cbiAgYXN5bmMgY2hlY2tBbmRTaWduQ2VydCAoYXBrKSB7XG4gICAgbGV0IHNpZ25lZCA9IGF3YWl0IHRoaXMuYWRiLmNoZWNrQXBrQ2VydChhcGssIHRoaXMuYXBwUGFja2FnZSk7XG4gICAgaWYgKCFzaWduZWQpIHtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnNpZ24oYXBrKTtcbiAgICB9XG5cbiAgICAvLyByZXR1cm4gd2hldGhlciB0aGUgYXBrIHdhcyBzaWduZWRcbiAgICByZXR1cm4gIXNpZ25lZDtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0U2Vzc2lvbiAoY2Fwcykge1xuICAgIGxldCBpbnN0cnVtZW50V2l0aCA9IGAke3RoaXMubW9kU2VydmVyUGtnfS9gICtcbiAgICAgICAgICAgICAgICAgICAgICAgICBgaW8uc2VsZW5kcm9pZC5zZXJ2ZXIuU2VydmVySW5zdHJ1bWVudGF0aW9uYDtcbiAgICBsb2dnZXIuaW5mbyhgU3RhcnRpbmcgc2VsZW5kcm9pZCBzZXJ2ZXIgd2l0aCBpbnN0cnVtZW50YXRpb246IGAgK1xuICAgICAgICAgICAgIGAke2luc3RydW1lbnRXaXRofWApO1xuICAgIGF3YWl0IHRoaXMuYWRiLmluc3RydW1lbnQodGhpcy5hcHBQYWNrYWdlLCB0aGlzLmFwcEFjdGl2aXR5LCBpbnN0cnVtZW50V2l0aCk7XG5cbiAgICBsb2dnZXIuaW5mbygnV2FpdGluZyBmb3IgU2VsZW5kcm9pZCB0byBiZSBvbmxpbmUuLi4nKTtcbiAgICAvLyB3YWl0IDIwcyBmb3IgU2VsZW5kcm9pZCB0byBiZSBvbmxpbmVcbiAgICBhd2FpdCByZXRyeUludGVydmFsKDIwLCAxMDAwLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnL3Nlc3Npb24nLCAnUE9TVCcsIHtkZXNpcmVkQ2FwYWJpbGl0aWVzOiBjYXBzfSk7XG4gIH1cblxuICBhc3luYyBkZWxldGVTZXNzaW9uICgpIHtcbiAgICBsb2dnZXIuZGVidWcoJ0RlbGV0aW5nIFNlbGVuZHJvaWQgc2VydmVyIHNlc3Npb24nKTtcbiAgICAvLyByZWx5IG9uIGp3cHJveHkncyBpbnRlbGxpZ2VuY2UgdG8ga25vdyB3aGF0IHdlJ3JlIHRhbGtpbmcgYWJvdXQgYW5kXG4gICAgLy8gZGVsZXRlIHRoZSBjdXJyZW50IHNlc3Npb25cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy8nLCAnREVMRVRFJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIud2FybihgRGlkIG5vdCBnZXQgY29uZmlybWF0aW9uIFNlbGVuZHJvaWQgZGVsZXRlU2Vzc2lvbiB3b3JrZWQ7IGAgK1xuICAgICAgICAgICAgICAgICAgYEVycm9yIHdhczogJHtlcnJ9YCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFNlbGVuZHJvaWRTZXJ2ZXI7XG4iXSwiZmlsZSI6ImxpYi9zZWxlbmRyb2lkLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
