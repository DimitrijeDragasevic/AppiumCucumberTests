"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _utf = _interopRequireDefault(require("utf7"));

var _appiumAndroidDriver = require("appium-android-driver");

var _driver = require("./driver");

const {
  imap
} = _utf.default;
let extensions = {},
    commands = {},
    helpers = {};

commands.launchApp = async function () {
  await this.startSelendroidSession();
};

commands.reset = async function () {
  _logger.default.debug("Running generic full reset");

  let oldImpWait = this.implicitWaitMs;
  let oldCommandTimeoutMs = this.commandTimeoutMs;
  let oldSessionId = this.sessionId;
  await this.deleteSession();

  _logger.default.debug("Restarting app");

  await this.startSelendroidSession();
  this.implicitWait(oldImpWait);
  this.timeouts('command', oldCommandTimeoutMs);
  this.sessionId = oldSessionId;
};

commands.performMultiAction = async function (elId, actions) {
  if (elId) {
    throw new Error("Selendroid actions do not support element id");
  }

  return await this.selendroid.jwproxy.command('/action', 'POST', {
    payload: actions
  });
};

function encodeString(value, unicode) {
  for (let i = 0; i < value.length; i++) {
    let c = value.charCodeAt(i);

    if (unicode && (c > 127 || c === 38)) {
      if (c >= parseInt("E000", 16) && c <= parseInt("E040", 16)) {} else {
        value = imap.encode(value);
        break;
      }
    }
  }

  return value;
}

commands.setValue = async function (value, elementId) {
  if (value instanceof Array) {
    value = value.join("");
  }

  _logger.default.debug(`Setting text on element '${elementId}': '${value}'`);

  value = encodeString(value, this.opts.unicodeKeyboard);
  await this.selendroid.jwproxy.command(`/element/${elementId}/value`, 'POST', {
    value: [value]
  });
};

commands.getElementRect = async function (elementId) {
  const location = await this.selendroid.jwproxy.command(`/element/${elementId}/location`, 'GET');
  const size = await this.selendroid.jwproxy.command(`/element/${elementId}/size`, 'GET');
  return Object.assign(location, size);
};

commands.keys = async function (value) {
  if (value instanceof Array) {
    value = value.join("");
  }

  _logger.default.debug(`Setting text: '${value}'`);

  value = encodeString(value, this.opts.unicodeKeyboard);
  await this.selendroid.jwproxy.command('/keys', 'POST', {
    value: [value]
  });
};

commands.keyevent = async function (keycode, metastate) {
  _logger.default.debug(`Ignoring metastate ${metastate}`);

  await this.adb.keyevent(keycode);
};

commands.back = async function () {
  await this.adb.keyevent(4);
};

commands.getContexts = async function () {
  let chromiumViews = [];
  let webviews = await _appiumAndroidDriver.webviewHelpers.getWebviews(this.adb, this.opts.androidDeviceSocket);

  if (_lodash.default.includes(webviews, _appiumAndroidDriver.CHROMIUM_WIN)) {
    chromiumViews = [_appiumAndroidDriver.CHROMIUM_WIN];
  } else {
    chromiumViews = [];
  }

  _logger.default.info('Getting window handles from Selendroid');

  let selendroidViews = await this.selendroid.jwproxy.command('/window_handles', 'GET', {});
  this.contexts = _lodash.default.union(selendroidViews, chromiumViews);

  _logger.default.info(`Available contexts: ${JSON.stringify(this.contexts)}`);

  return this.contexts;
};

helpers.switchContext = async function (name) {
  await this.selendroid.jwproxy.command('/window', 'POST', {
    name
  });
};

helpers.isChromedriverContext = function (windowName) {
  return windowName === _appiumAndroidDriver.CHROMIUM_WIN;
};

helpers.wrapBootstrapDisconnect = async function (wrapped) {
  await wrapped();
  await this.adb.restart();
  await this.adb.forwardPort(this.opts.systemPort, _driver.DEVICE_PORT);
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy5qcyJdLCJuYW1lcyI6WyJpbWFwIiwidXRmNyIsImV4dGVuc2lvbnMiLCJjb21tYW5kcyIsImhlbHBlcnMiLCJsYXVuY2hBcHAiLCJzdGFydFNlbGVuZHJvaWRTZXNzaW9uIiwicmVzZXQiLCJsb2ciLCJkZWJ1ZyIsIm9sZEltcFdhaXQiLCJpbXBsaWNpdFdhaXRNcyIsIm9sZENvbW1hbmRUaW1lb3V0TXMiLCJjb21tYW5kVGltZW91dE1zIiwib2xkU2Vzc2lvbklkIiwic2Vzc2lvbklkIiwiZGVsZXRlU2Vzc2lvbiIsImltcGxpY2l0V2FpdCIsInRpbWVvdXRzIiwicGVyZm9ybU11bHRpQWN0aW9uIiwiZWxJZCIsImFjdGlvbnMiLCJFcnJvciIsInNlbGVuZHJvaWQiLCJqd3Byb3h5IiwiY29tbWFuZCIsInBheWxvYWQiLCJlbmNvZGVTdHJpbmciLCJ2YWx1ZSIsInVuaWNvZGUiLCJpIiwibGVuZ3RoIiwiYyIsImNoYXJDb2RlQXQiLCJwYXJzZUludCIsImVuY29kZSIsInNldFZhbHVlIiwiZWxlbWVudElkIiwiQXJyYXkiLCJqb2luIiwib3B0cyIsInVuaWNvZGVLZXlib2FyZCIsImdldEVsZW1lbnRSZWN0IiwibG9jYXRpb24iLCJzaXplIiwiT2JqZWN0IiwiYXNzaWduIiwia2V5cyIsImtleWV2ZW50Iiwia2V5Y29kZSIsIm1ldGFzdGF0ZSIsImFkYiIsImJhY2siLCJnZXRDb250ZXh0cyIsImNocm9taXVtVmlld3MiLCJ3ZWJ2aWV3cyIsIndlYnZpZXdIZWxwZXJzIiwiZ2V0V2Vidmlld3MiLCJhbmRyb2lkRGV2aWNlU29ja2V0IiwiXyIsImluY2x1ZGVzIiwiQ0hST01JVU1fV0lOIiwiaW5mbyIsInNlbGVuZHJvaWRWaWV3cyIsImNvbnRleHRzIiwidW5pb24iLCJKU09OIiwic3RyaW5naWZ5Iiwic3dpdGNoQ29udGV4dCIsIm5hbWUiLCJpc0Nocm9tZWRyaXZlckNvbnRleHQiLCJ3aW5kb3dOYW1lIiwid3JhcEJvb3RzdHJhcERpc2Nvbm5lY3QiLCJ3cmFwcGVkIiwicmVzdGFydCIsImZvcndhcmRQb3J0Iiwic3lzdGVtUG9ydCIsIkRFVklDRV9QT1JUIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU07QUFBQ0EsRUFBQUE7QUFBRCxJQUFTQyxZQUFmO0FBRUEsSUFBSUMsVUFBVSxHQUFHLEVBQWpCO0FBQUEsSUFDSUMsUUFBUSxHQUFHLEVBRGY7QUFBQSxJQUVJQyxPQUFPLEdBQUcsRUFGZDs7QUFJQUQsUUFBUSxDQUFDRSxTQUFULEdBQXFCLGtCQUFrQjtBQUNyQyxRQUFNLEtBQUtDLHNCQUFMLEVBQU47QUFDRCxDQUZEOztBQUdBSCxRQUFRLENBQUNJLEtBQVQsR0FBaUIsa0JBQWtCO0FBQ2pDQyxrQkFBSUMsS0FBSixDQUFVLDRCQUFWOztBQUNBLE1BQUlDLFVBQVUsR0FBRyxLQUFLQyxjQUF0QjtBQUNBLE1BQUlDLG1CQUFtQixHQUFHLEtBQUtDLGdCQUEvQjtBQUNBLE1BQUlDLFlBQVksR0FBRyxLQUFLQyxTQUF4QjtBQUVBLFFBQU0sS0FBS0MsYUFBTCxFQUFOOztBQUNBUixrQkFBSUMsS0FBSixDQUFVLGdCQUFWOztBQUNBLFFBQU0sS0FBS0gsc0JBQUwsRUFBTjtBQUNBLE9BQUtXLFlBQUwsQ0FBa0JQLFVBQWxCO0FBQ0EsT0FBS1EsUUFBTCxDQUFjLFNBQWQsRUFBeUJOLG1CQUF6QjtBQUNBLE9BQUtHLFNBQUwsR0FBaUJELFlBQWpCO0FBQ0QsQ0FaRDs7QUFjQVgsUUFBUSxDQUFDZ0Isa0JBQVQsR0FBOEIsZ0JBQWdCQyxJQUFoQixFQUFzQkMsT0FBdEIsRUFBK0I7QUFDM0QsTUFBSUQsSUFBSixFQUFVO0FBQ1IsVUFBTSxJQUFJRSxLQUFKLENBQVUsOENBQVYsQ0FBTjtBQUNEOztBQUNELFNBQU8sTUFBTSxLQUFLQyxVQUFMLENBQWdCQyxPQUFoQixDQUF3QkMsT0FBeEIsQ0FBZ0MsU0FBaEMsRUFBMkMsTUFBM0MsRUFBbUQ7QUFBQ0MsSUFB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QUFoQyxFQUEyQyxNQUEzQyxFQUFtRDtBQUFDNEMsSUFBQUE7QUFBRCxHQUFuRCxDQUFOO0FBQ0QsQ0FIRDs7QUFLQWpFLE9BQU8sQ0FBQ2tFLHFCQUFSLEdBQWdDLFVBQVVDLFVBQVYsRUFBc0I7QUFDcEQsU0FBT0EsVUFBVSxLQUFLVixpQ0FBdEI7QUFDRCxDQUZEOztBQU9BekQsT0FBTyxDQUFDb0UsdUJBQVIsR0FBa0MsZ0JBQWdCQyxPQUFoQixFQUF5QjtBQUN6RCxRQUFNQSxPQUFPLEVBQWI7QUFDQSxRQUFNLEtBQUt0QixHQUFMLENBQVN1QixPQUFULEVBQU47QUFDQSxRQUFNLEtBQUt2QixHQUFMLENBQVN3QixXQUFULENBQXFCLEtBQUtuQyxJQUFMLENBQVVvQyxVQUEvQixFQUEyQ0MsbUJBQTNDLENBQU47QUFDRCxDQUpEOztBQU1BaEMsTUFBTSxDQUFDQyxNQUFQLENBQWM1QyxVQUFkLEVBQTBCQyxRQUExQixFQUFvQ0MsT0FBcEM7ZUFFZUYsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB1dGY3IGZyb20gJ3V0ZjcnO1xuaW1wb3J0IHsgd2Vidmlld0hlbHBlcnMsIENIUk9NSVVNX1dJTiB9IGZyb20gJ2FwcGl1bS1hbmRyb2lkLWRyaXZlcic7XG5pbXBvcnQgeyBERVZJQ0VfUE9SVCB9IGZyb20gJy4vZHJpdmVyJztcblxuY29uc3Qge2ltYXB9ID0gdXRmNztcblxubGV0IGV4dGVuc2lvbnMgPSB7fSxcbiAgICBjb21tYW5kcyA9IHt9LFxuICAgIGhlbHBlcnMgPSB7fTtcblxuY29tbWFuZHMubGF1bmNoQXBwID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBhd2FpdCB0aGlzLnN0YXJ0U2VsZW5kcm9pZFNlc3Npb24oKTtcbn07XG5jb21tYW5kcy5yZXNldCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbG9nLmRlYnVnKFwiUnVubmluZyBnZW5lcmljIGZ1bGwgcmVzZXRcIik7XG4gIGxldCBvbGRJbXBXYWl0ID0gdGhpcy5pbXBsaWNpdFdhaXRNcztcbiAgbGV0IG9sZENvbW1hbmRUaW1lb3V0TXMgPSB0aGlzLmNvbW1hbmRUaW1lb3V0TXM7XG4gIGxldCBvbGRTZXNzaW9uSWQgPSB0aGlzLnNlc3Npb25JZDtcblxuICBhd2FpdCB0aGlzLmRlbGV0ZVNlc3Npb24oKTtcbiAgbG9nLmRlYnVnKFwiUmVzdGFydGluZyBhcHBcIik7XG4gIGF3YWl0IHRoaXMuc3RhcnRTZWxlbmRyb2lkU2Vzc2lvbigpO1xuICB0aGlzLmltcGxpY2l0V2FpdChvbGRJbXBXYWl0KTtcbiAgdGhpcy50aW1lb3V0cygnY29tbWFuZCcsIG9sZENvbW1hbmRUaW1lb3V0TXMpO1xuICB0aGlzLnNlc3Npb25JZCA9IG9sZFNlc3Npb25JZDtcbn07XG5cbmNvbW1hbmRzLnBlcmZvcm1NdWx0aUFjdGlvbiA9IGFzeW5jIGZ1bmN0aW9uIChlbElkLCBhY3Rpb25zKSB7XG4gIGlmIChlbElkKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiU2VsZW5kcm9pZCBhY3Rpb25zIGRvIG5vdCBzdXBwb3J0IGVsZW1lbnQgaWRcIik7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IHRoaXMuc2VsZW5kcm9pZC5qd3Byb3h5LmNvbW1hbmQoJy9hY3Rpb24nLCAnUE9TVCcsIHtwYXlsb2FkOiBhY3Rpb25zfSk7XG59O1xuXG5mdW5jdGlvbiBlbmNvZGVTdHJpbmcgKHZhbHVlLCB1bmljb2RlKSB7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWUubGVuZ3RoOyBpKyspIHtcbiAgICBsZXQgYyA9IHZhbHVlLmNoYXJDb2RlQXQoaSk7XG4gICAgLy8gaWYgd2UncmUgdXNpbmcgdGhlIHVuaWNvZGUga2V5Ym9hcmQsIGFuZCB0aGlzIGlzIHVuaWNvZGUsIG1heWJlIGVuY29kZVxuICAgIGlmICh1bmljb2RlICYmIChjID4gMTI3IHx8IGMgPT09IDM4KSkge1xuICAgICAgLy8gdGhpcyBpcyBub3Qgc2ltcGxlIGFzY2lpLCBvciBpdCBpcyBhbiBhbXBlcnNhbmQgKGAmYClcbiAgICAgIGlmIChjID49IHBhcnNlSW50KFwiRTAwMFwiLCAxNikgJiYgYyA8PSBwYXJzZUludChcIkUwNDBcIiwgMTYpKSB7XG4gICAgICAgIC8vIFNlbGVuaXVtIHVzZXMgYSBVbmljb2RlIFBVQSB0byBjb3ZlciBjZXJ0YWluIHNwZWNpYWwgY2hhcmFjdGVyc1xuICAgICAgICAvLyBzZWUgaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9zZWxlbml1bS9zb3VyY2UvYnJvd3NlL2phdmEvY2xpZW50L3NyYy9vcmcvb3BlbnFhL3NlbGVuaXVtL0tleXMuamF2YVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gZW5jb2RlIHRoZSB0ZXh0XG4gICAgICAgIHZhbHVlID0gaW1hcC5lbmNvZGUodmFsdWUpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIHZhbHVlO1xufVxuXG4vLyBOZWVkIHRvIG92ZXJyaWRlIHRoaXMgZm9yIGNvcnJlY3QgdW5pY29kZSBzdXBwb3J0XG5jb21tYW5kcy5zZXRWYWx1ZSA9IGFzeW5jIGZ1bmN0aW9uICh2YWx1ZSwgZWxlbWVudElkKSB7XG4gIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgdmFsdWUgPSB2YWx1ZS5qb2luKFwiXCIpO1xuICB9XG4gIGxvZy5kZWJ1ZyhgU2V0dGluZyB0ZXh0IG9uIGVsZW1lbnQgJyR7ZWxlbWVudElkfSc6ICcke3ZhbHVlfSdgKTtcbiAgdmFsdWUgPSBlbmNvZGVTdHJpbmcodmFsdWUsIHRoaXMub3B0cy51bmljb2RlS2V5Ym9hcmQpO1xuICBhd2FpdCB0aGlzLnNlbGVuZHJvaWQuandwcm94eS5jb21tYW5kKGAvZWxlbWVudC8ke2VsZW1lbnRJZH0vdmFsdWVgLCAnUE9TVCcsIHt2YWx1ZTogW3ZhbHVlXX0pO1xufTtcblxuLy8gVGhpcyBpcyBuZWVkZWQgdG8gc2F0aXNmeSB1cGRhdGVkIFdlYkVsZW1lbnQgaW50ZXJmYWNlIGluIFNlbGVuaXVtIDNcbmNvbW1hbmRzLmdldEVsZW1lbnRSZWN0ID0gYXN5bmMgZnVuY3Rpb24gKGVsZW1lbnRJZCkge1xuICBjb25zdCBsb2NhdGlvbiA9IGF3YWl0IHRoaXMuc2VsZW5kcm9pZC5qd3Byb3h5LmNvbW1hbmQoYC9lbGVtZW50LyR7ZWxlbWVudElkfS9sb2NhdGlvbmAsICdHRVQnKTtcbiAgY29uc3Qgc2l6ZSA9IGF3YWl0IHRoaXMuc2VsZW5kcm9pZC5qd3Byb3h5LmNvbW1hbmQoYC9lbGVtZW50LyR7ZWxlbWVudElkfS9zaXplYCwgJ0dFVCcpO1xuICByZXR1cm4gT2JqZWN0LmFzc2lnbihsb2NhdGlvbiwgc2l6ZSk7XG59O1xuXG4vLyBOZWVkIHRvIG92ZXJyaWRlIHRoaXMgZm9yIGNvcnJlY3QgdW5pY29kZSBzdXBwb3J0XG5jb21tYW5kcy5rZXlzID0gYXN5bmMgZnVuY3Rpb24gKHZhbHVlKSB7XG4gIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgdmFsdWUgPSB2YWx1ZS5qb2luKFwiXCIpO1xuICB9XG4gIGxvZy5kZWJ1ZyhgU2V0dGluZyB0ZXh0OiAnJHt2YWx1ZX0nYCk7XG4gIHZhbHVlID0gZW5jb2RlU3RyaW5nKHZhbHVlLCB0aGlzLm9wdHMudW5pY29kZUtleWJvYXJkKTtcbiAgYXdhaXQgdGhpcy5zZWxlbmRyb2lkLmp3cHJveHkuY29tbWFuZCgnL2tleXMnLCAnUE9TVCcsIHt2YWx1ZTogW3ZhbHVlXX0pO1xufTtcblxuLy8gU2VsZW5kcm9pZCBkb2Vzbid0IHN1cHBvcnQgbWV0YXN0YXRlIGZvciBrZXlldmVudHNcbmNvbW1hbmRzLmtleWV2ZW50ID0gYXN5bmMgZnVuY3Rpb24gKGtleWNvZGUsIG1ldGFzdGF0ZSkge1xuICBsb2cuZGVidWcoYElnbm9yaW5nIG1ldGFzdGF0ZSAke21ldGFzdGF0ZX1gKTtcbiAgYXdhaXQgdGhpcy5hZGIua2V5ZXZlbnQoa2V5Y29kZSk7XG59O1xuXG4vLyBVc2UgQURCIHNpbmNlIHdlIGRvbid0IGhhdmUgVWlBdXRvbWF0b3JcbmNvbW1hbmRzLmJhY2sgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGF3YWl0IHRoaXMuYWRiLmtleWV2ZW50KDQpO1xufTtcblxuY29tbWFuZHMuZ2V0Q29udGV4dHMgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxldCBjaHJvbWl1bVZpZXdzID0gW107XG4gIGxldCB3ZWJ2aWV3cyA9IGF3YWl0IHdlYnZpZXdIZWxwZXJzLmdldFdlYnZpZXdzKHRoaXMuYWRiLFxuICAgICAgdGhpcy5vcHRzLmFuZHJvaWREZXZpY2VTb2NrZXQpO1xuICBpZiAoXy5pbmNsdWRlcyh3ZWJ2aWV3cywgQ0hST01JVU1fV0lOKSkge1xuICAgIGNocm9taXVtVmlld3MgPSBbQ0hST01JVU1fV0lOXTtcbiAgfSBlbHNlIHtcbiAgICBjaHJvbWl1bVZpZXdzID0gW107XG4gIH1cblxuICBsb2cuaW5mbygnR2V0dGluZyB3aW5kb3cgaGFuZGxlcyBmcm9tIFNlbGVuZHJvaWQnKTtcbiAgbGV0IHNlbGVuZHJvaWRWaWV3cyA9IGF3YWl0IHRoaXMuc2VsZW5kcm9pZC5qd3Byb3h5LmNvbW1hbmQoJy93aW5kb3dfaGFuZGxlcycsICdHRVQnLCB7fSk7XG4gIHRoaXMuY29udGV4dHMgPSBfLnVuaW9uKHNlbGVuZHJvaWRWaWV3cywgY2hyb21pdW1WaWV3cyk7XG4gIGxvZy5pbmZvKGBBdmFpbGFibGUgY29udGV4dHM6ICR7SlNPTi5zdHJpbmdpZnkodGhpcy5jb250ZXh0cyl9YCk7XG4gIHJldHVybiB0aGlzLmNvbnRleHRzO1xufTtcblxuaGVscGVycy5zd2l0Y2hDb250ZXh0ID0gYXN5bmMgZnVuY3Rpb24gKG5hbWUpIHtcbiAgLy8gY2FsbGVkIHdoZW4gc2V0dGluZyBjb250ZXh0XG4gIGF3YWl0IHRoaXMuc2VsZW5kcm9pZC5qd3Byb3h5LmNvbW1hbmQoJy93aW5kb3cnLCAnUE9TVCcsIHtuYW1lfSk7XG59O1xuXG5oZWxwZXJzLmlzQ2hyb21lZHJpdmVyQ29udGV4dCA9IGZ1bmN0aW9uICh3aW5kb3dOYW1lKSB7XG4gIHJldHVybiB3aW5kb3dOYW1lID09PSBDSFJPTUlVTV9XSU47XG59O1xuXG4vLyBOZWVkIHRvIG92ZXJyaWRlIGFuZHJvaWQtZHJpdmVyJ3MgdmVyc2lvbiBvZiB0aGlzIHNpbmNlIHdlIGRvbid0IGFjdHVhbGx5XG4vLyBoYXZlIGEgYm9vdHN0cmFwOyBpbnN0ZWFkIHdlIGp1c3QgcmVzdGFydCBhZGIgYW5kIHJlLWZvcndhcmQgdGhlIFNlbGVuZHJvaWRcbi8vIHBvcnRcbmhlbHBlcnMud3JhcEJvb3RzdHJhcERpc2Nvbm5lY3QgPSBhc3luYyBmdW5jdGlvbiAod3JhcHBlZCkge1xuICBhd2FpdCB3cmFwcGVkKCk7XG4gIGF3YWl0IHRoaXMuYWRiLnJlc3RhcnQoKTtcbiAgYXdhaXQgdGhpcy5hZGIuZm9yd2FyZFBvcnQodGhpcy5vcHRzLnN5c3RlbVBvcnQsIERFVklDRV9QT1JUKTtcbn07XG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMsIGhlbHBlcnMpO1xuXG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
