"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setupSelendroid = setupSelendroid;
exports.serverExists = serverExists;
exports.SE_MANIFEST_PATH = exports.SE_APK_PATH = void 0;

require("source-map-support/register");

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _fancyLog = _interopRequireDefault(require("fancy-log"));

var _crypto = _interopRequireDefault(require("crypto"));

const SE_VER = "0.17.0";
const SE_DOWNLOAD_CDNURL = process.env.npm_config_selendroid_driver_cdnurl || process.env.SELENDROID_DRIVER_CDNURL || "https://repo1.maven.org/maven2/io/selendroid/selendroid-standalone";
const SE_DOWNLOAD = `${SE_DOWNLOAD_CDNURL}/${SE_VER}/selendroid-standalone-${SE_VER}-with-dependencies.jar`;
const SE_DOWNLOAD_SHA256 = "7cf7163ac47f1c46eff95b62f78b58c1dabdec534acc6632da3784739f6e9d82";

const SE_DIR = _path.default.resolve(__dirname, "..", "..", "selendroid");

const SE_DOWNLOAD_DIR = _path.default.resolve(SE_DIR, "download");

const SE_JAR_PATH_TMP = _path.default.resolve(SE_DOWNLOAD_DIR, "selendroid-server.jar.tmp");

const SE_JAR_PATH = _path.default.resolve(SE_DOWNLOAD_DIR, `selendroid-server-${SE_DOWNLOAD_SHA256}.jar`);

const SE_APK_PATH = _path.default.resolve(SE_DIR, "selendroid-server.apk");

exports.SE_APK_PATH = SE_APK_PATH;

const SE_MANIFEST_PATH = _path.default.resolve(SE_DIR, "AndroidManifest.xml");

exports.SE_MANIFEST_PATH = SE_MANIFEST_PATH;

async function setupSelendroid() {
  try {
    await (0, _teen_process.exec)('jar');
  } catch (err) {
    if (err.message.indexOf("ENOENT") !== -1 || err.message.indexOf("exited with code 2") !== -1 || err.message.indexOf("Command 'jar' not found. Is it installed?") !== -1) {
      _fancyLog.default.error("Could not find Java's 'jar' executable on your PATH. Please " + "ensure it is present and try running install again");

      return;
    }
  }

  if (await _appiumSupport.fs.exists(SE_JAR_PATH)) {
    (0, _fancyLog.default)("Standalone jar exists, skipping download: " + SE_JAR_PATH);
  } else {
    await downloadSelendroid();
  }

  (0, _fancyLog.default)(`Determining AndroidManifest location`);
  let manifestPath = await getFilePathFromJar(/AndroidManifest.*\.xml$/, SE_JAR_PATH);
  (0, _fancyLog.default)(`Determining server apk location`);
  let serverPath = await getFilePathFromJar(/selendroid-server.*\.apk$/, SE_JAR_PATH);
  (0, _fancyLog.default)(`Extracting manifest and apk to ${SE_DOWNLOAD_DIR}`);
  await (0, _teen_process.exec)('jar', ['xf', SE_JAR_PATH, manifestPath, serverPath], {
    cwd: SE_DOWNLOAD_DIR
  });
  (0, _fancyLog.default)(`Copying manifest and apk to ${SE_DIR}`);

  let extractedManifestPath = _path.default.resolve(SE_DOWNLOAD_DIR, manifestPath);

  let extractedServerPath = _path.default.resolve(SE_DOWNLOAD_DIR, serverPath);

  await _appiumSupport.fs.copyFile(extractedManifestPath, SE_MANIFEST_PATH);
  await _appiumSupport.fs.copyFile(extractedServerPath, SE_APK_PATH);
  (0, _fancyLog.default)("Cleaning up temp files");
  await _appiumSupport.fs.rimraf(extractedManifestPath);
  await _appiumSupport.fs.rimraf(extractedServerPath);
  (0, _fancyLog.default)(`Fixing AndroidManifest icon bug`);
  await fixManifestIcons(SE_MANIFEST_PATH);

  if (!(await serverExists())) {
    throw new Error("Something went wrong in setting up selendroid");
  }
}

async function downloadSelendroid() {
  (0, _fancyLog.default)(`Ensuring ${SE_DOWNLOAD_DIR} exists`);
  await _appiumSupport.fs.mkdir(SE_DIR);
  await _appiumSupport.fs.mkdir(SE_DOWNLOAD_DIR);
  (0, _fancyLog.default)(`Downloading Selendroid standalone server version ${SE_VER} from ` + `${SE_DOWNLOAD} --> ${SE_JAR_PATH}`);
  let body = await _requestPromise.default.get({
    url: SE_DOWNLOAD,
    encoding: null
  });

  if (!(body instanceof Buffer)) {
    throw new Error(Object.prototype.toString.call(body));
  }

  (0, _fancyLog.default)(`Writing binary content to ${SE_JAR_PATH_TMP}`);
  await _appiumSupport.fs.writeFile(SE_JAR_PATH_TMP, body);
  await _appiumSupport.fs.chmod(SE_JAR_PATH_TMP, 0o0644);
  let fingerprint = sha256(body);

  if (fingerprint === SE_DOWNLOAD_SHA256) {
    await _appiumSupport.fs.rename(SE_JAR_PATH_TMP, SE_JAR_PATH);
    (0, _fancyLog.default)("Selendroid standalone server downloaded");
  } else {
    throw new Error(`Bad SHA256 fingerprint: '${fingerprint}', bytes: ${body.length}`);
  }
}

function sha256(buffer) {
  const hash = _crypto.default.createHash('sha256');

  return hash.update(buffer).digest('hex');
}

async function getFilePathFromJar(fileRegex, jarPath) {
  let {
    stdout
  } = await (0, _teen_process.exec)('jar', ['tf', jarPath]);

  for (let line of stdout.split("\n")) {
    if (fileRegex.test(line.trim())) {
      return line.trim();
    }
  }

  throw new Error(`Could not find ${fileRegex} in ${jarPath}`);
}

async function serverExists() {
  try {
    return (await _appiumSupport.fs.exists(SE_APK_PATH)) && (await _appiumSupport.fs.exists(SE_MANIFEST_PATH));
  } catch (e) {
    if (e.code.indexOf("ENOENT") !== -1) {
      return false;
    }

    throw e;
  }
}

async function fixManifestIcons(manifest) {
  let curData = (await _appiumSupport.fs.readFile(manifest)).toString('utf8');
  let iconRe = /application[\s\S]+android:icon="[^"]+"/;
  let newData = curData.replace(iconRe, "application");
  await _appiumSupport.fs.writeFile(manifest, newData);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pbnN0YWxsZXIuanMiXSwibmFtZXMiOlsiU0VfVkVSIiwiU0VfRE9XTkxPQURfQ0ROVVJMIiwicHJvY2VzcyIsImVudiIsIm5wbV9jb25maWdfc2VsZW5kcm9pZF9kcml2ZXJfY2RudXJsIiwiU0VMRU5EUk9JRF9EUklWRVJfQ0ROVVJMIiwiU0VfRE9XTkxPQUQiLCJTRV9ET1dOTE9BRF9TSEEyNTYiLCJTRV9ESVIiLCJwYXRoIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsIlNFX0RPV05MT0FEX0RJUiIsIlNFX0pBUl9QQVRIX1RNUCIsIlNFX0pBUl9QQVRIIiwiU0VfQVBLX1BBVEgiLCJTRV9NQU5JRkVTVF9QQVRIIiwic2V0dXBTZWxlbmRyb2lkIiwiZXJyIiwibWVzc2FnZSIsImluZGV4T2YiLCJsb2ciLCJlcnJvciIsImZzIiwiZXhpc3RzIiwiZG93bmxvYWRTZWxlbmRyb2lkIiwibWFuaWZlc3RQYXRoIiwiZ2V0RmlsZVBhdGhGcm9tSmFyIiwic2VydmVyUGF0aCIsImN3ZCIsImV4dHJhY3RlZE1hbmlmZXN0UGF0aCIsImV4dHJhY3RlZFNlcnZlclBhdGgiLCJjb3B5RmlsZSIsInJpbXJhZiIsImZpeE1hbmlmZXN0SWNvbnMiLCJzZXJ2ZXJFeGlzdHMiLCJFcnJvciIsIm1rZGlyIiwiYm9keSIsInJlcXVlc3QiLCJnZXQiLCJ1cmwiLCJlbmNvZGluZyIsIkJ1ZmZlciIsIk9iamVjdCIsInByb3RvdHlwZSIsInRvU3RyaW5nIiwiY2FsbCIsIndyaXRlRmlsZSIsImNobW9kIiwiZmluZ2VycHJpbnQiLCJzaGEyNTYiLCJyZW5hbWUiLCJsZW5ndGgiLCJidWZmZXIiLCJoYXNoIiwiY3J5cHRvIiwiY3JlYXRlSGFzaCIsInVwZGF0ZSIsImRpZ2VzdCIsImZpbGVSZWdleCIsImphclBhdGgiLCJzdGRvdXQiLCJsaW5lIiwic3BsaXQiLCJ0ZXN0IiwidHJpbSIsImUiLCJjb2RlIiwibWFuaWZlc3QiLCJjdXJEYXRhIiwicmVhZEZpbGUiLCJpY29uUmUi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QUYsQ0FBT2hELE9BQVAsQ0FBZSxRQUFmLE1BQTZCLENBQUMsQ0FBbEMsRUFBcUM7QUFDbkMsYUFBTyxLQUFQO0FBQ0Q7O0FBQ0QsVUFBTStDLENBQU47QUFDRDtBQUNGOztBQUVELGVBQWVqQyxnQkFBZixDQUFpQ21DLFFBQWpDLEVBQTJDO0FBQ3pDLE1BQUlDLE9BQU8sR0FBRyxDQUFDLE1BQU0vQyxrQkFBR2dELFFBQUgsQ0FBWUYsUUFBWixDQUFQLEVBQThCdkIsUUFBOUIsQ0FBdUMsTUFBdkMsQ0FBZDtBQUNBLE1BQUkwQixNQUFNLEdBQUcsd0NBQWI7QUFDQSxNQUFJQyxPQUFPLEdBQUdILE9BQU8sQ0FBQ0ksT0FBUixDQUFnQkYsTUFBaEIsRUFBd0IsYUFBeEIsQ0FBZDtBQUNBLFFBQU1qRCxrQkFBR3lCLFNBQUgsQ0FBYXFCLFFBQWIsRUFBdUJJLE9BQXZCLENBQU47QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCByZXF1ZXN0IGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgbG9nIGZyb20gJ2ZhbmN5LWxvZyc7XG5pbXBvcnQgY3J5cHRvIGZyb20gJ2NyeXB0byc7XG5cblxuY29uc3QgU0VfVkVSID0gXCIwLjE3LjBcIjtcbmNvbnN0IFNFX0RPV05MT0FEX0NETlVSTCA9IHByb2Nlc3MuZW52Lm5wbV9jb25maWdfc2VsZW5kcm9pZF9kcml2ZXJfY2RudXJsIHx8XG4gIHByb2Nlc3MuZW52LlNFTEVORFJPSURfRFJJVkVSX0NETlVSTCB8fFxuICBcImh0dHBzOi8vcmVwbzEubWF2ZW4ub3JnL21hdmVuMi9pby9zZWxlbmRyb2lkL3NlbGVuZHJvaWQtc3RhbmRhbG9uZVwiO1xuY29uc3QgU0VfRE9XTkxPQUQgPSBgJHtTRV9ET1dOTE9BRF9DRE5VUkx9LyR7U0VfVkVSfS9zZWxlbmRyb2lkLXN0YW5kYWxvbmUtJHtTRV9WRVJ9LXdpdGgtZGVwZW5kZW5jaWVzLmphcmA7XG5jb25zdCBTRV9ET1dOTE9BRF9TSEEyNTYgPSBcIjdjZjcxNjNhYzQ3ZjFjNDZlZmY5NWI2MmY3OGI1OGMxZGFiZGVjNTM0YWNjNjYzMmRhMzc4NDczOWY2ZTlkODJcIjtcbmNvbnN0IFNFX0RJUiA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIFwiLi5cIiwgXCIuLlwiLCBcInNlbGVuZHJvaWRcIik7XG5jb25zdCBTRV9ET1dOTE9BRF9ESVIgPSBwYXRoLnJlc29sdmUoU0VfRElSLCBcImRvd25sb2FkXCIpO1xuLy8gVXNlIG9mIHRlbXBvcmFyeSBmaWxlIG1lYW5zIHRoYXQgU0VfSkFSX1BBVEggY2FuIG9ubHkgZXhpc3QgaWYgaXQgaGFzXG4vLyB2ZXJpZmllZCBjb250ZW50LlxuY29uc3QgU0VfSkFSX1BBVEhfVE1QID0gcGF0aC5yZXNvbHZlKFNFX0RPV05MT0FEX0RJUiwgXCJzZWxlbmRyb2lkLXNlcnZlci5qYXIudG1wXCIpO1xuLy8gUHV0dGluZyBmaW5nZXJwcmludCBpbiBmaWxlIG5hbWUgbWVhbnMgZG93bmxvYWQgdHJpZ2dlcmVkIGlmIGZpbmdlcnByaW50IGNoYW5nZWQuXG5jb25zdCBTRV9KQVJfUEFUSCA9IHBhdGgucmVzb2x2ZShTRV9ET1dOTE9BRF9ESVIsIGBzZWxlbmRyb2lkLXNlcnZlci0ke1NFX0RPV05MT0FEX1NIQTI1Nn0uamFyYCk7XG5jb25zdCBTRV9BUEtfUEFUSCA9IHBhdGgucmVzb2x2ZShTRV9ESVIsIFwic2VsZW5kcm9pZC1zZXJ2ZXIuYXBrXCIpO1xuY29uc3QgU0VfTUFOSUZFU1RfUEFUSCA9IHBhdGgucmVzb2x2ZShTRV9ESVIsIFwiQW5kcm9pZE1hbmlmZXN0LnhtbFwiKTtcblxuYXN5bmMgZnVuY3Rpb24gc2V0dXBTZWxlbmRyb2lkICgpIHtcbiAgdHJ5IHtcbiAgICBhd2FpdCBleGVjKCdqYXInKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKGVyci5tZXNzYWdlLmluZGV4T2YoXCJFTk9FTlRcIikgIT09IC0xIHx8XG4gICAgICAgIGVyci5tZXNzYWdlLmluZGV4T2YoXCJleGl0ZWQgd2l0aCBjb2RlIDJcIikgIT09IC0xIHx8XG4gICAgICAgIGVyci5tZXNzYWdlLmluZGV4T2YoXCJDb21tYW5kICdqYXInIG5vdCBmb3VuZC4gSXMgaXQgaW5zdGFsbGVkP1wiKSAhPT0gLTEpIHtcbiAgICAgIGxvZy5lcnJvcihcIkNvdWxkIG5vdCBmaW5kIEphdmEncyAnamFyJyBleGVjdXRhYmxlIG9uIHlvdXIgUEFUSC4gUGxlYXNlIFwiICtcbiAgICAgICAgICAgICAgICBcImVuc3VyZSBpdCBpcyBwcmVzZW50IGFuZCB0cnkgcnVubmluZyBpbnN0YWxsIGFnYWluXCIpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgfVxuICBpZiAoYXdhaXQgZnMuZXhpc3RzKFNFX0pBUl9QQVRIKSkge1xuICAgIGxvZyhcIlN0YW5kYWxvbmUgamFyIGV4aXN0cywgc2tpcHBpbmcgZG93bmxvYWQ6IFwiICsgU0VfSkFSX1BBVEgpO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IGRvd25sb2FkU2VsZW5kcm9pZCgpO1xuICB9XG4gIGxvZyhgRGV0ZXJtaW5pbmcgQW5kcm9pZE1hbmlmZXN0IGxvY2F0aW9uYCk7XG4gIGxldCBtYW5pZmVzdFBhdGggPSBhd2FpdCBnZXRGaWxlUGF0aEZyb21KYXIoL0FuZHJvaWRNYW5pZmVzdC4qXFwueG1sJC8sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU0VfSkFSX1BBVEgpO1xuICBsb2coYERldGVybWluaW5nIHNlcnZlciBhcGsgbG9jYXRpb25gKTtcbiAgbGV0IHNlcnZlclBhdGggPSBhd2FpdCBnZXRGaWxlUGF0aEZyb21KYXIoL3NlbGVuZHJvaWQtc2VydmVyLipcXC5hcGskLyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU0VfSkFSX1BBVEgpO1xuICBsb2coYEV4dHJhY3RpbmcgbWFuaWZlc3QgYW5kIGFwayB0byAke1NFX0RPV05MT0FEX0RJUn1gKTtcbiAgYXdhaXQgZXhlYygnamFyJywgWyd4ZicsIFNFX0pBUl9QQVRILCBtYW5pZmVzdFBhdGgsIHNlcnZlclBhdGhdLCB7XG4gICAgY3dkOiBTRV9ET1dOTE9BRF9ESVJcbiAgfSk7XG4gIGxvZyhgQ29weWluZyBtYW5pZmVzdCBhbmQgYXBrIHRvICR7U0VfRElSfWApO1xuICBsZXQgZXh0cmFjdGVkTWFuaWZlc3RQYXRoID0gcGF0aC5yZXNvbHZlKFNFX0RPV05MT0FEX0RJUiwgbWFuaWZlc3RQYXRoKTtcbiAgbGV0IGV4dHJhY3RlZFNlcnZlclBhdGggPSBwYXRoLnJlc29sdmUoU0VfRE9XTkxPQURfRElSLCBzZXJ2ZXJQYXRoKTtcbiAgYXdhaXQgZnMuY29weUZpbGUoZXh0cmFjdGVkTWFuaWZlc3RQYXRoLCBTRV9NQU5JRkVTVF9QQVRIKTtcbiAgYXdhaXQgZnMuY29weUZpbGUoZXh0cmFjdGVkU2VydmVyUGF0aCwgU0VfQVBLX1BBVEgpO1xuICBsb2coXCJDbGVhbmluZyB1cCB0ZW1wIGZpbGVzXCIpO1xuICBhd2FpdCBmcy5yaW1yYWYoZXh0cmFjdGVkTWFuaWZlc3RQYXRoKTtcbiAgYXdhaXQgZnMucmltcmFmKGV4dHJhY3RlZFNlcnZlclBhdGgpO1xuICBsb2coYEZpeGluZyBBbmRyb2lkTWFuaWZlc3QgaWNvbiBidWdgKTtcbiAgYXdhaXQgZml4TWFuaWZlc3RJY29ucyhTRV9NQU5JRkVTVF9QQVRIKTtcbiAgaWYgKCEoYXdhaXQgc2VydmVyRXhpc3RzKCkpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiU29tZXRoaW5nIHdlbnQgd3JvbmcgaW4gc2V0dGluZyB1cCBzZWxlbmRyb2lkXCIpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRvd25sb2FkU2VsZW5kcm9pZCAoKSB7XG4gIGxvZyhgRW5zdXJpbmcgJHtTRV9ET1dOTE9BRF9ESVJ9IGV4aXN0c2ApO1xuICBhd2FpdCBmcy5ta2RpcihTRV9ESVIpO1xuICBhd2FpdCBmcy5ta2RpcihTRV9ET1dOTE9BRF9ESVIpO1xuICBsb2coYERvd25sb2FkaW5nIFNlbGVuZHJvaWQgc3RhbmRhbG9uZSBzZXJ2ZXIgdmVyc2lvbiAke1NFX1ZFUn0gZnJvbSBgICtcbiAgICAgICAgICAgYCR7U0VfRE9XTkxPQUR9IC0tPiAke1NFX0pBUl9QQVRIfWApO1xuICBsZXQgYm9keSA9IGF3YWl0IHJlcXVlc3QuZ2V0KHt1cmw6IFNFX0RPV05MT0FELCBlbmNvZGluZzogbnVsbH0pO1xuICBpZiAoIShib2R5IGluc3RhbmNlb2YgQnVmZmVyKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoYm9keSkpO1xuICB9XG4gIGxvZyhgV3JpdGluZyBiaW5hcnkgY29udGVudCB0byAke1NFX0pBUl9QQVRIX1RNUH1gKTtcbiAgYXdhaXQgZnMud3JpdGVGaWxlKFNFX0pBUl9QQVRIX1RNUCwgYm9keSk7XG4gIGF3YWl0IGZzLmNobW9kKFNFX0pBUl9QQVRIX1RNUCwgMG8wNjQ0KTtcbiAgbGV0IGZpbmdlcnByaW50ID0gc2hhMjU2KGJvZHkpO1xuICBpZiAoZmluZ2VycHJpbnQgPT09IFNFX0RPV05MT0FEX1NIQTI1Nikge1xuICAgIGF3YWl0IGZzLnJlbmFtZShTRV9KQVJfUEFUSF9UTVAsIFNFX0pBUl9QQVRIKTtcbiAgICBsb2coXCJTZWxlbmRyb2lkIHN0YW5kYWxvbmUgc2VydmVyIGRvd25sb2FkZWRcIik7XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBCYWQgU0hBMjU2IGZpbmdlcnByaW50OiAnJHtmaW5nZXJwcmludH0nLCBieXRlczogJHtib2R5Lmxlbmd0aH1gKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBzaGEyNTYgKGJ1ZmZlcikge1xuICBjb25zdCBoYXNoID0gY3J5cHRvLmNyZWF0ZUhhc2goJ3NoYTI1NicpO1xuICByZXR1cm4gaGFzaC51cGRhdGUoYnVmZmVyKS5kaWdlc3QoJ2hleCcpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRGaWxlUGF0aEZyb21KYXIgKGZpbGVSZWdleCwgamFyUGF0aCkge1xuICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKCdqYXInLCBbJ3RmJywgamFyUGF0aF0pO1xuICBmb3IgKGxldCBsaW5lIG9mIHN0ZG91dC5zcGxpdChcIlxcblwiKSkge1xuICAgIGlmIChmaWxlUmVnZXgudGVzdChsaW5lLnRyaW0oKSkpIHtcbiAgICAgIHJldHVybiBsaW5lLnRyaW0oKTtcbiAgICB9XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCAke2ZpbGVSZWdleH0gaW4gJHtqYXJQYXRofWApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXJ2ZXJFeGlzdHMgKCkge1xuICB0cnkge1xuICAgIHJldHVybiAoYXdhaXQgZnMuZXhpc3RzKFNFX0FQS19QQVRIKSAmJlxuICAgICAgICAgICAgYXdhaXQgZnMuZXhpc3RzKFNFX01BTklGRVNUX1BBVEgpKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmIChlLmNvZGUuaW5kZXhPZihcIkVOT0VOVFwiKSAhPT0gLTEpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgdGhyb3cgZTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBmaXhNYW5pZmVzdEljb25zIChtYW5pZmVzdCkge1xuICBsZXQgY3VyRGF0YSA9IChhd2FpdCBmcy5yZWFkRmlsZShtYW5pZmVzdCkpLnRvU3RyaW5nKCd1dGY4Jyk7XG4gIGxldCBpY29uUmUgPSAvYXBwbGljYXRpb25bXFxzXFxTXSthbmRyb2lkOmljb249XCJbXlwiXStcIi87XG4gIGxldCBuZXdEYXRhID0gY3VyRGF0YS5yZXBsYWNlKGljb25SZSwgXCJhcHBsaWNhdGlvblwiKTtcbiAgYXdhaXQgZnMud3JpdGVGaWxlKG1hbmlmZXN0LCBuZXdEYXRhKTtcbn1cblxuZXhwb3J0IHsgc2V0dXBTZWxlbmRyb2lkLCBzZXJ2ZXJFeGlzdHMsIFNFX0FQS19QQVRILCBTRV9NQU5JRkVTVF9QQVRIIH07XG4iXSwiZmlsZSI6ImxpYi9pbnN0YWxsZXIuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
