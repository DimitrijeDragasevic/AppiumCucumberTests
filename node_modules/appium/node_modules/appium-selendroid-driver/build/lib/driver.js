"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.DEVICE_PORT = exports.SelendroidDriver = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

var _selendroid = _interopRequireDefault(require("./selendroid"));

var _appiumSupport = require("appium-support");

var _installer = require("./installer");

var _asyncbox = require("asyncbox");

var _logger = _interopRequireDefault(require("./logger"));

var _commands = _interopRequireDefault(require("./commands"));

var _appiumAdb = require("appium-adb");

var _helpers = _interopRequireDefault(require("./helpers"));

var _appiumAndroidDriver = require("appium-android-driver");

var _desiredCaps = _interopRequireDefault(require("./desired-caps"));

let helpers = {};
Object.assign(helpers, _helpers.default, _appiumAndroidDriver.androidHelpers);
const SYSTEM_PORT_RANGE = [8200, 8299];
const DEVICE_PORT = 8080;
exports.DEVICE_PORT = DEVICE_PORT;
const NO_PROXY = [['GET', new RegExp('^/session/[^/]+/log/types$')], ['POST', new RegExp('^/session/[^/]+/log')], ['POST', new RegExp('^/session/[^/]+/location')], ['POST', new RegExp('^/session/[^/]+/appium')], ['GET', new RegExp('^/session/[^/]+/appium')], ['POST', new RegExp('^/session/[^/]+/context')], ['GET', new RegExp('^/session/[^/]+/context')], ['GET', new RegExp('^/session/[^/]+/contexts')], ['POST', new RegExp('^/session/[^/]+/element/[^/]+/value')], ['GET', new RegExp('^/session/[^/]+/element/[^/]+/rect')], ['GET', new RegExp('^/session/[^/]+/network_connection')], ['POST', new RegExp('^/session/[^/]+/network_connection')], ['POST', new RegExp('^/session/[^/]+/ime')], ['GET', new RegExp('^/session/[^/]+/ime')], ['POST', new RegExp('^/session/[^/]+/keys')], ['POST', new RegExp('^/session/[^/]+/touch/multi/perform')]];
const APP_EXTENSION = '.apk';

class SelendroidDriver extends _appiumBaseDriver.BaseDriver {
  constructor(opts = {}, shouldValidateCaps = true) {
    delete opts.shell;
    super(opts, shouldValidateCaps);
    this.desiredCapConstraints = _desiredCaps.default;
    this.selendroid = null;
    this.jwpProxyActive = false;
    this.defaultIME = null;
    this.jwpProxyAvoid = NO_PROXY;
    this.apkStrings = {};
    this.chromedriver = null;
    this.sessionChromedrivers = {};
    this.opts.systemPort = opts.selendroidPort || SYSTEM_PORT_RANGE[0];
    this.opts.adbPort = opts.adbPort || _appiumAdb.DEFAULT_ADB_PORT;
  }

  async createSession(caps) {
    try {
      if (!(await (0, _installer.serverExists)())) {
        throw new Error('Cannot start a selendroid session because the server ' + 'apk does not exist. Please run `npm run-script ' + 'selendroid` in the appium-selendroid-driver package');
      }

      let sessionId;
      [sessionId] = await super.createSession(caps);
      this.curContext = this.defaultContextName();
      this.opts.app = await this.helpers.configureApp(this.opts.app, APP_EXTENSION);
      await this.checkAppPresent();
      this.opts.systemPort = this.opts.selendroidPort || SYSTEM_PORT_RANGE[0];
      this.opts.adbPort = this.opts.adbPort || _appiumAdb.DEFAULT_ADB_PORT;
      await this.startSelendroidSession();
      return [sessionId, caps];
    } catch (e) {
      await this.deleteSession();
      throw e;
    }
  }

  validateDesiredCaps(caps) {
    let res = super.validateDesiredCaps(caps);
    if (!res) return res;

    if (this.opts.reboot) {
      this.setAvdFromCapabilities(caps);
    }
  }

  setAvdFromCapabilities(caps) {
    if (this.opts.avd) {
      _logger.default.info('avd name defined, ignoring device name and platform version');
    } else {
      if (!caps.deviceName) {
        _logger.default.errorAndThrow('avd or deviceName should be specified when reboot option is enabled');
      }

      if (!caps.platformVersion) {
        _logger.default.errorAndThrow('avd or platformVersion should be specified when reboot option is enabled');
      }

      let avdDevice = caps.deviceName.replace(/[^a-zA-Z0-9_.]/g, "-");
      this.opts.avd = `${avdDevice}__${caps.platformVersion}`;
    }
  }

  get driverData() {
    return {};
  }

  isEmulator() {
    return !!this.opts.avd;
  }

  async startSelendroidSession() {
    if (!this.opts.javaVersion) {
      this.opts.javaVersion = await helpers.getJavaVersion();
    }

    let {
      udid,
      emPort
    } = await helpers.getDeviceInfoFromCaps(this.opts);
    this.opts.udid = udid;
    this.opts.emPort = emPort;
    this.adb = await _appiumAndroidDriver.androidHelpers.createADB(this.opts);
    await helpers.ensureInternetPermissionForApp(this.adb, this.opts.app);
    let appInfo = await helpers.getLaunchInfo(this.adb, this.opts);
    Object.assign(this.opts, appInfo);
    await this.initSelendroidServer();
    await helpers.initDevice(this.adb, this.opts);
    await this.adb.forwardPort(this.opts.systemPort, DEVICE_PORT);
    await this.initAUT();
    await helpers.unlock(this, this.adb, this.caps);
    await this.selendroid.startSession(this.caps);
    await this.ensureAppStarts();

    if (this.opts.autoWebview) {
      await (0, _asyncbox.retryInterval)(20, this.opts.autoWebviewTimeout || 2000, async () => {
        await this.setContext(this.defaultWebviewName());
      });
    }

    this.jwpProxyActive = true;
  }

  async initSelendroidServer() {
    this.selendroid = new _selendroid.default({
      host: this.opts.host || 'localhost',
      systemPort: this.opts.systemPort,
      devicePort: DEVICE_PORT,
      adb: this.adb,
      apk: this.opts.app,
      tmpDir: this.opts.tmpDir,
      appPackage: this.opts.appPackage,
      appActivity: this.opts.appActivity
    });
    this.proxyReqRes = this.selendroid.proxyReqRes.bind(this.selendroid);
    await this.selendroid.prepareModifiedServer();
  }

  async initAUT() {
    _logger.default.debug('Initializing application under test');

    this.apkStrings[this.opts.language] = await helpers.pushStrings(this.opts.language, this.adb, this.opts);

    if (!this.opts.skipUninstall) {
      await this.adb.uninstallApk(this.opts.appPackage);
    }

    if (!this.opts.noSign) {
      let signed = await this.adb.checkApkCert(this.opts.app, this.opts.appPackage);

      if (!signed) {
        _logger.default.debug('Application not signed. Signing.');

        await this.adb.sign(this.opts.app, this.opts.appPackage);
      }
    }

    await helpers.installApk(this.adb, this.opts);
    await this.selendroid.installModifiedServer();
  }

  async ensureAppStarts() {
    let appWaitPackage = this.opts.appWaitPackage || this.opts.appPackage;
    let appWaitActivity = this.opts.appWaitActivity || this.opts.appActivity;

    try {
      await this.adb.waitForActivity(appWaitPackage, appWaitActivity, 5000);
    } catch (e) {
      _logger.default.info(`Selendroid did not start the activity we were waiting for, ` + `'${appWaitPackage}/${appWaitActivity}'. ` + `Starting it ourselves`);

      await this.adb.startApp({
        pkg: this.opts.appPackage,
        activity: this.opts.appActivity,
        action: this.opts.intentAction,
        category: this.opts.intentCategory,
        flags: this.opts.intentFlags,
        waitPkg: this.opts.appWaitPackage,
        waitActivity: this.opts.appWaitActivity,
        optionalIntentArguments: this.opts.optionalIntentArguments,
        stopApp: !this.opts.dontStopAppOnReset,
        retry: false
      });
    }
  }

  async deleteSession() {
    _logger.default.debug('Deleting Selendroid session');

    if (this.selendroid) {
      if (this.jwpProxyActive) {
        await this.selendroid.deleteSession();
      }

      this.selendroid = null;
    }

    this.jwpProxyActive = false;

    if (this.adb) {
      if (this.opts.unicodeKeyboard && this.opts.resetKeyboard && this.defaultIME) {
        _logger.default.debug(`Resetting IME to '${this.defaultIME}'`);

        await this.adb.setIME(this.defaultIME);
      }

      await this.adb.forceStop(this.opts.appPackage);
      await this.adb.stopLogcat();

      if (this.opts.reboot) {
        let avdName = this.opts.avd.replace('@', '');

        _logger.default.debug(`closing emulator '${avdName}'`);

        await this.adb.killEmulator(avdName);
      }
    }

    await super.deleteSession();
  }

  async checkAppPresent() {
    _logger.default.debug('Checking whether app is actually present');

    if (!(await _appiumSupport.fs.exists(this.opts.app))) {
      _logger.default.errorAndThrow(`Could not find app apk at '${this.opts.app}'`);
    }
  }

  defaultWebviewName() {
    return `${_appiumAndroidDriver.WEBVIEW_BASE}0`;
  }

  proxyActive(sessionId) {
    super.proxyActive(sessionId);
    return true;
  }

  getProxyAvoidList(sessionId) {
    super.getProxyAvoidList(sessionId);
    return this.jwpProxyAvoid;
  }

  canProxy(sessionId) {
    super.canProxy(sessionId);
    return true;
  }

}

exports.SelendroidDriver = SelendroidDriver;

for (let [cmd, fn] of _lodash.default.toPairs(_appiumAndroidDriver.androidCommands)) {
  if (!_lodash.default.includes(['defaultWebviewName'], cmd)) {
    SelendroidDriver.prototype[cmd] = fn;
  }
}

for (let [cmd, fn] of _lodash.default.toPairs(_commands.default)) {
  SelendroidDriver.prototype[cmd] = fn;
}

var _default = SelendroidDriver;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kcml2ZXIuanMiXSwibmFtZXMiOlsiaGVscGVycyIsIk9iamVjdCIsImFzc2lnbiIsInNlbGVuZHJvaWRIZWxwZXJzIiwiYW5kcm9pZEhlbHBlcnMiLCJTWVNURU1fUE9SVF9SQU5HRSIsIkRFVklDRV9QT1JUIiwiTk9fUFJPWFkiLCJSZWdFeHAiLCJBUFBfRVhURU5TSU9OIiwiU2VsZW5kcm9pZERyaXZlciIsIkJhc2VEcml2ZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJzaG91bGRWYWxpZGF0ZUNhcHMiLCJzaGVsbCIsImRlc2lyZWRDYXBDb25zdHJhaW50cyIsInNlbGVuZHJvaWQiLCJqd3BQcm94eUFjdGl2ZSIsImRlZmF1bHRJTUUiLCJqd3BQcm94eUF2b2lkIiwiYXBrU3RyaW5ncyIsImNocm9tZWRyaXZlciIsInNlc3Npb25DaHJvbWVkcml2ZXJzIiwic3lzdGVtUG9ydCIsInNlbGVuZHJvaWRQb3J0IiwiYWRiUG9ydCIsIkRFRkFVTFRfQURCX1BPUlQiLCJjcmVhdGVTZXNzaW9uIiwiY2FwcyIsIkVycm9yIiwic2Vzc2lvbklkIiwiY3VyQ29udGV4dCIsImRlZmF1bHRDb250ZXh0TmFtZSIsImFwcCIsImNvbmZpZ3VyZUFwcCIsImNoZWNrQXBwUHJlc2VudCIsInN0YXJ0U2VsZW5kcm9pZFNlc3Npb24iLCJlIiwiZGVsZXRlU2Vzc2lvbiIsInZhbGlkYXRlRGVzaXJlZENhcHMiLCJyZXMiLCJyZWJvb3QiLCJzZXRBdmRGcm9tQ2FwYWJpbGl0aWVzIiwiYXZkIiwibG9nZ2VyIiwiaW5mbyIsImRldmljZU5hbWUiLCJlcnJvckFuZFRocm93IiwicGxhdGZvcm1WZXJzaW9uIiwiYXZkRGV2aWNlIiwicmVwbGFjZSIsImRyaXZlckRhdGEiLCJpc0VtdWxhdG9yIiwiamF2YVZlcnNpb24iLCJnZXRKYXZhVmVyc2lvbiIsInVkaWQiLCJlbVBvcnQiLCJnZXREZXZpY2VJbmZvRnJvbUNhcHMiLCJhZGIiLCJjcmVhdGVBREIiLCJlbnN1cmVJbnRlcm5ldFBlcm1pc3Npb25Gb3JBcHAiLCJhcHBJbmZvIiwiZ2V0TGF1bmNoSW5mbyIsImluaXRTZWxlbmRyb2lkU2VydmVyIiwiaW5pdERldmljZSIsImZvcndhcmRQb3J0IiwiaW5pdEFVVCIsInVubG9jayIsInN0YXJ0U2Vzc2lvbiIsImVuc3VyZUFwcFN0YXJ0cyIsImF1dG9XZWJ2aWV3IiwiYXV0b1dlYnZpZXdUaW1lb3V0Iiwic2V0Q29udGV4dCIsImRlZmF1bHRXZWJ2aWV3TmFtZSIsIlNlbGVuZHJvaWRTZXJ2ZXIiLCJob3N0IiwiZGV2aWNlUG9ydCIsImFwayIsInRtcERpciIsImFwcFBhY2thZ2UiLCJhcHBBY3Rpdml0eSIsInByb3h5UmVxUmVzIiwiYmluZCIsInByZXBhcmVNb2RpZmllZFNlcnZlciIsImRlYnVnIiwibGFuZ3VhZ2UiLCJwdXNoU3RyaW5ncyIsInNraXBVbmluc3RhbGwiLCJ1bmluc3RhbGxBcGsiLCJub1NpZ24iLCJzaWduZWQiLCJjaGVja0Fwa0NlcnQiLCJzaWduIiwiaW5zdGFsbEFwayIsImluc3RhbGxNb2RpZmllZFNlcnZlciIsImFwcFdhaXRQYWNrYWdlIiwiYXBwV2FpdEFjdGl2aXR5Iiwid2FpdEZvckFjdGl2aXR5Iiwic3RhcnRBcHAiLCJwa2ciLCJhY3Rpdml0eSIsImFjdGlvbiIsImludGVudEFjdGlvbiIsImNhdGVnb3J5IiwiaW50ZW50Q2F0ZWdvcnkiLCJmbGFncyIsImludGVudEZsYWdzIiwid2FpdFBrZyIsIndhaXRBY3Rpdml0eSIsIm9wdGlvbmFsSW50ZW50QXJndW1lbnRzIiwic3RvcEFwcCIsImRvbnRTdG9wQXBwT25SZXNldCIsInJldHJ5IiwidW5pY29kZUtleWJvYXJkIiwicmVzZXRLZXlib2FyZCIsInNldElNRSIsImZvcmNlU3RvcCIsInN0b3BMb2djYXQiLCJhdmROYW1lIiwia2lsbEVtdWxhdG9yIiwiZnMiLCJleGlzdHMiLCJXRUJWSUVXX0JBU0UiLCJwcm94eUFjdGl2ZSIsImdldFByb3h5QXZvaWRMaXN0IiwiY2FuUHJveHkiLCJjbWQiLCJmbiIsIl8iLCJ0b1BhaXJzIiwiYW5kcm9pZENvbW1hbmRzIiwiaW5jbHVkZXMiLCJwcm90b3R5cGUiLCJjb21tYW5kcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxJQUFJQSxPQUFPLEdBQUcsRUFBZDtBQUNBQyxNQUFNLENBQUNDLE1BQVAsQ0FBY0YsT0FBZCxFQUF1QkcsZ0JBQXZCLEVBQTBDQyxtQ0FBMUM7QUFJQSxNQUFNQyxpQkFBaUIsR0FBRyxDQUFDLElBQUQsRUFBTyxJQUFQLENBQTFCO0FBSUEsTUFBTUMsV0FBVyxHQUFHLElBQXBCOztBQUdBLE1BQU1DLFFBQVEsR0FBRyxDQUNmLENBQUMsS0FBRCxFQUFRLElBQUlDLE1BQUosQ0FBVyw0QkFBWCxDQUFSLENBRGUsRUFFZixDQUFDLE1BQUQsRUFBUyxJQUFJQSxNQUFKLENBQVcscUJBQVgsQ0FBVCxDQUZlLEVBR2YsQ0FBQyxNQUFELEVBQVMsSUFBSUEsTUFBSixDQUFXLDBCQUFYLENBQVQsQ0FIZSxFQUlmLENBQUMsTUFBRCxFQUFTLElBQUlBLE1BQUosQ0FBVyx3QkFBWCxDQUFULENBSmUsRUFLZixDQUFDLEtBQUQsRUFBUSxJQUFJQSxNQUFKLENBQVcsd0JBQVgsQ0FBUixDQUxlLEVBTWYsQ0FBQyxNQUFELEVBQVMsSUFBSUEsTUFBSixDQUFXLHlCQUFYLENBQVQsQ0FOZSxFQU9mLENBQUMsS0FBRCxFQUFRLElBQUlBLE1BQUosQ0FBVyx5QkFBWCxDQUFSLENBUGUsRUFRZixDQUFDLEtBQUQsRUFBUSxJQUFJQSxNQUFKLENBQVcsMEJBQVgsQ0FBUixDQVJlLEVBU2YsQ0FBQyxNQUFELEVBQVMsSUFBSUEsTUFBSixDQUFXLHFDQUFYLENBQVQsQ0FUZSxFQVVmLENBQUMsS0FBRCxFQUFRLElBQUlBLE1BQUosQ0FBVyxvQ0FBWCxDQUFSLENBVmUsRUFXZixDQUFDLEtBQUQsRUFBUSxJQUFJ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MUMsS0FBSyxJQUFJLENBQUNnRyxHQUFELEVBQU1DLEVBQU4sQ0FBVCxJQUFzQkMsZ0JBQUVDLE9BQUYsQ0FBVUMsb0NBQVYsQ0FBdEIsRUFBa0Q7QUFFaEQsTUFBSSxDQUFDRixnQkFBRUcsUUFBRixDQUFXLENBQUMsb0JBQUQsQ0FBWCxFQUFtQ0wsR0FBbkMsQ0FBTCxFQUE4QztBQUM1Q3JILElBQUFBLGdCQUFnQixDQUFDMkgsU0FBakIsQ0FBMkJOLEdBQTNCLElBQWtDQyxFQUFsQztBQUNEO0FBQ0Y7O0FBR0QsS0FBSyxJQUFJLENBQUNELEdBQUQsRUFBTUMsRUFBTixDQUFULElBQXNCQyxnQkFBRUMsT0FBRixDQUFVSSxpQkFBVixDQUF0QixFQUEyQztBQUN6QzVILEVBQUFBLGdCQUFnQixDQUFDMkgsU0FBakIsQ0FBMkJOLEdBQTNCLElBQWtDQyxFQUFsQztBQUNEOztlQUdjdEgsZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgQmFzZURyaXZlciB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgU2VsZW5kcm9pZFNlcnZlciBmcm9tICcuL3NlbGVuZHJvaWQnO1xuaW1wb3J0IHsgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBzZXJ2ZXJFeGlzdHMgfSBmcm9tICcuL2luc3RhbGxlcic7XG5pbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgY29tbWFuZHMgZnJvbSAnLi9jb21tYW5kcyc7XG5pbXBvcnQgeyBERUZBVUxUX0FEQl9QT1JUIH0gZnJvbSAnYXBwaXVtLWFkYic7XG5pbXBvcnQgc2VsZW5kcm9pZEhlbHBlcnMgZnJvbSAnLi9oZWxwZXJzJztcbmltcG9ydCB7IGFuZHJvaWRIZWxwZXJzLCBhbmRyb2lkQ29tbWFuZHMsIFdFQlZJRVdfQkFTRSB9IGZyb20gJ2FwcGl1bS1hbmRyb2lkLWRyaXZlcic7XG5pbXBvcnQgZGVzaXJlZENhcENvbnN0cmFpbnRzIGZyb20gJy4vZGVzaXJlZC1jYXBzJztcblxuXG5sZXQgaGVscGVycyA9IHt9O1xuT2JqZWN0LmFzc2lnbihoZWxwZXJzLCBzZWxlbmRyb2lkSGVscGVycywgYW5kcm9pZEhlbHBlcnMpO1xuXG4vLyBUaGUgcmFuZ2Ugb2YgcG9ydHMgd2UgY2FuIHVzZSBvbiB0aGUgc3lzdGVtIGZvciBjb21tdW5pY2F0aW5nIHRvIHRoZVxuLy8gU2VsZW5kcm9pZCBIVFRQIHNlcnZlciBvbiB0aGUgZGV2aWNlXG5jb25zdCBTWVNURU1fUE9SVF9SQU5HRSA9IFs4MjAwLCA4Mjk5XTtcblxuLy8gVGhpcyBpcyB0aGUgcG9ydCB0aGF0IFNlbGVuZHJvaWQgbGlzdGVucyB0byBvbiB0aGUgZGV2aWNlLiBXZSB3aWxsIGZvcndhcmRcbi8vIG9uZSBvZiB0aGUgcG9ydHMgYWJvdmUgb24gdGhlIHN5c3RlbSB0byB0aGlzIHBvcnQgb24gdGhlIGRldmljZS5cbmNvbnN0IERFVklDRV9QT1JUID0gODA4MDtcblxuLy8gVGhpcyBpcyBhIHNldCBvZiBtZXRob2RzIGFuZCBwYXRocyB0aGF0IHdlIG5ldmVyIHdhbnQgdG8gcHJveHkgdG8gU2VsZW5kcm9pZFxuY29uc3QgTk9fUFJPWFkgPSBbXG4gIFsnR0VUJywgbmV3IFJlZ0V4cCgnXi9zZXNzaW9uL1teL10rL2xvZy90eXBlcyQnKV0sXG4gIFsnUE9TVCcsIG5ldyBSZWdFeHAoJ14vc2Vzc2lvbi9bXi9dKy9sb2cnKV0sXG4gIFsnUE9TVCcsIG5ldyBSZWdFeHAoJ14vc2Vzc2lvbi9bXi9dKy9sb2NhdGlvbicpXSxcbiAgWydQT1NUJywgbmV3IFJlZ0V4cCgnXi9zZXNzaW9uL1teL10rL2FwcGl1bScpXSxcbiAgWydHRVQnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsvYXBwaXVtJyldLFxuICBbJ1BPU1QnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsvY29udGV4dCcpXSxcbiAgWydHRVQnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsvY29udGV4dCcpXSxcbiAgWydHRVQnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsvY29udGV4dHMnKV0sXG4gIFsnUE9TVCcsIG5ldyBSZWdFeHAoJ14vc2Vzc2lvbi9bXi9dKy9lbGVtZW50L1teL10rL3ZhbHVlJyldLFxuICBbJ0dFVCcsIG5ldyBSZWdFeHAoJ14vc2Vzc2lvbi9bXi9dKy9lbGVtZW50L1teL10rL3JlY3QnKV0sXG4gIFsnR0VUJywgbmV3IFJlZ0V4cCgnXi9zZXNzaW9uL1teL10rL25ldHdvcmtfY29ubmVjdGlvbicpXSxcbiAgWydQT1NUJywgbmV3IFJlZ0V4cCgnXi9zZXNzaW9uL1teL10rL25ldHdvcmtfY29ubmVjdGlvbicpXSxcbiAgWydQT1NUJywgbmV3IFJlZ0V4cCgnXi9zZXNzaW9uL1teL10rL2ltZScpXSxcbiAgWydHRVQnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsvaW1lJyldLFxuICBbJ1BPU1QnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsva2V5cycpXSxcbiAgWydQT1NUJywgbmV3IFJlZ0V4cCgnXi9zZXNzaW9uL1teL10rL3RvdWNoL211bHRpL3BlcmZvcm0nKV0sXG5dO1xuXG5jb25zdCBBUFBfRVhURU5TSU9OID0gJy5hcGsnO1xuXG5cbmNsYXNzIFNlbGVuZHJvaWREcml2ZXIgZXh0ZW5kcyBCYXNlRHJpdmVyIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSwgc2hvdWxkVmFsaWRhdGVDYXBzID0gdHJ1ZSkge1xuICAgIC8vIGBzaGVsbGAgb3ZlcndyaXRlcyBhZGIuc2hlbGwsIHNvIHJlbW92ZVxuICAgIGRlbGV0ZSBvcHRzLnNoZWxsO1xuXG4gICAgc3VwZXIob3B0cywgc2hvdWxkVmFsaWRhdGVDYXBzKTtcblxuICAgIHRoaXMuZGVzaXJlZENhcENvbnN0cmFpbnRzID0gZGVzaXJlZENhcENvbnN0cmFpbnRzO1xuICAgIHRoaXMuc2VsZW5kcm9pZCA9IG51bGw7XG4gICAgdGhpcy5qd3BQcm94eUFjdGl2ZSA9IGZhbHNlO1xuICAgIHRoaXMuZGVmYXVsdElNRSA9IG51bGw7XG4gICAgdGhpcy5qd3BQcm94eUF2b2lkID0gTk9fUFJPWFk7XG4gICAgdGhpcy5hcGtTdHJpbmdzID0ge307IC8vIG1hcCBvZiBsYW5ndWFnZSAtPiBzdHJpbmdzIG9ialxuXG4gICAgLy8gaGFuZGxlIHdlYnZpZXcgbWVjaGFuaWNzIGZyb20gQW5kcm9pZERyaXZlclxuICAgIHRoaXMuY2hyb21lZHJpdmVyID0gbnVsbDtcbiAgICB0aGlzLnNlc3Npb25DaHJvbWVkcml2ZXJzID0ge307XG5cbiAgICB0aGlzLm9wdHMuc3lzdGVtUG9ydCA9IG9wdHMuc2VsZW5kcm9pZFBvcnQgfHwgU1lTVEVNX1BPUlRfUkFOR0VbMF07XG4gICAgdGhpcy5vcHRzLmFkYlBvcnQgPSBvcHRzLmFkYlBvcnQgfHwgREVGQVVMVF9BREJfUE9SVDtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVNlc3Npb24gKGNhcHMpIHtcbiAgICB0cnkge1xuICAgICAgaWYgKCEoYXdhaXQgc2VydmVyRXhpc3RzKCkpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHN0YXJ0IGEgc2VsZW5kcm9pZCBzZXNzaW9uIGJlY2F1c2UgdGhlIHNlcnZlciAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICdhcGsgZG9lcyBub3QgZXhpc3QuIFBsZWFzZSBydW4gYG5wbSBydW4tc2NyaXB0ICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJ3NlbGVuZHJvaWRgIGluIHRoZSBhcHBpdW0tc2VsZW5kcm9pZC1kcml2ZXIgcGFja2FnZScpO1xuICAgICAgfVxuXG4gICAgICAvLyBUT0RPIGhhbmRsZSBvdGhlclNlc3Npb25EYXRhIGZvciBtdWx0aXBsZSBzZXNzaW9uc1xuICAgICAgbGV0IHNlc3Npb25JZDtcbiAgICAgIFtzZXNzaW9uSWRdID0gYXdhaXQgc3VwZXIuY3JlYXRlU2Vzc2lvbihjYXBzKTtcbiAgICAgIHRoaXMuY3VyQ29udGV4dCA9IHRoaXMuZGVmYXVsdENvbnRleHROYW1lKCk7XG4gICAgICAvLyBmYWlsIHZlcnkgZWFybHkgaWYgdGhlIGFwcCBkb2Vzbid0IGFjdHVhbGx5IGV4aXN0LCBzaW5jZSBzZWxlbmRyb2lkXG4gICAgICAvLyAodW5saWtlIHRoZSBhbmRyb2lkIGRyaXZlcikgY2FuJ3QgcnVuIGEgcHJlLWluc3RhbGxlZCBhcHAgYmFzZWRcbiAgICAgIC8vIG9ubHkgb24gcGFja2FnZSBuYW1lLiBJdCBoYXMgdG8gYmUgYW4gYWN0dWFsIGFwa1xuICAgICAgdGhpcy5vcHRzLmFwcCA9IGF3YWl0IHRoaXMuaGVscGVycy5jb25maWd1cmVBcHAodGhpcy5vcHRzLmFwcCwgQVBQX0VYVEVOU0lPTik7XG4gICAgICBhd2FpdCB0aGlzLmNoZWNrQXBwUHJlc2VudCgpO1xuICAgICAgdGhpcy5vcHRzLnN5c3RlbVBvcnQgPSB0aGlzLm9wdHMuc2VsZW5kcm9pZFBvcnQgfHwgU1lTVEVNX1BPUlRfUkFOR0VbMF07XG4gICAgICB0aGlzLm9wdHMuYWRiUG9ydCA9IHRoaXMub3B0cy5hZGJQb3J0IHx8IERFRkFVTFRfQURCX1BPUlQ7XG4gICAgICBhd2FpdCB0aGlzLnN0YXJ0U2VsZW5kcm9pZFNlc3Npb24oKTtcbiAgICAgIHJldHVybiBbc2Vzc2lvbklkLCBjYXBzXTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBhd2FpdCB0aGlzLmRlbGV0ZVNlc3Npb24oKTtcbiAgICAgIHRocm93IGU7XG4gICAgfVxuICB9XG5cbiAgdmFsaWRhdGVEZXNpcmVkQ2FwcyAoY2Fwcykge1xuICAgIC8vIGNoZWNrIHdpdGggdGhlIGJhc2UgY2xhc3MsIGFuZCByZXR1cm4gaWYgaXQgZmFpbHNcbiAgICBsZXQgcmVzID0gc3VwZXIudmFsaWRhdGVEZXNpcmVkQ2FwcyhjYXBzKTtcbiAgICBpZiAoIXJlcykgcmV0dXJuIHJlczsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuXG4gICAgaWYgKHRoaXMub3B0cy5yZWJvb3QpIHtcbiAgICAgIHRoaXMuc2V0QXZkRnJvbUNhcGFiaWxpdGllcyhjYXBzKTtcbiAgICB9XG4gIH1cblxuICBzZXRBdmRGcm9tQ2FwYWJpbGl0aWVzIChjYXBzKSB7XG4gICAgaWYgKHRoaXMub3B0cy5hdmQpIHtcbiAgICAgIGxvZ2dlci5pbmZvKCdhdmQgbmFtZSBkZWZpbmVkLCBpZ25vcmluZyBkZXZpY2UgbmFtZSBhbmQgcGxhdGZvcm0gdmVyc2lvbicpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIWNhcHMuZGV2aWNlTmFtZSkge1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdygnYXZkIG9yIGRldmljZU5hbWUgc2hvdWxkIGJlIHNwZWNpZmllZCB3aGVuIHJlYm9vdCBvcHRpb24gaXMgZW5hYmxlZCcpO1xuICAgICAgfVxuICAgICAgaWYgKCFjYXBzLnBsYXRmb3JtVmVyc2lvbikge1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdygnYXZkIG9yIHBsYXRmb3JtVmVyc2lvbiBzaG91bGQgYmUgc3BlY2lmaWVkIHdoZW4gcmVib290IG9wdGlvbiBpcyBlbmFibGVkJyk7XG4gICAgICB9XG4gICAgICBsZXQgYXZkRGV2aWNlID0gY2Fwcy5kZXZpY2VOYW1lLnJlcGxhY2UoL1teYS16QS1aMC05Xy5dL2csIFwiLVwiKTtcbiAgICAgIHRoaXMub3B0cy5hdmQgPSBgJHthdmREZXZpY2V9X18ke2NhcHMucGxhdGZvcm1WZXJzaW9ufWA7XG4gICAgfVxuICB9XG5cbiAgZ2V0IGRyaXZlckRhdGEgKCkge1xuICAgIC8vIFRPRE8gZmlsbGUgb3V0IHJlc291cmNlIGluZm8gaGVyZVxuICAgIHJldHVybiB7fTtcbiAgfVxuXG4gIGlzRW11bGF0b3IgKCkge1xuICAgIHJldHVybiAhIXRoaXMub3B0cy5hdmQ7XG4gIH1cblxuICBhc3luYyBzdGFydFNlbGVuZHJvaWRTZXNzaW9uICgpIHtcbiAgICBpZiAoIXRoaXMub3B0cy5qYXZhVmVyc2lvbikge1xuICAgICAgdGhpcy5vcHRzLmphdmFWZXJzaW9uID0gYXdhaXQgaGVscGVycy5nZXRKYXZhVmVyc2lvbigpO1xuICAgIH1cblxuICAgIC8vIGdldCBkZXZpY2UgdWRpZCBmb3IgdGhpcyBzZXNzaW9uXG4gICAgbGV0IHt1ZGlkLCBlbVBvcnR9ID0gYXdhaXQgaGVscGVycy5nZXREZXZpY2VJbmZvRnJvbUNhcHModGhpcy5vcHRzKTtcbiAgICB0aGlzLm9wdHMudWRpZCA9IHVkaWQ7XG4gICAgdGhpcy5vcHRzLmVtUG9ydCA9IGVtUG9ydDtcblxuICAgIC8vIG5vdyB0aGF0IHdlIGtub3cgb3VyIGphdmEgdmVyc2lvbiBhbmQgZGV2aWNlIGluZm8sIHdlIGNhbiBjcmVhdGUgb3VyXG4gICAgLy8gQURCIGluc3RhbmNlXG4gICAgdGhpcy5hZGIgPSBhd2FpdCBhbmRyb2lkSGVscGVycy5jcmVhdGVBREIodGhpcy5vcHRzKTtcbiAgICAvLyBmYWlsIHZlcnkgZWFybHkgaWYgdGhlIHVzZXIncyBhcHAgZG9lc24ndCBoYXZlIHRoZSBhcHByb3ByaWF0ZSBwZXJtc1xuICAgIC8vIGZvciBzZWxlbmRyb2lkIGF1dG9tYXRpb25cbiAgICBhd2FpdCBoZWxwZXJzLmVuc3VyZUludGVybmV0UGVybWlzc2lvbkZvckFwcCh0aGlzLmFkYiwgdGhpcy5vcHRzLmFwcCk7XG4gICAgLy8gZ2V0IGFwcFBhY2thZ2UgZXQgYWwgZnJvbSBtYW5pZmVzdCBpZiBuZWNlc3NhcnlcbiAgICBsZXQgYXBwSW5mbyA9IGF3YWl0IGhlbHBlcnMuZ2V0TGF1bmNoSW5mbyh0aGlzLmFkYiwgdGhpcy5vcHRzKTtcbiAgICAvLyBhbmQgZ2V0IGl0IG9udG8gb3VyICdvcHRzJyBvYmplY3Qgc28gd2UgdXNlIGl0IGZyb20gbm93IG9uXG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLm9wdHMsIGFwcEluZm8pO1xuICAgIC8vIHNldCB1cCB0aGUgbW9kaWZpZWQgc2VsZW5kcm9pZCBzZXJ2ZXIgZXRjXG4gICAgYXdhaXQgdGhpcy5pbml0U2VsZW5kcm9pZFNlcnZlcigpO1xuICAgIC8vIHN0YXJ0IGFuIGF2ZCwgc2V0IHRoZSBsYW5ndWFnZS9sb2NhbGUsIHBpY2sgYW4gZW11bGF0b3IsIGV0Yy4uLlxuICAgIC8vIFRPRE8gd2l0aCBtdWx0aXBsZSBkZXZpY2VzIHdlJ2xsIG5lZWQgdG8gcGFyYW1ldGVyaXplIHRoaXNcbiAgICBhd2FpdCBoZWxwZXJzLmluaXREZXZpY2UodGhpcy5hZGIsIHRoaXMub3B0cyk7XG4gICAgLy8gRnVydGhlciBwcmVwYXJlIHRoZSBkZXZpY2UgYnkgZm9yd2FyZGluZyB0aGUgU2VsZW5kcm9pZCBwb3J0XG4gICAgYXdhaXQgdGhpcy5hZGIuZm9yd2FyZFBvcnQodGhpcy5vcHRzLnN5c3RlbVBvcnQsIERFVklDRV9QT1JUKTtcbiAgICAvLyBwcmVwYXJlIG91ciBhY3R1YWwgQVVULCBnZXQgaXQgb24gdGhlIGRldmljZSwgZXRjLi4uXG4gICAgYXdhaXQgdGhpcy5pbml0QVVUKCk7XG4gICAgLy8gdW5sb2NrIHRoZSBkZXZpY2UgdG8gcHJlcGFyZSBpdCBmb3IgdGVzdGluZ1xuICAgIGF3YWl0IGhlbHBlcnMudW5sb2NrKHRoaXMsIHRoaXMuYWRiLCB0aGlzLmNhcHMpO1xuICAgIC8vIGxhdW5jaCBzZWxlbmRyb2lkIGFuZCB3YWl0IHRpbGwgaXRzIG9ubGluZSBhbmQgd2UgaGF2ZSBhIHNlc3Npb25cbiAgICBhd2FpdCB0aGlzLnNlbGVuZHJvaWQuc3RhcnRTZXNzaW9uKHRoaXMuY2Fwcyk7XG4gICAgLy8gcmVzY3VlIHNlbGVuZHJvaWQgaWYgaXQgZmFpbHMgdG8gc3RhcnQgb3VyIEFVVFxuICAgIGF3YWl0IHRoaXMuZW5zdXJlQXBwU3RhcnRzKCk7XG4gICAgLy8gaWYgd2Ugd2FudCB0byBpbW1lZGlhdGVseSBnZXQgaW50byBhIHdlYnZpZXcsIHNldCBvdXIgY29udGV4dFxuICAgIC8vIGFwcHJvcHJpYXRlbHlcbiAgICBpZiAodGhpcy5vcHRzLmF1dG9XZWJ2aWV3KSB7XG4gICAgICBhd2FpdCByZXRyeUludGVydmFsKDIwLCB0aGlzLm9wdHMuYXV0b1dlYnZpZXdUaW1lb3V0IHx8IDIwMDAsIGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5zZXRDb250ZXh0KHRoaXMuZGVmYXVsdFdlYnZpZXdOYW1lKCkpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIC8vIG5vdyB0aGF0IGV2ZXJ5dGhpbmcgaGFzIHN0YXJ0ZWQgc3VjY2Vzc2Z1bGx5LCB0dXJuIG9uIHByb3h5aW5nIHNvIGFsbFxuICAgIC8vIHN1YnNlcXVlbnQgc2Vzc2lvbiByZXF1ZXN0cyBnbyBzdHJhaWdodCB0by9mcm9tIHNlbGVuZHJvaWRcbiAgICB0aGlzLmp3cFByb3h5QWN0aXZlID0gdHJ1ZTtcbiAgfVxuXG4gIGFzeW5jIGluaXRTZWxlbmRyb2lkU2VydmVyICgpIHtcbiAgICAvLyBub3cgdGhhdCB3ZSBoYXZlIHBhY2thZ2UgYW5kIGFjdGl2aXR5LCB3ZSBjYW4gY3JlYXRlIGFuIGluc3RhbmNlIG9mXG4gICAgLy8gc2VsZW5kcm9pZCB3aXRoIHRoZSBhcHByb3ByaWF0ZSBkYXRhXG4gICAgdGhpcy5zZWxlbmRyb2lkID0gbmV3IFNlbGVuZHJvaWRTZXJ2ZXIoe1xuICAgICAgaG9zdDogdGhpcy5vcHRzLmhvc3QgfHwgJ2xvY2FsaG9zdCcsXG4gICAgICBzeXN0ZW1Qb3J0OiB0aGlzLm9wdHMuc3lzdGVtUG9ydCxcbiAgICAgIGRldmljZVBvcnQ6IERFVklDRV9QT1JULFxuICAgICAgYWRiOiB0aGlzLmFkYixcbiAgICAgIGFwazogdGhpcy5vcHRzLmFwcCxcbiAgICAgIHRtcERpcjogdGhpcy5vcHRzLnRtcERpcixcbiAgICAgIGFwcFBhY2thZ2U6IHRoaXMub3B0cy5hcHBQYWNrYWdlLFxuICAgICAgYXBwQWN0aXZpdHk6IHRoaXMub3B0cy5hcHBBY3Rpdml0eSxcbiAgICB9KTtcbiAgICB0aGlzLnByb3h5UmVxUmVzID0gdGhpcy5zZWxlbmRyb2lkLnByb3h5UmVxUmVzLmJpbmQodGhpcy5zZWxlbmRyb2lkKTtcbiAgICAvLyBsZXQgc2VsZW5kcm9pZCByZXBhY2thZ2UgaXRzZWxmIGZvciBvdXIgQVVUXG4gICAgYXdhaXQgdGhpcy5zZWxlbmRyb2lkLnByZXBhcmVNb2RpZmllZFNlcnZlcigpO1xuICB9XG5cbiAgYXN5bmMgaW5pdEFVVCAoKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdJbml0aWFsaXppbmcgYXBwbGljYXRpb24gdW5kZXIgdGVzdCcpO1xuICAgIC8vIHNldCB0aGUgbG9jYWxpemVkIHN0cmluZ3MgZm9yIHRoZSBjdXJyZW50IGxhbmd1YWdlIGZyb20gdGhlIGFwa1xuICAgIC8vIFRPRE86IGluY29ycG9yYXRlIGNoYW5nZXMgZnJvbSBhcHBpdW0jNTMwOCB3aGljaCBmaXggYSByYWNlIGNvbmQtXG4gICAgLy8gaXRpb24gYnVnIGluIG9sZCBhcHBpdW0gYW5kIG5lZWQgdG8gYmUgcmVwbGljYXRlZCBoZXJlXG4gICAgdGhpcy5hcGtTdHJpbmdzW3RoaXMub3B0cy5sYW5ndWFnZV0gPSBhd2FpdCBoZWxwZXJzLnB1c2hTdHJpbmdzKFxuICAgICAgICB0aGlzLm9wdHMubGFuZ3VhZ2UsIHRoaXMuYWRiLCB0aGlzLm9wdHMpO1xuICAgIGlmICghdGhpcy5vcHRzLnNraXBVbmluc3RhbGwpIHtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnVuaW5zdGFsbEFwayh0aGlzLm9wdHMuYXBwUGFja2FnZSk7XG4gICAgfVxuICAgIGlmICghdGhpcy5vcHRzLm5vU2lnbikge1xuICAgICAgbGV0IHNpZ25lZCA9IGF3YWl0IHRoaXMuYWRiLmNoZWNrQXBrQ2VydCh0aGlzLm9wdHMuYXBwLCB0aGlzLm9wdHMuYXBwUGFja2FnZSk7XG4gICAgICBpZiAoIXNpZ25lZCkge1xuICAgICAgICBsb2dnZXIuZGVidWcoJ0FwcGxpY2F0aW9uIG5vdCBzaWduZWQuIFNpZ25pbmcuJyk7XG4gICAgICAgIGF3YWl0IHRoaXMuYWRiLnNpZ24odGhpcy5vcHRzLmFwcCwgdGhpcy5vcHRzLmFwcFBhY2thZ2UpO1xuICAgICAgfVxuICAgIH1cbiAgICBhd2FpdCBoZWxwZXJzLmluc3RhbGxBcGsodGhpcy5hZGIsIHRoaXMub3B0cyk7XG4gICAgLy8gZ2V0IFNlbGVuZHJvaWQgb24gdGhlIGRldmljZSB0b29cbiAgICBhd2FpdCB0aGlzLnNlbGVuZHJvaWQuaW5zdGFsbE1vZGlmaWVkU2VydmVyKCk7XG4gIH1cblxuICBhc3luYyBlbnN1cmVBcHBTdGFydHMgKCkge1xuICAgIC8vIG1ha2Ugc3VyZSB3ZSBoYXZlIGFuIGFjdGl2aXR5IGFuZCBwYWNrYWdlIHRvIHdhaXQgZm9yXG4gICAgbGV0IGFwcFdhaXRQYWNrYWdlID0gdGhpcy5vcHRzLmFwcFdhaXRQYWNrYWdlIHx8IHRoaXMub3B0cy5hcHBQYWNrYWdlO1xuICAgIGxldCBhcHBXYWl0QWN0aXZpdHkgPSB0aGlzLm9wdHMuYXBwV2FpdEFjdGl2aXR5IHx8IHRoaXMub3B0cy5hcHBBY3Rpdml0eTtcbiAgICB0cnkge1xuICAgICAgLy8gd2FpdCBmb3IgdXAgdG8gNXMgZm9yIHNlbGVuZHJvaWQgdG8gaGF2ZSBzdGFydGVkIHRoZSBhcHAgYWZ0ZXIgaXQgaXNcbiAgICAgIC8vIG9ubGluZVxuICAgICAgYXdhaXQgdGhpcy5hZGIud2FpdEZvckFjdGl2aXR5KGFwcFdhaXRQYWNrYWdlLCBhcHBXYWl0QWN0aXZpdHksIDUwMDApO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZ2dlci5pbmZvKGBTZWxlbmRyb2lkIGRpZCBub3Qgc3RhcnQgdGhlIGFjdGl2aXR5IHdlIHdlcmUgd2FpdGluZyBmb3IsIGAgK1xuICAgICAgICAgICAgICAgICAgYCcke2FwcFdhaXRQYWNrYWdlfS8ke2FwcFdhaXRBY3Rpdml0eX0nLiBgICtcbiAgICAgICAgICAgICAgICAgIGBTdGFydGluZyBpdCBvdXJzZWx2ZXNgKTtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnN0YXJ0QXBwKHtcbiAgICAgICAgcGtnOiB0aGlzLm9wdHMuYXBwUGFja2FnZSxcbiAgICAgICAgYWN0aXZpdHk6IHRoaXMub3B0cy5hcHBBY3Rpdml0eSxcbiAgICAgICAgYWN0aW9uOiB0aGlzLm9wdHMuaW50ZW50QWN0aW9uLFxuICAgICAgICBjYXRlZ29yeTogdGhpcy5vcHRzLmludGVudENhdGVnb3J5LFxuICAgICAgICBmbGFnczogdGhpcy5vcHRzLmludGVudEZsYWdzLFxuICAgICAgICB3YWl0UGtnOiB0aGlzLm9wdHMuYXBwV2FpdFBhY2thZ2UsXG4gICAgICAgIHdhaXRBY3Rpdml0eTogdGhpcy5vcHRzLmFwcFdhaXRBY3Rpdml0eSxcbiAgICAgICAgb3B0aW9uYWxJbnRlbnRBcmd1bWVudHM6IHRoaXMub3B0cy5vcHRpb25hbEludGVudEFyZ3VtZW50cyxcbiAgICAgICAgc3RvcEFwcDogIXRoaXMub3B0cy5kb250U3RvcEFwcE9uUmVzZXQsXG4gICAgICAgIHJldHJ5OiBmYWxzZVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZGVsZXRlU2Vzc2lvbiAoKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdEZWxldGluZyBTZWxlbmRyb2lkIHNlc3Npb24nKTtcbiAgICBpZiAodGhpcy5zZWxlbmRyb2lkKSB7XG4gICAgICBpZiAodGhpcy5qd3BQcm94eUFjdGl2ZSkge1xuICAgICAgICBhd2FpdCB0aGlzLnNlbGVuZHJvaWQuZGVsZXRlU2Vzc2lvbigpO1xuICAgICAgfVxuICAgICAgdGhpcy5zZWxlbmRyb2lkID0gbnVsbDtcbiAgICB9XG4gICAgdGhpcy5qd3BQcm94eUFjdGl2ZSA9IGZhbHNlO1xuXG4gICAgaWYgKHRoaXMuYWRiKSB7XG4gICAgICBpZiAodGhpcy5vcHRzLnVuaWNvZGVLZXlib2FyZCAmJiB0aGlzLm9wdHMucmVzZXRLZXlib2FyZCAmJlxuICAgICAgICAgIHRoaXMuZGVmYXVsdElNRSkge1xuICAgICAgICBsb2dnZXIuZGVidWcoYFJlc2V0dGluZyBJTUUgdG8gJyR7dGhpcy5kZWZhdWx0SU1FfSdgKTtcbiAgICAgICAgYXdhaXQgdGhpcy5hZGIuc2V0SU1FKHRoaXMuZGVmYXVsdElNRSk7XG4gICAgICB9XG4gICAgICBhd2FpdCB0aGlzLmFkYi5mb3JjZVN0b3AodGhpcy5vcHRzLmFwcFBhY2thZ2UpO1xuICAgICAgYXdhaXQgdGhpcy5hZGIuc3RvcExvZ2NhdCgpO1xuICAgICAgaWYgKHRoaXMub3B0cy5yZWJvb3QpIHtcbiAgICAgICAgbGV0IGF2ZE5hbWUgPSB0aGlzLm9wdHMuYXZkLnJlcGxhY2UoJ0AnLCAnJyk7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgY2xvc2luZyBlbXVsYXRvciAnJHthdmROYW1lfSdgKTtcbiAgICAgICAgYXdhaXQgdGhpcy5hZGIua2lsbEVtdWxhdG9yKGF2ZE5hbWUpO1xuICAgICAgfVxuICAgIH1cbiAgICBhd2FpdCBzdXBlci5kZWxldGVTZXNzaW9uKCk7XG4gIH1cblxuICBhc3luYyBjaGVja0FwcFByZXNlbnQgKCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnQ2hlY2tpbmcgd2hldGhlciBhcHAgaXMgYWN0dWFsbHkgcHJlc2VudCcpO1xuICAgIGlmICghKGF3YWl0IGZzLmV4aXN0cyh0aGlzLm9wdHMuYXBwKSkpIHtcbiAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KGBDb3VsZCBub3QgZmluZCBhcHAgYXBrIGF0ICcke3RoaXMub3B0cy5hcHB9J2ApO1xuICAgIH1cbiAgfVxuXG4gIGRlZmF1bHRXZWJ2aWV3TmFtZSAoKSB7XG4gICAgcmV0dXJuIGAke1dFQlZJRVdfQkFTRX0wYDtcbiAgfVxuXG4gIHByb3h5QWN0aXZlIChzZXNzaW9uSWQpIHtcbiAgICBzdXBlci5wcm94eUFjdGl2ZShzZXNzaW9uSWQpO1xuXG4gICAgLy8gd2UgYWx3YXlzIGhhdmUgYW4gYWN0aXZlIHByb3h5IHRvIHRoZSBzZWxlbmRyb2lkIHNlcnZlclxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgZ2V0UHJveHlBdm9pZExpc3QgKHNlc3Npb25JZCkge1xuICAgIHN1cGVyLmdldFByb3h5QXZvaWRMaXN0KHNlc3Npb25JZCk7XG5cbiAgICByZXR1cm4gdGhpcy5qd3BQcm94eUF2b2lkO1xuICB9XG5cbiAgY2FuUHJveHkgKHNlc3Npb25JZCkge1xuICAgIHN1cGVyLmNhblByb3h5KHNlc3Npb25JZCk7XG5cbiAgICAvLyB3ZSBjYW4gYWx3YXlzIHByb3h5IHRvIHRoZSBzZWxlbmRyb2lkIHNlcnZlclxuICAgIHJldHVybiB0cnVlO1xuICB9XG59XG5cbi8vIGZpcnN0IGFkZCB0aGUgYW5kcm9pZC1kcml2ZXIgY29tbWFuZHMgd2hpY2ggd2Ugd2lsbCBmYWxsIGJhY2sgdG9cbmZvciAobGV0IFtjbWQsIGZuXSBvZiBfLnRvUGFpcnMoYW5kcm9pZENvbW1hbmRzKSkge1xuICAvLyB3ZSBkbyBzb21lIGRpZmZlcmVudC9zcGVjaWFsIHRoaW5ncyB3aXRoIHRoZXNlIG1ldGhvZHNcbiAgaWYgKCFfLmluY2x1ZGVzKFsnZGVmYXVsdFdlYnZpZXdOYW1lJ10sIGNtZCkpIHtcbiAgICBTZWxlbmRyb2lkRHJpdmVyLnByb3RvdHlwZVtjbWRdID0gZm47XG4gIH1cbn1cblxuLy8gdGhlbiBvdmVyd3JpdGUgd2l0aCBhbnkgc2VsZW5kcm9pZC1zcGVjaWZpYyBjb21tYW5kc1xuZm9yIChsZXQgW2NtZCwgZm5dIG9mIF8udG9QYWlycyhjb21tYW5kcykpIHtcbiAgU2VsZW5kcm9pZERyaXZlci5wcm90b3R5cGVbY21kXSA9IGZuO1xufVxuXG5leHBvcnQgeyBTZWxlbmRyb2lkRHJpdmVyLCBERVZJQ0VfUE9SVCB9O1xuZXhwb3J0IGRlZmF1bHQgU2VsZW5kcm9pZERyaXZlcjtcbiJdLCJmaWxlIjoibGliL2RyaXZlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
