"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _lodash = _interopRequireDefault(require("lodash"));

var _fs2 = _interopRequireDefault(require("fs"));

var _teen_process = require("teen_process");

var _path = _interopRequireDefault(require("path"));

var _logger = _interopRequireDefault(require("../logger.js"));

var _appiumSupport = require("appium-support");

var _helpers = require("../helpers.js");

const DEFAULT_PRIVATE_KEY = _path.default.resolve(_helpers.rootDir, 'keys', 'testkey.pk8');

const DEFAULT_CERTIFICATE = _path.default.resolve(_helpers.rootDir, 'keys', 'testkey.x509.pem');

const DEFAULT_CERT_DIGEST = 'a40da80a59d170caa950cf15c18c454d47a39b26989d8b640ecd745ba71bf5dc';
const BUNDLETOOL_TUTORIAL = 'https://developer.android.com/studio/command-line/bundletool';
const APKSIGNER_VERIFY_FAIL = 'DOES NOT VERIFY';
let apkSigningMethods = {};

function patchApksigner(_x) {
  return _patchApksigner.apply(this, arguments);
}

function _patchApksigner() {
  _patchApksigner = (0, _asyncToGenerator2.default)(function* (originalPath) {
    const originalContent = yield _appiumSupport.fs.readFile(originalPath, 'ascii');
    const patchedContent = originalContent.replace('-Djava.ext.dirs="%frameworkdir%"', '-cp "%frameworkdir%\\*"');

    if (patchedContent === originalContent) {
      return originalPath;
    }

    _logger.default.debug(`Patching '${originalPath}...`);

    const patchedPath = yield _appiumSupport.tempDir.path({
      prefix: 'apksigner',
      suffix: '.bat'
    });
    yield (0, _appiumSupport.mkdirp)(_path.default.dirname(patchedPath));
    yield _appiumSupport.fs.writeFile(patchedPath, patchedContent, 'ascii');
    return patchedPath;
  });
  return _patchApksigner.apply(this, arguments);
}

apkSigningMethods.executeApksigner = function () {
  var _executeApksigner = (0, _asyncToGenerator2.default)(function* (args = []) {
    const apkSigner = yield (0, _helpers.getApksignerForOs)(this);

    const originalFolder = _path.default.dirname(apkSigner);

    const getApksignerOutput = function () {
      var _ref = (0, _asyncToGenerator2.default)(function* (apksignerPath) {
        let binaryPath = apksignerPath;

        if (_appiumSupport.system.isWindows() && _appiumSupport.util.isSubPath(binaryPath, originalFolder)) {
          binaryPath = _path.default.basename(binaryPath);
        }

        const _ref2 = yield (0, _teen_process.exec)(binaryPath, args, {
          cwd: originalFolder
        }),
              stdout = _ref2.stdout,
              stderr = _ref2.stderr;

        var _arr = [['stdout', stdout], ['stderr', stderr]];

        for (var _i = 0; _i < _arr.length; _i++) {
          let _arr$_i = (0, _slicedToArray2.default)(_arr[_i], 2),
              name = _arr$_i[0],
              stream = _arr$_i[1];

          if (!stream) {
            continue;
          }

          if (name === 'stdout') {
            stream = stream.split('\n').filter(line => !line.includes('WARNING:')).join('\n');
          }

          _logger.default.debug(`apksigner ${name}: ${stream}`);
        }

        return stdout;
      });

      return function getApksignerOutput(_x2) {
        return _ref.apply(this, arguments);
      };
    }();

    _logger.default.debug(`Starting '${apkSigner}' with args '${JSON.stringify(args)}'`);

    try {
      return yield getApksignerOutput(apkSigner);
    } catch (err) {
      _logger.default.warn(`Got an error during apksigner execution: ${err.message}`);

      var _arr2 = [['stdout', err.stdout], ['stderr', err.stderr]];

      for (var _i2 = 0; _i2 < _arr2.length; _i2++) {
        const _arr2$_i = (0, _slicedToArray2.default)(_arr2[_i2], 2),
              name = _arr2$_i[0],
              stream = _arr2$_i[1];

        if (stream) {
          _logger.default.warn(`apksigner ${name}: ${stream}`);
        }
      }

      if (_appiumSupport.system.isWindows()) {
        const patchedApksigner = yield patchApksigner(apkSigner);

        if (patchedApksigner !== apkSigner) {
          try {
            return yield getApksignerOutput(patchedApksigner);
          } finally {
            yield _appiumSupport.fs.unlink(patchedApksigner);
          }
        }
      }

      throw err;
    }
  });

  return function executeApksigner() {
    return _executeApksigner.apply(this, arguments);
  };
}();

apkSigningMethods.signWithDefaultCert = function () {
  var _signWithDefaultCert = (0, _asyncToGenerator2.default)(function* (apk) {
    _logger.default.debug(`Signing '${apk}' with default cert`);

    if (!(yield _appiumSupport.fs.exists(apk))) {
      throw new Error(`${apk} file doesn't exist.`);
    }

    try {
      const args = ['sign', '--key', DEFAULT_PRIVATE_KEY, '--cert', DEFAULT_CERTIFICATE, apk];
      yield this.executeApksigner(args);
    } catch (err) {
      _logger.default.warn(`Cannot use apksigner tool for signing. Defaulting to sign.jar. ` + `Original error: ${err.message}` + (err.stderr ? `; StdErr: ${err.stderr}` : ''));

      const java = (0, _helpers.getJavaForOs)();

      const signPath = _path.default.resolve(this.helperJarPath, 'sign.jar');

      _logger.default.debug('Resigning apk.');

      try {
        yield (0, _teen_process.exec)(java, ['-jar', signPath, apk, '--override']);
      } catch (e) {
        throw new Error(`Could not sign with default certificate. Original error ${e.message}`);
      }
    }
  });

  return function signWithDefaultCert(_x3) {
    return _signWithDefaultCert.apply(this, arguments);
  };
}();

apkSigningMethods.signWithCustomCert = function () {
  var _signWithCustomCert = (0, _asyncToGenerator2.default)(function* (apk) {
    _logger.default.debug(`Signing '${apk}' with custom cert`);

    if (!(yield _appiumSupport.fs.exists(this.keystorePath))) {
      throw new Error(`Keystore: ${this.keystorePath} doesn't exist.`);
    }

    if (!(yield _appiumSupport.fs.exists(apk))) {
      throw new Error(`'${apk}' doesn't exist.`);
    }

    try {
      const args = ['sign', '--ks', this.keystorePath, '--ks-key-alias', this.keyAlias, '--ks-pass', `pass:${this.keystorePassword}`, '--key-pass', `pass:${this.keyPassword}`, apk];
      yield this.executeApksigner(args);
    } catch (err) {
      _logger.default.warn(`Cannot use apksigner tool for signing. Defaulting to jarsigner. ` + `Original error: ${err.message}`);

      try {
        _logger.default.debug('Unsigning apk.');

        yield (0, _teen_process.exec)((0, _helpers.getJavaForOs)(), ['-jar', _path.default.resolve(this.helperJarPath, 'unsign.jar'), apk]);

        _logger.default.debug('Signing apk.');

        const jarsigner = _path.default.resolve((0, _helpers.getJavaHome)(), 'bin', `jarsigner${_appiumSupport.system.isWindows() ? '.exe' : ''}`);

        yield (0, _teen_process.exec)(jarsigner, ['-sigalg', 'MD5withRSA', '-digestalg', 'SHA1', '-keystore', this.keystorePath, '-storepass', this.keystorePassword, '-keypass', this.keyPassword, apk, this.keyAlias]);
      } catch (e) {
        throw new Error(`Could not sign with custom certificate. Original error ${e.message}`);
      }
    }
  });

  return function signWithCustomCert(_x4) {
    return _signWithCustomCert.apply(this, arguments);
  };
}();

apkSigningMethods.sign = function () {
  var _sign = (0, _asyncToGenerator2.default)(function* (appPath) {
    if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
      let message = 'Signing of .apks-files is not supported. ';

      if (this.useKeystore) {
        message += 'Consider manual application bundle signing with the custom keystore ' + `like it is described at ${BUNDLETOOL_TUTORIAL}`;
      } else {
        message += `Consider manual application bundle signing with the key at '${DEFAULT_PRIVATE_KEY}' ` + `and the certificate at '${DEFAULT_CERTIFICATE}'. Read ${BUNDLETOOL_TUTORIAL} for more details.`;
      }

      _logger.default.warn(message);

      return;
    }

    let apksignerFound = true;

    try {
      yield (0, _helpers.getApksignerForOs)(this);
    } catch (err) {
      apksignerFound = false;
    }

    if (apksignerFound) {
      yield this.zipAlignApk(appPath);
    }

    if (this.useKeystore) {
      yield this.signWithCustomCert(appPath);
    } else {
      yield this.signWithDefaultCert(appPath);
    }

    if (!apksignerFound) {
      yield this.zipAlignApk(appPath);
    }
  });

  return function sign(_x5) {
    return _sign.apply(this, arguments);
  };
}();

apkSigningMethods.zipAlignApk = function () {
  var _zipAlignApk = (0, _asyncToGenerator2.default)(function* (apk) {
    yield this.initZipAlign();

    try {
      yield (0, _teen_process.exec)(this.binaries.zipalign, ['-c', '4', apk]);

      _logger.default.debug(`${apk}' is already zip-aligned. Doing nothing`);

      return false;
    } catch (e) {
      _logger.default.debug(`'${apk}' is not zip-aligned. Aligning`);
    }

    try {
      yield _appiumSupport.fs.access(apk, _fs2.default.W_OK);
    } catch (e) {
      throw new Error(`The file at '${apk}' is not writeable. ` + `Please grant write permissions to this file or to its parent folder '${_path.default.dirname(apk)}' ` + `for the Appium process, so it can zip-align the file`);
    }

    const alignedApk = yield _appiumSupport.tempDir.path({
      prefix: 'appium',
      suffix: '.tmp'
    });
    yield (0, _appiumSupport.mkdirp)(_path.default.dirname(alignedApk));

    try {
      yield (0, _teen_process.exec)(this.binaries.zipalign, ['-f', '4', apk, alignedApk]);
      yield _appiumSupport.fs.mv(alignedApk, apk, {
        mkdirp: true
      });
      return true;
    } catch (e) {
      if (yield _appiumSupport.fs.exists(alignedApk)) {
        yield _appiumSupport.fs.unlink(alignedApk);
      }

      throw new Error(`zipAlignApk failed. Original error: ${e.message}. Stdout: '${e.stdout}'; Stderr: '${e.stderr}'`);
    }
  });

  return function zipAlignApk(_x6) {
    return _zipAlignApk.apply(this, arguments);
  };
}();

apkSigningMethods.checkApkCert = function () {
  var _checkApkCert = (0, _asyncToGenerator2.default)(function* (appPath, pkg) {
    _logger.default.debug(`Checking app cert for ${appPath}`);

    if (!(yield _appiumSupport.fs.exists(appPath))) {
      _logger.default.debug(`'${appPath}' does not exist`);

      return false;
    }

    if (this.useKeystore) {
      return yield this.checkCustomApkCert(appPath, pkg);
    }

    if (_path.default.extname(appPath) === _helpers.APKS_EXTENSION) {
      appPath = yield this.extractBaseApk(appPath);
    }

    try {
      yield (0, _helpers.getApksignerForOs)(this);
      const output = yield this.executeApksigner(['verify', '--print-certs', appPath]);

      if (!_lodash.default.includes(output, DEFAULT_CERT_DIGEST)) {
        _logger.default.debug(`'${appPath}' is signed with non-default certificate`);

        return false;
      }

      _logger.default.debug(`'${appPath}' is already signed.`);

      return true;
    } catch (err) {
      if (err.stderr && err.stderr.includes(APKSIGNER_VERIFY_FAIL)) {
        _logger.default.debug(`'${appPath}' is not signed with debug cert`);

        return false;
      }

      _logger.default.warn(`Cannot use apksigner tool for signature verification. ` + `Original error: ${err.message}`);
    }

    try {
      _logger.default.debug(`Defaulting to verify.jar`);

      yield (0, _teen_process.exec)((0, _helpers.getJavaForOs)(), ['-jar', _path.default.resolve(this.helperJarPath, 'verify.jar'), appPath]);

      _logger.default.debug(`'${appPath}' is already signed.`);

      return true;
    } catch (err) {
      _logger.default.debug(`'${appPath}' is not signed with debug cert${err.stderr ? `: ${err.stderr}` : ''}`);

      return false;
    }
  });

  return function checkApkCert(_x7, _x8) {
    return _checkApkCert.apply(this, arguments);
  };
}();

apkSigningMethods.checkCustomApkCert = function () {
  var _checkCustomApkCert = (0, _asyncToGenerator2.default)(function* (appPath, pkg) {
    _logger.default.debug(`Checking custom app cert for ${appPath}`);

    if (_path.default.extname(appPath) === _helpers.APKS_EXTENSION) {
      appPath = yield this.extractBaseApk(appPath);
    }

    let h = 'a-fA-F0-9';
    let md5Str = [`.*MD5.*((?:[${h}]{2}:){15}[${h}]{2})`];
    let md5 = new RegExp(md5Str, 'mi');

    let keytool = _path.default.resolve((0, _helpers.getJavaHome)(), 'bin', `keytool${_appiumSupport.system.isWindows() ? '.exe' : ''}`);

    let keystoreHash = yield this.getKeystoreMd5(keytool, md5);
    return yield this.checkApkKeystoreMatch(keytool, md5, keystoreHash, pkg, appPath);
  });

  return function checkCustomApkCert(_x9, _x10) {
    return _checkCustomApkCert.apply(this, arguments);
  };
}();

apkSigningMethods.getKeystoreMd5 = function () {
  var _getKeystoreMd = (0, _asyncToGenerator2.default)(function* (keytool, md5re) {
    _logger.default.debug('Printing keystore md5.');

    try {
      let _ref3 = yield (0, _teen_process.exec)(keytool, ['-v', '-list', '-alias', this.keyAlias, '-keystore', this.keystorePath, '-storepass', this.keystorePassword]),
          stdout = _ref3.stdout;

      let keystoreHash = md5re.exec(stdout);
      keystoreHash = keystoreHash ? keystoreHash[1] : null;

      _logger.default.debug(`Keystore MD5: ${keystoreHash}`);

      return keystoreHash;
    } catch (e) {
      throw new Error(`getKeystoreMd5 failed. Original error: ${e.message}`);
    }
  });

  return function getKeystoreMd5(_x11, _x12) {
    return _getKeystoreMd.apply(this, arguments);
  };
}();

apkSigningMethods.checkApkKeystoreMatch = function () {
  var _checkApkKeystoreMatch = (0, _asyncToGenerator2.default)(function* (keytool, md5re, keystoreHash, pkg, apk) {
    var _this = this;

    let entryHash = null;
    let rsa = /^META-INF\/.*\.[rR][sS][aA]$/;
    let foundKeystoreMatch = false;
    yield _appiumSupport.zip.readEntries(apk, function () {
      var _ref4 = (0, _asyncToGenerator2.default)(function* ({
        entry,
        extractEntryTo
      }) {
        entry = entry.fileName;

        if (!rsa.test(entry)) {
          return;
        }

        _logger.default.debug(`Entry: ${entry}`);

        let entryPath = _path.default.join(_this.tmpDir, pkg, 'cert');

        _logger.default.debug(`entryPath: ${entryPath}`);

        let entryFile = _path.default.join(entryPath, entry);

        _logger.default.debug(`entryFile: ${entryFile}`);

        yield _appiumSupport.fs.rimraf(entryPath);
        yield extractEntryTo(entryPath);

        _logger.default.debug('extracted!');

        _logger.default.debug('Printing apk md5.');

        let _ref5 = yield (0, _teen_process.exec)(keytool, ['-v', '-printcert', '-file', entryFile]),
            stdout = _ref5.stdout;

        entryHash = md5re.exec(stdout);
        entryHash = entryHash ? entryHash[1] : null;

        _logger.default.debug(`entryHash MD5: ${entryHash}`);

        _logger.default.debug(`keystore MD5: ${keystoreHash}`);

        let matchesKeystore = entryHash && entryHash === keystoreHash;

        _logger.default.debug(`Matches keystore? ${matchesKeystore}`);

        if (matchesKeystore) {
          foundKeystoreMatch = true;
          return false;
        }
      });

      return function (_x18) {
        return _ref4.apply(this, arguments);
      };
    }());
    return foundKeystoreMatch;
  });

  return function checkApkKeystoreMatch(_x13, _x14, _x15, _x16, _x17) {
    return _checkApkKeystoreMatch.apply(this, arguments);
  };
}();

var _default = apkSigningMethods;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90b29scy9hcGstc2lnbmluZy5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX1BSSVZBVEVfS0VZIiwicGF0aCIsInJlc29sdmUiLCJyb290RGlyIiwiREVGQVVMVF9DRVJUSUZJQ0FURSIsIkRFRkFVTFRfQ0VSVF9ESUdFU1QiLCJCVU5ETEVUT09MX1RVVE9SSUFMIiwiQVBLU0lHTkVSX1ZFUklGWV9GQUlMIiwiYXBrU2lnbmluZ01ldGhvZHMiLCJwYXRjaEFwa3NpZ25lciIsIm9yaWdpbmFsUGF0aCIsIm9yaWdpbmFsQ29udGVudCIsImZzIiwicmVhZEZpbGUiLCJwYXRjaGVkQ29udGVudCIsInJlcGxhY2UiLCJsb2ciLCJkZWJ1ZyIsInBhdGNoZWRQYXRoIiwidGVtcERpciIsInByZWZpeCIsInN1ZmZpeCIsImRpcm5hbWUiLCJ3cml0ZUZpbGUiLCJleGVjdXRlQXBrc2lnbmVyIiwiYXJncyIsImFwa1NpZ25lciIsIm9yaWdpbmFsRm9sZGVyIiwiZ2V0QXBrc2lnbmVyT3V0cHV0IiwiYXBrc2lnbmVyUGF0aCIsImJpbmFyeVBhdGgiLCJzeXN0ZW0iLCJpc1dpbmRvd3MiLCJ1dGlsIiwiaXNTdWJQYXRoIiwiYmFzZW5hbWUiLCJjd2QiLCJzdGRvdXQiLCJzdGRlcnIiLCJuYW1lIiwic3RyZWFtIiwic3BsaXQiLCJmaWx0ZXIiLCJsaW5lIiwiaW5jbHVkZXMiLCJqb2luIiwiSlNPTiIsInN0cmluZ2lmeSIsImVyciIsIndhcm4iLCJtZXNzYWdlIiwicGF0Y2hlZEFwa3NpZ25lciIsInVubGluayIsInNpZ25XaXRoRGVmYXVsdENlcnQiLCJhcGsiLCJleGlzdHMiLCJFcnJvciIsImphdmEiLCJzaWduUGF0aCIsImhlbHBlckphclBhdGgiLCJlIiwic2lnbldpdGhDdXN0b21DZXJ0Iiwia2V5c3RvcmVQYXRoIiwia2V5QWxpYXMiLCJrZXlzdG9yZVBhc3N3b3JkIiwia2V5UGFzc3dvcmQiLCJqYXJzaWduZXIiLCJzaWduIiwiYXBwUGF0aCIsImVuZHNXaXRoIiwiQVBLU19FWFRFTlNJT04iLCJ1c2VLZXlzdG9yZSIsImFwa3NpZ25lckZvdW5kIiwiemlwQWxpZ25BcGsiLCJpbml0WmlwQWxpZ24iLCJiaW5hcmllcyIsInppcGFsaWduIiwiYWNjZXNzIiwiX2ZzIiwiV19PSyIsImFsaWduZWRBcGsiLCJtdiIsIm1rZGlycCIsImNoZWNrQXBrQ2VydCIsInBrZyIsImNoZWNrQ3VzdG9tQXBrQ2VydCIsImV4dG5hbWUiLCJleHRyYWN0QmFzZUFwayIsIm91dHB1dCIsIl8iLCJoIiwibWQ1U3RyIiwibWQ1IiwiUmVnRXhwIiwia2V5dG9vbCIsImtleXN0b3JlSGFzaCIsImdldEtleXN0b3JlTWQ1IiwiY2hlY2tBcGtLZXlzdG9yZU1hdGNoIiwibWQ1cmUiLCJleGVjIiwiZW50cnlIYXNoIiwicnNhIiwiZm91bmRLZXlzdG9yZU1hdGNoIiwiemlwIiwicmVhZEVudHJpZXMiLCJlbnRyeSIsImV4dHJhY3RFbnRyeVRvIiwiZmlsZU5hbWUiLCJ0ZXN0IiwiZW50cnlQYXRoIiwidG1wRGlyIiwiZW50cnlGaWxlIiwicmltcmFmIiwibWF0Y2hlc0tleXN0b3JlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsbUJBQW1CLEdBQUdDLGNBQUtDLE9BQUwsQ0FBYUMsZ0JBQWIsRUFBc0IsTUFBdEIsRUFBOEIsYUFBOUIsQ0FBNUI7O0FBQ0EsTUFBTUMsbUJBQW1CLEdBQUdILGNBQUtDLE9BQUwsQ0FBYUMsZ0JBQWIsRUFBc0IsTUFBdEIsRUFBOEIsa0JBQTlCLENBQTVCOztBQUNBLE1BQU1FLG1CQUFtQixHQUFHLGtFQUE1QjtBQUNBLE1BQU1DLG1CQUFtQixHQUFHLDhEQUE1QjtBQUNBLE1BQU1DLHFCQUFxQixHQUFHLGlCQUE5QjtBQUVBLElBQUlDLGlCQUFpQixHQUFHLEVBQXhCOztTQVVlQyxjOzs7OztvREFBZixXQUErQkMsWUFBL0IsRUFBNkM7QUFDM0MsVUFBTUMsZUFB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aW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBfZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyLmpzJztcbmltcG9ydCB7IHRlbXBEaXIsIHN5c3RlbSwgbWtkaXJwLCBmcywgemlwLCB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgZ2V0SmF2YUZvck9zLCBnZXRBcGtzaWduZXJGb3JPcywgZ2V0SmF2YUhvbWUsIHJvb3REaXIsIEFQS1NfRVhURU5TSU9OIH0gZnJvbSAnLi4vaGVscGVycy5qcyc7XG5cbmNvbnN0IERFRkFVTFRfUFJJVkFURV9LRVkgPSBwYXRoLnJlc29sdmUocm9vdERpciwgJ2tleXMnLCAndGVzdGtleS5wazgnKTtcbmNvbnN0IERFRkFVTFRfQ0VSVElGSUNBVEUgPSBwYXRoLnJlc29sdmUocm9vdERpciwgJ2tleXMnLCAndGVzdGtleS54NTA5LnBlbScpO1xuY29uc3QgREVGQVVMVF9DRVJUX0RJR0VTVCA9ICdhNDBkYTgwYTU5ZDE3MGNhYTk1MGNmMTVjMThjNDU0ZDQ3YTM5YjI2OTg5ZDhiNjQwZWNkNzQ1YmE3MWJmNWRjJztcbmNvbnN0IEJVTkRMRVRPT0xfVFVUT1JJQUwgPSAnaHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vc3R1ZGlvL2NvbW1hbmQtbGluZS9idW5kbGV0b29sJztcbmNvbnN0IEFQS1NJR05FUl9WRVJJRllfRkFJTCA9ICdET0VTIE5PVCBWRVJJRlknO1xuXG5sZXQgYXBrU2lnbmluZ01ldGhvZHMgPSB7fTtcblxuLyoqXG4gKiBBcHBsaWVzIHRoZSBwYXRjaCwgd2hpY2ggd29ya2Fyb3VuZHMnLURqYXZhLmV4dC5kaXJzIGlzIG5vdCBzdXBwb3J0ZWQuIFVzZSAtY2xhc3NwYXRoIGluc3RlYWQuJ1xuICogZXJyb3Igb24gV2luZG93cyBieSBjcmVhdGluZyBhIHRlbXBvcmFyeSBwYXRjaGVkIGNvcHkgb2YgdGhlIG9yaWdpbmFsIGFwa3NpZ25lciBzY3JpcHQuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IG9yaWdpbmFsUGF0aCAtIFRoZSBvcmlnaW5hbCBwYXRoIHRvIGFwa3NpZ25lciB0b29sXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBwYXRjaGVkIHNjcmlwdCBvciB0aGUgc2FtZSBwYXRoIGlmIHRoZXJlIGlzXG4gKiAgICAgICAgICAgICAgICAgICBubyBuZWVkIHRvIHBhdGNoIHRoZSBvcmlnaW5hbCBmaWxlLlxuICovXG5hc3luYyBmdW5jdGlvbiBwYXRjaEFwa3NpZ25lciAob3JpZ2luYWxQYXRoKSB7XG4gIGNvbnN0IG9yaWdpbmFsQ29udGVudCA9IGF3YWl0IGZzLnJlYWRGaWxlKG9yaWdpbmFsUGF0aCwgJ2FzY2lpJyk7XG4gIGNvbnN0IHBhdGNoZWRDb250ZW50ID0gb3JpZ2luYWxDb250ZW50LnJlcGxhY2UoJy1EamF2YS5leHQuZGlycz1cIiVmcmFtZXdvcmtkaXIlXCInLFxuICAgICctY3AgXCIlZnJhbWV3b3JrZGlyJVxcXFwqXCInKTtcbiAgaWYgKHBhdGNoZWRDb250ZW50ID09PSBvcmlnaW5hbENvbnRlbnQpIHtcbiAgICByZXR1cm4gb3JpZ2luYWxQYXRoO1xuICB9XG4gIGxvZy5kZWJ1ZyhgUGF0Y2hpbmcgJyR7b3JpZ2luYWxQYXRofS4uLmApO1xuICBjb25zdCBwYXRjaGVkUGF0aCA9IGF3YWl0IHRlbXBEaXIucGF0aCh7cHJlZml4OiAnYXBrc2lnbmVyJywgc3VmZml4OiAnLmJhdCd9KTtcbiAgYXdhaXQgbWtkaXJwKHBhdGguZGlybmFtZShwYXRjaGVkUGF0aCkpO1xuICBhd2FpdCBmcy53cml0ZUZpbGUocGF0Y2hlZFBhdGgsIHBhdGNoZWRDb250ZW50LCAnYXNjaWknKTtcbiAgcmV0dXJuIHBhdGNoZWRQYXRoO1xufVxuXG4vKipcbiAqIEV4ZWN1dGUgYXBrc2lnbmVyIHV0aWxpdHkgd2l0aCBnaXZlbiBhcmd1bWVudHMuXG4gKlxuICogQHBhcmFtIHs/QXJyYXk8U3RyaW5nPn0gYXJncyAtIFRoZSBsaXN0IG9mIHRvb2wgYXJndW1lbnRzLlxuICogQHJldHVybiB7c3RyaW5nfSAtIENvbW1hbmQgc3Rkb3V0XG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgYXBrc2lnbmVyIGJpbmFyeSBpcyBub3QgcHJlc2VudCBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW1cbiAqICAgICAgICAgICAgICAgICBvciB0aGUgcmV0dXJuIGNvZGUgaXMgbm90IGVxdWFsIHRvIHplcm8uXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLmV4ZWN1dGVBcGtzaWduZXIgPSBhc3luYyBmdW5jdGlvbiBleGVjdXRlQXBrc2lnbmVyIChhcmdzID0gW10pIHtcbiAgY29uc3QgYXBrU2lnbmVyID0gYXdhaXQgZ2V0QXBrc2lnbmVyRm9yT3ModGhpcyk7XG4gIGNvbnN0IG9yaWdpbmFsRm9sZGVyID0gcGF0aC5kaXJuYW1lKGFwa1NpZ25lcik7XG4gIGNvbnN0IGdldEFwa3NpZ25lck91dHB1dCA9IGFzeW5jIChhcGtzaWduZXJQYXRoKSA9PiB7XG4gICAgbGV0IGJpbmFyeVBhdGggPSBhcGtzaWduZXJQYXRoO1xuICAgIGlmIChzeXN0ZW0uaXNXaW5kb3dzKCkgJiYgdXRpbC5pc1N1YlBhdGgoYmluYXJ5UGF0aCwgb3JpZ2luYWxGb2xkZXIpKSB7XG4gICAgICAvLyBXb3JrYXJvdW5kIGZvciBodHRwczovL2dpdGh1Yi5jb20vbm9kZWpzL25vZGUtdjAueC1hcmNoaXZlL2lzc3Vlcy8yNTg5NVxuICAgICAgYmluYXJ5UGF0aCA9IHBhdGguYmFzZW5hbWUoYmluYXJ5UGF0aCk7XG4gICAgfVxuICAgIGNvbnN0IHtzdGRvdXQsIHN0ZGVycn0gPSBhd2FpdCBleGVjKGJpbmFyeVBhdGgsIGFyZ3MsIHtcbiAgICAgIGN3ZDogb3JpZ2luYWxGb2xkZXJcbiAgICB9KTtcbiAgICBmb3IgKGxldCBbbmFtZSwgc3RyZWFtXSBvZiBbWydzdGRvdXQnLCBzdGRvdXRdLCBbJ3N0ZGVycicsIHN0ZGVycl1dKSB7XG4gICAgICBpZiAoIXN0cmVhbSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKG5hbWUgPT09ICdzdGRvdXQnKSB7XG4gICAgICAgIC8vIE1ha2UgdGhlIG91dHB1dCBsZXNzIHRhbGthdGl2ZVxuICAgICAgICBzdHJlYW0gPSBzdHJlYW0uc3BsaXQoJ1xcbicpXG4gICAgICAgICAgLmZpbHRlcigobGluZSkgPT4gIWxpbmUuaW5jbHVkZXMoJ1dBUk5JTkc6JykpXG4gICAgICAgICAgLmpvaW4oJ1xcbicpO1xuICAgICAgfVxuICAgICAgbG9nLmRlYnVnKGBhcGtzaWduZXIgJHtuYW1lfTogJHtzdHJlYW19YCk7XG4gICAgfVxuICAgIHJldHVybiBzdGRvdXQ7XG4gIH07XG4gIGxvZy5kZWJ1ZyhgU3RhcnRpbmcgJyR7YXBrU2lnbmVyfScgd2l0aCBhcmdzICcke0pTT04uc3RyaW5naWZ5KGFyZ3MpfSdgKTtcbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgZ2V0QXBrc2lnbmVyT3V0cHV0KGFwa1NpZ25lcik7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBHb3QgYW4gZXJyb3IgZHVyaW5nIGFwa3NpZ25lciBleGVjdXRpb246ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgZm9yIChjb25zdCBbbmFtZSwgc3RyZWFtXSBvZiBbWydzdGRvdXQnLCBlcnIuc3Rkb3V0XSwgWydzdGRlcnInLCBlcnIuc3RkZXJyXV0pIHtcbiAgICAgIGlmIChzdHJlYW0pIHtcbiAgICAgICAgbG9nLndhcm4oYGFwa3NpZ25lciAke25hbWV9OiAke3N0cmVhbX1gKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHN5c3RlbS5pc1dpbmRvd3MoKSkge1xuICAgICAgY29uc3QgcGF0Y2hlZEFwa3NpZ25lciA9IGF3YWl0IHBhdGNoQXBrc2lnbmVyKGFwa1NpZ25lcik7XG4gICAgICBpZiAocGF0Y2hlZEFwa3NpZ25lciAhPT0gYXBrU2lnbmVyKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgcmV0dXJuIGF3YWl0IGdldEFwa3NpZ25lck91dHB1dChwYXRjaGVkQXBrc2lnbmVyKTtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICBhd2FpdCBmcy51bmxpbmsocGF0Y2hlZEFwa3NpZ25lcik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgdGhyb3cgZXJyO1xuICB9XG59O1xuXG4vKipcbiAqIChSZSlzaWduIHRoZSBnaXZlbiBhcGsgZmlsZSBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW0gd2l0aCB0aGUgZGVmYXVsdCBjZXJ0aWZpY2F0ZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBrIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgbG9jYWwgYXBrIGZpbGUuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgc2lnbmluZyBmYWlscy5cbiAqL1xuYXBrU2lnbmluZ01ldGhvZHMuc2lnbldpdGhEZWZhdWx0Q2VydCA9IGFzeW5jIGZ1bmN0aW9uIHNpZ25XaXRoRGVmYXVsdENlcnQgKGFwaykge1xuICBsb2cuZGVidWcoYFNpZ25pbmcgJyR7YXBrfScgd2l0aCBkZWZhdWx0IGNlcnRgKTtcbiAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKGFwaykpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGAke2Fwa30gZmlsZSBkb2Vzbid0IGV4aXN0LmApO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBhcmdzID0gWydzaWduJyxcbiAgICAgICctLWtleScsIERFRkFVTFRfUFJJVkFURV9LRVksXG4gICAgICAnLS1jZXJ0JywgREVGQVVMVF9DRVJUSUZJQ0FURSxcbiAgICAgIGFwa107XG4gICAgYXdhaXQgdGhpcy5leGVjdXRlQXBrc2lnbmVyKGFyZ3MpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgQ2Fubm90IHVzZSBhcGtzaWduZXIgdG9vbCBmb3Igc2lnbmluZy4gRGVmYXVsdGluZyB0byBzaWduLmphci4gYCArXG4gICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCArIChlcnIuc3RkZXJyID8gYDsgU3RkRXJyOiAke2Vyci5zdGRlcnJ9YCA6ICcnKSk7XG4gICAgY29uc3QgamF2YSA9IGdldEphdmFGb3JPcygpO1xuICAgIGNvbnN0IHNpZ25QYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMuaGVscGVySmFyUGF0aCwgJ3NpZ24uamFyJyk7XG4gICAgbG9nLmRlYnVnKCdSZXNpZ25pbmcgYXBrLicpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBleGVjKGphdmEsIFsnLWphcicsIHNpZ25QYXRoLCBhcGssICctLW92ZXJyaWRlJ10pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IHNpZ24gd2l0aCBkZWZhdWx0IGNlcnRpZmljYXRlLiBPcmlnaW5hbCBlcnJvciAke2UubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cbn07XG5cbi8qKlxuICogKFJlKXNpZ24gdGhlIGdpdmVuIGFwayBmaWxlIG9uIHRoZSBsb2NhbCBmaWxlIHN5c3RlbSB3aXRoIGEgY3VzdG9tIGNlcnRpZmljYXRlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcGsgLSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBsb2NhbCBhcGsgZmlsZS5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBzaWduaW5nIGZhaWxzLlxuICovXG5hcGtTaWduaW5nTWV0aG9kcy5zaWduV2l0aEN1c3RvbUNlcnQgPSBhc3luYyBmdW5jdGlvbiBzaWduV2l0aEN1c3RvbUNlcnQgKGFwaykge1xuICBsb2cuZGVidWcoYFNpZ25pbmcgJyR7YXBrfScgd2l0aCBjdXN0b20gY2VydGApO1xuICBpZiAoIShhd2FpdCBmcy5leGlzdHModGhpcy5rZXlzdG9yZVBhdGgpKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgS2V5c3RvcmU6ICR7dGhpcy5rZXlzdG9yZVBhdGh9IGRvZXNuJ3QgZXhpc3QuYCk7XG4gIH1cbiAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKGFwaykpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGAnJHthcGt9JyBkb2Vzbid0IGV4aXN0LmApO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBhcmdzID0gWydzaWduJyxcbiAgICAgICctLWtzJywgdGhpcy5rZXlzdG9yZVBhdGgsXG4gICAgICAnLS1rcy1rZXktYWxpYXMnLCB0aGlzLmtleUFsaWFzLFxuICAgICAgJy0ta3MtcGFzcycsIGBwYXNzOiR7dGhpcy5rZXlzdG9yZVBhc3N3b3JkfWAsXG4gICAgICAnLS1rZXktcGFzcycsIGBwYXNzOiR7dGhpcy5rZXlQYXNzd29yZH1gLFxuICAgICAgYXBrXTtcbiAgICBhd2FpdCB0aGlzLmV4ZWN1dGVBcGtzaWduZXIoYXJncyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBDYW5ub3QgdXNlIGFwa3NpZ25lciB0b29sIGZvciBzaWduaW5nLiBEZWZhdWx0aW5nIHRvIGphcnNpZ25lci4gYCArXG4gICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgdHJ5IHtcbiAgICAgIGxvZy5kZWJ1ZygnVW5zaWduaW5nIGFway4nKTtcbiAgICAgIGF3YWl0IGV4ZWMoZ2V0SmF2YUZvck9zKCksIFsnLWphcicsIHBhdGgucmVzb2x2ZSh0aGlzLmhlbHBlckphclBhdGgsICd1bnNpZ24uamFyJyksIGFwa10pO1xuICAgICAgbG9nLmRlYnVnKCdTaWduaW5nIGFway4nKTtcbiAgICAgIGNvbnN0IGphcnNpZ25lciA9IHBhdGgucmVzb2x2ZShnZXRKYXZhSG9tZSgpLCAnYmluJywgYGphcnNpZ25lciR7c3lzdGVtLmlzV2luZG93cygpID8gJy5leGUnIDogJyd9YCk7XG4gICAgICBhd2FpdCBleGVjKGphcnNpZ25lciwgWyctc2lnYWxnJywgJ01ENXdpdGhSU0EnLCAnLWRpZ2VzdGFsZycsICdTSEExJyxcbiAgICAgICAgJy1rZXlzdG9yZScsIHRoaXMua2V5c3RvcmVQYXRoLCAnLXN0b3JlcGFzcycsIHRoaXMua2V5c3RvcmVQYXNzd29yZCxcbiAgICAgICAgJy1rZXlwYXNzJywgdGhpcy5rZXlQYXNzd29yZCwgYXBrLCB0aGlzLmtleUFsaWFzXSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3Qgc2lnbiB3aXRoIGN1c3RvbSBjZXJ0aWZpY2F0ZS4gT3JpZ2luYWwgZXJyb3IgJHtlLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG59O1xuXG4vKipcbiAqIChSZSlzaWduIHRoZSBnaXZlbiBhcGsgZmlsZSBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW0gd2l0aCBlaXRoZXJcbiAqIGN1c3RvbSBvciBkZWZhdWx0IGNlcnRpZmljYXRlIGJhc2VkIG9uIF90aGlzLnVzZUtleXN0b3JlXyBwcm9wZXJ0eSB2YWx1ZVxuICogYW5kIFppcC1hbGlnbnMgaXQgYWZ0ZXIgc2lnbmluZy5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBwUGF0aCAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIGxvY2FsIC5hcGsocykgZmlsZS5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBzaWduaW5nIGZhaWxzLlxuICovXG5hcGtTaWduaW5nTWV0aG9kcy5zaWduID0gYXN5bmMgZnVuY3Rpb24gc2lnbiAoYXBwUGF0aCkge1xuICBpZiAoYXBwUGF0aC5lbmRzV2l0aChBUEtTX0VYVEVOU0lPTikpIHtcbiAgICBsZXQgbWVzc2FnZSA9ICdTaWduaW5nIG9mIC5hcGtzLWZpbGVzIGlzIG5vdCBzdXBwb3J0ZWQuICc7XG4gICAgaWYgKHRoaXMudXNlS2V5c3RvcmUpIHtcbiAgICAgIG1lc3NhZ2UgKz0gJ0NvbnNpZGVyIG1hbnVhbCBhcHBsaWNhdGlvbiBidW5kbGUgc2lnbmluZyB3aXRoIHRoZSBjdXN0b20ga2V5c3RvcmUgJyArXG4gICAgICAgIGBsaWtlIGl0IGlzIGRlc2NyaWJlZCBhdCAke0JVTkRMRVRPT0xfVFVUT1JJQUx9YDtcbiAgICB9IGVsc2Uge1xuICAgICAgbWVzc2FnZSArPSBgQ29uc2lkZXIgbWFudWFsIGFwcGxpY2F0aW9uIGJ1bmRsZSBzaWduaW5nIHdpdGggdGhlIGtleSBhdCAnJHtERUZBVUxUX1BSSVZBVEVfS0VZfScgYCArXG4gICAgICAgIGBhbmQgdGhlIGNlcnRpZmljYXRlIGF0ICcke0RFRkFVTFRfQ0VSVElGSUNBVEV9Jy4gUmVhZCAke0JVTkRMRVRPT0xfVFVUT1JJQUx9IGZvciBtb3JlIGRldGFpbHMuYDtcbiAgICB9XG4gICAgbG9nLndhcm4obWVzc2FnZSk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbGV0IGFwa3NpZ25lckZvdW5kID0gdHJ1ZTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBnZXRBcGtzaWduZXJGb3JPcyh0aGlzKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgYXBrc2lnbmVyRm91bmQgPSBmYWxzZTtcbiAgfVxuXG4gIGlmIChhcGtzaWduZXJGb3VuZCkge1xuICAgIC8vIGl0IGlzIG5lY2Vzc2FyeSB0byBhcHBseSB6aXBhbGlnbiBvbmx5IGJlZm9yZSBzaWduaW5nXG4gICAgLy8gaWYgYXBrc2lnbmVyIGlzIHVzZWQgb3Igb25seSBhZnRlciBzaWduaW5nIGlmIHdlIG9ubHkgaGF2ZVxuICAgIC8vIHNpZ24uamFyIHV0aWxpdHlcbiAgICBhd2FpdCB0aGlzLnppcEFsaWduQXBrKGFwcFBhdGgpO1xuICB9XG5cbiAgaWYgKHRoaXMudXNlS2V5c3RvcmUpIHtcbiAgICBhd2FpdCB0aGlzLnNpZ25XaXRoQ3VzdG9tQ2VydChhcHBQYXRoKTtcbiAgfSBlbHNlIHtcbiAgICBhd2FpdCB0aGlzLnNpZ25XaXRoRGVmYXVsdENlcnQoYXBwUGF0aCk7XG4gIH1cblxuICBpZiAoIWFwa3NpZ25lckZvdW5kKSB7XG4gICAgYXdhaXQgdGhpcy56aXBBbGlnbkFwayhhcHBQYXRoKTtcbiAgfVxufTtcblxuLyoqXG4gKiBQZXJmb3JtIHppcC1hbGlnbmluZyB0byB0aGUgZ2l2ZW4gbG9jYWwgYXBrIGZpbGUuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwayAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIGxvY2FsIGFwayBmaWxlLlxuICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgdGhlIGFwayBoYXMgYmVlbiBzdWNjZXNzZnVsbHkgYWxpZ25lZFxuICogb3IgZmFsc2UgaWYgdGhlIGFwayBoYXMgYmVlbiBhbHJlYWR5IGFsaWduZWQuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgemlwLWFsaWduIGZhaWxzLlxuICovXG5hcGtTaWduaW5nTWV0aG9kcy56aXBBbGlnbkFwayA9IGFzeW5jIGZ1bmN0aW9uIHppcEFsaWduQXBrIChhcGspIHtcbiAgYXdhaXQgdGhpcy5pbml0WmlwQWxpZ24oKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBleGVjKHRoaXMuYmluYXJpZXMuemlwYWxpZ24sIFsnLWMnLCAnNCcsIGFwa10pO1xuICAgIGxvZy5kZWJ1ZyhgJHthcGt9JyBpcyBhbHJlYWR5IHppcC1hbGlnbmVkLiBEb2luZyBub3RoaW5nYCk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmRlYnVnKGAnJHthcGt9JyBpcyBub3QgemlwLWFsaWduZWQuIEFsaWduaW5nYCk7XG4gIH1cbiAgdHJ5IHtcbiAgICBhd2FpdCBmcy5hY2Nlc3MoYXBrLCBfZnMuV19PSyk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBmaWxlIGF0ICcke2Fwa30nIGlzIG5vdCB3cml0ZWFibGUuIGAgK1xuICAgICAgYFBsZWFzZSBncmFudCB3cml0ZSBwZXJtaXNzaW9ucyB0byB0aGlzIGZpbGUgb3IgdG8gaXRzIHBhcmVudCBmb2xkZXIgJyR7cGF0aC5kaXJuYW1lKGFwayl9JyBgICtcbiAgICAgIGBmb3IgdGhlIEFwcGl1bSBwcm9jZXNzLCBzbyBpdCBjYW4gemlwLWFsaWduIHRoZSBmaWxlYCk7XG4gIH1cbiAgY29uc3QgYWxpZ25lZEFwayA9IGF3YWl0IHRlbXBEaXIucGF0aCh7cHJlZml4OiAnYXBwaXVtJywgc3VmZml4OiAnLnRtcCd9KTtcbiAgYXdhaXQgbWtkaXJwKHBhdGguZGlybmFtZShhbGlnbmVkQXBrKSk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYyh0aGlzLmJpbmFyaWVzLnppcGFsaWduLCBbJy1mJywgJzQnLCBhcGssIGFsaWduZWRBcGtdKTtcbiAgICBhd2FpdCBmcy5tdihhbGlnbmVkQXBrLCBhcGssIHsgbWtkaXJwOiB0cnVlIH0pO1xuICAgIHJldHVybiB0cnVlO1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKGF3YWl0IGZzLmV4aXN0cyhhbGlnbmVkQXBrKSkge1xuICAgICAgYXdhaXQgZnMudW5saW5rKGFsaWduZWRBcGspO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoYHppcEFsaWduQXBrIGZhaWxlZC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfS4gU3Rkb3V0OiAnJHtlLnN0ZG91dH0nOyBTdGRlcnI6ICcke2Uuc3RkZXJyfSdgKTtcbiAgfVxufTtcblxuLyoqXG4gKiBDaGVjayBpZiB0aGUgYXBwIGlzIGFscmVhZHkgc2lnbmVkIHdpdGggdGhlIGRlZmF1bHQgQXBwaXVtIGNlcnRpZmljYXRlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBQYXRoIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgbG9jYWwgLmFwayhzKSBmaWxlLlxuICogQHBhcmFtIHtzdHJpbmd9IHBnayAtIFRoZSBuYW1lIG9mIGFwcGxpY2F0aW9uIHBhY2thZ2UuXG4gKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIGdpdmVuIGFwcGxpY2F0aW9uIGlzIGFscmVhZHkgc2lnbmVkLlxuICovXG5hcGtTaWduaW5nTWV0aG9kcy5jaGVja0Fwa0NlcnQgPSBhc3luYyBmdW5jdGlvbiBjaGVja0Fwa0NlcnQgKGFwcFBhdGgsIHBrZykge1xuICBsb2cuZGVidWcoYENoZWNraW5nIGFwcCBjZXJ0IGZvciAke2FwcFBhdGh9YCk7XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKGFwcFBhdGgpKSB7XG4gICAgbG9nLmRlYnVnKGAnJHthcHBQYXRofScgZG9lcyBub3QgZXhpc3RgKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBpZiAodGhpcy51c2VLZXlzdG9yZSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmNoZWNrQ3VzdG9tQXBrQ2VydChhcHBQYXRoLCBwa2cpO1xuICB9XG5cbiAgaWYgKHBhdGguZXh0bmFtZShhcHBQYXRoKSA9PT0gQVBLU19FWFRFTlNJT04pIHtcbiAgICBhcHBQYXRoID0gYXdhaXQgdGhpcy5leHRyYWN0QmFzZUFwayhhcHBQYXRoKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgYXdhaXQgZ2V0QXBrc2lnbmVyRm9yT3ModGhpcyk7XG4gICAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgdGhpcy5leGVjdXRlQXBrc2lnbmVyKFsndmVyaWZ5JywgJy0tcHJpbnQtY2VydHMnLCBhcHBQYXRoXSk7XG4gICAgaWYgKCFfLmluY2x1ZGVzKG91dHB1dCwgREVGQVVMVF9DRVJUX0RJR0VTVCkpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgJyR7YXBwUGF0aH0nIGlzIHNpZ25lZCB3aXRoIG5vbi1kZWZhdWx0IGNlcnRpZmljYXRlYCk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgJyR7YXBwUGF0aH0nIGlzIGFscmVhZHkgc2lnbmVkLmApO1xuICAgIHJldHVybiB0cnVlO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICAvLyBjaGVjayBpZiB0aGVyZSBpcyBubyBzaWduYXR1cmVcbiAgICBpZiAoZXJyLnN0ZGVyciAmJiBlcnIuc3RkZXJyLmluY2x1ZGVzKEFQS1NJR05FUl9WRVJJRllfRkFJTCkpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgJyR7YXBwUGF0aH0nIGlzIG5vdCBzaWduZWQgd2l0aCBkZWJ1ZyBjZXJ0YCk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGxvZy53YXJuKGBDYW5ub3QgdXNlIGFwa3NpZ25lciB0b29sIGZvciBzaWduYXR1cmUgdmVyaWZpY2F0aW9uLiBgICtcbiAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuXG4gIC8vIGRlZmF1bHQgdG8gdmVyaWZ5LmphclxuICB0cnkge1xuICAgIGxvZy5kZWJ1ZyhgRGVmYXVsdGluZyB0byB2ZXJpZnkuamFyYCk7XG4gICAgYXdhaXQgZXhlYyhnZXRKYXZhRm9yT3MoKSwgWyctamFyJywgcGF0aC5yZXNvbHZlKHRoaXMuaGVscGVySmFyUGF0aCwgJ3ZlcmlmeS5qYXInKSwgYXBwUGF0aF0pO1xuICAgIGxvZy5kZWJ1ZyhgJyR7YXBwUGF0aH0nIGlzIGFscmVhZHkgc2lnbmVkLmApO1xuICAgIHJldHVybiB0cnVlO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZGVidWcoYCcke2FwcFBhdGh9JyBpcyBub3Qgc2lnbmVkIHdpdGggZGVidWcgY2VydCR7ZXJyLnN0ZGVyciA/IGA6ICR7ZXJyLnN0ZGVycn1gIDogJyd9YCk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59O1xuXG4vKipcbiAqIENoZWNrIGlmIHRoZSBhcHAgaXMgYWxyZWFkeSBzaWduZWQgd2l0aCBhIGN1c3RvbSBjZXJ0aWZpY2F0ZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBwUGF0aCAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIGxvY2FsIGFwayhzKSBmaWxlLlxuICogQHBhcmFtIHtzdHJpbmd9IHBnayAtIFRoZSBuYW1lIG9mIGFwcGxpY2F0aW9uIHBhY2thZ2UuXG4gKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIGdpdmVuIGFwcGxpY2F0aW9uIGlzIGFscmVhZHkgc2lnbmVkIHdpdGggYSBjdXN0b20gY2VydGlmaWNhdGUuXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLmNoZWNrQ3VzdG9tQXBrQ2VydCA9IGFzeW5jIGZ1bmN0aW9uIGNoZWNrQ3VzdG9tQXBrQ2VydCAoYXBwUGF0aCwgcGtnKSB7XG4gIGxvZy5kZWJ1ZyhgQ2hlY2tpbmcgY3VzdG9tIGFwcCBjZXJ0IGZvciAke2FwcFBhdGh9YCk7XG5cbiAgaWYgKHBhdGguZXh0bmFtZShhcHBQYXRoKSA9PT0gQVBLU19FWFRFTlNJT04pIHtcbiAgICBhcHBQYXRoID0gYXdhaXQgdGhpcy5leHRyYWN0QmFzZUFwayhhcHBQYXRoKTtcbiAgfVxuXG4gIGxldCBoID0gJ2EtZkEtRjAtOSc7XG4gIGxldCBtZDVTdHIgPSBbYC4qTUQ1LiooKD86WyR7aH1dezJ9Oil7MTV9WyR7aH1dezJ9KWBdO1xuICBsZXQgbWQ1ID0gbmV3IFJlZ0V4cChtZDVTdHIsICdtaScpO1xuICBsZXQga2V5dG9vbCA9IHBhdGgucmVzb2x2ZShnZXRKYXZhSG9tZSgpLCAnYmluJywgYGtleXRvb2wke3N5c3RlbS5pc1dpbmRvd3MoKSA/ICcuZXhlJyA6ICcnfWApO1xuICBsZXQga2V5c3RvcmVIYXNoID0gYXdhaXQgdGhpcy5nZXRLZXlzdG9yZU1kNShrZXl0b29sLCBtZDUpO1xuICByZXR1cm4gYXdhaXQgdGhpcy5jaGVja0Fwa0tleXN0b3JlTWF0Y2goa2V5dG9vbCwgbWQ1LCBrZXlzdG9yZUhhc2gsIHBrZywgYXBwUGF0aCk7XG59O1xuXG4vKipcbiAqIEdldCB0aGUgTUQ1IGhhc2ggb2YgdGhlIGtleXN0b3JlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBrZXl0b29sIC0gVGhlIG5hbWUgb2YgdGhlIGtleXRvb2wgdXRpbGl0eS5cbiAqIEBwYXJhbSB7UmVnRXhwfSBtZDVyZSAtIFRoZSBwYXR0ZXJuIHVzZWQgdG8gbWF0Y2ggdGhlIHJlc3VsdCBpbiBfa2V5dG9vbF8gb3V0cHV0LlxuICogQHJldHVybiB7P3N0cmluZ30gS2V5c3RvcmUgTUQ1IGhhc2ggb3IgX251bGxfIGlmIHRoZSBoYXNoIGNhbm5vdCBiZSBwYXJzZWQuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgZ2V0dGluZyBrZXlzdG9yZSBNRDUgaGFzaCBmYWlscy5cbiAqL1xuYXBrU2lnbmluZ01ldGhvZHMuZ2V0S2V5c3RvcmVNZDUgPSBhc3luYyBmdW5jdGlvbiBnZXRLZXlzdG9yZU1kNSAoa2V5dG9vbCwgbWQ1cmUpIHtcbiAgbG9nLmRlYnVnKCdQcmludGluZyBrZXlzdG9yZSBtZDUuJyk7XG4gIHRyeSB7XG4gICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyhrZXl0b29sLCBbJy12JywgJy1saXN0JyxcbiAgICAgICctYWxpYXMnLCB0aGlzLmtleUFsaWFzLFxuICAgICAgJy1rZXlzdG9yZScsIHRoaXMua2V5c3RvcmVQYXRoLFxuICAgICAgJy1zdG9yZXBhc3MnLCB0aGlzLmtleXN0b3JlUGFzc3dvcmRdKTtcbiAgICBsZXQga2V5c3RvcmVIYXNoID0gbWQ1cmUuZXhlYyhzdGRvdXQpO1xuICAgIGtleXN0b3JlSGFzaCA9IGtleXN0b3JlSGFzaCA/IGtleXN0b3JlSGFzaFsxXSA6IG51bGw7XG4gICAgbG9nLmRlYnVnKGBLZXlzdG9yZSBNRDU6ICR7a2V5c3RvcmVIYXNofWApO1xuICAgIHJldHVybiBrZXlzdG9yZUhhc2g7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYGdldEtleXN0b3JlTWQ1IGZhaWxlZC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICB9XG59O1xuXG4vKipcbiAqIENoZWNrIGlmIHRoZSBNRDUgaGFzaCBvZiB0aGUgcGFydGljdWxhciBhcHBsaWNhdGlvbiBtYXRjaGVzIHRvIHRoZSBnaXZlbiBoYXNoLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBrZXl0b29sIC0gVGhlIG5hbWUgb2YgdGhlIGtleXRvb2wgdXRpbGl0eS5cbiAqIEBwYXJhbSB7UmVnRXhwfSBtZDVyZSAtIFRoZSBwYXR0ZXJuIHVzZWQgdG8gbWF0Y2ggdGhlIHJlc3VsdCBpbiBfa2V5dG9vbF8gb3V0cHV0LlxuICogQHBhcmFtIHtzdHJpbmd9IGtleXN0b3JlSGFzaCAtIFRoZSBleHBlY3RlZCBoYXNoIHZhbHVlLlxuICogQHBhcmFtIHtzdHJpbmd9IHBrZyAtIFRoZSBuYW1lIG9mIHRoZSBpbnN0YWxsZWQgcGFja2FnZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBhcGsgLSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBleGlzdGluZyBhcGsgZmlsZS5cbiAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgYm90aCBoYXNoZXMgYXJlIGVxdWFsLlxuICogQHRocm93cyB7RXJyb3J9IElmIGdldHRpbmcga2V5c3RvcmUgTUQ1IGhhc2ggZmFpbHMuXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLmNoZWNrQXBrS2V5c3RvcmVNYXRjaCA9IGFzeW5jIGZ1bmN0aW9uIGNoZWNrQXBrS2V5c3RvcmVNYXRjaCAoa2V5dG9vbCwgbWQ1cmUsIGtleXN0b3JlSGFzaCwgcGtnLCBhcGspIHtcbiAgbGV0IGVudHJ5SGFzaCA9IG51bGw7XG4gIGxldCByc2EgPSAvXk1FVEEtSU5GXFwvLipcXC5bclJdW3NTXVthQV0kLztcbiAgbGV0IGZvdW5kS2V5c3RvcmVNYXRjaCA9IGZhbHNlO1xuXG4gIC8vZm9yIChsZXQgZW50cnkgb2YgZW50cmllcykge1xuICBhd2FpdCB6aXAucmVhZEVudHJpZXMoYXBrLCBhc3luYyAoe2VudHJ5LCBleHRyYWN0RW50cnlUb30pID0+IHtcbiAgICBlbnRyeSA9IGVudHJ5LmZpbGVOYW1lO1xuICAgIGlmICghcnNhLnRlc3QoZW50cnkpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgRW50cnk6ICR7ZW50cnl9YCk7XG4gICAgbGV0IGVudHJ5UGF0aCA9IHBhdGguam9pbih0aGlzLnRtcERpciwgcGtnLCAnY2VydCcpO1xuICAgIGxvZy5kZWJ1ZyhgZW50cnlQYXRoOiAke2VudHJ5UGF0aH1gKTtcbiAgICBsZXQgZW50cnlGaWxlID0gcGF0aC5qb2luKGVudHJ5UGF0aCwgZW50cnkpO1xuICAgIGxvZy5kZWJ1ZyhgZW50cnlGaWxlOiAke2VudHJ5RmlsZX1gKTtcbiAgICAvLyBlbnN1cmUgL3RtcC9wa2cvY2VydC8gZG9lc24ndCBleGlzdCBvciBleHRyYWN0IHdpbGwgZmFpbC5cbiAgICBhd2FpdCBmcy5yaW1yYWYoZW50cnlQYXRoKTtcbiAgICAvLyBNRVRBLUlORi9DRVJULlJTQVxuICAgIGF3YWl0IGV4dHJhY3RFbnRyeVRvKGVudHJ5UGF0aCk7XG4gICAgbG9nLmRlYnVnKCdleHRyYWN0ZWQhJyk7XG4gICAgLy8gY2hlY2sgZm9yIG1hdGNoXG4gICAgbG9nLmRlYnVnKCdQcmludGluZyBhcGsgbWQ1LicpO1xuICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoa2V5dG9vbCwgWyctdicsICctcHJpbnRjZXJ0JywgJy1maWxlJywgZW50cnlGaWxlXSk7XG4gICAgZW50cnlIYXNoID0gbWQ1cmUuZXhlYyhzdGRvdXQpO1xuICAgIGVudHJ5SGFzaCA9IGVudHJ5SGFzaCA/IGVudHJ5SGFzaFsxXSA6IG51bGw7XG4gICAgbG9nLmRlYnVnKGBlbnRyeUhhc2ggTUQ1OiAke2VudHJ5SGFzaH1gKTtcbiAgICBsb2cuZGVidWcoYGtleXN0b3JlIE1ENTogJHtrZXlzdG9yZUhhc2h9YCk7XG4gICAgbGV0IG1hdGNoZXNLZXlzdG9yZSA9IGVudHJ5SGFzaCAmJiBlbnRyeUhhc2ggPT09IGtleXN0b3JlSGFzaDtcbiAgICBsb2cuZGVidWcoYE1hdGNoZXMga2V5c3RvcmU/ICR7bWF0Y2hlc0tleXN0b3JlfWApO1xuXG4gICAgLy8gSWYgd2UgaGF2ZSBhIGtleXN0b3JlIG1hdGNoLCBzdG9wIGl0ZXJhdGluZ1xuICAgIGlmIChtYXRjaGVzS2V5c3RvcmUpIHtcbiAgICAgIGZvdW5kS2V5c3RvcmVNYXRjaCA9IHRydWU7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIGZvdW5kS2V5c3RvcmVNYXRjaDtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGFwa1NpZ25pbmdNZXRob2RzO1xuIl0sImZpbGUiOiJsaWIvdG9vbHMvYXBrLXNpZ25pbmcuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
