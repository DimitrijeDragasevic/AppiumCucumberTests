"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.hasContent = hasContent;
exports.hasValue = hasValue;
exports.escapeSpace = escapeSpace;
exports.escapeSpecialChars = escapeSpecialChars;
exports.localIp = localIp;
exports.cancellableDelay = cancellableDelay;
exports.multiResolve = multiResolve;
exports.safeJsonParse = safeJsonParse;
exports.unwrapElement = unwrapElement;
exports.filterObject = filterObject;
exports.toReadableSizeString = toReadableSizeString;
exports.isSubPath = isSubPath;
exports.isSameDestination = isSameDestination;
exports.W3C_WEB_ELEMENT_IDENTIFIER = void 0;

require("source-map-support/register");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _lodash = _interopRequireDefault(require("lodash"));

var _os = _interopRequireDefault(require("os"));

var _path = _interopRequireDefault(require("path"));

var _fs = _interopRequireDefault(require("./fs"));

const W3C_WEB_ELEMENT_IDENTIFIER = 'element-6066-11e4-a52e-4f735466cecf';
exports.W3C_WEB_ELEMENT_IDENTIFIER = W3C_WEB_ELEMENT_IDENTIFIER;

function hasContent(val) {
  return _lodash.default.isString(val) && val !== "";
}

function hasValue(val) {
  let hasVal = false;

  if (_lodash.default.isNumber(val)) {
    hasVal = !_lodash.default.isNaN(val);
  } else {
    hasVal = !_lodash.default.isUndefined(val) && !_lodash.default.isNull(val);
  }

  return hasVal;
}

function escapeSpace(str) {
  return str.split(/ /).join('\\ ');
}

function escapeSpecialChars(str, quoteEscape) {
  if (typeof str !== "string") {
    return str;
  }

  if (typeof quoteEscape === "undefined") {
    quoteEscape = false;
  }

  str = str.replace(/[\\]/g, '\\\\').replace(/[\/]/g, '\\/').replace(/[\b]/g, '\\b').replace(/[\f]/g, '\\f').replace(/[\n]/g, '\\n').replace(/[\r]/g, '\\r').replace(/[\t]/g, '\\t').replace(/[\"]/g, '\\"').replace(/\\'/g, "\\'");

  if (quoteEscape) {
    let re = new RegExp(quoteEscape, "g");
    str = str.replace(re, `\\${quoteEscape}`);
  }

  return str;
}

function localIp() {
  let ip = _lodash.default.chain(_os.default.networkInterfaces()).values().flatten().filter(function (val) {
    return val.family === 'IPv4' && val.internal === false;
  }).map('address').first().value();

  return ip;
}

function cancellableDelay(ms) {
  let timer;
  let resolve;
  let reject;
  const delay = new _bluebird.default.Promise((_resolve, _reject) => {
    resolve = _resolve;
    reject = _reject;
    timer = setTimeout(function () {
      resolve();
    }, ms);
  });

  delay.cancel = function () {
    clearTimeout(timer);
    reject(new _bluebird.default.CancellationError());
  };

  return delay;
}

function multiResolve(roots, ...args) {
  return roots.map(root => {
    return _path.default.resolve(root, ...args);
  });
}

function safeJsonParse(obj) {
  try {
    obj = JSON.parse(obj);
  } catch (ign) {}

  return obj;
}

function unwrapElement(el) {
  for (const propName of [W3C_WEB_ELEMENT_IDENTIFIER, 'ELEMENT']) {
    if (_lodash.default.has(el, propName)) {
      return el[propName];
    }
  }

  return el;
}

function filterObject(obj, predicate) {
  let newObj = _lodash.default.clone(obj);

  if (_lodash.default.isUndefined(predicate)) {
    predicate = v => !_lodash.default.isUndefined(v);
  } else if (!_lodash.default.isFunction(predicate)) {
    const valuePredicate = predicate;

    predicate = v => v === valuePredicate;
  }

  for (const key of Object.keys(obj)) {
    if (!predicate(obj[key], obj)) {
      delete newObj[key];
    }
  }

  return newObj;
}

function toReadableSizeString(bytes) {
  const intBytes = parseInt(bytes, 10);

  if (isNaN(intBytes) || intBytes < 0) {
    throw new Error(`Cannot convert '${bytes}' to a readable size format`);
  }

  if (intBytes >= 1024 * 1024 * 1024) {
    return `${parseFloat(intBytes / (1024 * 1024 * 1024.0)).toFixed(2)} GB`;
  } else if (intBytes >= 1024 * 1024) {
    return `${parseFloat(intBytes / (1024 * 1024.0)).toFixed(2)} MB`;
  } else if (intBytes >= 1024) {
    return `${parseFloat(intBytes / 1024.0).toFixed(2)} KB`;
  }

  return `${intBytes} B`;
}

function isSubPath(originalPath, root, forcePosix = null) {
  const pathObj = forcePosix ? _path.default.posix : _path.default;

  for (const p of [originalPath, root]) {
    if (!pathObj.isAbsolute(p)) {
      throw new Error(`'${p}' is expected to be an absolute path`);
    }
  }

  const normalizedRoot = pathObj.normalize(root);
  const normalizedPath = pathObj.normalize(originalPath);
  return normalizedPath.startsWith(normalizedRoot);
}

async function isSameDestination(path1, path2, ...pathN) {
  const allPaths = [path1, path2, ...pathN];

  if (!(await _bluebird.default.reduce(allPaths, async (a, b) => a && (await _fs.default.exists(b)), true))) {
    return false;
  }

  const areAllItemsEqual = arr => !!arr.reduce((a, b) => a === b ? a : NaN);

  if (areAllItemsEqual(allPaths)) {
    return true;
  }

  return areAllItemsEqual((await _bluebird.default.map(allPaths, async x => (await _fs.default.stat(x)).ino)));
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91dGlsLmpzIl0sIm5hbWVzIjpbIlczQ19XRUJfRUxFTUVOVF9JREVOVElGSUVSIiwiaGFzQ29udGVudCIsInZhbCIsIl8iLCJpc1N0cmluZyIsImhhc1ZhbHVlIiwiaGFzVmFsIiwiaXNOdW1iZXIiLCJpc05hTiIsImlzVW5kZWZpbmVkIiwiaXNOdWxsIiwiZXNjYXBlU3BhY2UiLCJzdHIiLCJzcGxpdCIsImpvaW4iLCJlc2NhcGVTcGVjaWFsQ2hhcnMiLCJxdW90ZUVzY2FwZSIsInJlcGxhY2UiLCJyZSIsIlJlZ0V4cCIsImxvY2FsSXAiLCJpcCIsImNoYWluIiwib3MiLCJuZXR3b3JrSW50ZXJmYWNlcyIsInZhbHVlcyIsImZsYXR0ZW4iLCJmaWx0ZXIiLCJmYW1pbHkiLCJpbnRlcm5hbCIsIm1hcCIsImZpcnN0IiwidmFsdWUiLCJjYW5jZWxsYWJsZURlbGF5IiwibXMiLCJ0aW1lciIsInJlc29sdmUiLCJyZWplY3QiLCJkZWxheSIsIkIiLCJQcm9taXNlIiwiX3Jlc29sdmUiLCJfcmVqZWN0Iiwic2V0VGltZW91dCIsImNhbmNlbCIsImNsZWFyVGltZW91dCIsIkNhbmNlbGxhdGlvbkVycm9yIiwibXVsdGlSZXNvbHZlIiwicm9vdHMiLCJhcmdzIiwicm9vdCIsInBhdGgiLCJzYWZlSnNvblBhcnNlIiwib2JqIiwiSlNPTiIsInBhcnNlIiwiaWduIiwidW53cmFwRWxlbWVudCIsImVsIiwicHJvcE5hbWUiLCJoYXMiLCJmaWx0ZXJPYmplY3QiLCJwcmVkaWNhdGUiLCJuZXdPYmoiLCJjbG9uZSIsInYiLCJpc0Z1bmN0aW9uIiwidmFsdWVQcmVkaWNhdGUiLCJrZXkiLCJPYmplY3QiLCJrZXlzIiwidG9SZWFkYWJsZVNpemVTdHJpbmciLCJieXRlcyIsImludEJ5dGVzIiwicGFyc2VJbnQiLCJFcnJvciIsInBhcnNlRmxvYXQiLCJ0b0ZpeGVkIiwiaXNTdWJQYXRoIiwib3JpZ2luYWxQYXRoIiwiZm9yY2VQb3NpeCIsInBhdGhPYmoiLCJwb3NpeCIsInAiLCJpc0Fic29sdXRlIiwibm9ybWFsaXplZFJvb3QiLCJub3JtYWxpemUiLCJub3JtYWxpemVkUGF0aCIsInN0YXJ0c1dpdGgiLCJpc1NhbWVEZXN0aW5hdGlvbiIsInBhdGgxIiwicGF0aDIiLCJwYXRoTiIsImFsbFBhdGhzIiwicmVkdWNlIiwiYSIsImIiLCJmcyIsImV4aXN0cyIsImFyZUFsbEl0ZW1zRXF1YWwiLCJhcnIiLCJOYU4iLCJ4Iiwic3RhdCIsImlubyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsMEJBQTBCLEdBQUcscUNBQW5DOzs7QUFFTyxTQUFTQyxVQUFULENBQXFCQyxHQUFyQixFQUEwQjtBQUMvQixTQUFPQyxnQkFBRUMsUUFBRixDQUFXRixHQUFYLEtBQW1CQSxHQUFHLEtBQUssRUFBbEM7QUFDRDs7QUFHRCxTQUFTRyxRQUFULENBQW1CSCxHQUFuQixFQUF3QjtBQUN0QixNQUFJSSxNQUFNLEdBQUcsS0FBYjs7QUFFQSxNQUFJSCxnQkFBRUksUUFBRixDQUFXTCxHQUFYLENBQUosRUFBcUI7QUFDbkJJLElBQUFBLE1BQU0sR0FBRyxDQUFDSCxnQkFBRUssS0FBRixDQUFRTixHQUFSLENBQVY7QUFDRCxHQUZELE1BRU87QUFDTEksSUFBQUEsTUFBTSxHQUFHLENBQUNILGdCQUFFTSxXQUFGLENBQWNQLEdBQWQsQ0FBRCxJQUF1QixDQUFDQyxnQkFBRU8sTUFBRixDQUFTUixHQUFULENBQWpDO0FBQ0Q7O0FBRUQsU0FBT0ksTUFBUDtBQUNEOztBQUdELFNBQVNLLFdBQVQsQ0FBc0JDLEdBQXRCLEVBQTJCO0FBQ3pCLFNBQU9BLEdBQUcsQ0FBQ0MsS0FBSixDQUFVLEdBQVYsRUFBZUMsSUFBZixDQUFvQixLQUFwQixDQUFQO0FBQ0Q7O0FBRUQsU0FBU0Msa0JBQVQsQ0FBNkJILEdBQTdCLEVBQWtDSSxXQUFsQyxFQUErQztBQUM3QyxNQUFJLE9BQU9KLEdBQVAsS0FBZSxR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QWtCUCxZQUFsQixDQUF2QjtBQUNBLFNBQU9RLGNBQWMsQ0FBQ0MsVUFBZixDQUEwQkgsY0FBMUIsQ0FBUDtBQUNEOztBQVdELGVBQWVJLGlCQUFmLENBQWtDQyxLQUFsQyxFQUF5Q0MsS0FBekMsRUFBZ0QsR0FBR0MsS0FBbkQsRUFBMEQ7QUFDeEQsUUFBTUMsUUFBUSxHQUFHLENBQUNILEtBQUQsRUFBUUMsS0FBUixFQUFlLEdBQUdDLEtBQWxCLENBQWpCOztBQUNBLE1BQUksRUFBQyxNQUFNckQsa0JBQUV1RCxNQUFGLENBQVNELFFBQVQsRUFBbUIsT0FBT0UsQ0FBUCxFQUFVQyxDQUFWLEtBQWdCRCxDQUFDLEtBQUksTUFBTUUsWUFBR0MsTUFBSCxDQUFVRixDQUFWLENBQVYsQ0FBcEMsRUFBNEQsSUFBNUQsQ0FBUCxDQUFKLEVBQThFO0FBQzVFLFdBQU8sS0FBUDtBQUNEOztBQUVELFFBQU1HLGdCQUFnQixHQUFJQyxHQUFELElBQVMsQ0FBQyxDQUFDQSxHQUFHLENBQUNOLE1BQUosQ0FBVyxDQUFDQyxDQUFELEVBQUlDLENBQUosS0FBVUQsQ0FBQyxLQUFLQyxDQUFOLEdBQVVELENBQVYsR0FBY00sR0FBbkMsQ0FBcEM7O0FBQ0EsTUFBSUYsZ0JBQWdCLENBQUNOLFFBQUQsQ0FBcEIsRUFBZ0M7QUFDOUIsV0FBTyxJQUFQO0FBQ0Q7O0FBQ0QsU0FBT00sZ0JBQWdCLEVBQUMsTUFBTTVELGtCQUFFVCxHQUFGLENBQU0rRCxRQUFOLEVBQWdCLE1BQU9TLENBQVAsSUFBYSxDQUFDLE1BQU1MLFlBQUdNLElBQUgsQ0FBUUQsQ0FBUixDQUFQLEVBQW1CRSxHQUFoRCxDQUFQLEVBQXZCO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGZzIGZyb20gJy4vZnMnO1xuXG5jb25zdCBXM0NfV0VCX0VMRU1FTlRfSURFTlRJRklFUiA9ICdlbGVtZW50LTYwNjYtMTFlNC1hNTJlLTRmNzM1NDY2Y2VjZic7XG5cbmV4cG9ydCBmdW5jdGlvbiBoYXNDb250ZW50ICh2YWwpIHtcbiAgcmV0dXJuIF8uaXNTdHJpbmcodmFsKSAmJiB2YWwgIT09IFwiXCI7XG59XG5cbi8vIHJldHVybiB0cnVlIGlmIHRoZSB0aGUgdmFsdWUgaXMgbm90IHVuZGVmaW5lZCwgbnVsbCwgb3IgTmFOLlxuZnVuY3Rpb24gaGFzVmFsdWUgKHZhbCkge1xuICBsZXQgaGFzVmFsID0gZmFsc2U7XG4gIC8vIGF2b2lkIGluY29ycmVjdGx5IGV2YWx1YXRpbmcgYDBgIGFzIGZhbHNlXG4gIGlmIChfLmlzTnVtYmVyKHZhbCkpIHtcbiAgICBoYXNWYWwgPSAhXy5pc05hTih2YWwpO1xuICB9IGVsc2Uge1xuICAgIGhhc1ZhbCA9ICFfLmlzVW5kZWZpbmVkKHZhbCkgJiYgIV8uaXNOdWxsKHZhbCk7XG4gIH1cblxuICByZXR1cm4gaGFzVmFsO1xufVxuXG4vLyBlc2NhcGUgc3BhY2VzIGluIHN0cmluZywgZm9yIGNvbW1hbmRsaW5lIGNhbGxzXG5mdW5jdGlvbiBlc2NhcGVTcGFjZSAoc3RyKSB7XG4gIHJldHVybiBzdHIuc3BsaXQoLyAvKS5qb2luKCdcXFxcICcpO1xufVxuXG5mdW5jdGlvbiBlc2NhcGVTcGVjaWFsQ2hhcnMgKHN0ciwgcXVvdGVFc2NhcGUpIHtcbiAgaWYgKHR5cGVvZiBzdHIgIT09IFwic3RyaW5nXCIpIHtcbiAgICByZXR1cm4gc3RyO1xuICB9XG4gIGlmICh0eXBlb2YgcXVvdGVFc2NhcGUgPT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICBxdW90ZUVzY2FwZSA9IGZhbHNlO1xuICB9XG4gIHN0ciA9IHN0clxuICAgIC5yZXBsYWNlKC9bXFxcXF0vZywgJ1xcXFxcXFxcJylcbiAgICAucmVwbGFjZSgvW1xcL10vZywgJ1xcXFwvJykgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby11c2VsZXNzLWVzY2FwZVxuICAgIC5yZXBsYWNlKC9bXFxiXS9nLCAnXFxcXGInKVxuICAgIC5yZXBsYWNlKC9bXFxmXS9nLCAnXFxcXGYnKVxuICAgIC5yZXBsYWNlKC9bXFxuXS9nLCAnXFxcXG4nKVxuICAgIC5yZXBsYWNlKC9bXFxyXS9nLCAnXFxcXHInKVxuICAgIC5yZXBsYWNlKC9bXFx0XS9nLCAnXFxcXHQnKVxuICAgIC5yZXBsYWNlKC9bXFxcIl0vZywgJ1xcXFxcIicpIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdXNlbGVzcy1lc2NhcGVcbiAgICAucmVwbGFjZSgvXFxcXCcvZywgXCJcXFxcJ1wiKTtcbiAgaWYgKHF1b3RlRXNjYXBlKSB7XG4gICAgbGV0IHJlID0gbmV3IFJlZ0V4cChxdW90ZUVzY2FwZSwgXCJnXCIpO1xuICAgIHN0ciA9IHN0ci5yZXBsYWNlKHJlLCBgXFxcXCR7cXVvdGVFc2NhcGV9YCk7XG4gIH1cbiAgcmV0dXJuIHN0cjtcbn1cblxuZnVuY3Rpb24gbG9jYWxJcCAoKSB7XG4gIGxldCBpcCA9IF8uY2hhaW4ob3MubmV0d29ya0ludGVyZmFjZXMoKSlcbiAgICAudmFsdWVzKClcbiAgICAuZmxhdHRlbigpXG4gICAgLmZpbHRlcihmdW5jdGlvbiAodmFsKSB7XG4gICAgICByZXR1cm4gKHZhbC5mYW1pbHkgPT09ICdJUHY0JyAmJiB2YWwuaW50ZXJuYWwgPT09IGZhbHNlKTtcbiAgICB9KVxuICAgIC5tYXAoJ2FkZHJlc3MnKVxuICAgIC5maXJzdCgpXG4gICAgLnZhbHVlKCk7XG4gIHJldHVybiBpcDtcbn1cblxuLypcbiAqIENyZWF0ZXMgYSBwcm9taXNlIHRoYXQgaXMgY2FuY2VsbGFibGUsIGFuZCB3aWxsIHRpbWVvdXRcbiAqIGFmdGVyIGBtc2AgZGVsYXlcbiAqL1xuZnVuY3Rpb24gY2FuY2VsbGFibGVEZWxheSAobXMpIHtcbiAgbGV0IHRpbWVyO1xuICBsZXQgcmVzb2x2ZTtcbiAgbGV0IHJlamVjdDtcblxuICBjb25zdCBkZWxheSA9IG5ldyBCLlByb21pc2UoKF9yZXNvbHZlLCBfcmVqZWN0KSA9PiB7XG4gICAgcmVzb2x2ZSA9IF9yZXNvbHZlO1xuICAgIHJlamVjdCA9IF9yZWplY3Q7XG4gICAgdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgIHJlc29sdmUoKTtcbiAgICB9LCBtcyk7XG4gIH0pO1xuXG4gIC8vIG92ZXJyaWRlIEJsdWViaXJkJ3MgYGNhbmNlbGAsIHdoaWNoIGRvZXMgbm90IHdvcmsgd2hlbiB1c2luZyBgYXdhaXRgIG9uXG4gIC8vIGEgcHJvbWlzZSwgc2luY2UgYHJlc29sdmVgL2ByZWplY3RgIGFyZSBuZXZlciBjYWxsZWRcbiAgZGVsYXkuY2FuY2VsID0gZnVuY3Rpb24gKCkge1xuICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgcmVqZWN0KG5ldyBCLkNhbmNlbGxhdGlvbkVycm9yKCkpO1xuICB9O1xuICByZXR1cm4gZGVsYXk7XG59XG5cbmZ1bmN0aW9uIG11bHRpUmVzb2x2ZSAocm9vdHMsIC4uLmFyZ3MpIHtcbiAgcmV0dXJuIHJvb3RzLm1hcCgocm9vdCkgPT4ge1xuICAgIHJldHVybiBwYXRoLnJlc29sdmUocm9vdCwgLi4uYXJncyk7XG4gIH0pO1xufVxuXG4vKlxuICogUGFyc2VzIGFuIG9iamVjdCBpZiBwb3NzaWJsZS4gT3RoZXJ3aXNlIHJldHVybnMgdGhlIG9iamVjdCB3aXRob3V0IHBhcnNpbmcuXG4gKi9cbmZ1bmN0aW9uIHNhZmVKc29uUGFyc2UgKG9iaikge1xuICB0cnkge1xuICAgIG9iaiA9IEpTT04ucGFyc2Uob2JqKTtcbiAgfSBjYXRjaCAoaWduKSB7XG4gICAgLy8gaWdub3JlOiB0aGlzIGlzIG5vdCBqc29uIHBhcnNhYmxlXG4gIH1cbiAgcmV0dXJuIG9iajtcbn1cblxuLypcbiAqIFJlbW92ZXMgdGhlIHdyYXBwZXIgZnJvbSBlbGVtZW50LCBpZiBpdCBleGlzdHMuXG4gKiAgIHsgRUxFTUVOVDogNCB9IGJlY29tZXMgNFxuICogICB7IGVsZW1lbnQtNjA2Ni0xMWU0LWE1MmUtNGY3MzU0NjZjZWNmOiA1IH0gYmVjb21lcyA1XG4gKi9cbmZ1bmN0aW9uIHVud3JhcEVsZW1lbnQgKGVsKSB7XG4gIGZvciAoY29uc3QgcHJvcE5hbWUgb2YgW1czQ19XRUJfRUxFTUVOVF9JREVOVElGSUVSLCAnRUxFTUVOVCddKSB7XG4gICAgaWYgKF8uaGFzKGVsLCBwcm9wTmFtZSkpIHtcbiAgICAgIHJldHVybiBlbFtwcm9wTmFtZV07XG4gICAgfVxuICB9XG4gIHJldHVybiBlbDtcbn1cblxuLypcbiAqIFJldHVybnMgb2JqZWN0IGNvbnNpc3Rpbmcgb2YgYWxsIHByb3BlcnRpZXMgaW4gdGhlIG9yaWdpbmFsIGVsZW1lbnRcbiAqIHdoaWNoIHdlcmUgdHJ1dGh5IGdpdmVuIHRoZSBwcmVkaWNhdGUuXG4gKiBJZiB0aGUgcHJlZGljYXRlIGlzXG4gKiAgICogbWlzc2luZyAtIGl0IHdpbGwgcmVtb3ZlIGFsbCBwcm9wZXJ0aWVzIHdob3NlIHZhbHVlcyBhcmUgYHVuZGVmaW5lZGBcbiAqICAgKiBhIHNjYWxhciAtIGl0IHdpbGwgdGVzdCBhbGwgcHJvcGVydGllcycgdmFsdWVzIGFnYWluc3QgdGhhdCB2YWx1ZVxuICogICAqIGEgZnVuY3Rpb24gLSBpdCB3aWxsIHBhc3MgZWFjaCB2YWx1ZSBhbmQgdGhlIG9yaWdpbmFsIG9iamVjdCBpbnRvIHRoZSBmdW5jdGlvblxuICovXG5mdW5jdGlvbiBmaWx0ZXJPYmplY3QgKG9iaiwgcHJlZGljYXRlKSB7XG4gIGxldCBuZXdPYmogPSBfLmNsb25lKG9iaik7XG4gIGlmIChfLmlzVW5kZWZpbmVkKHByZWRpY2F0ZSkpIHtcbiAgICAvLyByZW1vdmUgYW55IGVsZW1lbnQgZnJvbSB0aGUgb2JqZWN0IHdob3NlIHZhbHVlIGlzIHVuZGVmaW5lZFxuICAgIHByZWRpY2F0ZSA9ICh2KSA9PiAhXy5pc1VuZGVmaW5lZCh2KTtcbiAgfSBlbHNlIGlmICghXy5pc0Z1bmN0aW9uKHByZWRpY2F0ZSkpIHtcbiAgICAvLyBtYWtlIHByZWRpY2F0ZSBpbnRvIGEgZnVuY3Rpb25cbiAgICBjb25zdCB2YWx1ZVByZWRpY2F0ZSA9IHByZWRpY2F0ZTtcbiAgICBwcmVkaWNhdGUgPSAodikgPT4gdiA9PT0gdmFsdWVQcmVkaWNhdGU7XG4gIH1cbiAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMob2JqKSkge1xuICAgIGlmICghcHJlZGljYXRlKG9ialtrZXldLCBvYmopKSB7XG4gICAgICBkZWxldGUgbmV3T2JqW2tleV07XG4gICAgfVxuICB9XG4gIHJldHVybiBuZXdPYmo7XG59XG5cbi8qKlxuICogQ29udmVydHMgbnVtYmVyIG9mIGJ5dGVzIHRvIGEgcmVhZGFibGUgc2l6ZSBzdHJpbmcuXG4gKlxuICogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfSBieXRlcyAtIFRoZSBhY3R1YWwgbnVtYmVyIG9mIGJ5dGVzLlxuICogQHJldHVybnMge3N0cmluZ30gVGhlIGFjdHVhbCBzdHJpbmcgcmVwcmVzZW50YXRpb24sIGZvciBleGFtcGxlXG4gKiAgICAgICAgICAgICAgICAgICAnMS4wMCBLQicgZm9yICcxMDI0IEInXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgYnl0ZXMgY291bnQgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBhbiBpbnRlZ2VyIG9yXG4gKiAgICAgICAgICAgICAgICAgaWYgaXQgaXMgbGVzcyB0aGFuIHplcm8uXG4gKi9cbmZ1bmN0aW9uIHRvUmVhZGFibGVTaXplU3RyaW5nIChieXRlcykge1xuICBjb25zdCBpbnRCeXRlcyA9IHBhcnNlSW50KGJ5dGVzLCAxMCk7XG4gIGlmIChpc05hTihpbnRCeXRlcykgfHwgaW50Qnl0ZXMgPCAwKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgY29udmVydCAnJHtieXRlc30nIHRvIGEgcmVhZGFibGUgc2l6ZSBmb3JtYXRgKTtcbiAgfVxuICBpZiAoaW50Qnl0ZXMgPj0gMTAyNCAqIDEwMjQgKiAxMDI0KSB7XG4gICAgcmV0dXJuIGAke3BhcnNlRmxvYXQoaW50Qnl0ZXMgLyAoMTAyNCAqIDEwMjQgKiAxMDI0LjApKS50b0ZpeGVkKDIpfSBHQmA7XG4gIH0gZWxzZSBpZiAoaW50Qnl0ZXMgPj0gMTAyNCAqIDEwMjQpIHtcbiAgICByZXR1cm4gYCR7cGFyc2VGbG9hdChpbnRCeXRlcyAvICgxMDI0ICogMTAyNC4wKSkudG9GaXhlZCgyKX0gTUJgO1xuICB9IGVsc2UgaWYgKGludEJ5dGVzID49IDEwMjQpIHtcbiAgICByZXR1cm4gYCR7cGFyc2VGbG9hdChpbnRCeXRlcyAvIDEwMjQuMCkudG9GaXhlZCgyKX0gS0JgO1xuICB9XG4gIHJldHVybiBgJHtpbnRCeXRlc30gQmA7XG59XG5cbi8qKlxuICogQ2hlY2tzIHdoZXRoZXIgdGhlIGdpdmVuIHBhdGggaXMgYSBzdWJwYXRoIG9mIHRoZVxuICogcGFydGljdWxhciByb290IGZvbGRlci4gQm90aCBwYXRocyBjYW4gaW5jbHVkZSAuLiBhbmQgLiBzcGVjaWZpZXJzXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IG9yaWdpbmFsUGF0aCBUaGUgYWJzb2x1dGUgZmlsZS9mb2xkZXIgcGF0aFxuICogQHBhcmFtIHtzdHJpbmd9IHJvb3QgVGhlIGFic29sdXRlIHJvb3QgZm9sZGVyIHBhdGhcbiAqIEBwYXJhbSB7P2Jvb2xlYW59IGZvcmNlUG9zaXggU2V0IGl0IHRvIHRydWUgaWYgcGF0aHMgbXVzdCBiZSBpbnRlcnByZXRlZCBpbiBQT1NJWCBmb3JtYXRcbiAqIEByZXR1cm5zIHtib29sZWFufSB0cnVlIGlmIHRoZSBnaXZlbiBvcmlnaW5hbCBwYXRoIGlzIHRoZSBzdWJwYXRoIG9mIHRoZSByb290IGZvbGRlclxuICogQHRocm93cyB7RXJyb3J9IGlmIGFueSBvZiB0aGUgZ2l2ZW4gcGF0aHMgaXMgbm90IGFic29sdXRlXG4gKi9cbmZ1bmN0aW9uIGlzU3ViUGF0aCAob3JpZ2luYWxQYXRoLCByb290LCBmb3JjZVBvc2l4ID0gbnVsbCkge1xuICBjb25zdCBwYXRoT2JqID0gZm9yY2VQb3NpeCA/IHBhdGgucG9zaXggOiBwYXRoO1xuICBmb3IgKGNvbnN0IHAgb2YgW29yaWdpbmFsUGF0aCwgcm9vdF0pIHtcbiAgICBpZiAoIXBhdGhPYmouaXNBYnNvbHV0ZShwKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAnJHtwfScgaXMgZXhwZWN0ZWQgdG8gYmUgYW4gYWJzb2x1dGUgcGF0aGApO1xuICAgIH1cbiAgfVxuICBjb25zdCBub3JtYWxpemVkUm9vdCA9IHBhdGhPYmoubm9ybWFsaXplKHJvb3QpO1xuICBjb25zdCBub3JtYWxpemVkUGF0aCA9IHBhdGhPYmoubm9ybWFsaXplKG9yaWdpbmFsUGF0aCk7XG4gIHJldHVybiBub3JtYWxpemVkUGF0aC5zdGFydHNXaXRoKG5vcm1hbGl6ZWRSb290KTtcbn1cblxuLyoqXG4gKiBDaGVja3Mgd2hldGhlciB0aGUgZ2l2ZW4gcGF0aHMgYXJlIHBvaW50aW5nIHRvIHRoZSBzYW1lIGZpbGUgc3lzdGVtXG4gKiBkZXN0aW5hdGlvbi5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gcGF0aDEgLSBBYnNvbHV0ZSBvciByZWxhdGl2ZSBwYXRoIHRvIGEgZmlsZS9mb2xkZXJcbiAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoMiAtIEFic29sdXRlIG9yIHJlbGF0aXZlIHBhdGggdG8gYSBmaWxlL2ZvbGRlclxuICogQHBhcmFtIHsuLi5zdHJpbmd9IHBhdGhOIC0gWmVybyBvciBtb3JlIGFic29sdXRlIG9yIHJlbGF0aXZlIHBhdGhzIHRvIGZpbGVzL2ZvbGRlcnNcbiAqIEByZXR1cm5zIHtib29sZWFufSB0cnVlIGlmIGFsbCBwYXRocyBhcmUgcG9pbnRpbmcgdG8gdGhlIHNhbWUgZmlsZSBzeXN0ZW0gaXRlbVxuICovXG5hc3luYyBmdW5jdGlvbiBpc1NhbWVEZXN0aW5hdGlvbiAocGF0aDEsIHBhdGgyLCAuLi5wYXRoTikge1xuICBjb25zdCBhbGxQYXRocyA9IFtwYXRoMSwgcGF0aDIsIC4uLnBhdGhOXTtcbiAgaWYgKCFhd2FpdCBCLnJlZHVjZShhbGxQYXRocywgYXN5bmMgKGEsIGIpID0+IGEgJiYgYXdhaXQgZnMuZXhpc3RzKGIpLCB0cnVlKSkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGNvbnN0IGFyZUFsbEl0ZW1zRXF1YWwgPSAoYXJyKSA9PiAhIWFyci5yZWR1Y2UoKGEsIGIpID0+IGEgPT09IGIgPyBhIDogTmFOKTtcbiAgaWYgKGFyZUFsbEl0ZW1zRXF1YWwoYWxsUGF0aHMpKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgcmV0dXJuIGFyZUFsbEl0ZW1zRXF1YWwoYXdhaXQgQi5tYXAoYWxsUGF0aHMsIGFzeW5jICh4KSA9PiAoYXdhaXQgZnMuc3RhdCh4KSkuaW5vKSk7XG59XG5cbmV4cG9ydCB7XG4gIGhhc1ZhbHVlLCBlc2NhcGVTcGFjZSwgZXNjYXBlU3BlY2lhbENoYXJzLCBsb2NhbElwLCBjYW5jZWxsYWJsZURlbGF5LFxuICBtdWx0aVJlc29sdmUsIHNhZmVKc29uUGFyc2UsIHVud3JhcEVsZW1lbnQsIGZpbHRlck9iamVjdCxcbiAgdG9SZWFkYWJsZVNpemVTdHJpbmcsIGlzU3ViUGF0aCwgVzNDX1dFQl9FTEVNRU5UX0lERU5USUZJRVIsXG4gIGlzU2FtZURlc3RpbmF0aW9uLFxufTtcbiJdLCJmaWxlIjoibGliL3V0aWwuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
